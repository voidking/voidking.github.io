<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.1"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="问题描述心态爆炸了！火急火燎！一方面马上要交毕业论文，另一方面马上要提交小论文。就当我打算抽出一天先完成小论文时，实验环境崩了！ 之前进行迁移实验都好好的，但是今天进行迁移实验的时候，实例经常死机。本着“重启治百病”的思想，重启了两个计算节点，重新挂载了nfs。然后再次迁移时，实例可以从compute2迁移到compute1。但是，实例从compute1迁移到compute2时，compute2就"><meta property="og:type" content="article"><meta property="og:title" content="OpenStack计算节点的奇葩问题"><meta property="og:url" content="https://www.voidking.com/dev-openstack-compute-node-broken/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="问题描述心态爆炸了！火急火燎！一方面马上要交毕业论文，另一方面马上要提交小论文。就当我打算抽出一天先完成小论文时，实验环境崩了！ 之前进行迁移实验都好好的，但是今天进行迁移实验的时候，实例经常死机。本着“重启治百病”的思想，重启了两个计算节点，重新挂载了nfs。然后再次迁移时，实例可以从compute2迁移到compute1。但是，实例从compute1迁移到compute2时，compute2就"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://cdn.voidking.com//imgs/openstack-compute-node-broken/error1.jpg?imageView2/0/w/700"><meta property="og:image" content="http://cdn.voidking.com//imgs/openstack-compute-node-broken/error2.jpg?imageView2/0/w/700"><meta property="article:published_time" content="2019-03-20T20:00:00.000Z"><meta property="article:modified_time" content="2020-06-16T02:44:05.493Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="linux"><meta property="article:tag" content="mysql"><meta property="article:tag" content="ubuntu"><meta property="article:tag" content="ansible"><meta property="article:tag" content="openstack"><meta property="article:tag" content="kolla"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://cdn.voidking.com//imgs/openstack-compute-node-broken/error1.jpg?imageView2/0/w/700"><link rel="canonical" href="https://www.voidking.com/dev-openstack-compute-node-broken/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>OpenStack计算节点的奇葩问题 | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">好好学习，天天向上！</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-openstack-compute-node-broken/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="学而不思则罔，思而不学则殆！"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> OpenStack计算节点的奇葩问题</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-03-20 20:00:00" itemprop="dateCreated datePublished" datetime="2019-03-20T20:00:00+00:00">2019-03-20</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/" itemprop="url" rel="index"><span itemprop="name">专业</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/%E8%BF%90%E7%BB%B4/openstack/" itemprop="url" rel="index"><span itemprop="name">openstack</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>心态爆炸了！火急火燎！一方面马上要交毕业论文，另一方面马上要提交小论文。就当我打算抽出一天先完成小论文时，实验环境崩了！</p><p>之前进行迁移实验都好好的，但是今天进行迁移实验的时候，实例经常死机。本着“重启治百病”的思想，重启了两个计算节点，重新挂载了nfs。然后再次迁移时，实例可以从compute2迁移到compute1。但是，实例从compute1迁移到compute2时，compute2就报错！</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ERROR </span>oslo_messaging.rpc.server [req<span class="string">-922596</span>a7-f122<span class="string">-45</span>c8<span class="string">-9</span>f91<span class="string">-1446</span>bb855e05 2c04ede78270421da71953f8f07ef115 8de01ef30eed437193725fb759b9992d - default default] Exception during message handling: InvalidCPUInfo: Unacceptable CPU info: CPU doesn't have compatibility.</span><br></pre></td></tr></table></figure><p>重新部署了compute2计算节点，依然是这个错误。重装了compute2计算节点的操作系统，然后重新部署，依然是这个错误！很绝望！</p><a id="more"></a><h1 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h1><p>重装系统无效，那么大概率是控制节点的锅了！那么问题具体出在哪里？凭什么compute1就好好的，compute2就坏了？是因为控制节点的一些残留信息没有清空吗？数据库中记录说compute2已经没有可用CPU了？数据库中记录说不兼容？还是有缓存或者消息？那么该怎么清空关于compute2的信息？。。。<br>还有一个关键的问题是，为什么突然就无法兼容了？之前不是好好的么？<br>然而，没有人可以告诉我答案，搜索引擎不行，社区群聊不行，身边也没有OpenStack的大牛。<br>现在只想赶紧从OpenStack这个大坑中爬出来，遇到问题根本找不到答案，就问你服不服！</p><h1 id="垂死挣扎"><a href="#垂死挣扎" class="headerlink" title="垂死挣扎"></a>垂死挣扎</h1><h2 id="查看数据库"><a href="#查看数据库" class="headerlink" title="查看数据库"></a>查看数据库</h2><p>1、查看数据库密码<br><code>less /etc/kolla/passwords.yml | grep password</code><br>里面有很多密码，我们需要的是nova_database_password。</p><p>2、进入mariadb容器<br><code>docker exec -it mariadb /bin/bash</code></p><p>3、登录mariadb数据库<br><code>mysql -u nova -p</code></p><p>4、使用nova数据库<br><code>use nova;</code></p><p>5、查看计算节点的信息<br><code>select * from compute_nodes\G</code></p><h2 id="重命名计算节点"><a href="#重命名计算节点" class="headerlink" title="重命名计算节点"></a>重命名计算节点</h2><p>如果，给compute2节点更换hostname和IP呢？比如hostname换成compute3，IP也换成其他的。这样的话，计算节点就不会受控制节点中残留信息的影响了。</p><p>1、修改compute2的hostname和IP地址</p><p>2、修改multinode文件<br>控制节点中，把multinode文件中的compute2节点换成compute3，/etc/hosts中添加compute3对应的IP。</p><p>3、重新部署<br><code>kolla-ansible -i ./multinode deploy</code></p><p>4、查看计算服务</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">. admin-openrc.sh</span><br><span class="line">openstack compute<span class="built_in"> service </span>list</span><br></pre></td></tr></table></figure><h2 id="设置迁移和挂载"><a href="#设置迁移和挂载" class="headerlink" title="设置迁移和挂载"></a>设置迁移和挂载</h2><p>参考<a href="https://www.voidking.com/dev-openstack-vm-block-live-migration/">《OpenStack中虚拟机的在线迁移》</a>，在compute3节点设置OpenStack允许迁移。参考<a href="https://www.voidking.com/dev-openstack-vm-live-migration/">《OpenStack中共享存储的虚拟机在线迁移》</a>，在compute3节点挂载nfs。</p><p>1、修改nova.conf的配置<br><code>vim /etc/kolla/nova-compute/nova.conf</code>，在default中添加：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">live_migration_flag</span>=VIR_MIGRATE_UNDEFINE_SOURCE,VIR_MIGRATE_PEER2PEER,VIR_MIGRATE_LIVE</span><br></pre></td></tr></table></figure><p>2、修改libvirtd.conf<br><code>vim /etc/kolla/nova-libvirt/libvirtd.conf</code>，修改配置如下：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">listen_tcp</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">listen_tls</span> = <span class="number">0</span></span><br><span class="line"><span class="attr">auth_tcp</span> = <span class="string">"none"</span></span><br><span class="line"><span class="attr">ca_file</span> = <span class="string">""</span></span><br><span class="line"><span class="attr">log_level</span> = <span class="number">3</span></span><br><span class="line"><span class="attr">log_outputs</span> = <span class="string">"3:file:/var/log/kolla/libvirt/libvirtd.log"</span></span><br><span class="line"><span class="attr">listen_addr</span> = <span class="string">"0.0.0.0"</span></span><br></pre></td></tr></table></figure><p>3、挂载nfs</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get install nfs-common</span><br><span class="line">mount -t nfs <span class="number">192.168</span>.<span class="number">56.130</span>:<span class="regexp">/nfs/share</span><span class="regexp">/instances /var</span><span class="regexp">/lib/docker</span><span class="regexp">/volumes/nova</span>_compute/_data/instances/</span><br><span class="line">chmod -R <span class="number">777</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">docker</span>/<span class="title">volumes</span>/<span class="title">nova_compute</span>/<span class="title">_data</span>/<span class="title">instances</span>/</span></span><br></pre></td></tr></table></figure><p>4、重启nova_compute和nova_libvirt</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker stop nov<span class="built_in">a_compute</span></span><br><span class="line">docker start nov<span class="built_in">a_compute</span></span><br><span class="line">docker stop nov<span class="built_in">a_libvirt</span></span><br><span class="line">docker start nov<span class="built_in">a_libvirt</span></span><br></pre></td></tr></table></figure><h2 id="再次尝试迁移"><a href="#再次尝试迁移" class="headerlink" title="再次尝试迁移"></a>再次尝试迁移</h2><p>1、迁移命令<br><code>nova live-migration demo0 compute3</code></p><p>2、查看状态<br><code>nova show demo0</code></p><p>3、compute3上查看日志<br><code>tail -n 20 /var/lib/docker/volumes/kolla_logs/_data/nova/nova-compute.log</code><br><img src="http://cdn.voidking.com//imgs/openstack-compute-node-broken/error1.jpg?imageView2/0/w/700" alt=""></p><p>虽然迁移失败，但是好歹是不一样的错误了。。。这个错误以前遇到过，重启计算节点就好了。于是重启compute3节点，但是问题没有解决。</p><p>4、测试与控制节点的连接<br><code>curl http://192.168.56.120:35357</code>，结果为：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl: (7) Failed <span class="keyword">to</span> connect <span class="keyword">to</span> 192.168.56.120<span class="built_in"> port </span>35357:<span class="built_in"> Connection </span>refused</span><br></pre></td></tr></table></figure><p>5、在compute1节点上测试与控制节点的连接<br><code>curl http://192.168.56.120:35357</code>，结果为：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"versions"</span>: &#123;<span class="attr">"values"</span>: [&#123;<span class="attr">"status"</span>: <span class="string">"stable"</span>, <span class="attr">"updated"</span>: <span class="string">"2018-02-28T00:00:00Z"</span>, <span class="attr">"media-types"</span>: [&#123;<span class="attr">"base"</span>: <span class="string">"application/json"</span>, <span class="attr">"type"</span>: <span class="string">"application/vnd.openstack.identity-v3+json"</span>&#125;], <span class="attr">"id"</span>: <span class="string">"v3.10"</span>, <span class="attr">"links"</span>: [&#123;<span class="attr">"href"</span>: <span class="string">"http://192.168.56.120:35357/v3/"</span>, <span class="attr">"rel"</span>: <span class="string">"self"</span>&#125;]&#125;, &#123;<span class="attr">"status"</span>: <span class="string">"deprecated"</span>, <span class="attr">"updated"</span>: <span class="string">"2016-08-04T00:00:00Z"</span>, <span class="attr">"media-types"</span>: [&#123;<span class="attr">"base"</span>: <span class="string">"application/json"</span>, <span class="attr">"type"</span>: <span class="string">"application/vnd.openstack.identity-v2.0+json"</span>&#125;], <span class="attr">"id"</span>: <span class="string">"v2.0"</span>, <span class="attr">"links"</span>: [&#123;<span class="attr">"href"</span>: <span class="string">"http://192.168.56.120:35357/v2.0/"</span>, <span class="attr">"rel"</span>: <span class="string">"self"</span>&#125;, &#123;<span class="attr">"href"</span>: <span class="string">"https://docs.openstack.org/"</span>, <span class="attr">"type"</span>: <span class="string">"text/html"</span>, <span class="attr">"rel"</span>: <span class="string">"describedby"</span>&#125;]&#125;]&#125;&#125;</span><br></pre></td></tr></table></figure><p>这才是正常的啊！</p><p>6、重启compute3并且重新挂载nfs</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mount -t nfs <span class="number">192.168</span>.<span class="number">56.130</span><span class="symbol">:/nfs/share/instances</span> /var/lib/docker/volumes/nova_compute/_data/instances/</span><br><span class="line">docker stop nova_compute</span><br><span class="line">docker start nova_compute</span><br><span class="line">docker stop nova_libvirt</span><br><span class="line">docker start nova_libvirt</span><br></pre></td></tr></table></figure><p>7、再次执行迁移<br><code>nova live-migration demo0 compute3</code><br>依然失败，还是同样的错误。</p><h2 id="IP的坑"><a href="#IP的坑" class="headerlink" title="IP的坑"></a>IP的坑</h2><p>百度谷歌想要找到答案？不存在的。折腾了两天，突然灵光一现！<br>还记得<a href="https://www.voidking.com/dev-ubuntu16-kolla-openstack-multinode/">《Kolla安装OpenStack多节点》</a>一文中，控制节点的IP为192.168.56.110。而配置globals.yml时候，<code>kolla_internal_vip_address</code>的值为192.168.56.120。</p><p>因此，compute3节点中，nova.conf中的IP有一部分是192.168.56.110，另外一部分是192.168.56.120。</p><p>明明所有控制节点的服务都在一个节点上，却有两个IP，看起来就容易闹幺蛾子。实际上，确实闹过幺蛾子！OpenStack刚刚安装成功时，使用192.168.56.120这个IP可以访问到horizon服务，使用192.168.56.110就不可以。后来突然有一天，192.168.56.120这个IP就不能访问horizon了，使用192.168.56.110却可以访问！再后来突然有一天，两个IP都可以访问horizon服务！真的是醉了。。。</p><p>这次，会不会也是IP的问题？于是，在compute3上，换一个IP测试访问控制节点。<br><code>curl http://192.168.56.110:35357</code>，果然可以正常访问！于是，思路就清晰了。</p><p>1、修改compute3节点中的nova.conf配置文件<br><code>vim /etc/kolla/nova-compute/nova.conf</code>，所有的192.168.56.120全部换成192.168.56.110。</p><p>2、重启nova_compute</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker stop nov<span class="built_in">a_compute</span></span><br><span class="line">dokcer start nov<span class="built_in">a_compute</span></span><br></pre></td></tr></table></figure><p>3、再次迁移，失败，不过报错变了。<br><img src="http://cdn.voidking.com//imgs/openstack-compute-node-broken/error2.jpg?imageView2/0/w/700" alt=""></p><p>依然是IP问题，看来还有其他配置文件中写了192.168.56.120。</p><p>4、修改neutron.conf和chrony.conf文件</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="regexp">/etc/</span>kolla<span class="regexp">/neutron-openvswitch-agent/</span>neutron.conf</span><br><span class="line">vim <span class="regexp">/etc/</span>kolla<span class="regexp">/chrony/</span>chrony.conf</span><br></pre></td></tr></table></figure><p>所有120替换为110。</p><p>5、重启neutron和chrony</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="literal">stop</span> neutron_openvswitch_agent</span><br><span class="line">docker <span class="literal">start</span> neutron_openvswitch_agent</span><br><span class="line">docker <span class="literal">stop</span> chrony</span><br><span class="line">docker <span class="literal">start</span> chrony</span><br></pre></td></tr></table></figure><p>6、再次迁移，依然失败，报错依然失8780端口。</p><p>7、重启所有服务，再次迁移，依然失败。<br>莫非还有什么文件没有注意到？于是放了一个大招，<code>grep -rn &quot;192.168.56.120:8780&quot; *</code>，然而，没有找到包含该配置的文件。</p><p>8、重启了compute3，然后，nova_compute无法启动了！启动报错：</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/var/<span class="class"><span class="keyword">lib</span>/<span class="title">docker</span>/<span class="title">volumes</span>/<span class="title">kolla_logs</span>/<span class="title">_data</span>: <span class="title">no</span> <span class="title">such</span> <span class="title">file</span> <span class="title">or</span> <span class="title">directory</span></span></span><br><span class="line">/var/<span class="class"><span class="keyword">lib</span>/<span class="title">docker</span>/<span class="title">volumes</span>/<span class="title">libvirtd</span>/<span class="title">_data</span>: <span class="title">no</span> <span class="title">such</span> <span class="title">file</span> <span class="title">or</span> <span class="title">directory</span></span></span><br><span class="line">/var/<span class="class"><span class="keyword">lib</span>/<span class="title">docker</span>/<span class="title">volumes</span>/<span class="title">nova_compute</span>/<span class="title">_data</span>: <span class="title">no</span> <span class="title">such</span> <span class="title">file</span> <span class="title">or</span> <span class="title">directory</span></span></span><br></pre></td></tr></table></figure><p>创建了三个文件夹，依然无法启动nova_compute。</p><h1 id="破釜沉舟"><a href="#破釜沉舟" class="headerlink" title="破釜沉舟"></a>破釜沉舟</h1><p>实在是没办法了，只能使出最后一招：重装整个OpenStack系统！</p><h2 id="销毁OpenStack环境"><a href="#销毁OpenStack环境" class="headerlink" title="销毁OpenStack环境"></a>销毁OpenStack环境</h2><p>1、查看镜像<br><code>glance image-list</code></p><p>或者进入镜像文件夹查看<br><code>cd /var/lib/docker/volumes/glance/_data/images</code></p><p>2、导出镜像</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">glance image-download --file ./ubuntu16-env.img <span class="number">003</span>ae986<span class="number">-4</span>dd9<span class="number">-45</span>a6<span class="number">-9630</span><span class="number">-1</span>b80fc8dcab3</span><br><span class="line">ll -h</span><br></pre></td></tr></table></figure><p>3、在horizon中删除所有镜像</p><p>4、在horizon中关闭并删除所有实例</p><p>5、编辑multinode文件，取消所有节点的注释</p><p>6、销毁整个OpenStack环境<br><code>kolla-ansible destroy -i ./multinode --yes-i-really-really-mean-it</code></p><h2 id="安装OpenStack"><a href="#安装OpenStack" class="headerlink" title="安装OpenStack"></a>安装OpenStack</h2><p>参考<a href="https://www.voidking.com/dev-ubuntu16-kolla-openstack-multinode/">《Kolla安装OpenStack多节点》</a>进行OpenStack的安装。</p><p>考虑到两个IP的坑，这次安装我仔细阅读了一下globals.yml文件中关于<code>kolla_internal_vip_address</code>的描述：</p><blockquote><p>This should be a VIP, an unused IP on your network that will float between<br>the hosts running keepalived for high-availability. If you want to run an<br>All-In-One without haproxy and keepalived, you can set enable_haproxy to no<br>in “OpenStack options” section, and set this value to the IP of your<br>‘network_interface’ as set in the Networking section below.</p></blockquote><p>这应该是VIP，网络上未使用的IP将在运行keepalived以获得高可用性的主机之间浮动。如果要在没有haproxy和keepalived的情况下运行多功能一体机，可以在“OpenStack选项”部分中将enable_haproxy设置为no，并将此值设置为“network_interface”的IP，如下面的“网络”部分所述。</p><p>看来，<code>kolla_internal_vip_address</code>不应该设置为192.168.56.120，因为我们的环境中不需要haproxy。所以，在配置配置globals.yml的时候，<code>kolla_internal_vip_address</code>应该设置为和控制节点相同的IP：192.168.56.110，同时<code>enable_haproxy</code>设置为no。</p><p>安装完成后，导入之前备份的镜像：</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">. admin-openrc.sh</span><br><span class="line">glance image-create \</span><br><span class="line"><span class="params">--name</span> <span class="string">"ubuntu16-env"</span> \</span><br><span class="line"><span class="params">--file</span> <span class="string">./ubuntu16-env.img</span>  \</span><br><span class="line"><span class="params">--disk-format</span> qcow2 \</span><br><span class="line"><span class="params">--container-format</span> bare \</span><br><span class="line"><span class="params">--visibility</span> public \</span><br><span class="line"><span class="params">--progress</span></span><br></pre></td></tr></table></figure><h2 id="设置迁移和挂载-1"><a href="#设置迁移和挂载-1" class="headerlink" title="设置迁移和挂载"></a>设置迁移和挂载</h2><p>参考本文中垂死挣扎部分设置迁移和挂载。<br>然后，创建实例，分配浮动IP，测试迁移，成功！nice！</p><h1 id="罪魁祸首"><a href="#罪魁祸首" class="headerlink" title="罪魁祸首"></a>罪魁祸首</h1><p>再次进行迁移，同时启动间隔1ms的ping命令测试停机时间，然后实例迁移后死机了！Ctrl+C关闭ping命令，实例复活。由此猜想是ping命令的锅。</p><p>但是，这是一个单向问题！同样是使用间隔1ms的ping命令测试停机时间，实例从compute1迁移到compute2时正常，实例从compute2迁移到compute1时才会死机。就问你神奇不神奇？！</p><p>猜测是因为ping的频率太高，给网络或者实例带来了太大的负荷。ping命令降低到10ms一次，双向迁移都正常。</p><p>但是，实例从compute1到compute2时，就不会受到ping命令的影响，这次是为什么？两台机器的配置完全相同的啊！诡异，实在是诡异！</p><p>更诡异的是，每次迁移的数据居然都通过不同的网卡，也许这次通过eth0（管理网络），下次就通过eth2（外网网络）！还能不能愉快地玩耍了？！</p><p>细细回想整个安装流程，突然想到，在安装前设置了三个节点的hosts文件，三个节点通过eth0通信。但是ansible安装OpenStack后，会根据globals.yml中的network_interface（eth1）修改hosts文件，于是hosts中有了两套规则。默认使用hosts文件中靠前的规则，于是我自己设置的规则就把ansible设置的规则覆盖了。eth0既用于节点间通信，又用于实例迁移。由于eth2和eth0属于同一个网段，所以有时会通过eth2网卡进行迁移！</p><p>为了验证自己的猜想，修改了三个节点的hosts文件，保留ansible创建的那一份。这样，就指定了迁移时使用的网卡。修改后在控制节点和计算节点重启nova相关服务。</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计算节点</span></span><br><span class="line">docker <span class="literal">stop</span> nova_compute</span><br><span class="line">docker <span class="literal">start</span> nova_compute</span><br><span class="line">docker <span class="literal">stop</span> nova_libvirt</span><br><span class="line">docker <span class="literal">start</span> nova_libvirt</span><br><span class="line"><span class="comment"># 控制节点</span></span><br><span class="line">docker <span class="literal">stop</span> nova_api</span><br><span class="line">docker <span class="literal">start</span> nova_api</span><br><span class="line">docker <span class="literal">stop</span> nova_scheduler</span><br><span class="line">docker <span class="literal">start</span> nova_scheduler</span><br><span class="line">docker <span class="literal">stop</span> placement_api</span><br><span class="line">docker <span class="literal">start</span> placement_api</span><br></pre></td></tr></table></figure><p>再次迁移实验，迁移数据果然会通过eth1（OpenStack内网网络），而不是eth0或者eth2！而且，双向迁移加1ms的ping命令都可以成功迁移，实例不再死机，问题完美解决！真相大白，罪魁祸首居然是hosts文件！</p><p>此外，live_migration_inbound_addr参数也可以指定迁移网络。</p><h1 id="风波再起"><a href="#风波再起" class="headerlink" title="风波再起"></a>风波再起</h1><p>就当我自以为找到了真相，继续实验时，实例再次出现了实例死机的情况。双向迁移都会偶尔出现死机，而且，使用间隔1ms的ping命令时死机概率会更大。如果使用间隔10ms的ping命令来测试停机时间呢？测出来的停机时间是秒级！Are you kidding me ?<br>比如同一个迁移，使用两个ping命令进行测试：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo<span class="built_in"> ping </span>instance_float_ip -i 0.001 &gt;&gt; ping.log</span><br><span class="line">根据丢包数计算出的downtime为434ms</span><br><span class="line">sudo<span class="built_in"> ping </span>instance_float_ip -i 0.01 &gt;&gt; ping.log</span><br><span class="line">根据丢包数计算出的downtime为3340ms</span><br></pre></td></tr></table></figure><p>理论上，应该测出同样的结果才对，然而他们差了一个数量级！诡异，实在是诡异！哪个才是真正的downtime？无论哪个是真正的downtime，ping命令本身绝对存在重大缺陷！</p><p>如果downtime是毫秒级，那么就符合理论上的值，实验可以正常进行。但是，使用间隔1ms的ping命令测试停机时间容易实例死机啊大哥！</p><p>如果downtime是秒级，那么问题要么是出在OpenStack配置上面，要么是出在网络上面。<br>假设问题出在OpenStack的配置上面，于是参考<a href="https://docs.openstack.org/nova/pike/admin/configuring-migrations.html" target="_blank" rel="noopener">Configure live migrations</a>，先后设置了最大停机时间，设置了自动收敛，设置了后拷贝。但是，问题依旧，那么应该不是OpenStack的配置问题。<br>假设问题出在网络上面，那么怎么解决呢？给实例的外网（eth3）设置一个单独的网段，不要和管理网络（eth0）在同一个网段？太麻烦。如果，在另外一个实例中对迁移实例进行ping测试呢？这样至少也可以避免了浮动IP的切换问题，是一个好主意。</p><p>于是在实例B中运行间隔1ms的ping命令，通过实例间的内网测试实例A，实例A多次迁移，测出的downtime在几十毫秒到几百毫秒不等，而且不会死机。在实例B中使用间隔10ms的ping命令进行测试，测出的downtime在几百毫秒左右，也很合理。所以，不是ping命令的锅？</p><p>不管了不管了，总之找到了解决办法！在另外一个实例中对迁移实例使用ping命令通过实例间的内网测试停机时间，而不是在外部机器中使用ping命令通过浮动IP测试停机时间。命令如下：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo<span class="built_in"> ping </span>instance_internal_ip -i 0.001 &gt;&gt; ping.log</span><br></pre></td></tr></table></figure><h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>因为实例迁移会死机，所以开始了折腾。折腾了一大圈，重启所有节点，重装计算节点，重装系统，重装OpenStack，最后发现实例迁移依然会死机！这就排除了硬件问题，也排除了软件问题。好在最后灵光一现猜测是hosts的问题，不然这个坑是怎么都爬不出不来了。。。只是没想到刚爬出一个坑，又跌进了一个坑，修改了hosts不死机，只是刚好那几次实验都没死机！在使用了间隔1ms的ping命令之后，死机依然频繁。再次折腾OpenStack配置，失败。再次从网络方面考虑，终于找到了解决方案，太不容易了！</p><p>今天（3月24日）终于修复了实验环境，但是，已经错过了<a href="http://www.thecloudcomputing.org/2019/index.html" target="_blank" rel="noopener">cloud2019</a>的deadline。有些遗憾，不过和毕业论文相比，只能先牺牲小论文了。近期还有会议，加把劲，做实验，写论文，投稿！</p><h1 id="书签"><a href="#书签" class="headerlink" title="书签"></a>书签</h1><p><a href="https://www.cnblogs.com/kevingrace/p/6024251.html" target="_blank" rel="noopener">openstack中彻底删除计算节点的操作记录</a></p></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/linux/" rel="tag"># linux</a> <a href="/tags/mysql/" rel="tag"># mysql</a> <a href="/tags/ubuntu/" rel="tag"># ubuntu</a> <a href="/tags/ansible/" rel="tag"># ansible</a> <a href="/tags/openstack/" rel="tag"># openstack</a> <a href="/tags/kolla/" rel="tag"># kolla</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-sysbench-usage-and-plot/" rel="prev" title="sysbench的基本用法和结果绘图"><i class="fa fa-chevron-left"></i> sysbench的基本用法和结果绘图</a></div><div class="post-nav-item"> <a href="/dev-openstack-vm-live-migration-experiment-v2-1/" rel="next" title="虚拟机在线迁移实验V2——下">虚拟机在线迁移实验V2——下<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zODU3Mi8xNTEwMA=="></div></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#问题描述"><span class="nav-number">1.</span> <span class="nav-text">问题描述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#问题分析"><span class="nav-number">2.</span> <span class="nav-text">问题分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#垂死挣扎"><span class="nav-number">3.</span> <span class="nav-text">垂死挣扎</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#查看数据库"><span class="nav-number">3.1.</span> <span class="nav-text">查看数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#重命名计算节点"><span class="nav-number">3.2.</span> <span class="nav-text">重命名计算节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#设置迁移和挂载"><span class="nav-number">3.3.</span> <span class="nav-text">设置迁移和挂载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#再次尝试迁移"><span class="nav-number">3.4.</span> <span class="nav-text">再次尝试迁移</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IP的坑"><span class="nav-number">3.5.</span> <span class="nav-text">IP的坑</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#破釜沉舟"><span class="nav-number">4.</span> <span class="nav-text">破釜沉舟</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#销毁OpenStack环境"><span class="nav-number">4.1.</span> <span class="nav-text">销毁OpenStack环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装OpenStack"><span class="nav-number">4.2.</span> <span class="nav-text">安装OpenStack</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#设置迁移和挂载-1"><span class="nav-number">4.3.</span> <span class="nav-text">设置迁移和挂载</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#罪魁祸首"><span class="nav-number">5.</span> <span class="nav-text">罪魁祸首</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#风波再起"><span class="nav-number">6.</span> <span class="nav-text">风波再起</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#后记"><span class="nav-number">7.</span> <span class="nav-text">后记</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#书签"><span class="nav-number">8.</span> <span class="nav-text">书签</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">学而不思则罔，思而不学则殆！</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">601</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">42</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">195</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2020</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://www.beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={iconStyle:"box",boxForm:"horizontal",position:"bottomCenter",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={iconStyle:"box",boxForm:"horizontal",position:"topRight",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-float",flOptions)</script><script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  // window.livereOptions = {
  //   refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  // };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script></body></html>