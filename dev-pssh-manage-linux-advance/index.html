<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.1"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="前言《使用PSSH批量管理Linux》一文中，学习了pssh的基本用法，实际上已经涵盖了pssh的大部分内容。 本文主要记录利用pssh和expect脚本来解决一些实际问题，就算是进阶篇了。"><meta property="og:type" content="article"><meta property="og:title" content="使用PSSH批量管理Linux进阶篇"><meta property="og:url" content="https://www.voidking.com/dev-pssh-manage-linux-advance/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="前言《使用PSSH批量管理Linux》一文中，学习了pssh的基本用法，实际上已经涵盖了pssh的大部分内容。 本文主要记录利用pssh和expect脚本来解决一些实际问题，就算是进阶篇了。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2018-06-05T08:30:00.000Z"><meta property="article:modified_time" content="2021-04-12T00:34:25.013Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="linux"><meta property="article:tag" content="shell"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.voidking.com/dev-pssh-manage-linux-advance/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>使用PSSH批量管理Linux进阶篇 | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">好好学习，天天向上！</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-pssh-manage-linux-advance/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="学而不思则罔，思而不学则殆！"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> 使用PSSH批量管理Linux进阶篇</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-06-05 16:30:00" itemprop="dateCreated datePublished" datetime="2018-06-05T16:30:00+08:00">2018-06-05</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/" itemprop="url" rel="index"><span itemprop="name">专业</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/%E8%BF%90%E7%BB%B4/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><a href="https://www.voidking.com/dev-pssh-manage-linux/">《使用PSSH批量管理Linux》</a>一文中，学习了pssh的基本用法，实际上已经涵盖了pssh的大部分内容。</p><p>本文主要记录利用pssh和expect脚本来解决一些实际问题，就算是进阶篇了。</p><a id="more"></a><h1 id="批量添加密钥"><a href="#批量添加密钥" class="headerlink" title="批量添加密钥"></a>批量添加密钥</h1><p><a href="https://www.voidking.com/dev-pssh-manage-linux/#%E6%B7%BB%E5%8A%A0%E5%AF%86%E9%92%A5%E8%AE%A4%E8%AF%81%E8%AE%BF%E9%97%AE">《添加密钥认证访问》</a>一节中，已经写清楚了挨个给客户机添加密钥的方法。但是，在客户机数量非常多的时候，挨个添加也很麻烦，写个脚本吧！（假设所有客户机用户都是test，密码都是123456）</p><p>参考<a href="https://blog.csdn.net/tantexian/article/details/45887857" target="_blank" rel="noopener">无密钥登录的自动脚本实现</a> 和 <a href="http://xstarcd.github.io/wiki/shell/expect.html" target="_blank" rel="noopener">expect - 自动交互脚本</a></p><h2 id="基线版本"><a href="#基线版本" class="headerlink" title="基线版本"></a>基线版本</h2><p>1、新建脚本addkey.sh，内容为：</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/expect </span><br><span class="line"><span class="keyword">set</span> timeout <span class="comment">60</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">password 123456</span></span><br><span class="line"></span><br><span class="line">spawn <span class="comment">ssh-copy-id -i</span> /home/<span class="comment">test</span>/.ssh/<span class="comment">id_rsa.pub -p 22 test@192.168.56.101</span></span><br><span class="line">expect <span class="comment">"install the new keys"</span></span><br><span class="line">send <span class="comment">"\r"</span></span><br><span class="line">expect <span class="comment">"password:"</span></span><br><span class="line">send <span class="comment">"$password\r"</span></span><br><span class="line">expect <span class="comment">eof</span></span><br></pre></td></tr></table></figure><p>2、执行脚本<br><code>chmod a+x addkey.sh</code></p><p><code>./addkey.sh</code></p><p>注意：</p><ul><li>如果密码是六个空格，那么<code>set password &quot; &quot;</code>即可。</li><li><code>expect &quot;install the new keys&quot;</code>这里其实是不需要交互的，但是密码会直接出现在这里，所以加一个回车。</li></ul><h2 id="升级版本"><a href="#升级版本" class="headerlink" title="升级版本"></a>升级版本</h2><p>在使用ssh-copy-id命令的时候，有两种情况，一种是直接输入密码，就像基线版本；另一种情况是会先提示添加主机到known_hosts。</p><p>1、新建脚本addkey.sh，主要目的是测试，内容为：</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/expect </span><br><span class="line"><span class="keyword">set</span> timeout <span class="comment">60</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">password 123456</span></span><br><span class="line"></span><br><span class="line">spawn <span class="comment">ssh-copy-id -i</span> /home/<span class="comment">test</span>/.ssh/<span class="comment">id_rsa.pub -p 22 test@192.168.56.101</span></span><br><span class="line">expect <span class="comment">&#123;</span></span><br><span class="line">    #first <span class="comment">connect, no public key in</span> ~/.ssh/<span class="comment">known_hosts</span></span><br><span class="line">    <span class="string">"Are you sure you want to continue connecting (yes/no)?"</span> &#123;</span><br><span class="line">        send <span class="comment">"yes\r"</span>; exp_continue</span><br><span class="line">    &#125;</span><br><span class="line">    #already has public key in ~/.ssh/known_hosts</span><br><span class="line">    <span class="string">"install the new keys"</span> &#123;</span><br><span class="line">        send <span class="string">"\r"</span>; exp_continue</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">"password:"</span> &#123;</span><br><span class="line">        send <span class="string">"$password\r"</span>; exp_continue</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">"Now try logging into the machine"</span> &#123;</span><br><span class="line">        #it has authorized, do nothing!</span><br><span class="line">        ; exp_continue</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、执行脚本<br><code>chmod a+x addkey.sh</code></p><p><code>./addkey.sh</code></p><h2 id="批量版本"><a href="#批量版本" class="headerlink" title="批量版本"></a>批量版本</h2><p>1、升级脚本，新建addkeys.sh，内容为：</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/expect </span><br><span class="line"><span class="keyword">set</span> timeout <span class="comment">60</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">password 123456</span></span><br><span class="line"></span><br><span class="line">for <span class="comment">&#123;set i 101&#125; &#123;$i &lt; 201&#125; &#123;incr i&#125; &#123;</span></span><br><span class="line">    spawn <span class="comment">ssh-copy-id -i</span> /home/<span class="comment">test</span>/.ssh/<span class="comment">id_rsa.pub -p 22 test@192.168.56.$i</span></span><br><span class="line">    expect <span class="comment">&#123;</span></span><br><span class="line">        #first <span class="comment">connect, no public key in</span> ~/.ssh/<span class="comment">known_hosts</span></span><br><span class="line">        <span class="string">"Are you sure you want to continue connecting (yes/no)?"</span> &#123;</span><br><span class="line">            send <span class="comment">"yes\r"</span>; exp_continue</span><br><span class="line">        &#125;</span><br><span class="line">        #already has public key in ~/.ssh/known_hosts</span><br><span class="line">        <span class="string">"install the new keys"</span> &#123;</span><br><span class="line">            send <span class="string">"\r"</span>; exp_continue</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">"password:"</span> &#123;</span><br><span class="line">            send <span class="string">"$password\r"</span>; exp_continue</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">"Now try logging into the machine"</span> &#123;</span><br><span class="line">            #it has authorized, do nothing!</span><br><span class="line">            ; exp_continue</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、执行脚本<br><code>chmod a+x addkeys.sh</code></p><p><code>./addkeys.sh</code></p><h2 id="批量删除"><a href="#批量删除" class="headerlink" title="批量删除"></a>批量删除</h2><p>添加完密钥之后，发现部分机器不能免密登录。检查客户机中的authorized_keys文件，发现添加了两次密钥。于是决定删除重新添加。</p><p>1、管理机新建脚本delkeys.sh</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/expect </span></span><br><span class="line"><span class="builtin-name">set</span> timeout 30</span><br><span class="line"><span class="builtin-name">set</span> password 123456</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;<span class="builtin-name">set</span> i 101&#125; &#123;<span class="variable">$i</span> &lt; 201&#125; &#123;incr i&#125; &#123;</span><br><span class="line">    spawn ssh test@192.168.56.<span class="variable">$i</span> <span class="string">"rm /home/test/.ssh/authorized_keys"</span></span><br><span class="line">    expect &#123;</span><br><span class="line">        <span class="string">"password:"</span> &#123; send <span class="string">"<span class="variable">$password</span>\r"</span>&#125;</span><br><span class="line">        <span class="string">"No route to host"</span> &#123; send <span class="string">"\r"</span> &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、执行脚本<br><code>chmod a+x delkeys.sh</code></p><p><code>./delkeys.sh</code></p><p>注意，执行完之后检查一下最后一台客户机，也许会删除失败，不知道为什么。</p><h2 id="批量修改权限"><a href="#批量修改权限" class="headerlink" title="批量修改权限"></a>批量修改权限</h2><p>删除后重新添加，依然无法登录，后来发现，是目录权限的问题。用户目录权限是750，<code>~/.ssh</code>权限是700， <code>~/.ssh/authorized_keys</code>权限是600。</p><p>1、权限修改脚本chmods.sh</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/expect </span></span><br><span class="line"><span class="builtin-name">set</span> timeout 30</span><br><span class="line"><span class="builtin-name">set</span> password 123456</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;<span class="builtin-name">set</span> i 101&#125; &#123;<span class="variable">$i</span> &lt; 201&#125; &#123;incr i&#125; &#123;</span><br><span class="line">    spawn ssh test@192.168.56.<span class="variable">$i</span> -t <span class="string">"sudo chmod 750 /home/test/ &amp;&amp; sudo chmod 700 /home/test/.ssh &amp;&amp; sudo chmod 600 /home/test/.ssh/authorized_keys"</span></span><br><span class="line">    expect &#123;</span><br><span class="line">        <span class="string">"password:"</span> &#123; send <span class="string">"<span class="variable">$password</span>\r"</span>; exp_continue &#125;</span><br><span class="line">        <span class="string">"password for test"</span> &#123; send <span class="string">"<span class="variable">$password</span>\r"</span>; exp_continue &#125;</span><br><span class="line">        <span class="string">"No route to host"</span> &#123; send <span class="string">"\r"</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、执行脚本<br><code>chmod a+x chmods.sh</code></p><p><code>./chmods.sh</code></p><h2 id="修改StrictModes"><a href="#修改StrictModes" class="headerlink" title="修改StrictModes"></a>修改StrictModes</h2><p>设置完权限，依然无法免密登录，猜测是StrictModes的问题。</p><p>1、编辑sshd_config<br><code>sudo vi /etc/ssh/sshd_config</code></p><p>2、找到<code>StrictModes yes</code>，改成<code>StrictModes no</code>。</p><p>3、重启sshd，<code>sudo service ssh restart</code></p><p>然后，依然失败。</p><h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>1、不服，进行ssh登录调试，<code>ssh -v test@192.168.56.102</code>或者<code>ssh -vvv test@192.168.56.102</code>。</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">debug1:</span> Authentications that can <span class="string">continue:</span> publickey,password</span><br><span class="line"><span class="string">debug1:</span> Next authentication <span class="string">method:</span> publickey</span><br><span class="line"><span class="string">debug1:</span> Offering RSA <span class="keyword">public</span> <span class="string">key:</span> <span class="regexp">/home/</span>test<span class="regexp">/.ssh/</span>id_rsa</span><br><span class="line"><span class="string">debug1:</span> Authentications that can <span class="string">continue:</span> publickey,password</span><br><span class="line"><span class="string">debug1:</span> Trying <span class="keyword">private</span> <span class="string">key:</span> <span class="regexp">/home/</span>test<span class="regexp">/.ssh/</span>id_dsa</span><br><span class="line"><span class="string">debug1:</span> Trying <span class="keyword">private</span> <span class="string">key:</span> <span class="regexp">/home/</span>test<span class="regexp">/.ssh/</span>id_ecdsa</span><br><span class="line"><span class="string">debug1:</span> Trying <span class="keyword">private</span> <span class="string">key:</span> <span class="regexp">/home/</span>test<span class="regexp">/.ssh/</span>id_ed25519</span><br><span class="line"><span class="string">debug1:</span> Next authentication <span class="string">method:</span> password</span><br></pre></td></tr></table></figure><p>一番折腾，失败，失败，失败。。。</p><p>2、参考<a href="http://schin.space/ops/OPS-ssh-%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E6%80%9D%E8%B7%AF/" target="_blank" rel="noopener">ssh免密登录失败问题排查思路</a>，在客户机查看日志，<code>cat /var/log/auth.log</code>。</p><p>调试方法：<br>（1）客户机执行<code>tail -f /var/log/auth.log</code><br>（2）管理机执行<code>ssh -v test@192.168.56.102</code></p><p>然而，各种尝试依然失败，失败，失败。。。</p><p>3、然后找到一篇<a href="http://www.it610.com/article/3518600.htm" target="_blank" rel="noopener">重建home分区后出现的ssh公钥认证失败问题</a>，猜测是SElinux的问题，于是在客户机执行：</p><p><code>sudo apt-get install policycoreutils</code></p><p><code>restorecon -r -vv /home/</code></p><p>然而，依然没有用。</p><h2 id="使用dsa密钥"><a href="#使用dsa密钥" class="headerlink" title="使用dsa密钥"></a>使用dsa密钥</h2><p>1、生成dsa密钥<br><code>ssh-keygen -t dsa -P &#39;&#39; -f ~/.ssh/id_dsa</code></p><p>2、添加公钥到客户机<br><code>ssh-copy-id -i /home/test/.ssh/id_dsa.pub -p 22 test@192.168.56.102</code></p><p>3、管理机测试登录<br><code>ssh test@192.168.56.102</code></p><p>依然失败。换一个管理机重新添加密钥，依然失败，看来确实是客户机的锅。好吧，放弃了，不玩了！</p><h1 id="设置sudo免密"><a href="#设置sudo免密" class="headerlink" title="设置sudo免密"></a>设置sudo免密</h1><p>以上，假设已经实现了批量添加密钥，也就是实现了所有客户机的免密登录。但是，在客户机执行sudo命令的时候，会提示输入密码，也是很麻烦，所以接下来设置sudo免密执行。</p><p>1、管理机新建脚本addsudo.sh，内容为：</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/expect </span><br><span class="line"><span class="keyword">set</span> timeout <span class="comment">10</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">password 123456</span></span><br><span class="line"></span><br><span class="line">for <span class="comment">&#123;set i 101&#125; &#123;$i &lt;= 200&#125; &#123;incr i&#125; &#123;</span></span><br><span class="line">    spawn <span class="comment">ssh test@192.168.56.$i -t</span> <span class="comment">"sudo -i"</span></span><br><span class="line">    expect <span class="comment">"password for test:"</span></span><br><span class="line">    send <span class="comment">"$password\r"</span></span><br><span class="line">    expect <span class="comment">"*#"</span></span><br><span class="line">    send <span class="comment">"echo test ALL = NOPASSWD: ALL &gt;&gt; /etc/sudoers \r"</span></span><br><span class="line">    expect <span class="comment">"*#"</span></span><br><span class="line">    send <span class="comment">"exit\r"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、执行脚本<br><code>chmod a+x addsudo.sh</code></p><p><code>./addsudo.sh</code></p><h1 id="批量修改密码"><a href="#批量修改密码" class="headerlink" title="批量修改密码"></a>批量修改密码</h1><p><a href="https://www.voidking.com/dev-pssh-manage-linux/#%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A0%81">《批量修改密码》</a>一节中，我们采用的修改密码的方式是给所有的客户机都安装expect，然后发送脚本到客户机并执行脚本。给每台机器安装expect，不是一个好的做法。不妨参照设置sudo免密，在管理机执行脚本，虽然无法并行，但是胜在不需要给客户机安装expect。</p><p>不过，这次我们换一种脚本写法，使用bash脚本循环调用expect脚本。这种写法更好，更加稳定。因为在expect脚本中写循环语句，有些字符串会不显示，影响执行效果。</p><p>1、新建expect脚本m-chpasswd.sh</p><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/expect </span></span><br><span class="line"><span class="keyword">set</span> timeout <span class="number">10</span></span><br><span class="line"><span class="keyword">set</span> newpassword <span class="number">12345678</span></span><br><span class="line"><span class="keyword">set</span> i [<span class="keyword">lindex</span> $argv <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">spawn ssh test@<span class="number">192.168</span><span class="number">.56</span>.$i -t <span class="string">"sudo passwd test"</span></span><br><span class="line">expect <span class="string">"Enter new UNIX password:"</span></span><br><span class="line">send <span class="string">"$newpassword\r"</span></span><br><span class="line">expect <span class="string">"Retype new UNIX password:"</span></span><br><span class="line">send <span class="string">"$newpassword\r"</span></span><br><span class="line">expect <span class="string">"closed"</span> </span><br><span class="line">send <span class="string">"\r"</span></span><br><span class="line">expect <span class="keyword">eof</span></span><br></pre></td></tr></table></figure><p>2、新建bash脚本loop-passwd.sh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">for</span> ((i=101;i&lt;=200;i++))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"begin..."</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$i</span></span><br><span class="line">    ./m-chpasswd.sh <span class="variable">$i</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"end..."</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>3、执行脚本<br><code>chmod a+x m-chpasswd.sh</code></p><p><code>chmod a+x loop-passwd.sh</code></p><p><code>./loop-passwd.sh</code></p><h1 id="批量修改hosts"><a href="#批量修改hosts" class="headerlink" title="批量修改hosts"></a>批量修改hosts</h1><p><a href="https://www.voidking.com/dev-pssh-manage-linux/#%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9hostname">《批量修改hostname》</a>一节中，我们给三台机器设置了主机名，比较简单。现在假设我们有100台机器需要管理，IP为192.168.56.101-200，现在要给它们设置主机名，同时修改它们的<code>/etc/hosts</code>文件，方便使用主机名相互寻找。</p><h2 id="自动生成hosts"><a href="#自动生成hosts" class="headerlink" title="自动生成hosts"></a>自动生成hosts</h2><p>1、在管理机新建脚本makehosts.sh，内容为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"127.0.0.1    localhost"</span> &gt; /home/<span class="built_in">test</span>/hosts</span><br><span class="line">NUM=101</span><br><span class="line"><span class="keyword">while</span> [ <span class="variable">$NUM</span> -lt 201 ]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"192.168.56.<span class="variable">$NUM</span>    vk<span class="variable">$NUM</span>"</span> &gt;&gt; /home/<span class="built_in">test</span>/hosts</span><br><span class="line">    NUM=`expr <span class="variable">$NUM</span> + 1`</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>2、执行脚本<br><code>sudo chmod a+x makehosts.sh</code></p><p><code>./makehosts.sh</code></p><p>3、替换hosts<br><code>sudo cp hosts /etc/hosts</code></p><p>PS：添加一条新的记录到 /etc/hosts ，<code>sudo bash -c &quot;echo 192.168.56.201 vk201 &gt;&gt; /etc/hosts&quot;</code></p><h2 id="修改客户机hosts"><a href="#修改客户机hosts" class="headerlink" title="修改客户机hosts"></a>修改客户机hosts</h2><p>1、拷贝hosts文件到客户机<br><code>pscp -h hosts.txt ./hosts /home/test</code></p><p>2、替换hosts文件<br><code>pssh -h hosts.txt -i &quot;sudo cp /home/test/hosts /etc/hosts&quot;</code></p><h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>本文在写作之前，思路很明确，以为可以半天搞定，没想到遇到了一个大坑：部分机器无法免密登录。大大小小试了十几种解决办法，未果，折腾了一整天，还是无奈放弃。</p><p>设置sudo免密时还有一个方案，就是写一个脚本发送到客户机，在客户机执行修改/etc/sudoers文件。但是要求所有客户机都安装了expect，这个很麻烦，不如在管理机操作。</p><h1 id="20180614更新"><a href="#20180614更新" class="headerlink" title="20180614更新"></a>20180614更新</h1><p>今天，突然冒出一个想法，如果换一个用户呢？不再用test，而是使用test2用户。于是，进行了测试。</p><p>1、客户机新建test2用户<br><code>sudo useradd -m test2 -s /bin/bash</code></p><p><code>sudo passwd test2</code></p><p>根据需要给予sudo权限，<code>sudo adduser test2 sudo</code></p><p>2、管理机添加免密登录<br><code>ssh-copy-id -i .ssh/id_rsa.pub -p 22 test2@192.168.56.102</code></p><p>3、测试登录<br><code>ssh test2@192.168.56.102</code></p><p>登录成功！！！</p><p>那么，如果我删除test用户，再添加新的test用户，是不是也可以呢？</p><p>1、客户机删除test用户<br><code>sudo userdel -r test</code><br>提示userdel: user test is currently used by process 62901</p><p>2、查看最近登录情况<br><code>w</code>，<code>last</code></p><p>并没有人在使用这个账号，那就继续想办法删除。</p><p>3、使用vipw<br><code>sudo vipw</code>，找到test用户那行，删除。</p><p><code>sudo vipw -s</code>，找到test用户那行，删除。</p><p>4、删除test目录<br><code>cd /home &amp;&amp; sudo rm -rf test</code></p><p>5、新建test用户<br><code>sudo useradd -m test -g test -s /bin/bash</code></p><p><code>sudo passwd test</code></p><p><code>sudo adduser test sudo</code></p><p>7、管理机添加免密登录<br><code>ssh-copy-id -i .ssh/id_rsa.pub -p 22 test@192.168.56.102</code></p><p>8、测试登录<br><code>ssh test@192.168.56.102</code></p><p>登录成功！！！问题完美结局，不过确实很麻烦。</p><p>如果，单纯地拷贝其他客户机的整个test用户目录呢？假设客户机A的IP为192.168.56.102，已经配置完成，可以免密登录；客户机B的IP为192.168.56.103，不可以免密登录。</p><p>1、删除客户机B的test目录下所有文件<br><code>rf -rf ./*</code></p><p><code>rf -rf ./.*</code></p><p>2、拷贝配置好的客户机A的test目录到客户机B<br><code>scp test@192.168.56.102:~/.* .</code></p><p><code>scp test@192.168.56.102:~/.ssh/* .ssh/</code></p><p>3、在管理机测试登录<br><code>ssh test@192.168.56.103</code></p><p>登录成功！！！这个方法明显更好，nice。</p></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/linux/" rel="tag"># linux</a> <a href="/tags/shell/" rel="tag"># shell</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-linux-mail/" rel="prev" title="Linux设置邮件提醒"><i class="fa fa-chevron-left"></i> Linux设置邮件提醒</a></div><div class="post-nav-item"> <a href="/dev-windows-gym/" rel="next" title="Windows安装配置Gym">Windows安装配置Gym<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zODU3Mi8xNTEwMA=="></div></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#批量添加密钥"><span class="nav-number">2.</span> <span class="nav-text">批量添加密钥</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#基线版本"><span class="nav-number">2.1.</span> <span class="nav-text">基线版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#升级版本"><span class="nav-number">2.2.</span> <span class="nav-text">升级版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#批量版本"><span class="nav-number">2.3.</span> <span class="nav-text">批量版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#批量删除"><span class="nav-number">2.4.</span> <span class="nav-text">批量删除</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#批量修改权限"><span class="nav-number">2.5.</span> <span class="nav-text">批量修改权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改StrictModes"><span class="nav-number">2.6.</span> <span class="nav-text">修改StrictModes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调试"><span class="nav-number">2.7.</span> <span class="nav-text">调试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用dsa密钥"><span class="nav-number">2.8.</span> <span class="nav-text">使用dsa密钥</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#设置sudo免密"><span class="nav-number">3.</span> <span class="nav-text">设置sudo免密</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#批量修改密码"><span class="nav-number">4.</span> <span class="nav-text">批量修改密码</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#批量修改hosts"><span class="nav-number">5.</span> <span class="nav-text">批量修改hosts</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#自动生成hosts"><span class="nav-number">5.1.</span> <span class="nav-text">自动生成hosts</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改客户机hosts"><span class="nav-number">5.2.</span> <span class="nav-text">修改客户机hosts</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#后记"><span class="nav-number">6.</span> <span class="nav-text">后记</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#20180614更新"><span class="nav-number">7.</span> <span class="nav-text">20180614更新</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">学而不思则罔，思而不学则殆！</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">619</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">50</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">198</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2021</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://www.beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={iconStyle:"box",boxForm:"horizontal",position:"bottomCenter",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={iconStyle:"box",boxForm:"horizontal",position:"topRight",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-float",flOptions)</script><script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  // window.livereOptions = {
  //   refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  // };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script></body></html>