<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>å¥½å¥½å­¦ä¹ çš„éƒ</title>
  
  <subtitle>å¥½å¥½å­¦ä¹ ï¼Œå¤©å¤©å‘ä¸Šï¼</subtitle>
  <link href="https://www.voidking.com/atom.xml" rel="self"/>
  
  <link href="https://www.voidking.com/"/>
  <updated>2023-02-26T19:00:00.000Z</updated>
  <id>https://www.voidking.com/</id>
  
  <author>
    <name>å¥½å¥½å­¦ä¹ çš„éƒ</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Hexoé…ç½®GitHub Actionsè‡ªåŠ¨æ„å»ºå‘å¸ƒ</title>
    <link href="https://www.voidking.com/dev-hexo-github-actions/"/>
    <id>https://www.voidking.com/dev-hexo-github-actions/</id>
    <published>2023-02-25T20:00:00.000Z</published>
    <updated>2023-02-26T19:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Travis-CIå¿…é¡»ä»˜è´¹äº†"><a href="#Travis-CIå¿…é¡»ä»˜è´¹äº†" class="headerlink" title="Travis CIå¿…é¡»ä»˜è´¹äº†"></a>Travis CIå¿…é¡»ä»˜è´¹äº†</h1><p>2023å¹´2æœˆ25æ—¥ï¼Œä½¿ç”¨travis ciéƒ¨ç½²hexoé¡¹ç›®ï¼Œå‘ç°å¹¶æ²¡æœ‰è§¦å‘ä»»åŠ¡ã€‚</p><p>ç™»å½•<a href="https://www.travis-ci.com/">travis ci</a>ï¼Œå‘ç°æç¤ºï¼š</p><blockquote><p>Builds have been temporarily disabled for public repositories due to a negative credit balance. Please go to the Plan page to replenish your credit balance or alter your Consume paid credits for OSS setting.</p></blockquote><p>åœ¨<a href="https://app.travis-ci.com/account/plan">travis ci plan</a>é¡µé¢å…³é—­äº†Consume paid credits for OSSï¼Œä½†æ˜¯ä¾ç„¶æç¤ºï¼š</p><blockquote><p>Builds have been temporarily disabled for private and public repositories due to a negative credit balance. Please go to the Plan page to replenish your credit balance.</p></blockquote><p>ç‚¹å‡»Change planï¼Œå‘ç°å·²ç»æ²¡æœ‰å…è´¹çš„planäº†ï¼Œè€Œæœ€ä¾¿å®œçš„planï¼Œä¹Ÿè¦<code>$69/monthly</code>ï¼Œå¤ªè´µäº†ï¼Œæ”¾å¼ƒã€‚<br>ä¸è¿‡å¯ä»¥ç†è§£ï¼Œæ¯•ç«Ÿè·‘CIæ˜¯éœ€è¦æœåŠ¡å™¨çš„ï¼ŒæœåŠ¡å™¨æ˜¯éœ€è¦èŠ±é’±çš„ã€‚</p><p>é‚£å°±æ¢æˆ<a href="https://docs.github.com/en/actions">GitHub Actions</a>å§ï¼Œæœ‰ä»˜è´¹ç‰ˆï¼Œä¹Ÿæœ‰å…è´¹ç‰ˆã€‚</p><span id="more"></span><h1 id="Quickstart-for-GitHub-Actions"><a href="#Quickstart-for-GitHub-Actions" class="headerlink" title="Quickstart for GitHub Actions"></a>Quickstart for GitHub Actions</h1><p>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://docs.github.com/en/actions/quickstart">Quickstart for GitHub Actions</a></p><p>1ã€ åˆ›å»ºæ–°çš„åˆ†æ”¯ï¼ˆå› ä¸ºåŸåˆ†æ”¯æ˜¯é€‚ç”¨äºtravis ciçš„ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b github-action</span><br><span class="line">git push origin HEAD:github-action</span><br></pre></td></tr></table></figure><p>2ã€ åˆ›å»º github-actions-demo.yml æ–‡ä»¶<br><a href="https://github.com/voidking/hexo-deploy">voidking/hexo-deploy</a>é¡¹ç›®ä¸­æ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p .github/workflows</span><br><span class="line">vim .github/workflows/github-actions-demo.yml</span><br></pre></td></tr></table></figure><p>github-actions-demo.yml æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">GitHub</span> <span class="string">Actions</span> <span class="string">Demo</span></span><br><span class="line"><span class="attr">run-name:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.actor</span> <span class="string">&#125;&#125;</span> <span class="string">is</span> <span class="string">testing</span> <span class="string">out</span> <span class="string">GitHub</span> <span class="string">Actions</span> <span class="string">ğŸš€</span></span><br><span class="line"><span class="attr">on:</span> [<span class="string">push</span>]</span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">Explore-GitHub-Actions:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;ğŸ‰ The job was automatically triggered by a $<span class="template-variable">&#123;&#123; github.event_name &#125;&#125;</span> event.&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;ğŸ§ This job is now running on a $<span class="template-variable">&#123;&#123; runner.os &#125;&#125;</span> server hosted by GitHub!&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;ğŸ” The name of your branch is $<span class="template-variable">&#123;&#123; github.ref &#125;&#125;</span> and your repository is $<span class="template-variable">&#123;&#123; github.repository &#125;&#125;</span>.&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">out</span> <span class="string">repository</span> <span class="string">code</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v3</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;ğŸ’¡ The $<span class="template-variable">&#123;&#123; github.repository &#125;&#125;</span> repository has been cloned to the runner.&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;ğŸ–¥ï¸ The workflow is now ready to test your code on the runner.&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">List</span> <span class="string">files</span> <span class="string">in</span> <span class="string">the</span> <span class="string">repository</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          ls $&#123;&#123; github.workspace &#125;&#125;</span></span><br><span class="line"><span class="string"></span>      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;ğŸ This job&#x27;s status is $<span class="template-variable">&#123;&#123; job.status &#125;&#125;</span>.&quot;</span></span><br></pre></td></tr></table></figure><p>3ã€ ä¸Šä¼ ä»£ç </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">&quot;github action test&quot;</span></span><br><span class="line">git push</span><br></pre></td></tr></table></figure><p>æŠ¥é”™ï¼šrefusing to allow a Personal Access Token to create or update workflow <code>.github/workflows/github-actions-demo.yml</code> without <code>workflow</code> scope</p><p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬çš„Access Tokenéœ€è¦å…·æœ‰create or update workflowçš„æƒé™ï¼Œå› æ­¤éœ€è¦é‡æ–°åˆ›å»ºä¸€ä¸ªAccess Tokenã€‚<br>å…·ä½“æ“ä½œæ–¹æ³•ï¼šè®¿é—®<a href="https://github.com/settings/tokens">Personal access tokens (classic)</a>é¡µé¢ï¼ŒGenerate new tokenï¼Œç”Ÿæˆtokenæ—¶ä¸€å®šè¦å‹¾é€‰repoå’Œworkflowã€‚</p><p>ç„¶åï¼Œä½¿ç”¨æ–°çš„tokenå†æ¬¡pushå³å¯ã€‚ä¿®æ”¹tokençš„æ–¹æ³•å‚è€ƒæ–‡æ¡£<a href="https://www.voidking.com/dev-git/command/">ã€ŠGitå®ç”¨å‘½ä»¤ã€‹</a>ã€‚</p><p>4ã€æŸ¥çœ‹Actions<br>è®¿é—®<a href="https://github.com/voidking/hexo-deploy/actions">voidking/hexo-deploy Actions</a>é¡µé¢ï¼Œå³å¯çœ‹åˆ°CI workflowsï¼ˆç›¸å½“äºgitlabä¸­çš„pipelinesï¼‰ã€‚</p><h1 id="Hexoé…ç½®GitHub-Actions"><a href="#Hexoé…ç½®GitHub-Actions" class="headerlink" title="Hexoé…ç½®GitHub Actions"></a>Hexoé…ç½®GitHub Actions</h1><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://docs.github.com/en/actions">GitHub Actions</a></li><li><a href="https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions">Workflow syntax for GitHub Actions</a></li><li><a href="https://github.com/marketplace/actions/hexo-action">Hexo Action</a></li><li><a href="https://sanonz.github.io/2020/deploy-a-hexo-blog-from-github-actions/">åˆ©ç”¨ Github Actions è‡ªåŠ¨éƒ¨ç½² Hexo åšå®¢</a></li><li><a href="https://www.ruanyifeng.com/blog/2019/12/github_actions.html">GitHub Actions æ•™ç¨‹ï¼šå®šæ—¶å‘é€å¤©æ°”é‚®ä»¶</a></li></ul><h2 id="CICDæ€è·¯"><a href="#CICDæ€è·¯" class="headerlink" title="CICDæ€è·¯"></a>CICDæ€è·¯</h2><ol><li>æ‹‰å–è´Ÿè´£éƒ¨ç½²çš„hexo-deploy repoï¼Œé‡Œé¢æ˜¯hexoçš„é…ç½®æ–‡ä»¶ï¼ˆå…³äºç«™ç‚¹é…ç½®å’Œæ„å»ºé…ç½®ç­‰ï¼Œè¯¦æƒ…å‚è€ƒ<a href="https://www.voidking.com/dev-hexo-travis-ci/">ã€ŠHexoé…ç½®Travis CIè‡ªåŠ¨æ„å»ºå‘å¸ƒã€‹</a>ï¼‰</li><li>æ‹‰å–hexo theme repoï¼Œé‡Œé¢æ˜¯ç«™ç‚¹ä¸»é¢˜</li><li>æ‹‰å–hexo-backup repoï¼Œé‡Œé¢æ˜¯markdownæ–‡æ¡£</li><li>hexo-backupä¸­çš„æ–‡æ¡£æ”¾åˆ°hexoå¯ä»¥æ„å»ºï¼ˆç¼–è¯‘ï¼‰çš„ä½ç½®</li><li>å®‰è£…nodejs</li><li>å®‰è£…hexoã€gulpç­‰ä¾èµ–</li><li>æ‰§è¡Œæ„å»ºï¼ˆç¼–è¯‘ï¼‰</li><li>ä¸Šä¼ ç¼–è¯‘åçš„htmlç­‰é™æ€æ–‡ä»¶åˆ°ä¸¤ä¸ªpages repo<br>a. github pagesæ˜¯å›½å¤–æµé‡çš„æºç«™<br>b. aliyun serveræ˜¯å›½å†…æµé‡çš„æºç«™<br>c. aliyun serverä»gitee pagesæ‹‰å–æœ€æ–°ç‰ˆæœ¬<br>d. gitee pagesæœ¬èº«ä¸å¯¹å¤–æä¾›æœåŠ¡ï¼Œåªæ˜¯ä½œä¸ºä¸€ä¸ªgitä»“åº“</li><li>aliyun serverä»gitee pagesæ‹‰å–æœ€æ–°ç‰ˆæœ¬</li></ol><h2 id="å‡†å¤‡github-actions-yml"><a href="#å‡†å¤‡github-actions-yml" class="headerlink" title="å‡†å¤‡github-actions.yml"></a>å‡†å¤‡github-actions.yml</h2><p>github-actions.ymlå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Hexo</span> <span class="string">CICD</span></span><br><span class="line"><span class="attr">run-name:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.actor</span> <span class="string">&#125;&#125;</span> <span class="string">build</span> <span class="string">and</span> <span class="string">deploy</span> <span class="string">hexo!</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">github-actions</span></span><br><span class="line"></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">GIT_USER:</span> <span class="string">voidking</span></span><br><span class="line">  <span class="attr">HEXO_BACKUP_REPO:</span> <span class="string">voidking/hexo-backup</span></span><br><span class="line">  <span class="attr">HEXO_BACKUP_REPO_BRANCH:</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">HEXO_THEME_REPO:</span> <span class="string">voidking/hexo-theme-next</span></span><br><span class="line">  <span class="attr">HEXO_THEME_REPO_BRANCH:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">GITHUB_PAGES_REPO:</span> <span class="string">github.com/voidking/voidking.github.io.git</span></span><br><span class="line">  <span class="attr">GITEE_PAGES_REPO:</span> <span class="string">gitee.com/voidking/voidking.git</span></span><br><span class="line">  <span class="attr">GITHUB_PAGES_URL:</span> <span class="string">&quot;https://$&#123;GIT_USER&#125;:$<span class="template-variable">&#123;&#123; secrets.GH_TOKEN &#125;&#125;</span>@$&#123;GITHUB_PAGES_REPO&#125;&quot;</span></span><br><span class="line">  <span class="attr">GITEE_PAGES_URL:</span> <span class="string">&quot;https://$&#123;GIT_USER&#125;:$<span class="template-variable">&#123;&#123; secrets.GITEE_TOKEN &#125;&#125;</span>@$&#123;GITEE_PAGES_REPO&#125;&quot;</span></span><br><span class="line">  <span class="attr">ALI_IP:</span> <span class="number">8.136</span><span class="number">.13</span><span class="number">.58</span></span><br><span class="line">  <span class="attr">ALI_USER:</span> <span class="string">voidking</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Build</span> <span class="string">on</span> <span class="string">node</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.node_version</span> <span class="string">&#125;&#125;</span> <span class="string">and</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.os</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">os:</span> [<span class="string">ubuntu-latest</span>]</span><br><span class="line">        <span class="attr">node_version:</span> [<span class="number">12.22</span><span class="number">.5</span>]</span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">repo</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">theme</span> <span class="string">repo</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">repository:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.HEXO_THEME_REPO</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">ref:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.HEXO_THEME_REPO_BRANCH</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">themes/next</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">hexo-backup</span> <span class="string">repo</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">repository:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.HEXO_BACKUP_REPO</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">ref:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.HEXO_BACKUP_REPO_BRANCH</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">hexo-backup</span></span><br><span class="line">        <span class="attr">token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GH_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Move</span> <span class="string">markdown</span> <span class="string">articles</span> <span class="string">to</span> <span class="string">current</span> <span class="string">directory</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">mv</span> <span class="string">hexo-backup/source</span> <span class="string">.</span> <span class="string">&amp;&amp;</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">source/private</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">nodejs</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.node_version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">actions/setup-node@v3</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">node-version:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.node_version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">nodejs</span> <span class="string">dependencies</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">nodejs</span> <span class="string">project</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Push</span> <span class="string">to</span> <span class="string">voidking.github.io</span> <span class="string">and</span> <span class="string">gitee</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        git config --global user.name &quot;voidking&quot;</span></span><br><span class="line"><span class="string">        git config --global user.email &quot;voidking@qq.com&quot;</span></span><br><span class="line"><span class="string">        git clone https://$&#123;&#123; secrets.GH_TOKEN &#125;&#125;@$&#123;&#123; env.GITHUB_PAGES_REPO &#125;&#125; voidking</span></span><br><span class="line"><span class="string">        cd voidking</span></span><br><span class="line"><span class="string">        rm -rfv `ls -a | grep -vw &#x27;\.&#x27; | grep -vw &#x27;\.git&#x27; | xargs`</span></span><br><span class="line"><span class="string">        ls -al</span></span><br><span class="line"><span class="string">        # unalias cp </span></span><br><span class="line"><span class="string">        cp -rf ../public/. .</span></span><br><span class="line"><span class="string">        cp ../source/.travis.yml .</span></span><br><span class="line"><span class="string">        git add . &amp;&amp; git commit -m &quot;GitHub Actions Auto Builder&quot;</span></span><br><span class="line"><span class="string">        git push --force --quiet $&#123;&#123; env.GITHUB_PAGES_URL &#125;&#125; master:master</span></span><br><span class="line"><span class="string">        git push --force --quiet $&#123;&#123; env.GITEE_PAGES_URL &#125;&#125; master:master</span></span><br><span class="line"><span class="string"></span>  </span><br><span class="line">  <span class="attr">deploy:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">to</span> <span class="string">Aliyun</span> <span class="string">Server</span></span><br><span class="line">    <span class="attr">needs:</span> <span class="string">build</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">id_rsa</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        mkdir -p ~/.ssh/</span></span><br><span class="line"><span class="string">        echo $&#123;&#123; secrets.ID_RSA &#125;&#125; | base64 -d &gt; ~/.ssh/id_rsa</span></span><br><span class="line"><span class="string">        chmod 600 ~/.ssh/id_rsa</span></span><br><span class="line"><span class="string"></span>    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Execute</span> <span class="string">ssh</span> <span class="string">command</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        ssh -o StrictHostKeyChecking=no \</span></span><br><span class="line"><span class="string">        -o PubkeyAcceptedKeyTypes=ssh-rsa \</span></span><br><span class="line"><span class="string">        $&#123;&#123; env.ALI_USER &#125;&#125;@$&#123;&#123; env.ALI_IP &#125;&#125; \</span></span><br><span class="line"><span class="string">        &quot;cd /opt/nginx/work/voidking/ &amp;&amp; git pull --force --quiet $&#123;&#123; env.GITEE_PAGES_URL &#125;&#125; master:master&quot;</span></span><br></pre></td></tr></table></figure><p>è¯´æ˜ï¼š</p><ul><li>github actionä¸­å®šä¹‰å˜é‡æœ‰ä¸‰ç§æ–¹å¼ï¼švarsã€secretså’Œenvã€‚</li><li>vars/secretsåœ¨workflowè§¦å‘å‰å®šä¹‰ï¼Œenvåœ¨workflowè§¦å‘åå®šä¹‰ã€‚</li><li><code>$&#123;&#123;&#125;&#125;</code>åŒèŠ±æ‹¬å·è¡¨ç¤ºä¸Šä¸‹æ–‡å¼•ç”¨ï¼Œè¯¦æƒ…å‚è€ƒ<a href="https://docs.github.com/en/actions/learn-github-actions/contexts#context-availability">Context availability</a>ã€‚</li><li><code>$&#123;&#125;</code>å•èŠ±æ‹¬å·è¡¨ç¤ºshellæ–¹å¼ä½¿ç”¨ä¸­envå˜é‡ã€‚</li><li>ä½¿ç”¨envä¸­çš„å˜é‡æœ‰ä¸¤ç§æ–¹å¼ï¼šä¸Šä¸‹æ–‡å¼•ç”¨å’Œshellæ–¹å¼ä½¿ç”¨ã€‚</li></ul><h2 id="é…ç½®åŠ å¯†å˜é‡"><a href="#é…ç½®åŠ å¯†å˜é‡" class="headerlink" title="é…ç½®åŠ å¯†å˜é‡"></a>é…ç½®åŠ å¯†å˜é‡</h2><p>ä¸Šé¢çš„workflowé…ç½®ä¸­ï¼Œç”¨åˆ°äº†ä¸€äº›æ•æ„Ÿå˜é‡ï¼ŒGH_TOKENã€GITEE_TOKENå’ŒID_RSAï¼Œè¿™äº›å˜é‡éœ€è¦åŠ å¯†ã€‚</p><p>é…ç½®åŠ å¯†å˜é‡çš„æ–¹æ³•ï¼š</p><ul><li>repositoryçº§åˆ«å˜é‡ï¼šProject -&gt; Settings -&gt; Actions secrets and variables -&gt; New repository secret</li><li>environmentsçº§åˆ«å˜é‡ï¼šProject -&gt; Settings -&gt; Actions secrets and variables -&gt; Manage enviroments -&gt; New enviroment -&gt; Environment secrets -&gt; Add secret</li></ul><p>å…¶ä¸­ID_RSAçš„è·å–æ–¹æ³•ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line">ALI_IP=<span class="string">&quot;8.136.13.58&quot;</span></span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub voidking@<span class="variable">$&#123;ALI_IP&#125;</span></span><br><span class="line"><span class="built_in">cat</span> .ssh/id_rsa | <span class="built_in">base64</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="CICDæµ‹è¯•"><a href="#CICDæµ‹è¯•" class="headerlink" title="CICDæµ‹è¯•"></a>CICDæµ‹è¯•</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">&quot;github action test&quot;</span></span><br><span class="line">git push</span><br></pre></td></tr></table></figure><p>è®¿é—®<a href="https://github.com/voidking/hexo-deploy/actions">voidking/hexo-deploy Actions</a>é¡µé¢ï¼Œå³å¯çœ‹åˆ°æœ€æ–°çš„workflowã€‚<br>æœ€å¼€å§‹éš¾å…å‡ºé”™ï¼Œæ ¹æ®æŠ¥é”™è¿›è¡Œè°ƒæ•´å³å¯ã€‚</p><p>æœ€ç»ˆï¼Œå®ç°äº†å’Œtravis ciä¸Šä¸€æ ·çš„åŠŸèƒ½ï¼Œniceã€‚</p><h1 id="è¸©å‘è®°å½•"><a href="#è¸©å‘è®°å½•" class="headerlink" title="è¸©å‘è®°å½•"></a>è¸©å‘è®°å½•</h1><h2 id="envä¸èƒ½ç”¨åœ¨job-if"><a href="#envä¸èƒ½ç”¨åœ¨job-if" class="headerlink" title="envä¸èƒ½ç”¨åœ¨job:if"></a>envä¸èƒ½ç”¨åœ¨job:if</h2><p>å½“ä½¿ç”¨job:ifæ—¶ï¼Œå¦‚ä¸‹å®šä¹‰ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">BUILD:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Build</span></span><br><span class="line">    <span class="attr">if:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.BUILD</span> <span class="string">==</span> <span class="string">&quot;true&quot;</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br></pre></td></tr></table></figure><p>æŠ¥é”™ï¼š Unrecognized named-value: â€˜envâ€™. Located at position 1 within expression: env.BUILD == â€œtrueâ€ .github/workflows/github-actions.yml</p><p>è¿™æ˜¯ä¸ªgithub actionçš„å‘ï¼Œå‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://github.com/actions/runner/issues/480">Workflow level env does not work properly in all fields.</a></li><li><a href="https://github.com/actions/runner/issues/1661">workflow level env. is unrecognised on job levelâ€™s â€˜ifâ€™-expression when calling reusable workflow</a></li></ul><h2 id="workflow-dispatchæ— æ•ˆ"><a href="#workflow-dispatchæ— æ•ˆ" class="headerlink" title="workflow_dispatchæ— æ•ˆ"></a>workflow_dispatchæ— æ•ˆ</h2><p>å½“ä½¿ç”¨job:ifæ—¶ï¼Œå¦‚ä¸‹å®šä¹‰ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">workflow_dispatch:</span></span><br><span class="line">    <span class="attr">inputs:</span></span><br><span class="line">      <span class="attr">build:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&quot;build project&quot;</span></span><br><span class="line">        <span class="attr">required:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">default:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">boolean</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Build</span></span><br><span class="line">    <span class="attr">if:</span> <span class="string">$&#123;&#123;</span> <span class="string">inputs.build</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br></pre></td></tr></table></figure><p>æ— æ³•è§¦å‘build jobã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;Travis-CIå¿…é¡»ä»˜è´¹äº†&quot;&gt;&lt;a href=&quot;#Travis-CIå¿…é¡»ä»˜è´¹äº†&quot; class=&quot;headerlink&quot; title=&quot;Travis CIå¿…é¡»ä»˜è´¹äº†&quot;&gt;&lt;/a&gt;Travis CIå¿…é¡»ä»˜è´¹äº†&lt;/h1&gt;&lt;p&gt;2023å¹´2æœˆ25æ—¥ï¼Œä½¿ç”¨travis ciéƒ¨ç½²hexoé¡¹ç›®ï¼Œå‘ç°å¹¶æ²¡æœ‰è§¦å‘ä»»åŠ¡ã€‚&lt;/p&gt;
&lt;p&gt;ç™»å½•&lt;a href=&quot;https://www.travis-ci.com/&quot;&gt;travis ci&lt;/a&gt;ï¼Œå‘ç°æç¤ºï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Builds have been temporarily disabled for public repositories due to a negative credit balance. Please go to the Plan page to replenish your credit balance or alter your Consume paid credits for OSS setting.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;åœ¨&lt;a href=&quot;https://app.travis-ci.com/account/plan&quot;&gt;travis ci plan&lt;/a&gt;é¡µé¢å…³é—­äº†Consume paid credits for OSSï¼Œä½†æ˜¯ä¾ç„¶æç¤ºï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Builds have been temporarily disabled for private and public repositories due to a negative credit balance. Please go to the Plan page to replenish your credit balance.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ç‚¹å‡»Change planï¼Œå‘ç°å·²ç»æ²¡æœ‰å…è´¹çš„planäº†ï¼Œè€Œæœ€ä¾¿å®œçš„planï¼Œä¹Ÿè¦&lt;code&gt;$69/monthly&lt;/code&gt;ï¼Œå¤ªè´µäº†ï¼Œæ”¾å¼ƒã€‚&lt;br&gt;ä¸è¿‡å¯ä»¥ç†è§£ï¼Œæ¯•ç«Ÿè·‘CIæ˜¯éœ€è¦æœåŠ¡å™¨çš„ï¼ŒæœåŠ¡å™¨æ˜¯éœ€è¦èŠ±é’±çš„ã€‚&lt;/p&gt;
&lt;p&gt;é‚£å°±æ¢æˆ&lt;a href=&quot;https://docs.github.com/en/actions&quot;&gt;GitHub Actions&lt;/a&gt;å§ï¼Œæœ‰ä»˜è´¹ç‰ˆï¼Œä¹Ÿæœ‰å…è´¹ç‰ˆã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="engineering" scheme="https://www.voidking.com/categories/engineering/"/>
    
    <category term="devops" scheme="https://www.voidking.com/categories/engineering/devops/"/>
    
    <category term="hexo" scheme="https://www.voidking.com/categories/engineering/hexo/"/>
    
    <category term="troubleshooting" scheme="https://www.voidking.com/categories/engineering/troubleshooting/"/>
    
    
    <category term="é—®é¢˜æ’æŸ¥" scheme="https://www.voidking.com/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"/>
    
    <category term="git" scheme="https://www.voidking.com/tags/git/"/>
    
    <category term="cicd" scheme="https://www.voidking.com/tags/cicd/"/>
    
    <category term="hexo" scheme="https://www.voidking.com/tags/hexo/"/>
    
    <category term="travis-ci" scheme="https://www.voidking.com/tags/travis-ci/"/>
    
    <category term="github-actions" scheme="https://www.voidking.com/tags/github-actions/"/>
    
  </entry>
  
  <entry>
    <title>CentOS8æ›´æ¢è½¯ä»¶å®‰è£…æº</title>
    <link href="https://www.voidking.com/dev-centos8-change-repo/"/>
    <id>https://www.voidking.com/dev-centos8-change-repo/</id>
    <published>2023-02-07T17:00:00.000Z</published>
    <updated>2023-02-07T17:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>CentOS8å·²äº2021å¹´12æœˆ31æ—¥åœæ­¢ç»´æŠ¤ï¼Œåœ¨2022å¹´1æœˆ31æ—¥ï¼ŒCentOSå›¢é˜Ÿç»ˆäºä»å®˜æ–¹é•œåƒä¸­ç§»é™¤CentOS8çš„æ‰€æœ‰åŒ…ã€‚</p><p>å¦‚æœä»ç„¶éœ€è¦è¿è¡ŒCentOS8ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨/etc/yum.repos.dä¸­æ›´æ–°å®‰è£…æºã€‚</p><span id="more"></span><h1 id="æ›´æ¢æ–¹æ³•"><a href="#æ›´æ¢æ–¹æ³•" class="headerlink" title="æ›´æ¢æ–¹æ³•"></a>æ›´æ¢æ–¹æ³•</h1><p>1ã€å¤‡ä»½åŸå®‰è£…æº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> -r /etc/yum.repos.d&#123;,.bak&#125;</span><br></pre></td></tr></table></figure><p>2ã€æ›¿æ¢å®‰è£…æº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> /etc/yum.repos.d/*.repo -rf</span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo</span><br><span class="line"><span class="comment">#curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo</span></span><br></pre></td></tr></table></figure><p>3ã€æ›´æ–°å®‰è£…æº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;CentOS8å·²äº2021å¹´12æœˆ31æ—¥åœæ­¢ç»´æŠ¤ï¼Œåœ¨2022å¹´1æœˆ31æ—¥ï¼ŒCentOSå›¢é˜Ÿç»ˆäºä»å®˜æ–¹é•œåƒä¸­ç§»é™¤CentOS8çš„æ‰€æœ‰åŒ…ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœä»ç„¶éœ€è¦è¿è¡ŒCentOS8ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨/etc/yum.repos.dä¸­æ›´æ–°å®‰è£…æºã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="engineering" scheme="https://www.voidking.com/categories/engineering/"/>
    
    <category term="devops" scheme="https://www.voidking.com/categories/engineering/devops/"/>
    
    
    <category term="linux" scheme="https://www.voidking.com/tags/linux/"/>
    
    <category term="centos" scheme="https://www.voidking.com/tags/centos/"/>
    
  </entry>
  
  <entry>
    <title>GitLab CIé—®é¢˜è®°å½•</title>
    <link href="https://www.voidking.com/dev-gitlab-ci-problems/"/>
    <id>https://www.voidking.com/dev-gitlab-ci-problems/</id>
    <published>2022-11-11T14:00:00.000Z</published>
    <updated>2023-02-13T17:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Job-is-stuck"><a href="#Job-is-stuck" class="headerlink" title="Job is stuck"></a>Job is stuck</h2><p>Shell Runnerè·‘CIä»»åŠ¡ï¼ŒæŠ¥é”™ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Job is stuck. Check runners. allowed to fail</span><br></pre></td></tr></table></figure><p>è§£å†³åŠæ³•ï¼š<br>ç»æŸ¥æ˜¯å› ä¸ºgitlab-runnerç‰ˆæœ¬æ¯”è¾ƒé«˜ï¼ˆ15.5.0ï¼‰ï¼Œæ–°ç‰ˆæœ¬çš„runnerï¼Œè¦æ±‚<code>.gitlab-ci.yml</code>å¿…é¡»è¦é…ç½®tagsï¼ŒæŒ‡å®šrunnerã€‚</p><span id="more"></span><h2 id="setting-GIT-CLONE-PATH-is-not-allowed"><a href="#setting-GIT-CLONE-PATH-is-not-allowed" class="headerlink" title="setting GIT_CLONE_PATH is not allowed"></a>setting GIT_CLONE_PATH is not allowed</h2><p>Shell Runnerè·‘CIä»»åŠ¡ï¼ŒæŠ¥é”™ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR: Job failed: setting GIT_CLONE_PATH is not allowed, enable `custom_build_dir` feature</span><br></pre></td></tr></table></figure><p>è§£å†³åŠæ³•ï¼šå¯ç”¨custom_build_dir</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/gitlab-runner/config.toml</span><br></pre></td></tr></table></figure><p>æ·»åŠ custom_build_diré…ç½®</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[[runners]]</span></span><br><span class="line">  <span class="section">[runners.custom_build_dir]</span></span><br><span class="line">    <span class="attr">enabled</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>é‡å¯gitlab-runner</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-runner restart</span><br></pre></td></tr></table></figure><h2 id="fatal-git-fetch-pack"><a href="#fatal-git-fetch-pack" class="headerlink" title="fatal: git fetch-pack"></a>fatal: git fetch-pack</h2><p>Shell Runnerè·‘CIä»»åŠ¡ï¼ŒæŠ¥é”™ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fatal: git fetch-pack: expected shallow list</span><br><span class="line">fatal: The remote end hung up unexpectedly</span><br></pre></td></tr></table></figure><p>è§£å†³åŠæ³•ï¼š<br>gitç‰ˆæœ¬é—®é¢˜ï¼Œå‡çº§git</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh http://opensource.wandisco.com/centos/7/git/x86_64/wandisco-git-release-7-1.noarch.rpm</span><br><span class="line">yum install -y git </span><br></pre></td></tr></table></figure><h2 id="ä¸èƒ½é”å®šé…ç½®æ–‡ä»¶"><a href="#ä¸èƒ½é”å®šé…ç½®æ–‡ä»¶" class="headerlink" title="ä¸èƒ½é”å®šé…ç½®æ–‡ä»¶"></a>ä¸èƒ½é”å®šé…ç½®æ–‡ä»¶</h2><p>Shell Runnerè·‘CIä»»åŠ¡ï¼ŒæŠ¥é”™ï¼š<br>error: ä¸èƒ½é”å®šé…ç½®æ–‡ä»¶ /home/gitlab-runner/builds/builds/xxx/main.tmp/git-template/config: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•</p><p>è§£å†³åŠæ³•ï¼š<br>æ²¡æœ‰æ£€ç´¢åˆ°æ‰¾åˆ°è§£å†³åŠæ³•ï¼Œå°è¯•é™çº§åˆ°<code>14.5.0</code>ï¼Œé—®é¢˜è§£å†³ã€‚é™çº§æ–¹æ³•å‚è€ƒã€Linuxç¯å¢ƒå®‰è£…runnerã€‘ä¸€èŠ‚ã€‚</p><h2 id="No-such-file-or-directory"><a href="#No-such-file-or-directory" class="headerlink" title="No such file or directory"></a>No such file or directory</h2><p>Shell Runnerè·‘CIä»»åŠ¡ï¼ŒæŠ¥é”™ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Skipping Git checkout</span><br><span class="line">Skipping Git submodules setup</span><br><span class="line">...</span><br><span class="line">$ pip3 install -r requirements.txt</span><br><span class="line">ERROR: Could not open requirements file: [Errno 2] No such file or directory: &#x27;requirements.txt&#x27;</span><br></pre></td></tr></table></figure><p>è§£å†³åŠæ³•ï¼š<code>.gitlab-ci.yml</code>æ–‡ä»¶ä¸­æ·»åŠ GIT_CHECKOUTå˜é‡</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">GIT_CHECKOUT:</span> <span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure><h2 id="ä¸‹è½½é•œåƒæŠ¥é”™"><a href="#ä¸‹è½½é•œåƒæŠ¥é”™" class="headerlink" title="ä¸‹è½½é•œåƒæŠ¥é”™"></a>ä¸‹è½½é•œåƒæŠ¥é”™</h2><p>Docker Machine Runnerè·‘CIä»»åŠ¡ï¼Œä¸€ç›´æ­£å¸¸ã€‚<br>Docker Machine Runneræ²¡æœ‰ä»»ä½•å˜åŠ¨ï¼Œçªç„¶æœ‰ä¸€å¤©ï¼Œæ‰§è¡Œdocker buildçš„æ—¶å€™ï¼Œä¸‹è½½åŸºç¡€é•œåƒæŠ¥é”™ï¼š<br>ERROR: failed to do request: Head <a href="https://192.168.56.101:5000/v2/library/python/manifests/3.8">https://192.168.56.101:5000/v2/library/python/manifests/3.8</a>: http: server gave HTTP response to HTTPS client</p><p>é‡å¯gitlab-runneré—®é¢˜ä¾æ—§ï¼Œé‡å¯æœºå™¨é—®é¢˜ä¾æ—§ã€‚</p><p>è§£å†³åŠæ³•ï¼šrunneré…ç½®é‡Œï¼ŒæŒ‡å®šdocker imageçš„ç‰ˆæœ¬ä¸º<code>docker:19.03</code>ï¼Œè€Œä¸è¦ä½¿ç”¨<code>docker</code>ï¼Œå¦åˆ™ä¸€ç›´ä¼šæ‹‰å–æœ€æ–°ç‰ˆçš„dockerï¼Œè€Œæœ€æ–°ç‰ˆçš„dockerä¸æ”¯æŒå‘é€httpè¯·æ±‚é•œåƒä»“åº“ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;Job-is-stuck&quot;&gt;&lt;a href=&quot;#Job-is-stuck&quot; class=&quot;headerlink&quot; title=&quot;Job is stuck&quot;&gt;&lt;/a&gt;Job is stuck&lt;/h2&gt;&lt;p&gt;Shell Runnerè·‘CIä»»åŠ¡ï¼ŒæŠ¥é”™ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight text&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Job is stuck. Check runners. allowed to fail&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;è§£å†³åŠæ³•ï¼š&lt;br&gt;ç»æŸ¥æ˜¯å› ä¸ºgitlab-runnerç‰ˆæœ¬æ¯”è¾ƒé«˜ï¼ˆ15.5.0ï¼‰ï¼Œæ–°ç‰ˆæœ¬çš„runnerï¼Œè¦æ±‚&lt;code&gt;.gitlab-ci.yml&lt;/code&gt;å¿…é¡»è¦é…ç½®tagsï¼ŒæŒ‡å®šrunnerã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="engineering" scheme="https://www.voidking.com/categories/engineering/"/>
    
    <category term="devops" scheme="https://www.voidking.com/categories/engineering/devops/"/>
    
    <category term="troubleshooting" scheme="https://www.voidking.com/categories/engineering/troubleshooting/"/>
    
    <category term="git" scheme="https://www.voidking.com/categories/engineering/git/"/>
    
    
    <category term="é—®é¢˜æ’æŸ¥" scheme="https://www.voidking.com/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"/>
    
    <category term="git" scheme="https://www.voidking.com/tags/git/"/>
    
    <category term="cicd" scheme="https://www.voidking.com/tags/cicd/"/>
    
    <category term="gitlab" scheme="https://www.voidking.com/tags/gitlab/"/>
    
  </entry>
  
  <entry>
    <title>GitLab Runnerå®‰è£…å®è·µ</title>
    <link href="https://www.voidking.com/dev-gitlab-runner-install/"/>
    <id>https://www.voidking.com/dev-gitlab-runner-install/</id>
    <published>2022-11-11T14:00:00.000Z</published>
    <updated>2023-02-14T14:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="GitLab-Runnerç‰ˆæœ¬è¯´æ˜"><a href="#GitLab-Runnerç‰ˆæœ¬è¯´æ˜" class="headerlink" title="GitLab Runnerç‰ˆæœ¬è¯´æ˜"></a>GitLab Runnerç‰ˆæœ¬è¯´æ˜</h1><p>å‡ºäºå…¼å®¹æ€§åŸå› ï¼ŒGitLab Runner major.minor ç‰ˆæœ¬åº”ä¸ GitLab major.minor ç‰ˆæœ¬ä¿æŒåŒæ­¥ã€‚<br>è¾ƒæ—§çš„runnerå¯èƒ½ä»ç„¶å¯ä»¥ä½¿ç”¨è¾ƒæ–°çš„ GitLab ç‰ˆæœ¬ï¼Œåä¹‹äº¦ç„¶ã€‚ä½†æ˜¯ï¼Œå¦‚æœå­˜åœ¨ç‰ˆæœ¬å·®å¼‚ï¼ŒåŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨æˆ–æ— æ³•æ­£å¸¸å·¥ä½œã€‚<br>minorç‰ˆæœ¬æ›´æ–°æ—¶ï¼Œä¼šä¿éšœå‘åå…¼å®¹æ€§ã€‚ä½†æ˜¯ï¼Œæœ‰æ—¶ GitLab çš„minorç‰ˆæœ¬æ›´æ–°ä¼šå¼•å…¥æ–°åŠŸèƒ½ï¼Œè¿™äº›æ–°åŠŸèƒ½éœ€è¦ GitLab Runner åœ¨åŒä¸€minorç‰ˆæœ¬ä¸Šã€‚</p><p>éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼šGitLab Runner 15.0 å¯¹æ³¨å†Œ API è¯·æ±‚æ ¼å¼è¿›è¡Œäº†æ›´æ”¹ã€‚å®ƒé˜»æ­¢ GitLab Runner ä¸ä½äº 14.8 çš„ GitLab ç‰ˆæœ¬é€šä¿¡ã€‚æˆ‘ä»¬å¿…é¡»ä½¿ç”¨é€‚åˆ GitLab ç‰ˆæœ¬çš„ Runner ç‰ˆæœ¬ï¼Œæˆ–å‡çº§ GitLab åº”ç”¨ç¨‹åºã€‚</p><p>æ›´å¤šå†…å®¹å‚è€ƒæ–‡æ¡£<a href="https://docs.gitlab.com/runner/">GitLab Runner</a></p><span id="more"></span><h1 id="æŸ¥çœ‹å®‰è£…æ•™ç¨‹"><a href="#æŸ¥çœ‹å®‰è£…æ•™ç¨‹" class="headerlink" title="æŸ¥çœ‹å®‰è£…æ•™ç¨‹"></a>æŸ¥çœ‹å®‰è£…æ•™ç¨‹</h1><h2 id="æŒ‡å®šé¡¹ç›®çš„Runner"><a href="#æŒ‡å®šé¡¹ç›®çš„Runner" class="headerlink" title="æŒ‡å®šé¡¹ç›®çš„Runner"></a>æŒ‡å®šé¡¹ç›®çš„Runner</h2><p>æ‰“å¼€gitlabé¡¹ç›® -&gt; Settings -&gt; CI/CD -&gt; Runners -&gt; Expand -&gt; Show Runner installation instructions</p><p>é¡µé¢çš„ registration tokenï¼Œç”¨äºæ³¨å†ŒæŒ‡å®šé¡¹ç›®ï¼ˆå½“å‰é¡¹ç›®ï¼‰çš„runnerã€‚</p><h2 id="å…±äº«çš„Runner"><a href="#å…±äº«çš„Runner" class="headerlink" title="å…±äº«çš„Runner"></a>å…±äº«çš„Runner</h2><p>æŸ¥çœ‹Runnerï¼š<a href="https://gitlab.voidking.com/admin/runners">https://gitlab.voidking.com/admin/runners</a>  </p><p>æ‰“å¼€gitlab runnerç®¡ç†é¡µé¢ -&gt; Show Runner installation instructions</p><p>é¡µé¢çš„ registration tokenï¼Œç”¨äºæ³¨å†Œå…±äº«runnerã€‚</p><h1 id="TOMLè¯­æ³•"><a href="#TOMLè¯­æ³•" class="headerlink" title="TOMLè¯­æ³•"></a>TOMLè¯­æ³•</h1><p>gitlab-runneré…ç½®æ–‡ä»¶ä¸ºconfig.tomlï¼Œä½¿ç”¨TOMLè¯­æ³•ã€‚<br>TOMLçš„ç›®æ ‡æ˜¯æˆä¸ºä¸€ç§æ˜“äºé˜…è¯»çš„æœ€å°é…ç½®æ–‡ä»¶æ ¼å¼ã€‚<br>TOMLè¢«è®¾è®¡ä¸ºæ˜ç¡®åœ°æ˜ å°„åˆ°å“ˆå¸Œè¡¨ã€‚<br>TOMLåº”è¯¥å¾ˆå®¹æ˜“è§£ææˆå„ç§è¯­è¨€çš„æ•°æ®ç»“æ„ã€‚</p><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://docs.gitlab.com/runner/configuration/">Configuring GitLab Runner</a></li><li><a href="https://github.com/toml-lang/toml">TOML</a></li><li><a href="https://www.cnblogs.com/xingxia/p/toml.html">TOML 1.0æ ¼å¼è¯­æ³•</a></li><li><a href="https://www.convertjson.com/toml-to-json.htm">Convert TOML To JSON</a></li></ul><h2 id="æ³¨é‡Š"><a href="#æ³¨é‡Š" class="headerlink" title="æ³¨é‡Š"></a>æ³¨é‡Š</h2><p><code>#</code>ï¼Œäº•å·åé¢è¡¨ç¤ºæ³¨é‡Š</p><h2 id="é”®å€¼å¯¹"><a href="#é”®å€¼å¯¹" class="headerlink" title="é”®å€¼å¯¹"></a>é”®å€¼å¯¹</h2><p>é”®åä¸ºå­—ç¬¦ä¸²ï¼Œå€¼å¯ä»¥ä¸ºå­—ç¬¦ä¸²ã€æ•´æ•°ã€æµ®ç‚¹æ•°ã€å¸ƒå°”å€¼ã€æ—¥æœŸã€æ—¶åˆ»ã€æ•°ç»„ã€è¡Œå†…è¡¨ç­‰ã€‚<br>é”®ååœ¨ç­‰å·çš„å·¦è¾¹ï¼Œå€¼åœ¨ç­‰å·çš„å³è¾¹ã€‚</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name</span> = <span class="string">&quot;voidking&quot;</span></span><br></pre></td></tr></table></figure><h2 id="è¡¨"><a href="#è¡¨" class="headerlink" title="è¡¨"></a>è¡¨</h2><p>è¡¨çš„è¡¨ç¤ºæ–¹æ³•ï¼šæ–¹æ‹¬å·+è¡¨åï¼Œä¾‹å¦‚<code>[table]</code>ã€‚<br>è¡¨æ˜¯é”®å€¼å¯¹çš„é›†åˆï¼Œç±»ä¼¼äºjsonä¸­çš„å¯¹è±¡ï¼ˆèŠ±æ‹¬å·ä¸­å†…å®¹ï¼‰ã€‚åœ¨å®ƒä¸‹æ–¹ï¼Œç›´è‡³ä¸‹ä¸€ä¸ªè¡¨å¤´æˆ–æ–‡ä»¶ç»“æŸï¼Œéƒ½æ˜¯è¿™ä¸ªè¡¨çš„é”®å€¼å¯¹ã€‚<br>é¡¶å±‚è¡¨ï¼Œåˆè¢«ç§°ä¸ºæ ¹è¡¨ï¼Œäºæ–‡æ¡£å¼€å§‹å¤„å¼€å§‹å¹¶åœ¨ç¬¬ä¸€ä¸ªè¡¨å¤´ï¼ˆæˆ–æ–‡ä»¶ç»“æŸå¤„ï¼‰å‰ç»“æŸã€‚</p><p>è¡¨åçš„è§„åˆ™å’Œé”®åçš„è§„åˆ™ç›¸åŒã€‚</p><p>è¡¨çš„å±‚çº§ç»“æ„ä»¥ç‚¹<code>.</code>åˆ†éš”ï¼Œåˆ†éš”çš„æ¯ä¸ªéƒ¨åˆ†éƒ½æ˜¯ä¸€ä¸ªè¡¨åã€‚<br>å®šä¹‰ä¸€ä¸ªå¤šå±‚çº§è¡¨æ—¶ï¼Œå¦‚æœæœ€åä¸€ä¸ªè¡¨åå‰çš„è¡¨æ²¡æœ‰è¢«åˆ›å»ºï¼Œé‚£ä¹ˆä¼šè¢«è‡ªåŠ¨åˆ›å»ºã€‚</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[table]</span></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªåä¸º table çš„è¡¨</span></span><br><span class="line"><span class="attr">key1</span> = <span class="string">&quot;some string&quot;</span></span><br><span class="line"><span class="attr">key2</span> = <span class="number">123</span></span><br><span class="line"></span><br><span class="line"><span class="attr">fruit.apple.color</span> = <span class="string">&quot;çº¢è‰²&quot;</span></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªåä¸º fruit çš„è¡¨</span></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªåä¸º fruit.apple çš„è¡¨</span></span><br><span class="line"></span><br><span class="line"><span class="attr">fruit.apple.taste.sweet</span> = <span class="literal">true</span></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªåä¸º fruit.apple.taste çš„è¡¨</span></span><br><span class="line"><span class="comment"># fruit å’Œ fruit.apple å·²ç»åˆ›å»ºè¿‡äº†</span></span><br></pre></td></tr></table></figure><h2 id="è¡¨æ•°ç»„"><a href="#è¡¨æ•°ç»„" class="headerlink" title="è¡¨æ•°ç»„"></a>è¡¨æ•°ç»„</h2><p>è¡¨æ•°ç»„è¡¨ç¤ºæ–¹æ³•ï¼šåŒå±‚æ–¹æ‹¬å·+è¡¨åï¼Œä¾‹å¦‚<code>[[fruits]]</code>ã€‚<br>è¡¨æ•°ç»„æ˜¯è¡¨çš„æ•°ç»„ï¼Œç±»ä¼¼äºjsonä¸­çš„å¯¹è±¡æ•°ç»„ã€‚</p><p>è¡¨æ•°ç»„çš„ç¬¬ä¸€ä¾‹å®šä¹‰äº†è¿™ä¸ªæ•°ç»„åŠå…¶é¦–ä¸ªè¡¨å…ƒç´ ï¼Œè€Œåç»­çš„æ¯ä¸ªè¡¨æ•°ç»„åœ¨è¯¥æ•°ç»„ä¸­åˆ›å»ºå¹¶å®šä¹‰ä¸€ä¸ªæ–°çš„è¡¨å…ƒç´ ã€‚</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[[fruits]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;è‹¹æœ&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[fruits.physical]</span>  <span class="comment"># å­è¡¨</span></span><br><span class="line"><span class="attr">color</span> = <span class="string">&quot;çº¢è‰²&quot;</span></span><br><span class="line"><span class="attr">shape</span> = <span class="string">&quot;åœ†å½¢&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[fruits.varieties]]</span>  <span class="comment"># åµŒå¥—è¡¨æ•°ç»„</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;è›‡æœ&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[fruits.varieties]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;æ¾³æ´²é’è‹¹&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[fruits]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;é¦™è•‰&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[fruits.varieties]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;è½¦å‰è‰&quot;</span></span><br></pre></td></tr></table></figure><p>å¯¹åº”çš„jsonæ ¼å¼ä¸ºï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;fruits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;è‹¹æœ&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;physical&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;çº¢è‰²&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;shape&quot;</span><span class="punctuation">:</span> <span class="string">&quot;åœ†å½¢&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;varieties&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;è›‡æœ&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æ¾³æ´²é’è‹¹&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;é¦™è•‰&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;varieties&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;è½¦å‰è‰&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="ç¼©è¿›"><a href="#ç¼©è¿›" class="headerlink" title="ç¼©è¿›"></a>ç¼©è¿›</h2><p>TOMLä¸­çš„ç¼©è¿›æ²¡æœ‰æ„ä¹‰ï¼Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿è¯»è€…ç†è§£å±‚çº§ç»“æ„ã€‚</p><h1 id="Linuxç¯å¢ƒå®‰è£…Runner"><a href="#Linuxç¯å¢ƒå®‰è£…Runner" class="headerlink" title="Linuxç¯å¢ƒå®‰è£…Runner"></a>Linuxç¯å¢ƒå®‰è£…Runner</h1><p>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://docs.gitlab.com/runner/install/index.html">Install GitLab Runner</a></p><p>1ã€å®‰è£…runner</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Download the binary for your system</span></span><br><span class="line">sudo curl -L --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64</span><br><span class="line"></span><br><span class="line"><span class="comment"># Give it permissions to execute</span></span><br><span class="line">sudo <span class="built_in">chmod</span> +x /usr/local/bin/gitlab-runner</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a GitLab CI user</span></span><br><span class="line">sudo useradd --comment <span class="string">&#x27;GitLab Runner&#x27;</span> --create-home gitlab-runner --shell /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install and run as service</span></span><br><span class="line">sudo gitlab-runner install --user=gitlab-runner --working-directory=/home/gitlab-runner</span><br><span class="line">sudo gitlab-runner start</span><br><span class="line">sudo gitlab-runner -v</span><br></pre></td></tr></table></figure><p>PSï¼šå…¶ä»–ç‰ˆæœ¬çš„runneræºç å’ŒäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯ä»¥åœ¨<a href="https://gitlab.com/gitlab-org/gitlab-runner/-/releases">gitlab-runner Releases</a>é¡µé¢æ‰¾åˆ°ã€‚</p><p>å¯¹äºcentosç³»ç»Ÿï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨rpmåŒ…å®‰è£…ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y https://gitlab-runner.downloads.s3.amazonaws.com/latest/rpm/gitlab-runner_amd64.rpm </span><br></pre></td></tr></table></figure><p>2ã€æ·»åŠ åˆ°gitlab-runneråˆ°dockerç”¨æˆ·ç»„ï¼ˆå¯é€‰ï¼‰<br>å¦‚æœgitlab-runneræ‰§è¡Œçš„ciè„šæœ¬éœ€è¦è¿è¡Œdockerï¼Œé‚£ä¹ˆéœ€è¦å°†gitlab-runneråˆ°dockerç”¨æˆ·ç»„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -a -G docker gitlab-runner</span><br><span class="line"><span class="comment"># if no docker group</span></span><br><span class="line">sudo usermod -a -G root gitlab-runner</span><br><span class="line"></span><br><span class="line">sudo -u gitlab-runner -H docker info</span><br></pre></td></tr></table></figure><p>3ã€gitlab-runneræ·»åŠ sudoæƒé™ï¼ˆå¯é€‰ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sudoers</span><br></pre></td></tr></table></figure><p>æ·»åŠ é…ç½®ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-runner ALL=(ALL) NOPASSWD: ALL</span><br></pre></td></tr></table></figure><h1 id="æ³¨å†ŒShellç±»å‹Runner"><a href="#æ³¨å†ŒShellç±»å‹Runner" class="headerlink" title="æ³¨å†ŒShellç±»å‹Runner"></a>æ³¨å†ŒShellç±»å‹Runner</h1><p>Shellç±»å‹çš„Executorï¼Œåœ¨Runnerç¨‹åºæ‰€åœ¨ä¸»æœºä¸Šè¿è¡ŒCIä»»åŠ¡ã€‚</p><p>å‰ç½®æ¡ä»¶ï¼šå®‰è£…å¥½äº†Runnerã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-runner register -h</span><br><span class="line">sudo gitlab-runner register --url https://gitlab.voidking.com/ --registration-token <span class="variable">$REGISTRATION_TOKEN</span></span><br></pre></td></tr></table></figure><p>REGISTRATION_TOKENå¯ä»¥åœ¨gitlabé¡µé¢è·å–åˆ°ï¼Œè¯¦æƒ…å‚è€ƒä¸Šæ–‡ã€æŸ¥çœ‹å®‰è£…æ•™ç¨‹ã€‘ä¸€èŠ‚ã€‚<br>æ ¹æ®æç¤ºï¼Œå¡«å†™urlã€tokenã€descriptionã€tagsï¼ˆå¤šä¸ªtagä»¥è‹±æ–‡é€—å·åˆ†éš”ï¼‰ã€executorç±»å‹ç­‰ä¿¡æ¯ï¼Œè¿™é‡Œexecutorç±»å‹å¡«å†™<code>shell</code>ã€‚</p><h1 id="æ³¨å†ŒDockerç±»å‹Runner"><a href="#æ³¨å†ŒDockerç±»å‹Runner" class="headerlink" title="æ³¨å†ŒDockerç±»å‹Runner"></a>æ³¨å†ŒDockerç±»å‹Runner</h1><p>Dockerç±»å‹çš„Executorï¼Œåœ¨Runnerç¨‹åºæ‰€åœ¨ä¸»æœºä¸Šçš„Dockerå®¹å™¨ä¸­è¿è¡ŒCIä»»åŠ¡ã€‚</p><p>å‰ç½®æ¡ä»¶ï¼šå®‰è£…å¥½äº†Runnerï¼Œè€Œä¸”Runneræ‰€åœ¨ä¸»æœºå·²ç»å®‰è£…é…ç½®å¥½äº†Dockerã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-runner register --url https://gitlab.voidking.com/ --registration-token <span class="variable">$REGISTRATION_TOKEN</span></span><br></pre></td></tr></table></figure><p>æ ¹æ®æç¤ºï¼Œå¡«å†™urlã€tokenã€descriptionã€tagsã€executorç±»å‹ç­‰ä¿¡æ¯ï¼Œè¿™é‡Œexecutorç±»å‹å¡«å†™<code>docker</code>ï¼Œæœ€åå¡«å†™ä¸€ä¸ªé»˜è®¤çš„é•œåƒã€‚</p><h1 id="æ³¨å†ŒDocker-Machineç±»å‹Runner"><a href="#æ³¨å†ŒDocker-Machineç±»å‹Runner" class="headerlink" title="æ³¨å†ŒDocker Machineç±»å‹Runner"></a>æ³¨å†ŒDocker Machineç±»å‹Runner</h1><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://docs.gitlab.com/runner/executors/docker_machine.html">Install and register GitLab Runner for autoscaling with Docker Machine</a></li><li><a href="https://docs.gitlab.com/runner/configuration/autoscale.html">Docker Machine Executor autoscale configuration</a></li><li><a href="https://www.runoob.com/docker/docker-machine.html">Docker Machine</a></li><li><a href="https://blog.csdn.net/RenshenLi/article/details/121585307">docker-machineçš„å®‰è£…ä¸ä½¿ç”¨</a></li></ul><h2 id="å®‰è£…è™šæ‹Ÿæœºé©±åŠ¨"><a href="#å®‰è£…è™šæ‹Ÿæœºé©±åŠ¨" class="headerlink" title="å®‰è£…è™šæ‹Ÿæœºé©±åŠ¨"></a>å®‰è£…è™šæ‹Ÿæœºé©±åŠ¨</h2><p>å¯é€‰é©±åŠ¨ï¼š</p><ul><li>virtualboxï¼ˆæ¨èï¼‰ï¼Œå‚è€ƒæ–‡æ¡£<a href="https://www.voidking.com/dev-linux-virtualbox/">Linuxä¸‹ä½¿ç”¨VirtualBox</a></li><li>qemuï¼Œå‚è€ƒæ–‡æ¡£<a href="https://github.com/machine-drivers/docker-machine-driver-qemu">machine-drivers/docker-machine-driver-qemu</a></li><li>kvmï¼Œå‚è€ƒæ–‡æ¡£<a href="https://github.com/dhiltgen/docker-machine-kvm">dhiltgen/docker-machine-kvm</a></li></ul><p>1ã€å®‰è£…virtualboxé©±åŠ¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install https://download.virtualbox.org/virtualbox/6.1.26/VirtualBox-6.1-6.1.26_145957_el7-1.x86_64.rpm</span><br></pre></td></tr></table></figure><p>2ã€å®‰è£…ç¼–è¯‘ç¯å¢ƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kernel-devel kernel-devel install gcc make perl kernel-headers</span><br></pre></td></tr></table></figure><p>3ã€æ¿€æ´»virtualboxå†…æ ¸æ”¯æŒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/vboxconfig</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…Docker-Machine"><a href="#å®‰è£…Docker-Machine" class="headerlink" title="å®‰è£…Docker Machine"></a>å®‰è£…Docker Machine</h2><p>1ã€ä¸‹è½½docker-machineäºŒè¿›åˆ¶æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://gitlab.com/gitlab-org/ci-cd/docker-machine/-/releases/v0.16.2-gitlab.15/downloads/docker-machine-Linux-x86_64</span><br><span class="line"><span class="built_in">mv</span> docker-machine-Linux-x86_64 /usr/sbin/docker-machine</span><br><span class="line"><span class="built_in">chmod</span> +x /usr/sbin/docker-machine</span><br></pre></td></tr></table></figure><p>æ›´å¤šç‰ˆæœ¬å¯ä»¥è®¿é—®<a href="https://gitlab.com/gitlab-org/ci-cd/docker-machine/-/releases">docker-machine/releases</a>é¡µé¢æŸ¥æ‰¾ã€‚</p><p>2ã€æµ‹è¯•å¯åŠ¨è™šæ‹Ÿæœº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-machine create -d virtualbox <span class="built_in">test</span></span><br></pre></td></tr></table></figure><h2 id="æ³¨å†ŒRunner"><a href="#æ³¨å†ŒRunner" class="headerlink" title="æ³¨å†ŒRunner"></a>æ³¨å†ŒRunner</h2><p>å‰ç½®æ¡ä»¶ï¼šå®‰è£…å¥½äº†Runnerã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-runner register --url https://gitlab.voidking.com/ --registration-token <span class="variable">$REGISTRATION_TOKEN</span></span><br></pre></td></tr></table></figure><p>æ ¹æ®æç¤ºï¼Œå¡«å†™urlã€tokenã€descriptionã€tagsã€executorç±»å‹ç­‰ä¿¡æ¯ï¼Œè¿™é‡Œexecutorç±»å‹å¡«å†™<code>docker+machine</code>ï¼Œæœ€åå¡«å†™ä¸€ä¸ªé»˜è®¤çš„é•œåƒã€‚</p><h2 id="é…ç½®é•œåƒåŠ é€Ÿ"><a href="#é…ç½®é•œåƒåŠ é€Ÿ" class="headerlink" title="é…ç½®é•œåƒåŠ é€Ÿ"></a>é…ç½®é•œåƒåŠ é€Ÿ</h2><p>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://docs.docker.com/registry/">Docker Registry</a></p><p>1ã€å¯åŠ¨æœ¬åœ°ä»“åº“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5001:5000 -e REGISTRY_PROXY_REMOTEURL=https://gcr.io -e HTTPS_PROXY=socks5://192.168.56.1 -v /data/docker_registry_cache_gcr:/var/lib/registry --restart always --name gcr_io_registry registry:2</span><br><span class="line"></span><br><span class="line">docker run -d -p 5000:5000 -e REGISTRY_PROXY_REMOTEURL=https://registry-1.docker.io -v /data/docker_registry_cache_gcr:/var/lib/registry --restart always --name gcr_io_registry registry:2</span><br></pre></td></tr></table></figure><p>2ã€ä¿®æ”¹daemon.json</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;http://localhost:5000&quot;</span><span class="punctuation">,</span><span class="string">&quot;http://localhost:5001&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="é…ç½®ç¼“å­˜"><a href="#é…ç½®ç¼“å­˜" class="headerlink" title="é…ç½®ç¼“å­˜"></a>é…ç½®ç¼“å­˜</h2><p>1ã€å¯åŠ¨minioå®¹å™¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name minio \</span><br><span class="line">--restart always \</span><br><span class="line">-p 9000:9000 \</span><br><span class="line">-p 9001:9001  \</span><br><span class="line">-v /data/minio/.minio:/data/.minio \</span><br><span class="line">-v /data/minio/export:/export \</span><br><span class="line">-e <span class="string">&quot;MINIO_ROOT_USER=root&quot;</span> \</span><br><span class="line">-e <span class="string">&quot;MINIO_ROOT_PASSWORD=xxxxxx&quot;</span> \</span><br><span class="line">minio/minio:latest server /export --console-address <span class="string">&quot;:9001&quot;</span></span><br></pre></td></tr></table></figure><p>2ã€é¡µé¢è®¿é—®<br><a href="http://192.168.56.101:9001/">http://192.168.56.101:9001/</a> </p><h2 id="é…ç½®Runner"><a href="#é…ç½®Runner" class="headerlink" title="é…ç½®Runner"></a>é…ç½®Runner</h2><p>1ã€ä¿®æ”¹ /etc/gitlab-runner/config.toml</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">concurrent = 3</span><br><span class="line">check_interval = 0</span><br><span class="line"></span><br><span class="line">[session_server]</span><br><span class="line">  session_timeout = 1800</span><br><span class="line"></span><br><span class="line">[[runners]]</span><br><span class="line">  limit = 3</span><br><span class="line">  name = &quot;dockermachine&quot;</span><br><span class="line">  url = &quot;https://gitlab.voidking.com&quot;</span><br><span class="line">  token = &quot;xxx&quot;</span><br><span class="line">  executor = &quot;docker+machine&quot;</span><br><span class="line">  [runners.custom_build_dir]</span><br><span class="line">    enabled = true</span><br><span class="line">  [runners.cache]</span><br><span class="line">    Type = &quot;s3&quot;</span><br><span class="line">    Path = &quot;runner&quot;</span><br><span class="line">    Shared = true</span><br><span class="line">    [runners.cache.s3]</span><br><span class="line">      ServerAddress = &quot;192.168.56.101:9000&quot;</span><br><span class="line">      AccessKey = &quot;root&quot;</span><br><span class="line">      SecretKey = &quot;xxx&quot;</span><br><span class="line">      BucketName = &quot;runner&quot;</span><br><span class="line">      Insecure = true</span><br><span class="line">    [runners.cache.gcs]</span><br><span class="line">    [runners.cache.azure]</span><br><span class="line">  [runners.docker]</span><br><span class="line">    tls_verify = false</span><br><span class="line">    image = &quot;docker:19.03&quot;</span><br><span class="line">    privileged = true</span><br><span class="line">    disable_entrypoint_overwrite = false</span><br><span class="line">    oom_kill_disable = false</span><br><span class="line">    disable_cache = false</span><br><span class="line">    volumes = [&quot;/certs/client&quot;,&quot;/cache&quot;, &quot;/var/run/docker.sock:/var/run/docker.sock&quot;]</span><br><span class="line">    pull_policy = [&quot;if-not-present&quot;]</span><br><span class="line">    shm_size = 0</span><br><span class="line">  [runners.machine]</span><br><span class="line">    IdleCount = 5</span><br><span class="line">    MaxGrowthRate = 1</span><br><span class="line">    IdleTime = 1800</span><br><span class="line">    MachineDriver = &quot;virtualbox&quot;</span><br><span class="line">    MachineName = &quot;auto-scale-%s&quot;</span><br><span class="line">    MachineOptions = [</span><br><span class="line">      &quot;engine-registry-mirror=http://192.168.56.101:5000&quot;,</span><br><span class="line">      &quot;virtualbox-memory=4048&quot;,</span><br><span class="line">      &quot;virtualbox-disk-size=204800&quot;,</span><br><span class="line">      &quot;virtualbox-cpu-count=2&quot;</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šrunners.docker.imageè¦æŒ‡å®šç‰ˆæœ¬ï¼Œå¦åˆ™æ¯æ¬¡æ„å»ºéƒ½ä¼šæ‹‰å–æœ€æ–°ç‰ˆçš„dockerï¼Œè€Œæœ€æ–°ç‰ˆæœ¬çš„dockerä¸æ”¯æŒhttpè¯·æ±‚é•œåƒä»“åº“ã€‚<br>æ›´å¤šdockerç‰ˆæœ¬å¯ä»¥è®¿é—®<a href="https://hub.docker.com/_/docker/tags?page=1">dockerhub - docker</a>è·å–ã€‚</p><p>2ã€é‡æ–°å¯åŠ¨runner</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-runner restart</span><br></pre></td></tr></table></figure><h2 id="ç®¡ç†Docker-Machine"><a href="#ç®¡ç†Docker-Machine" class="headerlink" title="ç®¡ç†Docker Machine"></a>ç®¡ç†Docker Machine</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-machine <span class="built_in">ls</span></span><br><span class="line">docker-machine ssh xxx</span><br></pre></td></tr></table></figure><h1 id="K8Sç¯å¢ƒå®‰è£…Runner"><a href="#K8Sç¯å¢ƒå®‰è£…Runner" class="headerlink" title="K8Sç¯å¢ƒå®‰è£…Runner"></a>K8Sç¯å¢ƒå®‰è£…Runner</h1><p>æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬åœ¨K8Sä¸­é€šè¿‡helmå®‰è£…Runnerã€‚</p><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://docs.gitlab.com/runner/install/kubernetes.html">GitLab Runner Helm Chart</a></li><li><a href="https://docs.gitlab.com/runner/install/kubernetes.html#running-docker-in-docker-containers-with-gitlab-runner">GitLab Runner Helm Chart - Running Docker-in-Docker containers with GitLab Runner</a></li><li><a href="https://www.youtube.com/watch?v=0Fes86qtBSc">GitLab CI CD | Install and Configure GitLab Runner on Kubernetes with Helm</a></li><li><a href="http://docs.idevops.site/gitlabci/chapter05/01/01-runner%E6%9E%84%E5%BB%BA%E7%8E%AF%E5%A2%83%E4%BC%98%E5%8C%96%E9%85%8D%E7%BD%AE/">Runneræ„å»ºä¼˜åŒ–</a></li><li><a href="https://www.qikqiak.com/post/gitlab-runner-install-on-k8s/">åœ¨ Kubernetes ä¸Šå®‰è£… Gitlab CI Runner</a></li></ul><h2 id="å‡†å¤‡å­˜å‚¨"><a href="#å‡†å¤‡å­˜å‚¨" class="headerlink" title="å‡†å¤‡å­˜å‚¨"></a>å‡†å¤‡å­˜å‚¨</h2><p>é€šè¿‡helmå®‰è£…runnerï¼Œvalueså½“å‰è¿˜ä¸æ”¯æŒé…ç½®storageclassã€‚å› æ­¤ï¼Œéœ€è¦å…ˆè‡ªè¡Œå‡†å¤‡å¥½runnerçš„å­˜å‚¨ã€‚ä¸»è¦å‚è€ƒæ–‡æ¡£<a href="https://www.voidking.com/dev-k8s-storageclass/">ã€ŠK8Sä¸­å®‰è£…é…ç½®StorageClassã€‹</a></p><p>å‡†å¤‡pvcå®šä¹‰ runner-pvc.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab-runner-cache</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs-storage</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">50Gi</span></span><br></pre></td></tr></table></figure><h2 id="å‡†å¤‡Runneré…ç½®"><a href="#å‡†å¤‡Runneré…ç½®" class="headerlink" title="å‡†å¤‡Runneré…ç½®"></a>å‡†å¤‡Runneré…ç½®</h2><p>1ã€æ·»åŠ gitlab repo</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add gitlab https://charts.gitlab.io</span><br><span class="line">helm repo update</span><br></pre></td></tr></table></figure><p>2ã€æŸ¥çœ‹å¯ç”¨çš„runnerç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm search repo -l gitlab/gitlab-runner</span><br></pre></td></tr></table></figure><p>CHART VERSIONæœ‰å¯¹åº”çš„APP VERSIONç‰ˆæœ¬ï¼Œé€‰æ‹©éœ€è¦çš„APP VERSIONç‰ˆæœ¬ã€‚<br>è¿™é‡Œé€‰æ‹©14.0.0ç‰ˆæœ¬ï¼Œå¯¹åº”CHART VERSIONä¸º0.30.0</p><p>3ã€ä¸‹è½½chart</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm fetch gitlab/gitlab-runner --version 0.30.0</span><br><span class="line">tar -xzvf gitlab-runner-0.30.0.tgz</span><br></pre></td></tr></table></figure><p>4ã€values.yamlä¿®æ”¹é…ç½®</p><ul><li>imageï¼šæŒ‡å®šç‰ˆæœ¬gitlab/gitlab-runner:alpine-v14.0.1ï¼Œæ›´å¤šé•œåƒç‰ˆæœ¬å¯ä»¥è®¿é—®<a href="https://hub.docker.com/r/gitlab/gitlab-runner/tags">docker hub</a>æŸ¥æ‰¾</li><li>gitlabUrlï¼šæ”¹æˆæˆ‘ä»¬è‡ªå·±çš„çš„gitlabåœ°å€</li><li>runnerRegistrationTokenï¼šå‚è€ƒã€æŸ¥çœ‹å®‰è£…æ•™ç¨‹ã€‘ä¸€èŠ‚è·å–</li><li>resourcesï¼šä¿®æ”¹ç”³è¯·å’Œé™åˆ¶çš„èµ„æº</li><li>rbac.createï¼šæ”¹æˆtrueï¼Œåˆ›å»ºsaç”¨äºåˆ›å»ºrunner</li><li>nameï¼šæ”¹æˆrunneræƒ³è¦åœ¨gitlabä¸­æ˜¾ç¤ºçš„åç§°</li><li>tagsï¼šæ”¹æˆrunneræƒ³è¦æ³¨å†Œçš„tagsï¼Œå¤šä¸ªtagä»¥è‹±æ–‡é€—å·åˆ†éš”</li><li>replicasï¼šæ”¹æˆrunneræœŸæœ›çš„å‰¯æœ¬æ•°ï¼Œè¿™äº›runnerå‰¯æœ¬ä½¿ç”¨åŒä¸€ä¸ªnameã€‚</li><li>privilegedï¼šæ”¹æˆtrueï¼Œå¯ç”¨docker in docker</li><li>runners.configï¼šæ”¯æŒè‡ªå®šä¹‰æ„å»ºç›®å½•ï¼Œæ”¯æŒdocker in docker</li></ul><p>runners.configå†…å®¹ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[runners.custom_build_dir]</span><br><span class="line">  enabled = true</span><br><span class="line"></span><br><span class="line">[[runners.kubernetes.volumes.host_path]]</span><br><span class="line">  name = &quot;docker&quot;</span><br><span class="line">  mount_path = &quot;/var/run/docker.sock&quot;</span><br><span class="line">  read_only = true</span><br><span class="line">  host_path = &quot;/var/run/docker.sock&quot;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æƒ³è¦å¯¹æ„å»ºç¼“å­˜ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨ï¼Œå› æ­¤éœ€è¦æ·»åŠ </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## configure build cache</span></span><br><span class="line"><span class="attr">cibuild:</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">pvcName:</span> <span class="string">gitlab-runner-cache</span></span><br><span class="line">    <span class="attr">mountPath:</span> <span class="string">/home/gitlab-runner/ci-build-cache</span></span><br></pre></td></tr></table></figure><p>åŒæ—¶ï¼Œéœ€è¦ä¿®æ”¹gitlab-runner/templates/configmap.yaml<br>data.entrypointéƒ¨åˆ†æ·»åŠ runneré…ç½®ï¼Œè‡ªåŠ¨æŒ‚è½½å­˜å‚¨</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># add build cache and </span></span><br><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">&gt;&gt;/home/gitlab-runner/.gitlab-runner/config.toml</span></span><br><span class="line">  [[<span class="string">runners.kubernetes.volumes.pvc</span>]]</span><br><span class="line">    <span class="string">name</span> <span class="string">=</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;.Values.cibuild.cache.pvcName&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="string">mount_path</span> <span class="string">=</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;.Values.cibuild.cache.mountPath&#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Start the runner</span></span><br><span class="line"><span class="string">exec</span> <span class="string">/entrypoint</span> <span class="string">run</span> <span class="string">--user=gitlab-runner</span> <span class="string">\</span></span><br><span class="line">  <span class="string">--working-directory=/home/gitlab-runner</span></span><br></pre></td></tr></table></figure><h2 id="å®‰è£…Runner"><a href="#å®‰è£…Runner" class="headerlink" title="å®‰è£…Runner"></a>å®‰è£…Runner</h2><p>1ã€å®‰è£…runner</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns gitlab-14-0</span><br><span class="line">kubectl apply -f runner-pvc.yaml -n gitlab-14-0</span><br><span class="line">helm install --namespace gitlab-14-0 gitlab-runner ./gitlab-runner</span><br></pre></td></tr></table></figure><p>2ã€æŸ¥çœ‹å®‰è£…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all -n gitlab-14-0</span><br><span class="line">kubectl get pvc -n gitlab-14-0</span><br><span class="line">kubectl logs pod/gitlab-runner-gitlab-runner-849988b584-kllqv -n gitlab-14-0</span><br></pre></td></tr></table></figure><p>3ã€æŸ¥çœ‹runneræ³¨å†Œç»“æœ<br><a href="https://gitlab.voidking.com/admin/runners">https://gitlab.voidking.com/admin/runners</a></p><p>æ‰¾åˆ°æ–°çš„runnerï¼Œç‚¹å‡»å³ä¾§çš„EditæŒ‰é’®ï¼Œå¯ä»¥åšè¿›ä¸€æ­¥çš„é…ç½®ã€‚</p><h1 id="è‡ªå®šä¹‰buildsè·¯å¾„"><a href="#è‡ªå®šä¹‰buildsè·¯å¾„" class="headerlink" title="è‡ªå®šä¹‰buildsè·¯å¾„"></a>è‡ªå®šä¹‰buildsè·¯å¾„</h1><p>å‚è€ƒæ–‡æ¡£<a href="https://docs.gitlab.com/ee/ci/large_repositories/">Optimize GitLab for large repositories</a></p><p>1ã€å‡†å¤‡buildsç›®å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /builds</span><br><span class="line"><span class="built_in">mkdir</span> /cache</span><br><span class="line"><span class="built_in">chown</span> gitlab-runner:gitlab-runner -R /builds</span><br><span class="line"><span class="built_in">chown</span> gitlab-runner:gitlab-runner -R /cache</span><br></pre></td></tr></table></figure><p>2ã€ä¿®æ”¹runneré…ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/gitlab-runner/config.toml</span><br></pre></td></tr></table></figure><p>æ·»åŠ é…ç½®</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[[runners]]</span><br><span class="line">  builds_dir = &quot;/builds&quot;</span><br><span class="line">  cache_dir = &quot;/cache&quot;</span><br><span class="line">  [runners.custom_build_dir]</span><br><span class="line">    enabled = true</span><br></pre></td></tr></table></figure><p>3ã€é‡å¯runner</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-runner restart</span><br></pre></td></tr></table></figure><h1 id="å–æ¶ˆæ³¨å†ŒRunner"><a href="#å–æ¶ˆæ³¨å†ŒRunner" class="headerlink" title="å–æ¶ˆæ³¨å†ŒRunner"></a>å–æ¶ˆæ³¨å†ŒRunner</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹token</span></span><br><span class="line">gitlab-runner list</span><br><span class="line"><span class="comment"># tokenè¿˜å¯ä»¥åœ¨/etc/gitlab-runner/config.tomlä¸­æŸ¥çœ‹</span></span><br><span class="line"><span class="comment"># å–æ¶ˆæ³¨å†Œrunner</span></span><br><span class="line">gitlab-runner unregister -t <span class="variable">$token</span> -u https://gitlab.voidking.com/</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;GitLab-Runnerç‰ˆæœ¬è¯´æ˜&quot;&gt;&lt;a href=&quot;#GitLab-Runnerç‰ˆæœ¬è¯´æ˜&quot; class=&quot;headerlink&quot; title=&quot;GitLab Runnerç‰ˆæœ¬è¯´æ˜&quot;&gt;&lt;/a&gt;GitLab Runnerç‰ˆæœ¬è¯´æ˜&lt;/h1&gt;&lt;p&gt;å‡ºäºå…¼å®¹æ€§åŸå› ï¼ŒGitLab Runner major.minor ç‰ˆæœ¬åº”ä¸ GitLab major.minor ç‰ˆæœ¬ä¿æŒåŒæ­¥ã€‚&lt;br&gt;è¾ƒæ—§çš„runnerå¯èƒ½ä»ç„¶å¯ä»¥ä½¿ç”¨è¾ƒæ–°çš„ GitLab ç‰ˆæœ¬ï¼Œåä¹‹äº¦ç„¶ã€‚ä½†æ˜¯ï¼Œå¦‚æœå­˜åœ¨ç‰ˆæœ¬å·®å¼‚ï¼ŒåŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨æˆ–æ— æ³•æ­£å¸¸å·¥ä½œã€‚&lt;br&gt;minorç‰ˆæœ¬æ›´æ–°æ—¶ï¼Œä¼šä¿éšœå‘åå…¼å®¹æ€§ã€‚ä½†æ˜¯ï¼Œæœ‰æ—¶ GitLab çš„minorç‰ˆæœ¬æ›´æ–°ä¼šå¼•å…¥æ–°åŠŸèƒ½ï¼Œè¿™äº›æ–°åŠŸèƒ½éœ€è¦ GitLab Runner åœ¨åŒä¸€minorç‰ˆæœ¬ä¸Šã€‚&lt;/p&gt;
&lt;p&gt;éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼šGitLab Runner 15.0 å¯¹æ³¨å†Œ API è¯·æ±‚æ ¼å¼è¿›è¡Œäº†æ›´æ”¹ã€‚å®ƒé˜»æ­¢ GitLab Runner ä¸ä½äº 14.8 çš„ GitLab ç‰ˆæœ¬é€šä¿¡ã€‚æˆ‘ä»¬å¿…é¡»ä½¿ç”¨é€‚åˆ GitLab ç‰ˆæœ¬çš„ Runner ç‰ˆæœ¬ï¼Œæˆ–å‡çº§ GitLab åº”ç”¨ç¨‹åºã€‚&lt;/p&gt;
&lt;p&gt;æ›´å¤šå†…å®¹å‚è€ƒæ–‡æ¡£&lt;a href=&quot;https://docs.gitlab.com/runner/&quot;&gt;GitLab Runner&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="engineering" scheme="https://www.voidking.com/categories/engineering/"/>
    
    <category term="k8s" scheme="https://www.voidking.com/categories/engineering/k8s/"/>
    
    <category term="devops" scheme="https://www.voidking.com/categories/engineering/devops/"/>
    
    <category term="cloudnative" scheme="https://www.voidking.com/categories/engineering/cloudnative/"/>
    
    <category term="git" scheme="https://www.voidking.com/categories/engineering/git/"/>
    
    
    <category term="k8s" scheme="https://www.voidking.com/tags/k8s/"/>
    
    <category term="git" scheme="https://www.voidking.com/tags/git/"/>
    
    <category term="cicd" scheme="https://www.voidking.com/tags/cicd/"/>
    
    <category term="gitlab" scheme="https://www.voidking.com/tags/gitlab/"/>
    
    <category term="helm" scheme="https://www.voidking.com/tags/helm/"/>
    
    <category term="virtualbox" scheme="https://www.voidking.com/tags/virtualbox/"/>
    
  </entry>
  
  <entry>
    <title>GitLab Runnerå…¥é—¨ç¯‡</title>
    <link href="https://www.voidking.com/dev-gitlab-runner-start/"/>
    <id>https://www.voidking.com/dev-gitlab-runner-start/</id>
    <published>2022-11-11T14:00:00.000Z</published>
    <updated>2023-02-13T15:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="GitLab-Runnerç®€ä»‹"><a href="#GitLab-Runnerç®€ä»‹" class="headerlink" title="GitLab Runnerç®€ä»‹"></a>GitLab Runnerç®€ä»‹</h1><p>GitLab Runner æ˜¯ä¸€ä¸ªå¼€æºè½¯ä»¶ï¼Œå®ƒä¸ GitLab CI/CD é…åˆï¼Œåœ¨ç®¡é“æµä¸­è¿è¡Œä½œä¸šã€‚<br>GitLab Runner æ˜¯ç”¨Goç¼–å†™ï¼Œå‡ ä¹å¯ä»¥ç›´æ¥è¿è¡Œåœ¨ä»»ä½•æ“ä½œç³»ç»Ÿï¼ˆä¸ªåˆ«ç³»ç»Ÿéœ€è¦è‡ªè¡Œç¼–è¯‘ï¼‰ã€‚<br>GitLab Runner ä¹Ÿå¯ä»¥åœ¨ Docker å®¹å™¨å†…è¿è¡Œæˆ–éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤ä¸­ã€‚</p><p>GitLab Runnerèƒ½ä¸èƒ½æ›¿æ¢æˆå…¶ä»–çš„Runnerï¼Ÿå¯ä»¥ï¼Œä½†æ˜¯æ²¡æœ‰å¿…è¦ï¼Œæ¯•ç«ŸGitlab Runneræ˜¯å¼€æºçš„ï¼Œæœ‰ä»€ä¹ˆä¸ªæ€§åŒ–éœ€æ±‚å°±è‡ªå·±æ”¹ä¸€æ”¹ã€‚è€Œä¸”ï¼Œä¹Ÿæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ›¿ä»£äº§å“ã€‚</p><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://docs.gitlab.com/runner/">GitLab Runner</a> </li><li><a href="https://docs.gitlab.cn/jh/ci/">GitLab CI/CDä¸­æ–‡æ–‡æ¡£</a></li><li><a href="https://docs.gitlab.com/ee/ci/">GitLab CI/CDæ–‡æ¡£</a></li><li><a href="https://docs.gitlab.com/runner/">GitLab Runner</a></li><li><a href="https://docs.gitlab.com/runner/executors/">Executors</a></li><li><a href="https://docs.gitlab.com/runner/executors/shell.html">The Shell executor</a></li><li><a href="https://www.voidking.com/dev-gitlab-cicd/">ã€ŠGitLab CI/CDå…¥é—¨ç¯‡ã€‹</a></li></ul><span id="more"></span><h1 id="GitLabã€Runnerå’ŒExecutor"><a href="#GitLabã€Runnerå’ŒExecutor" class="headerlink" title="GitLabã€Runnerå’ŒExecutor"></a>GitLabã€Runnerå’ŒExecutor</h1><p>å…³äºGitLabã€Runnerå’ŒExecutorçš„å…³ç³»ï¼Œæœ‰ä¸€ä¸ªæ¯”å–»å¾ˆæ°å½“ï¼š<br>GitLabæ˜¯è€æ¿ï¼Œä¼šå»æŸ¥çœ‹éœ€æ±‚å•ï¼ˆ.gitlab-ci.ymlï¼‰ï¼Œå»ºç«‹ä¸€å¼ åˆä¸€å¼ æœ‰å…ˆåé¡ºåºçš„å·¥å•ï¼ˆCI Pipelineï¼‰ã€‚<br>GitLab Runner æ˜¯æ‰§è¡Œ CI Job çš„å·¥äººï¼Œå®šæœŸå»è¯¢é—®è€æ¿ï¼ˆGitLabï¼‰ç°åœ¨æœ‰åˆ†é…ç»™è‡ªå·±çš„å·¥ä½œï¼ˆCI Jobï¼‰å—ï¼Ÿå¦‚æœæ‹¿åˆ°å·¥ä½œï¼Œå°±å¼€å§‹æ‰§è¡Œï¼Œå¹¶åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å°†è¿›åº¦å³æ—¶å†™åœ¨å·¥å•ä¸Šã€‚<br>Executor æ˜¯å·¥äººï¼ˆRunnerï¼‰æ‰§è¡Œ CI Job çš„å·¥ä½œç¯å¢ƒï¼Œä¾‹å¦‚ä¸€ä¸ª CI Job æ˜¯æ‰“å°å‡ºâ€helloâ€ï¼Œé‚£ä¹ˆRunnerå¯ä»¥åœ¨æœ¬åœ°Shellç¯å¢ƒä¸­æ‰§è¡Œï¼Œå¯ä»¥åœ¨è™šæ‹Ÿæœºç¯å¢ƒä¸­æ‰§è¡Œï¼Œè¿˜å¯ä»¥åœ¨Dockerç¯å¢ƒä¸­æ‰§è¡Œï¼›è€Œå¦‚æœä¸€ä¸ªCI Jobéœ€è¦åœ¨åŸºç¡€é•œåƒä¸Šè¿›è¡Œæ„å»ºï¼Œé‚£ä¹ˆå°±éœ€è¦Dockerç¯å¢ƒæˆ–è€…K8Sç¯å¢ƒäº†ã€‚</p><p>Runneré€šå¸¸åœ¨å®‰è£…Runnerçš„åŒä¸€å°æœºå™¨ä¸Šå¤„ç†ä½œä¸šã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è®©Runneråœ¨å®¹å™¨ã€k8s é›†ç¾¤ã€æˆ–è€…äº‘ä¸Šçš„è‡ªåŠ¨ç¼©æ”¾å®ä¾‹ä¸­å¤„ç†ä½œä¸šã€‚</p><p>å®‰è£…Runneråï¼Œæƒ³è¦ä½¿ç”¨å®ƒï¼Œéœ€è¦åœ¨GitLabå¹³å°è¿›è¡Œæ³¨å†Œï¼Œæ³¨å†Œåšçš„å·¥ä½œå°±æ˜¯å»ºç«‹Gitlabä¸Runnerä¹‹é—´çš„é€šä¿¡ã€‚<br>æ³¨å†Œå®Œæˆåï¼ŒRunnerå°±å¯ä»¥è¿è¡Œæ¥è‡ª GitLab çš„ CI/CD ä½œä¸šäº†ã€‚</p><p>å½“æˆ‘ä»¬æ³¨å†Œä¸€ä¸ªRunneræ—¶ï¼Œå¿…é¡»é€‰æ‹©ä¸€ä¸ªExecutorã€‚Executorå†³å®šäº†æ¯ä¸ªä½œä¸šè¿è¡Œçš„ç¯å¢ƒã€‚</p><p>Gitlab Runnerçš„å®‰è£…ç¯å¢ƒåŒ…æ‹¬Linuxã€MacOSã€Windowsã€Dockerå’ŒKubernetesã€‚<br>è€Œä¸åŒå®‰è£…ç¯å¢ƒçš„Runnerï¼Œæ”¯æŒä¸åŒçš„Executorsã€‚<br>æ ¹æ®Executorçš„ä¸åŒï¼ŒåŒä¸€ä¸ªRunnerç¨‹åºï¼Œå¯ä»¥æ³¨å†Œä¸ºä¸åŒExecutorç±»å‹çš„Runnerï¼Œä¾‹å¦‚SSHã€Shellã€Parallelsã€VirtualBoxã€Dockerã€Docker Machine (auto-scaling)ã€Kubernetesã€Customã€‚</p><p>ä¾‹å¦‚ï¼š</p><ul><li>å¦‚æœæˆ‘ä»¬å¸Œæœ› CI/CD ä½œä¸šè¿è¡Œ PowerShell å‘½ä»¤ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨ Windows æœåŠ¡å™¨ä¸Šå®‰è£… GitLab Runnerï¼Œç„¶åæ³¨å†Œä¸€ä¸ªä½¿ç”¨ Shell Executorçš„Runnerã€‚</li><li>å¦‚æœæˆ‘ä»¬å¸Œæœ› CI/CD ä½œä¸šåœ¨è‡ªå®šä¹‰ Docker å®¹å™¨ä¸­è¿è¡Œå‘½ä»¤ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨ Linux æœåŠ¡å™¨ä¸Šå®‰è£… GitLab Runner å¹¶æ³¨å†Œä¸€ä¸ªä½¿ç”¨ Docker Executor çš„ Runnerã€‚</li><li>æˆ‘ä»¬è¿˜å¯ä»¥åœ¨è™šæ‹Ÿæœºä¸Šå®‰è£… GitLab Runnerï¼Œå¹¶è®©å®ƒä½¿ç”¨å¦ä¸€ä¸ªè™šæ‹Ÿæœºä½œä¸ºExecutorã€‚</li></ul><p>æœ€å¸¸ç”¨çš„Executorï¼šShellã€Dockerã€Docker Machineã€Kubernetesã€‚</p><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://docs.gitlab.com/runner/">GitLab Runner</a> </li><li><a href="https://docs.gitlab.com/runner/executors/index.html">Executors</a></li><li><a href="https://chengweichen.com/2021/03/gitlab-ci-executor.html">GitLab CI ä¹‹ Runner çš„ Executor è©²å¦‚ä½•é¸æ“‡ï¼Ÿ</a></li></ul><h1 id="Executorç®€ä»‹"><a href="#Executorç®€ä»‹" class="headerlink" title="Executorç®€ä»‹"></a>Executorç®€ä»‹</h1><h2 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h2><p>Shell æ˜¯æœ€ç®€å•çš„é…ç½®æ‰§è¡Œå™¨ã€‚æ„å»ºæ‰€éœ€çš„æ‰€æœ‰ä¾èµ–é¡¹éƒ½éœ€è¦æ‰‹åŠ¨å®‰è£…åœ¨å®‰è£… GitLab Runner çš„åŒä¸€å°æœºå™¨ä¸Šã€‚</p><h2 id="Docker-executor"><a href="#Docker-executor" class="headerlink" title="Docker executor"></a>Docker executor</h2><p>ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©æ˜¯ä½¿ç”¨ Dockerï¼Œå› ä¸ºå®ƒå…è®¸ä¸€ä¸ªå¹²å‡€çš„æ„å»ºç¯å¢ƒï¼Œå¹¶ä¸”å…·æœ‰ç®€å•çš„ä¾èµ–é¡¹ç®¡ç†ï¼ˆæ„å»ºé¡¹ç›®çš„æ‰€æœ‰ä¾èµ–é¡¹éƒ½å¯ä»¥æ”¾åœ¨ Docker æ˜ åƒä¸­ï¼‰ã€‚ Docker æ‰§è¡Œå™¨å…è®¸æ‚¨è½»æ¾åˆ›å»ºå…·æœ‰ä¾èµ–æœåŠ¡çš„æ„å»ºç¯å¢ƒï¼Œä¾‹å¦‚ MySQLã€‚</p><p>å½“æˆ‘ä»¬åœ¨ Docker å®¹å™¨ä¸­å®‰è£… GitLab Runner å¹¶é€‰æ‹© Docker executoræ¥è¿è¡Œä½œä¸šæ—¶ï¼Œå®ƒæœ‰æ—¶è¢«ç§°ä¸º Docker-in-Docker ï¼ˆdindï¼‰é…ç½®ã€‚</p><p>æ³¨æ„ï¼šæœ‰äº›Dockerå®¹å™¨ä¸­ï¼Œé»˜è®¤çš„shellå¹¶ä¸æ˜¯bashï¼Œshellé€‰æ‹©é€»è¾‘å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [ -x /usr/local/bin/bash ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exec</span> /usr/local/bin/bash <span class="variable">$@</span></span><br><span class="line"><span class="keyword">elif</span> [ -x /usr/bin/bash ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exec</span> /usr/bin/bash <span class="variable">$@</span></span><br><span class="line"><span class="keyword">elif</span> [ -x /bin/bash ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exec</span> /bin/bash <span class="variable">$@</span></span><br><span class="line"><span class="keyword">elif</span> [ -x /usr/local/bin/sh ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exec</span> /usr/local/bin/sh <span class="variable">$@</span></span><br><span class="line"><span class="keyword">elif</span> [ -x /usr/bin/sh ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exec</span> /usr/bin/sh <span class="variable">$@</span></span><br><span class="line"><span class="keyword">elif</span> [ -x /bin/sh ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exec</span> /bin/sh <span class="variable">$@</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> shell not found</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://shisho.dev/blog/posts/docker-in-docker/">How To Run Docker in Docker</a></li><li><a href="https://devopscube.com/run-docker-in-docker/">How To Run Docker in Docker Container</a></li><li><a href="https://medium.com/@tonywooster/docker-in-docker-in-gitlab-runners-220caeb708ca">Docker-in-Docker in Gitlab Runners</a></li><li><a href="https://gitlab.com/gitlab-org/gitlab-runner/-/issues/1758">shell in docker executor isnâ€™t bash</a></li></ul><h2 id="Docker-Machine-executor"><a href="#Docker-Machine-executor" class="headerlink" title="Docker Machine executor"></a>Docker Machine executor</h2><p>Docker Machine æ˜¯ Docker æ‰§è¡Œå™¨çš„ç‰¹æ®Šç‰ˆæœ¬ï¼Œæ”¯æŒè‡ªåŠ¨ç¼©æ”¾ã€‚å®ƒåƒæ™®é€šçš„ Docker æ‰§è¡Œå™¨ä¸€æ ·å·¥ä½œï¼Œä½†ä½¿ç”¨ Docker Machine æŒ‰éœ€åˆ›å»ºçš„æ„å»ºä¸»æœºã€‚</p><p>Dockerå®˜æ–¹å·²ç»åºŸå¼ƒäº†Docker Machineï¼ŒGitLab Runnerä½¿ç”¨çš„æ˜¯è‡ªå·±ç»´æŠ¤çš„Docker Machineã€‚</p><p>Docker Machine executoråŸç†ï¼š</p><ul><li>å®‰è£…Runnerå¹¶é…ç½®gitlab-runnerç”¨æˆ·å…·æœ‰å¯åŠ¨è™šæ‹Ÿæœºçš„æƒé™</li><li>Runnerè°ƒç”¨é©±åŠ¨å¯åŠ¨Docker Machine VMï¼ŒVMç³»ç»Ÿä¸º<a href="https://github.com/boot2docker/boot2docker">Boot2Docker</a></li><li>å½“VMä¸­å¼€å§‹è·‘CI Jobæ—¶ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªDockerå®¹å™¨ä½œä¸ºæ‰§è¡Œå®¹å™¨ï¼Œåœ¨å®¹å™¨ä¸­è·‘CI Job</li><li>CI Jobä¸­å¯ä»¥åŒ…å«docker buildç­‰å‘½ä»¤ï¼Œæ­¤æ—¶ä¼šå…±äº«è°ƒç”¨VMçš„Dockerï¼Œæ˜¯Docker in Dockeræ¨¡å¼çš„ä¸€ç§</li></ul><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://docs.gitlab.com/runner/executors/docker_machine.html">Install and register GitLab Runner for autoscaling with Docker Machine</a></li><li><a href="https://docs.gitlab.com/runner/configuration/autoscale.html">Docker Machine Executor autoscale configuration</a></li></ul><h2 id="Kubernetes-executor"><a href="#Kubernetes-executor" class="headerlink" title="Kubernetes executor"></a>Kubernetes executor</h2><p>Kubernetes æ‰§è¡Œå™¨å…è®¸æ‚¨ä½¿ç”¨ç°æœ‰çš„ Kubernetes é›†ç¾¤è¿›è¡Œæ„å»ºã€‚æ‰§è¡Œå™¨å°†è°ƒç”¨ Kubernetes é›†ç¾¤ API å¹¶ä¸ºæ¯ä¸ª GitLab CI ä½œä¸šåˆ›å»ºä¸€ä¸ªæ–°çš„ Podï¼ˆå¸¦æœ‰æ„å»ºå®¹å™¨å’ŒæœåŠ¡å®¹å™¨ï¼‰ã€‚</p><p>Kubernetes executorä¹Ÿæ˜¯æ”¯æŒ Docker-in-Docker çš„ã€‚</p><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://docs.gitlab.com/runner/executors/kubernetes.html">The Kubernetes executor for GitLab Runner</a></li><li><a href="https://docs.gitlab.com/runner/executors/kubernetes.html#using-docker-in-your-builds">The Kubernetes executor for GitLab Runner - Using Docker in your builds</a></li><li><a href="https://stackoverflow.com/questions/58847455/cannot-access-docker-daemon-in-gitlab-runner-using-kubernetes-executor">Cannot access docker daemon in gitlab runner using Kubernetes executor</a></li></ul><h2 id="SSH-executor"><a href="#SSH-executor" class="headerlink" title="SSH executor"></a>SSH executor</h2><p>SSH æ‰§è¡Œå™¨æ˜¯ä¸ºäº†å®Œæ•´æ€§è€Œæ·»åŠ çš„ï¼Œä½†å®ƒæ˜¯æ‰€æœ‰æ‰§è¡Œå™¨ä¸­å—æ”¯æŒæœ€å°‘çš„ã€‚å®ƒä½¿ GitLab Runner è¿æ¥åˆ°å¤–éƒ¨æœåŠ¡å™¨å¹¶åœ¨é‚£é‡Œè¿è¡Œæ„å»ºã€‚æˆ‘ä»¬æœ‰ä¸€äº›æ¥è‡ªä½¿ç”¨æ­¤æ‰§è¡Œå™¨çš„ç»„ç»‡çš„æˆåŠŸæ¡ˆä¾‹ï¼Œä½†é€šå¸¸æˆ‘ä»¬å»ºè®®ä½¿ç”¨å…¶ä»–ç±»å‹ä¹‹ä¸€ã€‚</p><h2 id="Virtual-Machine-executor"><a href="#Virtual-Machine-executor" class="headerlink" title="Virtual Machine executor"></a>Virtual Machine executor</h2><p>è¿™ç§ç±»å‹çš„æ‰§è¡Œå™¨å…è®¸æ‚¨ä½¿ç”¨å·²åˆ›å»ºçš„è™šæ‹Ÿæœºï¼Œè¯¥è™šæ‹Ÿæœºè¢«å…‹éš†å¹¶ç”¨äºè¿è¡Œæ‚¨çš„æ„å»ºã€‚æˆ‘ä»¬æä¾›ä¸¤ä¸ªå®Œæ•´çš„ç³»ç»Ÿè™šæ‹ŸåŒ–é€‰é¡¹ï¼šVirtualBox å’Œ Parallelsã€‚å¦‚æœæ‚¨æƒ³åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œæ„å»ºï¼Œå®ƒä»¬å¯èƒ½ä¼šå¾ˆæœ‰ç”¨ï¼Œå› ä¸ºå®ƒå…è®¸åœ¨ Windowsã€Linuxã€macOS æˆ– FreeBSD ä¸Šåˆ›å»ºè™šæ‹Ÿæœºï¼Œç„¶å GitLab Runner è¿æ¥åˆ°è™šæ‹Ÿæœºå¹¶åœ¨å…¶ä¸Šè¿è¡Œæ„å»ºã€‚å®ƒçš„ä½¿ç”¨ä¹Ÿæœ‰åŠ©äºé™ä½åŸºç¡€è®¾æ–½æˆæœ¬ã€‚</p><h2 id="Custom-executor"><a href="#Custom-executor" class="headerlink" title="Custom executor"></a>Custom executor</h2><p>è‡ªå®šä¹‰æ‰§è¡Œå™¨å…è®¸æ‚¨æŒ‡å®šè‡ªå·±çš„æ‰§è¡Œç¯å¢ƒã€‚å½“ GitLab Runner ä¸æä¾›æ‰§è¡Œå™¨ï¼ˆä¾‹å¦‚ï¼ŒLXC å®¹å™¨ï¼‰æ—¶ï¼Œæ‚¨å¯ä»¥å‘ GitLab Runner æä¾›è‡ªå·±çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä»¥é…ç½®å’Œæ¸…ç†æ‚¨æƒ³è¦ä½¿ç”¨çš„ä»»ä½•ç¯å¢ƒã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;GitLab-Runnerç®€ä»‹&quot;&gt;&lt;a href=&quot;#GitLab-Runnerç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;GitLab Runnerç®€ä»‹&quot;&gt;&lt;/a&gt;GitLab Runnerç®€ä»‹&lt;/h1&gt;&lt;p&gt;GitLab Runner æ˜¯ä¸€ä¸ªå¼€æºè½¯ä»¶ï¼Œå®ƒä¸ GitLab CI/CD é…åˆï¼Œåœ¨ç®¡é“æµä¸­è¿è¡Œä½œä¸šã€‚&lt;br&gt;GitLab Runner æ˜¯ç”¨Goç¼–å†™ï¼Œå‡ ä¹å¯ä»¥ç›´æ¥è¿è¡Œåœ¨ä»»ä½•æ“ä½œç³»ç»Ÿï¼ˆä¸ªåˆ«ç³»ç»Ÿéœ€è¦è‡ªè¡Œç¼–è¯‘ï¼‰ã€‚&lt;br&gt;GitLab Runner ä¹Ÿå¯ä»¥åœ¨ Docker å®¹å™¨å†…è¿è¡Œæˆ–éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤ä¸­ã€‚&lt;/p&gt;
&lt;p&gt;GitLab Runnerèƒ½ä¸èƒ½æ›¿æ¢æˆå…¶ä»–çš„Runnerï¼Ÿå¯ä»¥ï¼Œä½†æ˜¯æ²¡æœ‰å¿…è¦ï¼Œæ¯•ç«ŸGitlab Runneræ˜¯å¼€æºçš„ï¼Œæœ‰ä»€ä¹ˆä¸ªæ€§åŒ–éœ€æ±‚å°±è‡ªå·±æ”¹ä¸€æ”¹ã€‚è€Œä¸”ï¼Œä¹Ÿæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ›¿ä»£äº§å“ã€‚&lt;/p&gt;
&lt;p&gt;å‚è€ƒæ–‡æ¡£ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.gitlab.com/runner/&quot;&gt;GitLab Runner&lt;/a&gt; &lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.gitlab.cn/jh/ci/&quot;&gt;GitLab CI/CDä¸­æ–‡æ–‡æ¡£&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.gitlab.com/ee/ci/&quot;&gt;GitLab CI/CDæ–‡æ¡£&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.gitlab.com/runner/&quot;&gt;GitLab Runner&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.gitlab.com/runner/executors/&quot;&gt;Executors&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.gitlab.com/runner/executors/shell.html&quot;&gt;The Shell executor&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.voidking.com/dev-gitlab-cicd/&quot;&gt;ã€ŠGitLab CI/CDå…¥é—¨ç¯‡ã€‹&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="engineering" scheme="https://www.voidking.com/categories/engineering/"/>
    
    <category term="k8s" scheme="https://www.voidking.com/categories/engineering/k8s/"/>
    
    <category term="devops" scheme="https://www.voidking.com/categories/engineering/devops/"/>
    
    <category term="cloudnative" scheme="https://www.voidking.com/categories/engineering/cloudnative/"/>
    
    <category term="git" scheme="https://www.voidking.com/categories/engineering/git/"/>
    
    
    <category term="git" scheme="https://www.voidking.com/tags/git/"/>
    
    <category term="cicd" scheme="https://www.voidking.com/tags/cicd/"/>
    
    <category term="gitlab" scheme="https://www.voidking.com/tags/gitlab/"/>
    
  </entry>
  
  <entry>
    <title>GitLab CIæŠ¥é”™ERROR: Job failed (system failure)</title>
    <link href="https://www.voidking.com/dev-gitlab-ci-job-faild-system-failure/"/>
    <id>https://www.voidking.com/dev-gitlab-ci-job-faild-system-failure/</id>
    <published>2022-11-10T19:00:00.000Z</published>
    <updated>2022-11-10T19:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h1><p>GitLab CIä»»åŠ¡ï¼ŒRunnerä½¿ç”¨çš„æ˜¯<code>docker machine executor</code>ç±»å‹çš„æ‰§è¡Œå™¨ï¼Œæ‰§è¡Œå¤±è´¥æŠ¥é”™ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Running on runner-h6ezaymy-project-1037-concurrent-0 via runner-h6ezaymy-auto-scale-1668060271-ce458595...</span><br><span class="line">...</span><br><span class="line">WARNING: Failed to pull image with policy &quot;if-not-present&quot;: error during connect: Post https://192.168.99.251:2376/v1.25/images/create?fromImage=registry.gitlab.com%2Fgitlab-org%2Fgitlab-runner%2Fgitlab-runner-helper&amp;tag=x86_64-58ba2b95: dial tcp 192.168.99.251:2376: connect: no route to host (manager.go:205:3s)</span><br><span class="line">ERROR: Job failed (system failure): error during connect: Post https://192.168.99.251:2376/v1.25/containers/47272fbe49e4be0f85724ad99f0657b72f568810ce0f4914c57e7fcf114764e2/wait: dial tcp 192.168.99.251:2376: connect: no route to host</span><br></pre></td></tr></table></figure><p>é‡è¯•ï¼Œé—®é¢˜ä¾æ—§ã€‚</p><span id="more"></span><h1 id="æ’æŸ¥æ€è·¯"><a href="#æ’æŸ¥æ€è·¯" class="headerlink" title="æ’æŸ¥æ€è·¯"></a>æ’æŸ¥æ€è·¯</h1><p>é—®é¢˜åŸå› çŒœæµ‹ï¼š</p><ul><li>å¶å‘é—®é¢˜ï¼Ÿç¡®è®¤æ˜¯å¦èƒ½ç¨³å®šå¤ç°</li><li>CICDé…ç½®é—®é¢˜ï¼Ÿç¡®è®¤CICDé…ç½®ï¼Œæ£€æŸ¥ç”¨æ³•æ˜¯å¦æ­£ç¡®</li><li>runneré—®é¢˜ï¼Ÿé‡å¯runnerï¼Œå†æ¬¡å°è¯•å¤ç°</li></ul><p>æ’æŸ¥ç¡®è®¤ï¼š</p><ul><li>å¶å‘é—®é¢˜ï¼Œé‡è¯•å¤±è´¥ï¼Œä½†æ˜¯å¤œé—´å¯ä»¥æˆåŠŸæ‰§è¡Œ</li><li>CICDé…ç½®æ­£å¸¸ï¼ŒæŠ¥é”™ä¸é…ç½®æ— å…³ï¼Œè€Œä¸”å¤œé—´å¯ä»¥æˆåŠŸæ‰§è¡Œ</li><li>runneré—®é¢˜æ— æ³•æ’é™¤ï¼Œéœ€è¦è¿›ä¸€æ­¥æ’æŸ¥</li></ul><h1 id="Runneré—®é¢˜æ’æŸ¥"><a href="#Runneré—®é¢˜æ’æŸ¥" class="headerlink" title="Runneré—®é¢˜æ’æŸ¥"></a>Runneré—®é¢˜æ’æŸ¥</h1><h2 id="ç½‘ç»œé—®é¢˜ï¼Ÿ"><a href="#ç½‘ç»œé—®é¢˜ï¼Ÿ" class="headerlink" title="ç½‘ç»œé—®é¢˜ï¼Ÿ"></a>ç½‘ç»œé—®é¢˜ï¼Ÿ</h2><p>ç™»å½•åˆ°runneræ‰€åœ¨å®¿ä¸»æœºï¼Œè¿›å…¥åˆ°runner</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-machine ssh runner-h6ezaymy-auto-scale-1668060271-ce458595</span><br></pre></td></tr></table></figure><p>æç¤ºvmä¸å­˜åœ¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-machine <span class="built_in">ls</span></span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å½“å‰çš„vmï¼Œè´Ÿè´£è¿è¡Œä»»åŠ¡çš„vmç¡®å®ä¸å­˜åœ¨äº†ï¼Œçœ‹æ¥ä¸æ˜¯ç½‘ç»œé—®é¢˜ã€‚<br>æ€€ç–‘æ˜¯vmå‡ºé—®é¢˜è¢«å¹²æ‰äº†ï¼Œç„¶åé‡æ–°åˆ›å»ºäº†ä¸€ä¸ªvmã€‚<br>é‚£ä¹ˆvmä¸ºä»€ä¹ˆä¼šè¢«å¹²æ‰ï¼Ÿçœ‹çœ‹æ—¥å¿—å§ã€‚</p><h2 id="æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—"><a href="#æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—" class="headerlink" title="æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—"></a>æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">journalctl -xe</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line"><span class="built_in">cat</span> /var/log/messages | grep -i <span class="built_in">kill</span> -A3 -B3</span><br></pre></td></tr></table></figure><p>ç¡®å®æ‰¾åˆ°äº†ç¨‹åºè¢«å¹²æ‰çš„è¯æ®ï¼Œåˆšå¥½å’Œgitlabciä»»åŠ¡å¤±è´¥çš„æ—¶é—´å»åˆã€‚</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">11æœˆ 10 17:13:42 runner kernel: Out of memory: Kill process 12293 (MainHGCMthread) score 215 or sacrifice child</span><br><span class="line">11æœˆ 10 17:13:42 runner kernel: Killed process 12294 (EMT-0), UID 0, total-vm:4345420kB, anon-rss:45340kB, file-rss:2622104kB, shmem-rss:4kB</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿™ä¸ªvmä¸ºä»€ä¹ˆè¢«å¹²æ‰äº†ï¼Ÿoomï¼Ÿ</p><h2 id="CIä»»åŠ¡å ç”¨å†…å­˜å¤ªé«˜ï¼Ÿ"><a href="#CIä»»åŠ¡å ç”¨å†…å­˜å¤ªé«˜ï¼Ÿ" class="headerlink" title="CIä»»åŠ¡å ç”¨å†…å­˜å¤ªé«˜ï¼Ÿ"></a>CIä»»åŠ¡å ç”¨å†…å­˜å¤ªé«˜ï¼Ÿ</h2><p>æ£€æŸ¥ciä»»åŠ¡çš„ä»£ç ï¼Œå¹¶æ²¡æœ‰å‘ç°å¯¼è‡´è¶…é«˜å†…å­˜å ç”¨çš„é€»è¾‘ã€‚</p><h2 id="Linux-OOMæœºåˆ¶"><a href="#Linux-OOMæœºåˆ¶" class="headerlink" title="Linux OOMæœºåˆ¶"></a>Linux OOMæœºåˆ¶</h2><p>å›æƒ³èµ·Linux OOMçš„é€»è¾‘ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªç¨‹åºå ç”¨å†…å­˜é«˜å°±æŠŠå®ƒå¹²æ‰ï¼Œè€Œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„å†…å­˜é«˜ï¼Œæ‰ä¼šé€‰å‡ºä¸€ä¸ªæ‰“åˆ†æœ€é«˜çš„ç¨‹åºå¹²æ‰ã€‚</p><p>è¿™å°±åˆç†äº†ï¼Œä¸‹åˆçš„æ—¶å€™runneræ‰€åœ¨å®¿ä¸»æœºä¸Šè·‘æ»¡äº†ä»»åŠ¡ï¼Œå¾ˆæœ‰å¯èƒ½å‡ºç°å†…å­˜ç´§å¼ çš„æƒ…å†µã€‚è€Œè¿™ä¸ªè¢«å¹²æ‰çš„runnerå½“æ—¶è¢«æ‰“åˆ†æœ€é«˜ï¼Œæ‰€ä»¥è¢«å¹²æ‰äº†ã€‚</p><p>Linux OOMæœºåˆ¶å‚è€ƒï¼š</p><ul><li><a href="https://www.cnblogs.com/MrLiuZF/p/15229868.html">Linux OOMæœºåˆ¶åˆ†æ</a></li><li><a href="https://www.vpsee.com/2013/10/how-to-configure-the-linux-oom-killer/">å¦‚ä½•ç†è§£å’Œé…ç½® Linux ä¸‹çš„ OOM Killerï¼Ÿ</a></li></ul><h1 id="è§£å†³åŠæ³•"><a href="#è§£å†³åŠæ³•" class="headerlink" title="è§£å†³åŠæ³•"></a>è§£å†³åŠæ³•</h1><p>æ–¹æ³•ä¸€ï¼šå¢åŠ èµ„æº<br>å‡çº§å®¿ä¸»æœºå†…å­˜ï¼Œæˆ–è€…æ·»åŠ runnerå®¿ä¸»æœº</p><p>æ–¹æ³•äºŒï¼šé”™å³°æ‰§è¡Œciä»»åŠ¡<br>æ¯”å¦‚è¿™ä¸ªå¤±è´¥çš„ä»»åŠ¡ï¼Œè¿˜æ˜¯å¤œé—´æ‰§è¡Œå§</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;é—®é¢˜æè¿°&quot;&gt;&lt;a href=&quot;#é—®é¢˜æè¿°&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜æè¿°&quot;&gt;&lt;/a&gt;é—®é¢˜æè¿°&lt;/h1&gt;&lt;p&gt;GitLab CIä»»åŠ¡ï¼ŒRunnerä½¿ç”¨çš„æ˜¯&lt;code&gt;docker machine executor&lt;/code&gt;ç±»å‹çš„æ‰§è¡Œå™¨ï¼Œæ‰§è¡Œå¤±è´¥æŠ¥é”™ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight text&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Running on runner-h6ezaymy-project-1037-concurrent-0 via runner-h6ezaymy-auto-scale-1668060271-ce458595...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;WARNING: Failed to pull image with policy &amp;quot;if-not-present&amp;quot;: error during connect: Post https://192.168.99.251:2376/v1.25/images/create?fromImage=registry.gitlab.com%2Fgitlab-org%2Fgitlab-runner%2Fgitlab-runner-helper&amp;amp;tag=x86_64-58ba2b95: dial tcp 192.168.99.251:2376: connect: no route to host (manager.go:205:3s)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ERROR: Job failed (system failure): error during connect: Post https://192.168.99.251:2376/v1.25/containers/47272fbe49e4be0f85724ad99f0657b72f568810ce0f4914c57e7fcf114764e2/wait: dial tcp 192.168.99.251:2376: connect: no route to host&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;é‡è¯•ï¼Œé—®é¢˜ä¾æ—§ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="engineering" scheme="https://www.voidking.com/categories/engineering/"/>
    
    <category term="devops" scheme="https://www.voidking.com/categories/engineering/devops/"/>
    
    <category term="troubleshooting" scheme="https://www.voidking.com/categories/engineering/troubleshooting/"/>
    
    <category term="git" scheme="https://www.voidking.com/categories/engineering/git/"/>
    
    
    <category term="é—®é¢˜æ’æŸ¥" scheme="https://www.voidking.com/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"/>
    
    <category term="git" scheme="https://www.voidking.com/tags/git/"/>
    
    <category term="cicd" scheme="https://www.voidking.com/tags/cicd/"/>
    
    <category term="gitlab" scheme="https://www.voidking.com/tags/gitlab/"/>
    
    <category term="oom" scheme="https://www.voidking.com/tags/oom/"/>
    
  </entry>
  
  <entry>
    <title>ArgoCDæŠ¥é”™Unable to load dataé—®é¢˜</title>
    <link href="https://www.voidking.com/dev-argocd-unable-to-load-data/"/>
    <id>https://www.voidking.com/dev-argocd-unable-to-load-data/</id>
    <published>2022-11-03T19:00:00.000Z</published>
    <updated>2022-11-03T19:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h1><p>æ–­ç”µåï¼Œk8sé›†ç¾¤é‡æ–°æ‹‰èµ·ã€‚argocdæ— æ³•åŒæ­¥gitlabä¸­çš„æ•°æ®ï¼ŒæŠ¥é”™ï¼š</p><p>Unable to load data: Failed to fetch default: <code>git fetch origin --tags --force</code> failed exit status 128: fatal: unable to access â€˜<a href="https://gitlab.voidking.com/devops/argocd.git/&#39;">https://gitlab.voidking.com/devops/argocd.git/&#39;</a>: server certificate verification failed. CAfile: none CRLfile: none</p><span id="more"></span><h1 id="æŸ¥æ—¥å¿—"><a href="#æŸ¥æ—¥å¿—" class="headerlink" title="æŸ¥æ—¥å¿—"></a>æŸ¥æ—¥å¿—</h1><h2 id="æŸ¥çœ‹argocd-repo-serveræ—¥å¿—"><a href="#æŸ¥çœ‹argocd-repo-serveræ—¥å¿—" class="headerlink" title="æŸ¥çœ‹argocd repo-serveræ—¥å¿—"></a>æŸ¥çœ‹argocd repo-serveræ—¥å¿—</h2><p>repo-serverè´Ÿè´£ä»gitlabåŒæ­¥æ•°æ®ï¼ŒæŸ¥çœ‹ä¸€ä¸‹å®ƒçš„æ—¥å¿—ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs --<span class="built_in">tail</span>=100 argo-cd-argocd-repo-server-547b6cf9f9-dff7d -n argocd</span><br></pre></td></tr></table></figure><p>å†…å®¹ä¸ºï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time=&quot;2022-11-03T06:04:33Z&quot; level=error msg=&quot;finished unary call with code Unknown&quot; error=&quot;Get \&quot;https://gitlab.voidking.com/devops/argocd.git/info/refs?service=git-upload-pack\&quot;: x509: certificate is not valid for any names, but wanted to match gitlab.voidking.com&quot; grpc.code=Unknown grpc.method=GenerateManifest grpc.request.deadline=&quot;2022-11-03T06:05:33Z&quot; grpc.service=repository.RepoServerService grpc.start_time=&quot;2022-11-03T06:04:33Z&quot; grpc.time_ms=38.558 span.kind=server system=grpc</span><br></pre></td></tr></table></figure><h2 id="æŸ¥çœ‹argocdå…¶ä»–ç»„ä»¶æ—¥å¿—"><a href="#æŸ¥çœ‹argocdå…¶ä»–ç»„ä»¶æ—¥å¿—" class="headerlink" title="æŸ¥çœ‹argocdå…¶ä»–ç»„ä»¶æ—¥å¿—"></a>æŸ¥çœ‹argocdå…¶ä»–ç»„ä»¶æ—¥å¿—</h2><p>æŒ¨ä¸ªæŸ¥çœ‹argocdå…¶ä»–ç»„ä»¶æ—¥å¿—ï¼Œå…¶ä¸­dex-serverçœ‹ç€æœ‰äº›é—®é¢˜</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs --<span class="built_in">tail</span>=100 argo-cd-argocd-dex-server-7cc5cc5455-c7q29  -n argocd</span><br></pre></td></tr></table></figure><p>å†…å®¹ä¸ºï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">time=&quot;2022-10-31T03:24:16Z&quot; level=info msg=&quot;keys expired, rotating&quot;</span><br><span class="line">time=&quot;2022-10-31T03:24:16Z&quot; level=info msg=&quot;keys rotated, next rotation: 2022-10-31 09:24:16.595711381 +0000 UTC&quot;</span><br></pre></td></tr></table></figure><h1 id="è¯ä¹¦é—®é¢˜ï¼Ÿ"><a href="#è¯ä¹¦é—®é¢˜ï¼Ÿ" class="headerlink" title="è¯ä¹¦é—®é¢˜ï¼Ÿ"></a>è¯ä¹¦é—®é¢˜ï¼Ÿ</h1><p>æ€€ç–‘æ˜¯è¯ä¹¦åˆ°æœŸå¯¼è‡´çš„ï¼Œæ‰“ç®—å¯¹è¯ä¹¦è¿›è¡Œæ›´æ–°ï¼Œå‚è€ƒæ–‡æ¡£<a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/tls/">TLS configuration</a></p><p>ä½†æ˜¯ï¼Œæ€ä¹ˆç¡®è®¤è¯ä¹¦å·²ç»åˆ°æœŸäº†å‘¢ï¼Ÿå…·ä½“æ€ä¹ˆæ“ä½œæ›´æ–°è¯ä¹¦ï¼Ÿ<br>æ²¡æœ‰æ‰¾åˆ°æ–¹æ³•ï¼Œå…ˆçœ‹çœ‹è¿˜æœ‰æ²¡æœ‰å…¶ä»–å¯èƒ½ã€‚</p><h1 id="é‡å¯ä¸€ä¸‹è¯•è¯•ï¼Ÿ"><a href="#é‡å¯ä¸€ä¸‹è¯•è¯•ï¼Ÿ" class="headerlink" title="é‡å¯ä¸€ä¸‹è¯•è¯•ï¼Ÿ"></a>é‡å¯ä¸€ä¸‹è¯•è¯•ï¼Ÿ</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k get pod argo-cd-argocd-repo-server-547b6cf9f9-dff7d -n argocd -oyaml | k replace --force -f -</span><br></pre></td></tr></table></figure><p>é‡å»ºpodåï¼Œé—®é¢˜è§£å†³äº†ã€‚ã€‚ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;é—®é¢˜æè¿°&quot;&gt;&lt;a href=&quot;#é—®é¢˜æè¿°&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜æè¿°&quot;&gt;&lt;/a&gt;é—®é¢˜æè¿°&lt;/h1&gt;&lt;p&gt;æ–­ç”µåï¼Œk8sé›†ç¾¤é‡æ–°æ‹‰èµ·ã€‚argocdæ— æ³•åŒæ­¥gitlabä¸­çš„æ•°æ®ï¼ŒæŠ¥é”™ï¼š&lt;/p&gt;
&lt;p&gt;Unable to load data: Failed to fetch default: &lt;code&gt;git fetch origin --tags --force&lt;/code&gt; failed exit status 128: fatal: unable to access â€˜&lt;a href=&quot;https://gitlab.voidking.com/devops/argocd.git/&amp;#39;&quot;&gt;https://gitlab.voidking.com/devops/argocd.git/&amp;#39;&lt;/a&gt;: server certificate verification failed. CAfile: none CRLfile: none&lt;/p&gt;</summary>
    
    
    
    <category term="engineering" scheme="https://www.voidking.com/categories/engineering/"/>
    
    <category term="k8s" scheme="https://www.voidking.com/categories/engineering/k8s/"/>
    
    <category term="devops" scheme="https://www.voidking.com/categories/engineering/devops/"/>
    
    <category term="cloudnative" scheme="https://www.voidking.com/categories/engineering/cloudnative/"/>
    
    <category term="troubleshooting" scheme="https://www.voidking.com/categories/engineering/troubleshooting/"/>
    
    
    <category term="k8s" scheme="https://www.voidking.com/tags/k8s/"/>
    
    <category term="é—®é¢˜æ’æŸ¥" scheme="https://www.voidking.com/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"/>
    
    <category term="argocd" scheme="https://www.voidking.com/tags/argocd/"/>
    
    <category term="cicd" scheme="https://www.voidking.com/tags/cicd/"/>
    
    <category term="devops" scheme="https://www.voidking.com/tags/devops/"/>
    
  </entry>
  
  <entry>
    <title>KubeSphereç‰ˆæœ¬å‡çº§</title>
    <link href="https://www.voidking.com/dev-kubesphere-upgrade/"/>
    <id>https://www.voidking.com/dev-kubesphere-upgrade/</id>
    <published>2022-11-02T10:00:00.000Z</published>
    <updated>2022-11-18T10:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="éœ€æ±‚æè¿°"><a href="#éœ€æ±‚æè¿°" class="headerlink" title="éœ€æ±‚æè¿°"></a>éœ€æ±‚æè¿°</h1><p>å½“å‰KubeSphereç‰ˆæœ¬v3.2.1ï¼Œä½†æ˜¯å› ä¸ºæƒé™ç®¡ç†ä¸å¥½ç”¨ï¼ˆä¸èƒ½é’ˆå¯¹ä¸åŒé›†ç¾¤å•ç‹¬æˆæƒï¼‰ï¼Œå› æ­¤è®¡åˆ’å‡çº§åˆ°v3.3.1ã€‚<br>KubeSphere v3.3.0ä¹‹åæ”¯æŒä¸ºæ¯ä¸ªé›†ç¾¤å•ç‹¬è®¾ç½®é›†ç¾¤æˆå‘˜å’Œé›†ç¾¤è§’è‰²ï¼Œæä¾›äº†æ›´ç»†ç²’åº¦çš„æƒé™ç®¡æ§æœºåˆ¶ï¼Œè¿›ä¸€æ­¥å®Œå–„äº† KubeSphere çš„å¤šç§Ÿæˆ·ç³»ç»Ÿã€‚</p><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://baijiahao.baidu.com/s?id=1737027419479012228&wfr=spider&for=pc">KubeSphere 3.3.0 å…¨æ–°å‡çº§ï¼Œæ¥äº†ï¼</a></li><li><a href="https://kubesphere.io/zh/docs/v3.3/release/release-v331/">Release Notes - 3.3.1 ç‰ˆæœ¬è¯´æ˜</a></li><li><a href="https://kubesphere.io/zh/docs/v3.3/upgrade/upgrade-with-ks-installer/">ä½¿ç”¨ ks-installer å‡çº§</a></li><li><a href="https://kubesphere.io/zh/docs/v3.3/upgrade/air-gapped-upgrade-with-ks-installer/">ä½¿ç”¨ ks-installer ç¦»çº¿å‡çº§</a></li></ul><span id="more"></span><h1 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h1><ul><li>æ‚¨åº”è¯¥å…ˆåœ¨æµ‹è¯•ç¯å¢ƒä¸­å®æ–½å‡çº§æ¨¡æ‹Ÿã€‚åœ¨æµ‹è¯•ç¯å¢ƒä¸­æˆåŠŸå‡çº§å¹¶ä¸”æ‰€æœ‰åº”ç”¨ç¨‹åºéƒ½æ­£å¸¸è¿è¡Œä¹‹åï¼Œå†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å‡çº§æ‚¨çš„é›†ç¾¤ã€‚</li><li>åœ¨å‡çº§è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½ä¼šçŸ­æš‚ä¸­æ–­ï¼ˆå°¤å…¶æ˜¯å•å‰¯æœ¬å®¹å™¨ç»„ï¼‰ï¼Œè¯·å®‰æ’åˆç†çš„å‡çº§æ—¶é—´ã€‚</li><li>å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å‡çº§ä¹‹å‰å¤‡ä»½ etcd å’Œæœ‰çŠ¶æ€åº”ç”¨ç¨‹åºã€‚æ‚¨å¯ä»¥ä½¿ç”¨ Velero æ¥å¤‡ä»½å’Œè¿ç§» Kubernetes èµ„æºä»¥åŠæŒä¹…åŒ–å­˜å‚¨å·ã€‚</li></ul><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://kubesphere.io/zh/docs/v3.3/upgrade/overview/">å‡çº§ - æ¦‚è¿°</a></li><li><a href="https://velero.io/">Velero</a></li><li><a href="https://baijiahao.baidu.com/s?id=1736481781028427417&wfr=spider&for=pc">è¯¦è§£kuberneteså¤‡ä»½æ¢å¤åˆ©å™¨ Velero</a></li></ul><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><p>1ã€å¤‡ä»½<br>2ã€kubesphereæ‰§è¡Œå‡çº§</p><h1 id="å¤‡ä»½"><a href="#å¤‡ä»½" class="headerlink" title="å¤‡ä»½"></a>å¤‡ä»½</h1><h2 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h2><p>å¤‡ä»½etcdï¼Œå‚è€ƒ <a href="https://www.voidking.com/dev-k8s-etcd-backup-restore/">ã€ŠK8Sé›†ç¾¤ä¸­etcdå¤‡ä»½å’Œæ¢å¤ã€‹</a></p><h2 id="æœ‰çŠ¶æ€åº”ç”¨ç¨‹åº"><a href="#æœ‰çŠ¶æ€åº”ç”¨ç¨‹åº" class="headerlink" title="æœ‰çŠ¶æ€åº”ç”¨ç¨‹åº"></a>æœ‰çŠ¶æ€åº”ç”¨ç¨‹åº</h2><p>æœªå®Œå¾…ç»­</p><h1 id="æ‰§è¡Œå‡çº§"><a href="#æ‰§è¡Œå‡çº§" class="headerlink" title="æ‰§è¡Œå‡çº§"></a>æ‰§è¡Œå‡çº§</h1><p>1ã€ä¸‹è½½yamlæ–‡ä»¶&amp;æäº¤åˆ°k8sé›†ç¾¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/kubesphere/ks-installer/releases/download/v3.3.1/kubesphere-installer.yaml</span><br><span class="line">kubectl apply -f kubesphere-installer.yaml  --force</span><br></pre></td></tr></table></figure><p>2ã€è§‚å¯Ÿå‡çº§è¿›å±•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all -n kubesphere-system</span><br><span class="line">kubectl get pods -n kubesphere-system</span><br><span class="line">kubectl describe job.batch/ks-upgrade -n kubesphere-system</span><br><span class="line">kubectl logs -f ks-installer-895b8994d-5qrjs -n kubesphere-system</span><br></pre></td></tr></table></figure><p>3ã€éªŒè¯å‡çº§åçš„ç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n kubesphere-system -oyaml | grep image:</span><br></pre></td></tr></table></figure><p>æµè§ˆå™¨è®¿é—®ksï¼Œå³ä¸Šè§’ç‚¹å‡»<code>ç”¨æˆ·å</code>ï¼Œ<code>å…³äº</code>ï¼Œå°±å¯ä»¥çœ‹åˆ°å½“å‰ksç‰ˆæœ¬ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;éœ€æ±‚æè¿°&quot;&gt;&lt;a href=&quot;#éœ€æ±‚æè¿°&quot; class=&quot;headerlink&quot; title=&quot;éœ€æ±‚æè¿°&quot;&gt;&lt;/a&gt;éœ€æ±‚æè¿°&lt;/h1&gt;&lt;p&gt;å½“å‰KubeSphereç‰ˆæœ¬v3.2.1ï¼Œä½†æ˜¯å› ä¸ºæƒé™ç®¡ç†ä¸å¥½ç”¨ï¼ˆä¸èƒ½é’ˆå¯¹ä¸åŒé›†ç¾¤å•ç‹¬æˆæƒï¼‰ï¼Œå› æ­¤è®¡åˆ’å‡çº§åˆ°v3.3.1ã€‚&lt;br&gt;KubeSphere v3.3.0ä¹‹åæ”¯æŒä¸ºæ¯ä¸ªé›†ç¾¤å•ç‹¬è®¾ç½®é›†ç¾¤æˆå‘˜å’Œé›†ç¾¤è§’è‰²ï¼Œæä¾›äº†æ›´ç»†ç²’åº¦çš„æƒé™ç®¡æ§æœºåˆ¶ï¼Œè¿›ä¸€æ­¥å®Œå–„äº† KubeSphere çš„å¤šç§Ÿæˆ·ç³»ç»Ÿã€‚&lt;/p&gt;
&lt;p&gt;å‚è€ƒæ–‡æ¡£ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://baijiahao.baidu.com/s?id=1737027419479012228&amp;wfr=spider&amp;for=pc&quot;&gt;KubeSphere 3.3.0 å…¨æ–°å‡çº§ï¼Œæ¥äº†ï¼&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://kubesphere.io/zh/docs/v3.3/release/release-v331/&quot;&gt;Release Notes - 3.3.1 ç‰ˆæœ¬è¯´æ˜&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://kubesphere.io/zh/docs/v3.3/upgrade/upgrade-with-ks-installer/&quot;&gt;ä½¿ç”¨ ks-installer å‡çº§&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://kubesphere.io/zh/docs/v3.3/upgrade/air-gapped-upgrade-with-ks-installer/&quot;&gt;ä½¿ç”¨ ks-installer ç¦»çº¿å‡çº§&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="engineering" scheme="https://www.voidking.com/categories/engineering/"/>
    
    <category term="k8s" scheme="https://www.voidking.com/categories/engineering/k8s/"/>
    
    <category term="cloudnative" scheme="https://www.voidking.com/categories/engineering/cloudnative/"/>
    
    
    <category term="k8s" scheme="https://www.voidking.com/tags/k8s/"/>
    
    <category term="kubesphere" scheme="https://www.voidking.com/tags/kubesphere/"/>
    
  </entry>
  
  <entry>
    <title>K8Sé…ç½®ä½¿ç”¨imagePullSecrets</title>
    <link href="https://www.voidking.com/dev-k8s-imagepullsecrets/"/>
    <id>https://www.voidking.com/dev-k8s-imagepullsecrets/</id>
    <published>2022-10-22T14:00:00.000Z</published>
    <updated>2022-12-19T19:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><a href="https://www.voidking.com/dev-harbor-start/">ã€ŠHarborå…¥é—¨ç¯‡ã€‹</a>ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å·²ç»å®‰è£…é…ç½®å¥½äº†Harborã€‚<br>æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æ¥å­¦ä¹ ä¸€ä¸‹æ€æ ·åœ¨K8Sä¸­é…ç½®ä½¿ç”¨imagePullSecretsï¼Œä»Harboræˆ–è€…å…¶ä»–ç§æœ‰é•œåƒä»“åº“æ‹‰å–é•œåƒã€‚</p><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/pull-image-private-registry/">ä»ç§æœ‰ä»“åº“æ‹‰å–é•œåƒ</a></li></ul><span id="more"></span><h1 id="åˆ›å»ºimagePullSecrets"><a href="#åˆ›å»ºimagePullSecrets" class="headerlink" title="åˆ›å»ºimagePullSecrets"></a>åˆ›å»ºimagePullSecrets</h1><p>åˆ›å»ºä¸€ä¸ªdocker-registryç±»å‹çš„secretï¼Œåå­—ä¸º<code>harbor-secret</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret docker-registry harbor-secret \</span><br><span class="line">  --docker-server=harbor.voidking.com \</span><br><span class="line">  --docker-username=admin \</span><br><span class="line">  --docker-password=Harbor12345</span><br></pre></td></tr></table></figure><h1 id="ä½¿ç”¨imagePullSecrets"><a href="#ä½¿ç”¨imagePullSecrets" class="headerlink" title="ä½¿ç”¨imagePullSecrets"></a>ä½¿ç”¨imagePullSecrets</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">testpod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">harbor.voidking.com/voidking/busybox:1.31</span></span><br><span class="line">    <span class="attr">command:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;36000&quot;</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">harbor-secret</span></span><br></pre></td></tr></table></figure><h1 id="ç»™podæ·»åŠ é»˜è®¤imagePullSecrets"><a href="#ç»™podæ·»åŠ é»˜è®¤imagePullSecrets" class="headerlink" title="ç»™podæ·»åŠ é»˜è®¤imagePullSecrets"></a>ç»™podæ·»åŠ é»˜è®¤imagePullSecrets</h1><p>ä¸Šé¢çš„é…ç½®ï¼Œå·²ç»å¯ä»¥æ­£å¸¸ä»harboré•œåƒä»“åº“æ‹‰å–é•œåƒäº†ã€‚<br>ä½†æ˜¯ï¼Œæ¯ä¸ªpodéƒ½éœ€è¦æŒ‡å®šä¸€ä¸‹imagePullSecretsï¼Œä¹Ÿæ˜¯æ¯”è¾ƒéº»çƒ¦ã€‚<br>è¿™é‡Œæˆ‘ä»¬å¯ä»¥åœ¨å‘½åç©ºé—´é»˜è®¤saä¸­æ·»åŠ imagePullSecretsï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ç”¨åœ¨podä¸­æŒ‡å®šimagePullSecretsäº†ï¼Œåˆ›å»ºpodæ—¶ä¼šè‡ªåŠ¨æ³¨å…¥ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch serviceaccount default \</span><br><span class="line">  -p <span class="string">&quot;&#123;\&quot;imagePullSecrets\&quot;: [&#123;\&quot;name\&quot;: \&quot;docker-secret\&quot;&#125;]&#125;&quot;</span> \</span><br><span class="line">  -n &lt;your-namespace&gt;</span><br></pre></td></tr></table></figure><h1 id="å…¨å±€é…ç½®imagePullSecrets"><a href="#å…¨å±€é…ç½®imagePullSecrets" class="headerlink" title="å…¨å±€é…ç½®imagePullSecrets"></a>å…¨å±€é…ç½®imagePullSecrets</h1><p>å¦‚æœæ–°å¢äº†namespaceï¼Œé‚£ä¹ˆè¿™ä¸ªnamespaceå°±éœ€è¦å•ç‹¬æ·»åŠ ä¸€æ¬¡imagePullSecretsï¼Œè€Œä¸”è¿™ä¸ªnamespaceçš„saä¹Ÿéœ€è¦æ·»åŠ imagePullSecretsã€‚</p><p>è¿™é‡Œå¯ä»¥ä½¿ç”¨imagepullsecret-patcheræ¥ç®€åŒ–æˆ‘ä»¬çš„å·¥ä½œï¼Œå‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://devopstales.github.io/kubernetes/k8s-imagepullsecret-patcher/">How to use imagePullSecrets cluster-wide??</a></li><li><a href="https://medium.com/titansoft-engineering/kubernetes-cluster-wide-access-to-private-container-registry-with-imagepullsecret-patcher-b8b8fb79f7e5">Kubernetes cluster-wide access to private container registry with imagepullsecret-patcher</a></li><li><a href="https://github.com/titansoft-pte-ltd/imagepullsecret-patcher">imagepullsecret-patcher</a></li><li><a href="https://github.com/titansoft-pte-ltd/imagepullsecret-patcher/tree/master/deploy-example">imagepullsecret-patcher deploy-example</a></li></ul><p>1ã€åˆ›å»º sa.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">imagepullsecret-patcher</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">imagepullsecret-patcher</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">imagepullsecret-patcher</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">imagepullsecret-patcher</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">imagepullsecret-patcher</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">serviceaccounts</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">delete</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">imagepullsecret-patcher</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">imagepullsecret-patcher</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">imagepullsecret-patcher</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">imagepullsecret-patcher</span></span><br></pre></td></tr></table></figure><p>2ã€è·å– dockerconfigjson</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret harbor-secret -oyaml</span><br></pre></td></tr></table></figure><p>3ã€åˆ›å»º deployment.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/dockerconfigjson</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">image-pull-secret-src</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">imagepullsecret-patcher</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">.dockerconfigjson:</span> <span class="string">eyJhdXRocyI6eyJnY3IuaW8iOnsicGFzc3dvcmQiOiJ7XCJhdXRoXCI6e1wiZ2NyLmlvXCI6e1widXNlcm5hbWVcIjpcIl9qc29uX2tleVwiLFwicGFzc3dvcmRcIjpcInt9XCJ9fX0iLCJ1c2VybmFtZSI6Il9qc29uX2tleSJ9fX0=</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">imagepullsecret-patcher</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">imagepullsecret-patcher</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">imagepullsecret-patcher</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">imagepullsecret-patcher</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">imagepullsecret-patcher</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">automountServiceAccountToken:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">imagepullsecret-patcher</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">imagepullsecret-patcher</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">&quot;quay.io/titansoft/imagepullsecret-patcher:v0.14&quot;</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FORCE</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_DEBUG</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_ALLSERVICEACCOUNT</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_DOCKERCONFIGJSONPATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;/app/secrets/.dockerconfigjson&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_SECRETNAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;harbor-secret&quot;</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">src-dockerconfigjson</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">&quot;/app/secrets&quot;</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="number">0.1</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">15Mi</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="number">0.2</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">30Mi</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">src-dockerconfigjson</span></span><br><span class="line">          <span class="attr">secret:</span> </span><br><span class="line">            <span class="attr">secretName:</span> <span class="string">image-pull-secret-src</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­dockerconfigjsonæ”¹æˆæ­¥éª¤2ä¸­è·å–åˆ°çš„é…ç½®ï¼ŒCONFIG_SECRETNAMEå˜é‡çš„valueæ”¹æˆæœŸæœ›çš„secretåç§°ã€‚</p><p>4ã€å®‰è£…imagepullsecret-patcher</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f sa.yaml</span><br><span class="line">kubectl apply -f deployment.yaml</span><br></pre></td></tr></table></figure><p>5ã€æŸ¥çœ‹å®‰è£…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all -n imagepullsecret-patcher</span><br><span class="line">kubectl get sa -n imagepullsecret-patcher</span><br><span class="line">kubectl get sa default -n imagepullsecret-patcher -oyaml</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°ï¼Œ<code>harbor-secret</code> å·²ç»æ³¨å…¥åˆ°äº†saä¸­ã€‚</p><h1 id="åˆ é™¤imagePullSecrets"><a href="#åˆ é™¤imagePullSecrets" class="headerlink" title="åˆ é™¤imagePullSecrets"></a>åˆ é™¤imagePullSecrets</h1><p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ›¿æ¢imagePullSecretsï¼Œæ¯”å¦‚imagePullSecretsåç§°å‘ç”Ÿäº†å˜æ›´ã€‚è¿™æ—¶å°±éœ€è¦åˆ é™¤åŸæœ¬çš„imagePullSecretsã€‚</p><p>å•ä¸ªsaåˆ é™¤imagePullSecretsæ–¹æ³•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INDEX=$(kubectl get sa default -n imagepullsecret-patcher -o json | jq <span class="string">&#x27;.imagePullSecrets | map(.name == &quot;harbor-secret&quot;) | index(true)&#x27;</span>)</span><br><span class="line">kubectl patch sa default --<span class="built_in">type</span>=json -p=<span class="string">&quot;[&#123;&#x27;op&#x27;: &#x27;remove&#x27;, &#x27;path&#x27;: &#x27;/imagePullSecrets/<span class="variable">$INDEX</span>&#x27;&#125;]&quot;</span> -n imagepullsecret-patcher</span><br></pre></td></tr></table></figure><p>æ‰¹é‡saåˆ é™¤imagePullSecretsæ–¹æ³•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">kubectl get ns | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | grep -v <span class="string">&quot;NAME&quot;</span> &gt; namespace.txt</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> namespace <span class="keyword">in</span> `<span class="built_in">cat</span> namespace.txt`;<span class="keyword">do</span></span><br><span class="line">  INDEX=$(kubectl get sa default -n <span class="variable">$namespace</span> -o json | jq <span class="string">&#x27;.imagePullSecrets | map(.name == &quot;harbor-secret&quot;) | index(true)&#x27;</span>)</span><br><span class="line">  kubectl patch sa default --<span class="built_in">type</span>=json -p=<span class="string">&quot;[&#123;&#x27;op&#x27;: &#x27;remove&#x27;, &#x27;path&#x27;: &#x27;/imagePullSecrets/<span class="variable">$INDEX</span>&#x27;&#125;]&quot;</span> -n <span class="variable">$namespace</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://www.voidking.com/dev-harbor-start/&quot;&gt;ã€ŠHarborå…¥é—¨ç¯‡ã€‹&lt;/a&gt;ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å·²ç»å®‰è£…é…ç½®å¥½äº†Harborã€‚&lt;br&gt;æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æ¥å­¦ä¹ ä¸€ä¸‹æ€æ ·åœ¨K8Sä¸­é…ç½®ä½¿ç”¨imagePullSecretsï¼Œä»Harboræˆ–è€…å…¶ä»–ç§æœ‰é•œåƒä»“åº“æ‹‰å–é•œåƒã€‚&lt;/p&gt;
&lt;p&gt;å‚è€ƒæ–‡æ¡£ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/pull-image-private-registry/&quot;&gt;ä»ç§æœ‰ä»“åº“æ‹‰å–é•œåƒ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="engineering" scheme="https://www.voidking.com/categories/engineering/"/>
    
    <category term="k8s" scheme="https://www.voidking.com/categories/engineering/k8s/"/>
    
    <category term="docker" scheme="https://www.voidking.com/categories/engineering/docker/"/>
    
    <category term="cloudnative" scheme="https://www.voidking.com/categories/engineering/cloudnative/"/>
    
    
    <category term="k8s" scheme="https://www.voidking.com/tags/k8s/"/>
    
    <category term="docker" scheme="https://www.voidking.com/tags/docker/"/>
    
    <category term="harbor" scheme="https://www.voidking.com/tags/harbor/"/>
    
  </entry>
  
  <entry>
    <title>K8Sä¸­å®‰è£…é…ç½®KubeSphere</title>
    <link href="https://www.voidking.com/dev-k8s-kubesphere/"/>
    <id>https://www.voidking.com/dev-k8s-kubesphere/</id>
    <published>2022-10-10T15:00:00.000Z</published>
    <updated>2023-01-11T10:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="KubeSphereç®€ä»‹"><a href="#KubeSphereç®€ä»‹" class="headerlink" title="KubeSphereç®€ä»‹"></a>KubeSphereç®€ä»‹</h1><blockquote><p>KubeSphere æ„¿æ™¯æ˜¯æ‰“é€ ä¸€ä¸ªä»¥ Kubernetes ä¸ºå†…æ ¸çš„äº‘åŸç”Ÿåˆ†å¸ƒå¼æ“ä½œç³»ç»Ÿï¼Œå®ƒçš„æ¶æ„å¯ä»¥éå¸¸æ–¹ä¾¿åœ°ä½¿ç¬¬ä¸‰æ–¹åº”ç”¨ä¸äº‘åŸç”Ÿç”Ÿæ€ç»„ä»¶è¿›è¡Œå³æ’å³ç”¨ï¼ˆplug-and-playï¼‰çš„é›†æˆï¼Œæ”¯æŒäº‘åŸç”Ÿåº”ç”¨åœ¨å¤šäº‘ä¸å¤šé›†ç¾¤çš„ç»Ÿä¸€åˆ†å‘å’Œè¿ç»´ç®¡ç†ã€‚</p></blockquote><p>ç®€å•æ¥è¯´ï¼ŒKubeSphereï¼ˆä¸‹æ–‡ç®€ç§°ksï¼‰å°±æ˜¯ä¸€ä¸ªå®¹å™¨ç®¡ç†å¹³å°ï¼Œå¯ä»¥å›¾å½¢åŒ–ç®¡ç†å¤šä¸ªK8Sé›†ç¾¤ã€‚</p><p>ç›¸å…³é“¾æ¥ï¼š</p><ul><li><a href="https://kubesphere.io/zh/">KubeSphereå®˜ç½‘</a></li><li><a href="https://kubesphere.io/zh/videos/">KubeSphereå­¦ä¹ è§†é¢‘</a></li></ul><span id="more"></span><h1 id="å®‰è£…å‡†å¤‡"><a href="#å®‰è£…å‡†å¤‡" class="headerlink" title="å®‰è£…å‡†å¤‡"></a>å®‰è£…å‡†å¤‡</h1><p>å‚è€ƒ<a href="https://kubesphere.io/zh/docs/v3.3/installing-on-kubernetes/introduction/prerequisites/">åœ¨ Kubernetes ä¸Šå®‰è£… KubeSphere - å‡†å¤‡å·¥ä½œ</a>ï¼Œç¡®è®¤ç¯å¢ƒæ»¡è¶³kså®‰è£…éœ€æ±‚ã€‚</p><h2 id="k8sç‰ˆæœ¬"><a href="#k8sç‰ˆæœ¬" class="headerlink" title="k8sç‰ˆæœ¬"></a>k8sç‰ˆæœ¬</h2><p>è®¡åˆ’å®‰è£…kubesphere-v3.3.0ç‰ˆæœ¬ï¼Œéœ€è¦ç¡®è®¤ Kubernetes ç‰ˆæœ¬å¿…é¡»ä¸ºï¼šv1.19.xï¼Œv1.20.xï¼Œv1.21.xï¼Œv1.22.x æˆ– v1.23.xï¼ˆå®éªŒæ€§æ”¯æŒï¼‰ã€‚</p><h2 id="èµ„æº"><a href="#èµ„æº" class="headerlink" title="èµ„æº"></a>èµ„æº</h2><p>å¯ç”¨ CPU &gt; 1 æ ¸ï¼›å†…å­˜ &gt; 2 Gã€‚CPU å¿…é¡»ä¸º x86_64ï¼Œæš‚æ—¶ä¸æ”¯æŒ Arm æ¶æ„çš„ CPUã€‚</p><h2 id="StorageClass"><a href="#StorageClass" class="headerlink" title="StorageClass"></a>StorageClass</h2><p>Kubernetes é›†ç¾¤å·²é…ç½®é»˜è®¤ StorageClassï¼ˆè¯·ä½¿ç”¨ <code>kubectl get sc</code> è¿›è¡Œç¡®è®¤ï¼‰ã€‚<br>è¿™ä¸€æ¡æ˜¯æœ€é‡è¦çš„ï¼Œå› ä¸ºk8sé›†ç¾¤é»˜è®¤å¹¶ä¸ä¼šé…ç½®storageclassï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±å•ç‹¬é…ç½®ã€‚<br>storageå®‰è£…é…ç½®æ–¹æ³•å‚è€ƒ<a href="https://www.voidking.com/dev-k8s-storageclass/">ã€ŠK8Sä¸­å®‰è£…é…ç½®StorageClassã€‹</a></p><h1 id="å®‰è£…ks"><a href="#å®‰è£…ks" class="headerlink" title="å®‰è£…ks"></a>å®‰è£…ks</h1><p>å‚è€ƒ<a href="https://kubesphere.io/zh/docs/v3.3/installing-on-kubernetes/introduction/overview/">åœ¨ Kubernetes ä¸Šå®‰è£… KubeSphere - æ¦‚è¿°</a>ï¼Œå®‰è£…kubesphere-v3.3.0ç‰ˆæœ¬</p><p>1ã€ä¸‹è½½yaml</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/kubesphere/ks-installer/releases/download/v3.3.0/kubesphere-installer.yaml</span><br><span class="line">wget https://github.com/kubesphere/ks-installer/releases/download/v3.3.0/cluster-configuration.yaml</span><br></pre></td></tr></table></figure><p>2ã€ä¿®æ”¹yaml<br>æŒ‰éœ€ä¿®æ”¹cluster-configuration.yamlã€‚<br>ks-apiserverå’Œks-controller-managerçš„èµ„æºè°ƒæ•´ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">common:</span></span><br><span class="line">    <span class="attr">core:</span></span><br><span class="line">      <span class="attr">console:</span></span><br><span class="line">        <span class="attr">enableMultiLogin:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">30880</span></span><br><span class="line">      <span class="attr">apiserver:</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">400Mi</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">8Gi</span></span><br><span class="line">      <span class="attr">controllerManager:</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">400Mi</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">8Gi</span></span><br></pre></td></tr></table></figure><p>å› ä¸ºks-apiserverå’Œks-controller-managerå®¹æ˜“OOMï¼Œæ‰€ä»¥å†…å­˜ä¸Šé™è®¾ç½®é«˜ã€‚</p><p>3ã€æäº¤yamlåˆ°k8sé›†ç¾¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kubesphere-installer.yaml</span><br><span class="line">kubectl apply -f cluster-configuration.yaml</span><br></pre></td></tr></table></figure><p>4ã€æŸ¥çœ‹å®‰è£…è¿‡ç¨‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k describe pod/ks-installer-xxx-xxx -n kubesphere-system</span><br><span class="line">kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l <span class="string">&#x27;app in (ks-install, ks-installer)&#x27;</span> -o jsonpath=<span class="string">&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span>) -f</span><br></pre></td></tr></table></figure><p>5ã€æŸ¥çœ‹ksçŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all -n kubesphere-system</span><br><span class="line">kubectl get svc/ks-console -n kubesphere-system</span><br></pre></td></tr></table></figure><h1 id="storageclassé—®é¢˜æ’æŸ¥"><a href="#storageclassé—®é¢˜æ’æŸ¥" class="headerlink" title="storageclassé—®é¢˜æ’æŸ¥"></a>storageclassé—®é¢˜æ’æŸ¥</h1><p>redisæ²¡æœ‰readyï¼Œä¸€ç›´å¤„äºpendingçŠ¶æ€ï¼ŒæŸ¥çœ‹è¯¦æƒ…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod/redis-d744b7468-45sh4 -n kubesphere-system</span><br></pre></td></tr></table></figure><p>æŠ¥é”™ï¼š0/x nodes are available: x pod has unbound immediate PersistentVolumeClaims.</p><p>æŸ¥çœ‹nfs-client-provisioneræ—¥å¿—</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs --<span class="built_in">tail</span>=100 nfs-client-provisioner-7975f9b954-7fw5l</span><br></pre></td></tr></table></figure><p>æŠ¥é”™ï¼š<br>provision â€œkubesphere-system/redis-pvcâ€ class â€œnfs-storageâ€: unexpected error getting claim reference: selfLink was empty, canâ€™t make reference</p><p>è¿™æ˜¯å› ä¸ºï¼Œ1.20.xä¹‹åçš„k8sç‰ˆæœ¬ï¼Œselflinkå·²ç»å¼ƒç”¨äº†ã€‚è€Œnfs-client-provisionerçš„å®ç°åŸºäºselflinkï¼Œå› æ­¤æŠ¥é”™ã€‚</p><p>è§£å†³åŠæ³•ï¼šapiserverå¯åŠ¨æ—¶æ·»åŠ å‚æ•°<code>--feature-gates=RemoveSelfLink=false</code><br>1ã€ç¼–è¾‘kube-apiserver.yaml</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br></pre></td></tr></table></figure><p>å¦‚ä¸‹ä¿®æ”¹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--...</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--feature-gates=RemoveSelfLink=false</span></span><br></pre></td></tr></table></figure><p>2ã€é‡å»ºapiserver pod<br>å› ä¸ºapiserveræ˜¯static podï¼Œæ‰€ä»¥åœ¨ä¿®æ”¹å®Œkube-apiserver.yamlåä¼šè‡ªåŠ¨é‡å»ºã€‚</p><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner/issues/25">unexpected error getting claim reference: selfLink was empty, canâ€™t make reference</a></li><li><a href="https://www.cnblogs.com/zhangsi-lzq/p/14292628.html">kubernetes1.20ç‰ˆæœ¬ nfs-provisioneræŠ¥é”™é—®é¢˜:â€selfLink was emptyâ€</a></li></ul><h1 id="éªŒè¯ks"><a href="#éªŒè¯ks" class="headerlink" title="éªŒè¯ks"></a>éªŒè¯ks</h1><p>KSé»˜è®¤å¯¹å¤–å¼€æ”¾ 30880 ç«¯å£ï¼Œé€šè¿‡ NodePort (IP:30880) ä½¿ç”¨é»˜è®¤å¸æˆ·å’Œå¯†ç  (admin/P@88w0rd) è®¿é—® Web æ§åˆ¶å°ã€‚<br><a href="http://192.168.56.101:30880/login">http://192.168.56.101:30880/login</a><br>ç¬¬ä¸€æ¬¡ç™»å½•æ—¶ï¼Œä¼šæç¤ºä¿®æ”¹å¯†ç ã€‚</p><h1 id="ä¿®æ”¹ksé…ç½®"><a href="#ä¿®æ”¹ksé…ç½®" class="headerlink" title="ä¿®æ”¹ksé…ç½®"></a>ä¿®æ”¹ksé…ç½®</h1><p>å¦‚æœkså·²ç»å®‰è£…å®Œæˆï¼Œæƒ³è¦ä¿®æ”¹ksé›†ç¾¤é…ç½®çš„è¯ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹clusterconfigurationé…ç½®æ¥å®ç°ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cm kubesphere-config -n kubesphere-system -oyaml</span><br><span class="line">kubectl get clusterconfiguration ks-installer -n kubesphere-system -oyaml</span><br><span class="line">kubectl edit clusterconfiguration ks-installer -n kubesphere-system</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ks-installeré…ç½®åï¼Œç›¸å…³podä¼šè‡ªåŠ¨é‡å¯ï¼ˆè¯·è€å¿ƒç­‰å¾…ï¼Œå¤§æ¦‚5åˆ†é’Ÿå†…ä¼šè‡ªåŠ¨é‡å¯ï¼‰ã€‚</p><p>å‚è€ƒæ–‡æ¡£<a href="https://kubesphere.io/zh/docs/v3.3/access-control-and-account-management/external-authentication/use-an-ldap-service/">KubeSphere - LDAPèº«ä»½æä¾›è€…</a></p><h1 id="é‡ç½®kså¯†ç "><a href="#é‡ç½®kså¯†ç " class="headerlink" title="é‡ç½®kså¯†ç "></a>é‡ç½®kså¯†ç </h1><p>å¦‚æœå¿˜è®°äº†ksçš„å¯†ç ï¼Œå¯ä»¥é€šè¿‡kubectlå‘½ä»¤è¿›è¡Œé‡ç½®ã€‚å‚è€ƒæ–‡æ¡£<a href="https://kubesphere.io/docs/v3.3/faq/access-control/forgot-password/">Reset the Account Password</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch <span class="built_in">users</span> &lt;USERNAME&gt; -p <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;password&quot;:&quot;&lt;YOURPASSWORD&gt;&quot;&#125;&#125;&#x27;</span> --<span class="built_in">type</span>=<span class="string">&#x27;merge&#x27;</span> &amp;&amp; kubectl annotate <span class="built_in">users</span> &lt;USERNAME&gt; iam.kubesphere.io/password-encrypted-</span><br></pre></td></tr></table></figure><h1 id="nginxé…ç½®"><a href="#nginxé…ç½®" class="headerlink" title="nginxé…ç½®"></a>nginxé…ç½®</h1><p>é…ç½®å¥½nginxï¼Œé€šè¿‡åŸŸåè®¿é—®ksæ­£å¸¸ï¼Œä½†æ˜¯åœ¨ksé¡µé¢ä¸Šè®¿é—®å®¹å™¨ç»ˆç«¯æ—¶å¯èƒ½æŠ¥é”™ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Could not connect to the container. Do you have sufficient privileges?</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸ºé¡µé¢è®¿é—®ç»ˆç«¯éœ€è¦websocketæ”¯æŒï¼Œæ‰€ä»¥nginxé…ç½®ä¸­éœ€è¦æ·»åŠ websocketæ”¯æŒï¼Œé…ç½®æ–¹æ³•å‚è€ƒ<a href="https://www.voidking.com/dev-nginx-start/">ã€ŠNginxå…¥é—¨ç¯‡ã€‹</a>ã€‚</p><h1 id="æ·»åŠ é¡¹ç›®åˆ°ä¼ä¸šç©ºé—´"><a href="#æ·»åŠ é¡¹ç›®åˆ°ä¼ä¸šç©ºé—´" class="headerlink" title="æ·»åŠ é¡¹ç›®åˆ°ä¼ä¸šç©ºé—´"></a>æ·»åŠ é¡¹ç›®åˆ°ä¼ä¸šç©ºé—´</h1><p>Kuberneteså‘½åç©ºé—´å°±æ˜¯KubeSphereé¡¹ç›®ï¼Œè¿™äº›é¡¹ç›®å¯ä»¥åœ¨ å¹³å°ç®¡ç†-&gt;é›†ç¾¤ç®¡ç†-&gt;å…·ä½“é›†ç¾¤-&gt;é¡¹ç›® ä¸­æŸ¥çœ‹åˆ°ã€‚</p><p>æ·»åŠ ç°æœ‰KubeSphereé¡¹ç›®åˆ°ä¼ä¸šç©ºé—´ï¼š<br>1ã€ä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•KubeSphereæ§åˆ¶å°ï¼Œè½¬åˆ°é›†ç¾¤ç®¡ç†é¡µé¢ã€‚ç‚¹å‡»é¡¹ç›®ï¼Œå¯ä»¥æŸ¥çœ‹åœ¨å½“å‰é›†ç¾¤ä¸­è¿è¡Œçš„æ‰€æœ‰é¡¹ç›®ã€‚<br>2ã€é€šè¿‡ kubectl åˆ›å»ºçš„å‘½åç©ºé—´ä¸å±äºä»»ä½•ä¼ä¸šç©ºé—´ã€‚è¯·ç‚¹å‡»å³ä¾§çš„ä¸‰ä¸ªç‚¹ï¼Œé€‰æ‹©åˆ†é…ä¼ä¸šç©ºé—´ã€‚<br>3ã€åœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­ï¼Œä¸ºè¯¥é¡¹ç›®é€‰æ‹©ä¸€ä¸ªä¼ä¸šç©ºé—´å’Œé¡¹ç›®ç®¡ç†å‘˜ï¼Œç„¶åç‚¹å‡»ç¡®å®šã€‚<br>4ã€è½¬åˆ°ä¼ä¸šç©ºé—´ï¼Œå¯ä»¥åœ¨é¡¹ç›®é¡µé¢çœ‹åˆ°è¯¥é¡¹ç›®å·²æ˜¾ç¤ºã€‚</p><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://kubesphere.io/zh/docs/v3.3/faq/access-control/add-kubernetes-namespace-to-kubesphere-workspace/">æ·»åŠ ç°æœ‰ Kubernetes å‘½åç©ºé—´è‡³ KubeSphere ä¼ä¸šç©ºé—´</a></li></ul><h1 id="æ‰¹é‡æ·»åŠ é¡¹ç›®åˆ°ä¼ä¸šç©ºé—´"><a href="#æ‰¹é‡æ·»åŠ é¡¹ç›®åˆ°ä¼ä¸šç©ºé—´" class="headerlink" title="æ‰¹é‡æ·»åŠ é¡¹ç›®åˆ°ä¼ä¸šç©ºé—´"></a>æ‰¹é‡æ·»åŠ é¡¹ç›®åˆ°ä¼ä¸šç©ºé—´</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get ns |grep voidking | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | xargs kubectl patch ns -p <span class="string">&#x27;metadata: &#123;labels: &#123;kubesphere.io/workspace: &quot;voidking&quot;&#125;, annotations: &#123;kubesphere.io/creator: &quot;haojin&quot;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h1 id="kså¤šé›†ç¾¤"><a href="#kså¤šé›†ç¾¤" class="headerlink" title="kså¤šé›†ç¾¤"></a>kså¤šé›†ç¾¤</h1><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://blog.51cto.com/u_15127592/2803374">Kubernetes å¤šé›†ç¾¤åœ¨å¼€æºé¡¹ç›® KubeSphere çš„åº”ç”¨</a></li></ul><h1 id="å¤šç§Ÿæˆ·ç®¡ç†"><a href="#å¤šç§Ÿæˆ·ç®¡ç†" class="headerlink" title="å¤šç§Ÿæˆ·ç®¡ç†"></a>å¤šç§Ÿæˆ·ç®¡ç†</h1><h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><ul><li>é›†ç¾¤ï¼šk8sé›†ç¾¤ã€‚</li><li>ä¼ä¸šç©ºé—´ï¼šä¸šåŠ¡ç®¡ç†åŸºæœ¬å•å…ƒã€‚</li><li>å…¬å¸éƒ¨é—¨ï¼šå…¬å¸å†…éƒ¨çš„éƒ¨é—¨å’Œkséƒ¨é—¨æ²¡æœ‰å¿…ç„¶è”ç³»ã€‚</li><li>kséƒ¨é—¨ï¼šä¼ä¸šç©ºé—´ä¸­æƒé™åˆ’åˆ†çš„å•ä½ï¼Œæ¯ä¸ªä¼ä¸šç©ºé—´åŒ…å«å¤šä¸ªkséƒ¨é—¨ï¼Œæ¯ä¸ªkséƒ¨é—¨åŒ…å«å¤šä¸ªç”¨æˆ·ï¼Œæ–¹ä¾¿æ‰¹é‡æˆæƒã€‚</li><li>ksç”¨æˆ·ï¼šæ¯ä¸ªå…¬å¸æˆå‘˜ï¼Œå¯¹åº”ä¸€ä¸ªksç”¨æˆ·ï¼Œä¸€ä¸ªksç”¨æˆ·å¯ä»¥å±äºå¤šä¸ªkséƒ¨é—¨ã€‚</li><li>é¡¹ç›®ï¼šé¡¹ç›®å¯¹åº”k8sä¸­çš„namespaceï¼Œä¸€ä¸ªé¡¹ç›®å¯ä»¥åŒæ—¶åˆ†é…ç»™ä¸åŒçš„kséƒ¨é—¨ã€‚</li></ul><p>é›†ç¾¤å’Œä¼ä¸šç©ºé—´ï¼Œæ˜¯å¤šå¯¹å¤šçš„å…³ç³»ã€‚ä¸€ä¸ªä¼ä¸šç©ºé—´å¯ä»¥åŒ…å«å¤šä¸ªé›†ç¾¤ï¼Œä¸€ä¸ªé›†ç¾¤å¯ä»¥è¢«å¤šä¸ªä¼ä¸šç©ºé—´åŒ…å«ã€‚</p><p>ksä¸­æ¯ä¸ªé¡¹ç›®åªèƒ½æ·»åŠ åˆ°ä¸€ä¸ªä¼ä¸šç©ºé—´ï¼Œå› æ­¤ä¼ä¸šç©ºé—´æŒ‰ç…§ä¸šåŠ¡æ¥åˆ’åˆ†ï¼Œä½œä¸ºä¸šåŠ¡ç®¡ç†çš„åŸºæœ¬å•ä½ã€‚</p><p>ä¼ä¸šç©ºé—´ä½œä¸ºæ“ä½œkubesphereçš„å”¯ä¸€å…¥å£ï¼Œåœ¨ä¼ä¸šç©ºé—´æˆæƒä¸€ä¸ªé¡¹ç›®çš„ç®¡ç†æƒé™åï¼Œå¦‚æœç”¨æˆ·é€šè¿‡é›†ç¾¤ç®¡ç†æ‰¾åˆ°ä¸€ä¸ªé¡¹ç›®ï¼Œæ˜¯æ²¡æœ‰æƒé™çš„ã€‚</p><p>æ¯ä¸ªä¼ä¸šç©ºé—´ï¼Œå»ºè®®è®¾ç½®1-3ä¸ªç®¡ç†å‘˜ã€‚ç®¡ç†å‘˜è´Ÿè´£æœ¬ä¼ä¸šç©ºé—´çš„å…·ä½“æƒé™ç®¡ç†ï¼Œä¾‹å¦‚æ·»åŠ ç®¡ç†å‘˜ã€æ–°å»ºéƒ¨é—¨ã€ç»™æ–°æˆå‘˜æˆæƒç­‰</p><p>kséƒ¨é—¨åˆ’åˆ†çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†é¡¹ç›®çš„æƒé™ç®¡ç†ï¼Œå› æ­¤éœ€è¦å…ˆå¯¹é›†ç¾¤å’Œé¡¹ç›®æƒé™è¿›è¡Œè§„åˆ’ã€‚<br>é€šè¿‡kséƒ¨é—¨ï¼Œæˆæƒå¯ä»¥ç²¾ç¡®åˆ°æ¯ä¸ªé¡¹ç›®å’Œæ¯ä¸ªäººã€‚</p><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://kubesphere.io/zh/docs/v3.3/access-control-and-account-management/multi-tenancy-in-kubesphere/">KubeSphere ä¸­çš„å¤šç§Ÿæˆ·</a></li><li><a href="https://kubesphere.io/zh/docs/v3.3/faq/access-control/add-kubernetes-namespace-to-kubesphere-workspace/">æ·»åŠ ç°æœ‰ Kubernetes å‘½åç©ºé—´è‡³ KubeSphere ä¼ä¸šç©ºé—´</a></li></ul><h2 id="å¤šç§Ÿæˆ·ç®¡ç†æ“ä½œæµç¨‹"><a href="#å¤šç§Ÿæˆ·ç®¡ç†æ“ä½œæµç¨‹" class="headerlink" title="å¤šç§Ÿæˆ·ç®¡ç†æ“ä½œæµç¨‹"></a>å¤šç§Ÿæˆ·ç®¡ç†æ“ä½œæµç¨‹</h2><p>1ã€åˆ›å»ºä¼ä¸šç©ºé—´ï¼Œå¹¶å…³è”é›†ç¾¤</p><p>2ã€æ·»åŠ ç°æœ‰é¡¹ç›®åˆ°ä¼ä¸šç©ºé—´</p><p>3ã€åˆ›å»ºéƒ¨é—¨ï¼Œé’ˆå¯¹éƒ¨é—¨ç²¾ç»†åŒ–æˆæƒ</p><p>4ã€æ·»åŠ ç”¨æˆ·åˆ°éƒ¨é—¨</p><p>5ã€é€šçŸ¥kså…¥å£éƒ½ä½¿ç”¨ä¼ä¸šç©ºé—´ï¼Œä¸è¦ä½¿ç”¨é›†ç¾¤ç®¡ç†</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;KubeSphereç®€ä»‹&quot;&gt;&lt;a href=&quot;#KubeSphereç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;KubeSphereç®€ä»‹&quot;&gt;&lt;/a&gt;KubeSphereç®€ä»‹&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;KubeSphere æ„¿æ™¯æ˜¯æ‰“é€ ä¸€ä¸ªä»¥ Kubernetes ä¸ºå†…æ ¸çš„äº‘åŸç”Ÿåˆ†å¸ƒå¼æ“ä½œç³»ç»Ÿï¼Œå®ƒçš„æ¶æ„å¯ä»¥éå¸¸æ–¹ä¾¿åœ°ä½¿ç¬¬ä¸‰æ–¹åº”ç”¨ä¸äº‘åŸç”Ÿç”Ÿæ€ç»„ä»¶è¿›è¡Œå³æ’å³ç”¨ï¼ˆplug-and-playï¼‰çš„é›†æˆï¼Œæ”¯æŒäº‘åŸç”Ÿåº”ç”¨åœ¨å¤šäº‘ä¸å¤šé›†ç¾¤çš„ç»Ÿä¸€åˆ†å‘å’Œè¿ç»´ç®¡ç†ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ç®€å•æ¥è¯´ï¼ŒKubeSphereï¼ˆä¸‹æ–‡ç®€ç§°ksï¼‰å°±æ˜¯ä¸€ä¸ªå®¹å™¨ç®¡ç†å¹³å°ï¼Œå¯ä»¥å›¾å½¢åŒ–ç®¡ç†å¤šä¸ªK8Sé›†ç¾¤ã€‚&lt;/p&gt;
&lt;p&gt;ç›¸å…³é“¾æ¥ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://kubesphere.io/zh/&quot;&gt;KubeSphereå®˜ç½‘&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://kubesphere.io/zh/videos/&quot;&gt;KubeSphereå­¦ä¹ è§†é¢‘&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="engineering" scheme="https://www.voidking.com/categories/engineering/"/>
    
    <category term="k8s" scheme="https://www.voidking.com/categories/engineering/k8s/"/>
    
    <category term="cloudnative" scheme="https://www.voidking.com/categories/engineering/cloudnative/"/>
    
    <category term="troubleshooting" scheme="https://www.voidking.com/categories/engineering/troubleshooting/"/>
    
    <category term="storage" scheme="https://www.voidking.com/categories/engineering/storage/"/>
    
    
    <category term="k8s" scheme="https://www.voidking.com/tags/k8s/"/>
    
    <category term="é—®é¢˜æ’æŸ¥" scheme="https://www.voidking.com/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"/>
    
    <category term="å­˜å‚¨" scheme="https://www.voidking.com/tags/%E5%AD%98%E5%82%A8/"/>
    
    <category term="kubesphere" scheme="https://www.voidking.com/tags/kubesphere/"/>
    
    <category term="storageclass" scheme="https://www.voidking.com/tags/storageclass/"/>
    
  </entry>
  
  <entry>
    <title>KubeSphereç™»å½•åæŠ¥é”™Session Timeout</title>
    <link href="https://www.voidking.com/dev-kubesphere-session-timeout/"/>
    <id>https://www.voidking.com/dev-kubesphere-session-timeout/</id>
    <published>2022-10-10T15:00:00.000Z</published>
    <updated>2022-11-02T11:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h1><p>å¤§éƒ¨åˆ†ç”¨æˆ·èƒ½å¤Ÿæ­£å¸¸ç™»å½•å’Œä½¿ç”¨ksï¼Œä½†æ˜¯ä¸ªåˆ«ç”¨æˆ·ï¼ˆvoidking01ï¼‰ç™»å½•ksåæŠ¥é”™ã€‚<br>ç”¨æˆ·ç™»å½•ksï¼Œæ­£å¸¸ï¼›ç™»å½•åæŸ¥çœ‹å·¥ä½œå°ï¼Œæ­£å¸¸ï¼›æŸ¥çœ‹hosté›†ç¾¤å’ŒåªåŒ…å«hosté›†ç¾¤çš„ä¼ä¸šç©ºé—´ï¼Œæ­£å¸¸ã€‚</p><p>ä½†æ˜¯ï¼Œé€‰æ‹©ä¸€ä¸ªéhosté›†ç¾¤æˆ–è€…é€‰æ‹©ä¸€ä¸ªåŒ…å«éhosté›†ç¾¤çš„ä¼ä¸šç©ºé—´åï¼Œé¡µé¢å°±ä¼šå¼¹å‡ºé”™è¯¯æç¤ºï¼š<br>Session timeout or this account is logged in elsewhere, please login again</p><p>ç„¶åè½¬åˆ°ç™»å½•é¡µé¢ï¼Œå†æ¬¡ç™»å½•ï¼Œç»§ç»­å¼¹å‡ºä¸Šé¢çš„é”™è¯¯æç¤ºã€‚å¾ªç¯å¾€å¤ã€‚</p><span id="more"></span><h1 id="æƒé™é—®é¢˜ï¼Ÿ"><a href="#æƒé™é—®é¢˜ï¼Ÿ" class="headerlink" title="æƒé™é—®é¢˜ï¼Ÿ"></a>æƒé™é—®é¢˜ï¼Ÿ</h1><p>æ›´æ”¹ç”¨æˆ·æƒé™ä¸ºadminï¼Œé—®é¢˜ä¾æ—§ã€‚</p><p>é‡æ–°ç»™ç”¨æˆ·æˆæƒï¼Œé—®é¢˜ä¾æ—§ã€‚</p><h1 id="ksç‰ˆæœ¬é—®é¢˜ï¼Ÿ"><a href="#ksç‰ˆæœ¬é—®é¢˜ï¼Ÿ" class="headerlink" title="ksç‰ˆæœ¬é—®é¢˜ï¼Ÿ"></a>ksç‰ˆæœ¬é—®é¢˜ï¼Ÿ</h1><p>ksç‰ˆæœ¬ä»3.2.1å‡çº§åˆ°äº†3.3.1ï¼Œé—®é¢˜ä¾æ—§ã€‚</p><h1 id="kube-eventsç»„ä»¶é—®é¢˜ï¼Ÿ"><a href="#kube-eventsç»„ä»¶é—®é¢˜ï¼Ÿ" class="headerlink" title="kube-eventsç»„ä»¶é—®é¢˜ï¼Ÿ"></a>kube-eventsç»„ä»¶é—®é¢˜ï¼Ÿ</h1><p>å‚è€ƒæ–‡æ¡£<a href="https://kubesphere.com.cn/forum/d/1501">ç™»å½•æˆåŠŸåï¼Œæ€»æ˜¯æç¤ºä¼šè¯è¶…æ—¶æˆ–æ­¤è´¦æˆ·åœ¨å…¶ä»–ç™»å½•åœ°æ–¹ç™»å½•ï¼Œè¯·é‡æ–°ç™»å½•</a></p><p>ç»æ£€æŸ¥ï¼Œå¹¶æ²¡æœ‰kube-eventså¤±è´¥æ—¥å¿—ï¼Œä¸æ˜¯å®ƒçš„é—®é¢˜ã€‚</p><h1 id="ksé…ç½®é—®é¢˜ï¼Ÿ"><a href="#ksé…ç½®é—®é¢˜ï¼Ÿ" class="headerlink" title="ksé…ç½®é—®é¢˜ï¼Ÿ"></a>ksé…ç½®é—®é¢˜ï¼Ÿ</h1><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://kubesphere.io/docs/v3.3/faq/access-control/session-timeout/">Session Timeout</a></li><li><a href="https://kubesphere.io/docs/v3.3/access-control-and-account-management/external-authentication/set-up-external-authentication/">Set Up External Authentication</a></li></ul><p>é˜…è¯»ksæ–‡æ¡£ï¼Œæ€€ç–‘æ˜¯ksé…ç½®ä¸å¯¹å¼•èµ·çš„ã€‚é‚£å°±æŒ‰ç…§å®˜æ–¹æ–‡æ¡£é‡æ–°é…ç½®ä¸€ä¸‹è¯•è¯•ã€‚</p><h2 id="hosté›†ç¾¤"><a href="#hosté›†ç¾¤" class="headerlink" title="hosté›†ç¾¤"></a>hosté›†ç¾¤</h2><p>1ã€ç¼–è¾‘ks-installeré…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubesphere-system edit cc ks-installer</span><br></pre></td></tr></table></figure><p>2ã€ä¿®æ”¹authenticationéƒ¨åˆ†é…ç½®</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">authentication:</span></span><br><span class="line">    <span class="attr">jwtSecret:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">authenticateRateLimiterMaxTries:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">authenticateRateLimiterDuration:</span> <span class="string">10m0s</span></span><br><span class="line">    <span class="attr">loginHistoryRetentionPeriod:</span> <span class="string">168h</span></span><br><span class="line">    <span class="attr">maximumClockSkew:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">multipleLogin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">oauthOptions:</span></span><br><span class="line">      <span class="attr">accessTokenMaxAge:</span> <span class="string">1h</span></span><br><span class="line">      <span class="attr">accessTokenInactivityTimeout:</span> <span class="string">30m</span></span><br><span class="line">      <span class="attr">identityProviders:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LDAP</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">LDAPIdentityProvider</span></span><br><span class="line">        <span class="attr">mappingMethod:</span> <span class="string">auto</span></span><br><span class="line">        <span class="attr">provider:</span></span><br><span class="line">          <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.2</span><span class="string">:389</span></span><br><span class="line">          <span class="attr">managerDN:</span> <span class="string">uid=root,cn=users,dc=nas</span></span><br><span class="line">          <span class="attr">managerPassword:</span> <span class="string">********</span></span><br><span class="line">          <span class="attr">userSearchBase:</span> <span class="string">cn=users,dc=nas</span></span><br><span class="line">          <span class="attr">loginAttribute:</span> <span class="string">uid</span></span><br><span class="line">          <span class="attr">mailAttribute:</span> <span class="string">mail</span></span><br></pre></td></tr></table></figure><h2 id="memberé›†ç¾¤"><a href="#memberé›†ç¾¤" class="headerlink" title="memberé›†ç¾¤"></a>memberé›†ç¾¤</h2><p>memberé›†ç¾¤åªè¦é…ç½®<code>jwtSecret</code>å³å¯ï¼Œå’Œhosté›†ç¾¤ä¿æŒä¸€è‡´ã€‚è¯¦æƒ…å‚è€ƒ<a href="https://kubesphere.io/docs/v3.3/multicluster-management/enable-multicluster/direct-connection/">Direct Connection</a></p><p>ä¿®æ”¹å®Œæˆï¼Œks podé‡å»ºåï¼Œé—®é¢˜ä¾æ—§ã€‚</p><h1 id="åˆ é™¤ç”¨æˆ·é‡å»ºï¼Ÿ"><a href="#åˆ é™¤ç”¨æˆ·é‡å»ºï¼Ÿ" class="headerlink" title="åˆ é™¤ç”¨æˆ·é‡å»ºï¼Ÿ"></a>åˆ é™¤ç”¨æˆ·é‡å»ºï¼Ÿ</h1><p>åˆ é™¤ç”¨æˆ·ï¼Œç”¨æˆ·é‡æ–°ç™»å½•ï¼Œé‡æ–°æˆæƒï¼Œé—®é¢˜ä¾æ—§ã€‚</p><h1 id="æ—¶é’Ÿé—®é¢˜ï¼Ÿ"><a href="#æ—¶é’Ÿé—®é¢˜ï¼Ÿ" class="headerlink" title="æ—¶é’Ÿé—®é¢˜ï¼Ÿ"></a>æ—¶é’Ÿé—®é¢˜ï¼Ÿ</h1><p>å‚è€ƒ<a href="https://kubesphere.io/docs/v3.3/faq/access-control/session-timeout/">Session Timeout</a>æ–‡æ¡£ï¼Œè¿˜æœ‰ä¸€ç§å¯èƒ½æ˜¯èŠ‚ç‚¹æ—¶é’Ÿåå·®ã€‚</p><blockquote><p>The node clock skew affects time-sensitive operations such as validating the expiration time of a user token. You can configure the server time synchronization with an NTP server. MaximumClockSkew can also be set, which defaults to 10 seconds.</p></blockquote><p>åˆ†åˆ«ç™»å½•hosté›†ç¾¤å’Œmemberé›†ç¾¤çš„apiserver podï¼Œæ‰§è¡Œ<code>date</code>å‘½ä»¤æŸ¥çœ‹æ—¶é—´ã€‚<br>å‘ç°ä¸åŒé›†ç¾¤çš„æ—¶åŒºé…ç½®ä¸åŒï¼Œå•Šå“ˆï¼Œå¤§æ¦‚ç‡æ˜¯è¿™ä¸ªé—®é¢˜äº†ï¼ï¼ï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br></pre></td></tr></table></figure><p>ç»Ÿä¸€æ‰€æœ‰é›†ç¾¤èŠ‚ç‚¹æ—¶åŒºä¸º<code>Asia/Shanghai</code>ï¼Œç„¶åé‡å»ºks podã€‚é—®é¢˜ä¾æ—§ã€‚</p><p>æŠŠ<code>maximumClockSkew</code>ä¹Ÿè°ƒå¤§ä¸€äº›ï¼Œé»˜è®¤10sï¼Œè°ƒæ•´åˆ°60sè¯•è¯•ã€‚é—®é¢˜ä¾æ—§ã€‚</p><h1 id="æŸ¥çœ‹æ—¥å¿—"><a href="#æŸ¥çœ‹æ—¥å¿—" class="headerlink" title="æŸ¥çœ‹æ—¥å¿—"></a>æŸ¥çœ‹æ—¥å¿—</h1><p>å‚è€ƒæ–‡æ¡£<a href="https://kubesphere.com.cn/docs/v3.3/faq/multi-cluster-management/host-cluster-access-member-cluster/">æ¢å¤ä¸»é›†ç¾¤å¯¹æˆå‘˜é›†ç¾¤çš„è®¿é—®æƒé™</a>ï¼ŒæŸ¥çœ‹memberé›†ç¾¤çš„api-serveræ—¥å¿—ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubesphere-system logs ks-apiserver-7c9c9456bd-qv6bs</span><br></pre></td></tr></table></figure><p>å‡ºç°æŠ¥é”™ä¿¡æ¯ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">W1104 11:13:28.432457       1 clusterroles.go:117] invalid aggregation role found: cluster-admin, role-template-manage-configmaps</span><br><span class="line">W1104 11:13:28.432464       1 clusterroles.go:117] invalid aggregation role found: cluster-admin, role-template-view-secrets</span><br><span class="line">W1104 11:13:28.432469       1 clusterroles.go:117] invalid aggregation role found: cluster-admin, role-template-manage-secrets</span><br><span class="line">W1104 11:13:28.432475       1 clusterroles.go:117] invalid aggregation role found: cluster-admin, role-template-view-service-accounts</span><br><span class="line">W1104 11:13:28.432484       1 clusterroles.go:117] invalid aggregation role found: cluster-admin, role-template-manage-service-accounts</span><br><span class="line">E1104 11:13:51.879574       1 upgradeaware.go:401] Error proxying data from backend to client: readfrom tcp 10.244.161.166:9090-&gt;192.168.50.74:34540: write tcp 10.244.161.166:9090-&gt;192.168.50.74:34540: write: connection reset by peer</span><br></pre></td></tr></table></figure><p>é¡ºç€è¿™ä¸ªæ—¥å¿—ï¼Œåœ¨kubesphereç¤¾åŒºæ‰¾åˆ°äº†ä¸€ä¸ªç›¸åŒçš„é—®é¢˜<a href="https://kubesphere.com.cn/forum/d/7394-kubesphere-member">kubesphereä½¿ç”¨å­è´¦æˆ·â€¦ä¼šè·³è½¬åˆ°ç™»å½•ç•Œé¢</a></p><blockquote><p>çœ‹èµ·æ¥æ˜¯å¤šé›†ç¾¤åŒæ­¥å‡ºé—®é¢˜äº†ï¼Œçœ‹ä¸‹ host é›†ç¾¤ kube-federation-system è¿™ä¸ª namespace ä¸‹çš„ pod æ˜¯å¦éƒ½æ­£å¸¸</p></blockquote><p>æ ¹æ®è®ºå›å¤§ä½¬çš„æç¤ºï¼Œæ£€æŸ¥kube-federation-system è¿™ä¸ª namespace ä¸‹çš„podä¿¡æ¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n kube-federation-system</span><br><span class="line">kubectl logs --<span class="built_in">tail</span>=100 kubefed-admission-webhook-657959d4d6-2sx5f -n kube-federation-system</span><br><span class="line">kubectl logs --<span class="built_in">tail</span>=100 kubefed-controller-manager-54fbd87f7f-6t7jq -n kube-federation-system</span><br><span class="line">kubectl logs --<span class="built_in">tail</span>=100 kubefed-controller-manager-54fbd87f7f-fh9pk -n kube-federation-system</span><br></pre></td></tr></table></figure><p>çœ‹ç€ä¹Ÿæ²¡æœ‰ä»€ä¹ˆæ˜æ˜¾çš„æŠ¥é”™ä¿¡æ¯ã€‚</p><p>æ ¹æ®è®ºå›çš„æç¤ºï¼Œæœ‰ä¸¤ä¸ªè§£å†³åŠæ³•ï¼šä¸€ä¸ªæ˜¯æ›¿æ¢kubeconfigï¼Œä¸€ä¸ªæ˜¯å‡çº§kubefed controllerã€‚</p><ul><li><a href="https://github.com/kubesphere/kubesphere/issues/4891">Update the version of kubefed controller </a></li><li><a href="https://github.com/kubernetes-sigs/kubefed/pull/1505">fix: controller-manager panic when kubeconfig set filed insecure-skip-tls-verify</a></li></ul><p>è¿™é‡Œæˆ‘ä»¬é€‰æ‹©å‡çº§kubefed controllerã€‚</p><h1 id="å‡çº§kubefed-controller"><a href="#å‡çº§kubefed-controller" class="headerlink" title="å‡çº§kubefed controller"></a>å‡çº§kubefed controller</h1><p>1ã€æŸ¥çœ‹å½“å‰kubefed controllerç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deployment.apps/kubefed-controller-manager -n kube-federation-system -oyaml| grep image</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹åˆ°å½“å‰ç‰ˆæœ¬v0.8.1</p><p>2ã€æŸ¥çœ‹kubefed controlleræœ€æ–°ç‰ˆæœ¬<br>è®¿é—®<a href="https://hub.docker.com/r/kubesphere/kubefed/tags">dockerhub - kubesphere/kubefed</a><br>æ‰¾åˆ°å½“å‰æœ€æ–°ç‰ˆæœ¬ï¼Œä¹Ÿæ˜¯v0.8.1</p><p>è«éä¸æ˜¯ç‰ˆæœ¬é—®é¢˜ï¼Ÿå†å¯¹æ¯”æœ¬åœ°é•œåƒå’Œçº¿ä¸Šé•œåƒçš„DIGESTï¼Œå‘ç°å®ƒä»¬æ˜¯ä¸åŒçš„ã€‚çœ‹æ¥æ˜¯ä¿®å¤bugåï¼Œä½¿ç”¨äº†åŸæ¥çš„é•œåƒtagã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect kubesphere/kubefed:v0.8.1 | grep -i <span class="built_in">id</span></span><br></pre></td></tr></table></figure><p>3ã€ç¼©å®¹kubefed controller</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale --replicas=0 deployment.apps/kubefed-controller-manager -n kube-federation-system</span><br></pre></td></tr></table></figure><p>4ã€åˆ é™¤å®¿ä¸»æœºæœ¬åœ°é•œåƒ&amp;æ‹‰å–æœ€æ–°é•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker rmi kubesphere/kubefed:v0.8.1 </span><br><span class="line">docker pull kubesphere/kubefed:v0.8.1</span><br></pre></td></tr></table></figure><p>5ã€é‡æ–°æ‹‰èµ·kubefed controller</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale --replicas=1 deployment.apps/kubefed-controller-manager -n kube-federation-system</span><br></pre></td></tr></table></figure><p>é—®é¢˜ä¾æ—§ã€‚ã€‚ã€‚</p><h1 id="åºŸå¼ƒé›†ç¾¤çš„é—®é¢˜ï¼Ÿ"><a href="#åºŸå¼ƒé›†ç¾¤çš„é—®é¢˜ï¼Ÿ" class="headerlink" title="åºŸå¼ƒé›†ç¾¤çš„é—®é¢˜ï¼Ÿ"></a>åºŸå¼ƒé›†ç¾¤çš„é—®é¢˜ï¼Ÿ</h1><p>å†æ¬¡æŸ¥çœ‹kubefed-controller-managerçš„æ—¥å¿—ï¼Œæ„Ÿè§‰åƒæ˜¯åºŸå¼ƒé›†ç¾¤å¼•èµ·çš„é—®é¢˜ã€‚</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">E1104 08:10:15.107249       1 controller.go:512] failed to delete FederatedGlobalRoleBinding &quot;voidking01-platform-regular&quot;: the following clusters were not ready: vk-dev, edge-cluster</span><br><span class="line">I1104 08:10:15.702028       1 controller.go:471] Ensuring deletion of FederatedGlobalRoleBinding &quot;voidking01-platform-admin&quot;</span><br><span class="line">I1104 08:10:15.702064       1 controller.go:500] Deserializing delete options of FederatedGlobalRoleBinding &quot;voidking01-platform-admin&quot;</span><br><span class="line">I1104 08:10:15.702072       1 controller.go:508] Deleting resources managed by FederatedGlobalRoleBinding &quot;voidking01-platform-admin&quot; from member clusters.</span><br><span class="line">E1104 08:10:15.702117       1 controller.go:512] failed to delete FederatedGlobalRoleBinding &quot;voidking01-platform-admin&quot;: the following clusters were not ready: vk-dev, edge-cluster</span><br></pre></td></tr></table></figure><p>åˆ é™¤åºŸå¼ƒçš„é›†ç¾¤åï¼ˆæœªå°±ç»ªçš„é›†ç¾¤ï¼‰ï¼Œé—®é¢˜è§£å†³ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;é—®é¢˜æè¿°&quot;&gt;&lt;a href=&quot;#é—®é¢˜æè¿°&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜æè¿°&quot;&gt;&lt;/a&gt;é—®é¢˜æè¿°&lt;/h1&gt;&lt;p&gt;å¤§éƒ¨åˆ†ç”¨æˆ·èƒ½å¤Ÿæ­£å¸¸ç™»å½•å’Œä½¿ç”¨ksï¼Œä½†æ˜¯ä¸ªåˆ«ç”¨æˆ·ï¼ˆvoidking01ï¼‰ç™»å½•ksåæŠ¥é”™ã€‚&lt;br&gt;ç”¨æˆ·ç™»å½•ksï¼Œæ­£å¸¸ï¼›ç™»å½•åæŸ¥çœ‹å·¥ä½œå°ï¼Œæ­£å¸¸ï¼›æŸ¥çœ‹hosté›†ç¾¤å’ŒåªåŒ…å«hosté›†ç¾¤çš„ä¼ä¸šç©ºé—´ï¼Œæ­£å¸¸ã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯ï¼Œé€‰æ‹©ä¸€ä¸ªéhosté›†ç¾¤æˆ–è€…é€‰æ‹©ä¸€ä¸ªåŒ…å«éhosté›†ç¾¤çš„ä¼ä¸šç©ºé—´åï¼Œé¡µé¢å°±ä¼šå¼¹å‡ºé”™è¯¯æç¤ºï¼š&lt;br&gt;Session timeout or this account is logged in elsewhere, please login again&lt;/p&gt;
&lt;p&gt;ç„¶åè½¬åˆ°ç™»å½•é¡µé¢ï¼Œå†æ¬¡ç™»å½•ï¼Œç»§ç»­å¼¹å‡ºä¸Šé¢çš„é”™è¯¯æç¤ºã€‚å¾ªç¯å¾€å¤ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="engineering" scheme="https://www.voidking.com/categories/engineering/"/>
    
    <category term="k8s" scheme="https://www.voidking.com/categories/engineering/k8s/"/>
    
    <category term="cloudnative" scheme="https://www.voidking.com/categories/engineering/cloudnative/"/>
    
    <category term="troubleshooting" scheme="https://www.voidking.com/categories/engineering/troubleshooting/"/>
    
    <category term="storage" scheme="https://www.voidking.com/categories/engineering/storage/"/>
    
    
    <category term="k8s" scheme="https://www.voidking.com/tags/k8s/"/>
    
    <category term="é—®é¢˜æ’æŸ¥" scheme="https://www.voidking.com/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"/>
    
    <category term="å­˜å‚¨" scheme="https://www.voidking.com/tags/%E5%AD%98%E5%82%A8/"/>
    
    <category term="kubesphere" scheme="https://www.voidking.com/tags/kubesphere/"/>
    
    <category term="storageclass" scheme="https://www.voidking.com/tags/storageclass/"/>
    
  </entry>
  
  <entry>
    <title>K8Sé›†ç¾¤ä¸­å˜æ›´æ•°æ®å­˜å‚¨è·¯å¾„</title>
    <link href="https://www.voidking.com/dev-change-data-dir-in-k8s/"/>
    <id>https://www.voidking.com/dev-change-data-dir-in-k8s/</id>
    <published>2022-10-09T20:00:00.000Z</published>
    <updated>2022-11-01T10:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="éœ€æ±‚æè¿°"><a href="#éœ€æ±‚æè¿°" class="headerlink" title="éœ€æ±‚æè¿°"></a>éœ€æ±‚æè¿°</h1><p>dockerçš„é»˜è®¤å·¥ä½œç›®å½•æ˜¯<code>/var/lib/docker</code>ï¼Œä¼šå­˜æ”¾é•œåƒæ–‡ä»¶ã€å®¹å™¨æ—¥å¿—å’Œå†™å…¥åˆ°å®¹å™¨ä¸´æ—¶ç›®å½•çš„æ–‡ä»¶ç­‰ï¼Œé»˜è®¤æŒ‚è½½åœ¨ç³»ç»Ÿç›˜ã€‚</p><p>kubeletçš„é»˜è®¤å·¥ä½œç›®å½•æ˜¯<code>/var/lib/kubelet</code>ï¼Œä¼šå­˜æ”¾volumeæ–‡ä»¶ï¼ˆåŒ…æ‹¬emptyDir volume)ã€pluginæ–‡ä»¶ç­‰ï¼Œä¹Ÿæ˜¯é»˜è®¤æŒ‚è½½åœ¨ç³»ç»Ÿç›˜ã€‚</p><p>ä½¿ç”¨kubeadmå®‰è£…çš„etcdï¼Œé»˜è®¤æ•°æ®ç›®å½•æ˜¯<code>/var/lib/etcd</code>ï¼Œä¹Ÿæ˜¯é»˜è®¤æŒ‚è½½åœ¨ç³»ç»Ÿç›˜ã€‚</p><p>è€Œç³»ç»Ÿç›˜ä¸€èˆ¬éƒ½ä¸ä¼šå¤ªå¤§ï¼Œå› æ­¤æœ€å¥½æŠŠdockerå·¥ä½œç›®å½•ã€kubeletå·¥ä½œç›®å½•å’Œetcdæ•°æ®ç›®å½•æ›´æ”¹åˆ°æ•°æ®ç›˜ã€‚</p><span id="more"></span><h1 id="æ“ä½œæ€è·¯"><a href="#æ“ä½œæ€è·¯" class="headerlink" title="æ“ä½œæ€è·¯"></a>æ“ä½œæ€è·¯</h1><p>èŠ‚ç‚¹åˆ†ä¸ºä¸¤ç±»ï¼ŒmasterèŠ‚ç‚¹ï¼ˆå¤šä¸ªèŠ‚ç‚¹ï¼‰å’ŒworkerèŠ‚ç‚¹ï¼ˆå¤šä¸ªèŠ‚ç‚¹ï¼‰ã€‚</p><p>å•ä¸ªmasterèŠ‚ç‚¹æ“ä½œæµç¨‹ï¼š<br>1ã€master-xç¦æ­¢è°ƒåº¦ã€é©±é€pod<br>2ã€master-xæ“ä½œä¿®æ”¹dockerå·¥ä½œç›®å½•ã€kubeletå·¥ä½œç›®å½•<br>3ã€master-xå¼€æ”¾è°ƒåº¦<br>4ã€master-xæ“ä½œä¿®æ”¹etcdæ•°æ®ç›®å½•</p><p>å•ä¸ªworkerèŠ‚ç‚¹æ“ä½œæµç¨‹ï¼š<br>1ã€worker-xç¦æ­¢è°ƒåº¦ã€é©±é€pod<br>2ã€worker-xæ“ä½œä¿®æ”¹dockerå·¥ä½œç›®å½•ã€kubeletå·¥ä½œç›®å½•<br>3ã€worker-xå¼€æ”¾è°ƒåº¦</p><p>masterèŠ‚ç‚¹æŒ¨ä¸ªæ“ä½œï¼ŒworkerèŠ‚ç‚¹æŒ¨ä¸ªæ“ä½œæˆ–è€…åˆ†æ‰¹æ“ä½œã€‚</p><h1 id="masterèŠ‚ç‚¹æ“ä½œ"><a href="#masterèŠ‚ç‚¹æ“ä½œ" class="headerlink" title="masterèŠ‚ç‚¹æ“ä½œ"></a>masterèŠ‚ç‚¹æ“ä½œ</h1><p>ä»¥master-0ä¸ºä¾‹ï¼Œæ–¹ä¾¿è¿›è¡Œæè¿°ã€‚</p><h2 id="ç¦æ­¢è°ƒåº¦-amp-é©±é€pod"><a href="#ç¦æ­¢è°ƒåº¦-amp-é©±é€pod" class="headerlink" title="ç¦æ­¢è°ƒåº¦&amp;é©±é€pod"></a>ç¦æ­¢è°ƒåº¦&amp;é©±é€pod</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl drain master-0 --ignore-daemonsets</span><br></pre></td></tr></table></figure><p>é©±é€master-0èŠ‚ç‚¹ä¸Šçš„podï¼Œé™„å¸¦æ•ˆæœç¦æ­¢è°ƒåº¦ã€‚</p><h2 id="ä¿®æ”¹dockerå·¥ä½œç›®å½•"><a href="#ä¿®æ”¹dockerå·¥ä½œç›®å½•" class="headerlink" title="ä¿®æ”¹dockerå·¥ä½œç›®å½•"></a>ä¿®æ”¹dockerå·¥ä½œç›®å½•</h2><p>è¯¦æƒ…å‚è€ƒ <a href="https://www.voidking.com/dev-docker-data-root/">ã€ŠDockerä¿®æ”¹å·¥ä½œç›®å½•ã€‹</a></p><h2 id="ä¿®æ”¹kubeletå·¥ä½œç›®å½•"><a href="#ä¿®æ”¹kubeletå·¥ä½œç›®å½•" class="headerlink" title="ä¿®æ”¹kubeletå·¥ä½œç›®å½•"></a>ä¿®æ”¹kubeletå·¥ä½œç›®å½•</h2><p>è¯¦æƒ…å‚è€ƒ <a href="https://www.voidking.com/dev-kubelet-root-dir/">ã€Škubeletä¿®æ”¹å·¥ä½œç›®å½•ã€‹</a></p><h2 id="å¼€æ”¾è°ƒåº¦"><a href="#å¼€æ”¾è°ƒåº¦" class="headerlink" title="å¼€æ”¾è°ƒåº¦"></a>å¼€æ”¾è°ƒåº¦</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl uncordon master-0</span><br></pre></td></tr></table></figure><h2 id="å•ä¸ªèŠ‚ç‚¹ä¿®æ”¹etcdæ•°æ®ç›®å½•"><a href="#å•ä¸ªèŠ‚ç‚¹ä¿®æ”¹etcdæ•°æ®ç›®å½•" class="headerlink" title="å•ä¸ªèŠ‚ç‚¹ä¿®æ”¹etcdæ•°æ®ç›®å½•"></a>å•ä¸ªèŠ‚ç‚¹ä¿®æ”¹etcdæ•°æ®ç›®å½•</h2><p>è¯¦æƒ…å‚è€ƒ <a href="https://www.voidking.com/dev-etcd-data-dir/">ã€Šetcdä¿®æ”¹æ•°æ®ç›®å½•ã€‹</a></p><h1 id="workerèŠ‚ç‚¹æ“ä½œ"><a href="#workerèŠ‚ç‚¹æ“ä½œ" class="headerlink" title="workerèŠ‚ç‚¹æ“ä½œ"></a>workerèŠ‚ç‚¹æ“ä½œ</h1><p>ä»¥worker-0ä¸ºä¾‹ï¼Œæ–¹ä¾¿è¿›è¡Œæè¿°ã€‚</p><h2 id="ç¦æ­¢è°ƒåº¦-amp-é©±é€pod-1"><a href="#ç¦æ­¢è°ƒåº¦-amp-é©±é€pod-1" class="headerlink" title="ç¦æ­¢è°ƒåº¦&amp;é©±é€pod"></a>ç¦æ­¢è°ƒåº¦&amp;é©±é€pod</h2><p><code>kubectl drain worker-0 --ignore-daemonsets</code></p><p>é©±é€worker-0èŠ‚ç‚¹ä¸Šçš„podï¼Œé™„å¸¦æ•ˆæœç¦æ­¢è°ƒåº¦ã€‚</p><h2 id="ä¿®æ”¹dockerå·¥ä½œç›®å½•-1"><a href="#ä¿®æ”¹dockerå·¥ä½œç›®å½•-1" class="headerlink" title="ä¿®æ”¹dockerå·¥ä½œç›®å½•"></a>ä¿®æ”¹dockerå·¥ä½œç›®å½•</h2><p>è¯¦æƒ…å‚è€ƒ <a href="https://www.voidking.com/dev-docker-data-root/">ã€ŠDockerä¿®æ”¹å·¥ä½œç›®å½•ã€‹</a></p><h2 id="ä¿®æ”¹kubeletå·¥ä½œç›®å½•-1"><a href="#ä¿®æ”¹kubeletå·¥ä½œç›®å½•-1" class="headerlink" title="ä¿®æ”¹kubeletå·¥ä½œç›®å½•"></a>ä¿®æ”¹kubeletå·¥ä½œç›®å½•</h2><p>è¯¦æƒ…å‚è€ƒ <a href="https://www.voidking.com/dev-kubelet-root-dir/">ã€Škubeletä¿®æ”¹å·¥ä½œç›®å½•ã€‹</a></p><h2 id="å¼€æ”¾è°ƒåº¦-1"><a href="#å¼€æ”¾è°ƒåº¦-1" class="headerlink" title="å¼€æ”¾è°ƒåº¦"></a>å¼€æ”¾è°ƒåº¦</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl uncordon worker-0</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;éœ€æ±‚æè¿°&quot;&gt;&lt;a href=&quot;#éœ€æ±‚æè¿°&quot; class=&quot;headerlink&quot; title=&quot;éœ€æ±‚æè¿°&quot;&gt;&lt;/a&gt;éœ€æ±‚æè¿°&lt;/h1&gt;&lt;p&gt;dockerçš„é»˜è®¤å·¥ä½œç›®å½•æ˜¯&lt;code&gt;/var/lib/docker&lt;/code&gt;ï¼Œä¼šå­˜æ”¾é•œåƒæ–‡ä»¶ã€å®¹å™¨æ—¥å¿—å’Œå†™å…¥åˆ°å®¹å™¨ä¸´æ—¶ç›®å½•çš„æ–‡ä»¶ç­‰ï¼Œé»˜è®¤æŒ‚è½½åœ¨ç³»ç»Ÿç›˜ã€‚&lt;/p&gt;
&lt;p&gt;kubeletçš„é»˜è®¤å·¥ä½œç›®å½•æ˜¯&lt;code&gt;/var/lib/kubelet&lt;/code&gt;ï¼Œä¼šå­˜æ”¾volumeæ–‡ä»¶ï¼ˆåŒ…æ‹¬emptyDir volume)ã€pluginæ–‡ä»¶ç­‰ï¼Œä¹Ÿæ˜¯é»˜è®¤æŒ‚è½½åœ¨ç³»ç»Ÿç›˜ã€‚&lt;/p&gt;
&lt;p&gt;ä½¿ç”¨kubeadmå®‰è£…çš„etcdï¼Œé»˜è®¤æ•°æ®ç›®å½•æ˜¯&lt;code&gt;/var/lib/etcd&lt;/code&gt;ï¼Œä¹Ÿæ˜¯é»˜è®¤æŒ‚è½½åœ¨ç³»ç»Ÿç›˜ã€‚&lt;/p&gt;
&lt;p&gt;è€Œç³»ç»Ÿç›˜ä¸€èˆ¬éƒ½ä¸ä¼šå¤ªå¤§ï¼Œå› æ­¤æœ€å¥½æŠŠdockerå·¥ä½œç›®å½•ã€kubeletå·¥ä½œç›®å½•å’Œetcdæ•°æ®ç›®å½•æ›´æ”¹åˆ°æ•°æ®ç›˜ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="engineering" scheme="https://www.voidking.com/categories/engineering/"/>
    
    <category term="k8s" scheme="https://www.voidking.com/categories/engineering/k8s/"/>
    
    <category term="docker" scheme="https://www.voidking.com/categories/engineering/docker/"/>
    
    <category term="cloudnative" scheme="https://www.voidking.com/categories/engineering/cloudnative/"/>
    
    
    <category term="k8s" scheme="https://www.voidking.com/tags/k8s/"/>
    
    <category term="docker" scheme="https://www.voidking.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>etcdä¿®æ”¹æ•°æ®ç›®å½•</title>
    <link href="https://www.voidking.com/dev-etcd-data-dir/"/>
    <id>https://www.voidking.com/dev-etcd-data-dir/</id>
    <published>2022-10-09T15:00:00.000Z</published>
    <updated>2022-11-01T10:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="éœ€æ±‚æè¿°"><a href="#éœ€æ±‚æè¿°" class="headerlink" title="éœ€æ±‚æè¿°"></a>éœ€æ±‚æè¿°</h1><p>ä½¿ç”¨kubeadmå®‰è£…çš„etcdï¼Œé»˜è®¤æ•°æ®ç›®å½•æ˜¯<code>/var/lib/etcd</code>ï¼Œé»˜è®¤æŒ‚è½½åœ¨ç³»ç»Ÿç›˜ã€‚</p><p>è€Œç³»ç»Ÿç›˜ä¸€èˆ¬éƒ½ä¸ä¼šå¤ªå¤§ï¼Œå› æ­¤æœ€å¥½æŠŠetcdçš„æ•°æ®ç›®å½•æ›´æ”¹åˆ°æ•°æ®ç›˜ã€‚</p><p>æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šæŠŠetcdçš„æ•°æ®ç›®å½•ä»<code>/var/lib/etcd</code>æ”¹åˆ°<code>/data/etcd</code>ï¼Œå…¶ä¸­<code>/data</code>ç›®å½•æŒ‚è½½äº†æ•°æ®ç›˜ã€‚</p><span id="more"></span><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><p>æƒ³åˆ°ä¸¤ä¸ªæ–¹æ³•ï¼š</p><ul><li>ä¿®æ”¹é…ç½®æ³•ï¼šæ‹·è´æ•°æ®åˆ°æ–°ç›®å½•ï¼Œä¿®æ”¹å·¥ä½œç›®å½•é…ç½®åˆ°æ–°ç›®å½•ã€‚</li><li>è½¯é“¾æ³•ï¼šæ‹·è´æ•°æ®åˆ°æ–°ç›®å½•ï¼Œä½¿ç”¨æ–°ç›®å½•çš„è½¯é“¾æ›¿æ¢åŸæ¥çš„å·¥ä½œç›®å½•ã€‚ä¸æ¨èï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰ä»€ä¹ˆéšè—å‘ã€‚</li></ul><p>etcdæ˜¯é›†ç¾¤ï¼Œä¸ºäº†ä¿è¯etcdæœåŠ¡å¯ç”¨ï¼Œéœ€è¦æŒ¨ä¸ªèŠ‚ç‚¹åœæœæ“ä½œï¼Œå®Œæˆä¸€ä¸ªèŠ‚ç‚¹å†è¿›è¡Œä¸‹ä¸€ä¸ªã€‚</p><h1 id="ä¿®æ”¹é…ç½®æ³•"><a href="#ä¿®æ”¹é…ç½®æ³•" class="headerlink" title="ä¿®æ”¹é…ç½®æ³•"></a>ä¿®æ”¹é…ç½®æ³•</h1><p>1ã€åœæ­¢etcd</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo docker ps | grep etcd</span><br><span class="line">sudo <span class="built_in">mv</span> /etc/kubernetes/manifests/etcd.yaml ~/</span><br><span class="line">sudo docker ps | grep etcd</span><br><span class="line">sudo etcdctl  --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/peer.crt --key=/etc/kubernetes/pki/etcd/peer.key --endpoints=<span class="string">&quot;https://192.168.56.101:2379,https://192.168.56.102:2379,https://192.168.56.103:2379&quot;</span> endpoint health</span><br></pre></td></tr></table></figure><p>2ã€ä¿®æ”¹etcdæ•°æ®ç›®å½•<br>ç¼–è¾‘<code>~/etcd.yaml</code>ï¼Œetcd-dataçš„pathä»<code>/var/lib/etcd</code>æ”¹ä¸º<code>/data/etcd</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/kubernetes/pki/etcd</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">etcd-certs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data/etcd</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">etcd-data</span></span><br></pre></td></tr></table></figure><p>3ã€æ‹·è´æ•°æ®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> -p /data/etcd</span><br><span class="line">sudo <span class="built_in">cp</span> -rf /var/lib/etcd/. /data/etcd</span><br><span class="line">sudo <span class="built_in">mv</span> /var/lib/etcd /var/lib/etcd.old</span><br></pre></td></tr></table></figure><p>4ã€å¯åŠ¨etcd&amp;æŸ¥çœ‹etcdçŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mv</span> ~/etcd.yaml /etc/kubernetes/manifests/</span><br><span class="line">sudo docker ps | grep etcd</span><br><span class="line">sudo etcdctl  --cacert=/etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">    --cert=/etc/kubernetes/pki/etcd/peer.crt --key=/etc/kubernetes/pki/etcd/peer.key \</span><br><span class="line">    --endpoints=<span class="string">&quot;https://192.168.56.101:2379,https://192.168.56.102:2379,https://192.168.56.103:2379&quot;</span> \</span><br><span class="line">    endpoint health</span><br></pre></td></tr></table></figure><h1 id="è½¯é“¾æ³•"><a href="#è½¯é“¾æ³•" class="headerlink" title="è½¯é“¾æ³•"></a>è½¯é“¾æ³•</h1><p>å¯ä»¥å‚è€ƒ <a href="https://www.voidking.com/dev-docker-data-root/">ã€ŠDockerä¿®æ”¹å·¥ä½œç›®å½•ã€‹</a></p><h1 id="kubeadmæŒ‡å®šetcdæ•°æ®ç›®å½•"><a href="#kubeadmæŒ‡å®šetcdæ•°æ®ç›®å½•" class="headerlink" title="kubeadmæŒ‡å®šetcdæ•°æ®ç›®å½•"></a>kubeadmæŒ‡å®šetcdæ•°æ®ç›®å½•</h1><h2 id="ä¿®æ”¹etcdæ•°æ®ç›®å½•"><a href="#ä¿®æ”¹etcdæ•°æ®ç›®å½•" class="headerlink" title="ä¿®æ”¹etcdæ•°æ®ç›®å½•"></a>ä¿®æ”¹etcdæ•°æ®ç›®å½•</h2><p>ä½¿ç”¨kubeadmå®‰è£…çš„etcdï¼Œetcdçš„æ•°æ®ç›®å½•æ˜¯åœ¨kubeadm.confæ–‡ä»¶ä¸­æŒ‡å®šçš„ã€‚</p><p>æ ¹æ®kubeadm.confä¸­çš„é…ç½®ï¼Œæ–°åŠ å…¥çš„masterèŠ‚ç‚¹ä¸Šä¼šç”Ÿæˆ<code>/etc/kubernetes/manifests/etcd.yaml</code>æ–‡ä»¶ï¼Œç„¶åetcdå°±ä¼šä½œä¸ºstatic podè¿è¡Œã€‚</p><p>å¯¹äºå·²ç»å®‰è£…å¥½çš„k8sé›†ç¾¤ï¼Œå¯ä»¥é€šè¿‡kubectlä¿®æ”¹é›†ç¾¤ä¸­kubeadmçš„é…ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit cm kubeadm-config -n kube-system </span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œetcdæ•°æ®ç›®å½•çš„ä¿®æ”¹æ–¹æ³•ä¸ºï¼šetcd.local.dataDir å˜é‡ä¿®æ”¹ä¸º <code>/data/etcd</code></p><p>ä¿®æ”¹ä¹‹åï¼Œå¹¶ä¸ä¼šé©¬ä¸Šç”Ÿæ•ˆï¼Œæœ‰æ–°çš„masterèŠ‚ç‚¹åŠ å…¥ï¼Œæ‰ä¼šä½¿ç”¨è¿™ä»½æ–°çš„etcdæ•°æ®ç›®å½•é…ç½®ã€‚</p><h2 id="åˆå§‹åŒ–å‰æŒ‡å®šetcdæ•°æ®ç›®å½•"><a href="#åˆå§‹åŒ–å‰æŒ‡å®šetcdæ•°æ®ç›®å½•" class="headerlink" title="åˆå§‹åŒ–å‰æŒ‡å®šetcdæ•°æ®ç›®å½•"></a>åˆå§‹åŒ–å‰æŒ‡å®šetcdæ•°æ®ç›®å½•</h2><p>åœ¨æ‰§è¡Œ<code>kubeadm init</code>ä¹‹å‰ï¼Œåœ¨kubeadm.confæ–‡ä»¶ä¸­æŒ‡å®šæ•°æ®ç›®å½•ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">dataDir:</span> <span class="string">/data/etcd</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;éœ€æ±‚æè¿°&quot;&gt;&lt;a href=&quot;#éœ€æ±‚æè¿°&quot; class=&quot;headerlink&quot; title=&quot;éœ€æ±‚æè¿°&quot;&gt;&lt;/a&gt;éœ€æ±‚æè¿°&lt;/h1&gt;&lt;p&gt;ä½¿ç”¨kubeadmå®‰è£…çš„etcdï¼Œé»˜è®¤æ•°æ®ç›®å½•æ˜¯&lt;code&gt;/var/lib/etcd&lt;/code&gt;ï¼Œé»˜è®¤æŒ‚è½½åœ¨ç³»ç»Ÿç›˜ã€‚&lt;/p&gt;
&lt;p&gt;è€Œç³»ç»Ÿç›˜ä¸€èˆ¬éƒ½ä¸ä¼šå¤ªå¤§ï¼Œå› æ­¤æœ€å¥½æŠŠetcdçš„æ•°æ®ç›®å½•æ›´æ”¹åˆ°æ•°æ®ç›˜ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šæŠŠetcdçš„æ•°æ®ç›®å½•ä»&lt;code&gt;/var/lib/etcd&lt;/code&gt;æ”¹åˆ°&lt;code&gt;/data/etcd&lt;/code&gt;ï¼Œå…¶ä¸­&lt;code&gt;/data&lt;/code&gt;ç›®å½•æŒ‚è½½äº†æ•°æ®ç›˜ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="engineering" scheme="https://www.voidking.com/categories/engineering/"/>
    
    <category term="k8s" scheme="https://www.voidking.com/categories/engineering/k8s/"/>
    
    <category term="cloudnative" scheme="https://www.voidking.com/categories/engineering/cloudnative/"/>
    
    
    <category term="k8s" scheme="https://www.voidking.com/tags/k8s/"/>
    
    <category term="cloudnative" scheme="https://www.voidking.com/tags/cloudnative/"/>
    
    <category term="etcd" scheme="https://www.voidking.com/tags/etcd/"/>
    
  </entry>
  
  <entry>
    <title>kubeletä¿®æ”¹å·¥ä½œç›®å½•</title>
    <link href="https://www.voidking.com/dev-kubelet-root-dir/"/>
    <id>https://www.voidking.com/dev-kubelet-root-dir/</id>
    <published>2022-10-09T14:00:00.000Z</published>
    <updated>2022-11-01T10:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="éœ€æ±‚æè¿°"><a href="#éœ€æ±‚æè¿°" class="headerlink" title="éœ€æ±‚æè¿°"></a>éœ€æ±‚æè¿°</h1><p>kubeletçš„é»˜è®¤å·¥ä½œç›®å½•ï¼ˆå­˜å‚¨ç›®å½•ï¼‰æ˜¯<code>/var/lib/kubelet</code>ï¼Œä¼šå­˜æ”¾volumeæ–‡ä»¶ï¼ˆåŒ…æ‹¬emptyDir volume)ã€pluginæ–‡ä»¶ç­‰ï¼Œé»˜è®¤æŒ‚è½½åœ¨ç³»ç»Ÿç›˜ã€‚</p><p>è€Œç³»ç»Ÿç›˜ä¸€èˆ¬éƒ½ä¸ä¼šå¤ªå¤§ï¼Œå› æ­¤æœ€å¥½æŠŠkubeletå·¥ä½œç›®å½•æ›´æ”¹åˆ°æ•°æ®ç›˜ã€‚</p><p>æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šæŠŠdockerçš„å·¥ä½œç›®å½•ä»<code>/var/lib/kubelet</code>æ”¹åˆ°<code>/data/kubelet</code>ï¼Œå…¶ä¸­<code>/data</code>ç›®å½•æŒ‚è½½äº†æ•°æ®ç›˜ã€‚</p><span id="more"></span><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><p>æƒ³åˆ°ä¸¤ä¸ªæ–¹æ³•ï¼š</p><ul><li>ä¿®æ”¹é…ç½®æ³•ï¼šæ‹·è´æ•°æ®åˆ°æ–°ç›®å½•ï¼Œä¿®æ”¹å·¥ä½œç›®å½•é…ç½®åˆ°æ–°ç›®å½•ã€‚</li><li>è½¯é“¾æ³•ï¼šæ‹·è´æ•°æ®åˆ°æ–°ç›®å½•ï¼Œä½¿ç”¨æ–°ç›®å½•çš„è½¯é“¾æ›¿æ¢åŸæ¥çš„å·¥ä½œç›®å½•ã€‚ä¸æ¨èï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰ä»€ä¹ˆéšè—å‘ã€‚</li></ul><p>ä¿®æ”¹kubeleté…ç½®ä¹‹å‰ï¼Œä¸ºäº†ä¿è¯ä¸å½±å“èŠ‚ç‚¹ä¸Šçš„æœåŠ¡ï¼Œæœ€å¥½å…ˆå¯¹èŠ‚ç‚¹æ“ä½œç¦æ­¢è°ƒåº¦å’Œé©±é€ã€‚</p><h1 id="ä¿®æ”¹é…ç½®æ³•"><a href="#ä¿®æ”¹é…ç½®æ³•" class="headerlink" title="ä¿®æ”¹é…ç½®æ³•"></a>ä¿®æ”¹é…ç½®æ³•</h1><p>1ã€åœæ­¢kubelet</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop kubelet</span><br></pre></td></tr></table></figure><p>2ã€æ‹·è´kubeletæ•°æ®æ–‡ä»¶åˆ°æ–°è·¯å¾„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> -p /data/kubelet</span><br><span class="line">sudo <span class="built_in">cp</span> -rf /var/lib/kubelet/. /data/kubelet</span><br><span class="line">sudo <span class="built_in">mv</span> /var/lib/kubelet /var/lib/kubelet.old</span><br></pre></td></tr></table></figure><p>3ã€ä¿ç•™config.yamlå’Œkubeadm-flags.envåœ¨è€è·¯å¾„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> /var/lib/kubelet</span><br><span class="line">sudo <span class="built_in">cp</span> /var/lib/kubelet.old/config.yaml /var/lib/kubelet/</span><br><span class="line">sudo <span class="built_in">cp</span> /var/lib/kubelet.old/kubeadm-flags.env /var/lib/kubelet/</span><br></pre></td></tr></table></figure><p>4ã€æ·»åŠ æˆ–ä¿®æ”¹ /etc/sysconfig/kubelet é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ <code>root-dir</code>å‚æ•°</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">KUBELET_EXTRA_ARGS</span>=<span class="string">&quot;--root-dir=/data/kubelet&quot;</span></span><br></pre></td></tr></table></figure><p>PSï¼šå¦‚æœæ˜¯ubuntuç³»ç»Ÿï¼Œåˆ™è¦ä¿®æ”¹ /etc/default/kubelet é…ç½®æ–‡ä»¶</p><p>5ã€é‡å¯kubelet</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload &amp;&amp; sudo systemctl restart kubelet</span><br><span class="line">sudo systemctl status kubelet</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶kubeletå¯åŠ¨å¤±è´¥ï¼Œæ˜¯æ­£å¸¸çš„ï¼Œä¸ç”¨ç‰¹æ®Šå¤„ç†ã€‚</p><h1 id="è½¯é“¾æ³•"><a href="#è½¯é“¾æ³•" class="headerlink" title="è½¯é“¾æ³•"></a>è½¯é“¾æ³•</h1><p>1ã€åœæ­¢kubelet</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop kubelet</span><br></pre></td></tr></table></figure><p>2ã€æ‹·è´kubeletæ•°æ®æ–‡ä»¶åˆ°æ–°è·¯å¾„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> -p /data/kubelet</span><br><span class="line">sudo <span class="built_in">cp</span> -rf /var/lib/kubelet/. /data/kubelet</span><br><span class="line">sudo <span class="built_in">mv</span> /var/lib/kubelet /var/lib/kubelet.old</span><br></pre></td></tr></table></figure><p>3ã€åˆ›å»ºè½¯é“¾</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s <span class="regexp">/data/</span>kubelet <span class="regexp">/var/</span>lib/kubelet</span><br></pre></td></tr></table></figure><p>4ã€å¯åŠ¨kubelet</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload &amp;&amp; sudo systemctl restart kubelet</span><br><span class="line">sudo systemctl status kubelet</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶kubeletå¯åŠ¨å¤±è´¥ï¼Œæ˜¯æ­£å¸¸çš„ï¼Œä¸ç”¨ç‰¹æ®Šå¤„ç†ã€‚</p><h1 id="kubeadmæŒ‡å®škubeletå·¥ä½œç›®å½•"><a href="#kubeadmæŒ‡å®škubeletå·¥ä½œç›®å½•" class="headerlink" title="kubeadmæŒ‡å®škubeletå·¥ä½œç›®å½•"></a>kubeadmæŒ‡å®škubeletå·¥ä½œç›®å½•</h1><p>ä¸å…¶ä¸´æ¸´æ˜äº•ï¼Œä¸å¦‚æœªé›¨ç»¸ç¼ªã€‚èƒ½å¦åœ¨ä½¿ç”¨kubeadméƒ¨ç½²k8sé›†ç¾¤çš„æ—¶å€™ï¼Œç›´æ¥æŒ‡å®šå¥½kubeletçš„å·¥ä½œç›®å½•ï¼Ÿå¿…é¡»æ˜¯å¯ä»¥çš„ã€‚</p><p>åœ¨æ‰§è¡Œ<code>kubeadm init</code>ä¹‹å‰ï¼Œä¿®æ”¹kubeadm.confæ–‡ä»¶ï¼Œæ·»åŠ kubeletExtraArgså­—æ®µã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">nodeRegistration:</span>  </span><br><span class="line">  <span class="attr">kubeletExtraArgs:</span>    </span><br><span class="line">    <span class="attr">root-dir:</span> <span class="string">&quot;/data/kubelet&quot;</span></span><br></pre></td></tr></table></figure><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://kubernetes.io/docs/reference/config-api/kubeadm-config.v1beta3/#kubeadm-k8s-io-v1beta3-NodeRegistrationOptions">kubeadm Configuration - NodeRegistrationOptions</a></li></ul><h1 id="kubeadméƒ¨ç½²kubeletåŸç†"><a href="#kubeadméƒ¨ç½²kubeletåŸç†" class="headerlink" title="kubeadméƒ¨ç½²kubeletåŸç†"></a>kubeadméƒ¨ç½²kubeletåŸç†</h1><p>æœ¬èŠ‚å±äºæ‰©å±•é˜…è¯»ã€‚<br>åœ¨ä¿®æ”¹kubeletå·¥ä½œç›®å½•æ—¶ï¼Œèµ°äº†å¾ˆå¤šå¼¯è·¯ã€‚å…¶å®å¦‚æœç†Ÿæ‚‰kubeadméƒ¨ç½²kubeletçš„åŸç†ï¼Œä¼šå‘ç°ä¿®æ”¹kubeletå·¥ä½œç›®å½•æ˜¯å¾ˆç®€å•çš„ã€‚<br>å¥½å¥½è¯»æ–‡æ¡£ï¼å¥½å¥½è¯»æ–‡æ¡£ï¼å¥½å¥½è¯»æ–‡æ¡£ï¼</p><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/kubelet-integration/">ä½¿ç”¨ kubeadm é…ç½®é›†ç¾¤ä¸­çš„æ¯ä¸ª kubelet</a></li><li><a href="https://blog.51cto.com/u_15127640/4093908">kubeletæºç åˆ†æâ€”â€”kubeletç®€ä»‹ä¸å¯åŠ¨</a></li></ul><h2 id="kubeadm-init-æ—¶çš„å·¥ä½œæµç¨‹"><a href="#kubeadm-init-æ—¶çš„å·¥ä½œæµç¨‹" class="headerlink" title="kubeadm init æ—¶çš„å·¥ä½œæµç¨‹"></a>kubeadm init æ—¶çš„å·¥ä½œæµç¨‹</h2><p>å½“è°ƒç”¨ kubeadm init æ—¶ï¼Œkubelet çš„é…ç½®ä¼šè¢«å†™å…¥ç£ç›˜ /var/lib/kubelet/config.yamlï¼Œ å¹¶ä¸Šä¼ åˆ°é›†ç¾¤ kube-system å‘½åç©ºé—´çš„ kubelet-config ConfigMapã€‚ kubelet é…ç½®ä¿¡æ¯ä¹Ÿè¢«å†™å…¥ /etc/kubernetes/kubelet.confï¼Œå…¶ä¸­åŒ…å«é›†ç¾¤å†…æ‰€æœ‰ kubelet çš„åŸºçº¿é…ç½®ã€‚ æ­¤é…ç½®æ–‡ä»¶æŒ‡å‘å…è®¸ kubelet ä¸ API æœåŠ¡å™¨é€šä¿¡çš„å®¢æˆ·ç«¯è¯ä¹¦ã€‚ è¿™è§£å†³äº†å°†é›†ç¾¤çº§é…ç½®ä¼ æ’­åˆ°æ¯ä¸ª kubelet çš„éœ€æ±‚ã€‚</p><p>é’ˆå¯¹ä¸ºç‰¹å®šå®ä¾‹æä¾›é…ç½®ç»†èŠ‚ï¼Œ kubeadm çš„è§£å†³æ–¹æ³•æ˜¯å°†ç¯å¢ƒæ–‡ä»¶å†™å…¥ /var/lib/kubelet/kubeadm-flags.envï¼Œå…¶ä¸­åŒ…å«äº†ä¸€ä¸ªæ ‡å¿—åˆ—è¡¨<code>KUBELET_KUBEADM_ARGS</code></p><p>å°†è¿™ä¸¤ä¸ªæ–‡ä»¶ç¼–ç»„åˆ°ç£ç›˜åï¼Œå¦‚æœä½¿ç”¨ systemdï¼Œåˆ™ kubeadm å°è¯•è¿è¡Œä»¥ä¸‹ä¸¤ä¸ªå‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br></pre></td></tr></table></figure><h2 id="kubeadm-join-æ—¶çš„å·¥ä½œæµç¨‹"><a href="#kubeadm-join-æ—¶çš„å·¥ä½œæµç¨‹" class="headerlink" title="kubeadm join æ—¶çš„å·¥ä½œæµç¨‹"></a>kubeadm join æ—¶çš„å·¥ä½œæµç¨‹</h2><p>å½“è¿è¡Œ kubeadm join æ—¶ï¼Œkubeadm ä½¿ç”¨ Bootstrap Token è¯ä¹¦æ‰§è¡Œ TLS å¼•å¯¼ï¼Œè¯¥å¼•å¯¼ä¼šè·å–ä¸€ä»½è¯ä¹¦ï¼Œ è¯¥è¯ä¹¦éœ€è¦ä¸‹è½½ kubelet-config ConfigMap å¹¶æŠŠå®ƒå†™å…¥ /var/lib/kubelet/config.yaml ä¸­ã€‚ åŠ¨æ€ç¯å¢ƒæ–‡ä»¶çš„ç”Ÿæˆæ–¹å¼æ°å¥½ä¸ kubeadm init å®Œå…¨ç›¸åŒã€‚</p><p>æ¥ä¸‹æ¥ï¼Œkubeadm è¿è¡Œä»¥ä¸‹ä¸¤ä¸ªå‘½ä»¤å°†æ–°é…ç½®åŠ è½½åˆ° kubelet ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br></pre></td></tr></table></figure><p>åœ¨ kubelet åŠ è½½æ–°é…ç½®åï¼Œkubeadm å°†å†™å…¥ /etc/kubernetes/bootstrap-kubelet.conf KubeConfig æ–‡ä»¶ä¸­ï¼Œ è¯¥æ–‡ä»¶åŒ…å« CA è¯ä¹¦å’Œå¼•å¯¼ç¨‹åºä»¤ç‰Œã€‚ kubelet ä½¿ç”¨è¿™äº›è¯ä¹¦æ‰§è¡Œ TLS å¼•å¯¼ç¨‹åºå¹¶è·å–å”¯ä¸€çš„å‡­æ®ï¼Œè¯¥å‡­æ®è¢«å­˜å‚¨åœ¨ /etc/kubernetes/kubelet.conf ä¸­ã€‚</p><p>å½“ /etc/kubernetes/kubelet.conf æ–‡ä»¶è¢«å†™å…¥åï¼Œkubelet å°±å®Œæˆäº† TLS å¼•å¯¼è¿‡ç¨‹ã€‚ Kubeadm åœ¨å®Œæˆ TLS å¼•å¯¼è¿‡ç¨‹åå°†åˆ é™¤ /etc/kubernetes/bootstrap-kubelet.conf æ–‡ä»¶ã€‚</p><h2 id="kubelet-çš„-systemd-drop-in-æ–‡ä»¶"><a href="#kubelet-çš„-systemd-drop-in-æ–‡ä»¶" class="headerlink" title="kubelet çš„ systemd drop-in æ–‡ä»¶"></a>kubelet çš„ systemd drop-in æ–‡ä»¶</h2><p>é€šè¿‡ kubeadm DEB åŒ… æˆ–è€… RPM åŒ… å®‰è£…çš„é…ç½®æ–‡ä»¶è¢«å†™å…¥ /etc/systemd/system/kubelet.service.d/10-kubeadm.conf å¹¶ç”± systemd ä½¿ç”¨ã€‚å®ƒå¯¹åŸæ¥çš„ RPM ç‰ˆæœ¬ kubelet.service æˆ–è€… DEB ç‰ˆæœ¬ kubelet.service åšäº†å¢å¼ºã€‚</p><p>10-kubeadm.conf ç¤ºä¾‹å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Environment</span>=<span class="string">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;</span></span><br><span class="line"><span class="attr">Environment</span>=<span class="string">&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line"><span class="comment"># è¿™æ˜¯ &quot;kubeadm init&quot; å’Œ &quot;kubeadm join&quot; è¿è¡Œæ—¶ç”Ÿæˆçš„æ–‡ä»¶ï¼Œ</span></span><br><span class="line"><span class="comment"># åŠ¨æ€åœ°å¡«å…… KUBELET_KUBEADM_ARGS å˜é‡</span></span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/var/lib/kubelet/kubeadm-flags.env</span><br><span class="line"><span class="comment"># è¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œç”¨æˆ·åœ¨ä¸å¾—å·²ä¸‹å¯ä»¥å°†å…¶ç”¨ä½œæ›¿ä»£ kubelet argsã€‚</span></span><br><span class="line"><span class="comment"># ç”¨æˆ·æœ€å¥½ä½¿ç”¨ .NodeRegistration.KubeletExtraArgs å¯¹è±¡åœ¨é…ç½®æ–‡ä»¶ä¸­æ›¿ä»£ã€‚</span></span><br><span class="line"><span class="comment"># KUBELET_EXTRA_ARGS åº”è¯¥ä»æ­¤æ–‡ä»¶ä¸­è·å–ã€‚</span></span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/etc/default/kubelet</span><br><span class="line"><span class="attr">ExecStart</span>=</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/kubelet <span class="variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="variable">$KUBELET_CONFIG_ARGS</span> <span class="variable">$KUBELET_KUBEADM_ARGS</span> <span class="variable">$KUBELET_EXTRA_ARGS</span></span><br></pre></td></tr></table></figure><p>å‚æ•°è¯´æ˜ï¼š</p><ul><li>ç”¨äº TLS å¼•å¯¼ç¨‹åºçš„ KubeConfig æ–‡ä»¶ä¸º /etc/kubernetes/bootstrap-kubelet.confï¼Œ ä½†ä»…å½“ /etc/kubernetes/kubelet.conf ä¸å­˜åœ¨æ—¶æ‰èƒ½ä½¿ç”¨ã€‚</li><li>å…·æœ‰å”¯ä¸€ kubelet æ ‡è¯†çš„ KubeConfig æ–‡ä»¶ä¸º /etc/kubernetes/kubelet.confã€‚</li><li>åŒ…å« kubelet çš„ç»„ä»¶é…ç½®çš„æ–‡ä»¶ä¸º /var/lib/kubelet/config.yamlã€‚</li><li><code>KUBELET_KUBEADM_ARGS</code> æ¥æºäº /var/lib/kubelet/kubeadm-flags.env ï¼Œ</li><li><code>KUBELET_EXTRA_ARGS</code> æ¥æºäº /etc/default/kubeletï¼ˆå¯¹äº DEBï¼‰ï¼Œæˆ–è€… /etc/sysconfig/kubeletï¼ˆå¯¹äº RPMï¼‰ã€‚<code>KUBELET_EXTRA_ARGS</code> åœ¨æ ‡å¿—é“¾ä¸­æ’åœ¨æœ€åï¼Œå¹¶ä¸”åœ¨è®¾ç½®å†²çªæ—¶å…·æœ‰æœ€é«˜ä¼˜å…ˆçº§ã€‚</li></ul><h2 id="æŒ‡å®škubeletå·¥ä½œç›®å½•"><a href="#æŒ‡å®škubeletå·¥ä½œç›®å½•" class="headerlink" title="æŒ‡å®škubeletå·¥ä½œç›®å½•"></a>æŒ‡å®škubeletå·¥ä½œç›®å½•</h2><p>é€šè¿‡ä¸Šé¢çš„åŸç†æˆ‘ä»¬äº†è§£åˆ°ï¼Œå¯¹äºkubeletï¼Œå¯ä»¥åœ¨<code>KUBELET_KUBEADM_ARGS</code>æˆ–è€…<code>KUBELET_EXTRA_ARGS</code>æ ‡å¿—åˆ—è¡¨ä¸­æ·»åŠ <code>root-dir</code>æ ‡å¿—ï¼ŒæŒ‡å®škubeletçš„å·¥ä½œç›®å½•ã€‚</p><p>æ–¹æ³•ä¸€ï¼š/var/lib/kubelet/kubeadm-flags.env ä¸­æ·»åŠ æ ‡å¿—</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">KUBELET_KUBEADM_ARGS</span>=<span class="string">&quot;--root-dir=/data/kubelet&quot;</span></span><br></pre></td></tr></table></figure><p>æ–¹æ³•äºŒï¼š/etc/sysconfig/kubelet ä¸­æ·»åŠ æ ‡å¿—</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">KUBELET_EXTRA_ARGS</span>=<span class="string">&quot;--root-dir=/data/kubelet&quot;</span></span><br></pre></td></tr></table></figure><p>æ·»åŠ æ ‡å¿—åï¼Œé‡å¯kubeletå³å¯ã€‚</p><p>ä¹Ÿå¯ä»¥åœ¨éƒ¨ç½²k8sé›†ç¾¤æ—¶ä¸€æ­¥åˆ°ä½æŒ‡å®škubeletå·¥ä½œç›®å½•ï¼Œå…·ä½“æ“ä½œæ–¹æ³•å‚è€ƒ kubeadmæŒ‡å®škubeletå·¥ä½œç›®å½• å°èŠ‚ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;éœ€æ±‚æè¿°&quot;&gt;&lt;a href=&quot;#éœ€æ±‚æè¿°&quot; class=&quot;headerlink&quot; title=&quot;éœ€æ±‚æè¿°&quot;&gt;&lt;/a&gt;éœ€æ±‚æè¿°&lt;/h1&gt;&lt;p&gt;kubeletçš„é»˜è®¤å·¥ä½œç›®å½•ï¼ˆå­˜å‚¨ç›®å½•ï¼‰æ˜¯&lt;code&gt;/var/lib/kubelet&lt;/code&gt;ï¼Œä¼šå­˜æ”¾volumeæ–‡ä»¶ï¼ˆåŒ…æ‹¬emptyDir volume)ã€pluginæ–‡ä»¶ç­‰ï¼Œé»˜è®¤æŒ‚è½½åœ¨ç³»ç»Ÿç›˜ã€‚&lt;/p&gt;
&lt;p&gt;è€Œç³»ç»Ÿç›˜ä¸€èˆ¬éƒ½ä¸ä¼šå¤ªå¤§ï¼Œå› æ­¤æœ€å¥½æŠŠkubeletå·¥ä½œç›®å½•æ›´æ”¹åˆ°æ•°æ®ç›˜ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šæŠŠdockerçš„å·¥ä½œç›®å½•ä»&lt;code&gt;/var/lib/kubelet&lt;/code&gt;æ”¹åˆ°&lt;code&gt;/data/kubelet&lt;/code&gt;ï¼Œå…¶ä¸­&lt;code&gt;/data&lt;/code&gt;ç›®å½•æŒ‚è½½äº†æ•°æ®ç›˜ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="engineering" scheme="https://www.voidking.com/categories/engineering/"/>
    
    <category term="k8s" scheme="https://www.voidking.com/categories/engineering/k8s/"/>
    
    <category term="cloudnative" scheme="https://www.voidking.com/categories/engineering/cloudnative/"/>
    
    
    <category term="k8s" scheme="https://www.voidking.com/tags/k8s/"/>
    
    <category term="cloudnative" scheme="https://www.voidking.com/tags/cloudnative/"/>
    
  </entry>
  
  <entry>
    <title>Dockerä¿®æ”¹å·¥ä½œç›®å½•</title>
    <link href="https://www.voidking.com/dev-docker-data-root/"/>
    <id>https://www.voidking.com/dev-docker-data-root/</id>
    <published>2022-10-09T13:00:00.000Z</published>
    <updated>2022-11-01T10:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="éœ€æ±‚æè¿°"><a href="#éœ€æ±‚æè¿°" class="headerlink" title="éœ€æ±‚æè¿°"></a>éœ€æ±‚æè¿°</h1><p>dockerçš„é»˜è®¤å·¥ä½œç›®å½•ï¼ˆå­˜å‚¨ç›®å½•ï¼‰æ˜¯<code>/var/lib/docker</code>ï¼Œä¼šå­˜æ”¾é•œåƒæ–‡ä»¶ã€å®¹å™¨æ—¥å¿—å’Œå†™å…¥åˆ°å®¹å™¨ä¸´æ—¶ç›®å½•çš„æ–‡ä»¶ç­‰ï¼Œé»˜è®¤æŒ‚è½½åœ¨ç³»ç»Ÿç›˜ã€‚</p><p>è€Œç³»ç»Ÿç›˜ä¸€èˆ¬éƒ½ä¸ä¼šå¤ªå¤§ï¼Œå› æ­¤æœ€å¥½æŠŠdockerå·¥ä½œç›®å½•æ›´æ”¹åˆ°æ•°æ®ç›˜ã€‚</p><p>æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šæŠŠdockerçš„å·¥ä½œç›®å½•ä»<code>/var/lib/docker</code>æ”¹åˆ°<code>/data/docker</code>ï¼Œå…¶ä¸­<code>/data</code>ç›®å½•æŒ‚è½½äº†æ•°æ®ç›˜ã€‚</p><span id="more"></span><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><p>æƒ³åˆ°ä¸¤ä¸ªæ–¹æ³•ï¼š</p><ul><li>ä¿®æ”¹é…ç½®æ³•ï¼šæ‹·è´æ•°æ®åˆ°æ–°ç›®å½•ï¼Œä¿®æ”¹å·¥ä½œç›®å½•é…ç½®åˆ°æ–°ç›®å½•ã€‚</li><li>è½¯é“¾æ³•ï¼šæ‹·è´æ•°æ®åˆ°æ–°ç›®å½•ï¼Œä½¿ç”¨æ–°ç›®å½•çš„è½¯é“¾æ›¿æ¢åŸæ¥çš„å·¥ä½œç›®å½•ã€‚ä¸æ¨èï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰ä»€ä¹ˆéšè—å‘ã€‚</li></ul><h1 id="ä¿®æ”¹é…ç½®æ³•"><a href="#ä¿®æ”¹é…ç½®æ³•" class="headerlink" title="ä¿®æ”¹é…ç½®æ³•"></a>ä¿®æ”¹é…ç½®æ³•</h1><p>å‚è€ƒæ–‡æ¡£<a href="https://tienbm90.medium.com/how-to-change-docker-root-data-directory-89a39be1a70b">How to change docker root data directory</a></p><p>1ã€å…³é—­docker</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop docker</span><br></pre></td></tr></table></figure><p>Warning: Stopping docker.service, but it can still be activated by: docker.socket<br>è¯¥è­¦å‘Šæ„å‘³ç€ï¼šå¦‚æœä½ è¯•å›¾è¿æ¥åˆ°docker socketï¼Œè€ŒdockeræœåŠ¡æ²¡æœ‰è¿è¡Œï¼Œç³»ç»Ÿå°†è‡ªåŠ¨å¯åŠ¨dockerã€‚<br>è¿™æ˜¯å› ä¸ºé™¤äº†docker.serviceå•å…ƒæ–‡ä»¶ï¼Œè¿˜æœ‰ä¸€ä¸ªdocker.socketå•å…ƒæ–‡ä»¶ï¼Œç”¨äºå¥—æ¥å­—æ¿€æ´»ã€‚</p><p>è¿™é‡Œå¯ä»¥ä½¿ç”¨å¦å¤–ä¸€ä¸ªå‘½ä»¤å…³é—­dockerï¼Œç¦æ­¢å¥—æ¥å­—æ¿€æ´»ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop docker.socket</span><br></pre></td></tr></table></figure><p>2ã€æ›´æ”¹dockeræ•°æ®å­˜å‚¨è·¯å¾„<br><code>sudo vim /etc/docker/daemon.json</code><br>æ·»åŠ ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;data-root&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/data/docker&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>3ã€æ‹·è´dockeræ•°æ®æ–‡ä»¶åˆ°æ–°è·¯å¾„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> -p /data/docker</span><br><span class="line">sudo <span class="built_in">cp</span> -rf /var/lib/docker/. /data/docker</span><br><span class="line">sudo <span class="built_in">mv</span> /var/lib/docker /var/lib/docker.old</span><br></pre></td></tr></table></figure><p>4ã€é‡å¯docker&amp;ç¡®è®¤å·¥ä½œç›®å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start docker</span><br><span class="line">sudo docker info | grep Dir</span><br></pre></td></tr></table></figure><h1 id="è½¯é“¾æ³•"><a href="#è½¯é“¾æ³•" class="headerlink" title="è½¯é“¾æ³•"></a>è½¯é“¾æ³•</h1><p>1ã€å…³é—­docker</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop docker</span><br><span class="line">sudo systemctl stop docker.socket</span><br></pre></td></tr></table></figure><p>2ã€æ‹·è´dockeræ•°æ®æ–‡ä»¶åˆ°æ–°è·¯å¾„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> -p /data/docker</span><br><span class="line">sudo <span class="built_in">cp</span> -rf /var/lib/docker/. /data/docker</span><br><span class="line">sudo <span class="built_in">mv</span> /var/lib/docker /var/lib/docker.old</span><br></pre></td></tr></table></figure><p>3ã€åˆ›å»ºè½¯é“¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">ln</span> -s /data/docker /var/lib/docker</span><br></pre></td></tr></table></figure><p>4ã€é‡å¯docker&amp;ç¡®è®¤å·¥ä½œç›®å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start docker</span><br><span class="line">sudo docker info | grep Dir</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;éœ€æ±‚æè¿°&quot;&gt;&lt;a href=&quot;#éœ€æ±‚æè¿°&quot; class=&quot;headerlink&quot; title=&quot;éœ€æ±‚æè¿°&quot;&gt;&lt;/a&gt;éœ€æ±‚æè¿°&lt;/h1&gt;&lt;p&gt;dockerçš„é»˜è®¤å·¥ä½œç›®å½•ï¼ˆå­˜å‚¨ç›®å½•ï¼‰æ˜¯&lt;code&gt;/var/lib/docker&lt;/code&gt;ï¼Œä¼šå­˜æ”¾é•œåƒæ–‡ä»¶ã€å®¹å™¨æ—¥å¿—å’Œå†™å…¥åˆ°å®¹å™¨ä¸´æ—¶ç›®å½•çš„æ–‡ä»¶ç­‰ï¼Œé»˜è®¤æŒ‚è½½åœ¨ç³»ç»Ÿç›˜ã€‚&lt;/p&gt;
&lt;p&gt;è€Œç³»ç»Ÿç›˜ä¸€èˆ¬éƒ½ä¸ä¼šå¤ªå¤§ï¼Œå› æ­¤æœ€å¥½æŠŠdockerå·¥ä½œç›®å½•æ›´æ”¹åˆ°æ•°æ®ç›˜ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šæŠŠdockerçš„å·¥ä½œç›®å½•ä»&lt;code&gt;/var/lib/docker&lt;/code&gt;æ”¹åˆ°&lt;code&gt;/data/docker&lt;/code&gt;ï¼Œå…¶ä¸­&lt;code&gt;/data&lt;/code&gt;ç›®å½•æŒ‚è½½äº†æ•°æ®ç›˜ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="engineering" scheme="https://www.voidking.com/categories/engineering/"/>
    
    <category term="docker" scheme="https://www.voidking.com/categories/engineering/docker/"/>
    
    <category term="cloudnative" scheme="https://www.voidking.com/categories/engineering/cloudnative/"/>
    
    
    <category term="docker" scheme="https://www.voidking.com/tags/docker/"/>
    
    <category term="cloudnative" scheme="https://www.voidking.com/tags/cloudnative/"/>
    
  </entry>
  
  <entry>
    <title>kubeadmå®‰è£…çš„K8Sé›†ç¾¤è¯ä¹¦è¿‡æœŸé—®é¢˜</title>
    <link href="https://www.voidking.com/dev-kubeadm-k8s-cert-expired/"/>
    <id>https://www.voidking.com/dev-kubeadm-k8s-cert-expired/</id>
    <published>2022-09-26T20:00:00.000Z</published>
    <updated>2022-11-14T15:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h1><p>ä½¿ç”¨kubectlè®¿é—®k8sé›†ç¾¤ï¼ŒæŠ¥é”™è¯ä¹¦è¿‡æœŸï¼š<br>Unable to connect to the server: x509: certificate has expired or is not yet valid: current time 2022-09-26T01:33:25-04:00 is after 2022-09-26T03:45:02Z</p><span id="more"></span><h1 id="è§£å†³æ€è·¯"><a href="#è§£å†³æ€è·¯" class="headerlink" title="è§£å†³æ€è·¯"></a>è§£å†³æ€è·¯</h1><p>1ã€ç¡®è®¤è¯ä¹¦è¿‡æœŸ<br>2ã€æ›´æ–°è¯ä¹¦<br>3ã€æ›´æ–°ç›¸å…³é…ç½®</p><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://juejin.cn/post/7068909995701567501">è§£å†³kubernetesè¯ä¹¦è¿‡æœŸé—®é¢˜</a></li><li><a href="https://cloud.tencent.com/developer/article/1962891">Kubeadmé›†ç¾¤è¯ä¹¦è¿‡æœŸåçš„å¤„ç†</a></li></ul><h1 id="å…·ä½“æ“ä½œ"><a href="#å…·ä½“æ“ä½œ" class="headerlink" title="å…·ä½“æ“ä½œ"></a>å…·ä½“æ“ä½œ</h1><h2 id="ç¡®è®¤è¯ä¹¦è¿‡æœŸ"><a href="#ç¡®è®¤è¯ä¹¦è¿‡æœŸ" class="headerlink" title="ç¡®è®¤è¯ä¹¦è¿‡æœŸ"></a>ç¡®è®¤è¯ä¹¦è¿‡æœŸ</h2><p>1ã€ç™»å½•è¯ä¹¦è¿‡æœŸé›†ç¾¤çš„ä»»æ„masterèŠ‚ç‚¹</p><p>2ã€æŸ¥çœ‹è¯ä¹¦è¿‡æœŸæ—¶é—´</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm certs check-expiration</span><br></pre></td></tr></table></figure><p>çœ‹åˆ° RESIDUAL TIME ä¸º <code>&lt;invalid&gt;</code>ï¼Œè¡¨æ˜è¯ä¹¦å·²ç»è¿‡æœŸã€‚</p><h2 id="æ›´æ–°è¯ä¹¦"><a href="#æ›´æ–°è¯ä¹¦" class="headerlink" title="æ›´æ–°è¯ä¹¦"></a>æ›´æ–°è¯ä¹¦</h2><p>æ³¨æ„ï¼šæ›´æ–°è¯ä¹¦æ—¶ï¼Œæ‰€æœ‰masterèŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œ</p><p>1ã€å¤‡ä»½k8sé…ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> -r /etc/kubernetes&#123;,.old&#125;</span><br><span class="line"><span class="comment">#cp -r /var/lib/etcd&#123;,.old&#125;</span></span><br></pre></td></tr></table></figure><p>2ã€æ›´æ–°è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm certs renew all</span><br></pre></td></tr></table></figure><p>æ›´æ–°æˆåŠŸåï¼Œä¼šæç¤ºé‡å¯ä¸€äº›podï¼š</p><blockquote><p>Done renewing certificates. You must restart the kube-apiserver, kube-controller-manager, kube-scheduler and etcd, so that they can use the new certificates.</p></blockquote><p>3ã€é‡å¯kubeletå’Œå®¹å™¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart kubelet</span><br><span class="line">docker ps | grep -v pause | grep -E <span class="string">&quot;etcd|scheduler|controller|apiserver&quot;</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | awk <span class="string">&#x27;&#123;print &quot;docker&quot;,&quot;restart&quot;,$1&#125;&#x27;</span> | bash</span><br></pre></td></tr></table></figure><p>4ã€éªŒè¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/kubernetes/pki</span><br><span class="line">ll</span><br><span class="line">kubeadm certs check-expiration</span><br></pre></td></tr></table></figure><h2 id="æ›´æ–°kubectlé…ç½®"><a href="#æ›´æ–°kubectlé…ç½®" class="headerlink" title="æ›´æ–°kubectlé…ç½®"></a>æ›´æ–°kubectlé…ç½®</h2><p>1ã€æ›´æ–°kubeconfigé…ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /etc/kubernetes/admin.conf .kube/config</span><br></pre></td></tr></table></figure><p>2ã€æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure><h2 id="æ›´æ–°kubesphereé…ç½®"><a href="#æ›´æ–°kubesphereé…ç½®" class="headerlink" title="æ›´æ–°kubesphereé…ç½®"></a>æ›´æ–°kubesphereé…ç½®</h2><p>ä»¥ä¸Šï¼Œk8sé›†ç¾¤çš„è¯ä¹¦è¿‡æœŸé—®é¢˜å·²ç»è§£å†³ã€‚ä½†æ˜¯ï¼Œä½¿ç”¨é€šè¿‡kubesphereçš„ç®¡ç†é¡µé¢è®¿é—®k8sé›†ç¾¤æ—¶ï¼Œä¼šæŠ¥é”™ï¼š</p><blockquote><p>ä¼šè¯è¶…æ—¶æˆ–æ­¤å¸æˆ·åœ¨å…¶å®ƒåœ°æ–¹ç™»å½•ï¼Œè¯·é‡æ–°ç™»å½•</p></blockquote><p>kså®˜æ–¹ç»™çš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨é¡µé¢ä¸Šæ›´æ–° kubeconfigï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ¡ˆåªé€‚ç”¨äºv3.3ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼ˆé¡µé¢ä¸Šä¼šæç¤ºkubeconfigå·²è¿‡æœŸï¼‰ï¼Œè¯¦æƒ…å‚è€ƒ<a href="https://kubesphere.io/zh/docs/v3.3/multicluster-management/enable-multicluster/update-kubeconfig/">æ›´æ–° Kubeconfig</a></p><p>å¦‚æœæ˜¯v3.2æˆ–è€…æ›´ä½ç‰ˆæœ¬ï¼Œå¯ä»¥é€šè¿‡kubectlä¿®æ”¹CRD clusters.cluster.kubesphere.ioï¼Œè¯¦æƒ…å‚è€ƒ<a href="https://kubesphere.com.cn/forum/d/5952-memberkubespherekubeconfig">memberèŠ‚ç‚¹è¯ä¹¦åˆ°æœŸï¼Œç»­çº¦è¯ä¹¦åï¼Œkubesphereå¦‚ä½•æ›´æ–°kubeconfigï¼Ÿ</a></p><p>ä¸ºæ–¹ä¾¿æè¿°ï¼Œå‡è®¾è¯ä¹¦è¿‡æœŸçš„k8sé›†ç¾¤åç§°ä¸º <code>dev</code>ã€‚è¯ä¹¦æ›´æ–°åï¼Œåœ¨kubesphereä¸»é›†ç¾¤æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š</p><p>1ã€æŸ¥çœ‹æ‰€æœ‰é›†ç¾¤é…ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get clusters.cluster.kubesphere.io -n kubesphere-system</span><br></pre></td></tr></table></figure><p>2ã€å¤‡ä»½devé›†ç¾¤é…ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get clusters.cluster.kubesphere.io/dev -n kubesphere-system -o yaml &gt; dev.yaml</span><br></pre></td></tr></table></figure><p>3ã€base64åŠ å¯†æ–°çš„devé›†ç¾¤çš„kubeconfig</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> .kube/config | <span class="built_in">base64</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span></span><br></pre></td></tr></table></figure><p>4ã€æ›´æ–°devé›†ç¾¤é…ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit clusters.cluster.kubesphere.io/dev -n kubesphere-system</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">connection:</span></span><br><span class="line">    <span class="attr">kubeconfig:</span> <span class="string">xxx</span></span><br></pre></td></tr></table></figure><p>æŠŠ kubeconfig çš„valueæ›¿æ¢ä¸ºbase64åŠ å¯†åçš„kubeconfigå†…å®¹ã€‚</p><p>5ã€éªŒè¯<br>é€šè¿‡ksçš„ç®¡ç†é¡µé¢å†æ¬¡è®¿é—®k8sé›†ç¾¤ï¼Œå·²ç»å¯ä»¥æ­£å¸¸è®¿é—®ã€‚</p><h2 id="æ›´æ–°argocdé…ç½®"><a href="#æ›´æ–°argocdé…ç½®" class="headerlink" title="æ›´æ–°argocdé…ç½®"></a>æ›´æ–°argocdé…ç½®</h2><p>æŸ¥çœ‹argocdå’Œk8s devé›†ç¾¤çš„è¿æ¥ï¼Œå‘ç°CONNECTION STATUSå·²ç»å¤±è”ã€‚</p><p>å‚è€ƒ<a href="https://argo-cd.readthedocs.io/en/stable/user-guide/commands/argocd_cluster_add/">Argocd cluster add</a>ï¼Œé€šè¿‡<code>--upsert</code>å‚æ•°æ›´æ–°é›†ç¾¤é…ç½®ã€‚<br>æ³¨æ„ï¼šæ›´æ–°é›†ç¾¤é…ç½®æ—¶ï¼Œé›†ç¾¤çš„åç§°ä¸€å®šè¦å’Œç°æœ‰åç§°ä¿æŒä¸€è‡´ã€‚</p><p>å‡è®¾ï¼š</p><ul><li>argocdæ‰€åœ¨k8sé›†ç¾¤ä¸ºmanager</li><li>managerçš„masterèŠ‚ç‚¹ä¸ŠåŒ…å«devé›†ç¾¤çš„æ–°çš„kubeconfigï¼Œè·¯å¾„ä¸º<code>~/.kube/newconfig</code></li><li><code>dev</code>é›†ç¾¤åœ¨argocdä¸­çš„åç§°ä¸º<code>dev(å¼€å‘)</code></li><li>argo-cd-argocd-server pod ipä¸º <code>10.x.x.x</code></li></ul><p>é‚£ä¹ˆï¼Œåœ¨manageré›†ç¾¤çš„masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œå¦‚ä¸‹æ“ä½œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n argocd -owide</span><br><span class="line">argocd login 10.x.x.x:8080 --grpc-web</span><br><span class="line">argocd cluster list</span><br><span class="line">argocd cluster add kubernetes-admin@kubernetes --kubeconfig ~/.kube/newconfig --name <span class="string">&quot;dev(å¼€å‘)&quot;</span> --upsert </span><br></pre></td></tr></table></figure><p>å¦‚æœmasterèŠ‚ç‚¹æ²¡æœ‰argocd clientï¼Œå¯ä»¥ç™»å½•åˆ°argo-cd-argocd-server podä¸­è¿›è¡Œæ“ä½œã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;é—®é¢˜æè¿°&quot;&gt;&lt;a href=&quot;#é—®é¢˜æè¿°&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜æè¿°&quot;&gt;&lt;/a&gt;é—®é¢˜æè¿°&lt;/h1&gt;&lt;p&gt;ä½¿ç”¨kubectlè®¿é—®k8sé›†ç¾¤ï¼ŒæŠ¥é”™è¯ä¹¦è¿‡æœŸï¼š&lt;br&gt;Unable to connect to the server: x509: certificate has expired or is not yet valid: current time 2022-09-26T01:33:25-04:00 is after 2022-09-26T03:45:02Z&lt;/p&gt;</summary>
    
    
    
    <category term="engineering" scheme="https://www.voidking.com/categories/engineering/"/>
    
    <category term="k8s" scheme="https://www.voidking.com/categories/engineering/k8s/"/>
    
    <category term="devops" scheme="https://www.voidking.com/categories/engineering/devops/"/>
    
    <category term="cloudnative" scheme="https://www.voidking.com/categories/engineering/cloudnative/"/>
    
    <category term="troubleshooting" scheme="https://www.voidking.com/categories/engineering/troubleshooting/"/>
    
    
    <category term="k8s" scheme="https://www.voidking.com/tags/k8s/"/>
    
    <category term="é—®é¢˜æ’æŸ¥" scheme="https://www.voidking.com/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"/>
    
    <category term="cicd" scheme="https://www.voidking.com/tags/cicd/"/>
    
    <category term="kubesphere" scheme="https://www.voidking.com/tags/kubesphere/"/>
    
    <category term="kubeadm" scheme="https://www.voidking.com/tags/kubeadm/"/>
    
  </entry>
  
  <entry>
    <title>Linuxé…ç½®ç½‘ç»œä»£ç†</title>
    <link href="https://www.voidking.com/dev-linux-network-proxy/"/>
    <id>https://www.voidking.com/dev-linux-network-proxy/</id>
    <published>2022-09-13T13:00:00.000Z</published>
    <updated>2022-12-29T22:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç½‘ç»œä»£ç†"><a href="#ç½‘ç»œä»£ç†" class="headerlink" title="ç½‘ç»œä»£ç†"></a>ç½‘ç»œä»£ç†</h1><p><a href="https://www.voidking.com/dev-linux-snat/">ã€ŠLinuxé…ç½®SNATä¸Šç½‘ã€‹</a>ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°ï¼Œé€šè¿‡SNATçš„æ–¹å¼èƒ½å¤Ÿè®©å±€åŸŸç½‘ä¸­æ‰€æœ‰ä¸»æœºéƒ½èƒ½è®¿é—®å¤–ç½‘ã€‚<br>è€Œç½‘ç»œä»£ç†ï¼Œä¹Ÿèƒ½è®©å±€åŸŸç½‘ä¸­æ‰€æœ‰ä¸»æœºéƒ½èƒ½è®¿é—®å¤–ç½‘ã€‚å¹¶ä¸”ï¼Œå¦‚æœç½‘ç»œä»£ç†æ”¯æŒç§‘å­¦ä¸Šç½‘ï¼Œé‚£ä¹ˆæ‰€æœ‰ä½¿ç”¨è¿™ä¸ªä»£ç†çš„ä¸»æœºä¹Ÿå¯ä»¥ç§‘å­¦ä¸Šç½‘ã€‚</p><p>æœ¬æ–‡æˆ‘ä»¬å°±æ¥å­¦ä¹ ä¸€ä¸‹Linuxä¸­å¸¸è§çš„ç½‘ç»œä»£ç†é…ç½®æ–¹æ³•ï¼Œå‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://www.cnblogs.com/zaq12wsx/p/14371537.html">linuxè®¾ç½®ä»£ç†ä¸Šç½‘</a></li><li><a href="https://www.cnblogs.com/linjiangCN/p/16135203.html">docker pull é…ç½®ä»£ç†</a></li></ul><p>å·²çŸ¥ç½‘ç»œä»£ç†çš„IPå’ŒPORTä¸ºï¼š<code>192.168.56.1:7890</code></p><span id="more"></span><h1 id="bashç¯å¢ƒç½‘ç»œä»£ç†"><a href="#bashç¯å¢ƒç½‘ç»œä»£ç†" class="headerlink" title="bashç¯å¢ƒç½‘ç»œä»£ç†"></a>bashç¯å¢ƒç½‘ç»œä»£ç†</h1><p>bashç¯å¢ƒç½‘ç»œä»£ç†è®¾ç½®ï¼Œæ˜¯é€‚ç”¨äºå…¨å±€çš„ï¼Œå› ä¸ºç»å¤§éƒ¨åˆ†è½¯ä»¶éƒ½ä¼šä»ç¯å¢ƒå˜é‡ä¸­è¯»å–æ•°æ®ï¼Œæ¯”å¦‚curlå‘½ä»¤ã€yumå‘½ä»¤ã€wgetå‘½ä»¤ç­‰ç­‰ã€‚</p><h2 id="ä¸´æ—¶é…ç½®"><a href="#ä¸´æ—¶é…ç½®" class="headerlink" title="ä¸´æ—¶é…ç½®"></a>ä¸´æ—¶é…ç½®</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> https_proxy=http://192.168.56.1:7890 http_proxy=http://192.168.56.1:7890 all_proxy=socks5://192.168.56.1:7890 ftp_proxy=http://192.168.56.1:7890 no_proxy=localhost,127.0.0.1,192.168.56.0/24</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>no_proxy</code>éœ€è¦æ³¨æ„ï¼Œä¸åŒçš„è½¯ä»¶å¯¹äºå®ƒæœ‰ä¸åŒçš„å¤„ç†ã€‚æœ€å…¸å‹çš„ä¾‹å­ï¼š</p><ul><li><code>example.com</code>ï¼šå¤§éƒ¨åˆ†è½¯ä»¶éƒ½æ”¯æŒç²¾ç¡®åŒ¹é…å’Œä¸‹ä¸€çº§åŸŸååŒ¹é…ï¼Œä¾‹å¦‚è¿˜å¯ä»¥åŒ¹é…<code>subdomain.example.com</code></li><li><code>.example.com</code>ï¼šcurlå‰¥ç¦»å‰ç¼€<code>.</code>ï¼Œå¯¹äº<code>example.com</code>ä¸ä¼šä½¿ç”¨ä»£ç†ï¼›wgetä¸ä¼šå‰¥ç¦»å‰ç¼€<code>.</code>ï¼Œå¯¹äº<code>example.com</code>ä¼šä½¿ç”¨ä»£ç†</li><li><code>192.168.56.0/24</code>ï¼šåªæœ‰Goå’ŒRubyæ”¯æŒè¿™ç§CIDRå—</li></ul><p>è¯¦æƒ…å‚è€ƒ<a href="https://about.gitlab.com/blog/2021/01/27/we-need-to-talk-no-proxy/">We need to talk: Can we standardize NO_PROXY?</a></p><h2 id="æ°¸ä¹…ç”Ÿæ•ˆ"><a href="#æ°¸ä¹…ç”Ÿæ•ˆ" class="headerlink" title="æ°¸ä¹…ç”Ÿæ•ˆ"></a>æ°¸ä¹…ç”Ÿæ•ˆ</h2><p>1ã€å†™å…¥é…ç½®å†…å®¹åˆ°<code>.bashrc</code>æ–‡ä»¶ä¸­</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> https_proxy=http://192.168.56.1:7890 </span><br><span class="line"><span class="built_in">export</span> http_proxy=http://192.168.56.1:7890 </span><br><span class="line"><span class="built_in">export</span> all_proxy=socks5://192.168.56.1:7890</span><br><span class="line"><span class="built_in">export</span> ftp_proxy=http://192.168.56.1:7890 </span><br><span class="line"><span class="built_in">export</span> no_proxy=localhost,127.0.0.1,192.168.56.0/24</span><br></pre></td></tr></table></figure><p>å†™åˆ°<code>.bashrc</code>ï¼Œæ— è®ºæ˜¯ç™»å½•sessionè¿˜æ˜¯éç™»å½•sessionï¼Œéƒ½å¯ä»¥ä½¿ç”¨è¿™äº›å˜é‡ï¼Œè¯¦æƒ…å‚è€ƒ<a href="https://www.voidking.com/dev-bashprofile-bashrc/">bash_profileå’Œbashrcçš„åŒºåˆ«</a>ã€‚</p><p>2ã€ä½¿ç”Ÿæ•ˆ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> .bashrc</span><br></pre></td></tr></table></figure><h1 id="wgetä»£ç†"><a href="#wgetä»£ç†" class="headerlink" title="wgetä»£ç†"></a>wgetä»£ç†</h1><p>ç¼–è¾‘æ–‡ä»¶<code>/etc/wgetrc</code>ï¼Œæ·»åŠ å†…å®¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http_proxy = http://192.168.56.1:7890  </span><br><span class="line">https_proxy = http://192.168.56.1:7890</span><br><span class="line">ftp_proxy = http://192.168.56.1:7890</span><br></pre></td></tr></table></figure><h1 id="yumä»£ç†"><a href="#yumä»£ç†" class="headerlink" title="yumä»£ç†"></a>yumä»£ç†</h1><p>ç¼–è¾‘æ–‡ä»¶<code>/etc/yum.conf</code>ï¼Œæ·»åŠ å†…å®¹ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy=http://192.168.56.1:7890</span><br></pre></td></tr></table></figure><h1 id="æµè§ˆå™¨ä¸Šç½‘ä»£ç†"><a href="#æµè§ˆå™¨ä¸Šç½‘ä»£ç†" class="headerlink" title="æµè§ˆå™¨ä¸Šç½‘ä»£ç†"></a>æµè§ˆå™¨ä¸Šç½‘ä»£ç†</h1><p>ä»¥Firefoxæµè§ˆå™¨ä¸ºä¾‹ï¼š<br>Edit -&gt; Preferences -&gt; Advanced -&gt; Network<br>åœ¨Connectionä¸‹ç‚¹å‡»Settingsï¼Œmanual proxy configurationé‡Œè®¾ç½®IPå’ŒPORTã€‚</p><h1 id="docker-pullä»£ç†"><a href="#docker-pullä»£ç†" class="headerlink" title="docker pullä»£ç†"></a>docker pullä»£ç†</h1><p>1ã€åˆ›å»ºdockeré…ç½®ç›®å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /etc/systemd/system/docker.service.d</span><br></pre></td></tr></table></figure><p>2ã€æ·»åŠ ä»£ç†é…ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/systemd/system/docker.service.d/http-proxy.conf</span><br></pre></td></tr></table></figure><p>å†™å…¥å†…å®¹ä¸ºï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">Environment=&quot;HTTP_PROXY=http://192.168.56.1:7890&quot;</span><br><span class="line">Environment=&quot;HTTPS_PROXY=http://192.168.56.1:7890&quot;</span><br><span class="line">Environment=&quot;NO_PROXY=localhost,127.0.0.1,192.168.56.200,harbor.voidking.com&quot;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ20.10.18å’Œæ›´æ—©çš„dockerç‰ˆæœ¬ï¼ŒNO_PROXYä¸æ”¯æŒCIDRï¼Œè¯¦æƒ…å‚è€ƒ<a href="https://github.com/docker/docs/issues/8191">NO_PROXY does not support CIDR notation</a></p><p>3ã€é‡å¯docker</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><p>4ã€æŸ¥çœ‹dockerä»£ç†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl show docker --property Environment</span><br><span class="line">docker info | grep Proxy</span><br></pre></td></tr></table></figure><h1 id="docker-buildä»£ç†"><a href="#docker-buildä»£ç†" class="headerlink" title="docker buildä»£ç†"></a>docker buildä»£ç†</h1><p>docker buildæ—¶ï¼Œå®¹å™¨å†…éœ€è¦ä½¿ç”¨pipä¸‹è½½ä¾èµ–ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker build \</span><br><span class="line">--network=host \</span><br><span class="line">--build-arg HTTP_PROXY=http://192.168.56.1:7890 \</span><br><span class="line">--build-arg HTTPS_PROXY=http://192.168.56.1:7890 \</span><br><span class="line">-t voidking/demo:v1.0.0 . \</span><br><span class="line">-f Dockerfile_test</span><br></pre></td></tr></table></figure><h1 id="pipä»£ç†"><a href="#pipä»£ç†" class="headerlink" title="pipä»£ç†"></a>pipä»£ç†</h1><p>æ‰§è¡Œpipå‘½ä»¤æ—¶ç›´æ¥æŒ‡å®šä»£ç†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install xxx --proxy http://192.168.56.1:7890</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;ç½‘ç»œä»£ç†&quot;&gt;&lt;a href=&quot;#ç½‘ç»œä»£ç†&quot; class=&quot;headerlink&quot; title=&quot;ç½‘ç»œä»£ç†&quot;&gt;&lt;/a&gt;ç½‘ç»œä»£ç†&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://www.voidking.com/dev-linux-snat/&quot;&gt;ã€ŠLinuxé…ç½®SNATä¸Šç½‘ã€‹&lt;/a&gt;ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°ï¼Œé€šè¿‡SNATçš„æ–¹å¼èƒ½å¤Ÿè®©å±€åŸŸç½‘ä¸­æ‰€æœ‰ä¸»æœºéƒ½èƒ½è®¿é—®å¤–ç½‘ã€‚&lt;br&gt;è€Œç½‘ç»œä»£ç†ï¼Œä¹Ÿèƒ½è®©å±€åŸŸç½‘ä¸­æ‰€æœ‰ä¸»æœºéƒ½èƒ½è®¿é—®å¤–ç½‘ã€‚å¹¶ä¸”ï¼Œå¦‚æœç½‘ç»œä»£ç†æ”¯æŒç§‘å­¦ä¸Šç½‘ï¼Œé‚£ä¹ˆæ‰€æœ‰ä½¿ç”¨è¿™ä¸ªä»£ç†çš„ä¸»æœºä¹Ÿå¯ä»¥ç§‘å­¦ä¸Šç½‘ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡æˆ‘ä»¬å°±æ¥å­¦ä¹ ä¸€ä¸‹Linuxä¸­å¸¸è§çš„ç½‘ç»œä»£ç†é…ç½®æ–¹æ³•ï¼Œå‚è€ƒæ–‡æ¡£ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.cnblogs.com/zaq12wsx/p/14371537.html&quot;&gt;linuxè®¾ç½®ä»£ç†ä¸Šç½‘&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.cnblogs.com/linjiangCN/p/16135203.html&quot;&gt;docker pull é…ç½®ä»£ç†&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å·²çŸ¥ç½‘ç»œä»£ç†çš„IPå’ŒPORTä¸ºï¼š&lt;code&gt;192.168.56.1:7890&lt;/code&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="engineering" scheme="https://www.voidking.com/categories/engineering/"/>
    
    <category term="docker" scheme="https://www.voidking.com/categories/engineering/docker/"/>
    
    <category term="network" scheme="https://www.voidking.com/categories/engineering/network/"/>
    
    <category term="devops" scheme="https://www.voidking.com/categories/engineering/devops/"/>
    
    
    <category term="ç½‘ç»œ" scheme="https://www.voidking.com/tags/%E7%BD%91%E7%BB%9C/"/>
    
    <category term="docker" scheme="https://www.voidking.com/tags/docker/"/>
    
    <category term="linux" scheme="https://www.voidking.com/tags/linux/"/>
    
    <category term="centos" scheme="https://www.voidking.com/tags/centos/"/>
    
  </entry>
  
  <entry>
    <title>Argo CDå…¥é—¨ç¯‡</title>
    <link href="https://www.voidking.com/dev-argocd-start/"/>
    <id>https://www.voidking.com/dev-argocd-start/</id>
    <published>2022-09-08T20:00:00.000Z</published>
    <updated>2023-02-06T17:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Argo-CDæ˜¯å•¥ï¼Ÿ"><a href="#Argo-CDæ˜¯å•¥ï¼Ÿ" class="headerlink" title="Argo CDæ˜¯å•¥ï¼Ÿ"></a>Argo CDæ˜¯å•¥ï¼Ÿ</h1><blockquote><p>What Is Argo CD? Argo CD is a declarative, GitOps continuous delivery tool for Kubernetes.<br>Why Argo CD? Application definitions, configurations, and environments should be declarative and version controlled. Application deployment and lifecycle management should be automated, auditable, and easy to understand.</p></blockquote><p>Argo CDæ˜¯ä»€ä¹ˆï¼ŸArgo CDæ˜¯ä¸€ä¸ªå£°æ˜å¼çš„åŸºäºGitOpsçš„ç”¨äºK8Sçš„æŒç»­äº¤ä»˜å·¥å…·ã€‚<br>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Argo CDï¼Ÿåº”ç”¨å®šä¹‰ã€é…ç½®å’Œç¯å¢ƒéƒ½åº”è¯¥è¢«å£°æ˜å’Œç‰ˆæœ¬æ§åˆ¶ã€‚åº”ç”¨éƒ¨ç½²å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†éƒ½åº”è¯¥æ˜¯è‡ªåŠ¨çš„ã€å¯å®¡è®¡çš„ã€æ˜“ç†è§£çš„ã€‚</p><p>Argo CD éµå¾ª GitOps æ¨¡å¼ï¼Œä½¿ç”¨ Git ä»“åº“ä½œä¸ºå®šä¹‰æ‰€éœ€åº”ç”¨ç¨‹åºçŠ¶æ€çš„çœŸå®æ¥æºï¼ŒArgo CD æ”¯æŒå¤šç§ Kubernetes æ¸…å•ï¼š</p><ul><li>kustomize</li><li>helm charts</li><li>ksonnet applications</li><li>jsonnet files</li><li>Plain directory of YAML/json manifests</li><li>Any custom config management tool configured as a config management plugin<br>Argo CD å¯åœ¨æŒ‡å®šçš„ç›®æ ‡ç¯å¢ƒä¸­è‡ªåŠ¨éƒ¨ç½²æ‰€éœ€çš„åº”ç”¨ç¨‹åºçŠ¶æ€ï¼Œåº”ç”¨ç¨‹åºéƒ¨ç½²å¯ä»¥åœ¨ Git æäº¤æ—¶è·Ÿè¸ªå¯¹åˆ†æ”¯ã€æ ‡ç­¾çš„æ›´æ–°ï¼Œæˆ–å›ºå®šåˆ°æ¸…å•çš„æŒ‡å®šç‰ˆæœ¬ã€‚</li></ul><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://argo-cd.readthedocs.io/en/stable/">Argo CDå®˜æ–¹æ–‡æ¡£</a></li><li><a href="https://www.qikqiak.com/k8strain2/devops/gitops/argocd/">Argo CD</a></li></ul><span id="more"></span><h1 id="GitOpsæ˜¯å•¥ï¼Ÿ"><a href="#GitOpsæ˜¯å•¥ï¼Ÿ" class="headerlink" title="GitOpsæ˜¯å•¥ï¼Ÿ"></a>GitOpsæ˜¯å•¥ï¼Ÿ</h1><p>ä¸Šé¢æåˆ°äº†GitOpsï¼Œè¿™æ˜¯ä¸ªå•¥ï¼Ÿ<br>åœ¨èŠGitOpsä¹‹å‰ï¼Œå…ˆèŠä¸€ä¸‹<a href="https://zh.wikipedia.org/wiki/DevOps">DevOps</a>ã€‚<br><img src="https://cdn.voidking.com/@/imgs/argocd-start/devops.png?imageView2/0/w/800"></p><blockquote><p>DevOpsï¼ˆDevelopmentå’ŒOperationsçš„ç»„åˆè¯ï¼‰æ˜¯ä¸€ç§é‡è§†â€œè½¯ä»¶å¼€å‘äººå‘˜ï¼ˆDevï¼‰â€å’Œâ€œITè¿ç»´æŠ€æœ¯äººå‘˜ï¼ˆOpsï¼‰â€ä¹‹é—´æ²Ÿé€šåˆä½œçš„æ–‡åŒ–ã€è¿åŠ¨æˆ–æƒ¯ä¾‹ã€‚é€šè¿‡è‡ªåŠ¨åŒ–â€œè½¯ä»¶äº¤ä»˜â€å’Œâ€œæ¶æ„å˜æ›´â€çš„æµç¨‹ï¼Œæ¥ä½¿å¾—æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒè½¯ä»¶èƒ½å¤Ÿæ›´åŠ åœ°å¿«æ·ã€é¢‘ç¹å’Œå¯é ã€‚</p></blockquote><p>DevOpsç®€å•æ¥è¯´ï¼Œå°±æ˜¯æ•æ·æ€ç»´ï¼ˆç‰ˆæœ¬æ›´æ–°åˆå¿«åˆå¥½ï¼‰ï¼ä¸ºäº†å®ç°æ•æ·ï¼Œéœ€è¦æ ‡å‡†å’Œè§„èŒƒï¼Œéœ€è¦å¼€å‘ã€æµ‹è¯•ã€è¿ç»´åˆä½œï¼Œéœ€è¦è‡ªåŠ¨åŒ–ã€‚</p><p>è€ŒGitOpsï¼Œæ­£æ˜¯åŸºäºæ•æ·æ€ç»´è€Œè¯ç”Ÿçš„ä¸€ç§æŒç»­äº¤ä»˜æ–¹å¼ï¼Œèƒ½å¤Ÿç”¨å£°æ˜çš„æ–¹å¼ä¼˜é›…åœ°è¿›è¡ŒCICDã€‚<br>1ã€æºç å­˜å‚¨äºGitæºç ä»“åº“ï¼Œå¼€å‘äººå‘˜æ¨é€æäº¤åŒ…å«æ–°åŠŸèƒ½çš„ä»£ç åˆ°ä»£ç ä»“åº“çš„å¯¹åº”åˆ†æ”¯ä¸­ï¼›ä»£ç å®¡æ ¸é€šè¿‡åå°†è¢«åˆå¹¶è‡³å¯¹åº”åˆ†æ”¯ã€‚<br>2ã€åˆå¹¶è¯·æ±‚é€šè¿‡åä¼šè§¦å‘æ„å»ºå¹¶è¿›è¡Œæµ‹è¯•ï¼Œæ„å»ºå¥½çš„é•œåƒå°†è¢«æ¨é€è‡³é•œåƒä»“åº“ä¸­ã€‚<br>3ã€GitOpsæ£€æµ‹åˆ°æœ‰æ–°çš„é•œåƒï¼Œä¼šæå–æœ€æ–°çš„é•œåƒæ ‡è®°ï¼Œç„¶ååŒæ­¥åˆ°Gité…ç½®ä»“åº“ï¼ˆConfigï¼‰çš„æ¸…å•ä¸­ã€‚<br>4ã€GitOpsæ£€æµ‹åˆ°é›†ç¾¤çŠ¶æ€è¿‡æœŸï¼Œä¼šä»é…ç½®ä»“åº“ä¸­æ‹‰å–æ›´æ–°åçš„æ¸…å•ï¼Œå¹¶å°†åŒ…å«æ–°åŠŸèƒ½çš„é•œåƒé€šè¿‡éƒ¨ç½²åˆ°é›†ç¾¤é‡Œã€‚</p><p>å¯¹äºä¸åŒç¯å¢ƒè€Œè¨€ï¼Œå¯ä»¥åœ¨Configä»“ä¸­åˆ›å»ºå¤šä¸ªå­ç›®å½•æˆ–è€…å­åˆ†æ”¯ç®¡ç†ä¸åŒç¯å¢ƒå¯¹åº”çš„å¤šä¸ªé›†ç¾¤ï¼Œä»è€Œå®ç°å¤šç¯å¢ƒçš„GitOpsã€‚</p><p>æ›´å¤šå†…å®¹å‚è€ƒ<a href="https://bbs.huaweicloud.com/blogs/314858">æµ…è°ˆGitOps</a></p><h1 id="Argo-CDæ¶æ„"><a href="#Argo-CDæ¶æ„" class="headerlink" title="Argo CDæ¶æ„"></a>Argo CDæ¶æ„</h1><p><img src="https://cdn.voidking.com/@/imgs/argocd-start/argocd_architecture.png?imageView2/0/w/800"></p><ul><li>API Serveræ˜¯ä¸€ä¸ª gRPC/REST serverï¼Œå®ƒå¼€æ”¾äº† Web UIã€CLI å’Œ CI/CD ç³»ç»Ÿä½¿ç”¨çš„ APIã€‚</li><li>Repository Serveræ˜¯ä¸€ä¸ªå†…éƒ¨æœåŠ¡ï¼Œå®ƒç»´æŠ¤åº”ç”¨æ¸…å•çš„Gitä»“åº“çš„æœ¬åœ°ç¼“å­˜ï¼Œè´Ÿè´£ç”Ÿæˆå’Œè¿”å› Kubernetes æ¸…å•ã€‚</li><li>Application Controlleræ˜¯ä¸€ä¸ª Kubernetes æ§åˆ¶å™¨ï¼Œå®ƒæŒç»­ç›‘æ§æ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºå¹¶å°†å½“å‰çš„æ´»åŠ¨çŠ¶æ€ä¸æ‰€éœ€çš„ç›®æ ‡çŠ¶æ€ï¼ˆå¦‚ repo ä¸­æŒ‡å®šçš„ï¼‰è¿›è¡Œæ¯”è¾ƒï¼Œæ£€æµ‹ OutOfSync åº”ç”¨ç¨‹åºçŠ¶æ€å¹¶å¯é€‰æ‹©é‡‡å–çº æ­£æªæ–½ã€‚è´Ÿè´£ä¸ºç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼ˆPreSyncã€Syncã€PostSyncï¼‰è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„é’©å­ã€‚</li></ul><p>ä»¥ä¸Šæ˜¯å®˜æ–¹ç»™çš„argocdæ¶æ„å›¾å’Œè¯´æ˜ï¼Œè¯¦æƒ…å‚è€ƒ<a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/architecture/">Architectural Overview</a>ã€‚<br>è¿™ä¸ªæ¶æ„å›¾ä¸å¤ªå‹å¥½ï¼Œæ²¡æœ‰æ˜æ˜¾ä½“ç°å‡ºargocdç›‘å¬gitä»“åº“ã€‚</p><p>ä¸‹é¢å†çœ‹ä¸€ä¸ªæ¯”è¾ƒå‹å¥½çš„argocdæ¶æ„å›¾ï¼š<br><img src="https://cdn.voidking.com/@/imgs/argocd-start/arch.jpeg?imageView2/0/w/800"><br>CIæµæ°´çº¿è§¦å‘æ›´æ–°Gitä»“åº“ä¸­çš„K8Såº”ç”¨æ¸…å•ï¼Œæˆ–è€…å·¥ç¨‹å¸ˆç›´æ¥ä¿®æ”¹Gitä»“åº“ä¸­çš„K8Såº”ç”¨æ¸…å•ï¼ŒArgo CDéƒ½ä¼šè‡ªåŠ¨æ‹‰å–æœ€æ–°çš„é…ç½®å¹¶åº”ç”¨åˆ°K8Sé›†ç¾¤ä¸­ã€‚è¯¦æƒ…å‚è€ƒ<a href="https://zhuanlan.zhihu.com/p/551331656">Argo CD å…¥é—¨æ•™ç¨‹</a></p><h1 id="è§¦å‘Argo-CDåŒæ­¥çš„æ–¹å¼"><a href="#è§¦å‘Argo-CDåŒæ­¥çš„æ–¹å¼" class="headerlink" title="è§¦å‘Argo CDåŒæ­¥çš„æ–¹å¼"></a>è§¦å‘Argo CDåŒæ­¥çš„æ–¹å¼</h1><p>è§¦å‘Argo CDåŒæ­¥æœ‰ä¸‰ç§æ–¹å¼ï¼š</p><ul><li>æ‰‹åŠ¨ï¼šåœ¨é¡µé¢ä¸Šç‚¹å‡»è§¦å‘åŒæ­¥ï¼Œæˆ–è€…ä½¿ç”¨CLIè§¦å‘åŒæ­¥</li><li>è‡ªåŠ¨ï¼šé…ç½®åè‡ªåŠ¨è§¦å‘åŒæ­¥</li><li>Webhookï¼šGitä»“åº“æ›´æ–°åï¼Œé€šè¿‡Webhookå‘ŠçŸ¥Argo CDè§¦å‘åŒæ­¥ã€‚è¯¦æƒ…å‚è€ƒæ–‡æ¡£<a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/webhook/">Git Webhook Configuration</a></li></ul><h1 id="Argo-CDä½¿ç”¨"><a href="#Argo-CDä½¿ç”¨" class="headerlink" title="Argo CDä½¿ç”¨"></a>Argo CDä½¿ç”¨</h1><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://argo-cd.readthedocs.io/en/stable/getting_started/">Argo CD - Getting Started</a></li><li><a href="https://zhuanlan.zhihu.com/p/551331656">Argo CD å…¥é—¨æ•™ç¨‹</a></li><li><a href="https://blog.csdn.net/youzhouliu/article/details/125033353">Argo CD ä½¿ç”¨</a></li><li><a href="https://zhuanlan.zhihu.com/p/162884286">Kustomize + Argo CD ä¼˜åŒ–å‘å¸ƒæµç¨‹</a></li><li><a href="https://argo-cd.readthedocs.io/en/stable/user-guide/auto_sync/">Argo CD - Automated Sync Policy</a></li><li><a href="https://argo-cd.readthedocs.io/en/stable/user-guide/sync-options/">Argo CD - Sync Options</a></li></ul><h2 id="å‡†å¤‡gitä»“åº“"><a href="#å‡†å¤‡gitä»“åº“" class="headerlink" title="å‡†å¤‡gitä»“åº“"></a>å‡†å¤‡gitä»“åº“</h2><p>åˆ›å»ºä¸€ä¸ªgitä»“åº“ï¼ŒåŒ…å«k8sèµ„æºæ¸…å•ï¼ˆä¸€èˆ¬æ˜¯kustomizationæ–‡ä»¶ï¼‰ã€‚<br>ä½¿ç”¨è¿™äº›èµ„æºæ¸…å•å¯ä»¥åœ¨k8sä¸­åˆ›å»ºå’Œå˜æ›´deploymentã€serviceç­‰èµ„æºå¯¹è±¡ï¼ˆä¸ä½¿ç”¨argocdï¼Œç›´æ¥ä½¿ç”¨kubectlä¹Ÿå¯ä»¥ï¼‰ã€‚</p><p>gitä»“åº“å‚è€ƒï¼š<a href="https://github.com/voidking/argocd-demo">voidking/argocd-demo</a></p><p>kustomizeç›¸å…³çŸ¥è¯†ç‚¹å‚è€ƒï¼š<a href="https://www.voidking.com/dev-kubectl-kustomize/">ã€ŠKustomizeå·¥å…·ã€‹</a></p><h2 id="é…ç½®argocdåº”ç”¨"><a href="#é…ç½®argocdåº”ç”¨" class="headerlink" title="é…ç½®argocdåº”ç”¨"></a>é…ç½®argocdåº”ç”¨</h2><p>é€šè¿‡argocdçš„clientæˆ–è€…UIç•Œé¢ï¼Œé…ç½®ä¸€ä¸ªargocdåº”ç”¨ã€‚<br>åº”ç”¨ä¼šæŒ‡å®šgitä»“åº“ã€è·¯å¾„ï¼Œè¿™æ ·å°±çŸ¥é“ä½¿ç”¨å“ªäº›èµ„æºæ¸…å•äº†ã€‚<br>åº”ç”¨è¿˜ä¼šæŒ‡å®šk8sé›†ç¾¤ï¼Œè¿™æ ·å°±çŸ¥é“åœ¨å“ªä¸ªé›†ç¾¤ä¸­åˆ›å»ºå’Œå˜æ›´èµ„æºå¯¹è±¡äº†ã€‚</p><p>Automated SYNC POLICYâ€‹â€‹â€‹ï¼š</p><ul><li>RRUNE RESOURCESâ€‹â€‹ï¼šè‡ªåŠ¨ä¿®å‰ªã€‚é›†ç¾¤ä¸ŠæŸä¸ªèµ„æºåœ¨ GitRepo ä¸­æ‰¾ä¸åˆ°å¯¹åº”çš„é…ç½®æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤é›†ç¾¤ä¸Šçš„è¯¥èµ„æºã€‚</li><li>SELF HEALâ€‹â€‹ï¼šè‡ªæ„ˆã€‚å› å„ç§åŸå› ï¼ˆå¦‚æ‰‹åŠ¨ä¿®æ”¹ï¼‰é›†ç¾¤ä¸Šèµ„æºçš„å®æ—¶çŠ¶æ€è€Œå¯¼è‡´ä¸ GitRepo ä¸åŒ¹é…æ—¶ï¼Œè‡ªåŠ¨å°†å®é™…çŠ¶æ€ä¸ GitRepo çš„æœŸæœ›çŠ¶æ€åŒæ­¥ã€‚ä¸å‹¾é€‰æ—¶ï¼Œè™½ç„¶ä¹Ÿä¼šè¿›è¡Œè‡ªåŠ¨åŒæ­¥çš„æ¢æµ‹ï¼Œä½†æ˜¯åªæœ‰å½“GitRepoä¸­æ¸…å•å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰ä¼šè§¦å‘k8sèµ„æºå˜æ›´ã€‚</li><li>è‡ªåŠ¨åŒæ­¥æ—¶é—´é—´éš”ï¼šé»˜è®¤180sã€‚è¯¦æƒ…å‚è€ƒæ–‡æ¡£<a href="https://github.com/argoproj/argo-cd/issues/8378">Automated Sync Policy default interval value</a></li></ul><p>SYNC OPTIONSï¼š<br>â€‹- SKIP SCHEMA VALIDATIONâ€‹â€‹ï¼šæ˜¯å¦æ‰§è¡Œèµ„æºè§„èŒƒæ ¼å¼çš„æ ¡éªŒã€‚<br>â€‹â€‹- AUTO-CREATE NAMESPACEâ€‹â€‹ï¼šè‡ªåŠ¨åˆ›å»ºå‘½åç©ºé—´ã€‚<br>â€‹â€‹- PRUNE LASTâ€‹â€‹ï¼šåœ¨åŒæ­¥æ“ä½œçš„æœ€ååœ¨æ‰§è¡Œä¿®å‰ªæ“ä½œï¼Œå³å…¶ä»–èµ„æºå·²ç»éƒ¨ç½²ä¸”è½¬ä¸ºå¥åº·çŠ¶æ€åå†è¿›è¡Œ prune<br>â€‹â€‹- APPLY OUT OF SYNC ONLYâ€‹â€‹â€‹ï¼šä»…å¯¹é‚£äº›å¤„äº â€‹â€‹OutOfSyncâ€‹â€‹â€‹ çŠ¶æ€çš„èµ„æºæ‰§è¡ŒåŒæ­¥æ“ä½œã€‚<br>â€‹â€‹- REPLACEâ€‹â€‹ï¼šå°†ä½¿ç”¨ kubectl replace/create å‘½ä»¤åŒæ­¥èµ„æºï¼Œè€Œéé»˜è®¤çš„ apply<br>â€‹â€‹- PRUNE PROPAGATION POLICYâ€‹â€‹ï¼šèµ„æºä¿®å‰ªä¼ æ’­ç­–ç•¥ï¼Œé»˜è®¤å€¼ä½¿ç”¨ foreground ç­–ç•¥ï¼Œè¿˜æœ‰ background å’Œ orphan<br>â€‹â€‹- RESPECT IGNORE DIFFERENCESâ€‹â€‹â€‹ï¼šåœ¨åŒæ­¥é˜¶æ®µå¿½ç•¥æœŸæœ›çŠ¶æ€çš„å­—æ®µã€‚ä¾‹å¦‚æˆ‘ä»¬æœ‰ä¸ª deploymentï¼Œé‡Œé¢çš„ replicas ä¸º 20ï¼Œä»£è¡¨æˆ‘ä»¬æœŸæœ›çš„ pod æ•°é‡ä¸º 20 ä¸ªï¼Œä½†å¦‚æœæˆ‘ä»¬è¿›è¡Œç°åº¦å‘å¸ƒçš„æ—¶å€™ï¼Œå¯èƒ½å¤šï¼Œä¹Ÿå¯èƒ½å°‘ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœä¸å‹¾é€‰ â€‹â€‹RESPECT IGNORE DIFFERENCESâ€‹â€‹ ï¼Œå°±ä¼šå¯¼è‡´ç°åº¦å‘å¸ƒå‡ºç°é—®é¢˜ï¼Œæ‰€ä»¥è¿™æ—¶å€™æˆ‘ä»¬æœ€å¥½æ˜¯å‹¾é€‰ä¸Šè¯¥å‚æ•°ã€‚</p><h2 id="èµ„æºåˆ›å»º-å˜æ›´"><a href="#èµ„æºåˆ›å»º-å˜æ›´" class="headerlink" title="èµ„æºåˆ›å»º/å˜æ›´"></a>èµ„æºåˆ›å»º/å˜æ›´</h2><p>é…ç½®å®Œæˆï¼Œç‚¹å‡»åŒæ­¥ï¼Œargocdå°±ä¼šä»gitä»“åº“è·å–æœ€æ–°çš„é…ç½®æ¸…å•ï¼Œapplyåˆ°k8sé›†ç¾¤ã€‚<br>å¦‚æœé…ç½®äº†è‡ªåŠ¨åŒæ­¥ï¼Œé‚£ä¹ˆé»˜è®¤3åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥ä¸€æ¬¡ï¼Œå¯ä»¥ä¿®æ”¹<code>timeout.reconciliation</code>å­—æ®µä¿®æ”¹åŒæ­¥é—´éš”ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;Argo-CDæ˜¯å•¥ï¼Ÿ&quot;&gt;&lt;a href=&quot;#Argo-CDæ˜¯å•¥ï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;Argo CDæ˜¯å•¥ï¼Ÿ&quot;&gt;&lt;/a&gt;Argo CDæ˜¯å•¥ï¼Ÿ&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;What Is Argo CD? Argo CD is a declarative, GitOps continuous delivery tool for Kubernetes.&lt;br&gt;Why Argo CD? Application definitions, configurations, and environments should be declarative and version controlled. Application deployment and lifecycle management should be automated, auditable, and easy to understand.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Argo CDæ˜¯ä»€ä¹ˆï¼ŸArgo CDæ˜¯ä¸€ä¸ªå£°æ˜å¼çš„åŸºäºGitOpsçš„ç”¨äºK8Sçš„æŒç»­äº¤ä»˜å·¥å…·ã€‚&lt;br&gt;ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Argo CDï¼Ÿåº”ç”¨å®šä¹‰ã€é…ç½®å’Œç¯å¢ƒéƒ½åº”è¯¥è¢«å£°æ˜å’Œç‰ˆæœ¬æ§åˆ¶ã€‚åº”ç”¨éƒ¨ç½²å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†éƒ½åº”è¯¥æ˜¯è‡ªåŠ¨çš„ã€å¯å®¡è®¡çš„ã€æ˜“ç†è§£çš„ã€‚&lt;/p&gt;
&lt;p&gt;Argo CD éµå¾ª GitOps æ¨¡å¼ï¼Œä½¿ç”¨ Git ä»“åº“ä½œä¸ºå®šä¹‰æ‰€éœ€åº”ç”¨ç¨‹åºçŠ¶æ€çš„çœŸå®æ¥æºï¼ŒArgo CD æ”¯æŒå¤šç§ Kubernetes æ¸…å•ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;kustomize&lt;/li&gt;
&lt;li&gt;helm charts&lt;/li&gt;
&lt;li&gt;ksonnet applications&lt;/li&gt;
&lt;li&gt;jsonnet files&lt;/li&gt;
&lt;li&gt;Plain directory of YAML/json manifests&lt;/li&gt;
&lt;li&gt;Any custom config management tool configured as a config management plugin&lt;br&gt;Argo CD å¯åœ¨æŒ‡å®šçš„ç›®æ ‡ç¯å¢ƒä¸­è‡ªåŠ¨éƒ¨ç½²æ‰€éœ€çš„åº”ç”¨ç¨‹åºçŠ¶æ€ï¼Œåº”ç”¨ç¨‹åºéƒ¨ç½²å¯ä»¥åœ¨ Git æäº¤æ—¶è·Ÿè¸ªå¯¹åˆ†æ”¯ã€æ ‡ç­¾çš„æ›´æ–°ï¼Œæˆ–å›ºå®šåˆ°æ¸…å•çš„æŒ‡å®šç‰ˆæœ¬ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å‚è€ƒæ–‡æ¡£ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://argo-cd.readthedocs.io/en/stable/&quot;&gt;Argo CDå®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.qikqiak.com/k8strain2/devops/gitops/argocd/&quot;&gt;Argo CD&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="engineering" scheme="https://www.voidking.com/categories/engineering/"/>
    
    <category term="k8s" scheme="https://www.voidking.com/categories/engineering/k8s/"/>
    
    <category term="devops" scheme="https://www.voidking.com/categories/engineering/devops/"/>
    
    <category term="cloudnative" scheme="https://www.voidking.com/categories/engineering/cloudnative/"/>
    
    
    <category term="k8s" scheme="https://www.voidking.com/tags/k8s/"/>
    
    <category term="argocd" scheme="https://www.voidking.com/tags/argocd/"/>
    
    <category term="cicd" scheme="https://www.voidking.com/tags/cicd/"/>
    
    <category term="devops" scheme="https://www.voidking.com/tags/devops/"/>
    
  </entry>
  
  <entry>
    <title>GitLab CIæŠ¥é”™no space left on device</title>
    <link href="https://www.voidking.com/dev-gitlab-ci-no-space-left-on-device/"/>
    <id>https://www.voidking.com/dev-gitlab-ci-no-space-left-on-device/</id>
    <published>2022-09-08T20:00:00.000Z</published>
    <updated>2022-10-13T20:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h1><p>gitlab CIä»»åŠ¡ï¼Œæ‹‰åŸºç¡€é•œåƒçš„æ—¶å€™æŠ¥é”™no space left on deviceï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">failed to register layer: Error processing tar file(exit status 1): write /root/miniconda3/envs/cv/lib/python3.7/site-packages/xxx.so: no space left on device</span><br></pre></td></tr></table></figure><span id="more"></span><h1 id="æ’æŸ¥æ€è·¯"><a href="#æ’æŸ¥æ€è·¯" class="headerlink" title="æ’æŸ¥æ€è·¯"></a>æ’æŸ¥æ€è·¯</h1><p>é—®é¢˜åŸå› çŒœæµ‹ï¼š</p><ul><li>å¶å‘é—®é¢˜ï¼Ÿç¡®è®¤æ˜¯å¦èƒ½ç¨³å®šå¤ç°</li><li>ç£ç›˜ç©ºé—´é—®é¢˜ï¼Ÿç¡®è®¤runneræ‰€åœ¨ä¸»æœºçš„ç£ç›˜ç©ºé—´</li><li>CICDé…ç½®é—®é¢˜ï¼Ÿç¡®è®¤CICDé…ç½®ï¼Œæ£€æŸ¥ç”¨æ³•æ˜¯å¦æ­£ç¡®</li><li>runneré—®é¢˜ï¼Ÿé‡å¯runnerï¼Œå†æ¬¡å°è¯•å¤ç°</li></ul><p>æ’æŸ¥ç¡®è®¤ï¼š</p><ul><li>é—®é¢˜å¶å‘å¤ç°ï¼Œéƒ½æ˜¯åœ¨åŒä¸€ä¸ªrunneræ‰€åœ¨ä¸»æœº</li><li>runneræ‰€åœ¨ä¸»æœºçš„ç£ç›˜ç©ºé—´å……è¶³</li><li>CICDé…ç½®æ­£ç¡®</li><li>é‡å¯runneråæ— æ³•å¤ç°ï¼Œé—®é¢˜è§£å†³äº†ï¼Œè¯´æ˜æ˜¯runneré—®é¢˜ã€‚ä½†æ˜¯è¿‡å‡ å¤©ä¼šå†æ¬¡å¤ç°ï¼Œéœ€è¦ç»§ç»­å®šä½æ ¹å› ã€‚</li></ul><h1 id="runneré—®é¢˜æ’æŸ¥"><a href="#runneré—®é¢˜æ’æŸ¥" class="headerlink" title="runneré—®é¢˜æ’æŸ¥"></a>runneré—®é¢˜æ’æŸ¥</h1><p>å‡ºé—®é¢˜çš„runnerï¼Œä½¿ç”¨çš„æ‰§è¡Œå™¨æ˜¯ <code>docker machine executor</code><br>docker machineç±»å‹çš„æ‰§è¡Œå™¨ï¼Œç‰¹ç‚¹æ˜¯å…ˆåˆ›å»ºVMï¼Œç„¶ååœ¨VMä¸­æ‰§è¡Œä½œä¸šã€‚<br>äº†è§£äº†è¿™ä¸ªç‰¹ç‚¹ï¼Œæˆ‘ä»¬å°±èƒ½çŸ¥é“æŠ¥é”™ç£ç›˜æ»¡çš„å¹¶ä¸æ˜¯runneræ‰€åœ¨å®¿ä¸»æœºï¼Œè€Œæ˜¯å®é™…æ‰§è¡Œä½œä¸šçš„VMã€‚</p><p>1ã€ç™»å½•åˆ°æ‰§è¡Œä½œä¸šçš„VMè¿›è¡Œç¡®è®¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker-machine <span class="built_in">ls</span></span><br><span class="line">docker-machine ssh xxx</span><br><span class="line"><span class="built_in">df</span> -h</span><br></pre></td></tr></table></figure><p>ç»ç¡®è®¤ï¼Œç¡®å®æ˜¯æ‰§è¡Œä½œä¸šçš„VMç£ç›˜æ»¡äº†ã€‚å› ä¸ºrunneræ‰€åœ¨å®¿ä¸»æœºç£ç›˜å……è¶³ï¼Œå› æ­¤è§£å†³åŠæ³•æ˜¯ç»™VMæ‰©ç£ç›˜ã€‚</p><p>2ã€VMç£ç›˜æ‰©å®¹<br>å› æ­¤VMæ˜¯å—runnerç®¡ç†çš„ï¼Œæ‰€ä»¥æœ€å¥½ä¸è¦é€šè¿‡<code>docker-machine</code>å‘½ä»¤æ‰‹åŠ¨æ‰©å®¹ï¼Œè€Œæ˜¯é€šè¿‡ä¿®æ”¹runneré…ç½®æ¥ä¿®æ”¹ã€‚</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim <span class="regexp">/etc/gi</span>tlab-runner/config.toml</span><br></pre></td></tr></table></figure><p>config.tomlä¸­çš„<code>virtualbox-disk-size</code>ä¿®æ”¹åˆ°æœŸæœ›çš„å€¼ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  [runners.machine]</span><br><span class="line">    IdleCount = 5</span><br><span class="line">    MaxGrowthRate = 1</span><br><span class="line">    IdleTime = 1800</span><br><span class="line">    MachineDriver = &quot;virtualbox&quot;</span><br><span class="line">    MachineName = &quot;auto-scale-%s&quot;</span><br><span class="line">    MachineOptions = [</span><br><span class="line">      &quot;engine-registry-mirror=http://xxxxxx:5000&quot;,</span><br><span class="line">      &quot;virtualbox-memory=4048&quot;,</span><br><span class="line">      &quot;virtualbox-disk-size=204800&quot;,</span><br><span class="line">      &quot;virtualbox-cpu-count=2&quot;</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure><p>3ã€é‡å¯runner</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gitlab-runner restart</span><br><span class="line">docker-machine <span class="built_in">ls</span></span><br></pre></td></tr></table></figure><p>é‡å¯runneråï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°VMè¢«é‡å»ºäº†ã€‚</p><p>4ã€ç¡®è®¤ç£ç›˜å¤§å°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-machine ssh xxx</span><br><span class="line"><span class="built_in">df</span> -h</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šï¼Œé—®é¢˜è§£å†³ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;é—®é¢˜æè¿°&quot;&gt;&lt;a href=&quot;#é—®é¢˜æè¿°&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜æè¿°&quot;&gt;&lt;/a&gt;é—®é¢˜æè¿°&lt;/h1&gt;&lt;p&gt;gitlab CIä»»åŠ¡ï¼Œæ‹‰åŸºç¡€é•œåƒçš„æ—¶å€™æŠ¥é”™no space left on deviceï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight text&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;failed to register layer: Error processing tar file(exit status 1): write /root/miniconda3/envs/cv/lib/python3.7/site-packages/xxx.so: no space left on device&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="engineering" scheme="https://www.voidking.com/categories/engineering/"/>
    
    <category term="devops" scheme="https://www.voidking.com/categories/engineering/devops/"/>
    
    <category term="troubleshooting" scheme="https://www.voidking.com/categories/engineering/troubleshooting/"/>
    
    <category term="git" scheme="https://www.voidking.com/categories/engineering/git/"/>
    
    
    <category term="é—®é¢˜æ’æŸ¥" scheme="https://www.voidking.com/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"/>
    
    <category term="git" scheme="https://www.voidking.com/tags/git/"/>
    
    <category term="cicd" scheme="https://www.voidking.com/tags/cicd/"/>
    
    <category term="gitlab" scheme="https://www.voidking.com/tags/gitlab/"/>
    
  </entry>
  
  <entry>
    <title>GitLab CI/CDå…¥é—¨ç¯‡</title>
    <link href="https://www.voidking.com/dev-gitlab-cicd/"/>
    <id>https://www.voidking.com/dev-gitlab-cicd/</id>
    <published>2022-09-08T20:00:00.000Z</published>
    <updated>2023-02-21T14:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="GitLab-CI-CDæ˜¯å•¥ï¼Ÿ"><a href="#GitLab-CI-CDæ˜¯å•¥ï¼Ÿ" class="headerlink" title="GitLab CI/CDæ˜¯å•¥ï¼Ÿ"></a>GitLab CI/CDæ˜¯å•¥ï¼Ÿ</h1><p>CIï¼ŒCONTINUOUS INTEGRATIONï¼ŒæŒç»­é›†æˆã€‚ç®€å•æ¥è¯´å°±æ˜¯è‡ªåŠ¨åŒ–æ„å»ºå’Œæµ‹è¯•ã€‚<br>ä¸€ä¸ªåº”ç”¨ç¨‹åºçš„ä»£ç å­˜å‚¨åœ¨Gitä»“åº“ä¸­ã€‚å¼€å‘äººå‘˜æ¨é€çš„æ¯ä¸ªæ›´æ”¹ï¼Œç”šè‡³æ˜¯å¼€å‘åˆ†æ”¯ï¼Œéƒ½å¯ä»¥é€šè¿‡ä¸€ç»„è„šæœ¬æ¥è‡ªåŠ¨åœ°æ„å»ºå’Œæµ‹è¯•ã€‚è¿™äº›æµ‹è¯•å¯ç¡®ä¿æ›´æ”¹é€šè¿‡æ‚¨ä¸ºåº”ç”¨ç¨‹åºå»ºç«‹çš„æ‰€æœ‰æµ‹è¯•ã€æŒ‡å—å’Œä»£ç åˆè§„æ€§æ ‡å‡†ã€‚</p><p>CDï¼ŒCONTINUOUS DELIVERYï¼ŒæŒç»­äº¤ä»˜ã€‚ç®€å•æ¥è¯´å°±æ˜¯è‡ªåŠ¨åŒ–æ„å»ºå’Œæµ‹è¯•+æ”¯æŒæ‰‹åŠ¨è§¦å‘éƒ¨ç½²ã€‚<br>æ¯æ¬¡å°†ä»£ç æ›´æ”¹æ¨é€åˆ°ä»£ç åº“æ—¶ï¼Œä¸ä»…ä¼šè‡ªåŠ¨æ„å»ºå’Œæµ‹è¯•åº”ç”¨ç¨‹åºï¼Œè¿˜æ”¯æŒä¸€é”®éƒ¨ç½²åº”ç”¨ç¨‹åºï¼Œè¿™é‡Œçš„éƒ¨ç½²éœ€è¦æ‰‹åŠ¨è§¦å‘ã€‚</p><p>CDï¼ŒCONTINUOUS DEPLOYMENTï¼ŒæŒç»­éƒ¨ç½²ã€‚ç®€å•æ¥è¯´å°±æ˜¯è‡ªåŠ¨åŒ–æ„å»ºå’Œæµ‹è¯•+è‡ªåŠ¨éƒ¨ç½²ã€‚<br>æŒç»­éƒ¨ç½²ç±»ä¼¼äºæŒç»­äº¤ä»˜ï¼Œä¸åŒä¹‹å¤„åœ¨äºï¼Œä¸æ˜¯æ‰‹åŠ¨è§¦å‘éƒ¨ç½²åº”ç”¨ç¨‹åºï¼Œè€Œæ˜¯å°†å…¶è®¾ç½®ä¸ºè‡ªåŠ¨éƒ¨ç½²ã€‚</p><p>è€ŒGitLab CI/CDï¼Œå°±æ˜¯ä¸€ç§æ”¯æŒåœ¨GitLabä¸­é…ç½®ä½¿ç”¨æŒç»­é›†æˆã€æŒç»­äº¤ä»˜å’ŒæŒç»­éƒ¨ç½²çš„å·¥å…·ã€‚</p><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://docs.gitlab.com/ee/ci/">GitLab CI/CD Document</a></li><li><a href="https://docs.gitlab.cn/jh/ci/">GitLab CI/CD ä¸­æ–‡æ–‡æ¡£</a></li><li><a href="https://docs.gitlab.cn/jh/ci/introduction/index.html">CI/CD æ¦‚å¿µ</a></li><li><a href="http://www.ttlsa.com/news/ci-cd-cd/">è¯¦è§£CIã€CD &amp; CD</a></li><li><a href="https://linux.cn/article-9926-1.html">ä»€ä¹ˆæ˜¯ CI/CDï¼Ÿ</a></li><li><a href="https://en.wikipedia.org/wiki/Deployment_environment">Deployment environment</a></li></ul><span id="more"></span><h1 id="GitLab-CI-CDåŸºæœ¬æ¦‚å¿µ"><a href="#GitLab-CI-CDåŸºæœ¬æ¦‚å¿µ" class="headerlink" title="GitLab CI/CDåŸºæœ¬æ¦‚å¿µ"></a>GitLab CI/CDåŸºæœ¬æ¦‚å¿µ</h1><ul><li>pipelineï¼šåœ¨æ¯ä¸ªä»“åº“ä¸­ï¼Œä½¿ç”¨åä¸º<code>.gitlab-ci.yml</code>çš„yamlæ–‡ä»¶é…ç½®gitlab ci/cdæµæ°´çº¿ï¼ˆpipelineï¼‰</li><li>stageï¼šä¸€æ¡æµæ°´çº¿å¯ä»¥åŒ…å«å¤šä¸ªé˜¶æ®µï¼ˆstageï¼‰ï¼Œä¸€ä¸ªé˜¶æ®µå¯ä»¥åŒ…å«å¤šä¸ªä½œä¸š</li><li>jobï¼šä½œä¸šï¼ˆjobï¼‰æ˜¯å…·ä½“è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ˜¯å‘½ä»¤è„šæœ¬è¯­å¥çš„é›†åˆ</li><li>runnerï¼šrunneræ˜¯æ¯ä¸ªä½œä¸šçš„æ‰§è¡ŒèŠ‚ç‚¹ï¼›æ¯ä¸ªä½œä¸šå¯ä»¥æ ¹æ®æ ‡ç­¾é€‰æ‹©ä¸åŒçš„æ‰§è¡ŒèŠ‚ç‚¹</li></ul><h1 id="Gitlab-CI-CDå·¥ä½œæœºåˆ¶"><a href="#Gitlab-CI-CDå·¥ä½œæœºåˆ¶" class="headerlink" title="Gitlab CI/CDå·¥ä½œæœºåˆ¶"></a>Gitlab CI/CDå·¥ä½œæœºåˆ¶</h1><p>1ã€åœ¨gitlabä»“åº“ä¸­æ·»åŠ <code>.gitlab-ci.yml</code>æ–‡ä»¶ï¼Œå®šä¹‰æµæ°´çº¿  </p><p>2ã€å½“ä»“åº“ä¸­å‘ç”Ÿcommitã€pushã€mergeç­‰äº‹ä»¶æ—¶ï¼Œæ ¹æ®<code>.gitlab-ci.yml</code>çš„å®šä¹‰è§¦å‘æµæ°´çº¿  </p><p>3ã€æµæ°´çº¿ä¼šè°ƒç”¨gitlab runnerï¼Œåœ¨gitlab runnerä¸­æŒ‰ç…§<code>.gitlab-ci.yml</code>çš„å®šä¹‰è·‘ä½œä¸š</p><h1 id="GitLab-CI-CDæµæ°´çº¿è¯­æ³•"><a href="#GitLab-CI-CDæµæ°´çº¿è¯­æ³•" class="headerlink" title="GitLab CI/CDæµæ°´çº¿è¯­æ³•"></a>GitLab CI/CDæµæ°´çº¿è¯­æ³•</h1><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://docs.gitlab.com/ee/ci/yaml/gitlab_ci_yaml.html">The .gitlab-ci.yml file</a></li><li><a href="https://docs.gitlab.com/ee/ci/yaml/">.gitlab-ci.yml keyword reference</a></li><li><a href="https://docs.gitlab.cn/jh/ci/yaml/">.gitlab-ci.yml å…³é”®å­—å‚è€ƒ</a></li><li><a href="https://zhuanlan.zhihu.com/p/510820543">GitLabCI-CDæµæ°´çº¿è¯­æ³•</a></li></ul><h2 id="å…¸å‹ç¤ºä¾‹"><a href="#å…¸å‹ç¤ºä¾‹" class="headerlink" title="å…¸å‹ç¤ºä¾‹"></a>å…¸å‹ç¤ºä¾‹</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stages:</span> <span class="comment">#å¯¹stagesçš„ç¼–æ’</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">DEPLOY_ENV:</span> <span class="string">&quot;dev&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ciinit:</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">.pre</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Pipeline init first job&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ciend:</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">.post</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Pipeline end job&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">before_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Before script section&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;For example you might run an update here or install a build dependency&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Or perhaps you might print out some debugging details&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">after_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;After script section&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;For example you might do some cleanup here&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">k8s</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Do your build here&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test1:</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">k8s</span>  </span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Do a test here&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;For example run a test suite&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test2:</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">k8s</span>  </span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Do a test here&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;For example run a test suite&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">k8s</span>  </span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">DEPLOY_ENV:</span> <span class="string">&quot;test&quot;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;$&#123;DEPLOY_ENV&#125;&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Do your deploy here&quot;</span></span><br></pre></td></tr></table></figure><h2 id="stagesé˜¶æ®µæ§åˆ¶"><a href="#stagesé˜¶æ®µæ§åˆ¶" class="headerlink" title="stagesé˜¶æ®µæ§åˆ¶"></a>stagesé˜¶æ®µæ§åˆ¶</h2><ul><li>stagesé‡Œå¯ä»¥å®šä¹‰å„ä¸ªstageæ‰§è¡Œçš„å‰åé¡ºåºï¼Œä½†æ˜¯<code>.pre</code>å’Œ<code>.post</code>é˜¶æ®µä¸å—å…¶æ§åˆ¶</li><li><code>.pre</code>é˜¶æ®µçš„ä½œä¸šæ€»æ˜¯åœ¨æµæ°´çº¿å¼€å§‹æ—¶æ‰§è¡Œ</li><li><code>.post</code>é˜¶æ®µçš„ä½œä¸šæ€»æ˜¯åœ¨æµæ°´çº¿ç»“æŸæ—¶æ‰§è¡Œ</li><li>å¦‚æœä¸¤ä¸ªæˆ–è€…å¤šä¸ªä½œä¸šï¼ŒæŒ‡å‘åŒä¸€ä¸ªé˜¶æ®µåç§°ï¼Œåˆ™è¯¥é˜¶æ®µä¸‹çš„æ‰€æœ‰ä½œä¸šéƒ½å¹¶è¡Œè¿è¡Œï¼›å¦‚æœä¸èƒ½å¹¶è¡Œè¿è¡Œï¼Œéœ€è¦æ£€æŸ¥runnerçš„é…ç½®æ–‡ä»¶ä¸­çš„<code>concurrent</code></li></ul><h2 id="variablesç¯å¢ƒå˜é‡"><a href="#variablesç¯å¢ƒå˜é‡" class="headerlink" title="variablesç¯å¢ƒå˜é‡"></a>variablesç¯å¢ƒå˜é‡</h2><p>ç¯å¢ƒå˜é‡å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼šå…¨å±€å˜é‡å’Œå±€éƒ¨å˜é‡ï¼Œå±€éƒ¨å˜é‡ä¼˜å…ˆçº§é«˜äºå…¨å±€å˜é‡</p><ul><li>å…¨å±€å˜é‡æ˜¯æ•´ä¸ªæµæ°´çº¿ç”Ÿæ•ˆçš„ï¼Œå±€éƒ¨å˜é‡æ˜¯ä»…åœ¨ä½œä¸šä¸­ç”Ÿæ•ˆçš„</li><li>å…¨å±€å˜é‡å¯ä»¥ä½¿ç”¨CIè‡ªå¸¦çš„é¢„å®šä¹‰å˜é‡ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰å˜é‡</li><li>å…¨å±€å˜é‡å®šä¹‰åœ¨å…¨å±€ variables ä¸­ï¼Œä¹Ÿå¯ä»¥å®šä¹‰åœ¨ workflow:rules:variables ä¸­</li><li>å±€éƒ¨å˜é‡å®šä¹‰åœ¨ job:variables ä¸­ï¼Œä¹Ÿå¯ä»¥å®šä¹‰åœ¨ job:rules:variables ä¸­</li></ul><p>.gitlab-ci.ymlè§£æé¡ºåºä¸ºï¼šå…¨å±€å˜é‡ -&gt; workflowè§„åˆ™ -&gt; jobè§„åˆ™ï¼Œå› æ­¤ï¼šjobä¸­å˜é‡ä¼˜å…ˆçº§ &gt; workflowä¸­å˜é‡ä¼˜å…ˆçº§ &gt; å…¨å±€å˜é‡ä¼˜å…ˆçº§</p><p>å¸¸ç”¨å…¨å±€é¢„å®šä¹‰å˜é‡ï¼š</p><table><thead><tr><th align="left">å˜é‡åç§°</th><th align="center">GitLab</th><th align="center">GitLab Runner</th><th align="left">æè¿°</th></tr></thead><tbody><tr><td align="left">CI</td><td align="center">all</td><td align="center">0.4</td><td align="left">å¯¹CI/CDä¸­çš„æ‰€æœ‰ä½œä¸šå¯è§ï¼Œå€¼ä¸ºtrue</td></tr><tr><td align="left">CI_BUILDS_DIR</td><td align="center">all</td><td align="center">11.10</td><td align="left">æ„å»ºæ—¶çš„æœ€é¡¶å±‚ç›®å½•</td></tr><tr><td align="left">CI_COMMIT_AUTHOR</td><td align="center">13.11</td><td align="center">all</td><td align="left">æäº¤çš„ä½œè€…ï¼Œæ ¼å¼ä¸ºï¼šåç§°&lt;é‚®ç®±&gt;</td></tr><tr><td align="left">CI_COMMIT_BEFORE_SHA</td><td align="center">11.2</td><td align="center">all</td><td align="left">å½“å‰åˆ†æ”¯çš„ä¸Šä¸€ä¸ªæäº¤å“ˆå¸Œå€¼</td></tr><tr><td align="left">CI_COMMIT_BRANCH</td><td align="center">12.6</td><td align="center">0.5</td><td align="left">æäº¤çš„åˆ†æ”¯åï¼Œåœ¨åˆå¹¶æµæ°´çº¿å’Œtagæµæ°´çº¿æ—¶ä¸å¯è§</td></tr><tr><td align="left">CI_COMMIT_DESCRIPTION</td><td align="center">10.8</td><td align="center">all</td><td align="left">æäº¤çš„æè¿°</td></tr><tr><td align="left">CI_COMMIT_MESSAGE</td><td align="center">10.8</td><td align="center">all</td><td align="left">å®Œæ•´çš„æäº¤ä¿¡æ¯</td></tr><tr><td align="left">CI_COMMIT_REF_NAME</td><td align="center">9.0</td><td align="center">all</td><td align="left">é¡¹ç›®çš„åˆ†æ”¯åæˆ–tagå</td></tr><tr><td align="left">CI_COMMIT_REF_PROTECTED</td><td align="center">11.11</td><td align="center">all</td><td align="left">å¦‚æœä½œä¸šæ­£åœ¨æ„å»ºçš„æ˜¯è¢«ä¿æŠ¤çš„åˆ†æ”¯æˆ–tagï¼Œå€¼ä¸ºtrue</td></tr><tr><td align="left">CI_COMMIT_REF_SLUG</td><td align="center">9.0</td><td align="center">all</td><td align="left">CI_COMMIT_REF_NAMEçš„å°å†™å½¢å¼ã€‚</td></tr><tr><td align="left">CI_COMMIT_SHA</td><td align="center">9.0</td><td align="center">all</td><td align="left">æäº¤çš„å®Œæ•´å“ˆå¸Œå€¼</td></tr><tr><td align="left">CI_COMMIT_SHORT_SHA</td><td align="center">11.7</td><td align="center">all</td><td align="left">8ä¸ªå­—ç¬¦çš„æäº¤å“ˆå¸Œå€¼</td></tr><tr><td align="left">CI_COMMIT_TAG</td><td align="center">9.0</td><td align="center">0.5</td><td align="left">æäº¤çš„tagï¼Œä»…åœ¨tagæµæ°´çº¿å¯è§</td></tr><tr><td align="left">CI_COMMIT_TIMESTAMP</td><td align="center">13.4</td><td align="center">all</td><td align="left">æäº¤æ—¶çš„æ—¶é—´æˆ³</td></tr><tr><td align="left">CI_COMMIT_TITLE</td><td align="center">10.8</td><td align="center">all</td><td align="left">æäº¤çš„æ ‡é¢˜</td></tr><tr><td align="left">CI_DEFAULT_BRANCH</td><td align="center">12.4</td><td align="center">all</td><td align="left">é¡¹ç›®çš„é»˜è®¤åˆ†æ”¯</td></tr><tr><td align="left">CI_DEPLOY_FREEZE</td><td align="center">13.2</td><td align="center">all</td><td align="left">å½“æµæ°´è¿è¡Œæ˜¯å¤„äºéƒ¨ç½²å†»ç»“é˜¶æ®µæ—¶å¯è§ï¼Œå€¼ä¸ºtrueã€‚</td></tr><tr><td align="left">CI_ENVIRONMENT_NAME</td><td align="center">8.15</td><td align="center">all</td><td align="left">å½“å‰ä½œä¸šçš„éƒ¨ç½²ç¯å¢ƒåï¼Œå½“è®¾ç½®äº†environment:name æ—¶å¯è§</td></tr><tr><td align="left">CI_ENVIRONMENT_URL</td><td align="center">9.3</td><td align="center">all</td><td align="left">å½“å‰ä½œä¸šçš„éƒ¨ç½²ç¯å¢ƒåœ°å€ï¼Œåªæœ‰è®¾ç½®äº†environment:urlå¯è§</td></tr><tr><td align="left">CI_JOB_ID</td><td align="center">9.0</td><td align="center">all</td><td align="left">å½“å‰ä½œä¸šçš„IDï¼Œç³»ç»Ÿå†…å”¯ä¸€</td></tr><tr><td align="left">CI_JOB_IMAGE</td><td align="center">12.9</td><td align="center">12.9</td><td align="left">å½“å‰ä½œä¸šä½¿ç”¨çš„Dockeré•œåƒå</td></tr><tr><td align="left">CI_JOB_NAME</td><td align="center">9.0</td><td align="center">0.5</td><td align="left">å½“å‰ä½œä¸šåç§°</td></tr><tr><td align="left">CI_JOB_STAGE</td><td align="center">9.0</td><td align="center">0.5</td><td align="left">å½“å‰ä½œä¸šæ‰€å±çš„é˜¶æ®µå</td></tr><tr><td align="left">CI_PIPELINE_ID</td><td align="center">8.10</td><td align="center">all</td><td align="left">å½“å‰æµæ°´çº¿IDï¼ˆå®ä¾‹çº§ï¼‰ï¼Œç³»ç»Ÿå†…å”¯ä¸€</td></tr><tr><td align="left">CI_PIPELINE_SOURCE</td><td align="center">10.0</td><td align="center">all</td><td align="left">æµæ°´çº¿è§¦å‘æ–¹å¼ï¼Œæšä¸¾å€¼ä¸ºpush,web, schedule, api, external, chat, webide,merge_request_event, external_pull_request_event, parent_pipeline, trigger, æˆ–è€… pipeline</td></tr><tr><td align="left">CI_PIPELINE_TRIGGERED</td><td align="center">all</td><td align="center">all</td><td align="left">å½“ä½œä¸šæ˜¯ä½¿ç”¨triggerè§¦å‘çš„æ—¶ä¸ºtrue</td></tr><tr><td align="left">CI_PIPELINE_URL</td><td align="center">11.1</td><td align="center">0.5</td><td align="left">æµæ°´çº¿è¯¦æƒ…çš„åœ°å€</td></tr><tr><td align="left">CI_PIPELINE_CREATED_AT</td><td align="center">13.10</td><td align="center">all</td><td align="left">æµæ°´çº¿åˆ›å»ºæ—¶é—´</td></tr><tr><td align="left">CI_PROJECT_DIR</td><td align="center">all</td><td align="center">all</td><td align="left">å­˜æ”¾å…‹éš†é¡¹ç›®çš„å®Œæ•´è·¯å¾„ï¼Œä½œä¸šè¿è¡Œçš„ç›®å½•ã€‚</td></tr><tr><td align="left">CI_PROJECT_NAME</td><td align="center">8.10</td><td align="center">0.5</td><td align="left">å½“å‰é¡¹ç›®åç§°ï¼Œä¸åŒ…å«ç»„å</td></tr><tr><td align="left">CI_PROJECT_NAMESPACE</td><td align="center">8.10</td><td align="center">0.5</td><td align="left">é¡¹ç›®çš„å‘½åç©ºé—´ï¼ˆç»„åæˆ–ç”¨æˆ·åï¼‰</td></tr><tr><td align="left">CI_PROJECT_PATH</td><td align="center">8.10</td><td align="center">0.5</td><td align="left">åŒ…å«é¡¹ç›®åç§°çš„å‘½åç©ºé—´</td></tr><tr><td align="left">CI_PROJECT_TITLE</td><td align="center">12.4</td><td align="center">all</td><td align="left">é¡¹ç›®åç§°ï¼ˆç½‘é¡µä¸Šæ˜¾ç¤ºçš„ï¼‰</td></tr><tr><td align="left">CI_PROJECT_URL</td><td align="center">8.10</td><td align="center">0.5</td><td align="left">é¡¹ç›®HTTP(S)åœ°å€</td></tr><tr><td align="left">CI_RUNNER_TAGS</td><td align="center">8.10</td><td align="center">0.5</td><td align="left">é€—å·åˆ†å‰²çš„runneræ ‡ç­¾åˆ—è¡¨</td></tr><tr><td align="left">GITLAB_USER_EMAIL</td><td align="center">8.12</td><td align="center">all</td><td align="left">å¼€å§‹å½“å‰ä½œä¸šçš„ç”¨æˆ·é‚®ç®±</td></tr><tr><td align="left">GITLAB_USER_LOGIN</td><td align="center">10.0</td><td align="center">all</td><td align="left">å¼€å§‹å½“å‰ä½œä¸šçš„ç™»å½•ç”¨æˆ·å</td></tr><tr><td align="left">GITLAB_USER_NAME</td><td align="center">10.0</td><td align="center">all</td><td align="left">å¼€å§‹å½“å‰ä½œä¸šçš„ç”¨æˆ·å</td></tr><tr><td align="left">CI_MERGE_REQUEST_APPROVED ï¼ˆä»…åˆå¹¶æµæ°´çº¿ï¼‰</td><td align="center">14.1</td><td align="center">all</td><td align="left">å½“åˆå¹¶æµæ°´çº¿çš„MRè¢«é€šè¿‡æ—¶å€¼ä¸ºtrue</td></tr><tr><td align="left">CI_MERGE_REQUEST_ASSIGNEES ï¼ˆä»…åˆå¹¶æµæ°´çº¿ï¼‰</td><td align="center">11.9</td><td align="center">all</td><td align="left">é€—å·åˆ†å‰²çš„åˆå¹¶è¯·æ±‚æŒ‡æ´¾äººåˆ—è¡¨</td></tr><tr><td align="left">CI_MERGE_REQUEST_SOURCE_BRANCH_NAMEï¼ˆä»…åˆå¹¶æµæ°´çº¿ï¼‰</td><td align="center">11.6</td><td align="center">all</td><td align="left">åˆå¹¶è¯·æ±‚ä¸­çš„æºåˆ†æ”¯åç§°</td></tr><tr><td align="left">CI_MERGE_REQUEST_TARGET_BRANCH_NAMEï¼ˆä»…åˆå¹¶æµæ°´çº¿ï¼‰</td><td align="center">11.6</td><td align="center">all</td><td align="left">åˆå¹¶è¯·æ±‚ä¸­çš„ç›®æ ‡åˆ†æ”¯åç§°</td></tr><tr><td align="left">CI_MERGE_REQUEST_TITLEï¼ˆä»…åˆå¹¶æµæ°´çº¿ï¼‰</td><td align="center">11.9</td><td align="center">all</td><td align="left">åˆå¹¶è¯·æ±‚çš„æ ‡é¢˜</td></tr></tbody></table><p>é¢„å®šä¹‰å˜é‡è¯¦æƒ…å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://docs.gitlab.com/ee/ci/variables/predefined_variables.html">Predefined variables reference</a></li><li><a href="https://cloud.tencent.com/developer/article/1976361">GitLab CI/CDä¸­çš„å¸¸ç”¨é¢„è®¾å˜é‡</a></li></ul><h2 id="jobå…³é”®å­—"><a href="#jobå…³é”®å­—" class="headerlink" title="jobå…³é”®å­—"></a>jobå…³é”®å­—</h2><ul><li>variablesï¼šå®šä¹‰ä½œä¸šä¸­çš„ç¯å¢ƒå˜é‡</li><li>tagsï¼šæ ¹æ®æ ‡ç­¾é€‰æ‹©è¿è¡Œä½œä¸šçš„èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰å¤šä¸ªæ ‡ç­¾ï¼Œåˆ™åŒ¹é…å…·æœ‰æ‰€æœ‰æ ‡ç­¾çš„èŠ‚ç‚¹</li><li>stageï¼šæŒ‡å®šå½“å‰ä½œä¸šæ‰€å±çš„é˜¶æ®µåç§°</li><li>before_scriptï¼šä½œä¸šåœ¨è¿è¡Œå‰æ‰§è¡Œçš„Shellå‘½ä»¤è¡Œ</li><li>scriptï¼šä½œä¸šåœ¨è¿è¡Œä¸­æ‰§è¡Œçš„Shellå‘½ä»¤è¡Œï¼Œæ¯ä¸ªä½œä¸šè‡³å°‘è¦åŒ…å«ä¸€ä¸ªscript</li><li>after_scriptï¼šä½œä¸šåœ¨è¿è¡Œåæ‰§è¡Œçš„Shellå‘½ä»¤è¡Œ</li><li>onlyï¼šä½œä¸šæ§åˆ¶ï¼Œæ»¡è¶³æ¡ä»¶æ—¶æ‰§è¡Œ</li><li>exceptï¼šä½œä¸šæ§åˆ¶ï¼Œæ»¡è¶³æ¡ä»¶æ—¶ä¸æ‰§è¡Œ</li><li>rulesï¼šä½œä¸šæ§åˆ¶ï¼Œ12.3ä¹‹åå¼•å…¥çš„ç‰¹æ€§ï¼Œä¸èƒ½ä¸only/exceptæ··ç”¨ï¼Œå…·ä½“ç”¨æ³•å‚è€ƒã€jobs:rulesä½œä¸šæ§åˆ¶ã€‘ä¸€èŠ‚</li></ul><p>æœ‰äº†before_scriptã€scriptã€å’Œafter_scriptï¼Œå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬æŠŠé€šç”¨çš„è„šæœ¬æŠ½è±¡å‡ºæ¥ã€‚</p><ul><li>before_scriptï¼šæœ‰å‘½ä»¤æ‰§è¡Œç»“æœé0ï¼Œjobåˆ¤å®šå¤±è´¥ï¼Œä¸å†æ‰§è¡Œbefore_scriptçš„åç»­å‘½ä»¤ï¼Œè·³è¿‡scriptï¼Œç»§ç»­æ‰§è¡Œafter_script</li><li>scriptï¼šæœ‰å‘½ä»¤æ‰§è¡Œç»“æœä¸º0ï¼Œjobåˆ¤å®šå¤±è´¥ï¼Œä¸å†æ‰§è¡Œscriptçš„åç»­å‘½ä»¤ï¼Œç»§ç»­æ‰§è¡Œafter_script</li><li>after_scriptï¼šæœ‰å‘½ä»¤æ‰§è¡Œç»“æœé0ï¼Œjobåˆ¤å®šä¸å—å½±å“ï¼Œä¸å†æ‰§è¡Œafter_scriptåç»­å‘½ä»¤</li></ul><h2 id="job-rulesä½œä¸šæ§åˆ¶"><a href="#job-rulesä½œä¸šæ§åˆ¶" class="headerlink" title="job:rulesä½œä¸šæ§åˆ¶"></a>job:rulesä½œä¸šæ§åˆ¶</h2><p>ä½¿ç”¨ job:rules å…³é”®å­—æ¥æ§åˆ¶ä½•æ—¶åˆ›å»ºä½œä¸šã€‚</p><p>rulesåŒ…å«ä»¥ä¸‹å­å…³é”®å­—ï¼š</p><ul><li>ifï¼šæ¡ä»¶åˆ¤æ–­ï¼Œä¸ºtrueæ—¶å†çœ‹å¯¹åº”çš„å…¶ä»–è§„åˆ™ã€‚<ul><li>ifçš„è¯­æ³•å’Œbashä¸­çš„ifè¯­æ³•å¾ˆåƒ</li><li>ä¸åŒ1ï¼šæ¨¡å¼åŒ¹é…æ—¶æ·»åŠ äº†ä¸¤ä¸ªæ–œæ </li><li>ä¸åŒ2ï¼šå˜é‡ä¸èƒ½åŠ èŠ±æ‹¬å·ï¼ˆç‰ˆæœ¬14.0.5ï¼‰</li></ul></li><li>whenï¼šå‰é¢çš„ä½œä¸šæˆåŠŸæˆ–è€…å¤±è´¥æ—¶è¿è¡Œã€‚on_successï¼ˆé»˜è®¤å€¼ï¼‰å‰é¢ä½œä¸šæˆåŠŸæ—¶æ‰§è¡Œï¼›on_failure å‰é¢ä½œä¸šå¤±è´¥æ—¶æ‰§è¡Œï¼›always æ€»æ˜¯æ‰§è¡Œï¼›manual æ‰‹åŠ¨æ‰§è¡Œï¼›delayed&amp;start_in å»¶è¿Ÿæ‰§è¡Œï¼›never æ°¸ä¸æ‰§è¡Œã€‚</li><li>allow_failureï¼šæ˜¯å¦å…è®¸ä½œä¸šå¤±è´¥ï¼Œé»˜è®¤å€¼ä¸ºfalseã€‚å¯ç”¨åï¼Œä½œä¸šå¤±è´¥ä¸ä¼šé˜»å¡æ¥ä¸‹æ¥çš„ä»»åŠ¡ã€‚</li><li>retryï¼šä½œä¸šé‡åˆ°é”™è¯¯é‡æ–°è¿è¡Œçš„æ¬¡æ•°ã€‚</li><li>timeoutï¼šä½œä¸šè¿è¡Œè¶…æ—¶æ—¶é—´ã€‚</li><li>needsï¼šä½œä¸šä¾èµ–æ§åˆ¶ã€‚å½“å‰ä½œä¸šå¯èƒ½åªä¾èµ–å‰ä¸€ä¸ªstageçš„å…¶ä¸­ä¸€ä¸ªä½œä¸šï¼Œå°±ä¸ç”¨ç­‰å‰ä¸€ä¸ªstageçš„ä½œä¸šå…¨éƒ¨å®Œæˆã€‚</li><li>parallelï¼šç”Ÿæˆå¤šä¸ªä½œä¸šï¼Œå¹¶è¡Œè¿è¡Œã€‚å€¼åœ¨<code>2-50</code>ä¹‹é—´ã€‚</li><li>variablesï¼šå®šä¹‰ç‰¹å®šä½œä¸šæ¡ä»¶ä¸‹çš„å˜é‡ã€‚</li></ul><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://my.oschina.net/zeyangli/blog/4346888">GitLabCIç³»åˆ—ä¹‹æµæ°´çº¿è¯­æ³•ç¬¬ä¸‰éƒ¨åˆ†</a></li><li><a href="https://docs.gitlab.com/ee/ci/jobs/job_control.html">Choose when to run jobs</a></li><li><a href="https://docs.gitlab.cn/jh/ci/jobs/job_control.html">é€‰æ‹©ä½•æ—¶è¿è¡Œä½œä¸š</a></li><li><a href="https://docs.gitlab.cn/jh/ci/yaml/index.html#rules">.gitlab-ci.yml å…³é”®å­—å‚è€ƒ - rules</a></li></ul><h2 id="workflow-rulesæµæ°´çº¿æ§åˆ¶"><a href="#workflow-rulesæµæ°´çº¿æ§åˆ¶" class="headerlink" title="workflow:rulesæµæ°´çº¿æ§åˆ¶"></a>workflow:rulesæµæ°´çº¿æ§åˆ¶</h2><p>ä½¿ç”¨ workflow:rules å…³é”®å­—æ¥æ§åˆ¶ä½•æ—¶åˆ›å»ºæµæ°´çº¿ã€‚<br>workflow:rules å…³é”®å­—åœ¨ä½œä¸šä¹‹å‰è¿›è¡Œè¯„ä¼°ã€‚ä¾‹å¦‚ï¼Œå°†ä½œä¸šé…ç½®ä¸ºé’ˆå¯¹æ ‡ç­¾è¿è¡Œï¼Œä½†å·¥ä½œæµé˜»æ­¢æ ‡ç­¾æµæ°´çº¿ï¼Œåˆ™è¯¥ä½œä¸šæ°¸è¿œä¸ä¼šè¿è¡Œã€‚</p><p>rulesåŒ…å«ä»¥ä¸‹å…³é”®å­—ï¼š</p><ul><li>ifï¼šæ¡ä»¶åˆ¤æ–­ï¼Œä¸ºtrueæ—¶å†çœ‹å¯¹åº”çš„whenè§„åˆ™ã€‚</li><li>whenï¼šå–å€¼<code>never</code>è¡¨ç¤ºæµæ°´çº¿ä¸è¿è¡Œï¼Œå–å€¼<code>always</code>æˆ–è€…ç¼ºçœè¡¨ç¤ºæµæ°´çº¿è¿è¡Œã€‚<ul><li>æœ€åä¸€ä¸ªè§„åˆ™çš„ifç¼ºçœï¼Œ<code>when: always</code>è¡¨ç¤ºå…¶ä»–æ‰€æœ‰æµæ°´çº¿ç±»å‹éƒ½è¿è¡Œã€‚</li><li>æœ€åä¸€ä¸ªè§„åˆ™ä¸æ˜¯<code>when: always</code>ï¼Œè¡¨ç¤ºå…¶ä»–æ‰€æœ‰æµæ°´çº¿ç±»å‹éƒ½ä¸è¿è¡Œã€‚</li></ul></li><li>variablesï¼šå®šä¹‰ç‰¹å®šæµæ°´çº¿æ¡ä»¶çš„å˜é‡ï¼ˆå¼•å…¥äº13.11ç‰ˆæœ¬ï¼‰ã€‚ä¾‹å¦‚ä¸åŒåˆ†æ”¯ï¼ŒåŒä¸€ä¸ªå˜é‡å¯ä»¥å®šä¹‰ä¸åŒçš„å€¼ã€‚</li></ul><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://docs.gitlab.cn/jh/ci/yaml/workflow.html">GitLab CI/CD workflow å…³é”®å­—</a></li><li><a href="https://docs.gitlab.cn/jh/ci/yaml/index.html#workflowrulesvariables">.gitlab-ci.yml å…³é”®å­—å‚è€ƒ - workflow</a></li><li><a href="https://forum.gitlab.com/t/interaction-between-workflow-rules-and-rules/49704">Interaction between workflow:rules and rules</a></li></ul><h2 id="include"><a href="#include" class="headerlink" title="include"></a>include</h2><p>ä½¿ç”¨ include åœ¨ CI/CD é…ç½®ä¸­åŒ…å«å¤–éƒ¨ YAML æ–‡ä»¶ã€‚ æ‚¨å¯ä»¥å°†ä¸€ä¸ªé•¿çš„ .gitlab-ci.yml æ–‡ä»¶æ‹†åˆ†ä¸ºå¤šä¸ªæ–‡ä»¶ä»¥æé«˜å¯è¯»æ€§ï¼Œæˆ–å‡å°‘åŒä¸€é…ç½®åœ¨å¤šä¸ªä½ç½®çš„é‡å¤ã€‚</p><p>æ‚¨è¿˜å¯ä»¥å°†æ¨¡æ¿æ–‡ä»¶å­˜å‚¨åœ¨ä¸­å¤®ä»“åº“ä¸­å¹¶å°†å®ƒä»¬åŒ…å«åœ¨é¡¹ç›®ä¸­ã€‚</p><p>include æ–‡ä»¶è¯´æ˜ï¼š</p><ul><li>ä¸ .gitlab-ci.yml æ–‡ä»¶ä¸­çš„é‚£äº›åˆå¹¶ã€‚</li><li>æ— è®º include å…³é”®å­—çš„ä½ç½®å¦‚ä½•ï¼Œå§‹ç»ˆå…ˆæ±‚å€¼ï¼Œç„¶åä¸ .gitlab-ci.yml æ–‡ä»¶çš„å†…å®¹åˆå¹¶ã€‚</li></ul><p>include å­é”®ï¼š</p><ul><li>include:local</li><li>include:projectï¼Œinclude:fileï¼Œinclude:ref</li><li>include:remote</li><li>include:template</li></ul><p>æ³¨æ„ï¼šå¦‚æœincludeäº†å¤šä¸ªæ–‡ä»¶ä¸­éƒ½åŒ…å«stagesï¼Œé‚£ä¹ˆæœ€åä¸€ä¸ªæ–‡ä»¶ä¸­çš„stagesä¼šç”Ÿæ•ˆã€‚</p><p>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://docs.gitlab.cn/jh/ci/yaml/#include">gitlab-ci - include</a></p><h2 id="extends"><a href="#extends" class="headerlink" title="extends"></a>extends</h2><p>ä½¿ç”¨ extends æ¥é‡ç”¨é…ç½® sectionã€‚å®ƒæ˜¯ YAML é”šç‚¹ çš„æ›¿ä»£æ–¹æ¡ˆï¼Œå¹¶ä¸”æ›´åŠ çµæ´»å’Œå¯è¯»ã€‚</p><p>å…³é”®å­—ç±»å‹ï¼šä½œä¸šå…³é”®å­—ã€‚æ‚¨åªèƒ½å°†å…¶ç”¨ä½œä½œä¸šçš„ä¸€éƒ¨åˆ†ã€‚</p><p>å¯èƒ½çš„è¾“å…¥ï¼š</p><ul><li>æµæ°´çº¿ä¸­å¦ä¸€ä¸ªä½œä¸šçš„åç§°ã€‚</li><li>æµæ°´çº¿ä¸­å…¶ä»–ä½œä¸šçš„åç§°åˆ—è¡¨ï¼ˆæ•°ç»„ï¼‰ã€‚</li></ul><p>æ³¨æ„ï¼šextendsçˆ¶ä½œä¸šæ—¶ï¼Œå¦‚æœä¸æƒ³æ‰§è¡Œçˆ¶ä½œä¸šï¼Œé‚£ä¹ˆçˆ¶ä½œä¸šçš„åç§°åº”è¯¥ä»¥ç‚¹<code>.</code>å¼€å¤´ã€‚</p><p>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://docs.gitlab.cn/jh/ci/yaml/#extends">gitlab-ci - extends</a></p><h1 id="å¸¸ç”¨é…ç½®"><a href="#å¸¸ç”¨é…ç½®" class="headerlink" title="å¸¸ç”¨é…ç½®"></a>å¸¸ç”¨é…ç½®</h1><h2 id="å½“æµæ°´çº¿æˆåŠŸæ—¶åˆå¹¶åˆ†æ”¯"><a href="#å½“æµæ°´çº¿æˆåŠŸæ—¶åˆå¹¶åˆ†æ”¯" class="headerlink" title="å½“æµæ°´çº¿æˆåŠŸæ—¶åˆå¹¶åˆ†æ”¯"></a>å½“æµæ°´çº¿æˆåŠŸæ—¶åˆå¹¶åˆ†æ”¯</h2><p>1ã€é¡¹ç›®é…ç½®<br>Project -&gt; Settings -&gt; General -&gt; Merge requests -&gt; Expand -&gt; Merge checks -&gt; å‹¾é€‰ Pipelines must succeed</p><p>2ã€gitlab-cié…ç½®<br>gitlab-cié…ç½®æ—¶ï¼Œè¦ä¿è¯workflowå’Œjobä¸­éƒ½å…è®¸merge requestsè§¦å‘pipelineã€‚</p><p>3ã€è§¦å‘åˆå¹¶è¯·æ±‚<br>gitlabé¡µé¢ä¸Šå‘èµ·ä¸€æ¬¡åˆå¹¶è¯·æ±‚ï¼Œæˆ–è€…ä½¿ç”¨glabå‘èµ·åˆå¹¶è¯·æ±‚</p><p>4ã€æµæ°´çº¿æˆåŠŸæ—¶è‡ªåŠ¨åˆå¹¶<br>æ‰“å¼€åˆå¹¶ä»£ç çš„é¡µé¢ï¼Œå½“pipelineè¿è¡Œæ—¶ï¼Œç‚¹å‡» Merge when pipeline succeeds</p><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ul><li><a href="https://docs.gitlab.cn/jh/user/project/merge_requests/merge_when_pipeline_succeeds.html">å½“æµæ°´çº¿æˆåŠŸæ—¶åˆå¹¶</a></li><li><a href="https://gitlab.voidking.com/help/ci/merge_request_pipelines/index.md#configuring-pipelines-for-merge-requests">Configuring pipelines for merge requests</a></li><li><a href="https://blog.csdn.net/wzj_110/article/details/104515993">é…ç½®Gitlabåˆå¹¶æµæ°´çº¿</a></li><li><a href="https://www.jianshu.com/p/54d57ed593e9">Gitlab å‘èµ·åˆå¹¶è¯·æ±‚ï¼Œä¸€è¡Œå‘½ä»¤å°±æå®šï¼</a></li></ul><h1 id="Gitlab-Runner"><a href="#Gitlab-Runner" class="headerlink" title="Gitlab Runner"></a>Gitlab Runner</h1><p>å‚è€ƒæ–‡æ¡£<a href="https://www.voidking.com/dev-gitlab-runner/">ã€ŠGitLab Runnerå…¥é—¨ç¯‡ã€‹</a></p><h1 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h1><ul><li>é˜…è¯»<a href="https://docs.gitlab.com/ee/ci/yaml/gitlab_ci_yaml.html">The .gitlab-ci.yml file</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;GitLab-CI-CDæ˜¯å•¥ï¼Ÿ&quot;&gt;&lt;a href=&quot;#GitLab-CI-CDæ˜¯å•¥ï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;GitLab CI/CDæ˜¯å•¥ï¼Ÿ&quot;&gt;&lt;/a&gt;GitLab CI/CDæ˜¯å•¥ï¼Ÿ&lt;/h1&gt;&lt;p&gt;CIï¼ŒCONTINUOUS INTEGRATIONï¼ŒæŒç»­é›†æˆã€‚ç®€å•æ¥è¯´å°±æ˜¯è‡ªåŠ¨åŒ–æ„å»ºå’Œæµ‹è¯•ã€‚&lt;br&gt;ä¸€ä¸ªåº”ç”¨ç¨‹åºçš„ä»£ç å­˜å‚¨åœ¨Gitä»“åº“ä¸­ã€‚å¼€å‘äººå‘˜æ¨é€çš„æ¯ä¸ªæ›´æ”¹ï¼Œç”šè‡³æ˜¯å¼€å‘åˆ†æ”¯ï¼Œéƒ½å¯ä»¥é€šè¿‡ä¸€ç»„è„šæœ¬æ¥è‡ªåŠ¨åœ°æ„å»ºå’Œæµ‹è¯•ã€‚è¿™äº›æµ‹è¯•å¯ç¡®ä¿æ›´æ”¹é€šè¿‡æ‚¨ä¸ºåº”ç”¨ç¨‹åºå»ºç«‹çš„æ‰€æœ‰æµ‹è¯•ã€æŒ‡å—å’Œä»£ç åˆè§„æ€§æ ‡å‡†ã€‚&lt;/p&gt;
&lt;p&gt;CDï¼ŒCONTINUOUS DELIVERYï¼ŒæŒç»­äº¤ä»˜ã€‚ç®€å•æ¥è¯´å°±æ˜¯è‡ªåŠ¨åŒ–æ„å»ºå’Œæµ‹è¯•+æ”¯æŒæ‰‹åŠ¨è§¦å‘éƒ¨ç½²ã€‚&lt;br&gt;æ¯æ¬¡å°†ä»£ç æ›´æ”¹æ¨é€åˆ°ä»£ç åº“æ—¶ï¼Œä¸ä»…ä¼šè‡ªåŠ¨æ„å»ºå’Œæµ‹è¯•åº”ç”¨ç¨‹åºï¼Œè¿˜æ”¯æŒä¸€é”®éƒ¨ç½²åº”ç”¨ç¨‹åºï¼Œè¿™é‡Œçš„éƒ¨ç½²éœ€è¦æ‰‹åŠ¨è§¦å‘ã€‚&lt;/p&gt;
&lt;p&gt;CDï¼ŒCONTINUOUS DEPLOYMENTï¼ŒæŒç»­éƒ¨ç½²ã€‚ç®€å•æ¥è¯´å°±æ˜¯è‡ªåŠ¨åŒ–æ„å»ºå’Œæµ‹è¯•+è‡ªåŠ¨éƒ¨ç½²ã€‚&lt;br&gt;æŒç»­éƒ¨ç½²ç±»ä¼¼äºæŒç»­äº¤ä»˜ï¼Œä¸åŒä¹‹å¤„åœ¨äºï¼Œä¸æ˜¯æ‰‹åŠ¨è§¦å‘éƒ¨ç½²åº”ç”¨ç¨‹åºï¼Œè€Œæ˜¯å°†å…¶è®¾ç½®ä¸ºè‡ªåŠ¨éƒ¨ç½²ã€‚&lt;/p&gt;
&lt;p&gt;è€ŒGitLab CI/CDï¼Œå°±æ˜¯ä¸€ç§æ”¯æŒåœ¨GitLabä¸­é…ç½®ä½¿ç”¨æŒç»­é›†æˆã€æŒç»­äº¤ä»˜å’ŒæŒç»­éƒ¨ç½²çš„å·¥å…·ã€‚&lt;/p&gt;
&lt;p&gt;å‚è€ƒæ–‡æ¡£ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.gitlab.com/ee/ci/&quot;&gt;GitLab CI/CD Document&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.gitlab.cn/jh/ci/&quot;&gt;GitLab CI/CD ä¸­æ–‡æ–‡æ¡£&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.gitlab.cn/jh/ci/introduction/index.html&quot;&gt;CI/CD æ¦‚å¿µ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.ttlsa.com/news/ci-cd-cd/&quot;&gt;è¯¦è§£CIã€CD &amp;amp; CD&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://linux.cn/article-9926-1.html&quot;&gt;ä»€ä¹ˆæ˜¯ CI/CDï¼Ÿ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Deployment_environment&quot;&gt;Deployment environment&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="engineering" scheme="https://www.voidking.com/categories/engineering/"/>
    
    <category term="devops" scheme="https://www.voidking.com/categories/engineering/devops/"/>
    
    <category term="git" scheme="https://www.voidking.com/categories/engineering/git/"/>
    
    
    <category term="git" scheme="https://www.voidking.com/tags/git/"/>
    
    <category term="cicd" scheme="https://www.voidking.com/tags/cicd/"/>
    
    <category term="gitlab" scheme="https://www.voidking.com/tags/gitlab/"/>
    
  </entry>
  
</feed>
