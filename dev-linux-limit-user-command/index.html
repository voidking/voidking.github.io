<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1,cdn:{enable:!0,url:"//qiniu-cdn.voidking.com/doc/search.xml"}},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="前言在Linux系统中，为了增强安全性，避免不适当的使用，有时需要限制特定用户或用户组的命令行访问。 常用的限制方法包括 profile限制、authorized_keys限制、rbash限制，本文我们就来学习一下这些方法。 参考文档：  linux 限制用户命令方法 受限的 bash – rbash rbash逃逸大全 ghantoos&#x2F;lshell 《shell命令之sudo》"><meta property="og:type" content="article"><meta property="og:title" content="好好学Linux：限制用户命令"><meta property="og:url" content="https://www.voidking.com/dev-linux-limit-user-command/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="前言在Linux系统中，为了增强安全性，避免不适当的使用，有时需要限制特定用户或用户组的命令行访问。 常用的限制方法包括 profile限制、authorized_keys限制、rbash限制，本文我们就来学习一下这些方法。 参考文档：  linux 限制用户命令方法 受限的 bash – rbash rbash逃逸大全 ghantoos&#x2F;lshell 《shell命令之sudo》"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2024-01-13T08:00:00.000Z"><meta property="article:modified_time" content="2024-01-13T08:00:00.000Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="linux"><meta property="article:tag" content="好好学Linux"><meta property="article:tag" content="shell"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.voidking.com/dev-linux-limit-user-command/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>好好学Linux：限制用户命令 | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">一个计算机技术爱好者与学习者</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-linux-limit-user-command/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="一个计算机技术爱好者与学习者"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> 好好学Linux：限制用户命令</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-01-13 08:00:00" itemprop="dateCreated datePublished" datetime="2024-01-13T08:00:00+00:00">2024-01-13</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/" itemprop="url" rel="index"><span itemprop="name">engineering</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/shell/" itemprop="url" rel="index"><span itemprop="name">shell</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="前言"><span class="post-title-index">1.</span><a href="#前言" class="headerlink" title="前言"></a> 前言</h1><p>在Linux系统中，为了增强安全性，避免不适当的使用，有时需要限制特定用户或用户组的命令行访问。</p><p>常用的限制方法包括 profile限制、authorized_keys限制、<a target="_blank" rel="noopener" href="https://www.gnu.org/software/bash/manual/html_node/The-Restricted-Shell.html">rbash</a>限制，本文我们就来学习一下这些方法。</p><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://sukbeta.github.io/linux-Restrict-user-command-method/">linux 限制用户命令方法</a></li><li><a target="_blank" rel="noopener" href="https://kuanghy.github.io/2017/02/20/rbash">受限的 bash – rbash</a></li><li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7642">rbash逃逸大全</a></li><li><a target="_blank" rel="noopener" href="https://github.com/ghantoos/lshell">ghantoos/lshell</a></li><li><a href="https://www.voidking.com/dev-shell-sudo/">《shell命令之sudo》</a></li></ul><span id="more"></span><h1 id="profile限制"><span class="post-title-index">2.</span><a href="#profile限制" class="headerlink" title="profile限制"></a> profile限制</h1><p>当一个shell登录时，它将读取 <code>/etc/profile</code> 文件中的全部环境变量，然后再执行 <code>/etc/profile.d/</code> 目录中的所有 <code>.sh</code> 结尾的脚本。<br>因此，我们可以定义一个 <code>/etc/profile.d/login.sh</code> 脚本，用来限制用户的PATH，以此限制用户命令。</p><p>下面是一个 login.sh 示例，限制用户只能使用 ssh 命令。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">user=`<span class="built_in">whoami</span>`</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;user&#125;</span>&quot;</span> != <span class="string">&quot;root&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;** \e[01;33m current user is: \e[01;31m <span class="variable">$LOGNAME</span>\e[00m  ** \e[00m&quot;</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/bin</span><br><span class="line">    <span class="built_in">rm</span> -f <span class="variable">$HOME</span>/bin/*</span><br><span class="line">    <span class="built_in">ln</span> -s /usr/bin/ssh <span class="variable">$HOME</span>/bin/</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&#x27;PATH=$HOME/bin&#x27;</span> &gt; <span class="variable">$HOME</span>/.restricted_profile</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&#x27;export PATH&#x27;</span> &gt;&gt; <span class="variable">$HOME</span>/.restricted_profile</span><br><span class="line">    <span class="built_in">chown</span> <span class="variable">$&#123;user&#125;</span>:<span class="variable">$&#123;user&#125;</span> <span class="variable">$HOME</span>/.restricted_profile</span><br><span class="line">    <span class="built_in">exec</span> bash --restricted --noprofile --rcfile <span class="variable">$HOME</span>/.restricted_profile</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>但是，这种方法只能限制用户登录后的命令，如果用户远程执行命令，就限制不住了。<br>比如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -t work@192.168.55.100 <span class="string">&quot;bash&quot;</span></span><br></pre></td></tr></table></figure><p>更多关于登录session和非登录session的内容，可以参考<a href="https://www.voidking.com/dev-bashprofile-bashrc/">《bash_profile和bashrc的区别》</a></p><h1 id="authorized-keys限制"><span class="post-title-index">3.</span><a href="#authorized-keys限制" class="headerlink" title="authorized_keys限制"></a> authorized_keys限制</h1><p>想要限制非登录session，一种可选的方案是使用 authorized_keys 。</p><p>1、authorized_keys 中配置 public key</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">command=&quot;/usr/bin/ssh $SSH_ORIGINAL_COMMAND@tiger.voidking.com -p 2222&quot; ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC9...</span><br></pre></td></tr></table></figure><p>2、用户使用ssh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -t work@192.168.55.100 <span class="string">&quot;haojin&quot;</span></span><br></pre></td></tr></table></figure><p>详情参考：<a href="https://www.voidking.com/dev-shell-ssh/">《shell命令之ssh》</a></p><h1 id="rbash限制"><span class="post-title-index">4.</span><a href="#rbash限制" class="headerlink" title="rbash限制"></a> rbash限制</h1><h2 id="rbash简介"><span class="post-title-index">4.1.</span><a href="#rbash简介" class="headerlink" title="rbash简介"></a> rbash简介</h2><p>rbash（restricted bash）是 bash 的一个版本，实际上 rbash 是 bash 的一个软连接，能够限制用户的命令。</p><p>具体限制包括：</p><ul><li>不能执行 cd 命令。只能在当前目录下工作，其它目录都无法进入。</li><li>不能修改 PATH、ENV、HOME、SHELL等环境变量的值。</li><li>不能执行包含 <code>/</code> 字符的程序。例如，我们无法执行 /usr/bin/uname 或 ./uname 命令或程序。但是，我们依然可以运行 uname 命令。也就是说，当前目录以外的程序或命令是无法被执行的。</li><li>不能使用 <code>&gt;</code> 和 <code>&gt;&gt;</code> 等重定向运算符进行重定向输出。</li><li>不能在脚本中或其它方式关闭 Restricted Shell 模式。</li><li>不能使用 set+r 或 set+o restricted 等方式退出 Restricted Shell 模式。</li></ul><h2 id="rbash限制只能执行ssh"><span class="post-title-index">4.2.</span><a href="#rbash限制只能执行ssh" class="headerlink" title="rbash限制只能执行ssh"></a> rbash限制只能执行ssh</h2><p>1、创建一个用户</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ls -s /bin/bash /bin/rbash</span></span><br><span class="line">useradd -s /bin/rbash -m ruser</span><br><span class="line"><span class="built_in">touch</span> /home/ruser/&#123;.bashrc,.bash_profile&#125;</span><br><span class="line"><span class="built_in">chown</span> -R root:ruser /home/ruser/&#123;.bashrc,.bash_profile&#125;</span><br><span class="line"><span class="built_in">chmod</span> 640 /home/ruser/&#123;.bashrc,.bash_profile&#125;</span><br><span class="line"><span class="built_in">mkdir</span> -p /home/ruser/bin</span><br></pre></td></tr></table></figure><p>2、限制用户只能执行ssh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export PATH=/home/ruser/bin&quot;</span> &gt;&gt; /home/ruser/.bash_profile</span><br><span class="line"><span class="built_in">ln</span> -s /usr/bin/ssh /home/ruser/bin/ssh</span><br></pre></td></tr></table></figure><p>但是，rbash有很多逃逸方法，比如一个简单的<code>bash</code>命令就可以逃逸，无论是session登录还是非session登录。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -t work@192.168.55.100 <span class="string">&quot;bash&quot;</span></span><br></pre></td></tr></table></figure><h1 id="限制用户命令实战"><span class="post-title-index">5.</span><a href="#限制用户命令实战" class="headerlink" title="限制用户命令实战"></a> 限制用户命令实战</h1><h2 id="需求描述"><span class="post-title-index">5.1.</span><a href="#需求描述" class="headerlink" title="需求描述"></a> 需求描述</h2><ul><li>jumpserver只能内网使用，但是有少量外网用户也需要使用jumpserver。</li><li>为避免增加了风险，jumpserver不能放通到外网。</li></ul><h2 id="解决方案"><span class="post-title-index">5.2.</span><a href="#解决方案" class="headerlink" title="解决方案"></a> 解决方案</h2><p>外网可以访问的主机A放通一个ssh命令用于登录，主机A可以连通到jumpserver主机。</p><h2 id="Step1：制作并运行ssh镜像"><span class="post-title-index">5.3.</span><a href="#Step1：制作并运行ssh镜像" class="headerlink" title="Step1：制作并运行ssh镜像"></a> Step1：制作并运行ssh镜像</h2><p>1、准备一个限制登录脚本 ssh.sh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;`date +%Y%m%d%H%M%S` ssh script was executed by key: <span class="variable">$SSH_KEY</span>&quot;</span> &gt;&gt; /opt/ssh.log</span><br><span class="line">ssh -o StrictHostKeyChecking=no -o HostKeyAlgorithms=+ssh-rsa <span class="variable">$SSH_ORIGINAL_COMMAND</span>@jump.voidking.com -p 2222</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> a+x ssh.sh</span><br></pre></td></tr></table></figure><p>2、定义 Dockerfile</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Using debian as base</span></span><br><span class="line"><span class="keyword">FROM</span> debian:bookworm-slim</span><br><span class="line"></span><br><span class="line"><span class="comment"># Maintainer</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> voidking <span class="string">&quot;voidking@qq.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Update and install openssh</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s/deb.debian.org/mirrors.ustc.edu.cn/g&#x27;</span> /etc/apt/sources.list.d/debian.sources</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y --no-install-recommends openssh-server</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> /etc/ssh &amp;&amp; ssh-keygen -A &amp;&amp; <span class="built_in">mkdir</span> -p /run/sshd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Disable SFTP and password login</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;/sftp/c\Subsystem sftp /bin/false&#x27;</span> /etc/ssh/sshd_config &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    sed -i <span class="string">&#x27;/PasswordAuthentication/c\PasswordAuthentication no&#x27;</span> /etc/ssh/sshd_config &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">echo</span> <span class="string">&#x27;PermitUserEnvironment yes&#x27;</span> &gt;&gt; /etc/ssh/sshd_config</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ssh.sh /opt/ssh.sh</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> 777 -R /opt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add new user</span></span><br><span class="line"><span class="comment"># RUN useradd -m work &amp;&amp; echo &quot;work:work123&quot; | chpasswd</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> useradd -m work &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mkdir</span> -p /home/work/.ssh &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chown</span> work:work /home/work/.ssh &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">touch</span> /home/work/.ssh/authorized_keys &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chown</span> work:work /home/work/.ssh/authorized_keys &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chmod</span> 600 /home/work/.ssh/authorized_keys</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the entry point</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/usr/sbin/sshd&quot;</span>, <span class="string">&quot;-D&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>3、打包镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t voidking/ssh:debian-bookworm-slim .</span><br></pre></td></tr></table></figure><p>4、运行镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name ssh \</span><br><span class="line">    -p 10022:22 \</span><br><span class="line">    -v /etc/timezone:/etc/timezone:ro \</span><br><span class="line">    -v /etc/localtime:/etc/localtime:ro</span><br><span class="line">    voidking/ssh:debian-bookworm-slim</span><br></pre></td></tr></table></figure><h2 id="Step2：配置public-key"><span class="post-title-index">5.4.</span><a href="#Step2：配置public-key" class="headerlink" title="Step2：配置public key"></a> Step2：配置public key</h2><p>配置外部用户的 public key 到ssh容器中 work用户的authorized_keys，以使得外部用户有权限执行 command 中指定的 ssh.sh 脚本。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it ssh /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;environment=&quot;SSH_KEY=haojin&quot;,command=&quot;/opt/ssh.sh $SSH_ORIGINAL_COMMAND&quot; ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC9...&#x27;</span> &gt;&gt; /home/work/.ssh/authorized_keys</span><br></pre></td></tr></table></figure><h2 id="Step3：测试登录"><span class="post-title-index">5.5.</span><a href="#Step3：测试登录" class="headerlink" title="Step3：测试登录"></a> Step3：测试登录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -t work@192.168.55.100 -p 10022 <span class="string">&quot;haojin&quot;</span></span><br></pre></td></tr></table></figure></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 好好学习的郝</li><li class="post-copyright-link"> <strong>原文链接：</strong> <a href="https://www.voidking.com/dev-linux-limit-user-command/" title="好好学Linux：限制用户命令">https://www.voidking.com/dev-linux-limit-user-command/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本文采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议，转载请注明出处！源站会即时更新知识点并修正错误，欢迎访问~</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/linux/" rel="tag"># linux</a> <a href="/tags/%E5%A5%BD%E5%A5%BD%E5%AD%A6Linux/" rel="tag"># 好好学Linux</a> <a href="/tags/shell/" rel="tag"># shell</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-github-actions-pypi-release/" rel="prev" title="GitHub Actions实现PyPI发版"><i class="fa fa-chevron-left"></i> GitHub Actions实现PyPI发版</a></div><div class="post-nav-item"> <a href="/dev-k8s-request-limit/" rel="next" title="好好学K8S：K8S中的Request和Limit">好好学K8S：K8S中的Request和Limit<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="footer-ads" style="margin-top:10px"><ins class="adsbygoogle" style="display:block" data-ad-format="autorelaxed" data-ad-client="ca-pub-3284447971731414" data-ad-slot="9697986181"></ins><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3284447971731414" crossorigin="anonymous"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div class="comments" id="gitalk-container"></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">1. 前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#profile%E9%99%90%E5%88%B6"><span class="nav-text">2. profile限制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#authorized-keys%E9%99%90%E5%88%B6"><span class="nav-text">3. authorized_keys限制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#rbash%E9%99%90%E5%88%B6"><span class="nav-text">4. rbash限制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#rbash%E7%AE%80%E4%BB%8B"><span class="nav-text">4.1. rbash简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rbash%E9%99%90%E5%88%B6%E5%8F%AA%E8%83%BD%E6%89%A7%E8%A1%8Cssh"><span class="nav-text">4.2. rbash限制只能执行ssh</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%90%E5%88%B6%E7%94%A8%E6%88%B7%E5%91%BD%E4%BB%A4%E5%AE%9E%E6%88%98"><span class="nav-text">5. 限制用户命令实战</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9C%80%E6%B1%82%E6%8F%8F%E8%BF%B0"><span class="nav-text">5.1. 需求描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">5.2. 解决方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step1%EF%BC%9A%E5%88%B6%E4%BD%9C%E5%B9%B6%E8%BF%90%E8%A1%8Cssh%E9%95%9C%E5%83%8F"><span class="nav-text">5.3. Step1：制作并运行ssh镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step2%EF%BC%9A%E9%85%8D%E7%BD%AEpublic-key"><span class="nav-text">5.4. Step2：配置public key</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step3%EF%BC%9A%E6%B5%8B%E8%AF%95%E7%99%BB%E5%BD%95"><span class="nav-text">5.5. Step3：测试登录</span></a></li></ol></li></ol></div></div><div class="sidecar-ads" style="margin-top:10px"><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">一个计算机技术爱好者与学习者</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">748</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">32</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">259</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/gitalk/1.7.2/gitalk.min.css"><script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/gitalk/1.7.2/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID: '5a238b8c32b1e4dd2156',
      clientSecret: 'bfb5d518626f6fdc7da0351d1e0cd37ab75c6361',
      repo: 'gitalk-comments',
      owner: 'voidking',
      admin: ['voidking'],
      id: '793b22b6f6de2cf0273fe495e142e537',
      title: '好好学Linux：限制用户命令',
      body: '欢迎留言，互相交流学习~',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script></body></html>