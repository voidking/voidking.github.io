<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.1"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1,cdn:{enable:!0,url:"//cdn.jsdelivr.net/gh/voidking/voidking.github.io/search.xml"}},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="前言《Django部署到线上》一文中，很多步骤不是必须的，有些部分甚至是错误的，本文就精简修改一下。目标：把djsite项目部署到&#x2F;home&#x2F;web目录中，并且给它分配一个域名为djsite.voidking.com。"><meta property="og:type" content="article"><meta property="og:title" content="Django部署到线上（修改版）"><meta property="og:url" content="https://www.voidking.com/dev-django-deploy-advance/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="前言《Django部署到线上》一文中，很多步骤不是必须的，有些部分甚至是错误的，本文就精简修改一下。目标：把djsite项目部署到&#x2F;home&#x2F;web目录中，并且给它分配一个域名为djsite.voidking.com。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2018-01-22T08:30:00.000Z"><meta property="article:modified_time" content="2018-01-22T08:30:00.000Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="python"><meta property="article:tag" content="django"><meta property="article:tag" content="centos"><meta property="article:tag" content="supervisor"><meta property="article:tag" content="uwsgi"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.voidking.com/dev-django-deploy-advance/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>Django部署到线上（修改版） | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">好好学习，天天向上！</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-django-deploy-advance/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="学而不思则罔，思而不学则殆！"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> Django部署到线上（修改版）</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-01-22 16:30:00" itemprop="dateCreated datePublished" datetime="2018-01-22T16:30:00+08:00">2018-01-22</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/" itemprop="url" rel="index"><span itemprop="name">专业</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/%E5%BC%80%E5%8F%91/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/%E8%BF%90%E7%BB%B4/centos/" itemprop="url" rel="index"><span itemprop="name">centos</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/%E5%BC%80%E5%8F%91/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>《Django部署到线上》一文中，很多步骤不是必须的，有些部分甚至是错误的，本文就精简修改一下。<br>目标：把djsite项目部署到/home/web目录中，并且给它分配一个域名为djsite.voidking.com。</p><a id="more"></a><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="supervisor"><a href="#supervisor" class="headerlink" title="supervisor"></a>supervisor</h2><p>参考<a href="https://www.voidking.com/dev-centos-supervisor/">《CentOS安装配置Supervisor》</a>，安装配置好supervisor。</p><h2 id="python虚拟机"><a href="#python虚拟机" class="headerlink" title="python虚拟机"></a>python虚拟机</h2><p>参考<a href="https://www.voidking.com/dev-centos-pyenv/">《CentOS安装配置pyenv》</a>，安装好python3.6.1。</p><h1 id="项目部署"><a href="#项目部署" class="headerlink" title="项目部署"></a>项目部署</h1><h2 id="代码准备"><a href="#代码准备" class="headerlink" title="代码准备"></a>代码准备</h2><p>1、在/home/web目录中，执行命令克隆项目<br><code>git clone https://github.com/voidking/djsite.git</code></p><p>2、安装django<br><code>pip install django==1.11.7</code></p><p>3、安装pymysql<br><code>pip install pymysql</code></p><h2 id="数据库准备"><a href="#数据库准备" class="headerlink" title="数据库准备"></a>数据库准备</h2><p>1、创建数据库</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql -uroot -p</span></span><br><span class="line">mysql&gt; create database `djsite`<span class="built_in"> default </span>character <span class="builtin-name">set</span> utf8 collate utf8_general_ci;</span><br></pre></td></tr></table></figure><p>2、修改mysql的binlog格式为混合模式：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global binlog_format=mixed;</span><br><span class="line">mysql&gt; <span class="keyword">exit</span>;</span><br></pre></td></tr></table></figure><p>3、修改djsite/djsite/settings.py中的数据库配置<br><code>vim djsite/djsite/settings.py</code></p><p>4、创建表结构</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">python</span> manage.<span class="keyword">py</span> makemigrations</span><br><span class="line"><span class="keyword">python</span> manage.<span class="keyword">py</span> migrate</span><br></pre></td></tr></table></figure><h2 id="启动项目"><a href="#启动项目" class="headerlink" title="启动项目"></a>启动项目</h2><p>1、启动命令<br><code>python manage.py runserver</code></p><p>2、服务器测试访问<br><code>curl localhost:8000/blog/index</code></p><p>3、本地测试访问<br>使用浏览器查看 <a href="http://ip:8000/blog/index" target="_blank" rel="noopener">http://ip:8000/blog/index</a> ，无法访问。<br>启动命令改为：<code>python manage.py runserver 0.0.0.0:8000</code>，此时即可在浏览器看到部署好的项目。</p><p>如果还是不能访问，尝试先关闭防火墙：<code>systemctl stop firewalld</code></p><h1 id="nginx配置"><a href="#nginx配置" class="headerlink" title="nginx配置"></a>nginx配置</h1><p>1、首先，在万网上配置域名解析，添加A记录，解析到阿里云服务器IP。假设解析好的域名为django.voidking.com。</p><p>2、在nginx的vhost中，添加django.voidking.com.conf，内容为：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> django.voidking.com;</span><br><span class="line">    <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line">    <span class="attribute">location</span> /&#123;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>   Host             <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>   X-Real-IP        <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>  X-Forwarded-For  <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">client_max_body_size</span>       <span class="number">1024m</span>;</span><br><span class="line">        <span class="attribute">client_body_buffer_size</span>    <span class="number">128k</span>;</span><br><span class="line">        <span class="attribute">client_body_temp_path</span>      data/client_body_temp;</span><br><span class="line">        <span class="attribute">proxy_connect_timeout</span>      <span class="number">90</span>;</span><br><span class="line">        <span class="attribute">proxy_send_timeout</span>         <span class="number">90</span>;</span><br><span class="line">        <span class="attribute">proxy_read_timeout</span>         <span class="number">90</span>;</span><br><span class="line">        <span class="attribute">proxy_buffer_size</span>          <span class="number">4k</span>;</span><br><span class="line">        <span class="attribute">proxy_buffers</span>              <span class="number">4</span> <span class="number">32k</span>;</span><br><span class="line">        <span class="attribute">proxy_busy_buffers_size</span>    <span class="number">64k</span>;</span><br><span class="line">        <span class="attribute">proxy_temp_file_write_size</span> <span class="number">64k</span>;</span><br><span class="line">        <span class="attribute">proxy_temp_path</span>            data/proxy_temp;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_pass</span> http://127.0.0.1:8000;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3、重启nginx，<code>./nginx -s reload</code></p><p>4、测试访问<br>服务器：<code>curl django.voidking.com/blog/index</code><br>本地浏览器：<a href="http://django.voidking.com/blog/index" target="_blank" rel="noopener">http://django.voidking.com/blog/index</a></p><p>至此，django项目已经部署成功，没有用到uwsgi。如果给django添加守护进程，那么我们的部署就接近完美了。那么，uwsgi又能干什么呢，我们继续研究。</p><h1 id="uwsgi"><a href="#uwsgi" class="headerlink" title="uwsgi"></a>uwsgi</h1><h2 id="安装uwsgi"><a href="#安装uwsgi" class="headerlink" title="安装uwsgi"></a>安装uwsgi</h2><p><code>pip install uwsgi</code></p><p>编写测试：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># test.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(env, start_response)</span></span><span class="symbol">:</span></span><br><span class="line">    start_response(<span class="string">'200 OK'</span>, [(<span class="string">'Content-Type'</span>,<span class="string">'text/html'</span>)])</span><br><span class="line">    <span class="keyword">return</span> [b<span class="string">"Hello World"</span>]</span><br></pre></td></tr></table></figure><p>启动测试：<br><code>uwsgi --http :8001 --wsgi-file test.py</code></p><p>访问 <a href="http://ip:8001" target="_blank" rel="noopener">http://ip:8001</a> ，即可看到Hello World 。</p><h2 id="一般启动"><a href="#一般启动" class="headerlink" title="一般启动"></a>一般启动</h2><p>1、编写wsgi.py文件<br>编写django_wsgi.py文件，将其放在与文件manage.py同一个目录下。</p><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env python</span></span><br><span class="line"># coding: utf-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os,django</span><br><span class="line">from django.core.handlers.wsgi <span class="keyword">import</span> WSGIHandler</span><br><span class="line"></span><br><span class="line">os.environ.setdefault(<span class="string">"DJANGO_SETTINGS_MODULE"</span>, <span class="string">"djsite.settings"</span>)</span><br><span class="line">django.setup()</span><br><span class="line">application = WSGIHandler()</span><br></pre></td></tr></table></figure><p>2、启动项目<br><code>uwsgi --http :8000 --chdir /home/web/djsite/ --module django_wsgi</code></p><p>3、查看启动结果<br><code>lsof -i :8000</code>，<code>ps aux | grep uwsgi</code></p><p>4、测试访问<br><a href="http://ip:8000/blog/index" target="_blank" rel="noopener">http://ip:8000/blog/index</a><br>此时，页面是没有样式的，也就是说静态资源加载失败。</p><p>5、配置静态资源<br><code>uwsgi --http :8000 --chdir /home/web/djsite/ --module django_wsgi --static-map=/static=static</code><br>此时，页面样式就正常了。</p><h2 id="高级启动"><a href="#高级启动" class="headerlink" title="高级启动"></a>高级启动</h2><p>1、新建uwsgi.ini，与manage.py在同一级目录。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[uwsgi]</span></span><br><span class="line"><span class="attr">http</span> = :<span class="number">8000</span></span><br><span class="line"><span class="attr">chdir</span> = /home/web/djsite/</span><br><span class="line"><span class="attr">wsgi-file</span> = django_wsgi.py</span><br><span class="line"><span class="attr">static-map</span> = /static=static</span><br></pre></td></tr></table></figure><p>2、启动uwsgi<br><code>uwsgi uwsgi.ini</code></p><p>3、测试访问<br><a href="http://ip:8000/blog/index" target="_blank" rel="noopener">http://ip:8000/blog/index</a></p><h1 id="使用supervisor管理"><a href="#使用supervisor管理" class="headerlink" title="使用supervisor管理"></a>使用supervisor管理</h1><h2 id="守护uwsgi"><a href="#守护uwsgi" class="headerlink" title="守护uwsgi"></a>守护uwsgi</h2><p>1、在/etc/supervisor中新建djsite.conf文件：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[program:djsite]</span></span><br><span class="line"><span class="attr">command</span>=/root/.pyenv/versions/<span class="number">3.6</span>.<span class="number">1</span>/bin/uwsgi --http :<span class="number">8000</span> --chdir /home/web/djsite/ --module django_wsgi --static-map=/static=static</span><br><span class="line"><span class="attr">directory</span>=/home/web/djsite/</span><br><span class="line"><span class="attr">startsecs</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">stopwaitsecs</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">autostart</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">autorestart</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure><p>2、重启supervisor</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ps</span> <span class="string">aux | grep supervisord</span></span><br><span class="line"><span class="attr">systemctl</span> <span class="string">stop supervisord</span></span><br><span class="line"><span class="attr">systemctl</span> <span class="string">start supervisord</span></span><br></pre></td></tr></table></figure><p>附：重启djsite命令</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">supervisorctl -c <span class="regexp">/etc/</span>supervisord.conf restart djsite</span><br></pre></td></tr></table></figure><p>3、测试访问<br><a href="http://ip:8000/blog/index" target="_blank" rel="noopener">http://ip:8000/blog/index</a><br>页面显示正常，至此守护进程配置成功。</p><p>4、djsite.conf可以精简修改为：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[program:djsite]</span></span><br><span class="line"><span class="attr">command</span>=/root/.pyenv/versions/<span class="number">3.6</span>.<span class="number">1</span>/bin/uwsgi --ini uwsgi.ini</span><br><span class="line"><span class="attr">directory</span>=/home/web/djsite/</span><br><span class="line"><span class="attr">startsecs</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">stopwaitsecs</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">autostart</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">autorestart</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="静态资源问题（可忽略）"><a href="#静态资源问题（可忽略）" class="headerlink" title="静态资源问题（可忽略）"></a>静态资源问题（可忽略）</h2><p>假设，uwsgi.ini为：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[uwsgi]</span></span><br><span class="line"><span class="attr">http</span> = :<span class="number">8000</span></span><br><span class="line"><span class="attr">chdir</span> = /home/web/djsite/</span><br><span class="line"><span class="attr">wsgi-file</span> = django_wsgi.py</span><br></pre></td></tr></table></figure><p>静态资源就无法访问了。在不添加static-map的情况下，需要修改两个文件：<br>（1）修改djsite/djsite/settings.py文件，添加：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">STATIC_ROOT</span> = <span class="string">'/home/web/djsite/static/'</span></span><br></pre></td></tr></table></figure><p>（2）修改djsite/djsite/settings.py文件为：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url,include</span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.conf.urls.static <span class="keyword">import</span> static</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^admin/'</span>, admin.site.urls),</span><br><span class="line">    url(<span class="string">r'^blog/'</span>, include(<span class="string">'blog.urls'</span>, namespace=<span class="string">'blog'</span>)),</span><br><span class="line">] + static(settings.STATIC_URL, document_root=settings.STATIC_ROOT)</span><br></pre></td></tr></table></figure><h2 id="admin静态资源问题"><a href="#admin静态资源问题" class="headerlink" title="admin静态资源问题"></a>admin静态资源问题</h2><p>如果以<code>python manage.py runserver</code>启动django，那么静态资源没有问题。</p><p>如果以uwsgi启动django，静态资源看起来没有问题，但是，如果访问 <a href="http://ip:8000/admin" target="_blank" rel="noopener">http://ip:8000/admin</a> ，就会发现这个页面的静态资源无法获取。</p><p>一个Django应用，一般有两类静态文件。一是应用内的静态文件，二是Django自带的静态文件。应用内的静态文件在djsite/static目录下。此外，在INSTALLED_APPS中配置了django.contrib.admin， 则还会有另外一组静态文件，在Django安装位置里。</p><p>例如，一个root在Python 3.6版本安装的Django，admin的静态文件在： /usr/local/lib/python3.6/site-packages/django/contrib/admin/static/admin/。</p><p>最终，在STATIC_URL里，会有两类静态文件， <code>/static/*</code> 与 <code>/static/admin/*</code> 。</p><p>了解原理，原因就很显然了。<code>python manage.py runserver</code>知道静态文件的位置，而uWSGI不知道静态文件在什么位置。</p><p>解决办法如下：<br>（1）修改djsite/djsite/settings.py文件：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SITE_ROOT = <span class="built_in">os</span>.<span class="built_in">path</span>.dirname(<span class="built_in">os</span>.<span class="built_in">path</span>.abspath(__file__))</span><br><span class="line">SITE_ROOT = <span class="built_in">os</span>.<span class="built_in">path</span>.abspath(<span class="built_in">os</span>.<span class="built_in">path</span>.join(SITE_ROOT, <span class="string">'../'</span>))</span><br><span class="line">STATIC_ROOT = <span class="built_in">os</span>.<span class="built_in">path</span>.join(SITE_ROOT, <span class="string">'collectedstatic'</span>)</span><br></pre></td></tr></table></figure><p>（2）收集所有静态文件到collectedstatic目录<br><code>python manage.py collectstatic</code></p><p>（3）修改uwsgi.ini配置</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[uwsgi]</span></span><br><span class="line"><span class="attr">http</span> = :<span class="number">8000</span></span><br><span class="line"><span class="attr">chdir</span> = /home/web/djsite/</span><br><span class="line"><span class="attr">wsgi-file</span> = django_wsgi.py</span><br><span class="line"><span class="attr">static-map</span> = /static=collectedstatic</span><br></pre></td></tr></table></figure><h1 id="nginx-uwsgi"><a href="#nginx-uwsgi" class="headerlink" title="nginx+uwsgi"></a>nginx+uwsgi</h1><p>以上，我们的djsite项目已经通过uwsgi方式启动起来，并且可以保持后台运行。nginx配置不改变的情况下，我们可以正常访问 <a href="http://django.voidking.com/blog/index" target="_blank" rel="noopener">http://django.voidking.com/blog/index</a> 。此时，nginx作为反向代理，和uwsgi间通过http交互。</p><p>接下来，就配置下nginx和uwsgi通过socket结合的方式。原理：用户发送http请求到nginx，nginx通过socket把请求交给uwsgi，uwsgi拿到django的处理结果，通过socket返还给nginx，nginx通过http返回结果给用户。</p><p>1、因为nginx和uwsgi通过socket方式交互，我们需要修改uwsgi.ini的配置为：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[uwsgi]</span></span><br><span class="line"><span class="attr">socket</span> = :<span class="number">8000</span></span><br><span class="line"><span class="attr">chdir</span> = /home/web/djsite/</span><br><span class="line"><span class="attr">wsgi-file</span> = django_wsgi.py</span><br><span class="line"><span class="attr">static-map</span> = /static=collectedstatic</span><br><span class="line"><span class="attr">master</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">processes</span> = <span class="number">2</span></span><br><span class="line"><span class="attr">enable-threads</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">daemonize</span> = /home/web/djsite/uwsgi.log</span><br></pre></td></tr></table></figure><p>2、重启supervisor<br><code>systemctl stop supervisord</code><br><code>systemctl start supervisord</code></p><p>3、修改nginx配置djsite.voidking.com.conf：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>      <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> djsite.voidking.com;</span><br><span class="line">    <span class="attribute">charset</span>     utf-<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">uwsgi_pass</span>     <span class="number">127.0.0.1:8000</span>;</span><br><span class="line">        <span class="attribute">include</span>        uwsgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>5、重启nginx<br><code>./nginx -s reload</code></p><p>6、测试访问<br>此时，访问 <a href="http://ip:8000/blog/index" target="_blank" rel="noopener">http://ip:8000/blog/index</a> 失败，访问 <a href="http://django.voidking.com/blog/index" target="_blank" rel="noopener">http://django.voidking.com/blog/index</a> 正常。因为8000端口不再提供http服务，而是一个和nginx连接的socket。</p><h1 id="加速静态资源"><a href="#加速静态资源" class="headerlink" title="加速静态资源"></a>加速静态资源</h1><p>1、修改nginx配置djsite.voidking.com.conf：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>      <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> djsite.voidking.com;</span><br><span class="line">    <span class="attribute">charset</span>     utf-<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">uwsgi_pass</span>     <span class="number">127.0.0.1:8000</span>;</span><br><span class="line">        <span class="attribute">include</span>        uwsgi_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> /static &#123;</span><br><span class="line">        <span class="attribute">alias</span> /root/djsite/collectedstatic;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、修改nginx.conf</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">user</span> <span class="title">root</span>;</span><br></pre></td></tr></table></figure><p>3、重启nginx<br><code>./nginx -s reload</code></p><h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>至此，django部署完毕，我们实现了三种部署方法：</p><ul><li>nginx + django（http方式）</li><li>nginx + uwsgi（http方式）</li><li>nginx + uwsgi（socket方式）</li></ul><h1 id="书签"><a href="#书签" class="headerlink" title="书签"></a>书签</h1><p><a href="http://uwsgi-docs-zh.readthedocs.io/zh_CN/latest/StaticFiles.html" target="_blank" rel="noopener">使用uWSGI提供静态文件 (更新至1.9)</a></p><p><a href="http://note.qidong.name/2017/07/uwsgi-serve-django-static/" target="_blank" rel="noopener">解决uWSGI里的Django静态文件丢失</a></p></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 好好学习的郝</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.voidking.com/dev-django-deploy-advance/" title="Django部署到线上（修改版）">https://www.voidking.com/dev-django-deploy-advance/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！源站会及时更新知识点及修正错误，阅读体验也更好。欢迎分享，欢迎收藏~</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/python/" rel="tag"># python</a> <a href="/tags/django/" rel="tag"># django</a> <a href="/tags/centos/" rel="tag"># centos</a> <a href="/tags/supervisor/" rel="tag"># supervisor</a> <a href="/tags/uwsgi/" rel="tag"># uwsgi</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-hadoop-hive-on-centos/" rel="prev" title="在CentOS7上安装Hadoop和Hive"><i class="fa fa-chevron-left"></i> 在CentOS7上安装Hadoop和Hive</a></div><div class="post-nav-item"> <a href="/dev-ml-principle-and-method/" rel="next" title="机器学习相关原则与方法">机器学习相关原则与方法<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zODU3Mi8xNTEwMA=="></div></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#环境准备"><span class="nav-number">2.</span> <span class="nav-text">环境准备</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#supervisor"><span class="nav-number">2.1.</span> <span class="nav-text">supervisor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#python虚拟机"><span class="nav-number">2.2.</span> <span class="nav-text">python虚拟机</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#项目部署"><span class="nav-number">3.</span> <span class="nav-text">项目部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#代码准备"><span class="nav-number">3.1.</span> <span class="nav-text">代码准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据库准备"><span class="nav-number">3.2.</span> <span class="nav-text">数据库准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动项目"><span class="nav-number">3.3.</span> <span class="nav-text">启动项目</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx配置"><span class="nav-number">4.</span> <span class="nav-text">nginx配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#uwsgi"><span class="nav-number">5.</span> <span class="nav-text">uwsgi</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装uwsgi"><span class="nav-number">5.1.</span> <span class="nav-text">安装uwsgi</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一般启动"><span class="nav-number">5.2.</span> <span class="nav-text">一般启动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#高级启动"><span class="nav-number">5.3.</span> <span class="nav-text">高级启动</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#使用supervisor管理"><span class="nav-number">6.</span> <span class="nav-text">使用supervisor管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#守护uwsgi"><span class="nav-number">6.1.</span> <span class="nav-text">守护uwsgi</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#静态资源问题（可忽略）"><span class="nav-number">6.2.</span> <span class="nav-text">静态资源问题（可忽略）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#admin静态资源问题"><span class="nav-number">6.3.</span> <span class="nav-text">admin静态资源问题</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx-uwsgi"><span class="nav-number">7.</span> <span class="nav-text">nginx+uwsgi</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#加速静态资源"><span class="nav-number">8.</span> <span class="nav-text">加速静态资源</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#小结"><span class="nav-number">9.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#书签"><span class="nav-number">10.</span> <span class="nav-text">书签</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">学而不思则罔，思而不学则殆！</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">637</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">50</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">199</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://www.beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={iconStyle:"box",boxForm:"horizontal",position:"bottomCenter",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={iconStyle:"box",boxForm:"horizontal",position:"topRight",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-float",flOptions)</script><script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  // window.livereOptions = {
  //   refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  // };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script></body></html>