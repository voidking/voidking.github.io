<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1,cdn:{enable:!0,url:"//qiniu.cdn.voidking.com/doc/search.xml"}},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="Ingress简介ingress是k8s中的一个七层的负载均衡，可以把流量路由到service。如果没有ingress，我们可以通过外部的nginx、haproxy等也可以实现七层负载均衡，但是配置nginx比较麻烦，因为想要配置nginx的upstream必须先查询service的ip，那如果使用service的name，还要维护一个dns；如果想要换成haproxy，成本也比较高。而有了ing"><meta property="og:type" content="article"><meta property="og:title" content="好好学K8S：K8S中安装使用Ingress"><meta property="og:url" content="https://www.voidking.com/dev-k8s-ingress/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="Ingress简介ingress是k8s中的一个七层的负载均衡，可以把流量路由到service。如果没有ingress，我们可以通过外部的nginx、haproxy等也可以实现七层负载均衡，但是配置nginx比较麻烦，因为想要配置nginx的upstream必须先查询service的ip，那如果使用service的name，还要维护一个dns；如果想要换成haproxy，成本也比较高。而有了ing"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://cdn.voidking.com/img/k8s-ingress/traffic-link.png?imageView2/0/w/1000"><meta property="article:published_time" content="2020-02-24T15:00:00.000Z"><meta property="article:modified_time" content="2023-09-02T08:00:00.000Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="架构"><meta property="article:tag" content="k8s"><meta property="article:tag" content="nginx"><meta property="article:tag" content="helm"><meta property="article:tag" content="好好学K8S"><meta property="article:tag" content="网络"><meta property="article:tag" content="ingress"><meta property="article:tag" content="kubesphere"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://cdn.voidking.com/img/k8s-ingress/traffic-link.png?imageView2/0/w/1000"><link rel="canonical" href="https://www.voidking.com/dev-k8s-ingress/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>好好学K8S：K8S中安装使用Ingress | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">一个计算机技术爱好者与学习者</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-k8s-ingress/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="一个计算机技术爱好者与学习者"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> 好好学K8S：K8S中安装使用Ingress</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-02-24 15:00:00" itemprop="dateCreated datePublished" datetime="2020-02-24T15:00:00+00:00">2020-02-24</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-09-02 08:00:00" itemprop="dateModified" datetime="2023-09-02T08:00:00+00:00">2023-09-02</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/" itemprop="url" rel="index"><span itemprop="name">engineering</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/cloudnative/" itemprop="url" rel="index"><span itemprop="name">cloudnative</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/architecture/" itemprop="url" rel="index"><span itemprop="name">architecture</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/network/" itemprop="url" rel="index"><span itemprop="name">network</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="Ingress简介"><span class="post-title-index">1.</span><a href="#Ingress简介" class="headerlink" title="Ingress简介"></a> Ingress简介</h1><p>ingress是k8s中的一个七层的负载均衡，可以把流量路由到service。<br>如果没有ingress，我们可以通过外部的nginx、haproxy等也可以实现七层负载均衡，但是配置nginx比较麻烦，因为想要配置nginx的upstream必须先查询service的ip，那如果使用service的name，还要维护一个dns；如果想要换成haproxy，成本也比较高。而有了ingress，实际上就是把nginx等七层负载均衡集成到了k8s中，配置就更加简单也更加通用。</p><p>它的工作原理是ingress服务作为流量的入口，收到请求后，根据host、path等规则，匹配到对应的service和端口，然后把流量转发到service的端口，service再转发流量给pod。</p><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/">Ingress</a></li><li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/">Ingress Controllers</a></li></ul><span id="more"></span><h1 id="安装Ingress-Controller"><span class="post-title-index">2.</span><a href="#安装Ingress-Controller" class="headerlink" title="安装Ingress Controller"></a> 安装Ingress Controller</h1><p>本节中，我们使用helm在K8S集群中安装Ingress NGINX Controller。</p><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/access-application-cluster/ingress-minikube/">Set up Ingress on Minikube with the NGINX Ingress Controller</a></li><li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-nginx">Ingress NGINX Controller</a></li><li><a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/deploy/">Ingress NGINX Controller - Installation Guide</a></li><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tangxuliang/p/16922807.html">使用Helm安装Ingress-nginx</a></li></ul><p>官方推荐一键安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade --install ingress-nginx ingress-nginx \</span><br><span class="line">  --repo https://kubernetes.github.io/ingress-nginx \</span><br><span class="line">  --namespace ingress-nginx --create-namespace</span><br></pre></td></tr></table></figure><p>因为郝同学喜欢安装指定版本，并且对配置做一些了解，因此本节使用稍微麻烦一点的方式。</p><p>1、添加chart仓库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx</span><br><span class="line">helm repo update</span><br><span class="line">helm repo list</span><br></pre></td></tr></table></figure><p>2、下载chart（chart4.1.4 对应 app1.2.1）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">helm search repo ingress-nginx/ingress-nginx -l</span><br><span class="line">helm fetch ingress-nginx/ingress-nginx --version 4.1.4</span><br><span class="line">tar -xzvf ingress-nginx-4.1.4.tgz</span><br><span class="line">vim ingress-nginx/values.yaml</span><br></pre></td></tr></table></figure><p>3、修改 values.yaml 配置</p><ul><li>controller.image.registry：改为<code>k8s.dockerproxy.com</code></li><li>controller.image.tag：保持不变<code>v1.2.1</code></li><li>controller.image.digest：注释掉</li><li>controller.image.digestChroot：注释掉</li><li>controller.admissionWebhooks.enabled：保持 true，避免创建的错误 Ingress 等资源对象影响控制器重新加载</li><li>defaultBackend.enabled：按需修改</li></ul><p>4、安装ingress nginx controller</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm install ingress-nginx ingress-nginx -n ingress-nginx --create-namespace --dry-run --debug</span><br><span class="line">helm install ingress-nginx ingress-nginx -n ingress-nginx --create-namespace</span><br></pre></td></tr></table></figure><p>5、查看安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all -n ingress-nginx</span><br><span class="line">kubectl get ingressclass</span><br></pre></td></tr></table></figure><p>注意：新版本的ingress，会创建ingressclass，但是一些旧版本的ingress，并没有ingressclass这种资源。<br>在 Kubernetes 1.18 之前，通常是在 Ingress 资源上通过 kubernetes.io/ingress.class 注解来指定使用的 Ingress Controller。虽然这个注解从未被正式定义过，但却是被各个 Ingress Controller 所广泛支持的，注解的值可以在Ingress Controller启动时指定。<br>Kubernetes 1.18 起提供了 IngressClass 资源，IngressClass指定关联<code>spec.controller</code>，Ingress指定关联<code>spec.ingressClassName</code>，就实现了Ingress指定Ingress Controller。<br>详情参考文档<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/78e27347076c">K8s Ingress、Ingress Controller 和 Ingress Class</a></p><h1 id="KS中的Ingress-Controller"><span class="post-title-index">3.</span><a href="#KS中的Ingress-Controller" class="headerlink" title="KS中的Ingress Controller"></a> KS中的Ingress Controller</h1><p>如果k8s集群中安装了kubesphere，那么可以直接启用kubesphere的网关，本质也是ingress nginx controller。<br>开启办法：admin用户登录控制台，集群设置，网关设置，启用网关。</p><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://kubesphere.io/blogs/guide-to-kubernetes-ingress-controllers/">Guide to Kubernetes Ingress Controllers</a></li><li><a target="_blank" rel="noopener" href="https://kubesphere.io/blogs/canary-release-with-nginx-ingress/">Canary Release in Kubernetes with Nginx Ingress</a></li><li><a target="_blank" rel="noopener" href="https://kubesphere.io/zh/docs/v3.3/cluster-administration/cluster-settings/cluster-gateway/">集群网关</a></li><li><a target="_blank" rel="noopener" href="https://kubesphere.io/zh/docs/v3.3/project-administration/project-gateway/">项目网关</a></li><li><a target="_blank" rel="noopener" href="https://kubesphere.io/zh/docs/v3.3/project-user-guide/application-workloads/routes/">应用路由</a></li></ul><h1 id="配置Ingress"><span class="post-title-index">4.</span><a href="#配置Ingress" class="headerlink" title="配置Ingress"></a> 配置Ingress</h1><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/">Ingress</a></li><li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/ingress/#default-ingress-class">Default IngressClass</a></li></ul><h2 id="Ingress-Controller配置"><span class="post-title-index">4.1.</span><a href="#Ingress-Controller配置" class="headerlink" title="Ingress Controller配置"></a> Ingress Controller配置</h2><p>可以认为Ingress Controller就是一个K8S内部的Nginx。<br>查看 Ingress Controller 的 service 配置，找到80和433端口对应的NodePort，用于访问Nginx。<br>假设一个节点IP为192.168.56.102，service的80端口对应30490，443端口对应30499。</p><h2 id="创建测试服务"><span class="post-title-index">4.2.</span><a href="#创建测试服务" class="headerlink" title="创建测试服务"></a> 创建测试服务</h2><p>1、创建测试服务（Nginx）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment <span class="built_in">test</span> --image=nginx --dry-run=client -oyaml &gt; deployment.yaml</span><br><span class="line">kubectl create service clusterip <span class="built_in">test</span> --tcp=80:80 --tcp=443:443 --dry-run=client -oyaml &gt; service.yaml</span><br><span class="line">kubectl apply -f deployment.yaml</span><br><span class="line">kubectl apply -f service.yaml</span><br></pre></td></tr></table></figure><p>2、查看测试服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods</span><br><span class="line">kubectl get svc</span><br></pre></td></tr></table></figure><h2 id="创建Ingress"><span class="post-title-index">4.3.</span><a href="#创建Ingress" class="headerlink" title="创建Ingress"></a> 创建Ingress</h2><p>1、准备 minimal-ingress.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">minimal-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/testpath</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>其中，ingressClassName可以省略，省略后会使用默认的ingressClass。<br>因为配置了rewrite-target，所以请求到达service时，<code>/testpath</code>会被替换为<code>/</code>。</p><p>2、创建ingress</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f minimal-ingress.yaml</span><br><span class="line">kubectl get ingress</span><br></pre></td></tr></table></figure><p>3、通过ingress controller访问测试服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 192.168.56.102:30490/testpath</span><br></pre></td></tr></table></figure><p>访问链路为：ip+port（ingress） -&gt; nginx service</p><h1 id="多个Ingress-Controller"><span class="post-title-index">5.</span><a href="#多个Ingress-Controller" class="headerlink" title="多个Ingress Controller"></a> 多个Ingress Controller</h1><p>怎样在k8s集群中配置多个Ingress Controller？<br>答：多个Ingress Controller的启动命令中，<code>--controller-class</code>和<code>--ingress-class</code>参数设置成不同的值。</p><p>如果k8s集群中存在多个Ingress Controller，哪个会生效呢？<br>答：在Ingress的spec中指定<code>ingressClassName</code>，或者在Ingress的annotations中指定<code>kubernetes.io/ingress.class</code>（即将废弃）。<br>如果不指定，那么将会使用默认的ingressClass，默认的ingressClass中会包含一个annotations：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">  <span class="attr">ingressclass.kubernetes.io/is-default-class:</span> <span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure><p>Ingress NGINX Controller的<code>--controller-class</code>默认值为<code>k8s.io/ingress-nginx</code>，<code>--ingress-class</code>的默认值为<code>nginx</code>。</p><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/">Ingress</a></li><li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/ingress/#default-ingress-class">Default IngressClass</a></li><li><a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/multiple-ingress/">Multiple Ingress controllers</a></li><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/wuawua1/article/details/126420642">kubernetes部署多个ingress controller（ingress controller分组部署）实践</a></li><li><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/151524.html">部署多个Ingress Controller</a></li><li><a target="_blank" rel="noopener" href="https://www.modb.pro/db/50736">同一kubernetes部署多个Nginx Ingress Controller</a></li></ul><h1 id="Ingress常用配置"><span class="post-title-index">6.</span><a href="#Ingress常用配置" class="headerlink" title="Ingress常用配置"></a> Ingress常用配置</h1><p>参考文档<a href="https://www.voidking.com/dev-ingress-config/">《Ingress常用配置》</a></p><h1 id="查看最终的nginx配置"><span class="post-title-index">7.</span><a href="#查看最终的nginx配置" class="headerlink" title="查看最终的nginx配置"></a> 查看最终的nginx配置</h1><p>我们编写的ingress，实际上最终会生成nginx.conf，可以在ingress-nginx-controller中查看是否符合预期。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it ingress-nginx-controller-xxx -- /bin/bash</span><br><span class="line"><span class="built_in">cd</span> /etc/nginx</span><br><span class="line"><span class="built_in">cat</span> nginx.conf</span><br></pre></td></tr></table></figure><h1 id="Ingress推荐链路"><span class="post-title-index">8.</span><a href="#Ingress推荐链路" class="headerlink" title="Ingress推荐链路"></a> Ingress推荐链路</h1><h2 id="LB-gt-Ingress"><span class="post-title-index">8.1.</span><a href="#LB-gt-Ingress" class="headerlink" title="LB -&gt; Ingress"></a> LB -&gt; Ingress</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Domain -&gt; LB -&gt; Ingress -&gt; Service -&gt; Pod</span><br></pre></td></tr></table></figure><p>这种链路，适用于云厂商提供的k8s集群。</p><p>创建方法：<br>1）在创建ingress-controller的Service时，直接创建LoadBanlancer类型的Service。<br>2）或者单独创建LB，后端配置Ingress的Node Port。</p><p>这种链路最大的优点是链路短，速度快。<br>通过云厂商提供的LB，可以配置四层或者七层负载均衡到Ingress，还可以在LB层加一些安全防护产品。<br>如果使用的是七层负载均衡，还可以统一配置泛域名证书。</p><h2 id="Nginx-gt-Ingress"><span class="post-title-index">8.2.</span><a href="#Nginx-gt-Ingress" class="headerlink" title="Nginx -&gt; Ingress"></a> Nginx -&gt; Ingress</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Domain -&gt; Nginx -&gt; Ingress -&gt; Service -&gt; Pod</span><br></pre></td></tr></table></figure><p>这种链路，适用于所有k8s集群。<br>通过Nginx，可以配置四层或者七层负载均衡到Ingress。<br>如果使用的是七层负载均衡，还可以统一配置泛域名证书。</p><h2 id="开发-测试-生产环境链路"><span class="post-title-index">8.3.</span><a href="#开发-测试-生产环境链路" class="headerlink" title="开发/测试/生产环境链路"></a> 开发/测试/生产环境链路</h2><p><img src="http://cdn.voidking.com/img/k8s-ingress/traffic-link.png?imageView2/0/w/1000"></p><ol><li>外网访问K8S生产集群中的服务：域名 -&gt; 云厂商Prod CLB(80/443) -&gt; Ingress(Node Port) -&gt; Service</li><li>外网访问K8S测试集群中的服务：域名 -&gt; 云厂商Test CLB(80/443) -&gt; Ingress(Node Port) -&gt; Service</li><li>外网访问K8S开发集群中的服务：域名 -&gt; 云厂商Nginx(裸机版，80/443) -&gt; Ingress(Node Port) -&gt; Service</li><li>内网访问K8S开发集群中的服务：域名 -&gt; 自建机房Nginx1(80/443) -&gt; Ingress(Node Port)-&gt; Service</li><li>外网访问云厂商非K8S集群中的服务：域名 -&gt; 云厂商混用 CLB(80/443) -&gt; 云厂商Nginx(Docker版，1080/1443) -&gt; Service</li><li>外网访问自建机房非K8S集群中的服务：域名 -&gt; 云厂商混用 CLB(80/443) -&gt; 云厂商Nginx(Docker版，1080/1443) -&gt;Service</li><li>内网访问自建机房非K8S集群中的服务：域名 -&gt; 自建机房Nginx2(80/443) -&gt; Service</li><li>外网访问云厂商需要四层转发的服务：云厂商混用CLB(自行选择端口) -&gt; 四层Service</li><li>外网访问自建机房需要四层转发的服务：云厂商混用CLB(自行选择端口) -&gt; 云厂商Nginx(裸机版，自行选择端口) -&gt; 四层Service</li></ol></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 好好学习的郝</li><li class="post-copyright-link"> <strong>原文链接：</strong> <a href="https://www.voidking.com/dev-k8s-ingress/" title="好好学K8S：K8S中安装使用Ingress">https://www.voidking.com/dev-k8s-ingress/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本文采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议，转载请注明出处！源站会即时更新知识点并修正错误，欢迎访问~</li><li> <img width="200" height="200" src="/images/avatar.jpg"><p style="text-align:center;margin-bottom:0">微信公众号同步更新，欢迎关注~</p></li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/%E6%9E%B6%E6%9E%84/" rel="tag"># 架构</a> <a href="/tags/k8s/" rel="tag"># k8s</a> <a href="/tags/nginx/" rel="tag"># nginx</a> <a href="/tags/helm/" rel="tag"># helm</a> <a href="/tags/%E5%A5%BD%E5%A5%BD%E5%AD%A6K8S/" rel="tag"># 好好学K8S</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag"># 网络</a> <a href="/tags/ingress/" rel="tag"># ingress</a> <a href="/tags/kubesphere/" rel="tag"># kubesphere</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-k8s-service/" rel="prev" title="好好学K8S：K8S中的Service详解"><i class="fa fa-chevron-left"></i> 好好学K8S：K8S中的Service详解</a></div><div class="post-nav-item"> <a href="/dev-k8s-ingress-80-443/" rel="next" title="好好学K8S：Ingress配置使用宿主机80/443端口">好好学K8S：Ingress配置使用宿主机80/443端口<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="footer-ads" style="margin-top:10px"><ins class="adsbygoogle" style="display:block" data-ad-format="autorelaxed" data-ad-client="ca-pub-3284447971731414" data-ad-slot="9697986181"></ins><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3284447971731414" crossorigin="anonymous"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div class="comments" id="gitalk-container"></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Ingress%E7%AE%80%E4%BB%8B"><span class="nav-text">1. Ingress简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Ingress-Controller"><span class="nav-text">2. 安装Ingress Controller</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#KS%E4%B8%AD%E7%9A%84Ingress-Controller"><span class="nav-text">3. KS中的Ingress Controller</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEIngress"><span class="nav-text">4. 配置Ingress</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Ingress-Controller%E9%85%8D%E7%BD%AE"><span class="nav-text">4.1. Ingress Controller配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%B5%8B%E8%AF%95%E6%9C%8D%E5%8A%A1"><span class="nav-text">4.2. 创建测试服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAIngress"><span class="nav-text">4.3. 创建Ingress</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A4%9A%E4%B8%AAIngress-Controller"><span class="nav-text">5. 多个Ingress Controller</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ingress%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="nav-text">6. Ingress常用配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%9C%80%E7%BB%88%E7%9A%84nginx%E9%85%8D%E7%BD%AE"><span class="nav-text">7. 查看最终的nginx配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ingress%E6%8E%A8%E8%8D%90%E9%93%BE%E8%B7%AF"><span class="nav-text">8. Ingress推荐链路</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#LB-gt-Ingress"><span class="nav-text">8.1. LB -&gt; Ingress</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-gt-Ingress"><span class="nav-text">8.2. Nginx -&gt; Ingress</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%8F%91-%E6%B5%8B%E8%AF%95-%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%93%BE%E8%B7%AF"><span class="nav-text">8.3. 开发&#x2F;测试&#x2F;生产环境链路</span></a></li></ol></li></ol></div></div><div class="sidecar-ads" style="margin-top:10px"><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">一个计算机技术爱好者与学习者</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">723</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">31</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">254</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/gitalk/1.7.2/gitalk.min.css"><script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/gitalk/1.7.2/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID: '5a238b8c32b1e4dd2156',
      clientSecret: 'bfb5d518626f6fdc7da0351d1e0cd37ab75c6361',
      repo: 'gitalk-comments',
      owner: 'voidking',
      admin: ['voidking'],
      id: 'd7a11b4f8337ec300c34ce926fa94bd0',
      title: '好好学K8S：K8S中安装使用Ingress',
      body: '欢迎留言，互相交流学习~',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script></body></html>