<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1,cdn:{enable:!0,url:"//qiniu-cdn.voidking.com/doc/search.xml"}},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="前言把模板引擎换成smarty后，yii框架自带的captcha，非常不友好，使用起来不方便。干脆自己封装一个php图片验证码模块，想要移植到其他框架，简单修改即可。"><meta property="og:type" content="article"><meta property="og:title" content="yii框架整合smarty使用自定义验证码"><meta property="og:url" content="https://www.voidking.com/dev-yii-smarty-captcha/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="前言把模板引擎换成smarty后，yii框架自带的captcha，非常不友好，使用起来不方便。干脆自己封装一个php图片验证码模块，想要移植到其他框架，简单修改即可。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://cdn.voidking.com/img/yii-smarty-captcha/structure.jpg"><meta property="og:image" content="http://cdn.voidking.com/img/yii-smarty-captcha/result.gif?imageView2/0/w/700"><meta property="article:published_time" content="2017-07-21T16:45:00.000Z"><meta property="article:modified_time" content="2017-07-21T16:45:00.000Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="php"><meta property="article:tag" content="yii"><meta property="article:tag" content="验证码"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://cdn.voidking.com/img/yii-smarty-captcha/structure.jpg"><link rel="canonical" href="https://www.voidking.com/dev-yii-smarty-captcha/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>yii框架整合smarty使用自定义验证码 | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">一个计算机技术爱好者与学习者</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-yii-smarty-captcha/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="一个计算机技术爱好者与学习者"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> yii框架整合smarty使用自定义验证码</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2017-07-21 16:45:00" itemprop="dateCreated datePublished" datetime="2017-07-21T16:45:00+00:00">2017-07-21</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/" itemprop="url" rel="index"><span itemprop="name">engineering</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/php/" itemprop="url" rel="index"><span itemprop="name">php</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="前言"><span class="post-title-index">1.</span><a href="#前言" class="headerlink" title="前言"></a> 前言</h1><p>把模板引擎换成smarty后，yii框架自带的captcha，非常不友好，使用起来不方便。干脆自己封装一个php图片验证码模块，想要移植到其他框架，简单修改即可。</p><span id="more"></span><h1 id="设计思路"><span class="post-title-index">2.</span><a href="#设计思路" class="headerlink" title="设计思路"></a> 设计思路</h1><p>PHP生成验证码的原理：使用PHP的GD库，生成一张带验证码的图片，并将验证码保存在Session中。PHP生成验证码的大致流程有：</p><p>1、产生一张png的图片；</p><p>2、为图片设置背景色；</p><p>3、设置字体颜色和样式；</p><p>4、产生N位数的随机的验证码；</p><p>5、把产生的每个字符调整旋转角度和位置画到png图片上；</p><p>6、加入噪点和干扰线防止注册机器分析原图片来恶意破解验证码；</p><p>7、输出图片；</p><p>8、释放图片所占内存。</p><h1 id="项目结构"><span class="post-title-index">3.</span><a href="#项目结构" class="headerlink" title="项目结构"></a> 项目结构</h1><p>1、《yii框架实战》的基础上，在controllers目录中新建util目录，util目录中新建CaptchaController.php，用来实现验证码模块。</p><p>2、在web中新建font目录，font目录中放入微软雅黑字体msyh.ttf，用来显示验证码上的字体。</p><p><img src="http://cdn.voidking.com/img/yii-smarty-captcha/structure.jpg"></p><h1 id="代码实现"><span class="post-title-index">4.</span><a href="#代码实现" class="headerlink" title="代码实现"></a> 代码实现</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">controllers</span>\<span class="title class_">util</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Yii</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">filters</span>\<span class="title">AccessControl</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">web</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">filters</span>\<span class="title">VerbFilter</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CaptchaController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionIndex</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;captcha index function&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionGetcode</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">session_start</span>();</span><br><span class="line">        <span class="variable">$response</span> = <span class="title class_">Yii</span>::<span class="variable">$app</span>-&gt;<span class="title function_ invoke__">getResponse</span>();</span><br><span class="line">        <span class="variable">$response</span>-&gt;format = <span class="variable">$response</span>::<span class="variable constant_">FORMAT_RAW</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">createCode</span>(<span class="number">300</span>,<span class="number">80</span>,<span class="number">30</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createCode</span>(<span class="params"><span class="variable">$width</span>,<span class="variable">$height</span>,<span class="variable">$fontsize</span></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//设置验证码图片大小的函数</span></span><br><span class="line">        <span class="variable">$image</span> = <span class="title function_ invoke__">imagecreate</span>(<span class="variable">$width</span>, <span class="variable">$height</span>);    </span><br><span class="line">        <span class="comment">//设置验证码颜色 imagecolorallocate(int im, int red, int green, int blue);</span></span><br><span class="line">        <span class="variable">$bgcolor</span> = <span class="title function_ invoke__">imagecolorallocate</span>(<span class="variable">$image</span>,<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>); <span class="comment">//#fff</span></span><br><span class="line">        <span class="comment">//区域填充 int imagefill(int im, int x, int y, int col) (x,y) 所在的区域着色,col 表示欲涂上的颜色</span></span><br><span class="line">        <span class="title function_ invoke__">imagefill</span>(<span class="variable">$image</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="variable">$bgcolor</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//设置变量</span></span><br><span class="line">        <span class="variable">$captcha_code</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">//生成随机的字母和数字</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="number">4</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">              </span><br><span class="line">            <span class="comment">//设置字体颜色，随机颜色，0-120深颜色</span></span><br><span class="line">            <span class="variable">$fontcolor</span> = <span class="title function_ invoke__">imagecolorallocate</span>(<span class="variable">$image</span>, <span class="title function_ invoke__">rand</span>(<span class="number">0</span>,<span class="number">120</span>),<span class="title function_ invoke__">rand</span>(<span class="number">0</span>,<span class="number">120</span>), <span class="title function_ invoke__">rand</span>(<span class="number">0</span>,<span class="number">120</span>));     </span><br><span class="line">            <span class="comment">//$fontcolor = imagecolorallocate($image, 0, 0, 0);</span></span><br><span class="line">            <span class="comment">//设置需要随机取的值，去掉容易出错的值如0和o、1和l、2和z</span></span><br><span class="line">            <span class="variable">$data</span> =<span class="string">&#x27;abcdefghigkmnpqrstuvwxy3456789&#x27;</span>;</span><br><span class="line">            <span class="comment">//取出值，字符串截取方法  strlen获取字符串长度</span></span><br><span class="line">            <span class="variable">$fontcontent</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$data</span>, <span class="title function_ invoke__">rand</span>(<span class="number">0</span>,<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>)-<span class="number">1</span>),<span class="number">1</span>);</span><br><span class="line">            <span class="comment">//连续定义变量</span></span><br><span class="line">            <span class="variable">$captcha_code</span> .= <span class="variable">$fontcontent</span>;    </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//imagestring设置字体大小，最大值为5</span></span><br><span class="line">            <span class="comment">//$fontsize = 5; </span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置坐标</span></span><br><span class="line">            <span class="variable">$x</span> = (<span class="variable">$i</span>*<span class="variable">$width</span>/<span class="number">4</span>)+<span class="title function_ invoke__">rand</span>(<span class="number">5</span>,<span class="number">10</span>);</span><br><span class="line">            <span class="variable">$y</span> = <span class="title function_ invoke__">rand</span>((<span class="variable">$height</span>+<span class="variable">$fontsize</span>)/<span class="number">2</span>-<span class="number">5</span>,(<span class="variable">$height</span>+<span class="variable">$fontsize</span>)/<span class="number">2</span>+<span class="number">5</span>);</span><br><span class="line">            <span class="comment">//imagestring($image,$fontsize,$x,$y,$fontcontent,$fontcolor);</span></span><br><span class="line">            <span class="title function_ invoke__">imagettftext</span>(<span class="variable">$image</span>,<span class="variable">$fontsize</span>,<span class="title function_ invoke__">rand</span>(-<span class="number">10</span>,<span class="number">10</span>),<span class="variable">$x</span>,<span class="variable">$y</span>,<span class="variable">$fontcolor</span>,<span class="string">&#x27;font/msyh.ttf&#x27;</span>,<span class="variable">$fontcontent</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//存到session</span></span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;captcha_code&#x27;</span>] = <span class="variable">$captcha_code</span>;</span><br><span class="line">        <span class="comment">//增加干扰元素，设置雪花点</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="number">200</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">            <span class="comment">//设置点的颜色，50-200颜色比数字浅，不干扰阅读</span></span><br><span class="line">            <span class="variable">$pointcolor</span> = <span class="title function_ invoke__">imagecolorallocate</span>(<span class="variable">$image</span>,<span class="title function_ invoke__">rand</span>(<span class="number">50</span>,<span class="number">200</span>), <span class="title function_ invoke__">rand</span>(<span class="number">50</span>,<span class="number">200</span>), <span class="title function_ invoke__">rand</span>(<span class="number">50</span>,<span class="number">200</span>));    </span><br><span class="line">            <span class="comment">//imagesetpixel — 画一个单一像素</span></span><br><span class="line">            <span class="title function_ invoke__">imagesetpixel</span>(<span class="variable">$image</span>, <span class="title function_ invoke__">rand</span>(<span class="number">1</span>,<span class="variable">$width</span>-<span class="number">1</span>), <span class="title function_ invoke__">rand</span>(<span class="number">1</span>,<span class="variable">$height</span>-<span class="number">1</span>), <span class="variable">$pointcolor</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//增加干扰元素，设置横线</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="number">2</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">            <span class="comment">//设置线的颜色</span></span><br><span class="line">            <span class="variable">$linecolor</span> = <span class="title function_ invoke__">imagecolorallocate</span>(<span class="variable">$image</span>,<span class="title function_ invoke__">rand</span>(<span class="number">80</span>,<span class="number">220</span>), <span class="title function_ invoke__">rand</span>(<span class="number">80</span>,<span class="number">220</span>),<span class="title function_ invoke__">rand</span>(<span class="number">80</span>,<span class="number">220</span>));</span><br><span class="line">            <span class="comment">//设置线，两点一线</span></span><br><span class="line">            <span class="title function_ invoke__">imageline</span>(<span class="variable">$image</span>,<span class="title function_ invoke__">rand</span>(<span class="number">1</span>,<span class="variable">$width</span>-<span class="number">1</span>), <span class="title function_ invoke__">rand</span>(<span class="number">1</span>,<span class="variable">$height</span>-<span class="number">1</span>),<span class="title function_ invoke__">rand</span>(<span class="number">1</span>,<span class="variable">$width</span>-<span class="number">1</span>), <span class="title function_ invoke__">rand</span>(<span class="number">1</span>,<span class="variable">$height</span>-<span class="number">1</span>),<span class="variable">$linecolor</span>);</span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">        <span class="comment">//设置头部，image/png</span></span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type: image/png&#x27;</span>);</span><br><span class="line">        <span class="comment">//imagepng() 建立png图形函数</span></span><br><span class="line">        <span class="title function_ invoke__">imagepng</span>(<span class="variable">$image</span>);</span><br><span class="line">        <span class="comment">//imagedestroy() 结束图形函数 销毁$image</span></span><br><span class="line">        <span class="title function_ invoke__">imagedestroy</span>(<span class="variable">$image</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionCheck</span>(<span class="params"><span class="variable">$code</span></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">session_start</span>();</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;captcha_code&#x27;</span>]))&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;captcha_code&#x27;</span>] == <span class="variable">$code</span>)&#123;</span><br><span class="line">                <span class="keyword">unset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;captcha_code&#x27;</span>]);</span><br><span class="line">                <span class="variable">$result</span> = <span class="keyword">array</span>(</span><br><span class="line">                    <span class="string">&#x27;code&#x27;</span>=&gt; <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;ext&#x27;</span>=&gt; <span class="string">&#x27;验证成功&#x27;</span></span><br><span class="line">                );</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$result</span> = <span class="keyword">array</span>(</span><br><span class="line">                    <span class="string">&#x27;code&#x27;</span>=&gt; <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;ext&#x27;</span>=&gt; <span class="string">&#x27;验证码错误&#x27;</span></span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$result</span> = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&#x27;code&#x27;</span>=&gt; <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;ext&#x27;</span>=&gt; <span class="string">&#x27;请先刷新验证码&#x27;</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$result</span>,JSON_UNESCAPED_UNICODE);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="使用"><span class="post-title-index">5.</span><a href="#使用" class="headerlink" title="使用"></a> 使用</h1><h2 id="接口"><span class="post-title-index">5.1.</span><a href="#接口" class="headerlink" title="接口"></a> 接口</h2><p>获取验证码接口：<a target="_blank" rel="noopener" href="http://localhost/basic/web/util/captcha/getcode">http://localhost/basic/web/util/captcha/getcode</a></p><p>验证验证码接口：<a target="_blank" rel="noopener" href="http://localhost/basic/web/util/captcha/check?code=f7nh">http://localhost/basic/web/util/captcha/check?code=f7nh</a></p><h2 id="显示"><span class="post-title-index">5.2.</span><a href="#显示" class="headerlink" title="显示"></a> 显示</h2><p>在smarty渲染的页面中，直接使用验证码接口即可显示图片。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;&lt;img <span class="attribute">id</span>=<span class="string">&quot;captcha&quot;</span> <span class="attribute">src</span>=<span class="string">&quot;http://localhost/basic/web/util/captcha/getcode&quot;</span> <span class="attribute">alt</span>=<span class="string">&quot;&quot;</span>&gt;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;请输入验证码：&lt;input <span class="attribute">id</span>=<span class="string">&quot;code&quot;</span> <span class="attribute">type</span>=<span class="string">&quot;text&quot;</span>&gt;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;&lt;input <span class="attribute">id</span>=<span class="string">&quot;check&quot;</span> <span class="attribute">type</span>=<span class="string">&quot;button&quot;</span> <span class="attribute">value</span>=<span class="string">&quot;确定&quot;</span>&gt;&lt;/p&gt;</span><br></pre></td></tr></table></figure><h2 id="刷新"><span class="post-title-index">5.3.</span><a href="#刷新" class="headerlink" title="刷新"></a> 刷新</h2><p>如果要刷新验证码，在js中重置src地址即可。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">&#x27;#captcha&#x27;</span>).<span class="title function_">click</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> $new_src = <span class="string">&#x27;http://localhost/basic/web/util/captcha/getcode?&#x27;</span>+<span class="title class_">Math</span>.<span class="title function_">random</span>();</span><br><span class="line">    $(<span class="variable language_">this</span>).<span class="title function_">attr</span>(<span class="string">&#x27;src&#x27;</span>,$new_src);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="验证"><span class="post-title-index">5.4.</span><a href="#验证" class="headerlink" title="验证"></a> 验证</h2><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">&#x27;#check&#x27;</span>).click(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> data = &#123;</span><br><span class="line">        <span class="attr">code</span>: $(<span class="string">&#x27;#code&#x27;</span>).val()</span><br><span class="line">    &#125;;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        <span class="attr">url</span>: <span class="string">&#x27;http://localhost/basic/web/util/captcha/check&#x27;</span>,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">        <span class="attr">dataType</span>: <span class="string">&#x27;json&#x27;</span>,</span><br><span class="line">        <span class="attr">data</span>: data,</span><br><span class="line">        <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">            alert(data.ext);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params">xhr</span>)&#123;</span><br><span class="line">            <span class="built_in">console</span>.<span class="built_in">log</span>(xhr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="效果演示"><span class="post-title-index">5.5.</span><a href="#效果演示" class="headerlink" title="效果演示"></a> 效果演示</h2><p><img src="http://cdn.voidking.com/img/yii-smarty-captcha/result.gif?imageView2/0/w/700"></p><h1 id="源码分享"><span class="post-title-index">6.</span><a href="#源码分享" class="headerlink" title="源码分享"></a> 源码分享</h1><p>1、下载安装：<code>git clone https://github.com/voidking/yii-basic.git basic</code></p><p>2、利用navicat等工具连接到本地mysql数据库，创建数据库basic，在数据库中创建表bas_project(int id, varchar title, varchar content)。注意，编码格式选择utf8。</p><p>3、验证码测试页url：<br><a target="_blank" rel="noopener" href="http://localhost/basic/web/util/captcha/index">http://localhost/basic/web/util/captcha/index</a></p><h1 id="书签"><span class="post-title-index">7.</span><a href="#书签" class="headerlink" title="书签"></a> 书签</h1><p><a target="_blank" rel="noopener" href="https://www.helloweba.com/view-blog-191.html">PHP生成各种验证码和Ajax验证</a></p><p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/m-m-g-y0416/p/5689797.html">PHP如何实现验证码</a></p></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 好好学习的郝</li><li class="post-copyright-link"> <strong>原文链接：</strong> <a href="https://www.voidking.com/dev-yii-smarty-captcha/" title="yii框架整合smarty使用自定义验证码">https://www.voidking.com/dev-yii-smarty-captcha/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本文采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议，转载请注明出处！源站会即时更新知识点并修正错误，欢迎访问~</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/php/" rel="tag"># php</a> <a href="/tags/yii/" rel="tag"># yii</a> <a href="/tags/%E9%AA%8C%E8%AF%81%E7%A0%81/" rel="tag"># 验证码</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-php-debug-xdebug/" rel="prev" title="好好学PHP：PHP调试之Xdebug+PhpStorm"><i class="fa fa-chevron-left"></i> 好好学PHP：PHP调试之Xdebug+PhpStorm</a></div><div class="post-nav-item"> <a href="/dev-navicat-mysqldiff/" rel="next" title="好好学MySQL：使用Navicat对比和同步MySQL">好好学MySQL：使用Navicat对比和同步MySQL<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="footer-ads" style="margin-top:10px"></div><div class="comments" id="gitalk-container"></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">1. 前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF"><span class="nav-text">2. 设计思路</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-text">3. 项目结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="nav-text">4. 代码实现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-text">5. 使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3"><span class="nav-text">5.1. 接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%98%BE%E7%A4%BA"><span class="nav-text">5.2. 显示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%B7%E6%96%B0"><span class="nav-text">5.3. 刷新</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81"><span class="nav-text">5.4. 验证</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%88%E6%9E%9C%E6%BC%94%E7%A4%BA"><span class="nav-text">5.5. 效果演示</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E4%BA%AB"><span class="nav-text">6. 源码分享</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B9%A6%E7%AD%BE"><span class="nav-text">7. 书签</span></a></li></ol></div></div><div class="sidecar-ads" style="margin-top:10px"><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">一个计算机技术爱好者与学习者</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">779</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">34</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">271</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2026</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="https://cdn.staticfile.net/gitalk/1.7.2/gitalk.min.css"><script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('https://cdn.staticfile.net/gitalk/1.7.2/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID: '5a238b8c32b1e4dd2156',
      clientSecret: 'bfb5d518626f6fdc7da0351d1e0cd37ab75c6361',
      repo: 'gitalk-comments',
      owner: 'voidking',
      admin: ['voidking'],
      id: 'f44e09303ca432f1e6f1af3d834a5005',
      title: 'yii框架整合smarty使用自定义验证码',
      body: '欢迎留言，互相交流学习~',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script></body></html>