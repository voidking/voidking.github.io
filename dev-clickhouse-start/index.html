<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1,cdn:{enable:!0,url:"//cdn.voidking.com/search.xml"}},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="ClickHouse简介 ClickHouse 是一个用于联机分析(OLAP)的列式数据库管理系统(DBMS)。  参考文档：   GitHub - ClickHouse 什么是ClickHouse？ ClickHouse深度揭秘"><meta property="og:type" content="article"><meta property="og:title" content="ClickHouse入门篇"><meta property="og:url" content="https://www.voidking.com/dev-clickhouse-start/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="ClickHouse简介 ClickHouse 是一个用于联机分析(OLAP)的列式数据库管理系统(DBMS)。  参考文档：   GitHub - ClickHouse 什么是ClickHouse？ ClickHouse深度揭秘"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2022-09-06T20:00:00.000Z"><meta property="article:modified_time" content="2023-04-08T08:00:00.000Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="macos"><meta property="article:tag" content="chatgpt"><meta property="article:tag" content="数据库"><meta property="article:tag" content="clickhouse"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.voidking.com/dev-clickhouse-start/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>ClickHouse入门篇 | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">好好学习，天天向上！</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-clickhouse-start/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="学而不思则罔，思而不学则殆！"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> ClickHouse入门篇</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-09-06 20:00:00" itemprop="dateCreated datePublished" datetime="2022-09-06T20:00:00+00:00">2022-09-06</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-04-08 08:00:00" itemprop="dateModified" datetime="2023-04-08T08:00:00+00:00">2023-04-08</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/" itemprop="url" rel="index"><span itemprop="name">engineering</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/database/" itemprop="url" rel="index"><span itemprop="name">database</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="ClickHouse简介"><a href="#ClickHouse简介" class="headerlink" title="ClickHouse简介"></a>ClickHouse简介</h1><blockquote><p><a target="_blank" rel="noopener" href="https://clickhouse.tech/">ClickHouse</a> 是一个用于联机分析(OLAP)的列式数据库管理系统(DBMS)。</p></blockquote><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://github.com/ClickHouse/ClickHouse/">GitHub - ClickHouse</a></li><li><a target="_blank" rel="noopener" href="https://clickhouse.com/docs/zh/">什么是ClickHouse？</a></li><li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/98135840">ClickHouse深度揭秘</a></li></ul><span id="more"></span><h1 id="ClickHouse基础概念"><a href="#ClickHouse基础概念" class="headerlink" title="ClickHouse基础概念"></a>ClickHouse基础概念</h1><p>在clickhouse集群中，clickhouse的表有两种类型：一种是本地表，一种是分布式表。<br>在单机情况下，使用本地表就可以了；在集群情况下，一般使用分布式表。<br>ch的单机和分布式的增删查改差异很大，使用的时候需要注意。<br>分布式表首先需要在集群所有节点上创建本地表，然后在本地表的基础上创建分布式表（本质是分布式视图），通过分布式表引擎聚合本地表引擎的数据。</p><p>一般写入使用本地表，查询使用分布式表。</p><p>写分布式表的优点：可以让ClickHouse控制数据到分片的路由。<br>写分布式表的缺点：</p><ul><li>数据是先写到一个分布式表的实例中并缓存起来，再逐渐分发到各个分片上去，实际是双写了数据（写入放大），浪费资源；</li><li>数据写入默认是异步的，短时间内可能造成不一致；</li><li>目标表中会产生较多的小parts，使merge（即compaction）过程压力增大。</li></ul><p>写本地表优点：同步操作，更快，parts的大小也比较合适。<br>写本地表缺点：要求应用层额外实现sharding和路由逻辑，如轮询或者随机等。</p><p>表引擎特殊说明：</p><ul><li>20版本的ch只有使用了replicated开头的engine的引擎的表，才能够在拥有on cluster xxx条件的ddl语句中进行集群更新；其他engine的表，只能够每个node进行update；21版本修复了这个bug。</li><li>目前阿里云20版本的ch的mergeTree引擎是支持on cluster xxx这样的ddl语句的。</li></ul><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/167447.html">ClickHouse - 基本概念</a></li><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_46124208/article/details/123705318">ClickHouse创建分布式表</a></li><li><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/162815.html">ClickHouse常见问题</a></li><li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1979174">「Clickhouse系列」分布式表&amp;本地表详解</a></li><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/laoqing/p/15954171.html">CK 分布式表和本地表</a></li><li><a target="_blank" rel="noopener" href="https://www.modb.pro/db/84325">clickhouse单机的增删查询实现方案和clickhouse分布式部署的增删查改实现方案</a></li><li><a target="_blank" rel="noopener" href="https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/replication/#creating-replicated-tables">ClickHouse - Data Replication</a></li><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_25073261/article/details/123670028">clickhouse删除ReplicatedMergeTree复制表后，新建同名表失败原因分析</a></li></ul><h1 id="安装ClickHouse服务端"><a href="#安装ClickHouse服务端" class="headerlink" title="安装ClickHouse服务端"></a>安装ClickHouse服务端</h1><p>参考文档<a href="https://www.voidking.com/dev-k8s-clickhouse/">《K8S中安装配置ClickHouse》</a></p><h1 id="安装ClickHouse客户端"><a href="#安装ClickHouse客户端" class="headerlink" title="安装ClickHouse客户端"></a>安装ClickHouse客户端</h1><h2 id="dbeaver"><a href="#dbeaver" class="headerlink" title="dbeaver"></a>dbeaver</h2><p>使用<a target="_blank" rel="noopener" href="https://dbeaver.io/">dbeaver</a>，可以图形化连接clickhouse。<br>安装方法：下载安装包，双击安装。</p><h2 id="clickhouse-client"><a href="#clickhouse-client" class="headerlink" title="clickhouse-client"></a>clickhouse-client</h2><p>使用<a target="_blank" rel="noopener" href="https://clickhouse.com/docs/en/integrations/sql-clients/cli">clickhouse-client</a>，可以命令行连接clickhouse。</p><p>安装方法参考<a target="_blank" rel="noopener" href="https://clickhouse.com/docs/zh/getting-started/install/">ClickHouse - 安装</a></p><h3 id="centos7中安装"><a href="#centos7中安装" class="headerlink" title="centos7中安装"></a>centos7中安装</h3><p>安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://packages.clickhouse.com/rpm/stable/clickhouse-common-static-21.8.15.7-2.x86_64.rpm</span><br><span class="line">wget https://packages.clickhouse.com/rpm/stable/clickhouse-client-21.8.15.7-2.noarch.rpm</span><br><span class="line">rpm -ivh clickhouse-common-static-21.8.15.7-2.x86_64.rpm</span><br><span class="line">rpm -ivh clickhouse-client-21.8.15.7-2.noarch.rpm</span><br></pre></td></tr></table></figure><p>测试：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clickhouse-client -h 192.168.56.101 --port 9000 \</span><br><span class="line">-u default --password xxx \</span><br><span class="line">--query <span class="string">&quot;select hostName()&quot;</span></span><br></pre></td></tr></table></figure><p>如果执行报错：Code: 102. DB::NetException: Unexpected packet from server 192.168.56.101:9000 (expected Hello or Exception, got Unknown packet). (UNEXPECTED_PACKET_FROM_SERVER)</p><p>请检查clickhouse服务端端口是否正确，改成正确的端口。</p><h3 id="macos中安装"><a href="#macos中安装" class="headerlink" title="macos中安装"></a>macos中安装</h3><p>安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -O <span class="string">&#x27;https://builds.clickhouse.com/master/macos/clickhouse&#x27;</span> &amp;&amp; <span class="built_in">chmod</span> a+x ./clickhouse</span><br></pre></td></tr></table></figure><p>测试：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./clickhouse client -h 192.168.56.101 --port 9000 \</span><br><span class="line">-u default --password xxx \</span><br><span class="line">--query <span class="string">&quot;select hostName()&quot;</span></span><br></pre></td></tr></table></figure><h1 id="使用ClickHouse"><a href="#使用ClickHouse" class="headerlink" title="使用ClickHouse"></a>使用ClickHouse</h1><h2 id="使用分布式表"><a href="#使用分布式表" class="headerlink" title="使用分布式表"></a>使用分布式表</h2><p>1、新建分布式表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看宏变量</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> `<span class="keyword">system</span>`.macros;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看cluster</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> `<span class="keyword">system</span>`.clusters;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建本地表</span></span><br><span class="line"><span class="comment">-- create table `default`.optest on cluster cluster (a UInt64) Engine = MergeTree() order by tuple();</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `<span class="keyword">default</span>`.optest <span class="keyword">on</span> cluster cluster (a UInt64) Engine <span class="operator">=</span> ReplicatedMergeTree(<span class="string">&#x27;/clickhouse/tables/&#123;shard&#125;/default.optest&#x27;</span>,<span class="string">&#x27;&#123;replica&#125;&#x27;</span>) <span class="keyword">order</span> <span class="keyword">by</span> tuple();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建本地表对应的分布式表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `<span class="keyword">default</span>`.optest_dis <span class="keyword">on</span> cluster cluster <span class="keyword">as</span> optest Engine <span class="operator">=</span> Distributed(cluster, <span class="keyword">default</span>, optest, cityHash64(a));</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除本地表</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> `<span class="keyword">default</span>`.optest <span class="keyword">on</span> cluster cluster;</span><br><span class="line"><span class="comment">-- 要等待480s才会删除zk中的数据</span></span><br></pre></td></tr></table></figure><p>order by指定的字段是对分区内数据进行排序，在ReplicatedMergeTree引擎下，会对相邻的重复数据进行删除。</p><p>2、增删查改</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">default</span>`.optest(a) <span class="keyword">values</span>(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `<span class="keyword">default</span>`.optest_dis;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `<span class="keyword">default</span>`.optest  <span class="keyword">on</span> cluster cluster <span class="keyword">UPDATE</span> `a` <span class="operator">=</span> <span class="string">&#x27;11&#x27;</span> <span class="keyword">WHERE</span> `a` <span class="operator">=</span> <span class="string">&#x27;10&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `<span class="keyword">default</span>`.optest_dis;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `<span class="keyword">default</span>`.optest <span class="keyword">on</span> cluster cluster <span class="keyword">DELETE</span> <span class="keyword">WHERE</span> `a`<span class="operator">=</span><span class="string">&#x27;11&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `<span class="keyword">default</span>`.optest_dis;</span><br></pre></td></tr></table></figure><h1 id="更新延迟处理"><a href="#更新延迟处理" class="headerlink" title="更新延迟处理"></a>更新延迟处理</h1><p>从使用场景来说，Clickhouse是个分析型数据库。这种场景下，数据一般是不变的，因此Clickhouse对update、delete的支持是比较弱的，实际上并不支持标准的update、delete操作。</p><p>Clickhouse通过alter方式实现更新、删除，它把update、delete操作叫做mutation(突变)。</p><p>标准SQL的更新、删除操作是同步的，即客户端要等服务端反回执行结果（通常是int值）；而Clickhouse的update、delete是通过异步方式实现的，当执行update语句时，服务端立即反回，但是实际上此时数据还没变，而是排队等着。</p><p>ClickHouse本身对update的执行是低效的，因为ClickHouse的MergeTree存储一旦生成一个Data Part，这个Part就不支持更改，而是需要删除旧Part, 重写整个Part。所以从MergeTree存储内核层面，ClickHouse就不擅长做数据更新删除操作。</p><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://www.modb.pro/db/197765">ClickHouse多种实时更新方法总结</a></li><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/MrYang-11-GetKnow/p/15975818.html">clickhouse数据实时更新实现的三种方式</a></li><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41893274/article/details/117093168">Clickhouse中update/delete的使用</a></li></ul><h2 id="mutations-sync"><a href="#mutations-sync" class="headerlink" title="mutations_sync"></a>mutations_sync</h2><p>使用mutations_sync参数，是最简单的方法。<br>方法一：客户端和clickhouse建立连接时，添加参数<code>mutations_sync=2</code><br>方法二：执行sql时，添加参数<code>settings mutations_sync=2</code><br>方法三：修改clickhouse服务端配置，设置<code>mutations_sync=2</code></p><p>python客户端连接参数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ck_config = &#123;</span><br><span class="line">  <span class="string">&quot;host&quot;</span>: ck_host, </span><br><span class="line">  <span class="string">&quot;port&quot;</span>: ck_port, </span><br><span class="line">  <span class="string">&quot;user&quot;</span>: ck_user, </span><br><span class="line">  <span class="string">&quot;password&quot;</span>: ck_pwd, </span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;<span class="string">&quot;mutations_sync&quot;</span>: <span class="string">&quot;2&quot;</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是，如果存在大量更新，这种方法会大量重建Part，效率会很低。</p><h2 id="ReplacingMergeTree"><a href="#ReplacingMergeTree" class="headerlink" title="ReplacingMergeTree"></a>ReplacingMergeTree</h2><p>ReplacingMergeTree + INSERT + Final 可以实现虚拟更新，以insert代替alter操作，每次select时都拉取最新一条数据。<br>当执行optimize时，老的数据才会被删除。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tb_test_replacing(</span><br><span class="line">ts DateTime,</span><br><span class="line">uid String,</span><br><span class="line">biz String</span><br><span class="line">) ENGINE <span class="operator">=</span> ReplacingMergeTree(ts) <span class="keyword">ORDER</span> <span class="keyword">BY</span> (ts) SETTINGS index_granularity <span class="operator">=</span> <span class="number">8192</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tb_test_replacing <span class="keyword">VALUES</span> (<span class="string">&#x27;2019-06-07 20:01:01&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;c1&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tb_test_replacing <span class="keyword">VALUES</span> (<span class="string">&#x27;2019-06-07 20:01:01&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;c2&#x27;</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tb_test_replacing;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tb_test_replacing <span class="keyword">FINAL</span>;</span><br><span class="line">optimize <span class="keyword">table</span> tb_test_replacing;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tb_test_replacing;</span><br></pre></td></tr></table></figure><h1 id="从MySQL同步数据到ClickHouse"><a href="#从MySQL同步数据到ClickHouse" class="headerlink" title="从MySQL同步数据到ClickHouse"></a>从MySQL同步数据到ClickHouse</h1><h2 id="ClickHouse官方工具"><a href="#ClickHouse官方工具" class="headerlink" title="ClickHouse官方工具"></a>ClickHouse官方工具</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> allow_experimental_database_materialize_mysql <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">value</span> <span class="keyword">from</span> system.settings <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;allow_experimental_database_materialize_mysql&#x27;</span>;</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db1_mysql</span><br><span class="line">ENGINE <span class="operator">=</span> MaterializeMySQL(</span><br><span class="line">  <span class="string">&#x27;mysql-host.domain.com:3306&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;db1&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;clickhouse_user&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;ClickHouse_123&#x27;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://clickhouse.com/docs/en/integrations/mysql/mysql-with-clickhouse-database-engine/">Replicate a MySQL Database in ClickHouse</a></li><li><a target="_blank" rel="noopener" href="https://clickhouse.com/docs/en/integrations/mysql">Integrating MySQL with ClickHouse</a></li><li><a target="_blank" rel="noopener" href="https://clickhouse.com/docs/en/engines/database-engines/materialized-mysql">[experimental] MaterializedMySQL</a></li><li><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/209912.html">MaterializeMySQL引擎</a></li><li><a target="_blank" rel="noopener" href="https://bohutang.me/2020/07/26/clickhouse-and-friends-mysql-replication/">ClickHouse和他的朋友们（9）MySQL实时复制与实现</a></li></ul><p>注意：官方文档中的<code>materialized</code>，需要改成<code>materialize</code>。</p><h2 id="MaterializeMySQL同步原理（ChatGPT）"><a href="#MaterializeMySQL同步原理（ChatGPT）" class="headerlink" title="MaterializeMySQL同步原理（ChatGPT）"></a>MaterializeMySQL同步原理（ChatGPT）</h2><p>使用 MaterializeMySQL 引擎同步数据时，首先会进行一次全量同步，然后再进行增量同步。</p><h3 id="全量同步"><a href="#全量同步" class="headerlink" title="全量同步"></a>全量同步</h3><p>全量同步的过程：</p><p>1、建立连接：首先需要建立到 MySQL 服务器的连接，提供主机名、端口、用户名和密码。</p><p>2、创建数据库：在 ClickHouse 中创建一个使用 MaterializeMySQL 引擎的数据库。这将自动触发全量同步过程。</p><p>3、获取数据表结构：ClickHouse 会从 MySQL 数据库获取表的结构信息，包括列名、数据类型等，并在 ClickHouse 中创建相应的表结构。</p><p>4、导出数据：ClickHouse 会从 MySQL 数据库导出所有表的数据。这一过程通常使用 mysqldump 工具或类似方法来完成。</p><p>5、导入数据：将导出的数据导入到 ClickHouse 中相应的表中。在这个过程中，数据可能需要进行转换，以便与 ClickHouse 的数据格式相匹配。</p><p>6、启动增量同步：完成全量同步后，ClickHouse 会自动开始监听 MySQL 服务器的二进制日志，以实时捕获和应用数据更改。</p><h3 id="增量同步"><a href="#增量同步" class="headerlink" title="增量同步"></a>增量同步</h3><p>使用ClickHouse的MaterializeMySQL引擎增量同步数据的原理主要基于MySQL的二进制日志（Binary Log，简称binlog）。二进制日志是MySQL用于记录所有更改（如数据修改和表结构变更）的日志文件。binlog是一种行级别的日志记录格式，包含足够的信息来重放所有已执行的数据更改。</p><p>以下是MaterializeMySQL引擎同步数据的主要步骤：</p><p>1、连接到 MySQL：首先，ClickHouse 需要连接到 MySQL 服务器。为此，需要提供 MySQL 服务器的连接信息，如主机名、端口、用户名和密码。</p><p>2、读取 binlog：ClickHouse 从 MySQL 服务器读取二进制日志，这些日志记录了数据库中的所有更改。ClickHouse 使用 mysqlbinlog 工具解析二进制日志文件。</p><p>3、解析更改：ClickHouse 解析二进制日志中的事件，如插入、更新、删除操作。这些事件将被转换为 ClickHouse 可以理解的格式。</p><p>4、应用更改：根据解析的更改事件，ClickHouse 更新其数据库。此过程涉及将更改应用到相应的表和列中。</p><p>5、实时同步：MaterializeMySQL 引擎会持续监听 MySQL 服务器的二进制日志，当 MySQL 数据库中发生数据更改事件时，ClickHouse 会立即捕获这些事件并应用相应的更改。</p><h2 id="clickhouse-client-1"><a href="#clickhouse-client-1" class="headerlink" title="clickhouse-client"></a>clickhouse-client</h2><p>clickhouse-client支持通过输入数据文件、管道、JDBC等方式导入数据。可以将MySQL中的数据导出成csv文件，然后使用clickhouse-client导入到ClickHouse中。</p><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://clickhouse.com/docs/en/interfaces/cli/">Command-Line Client</a></li></ul><h2 id="阿里云工具"><a href="#阿里云工具" class="headerlink" title="阿里云工具"></a>阿里云工具</h2><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/146006.html">阿里云ClickHouse - 从MySQL导入数据</a></li><li><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/196622.html">阿里云ClickHouse - 从RDS MySQL同步</a></li></ul></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 好好学习的郝</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.voidking.com/dev-clickhouse-start/" title="ClickHouse入门篇">https://www.voidking.com/dev-clickhouse-start/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！源站会及时更新知识点及修正错误，阅读体验也更好。欢迎分享，欢迎收藏~</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/macos/" rel="tag"># macos</a> <a href="/tags/chatgpt/" rel="tag"># chatgpt</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"># 数据库</a> <a href="/tags/clickhouse/" rel="tag"># clickhouse</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-k8s-clickhouse/" rel="prev" title="K8S中安装配置ClickHouse"><i class="fa fa-chevron-left"></i> K8S中安装配置ClickHouse</a></div><div class="post-nav-item"> <a href="/dev-gitlab-cicd/" rel="next" title="GitLab CI/CD入门篇">GitLab CI/CD入门篇<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="footer-ads" style="margin-top:10px"><ins class="adsbygoogle" style="display:block" data-ad-format="autorelaxed" data-ad-client="ca-pub-3284447971731414" data-ad-slot="9697986181"></ins><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3284447971731414" crossorigin="anonymous"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div class="comments" id="gitalk-container"></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ClickHouse%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">ClickHouse简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ClickHouse%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="nav-number">2.</span> <span class="nav-text">ClickHouse基础概念</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85ClickHouse%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-number">3.</span> <span class="nav-text">安装ClickHouse服务端</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85ClickHouse%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">4.</span> <span class="nav-text">安装ClickHouse客户端</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#dbeaver"><span class="nav-number">4.1.</span> <span class="nav-text">dbeaver</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#clickhouse-client"><span class="nav-number">4.2.</span> <span class="nav-text">clickhouse-client</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#centos7%E4%B8%AD%E5%AE%89%E8%A3%85"><span class="nav-number">4.2.1.</span> <span class="nav-text">centos7中安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#macos%E4%B8%AD%E5%AE%89%E8%A3%85"><span class="nav-number">4.2.2.</span> <span class="nav-text">macos中安装</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8ClickHouse"><span class="nav-number">5.</span> <span class="nav-text">使用ClickHouse</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%88%86%E5%B8%83%E5%BC%8F%E8%A1%A8"><span class="nav-number">5.1.</span> <span class="nav-text">使用分布式表</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E5%BB%B6%E8%BF%9F%E5%A4%84%E7%90%86"><span class="nav-number">6.</span> <span class="nav-text">更新延迟处理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#mutations-sync"><span class="nav-number">6.1.</span> <span class="nav-text">mutations_sync</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ReplacingMergeTree"><span class="nav-number">6.2.</span> <span class="nav-text">ReplacingMergeTree</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BB%8EMySQL%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE%E5%88%B0ClickHouse"><span class="nav-number">7.</span> <span class="nav-text">从MySQL同步数据到ClickHouse</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ClickHouse%E5%AE%98%E6%96%B9%E5%B7%A5%E5%85%B7"><span class="nav-number">7.1.</span> <span class="nav-text">ClickHouse官方工具</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MaterializeMySQL%E5%90%8C%E6%AD%A5%E5%8E%9F%E7%90%86%EF%BC%88ChatGPT%EF%BC%89"><span class="nav-number">7.2.</span> <span class="nav-text">MaterializeMySQL同步原理（ChatGPT）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E9%87%8F%E5%90%8C%E6%AD%A5"><span class="nav-number">7.2.1.</span> <span class="nav-text">全量同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A2%9E%E9%87%8F%E5%90%8C%E6%AD%A5"><span class="nav-number">7.2.2.</span> <span class="nav-text">增量同步</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#clickhouse-client-1"><span class="nav-number">7.3.</span> <span class="nav-text">clickhouse-client</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%BF%E9%87%8C%E4%BA%91%E5%B7%A5%E5%85%B7"><span class="nav-number">7.4.</span> <span class="nav-text">阿里云工具</span></a></li></ol></li></ol></div></div><div class="sidecar-ads" style="margin-top:10px"><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">学而不思则罔，思而不学则殆！</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">646</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">30</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">242</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/gitalk/1.7.2/gitalk.min.css"><script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/gitalk/1.7.2/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID: '5a238b8c32b1e4dd2156',
      clientSecret: 'bfb5d518626f6fdc7da0351d1e0cd37ab75c6361',
      repo: 'gitalk-comments',
      owner: 'voidking',
      admin: ['voidking'],
      id: '268b7397b03d9a353cd9fd784071734e',
      title: 'ClickHouse入门篇',
      body: '欢迎留言，互相交流学习~',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script></body></html>