<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1,cdn:{enable:!0,url:"//qiniu-cdn.voidking.com/doc/search.xml"}},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="需求描述当前有十台主机，主机IP为192.168.56.101-110，用户为voidking，具有sudo权限。现在想要用这十台主机搭建一个K8S集群，版本1.22.15，其中3台作为master，7台作为worker。 参考文档：  利用 kubeadm 创建高可用集群 High Availability Considerations k8s高可用部署：keepalived + haproxy"><meta property="og:type" content="article"><meta property="og:title" content="ansible+kubeadm部署K8S高可用集群"><meta property="og:url" content="https://www.voidking.com/dev-ansible-kubeadm/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="需求描述当前有十台主机，主机IP为192.168.56.101-110，用户为voidking，具有sudo权限。现在想要用这十台主机搭建一个K8S集群，版本1.22.15，其中3台作为master，7台作为worker。 参考文档：  利用 kubeadm 创建高可用集群 High Availability Considerations k8s高可用部署：keepalived + haproxy"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2022-09-30T15:00:00.000Z"><meta property="article:modified_time" content="2022-12-02T14:00:00.000Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="centos"><meta property="article:tag" content="docker"><meta property="article:tag" content="网络"><meta property="article:tag" content="k8s"><meta property="article:tag" content="ansible"><meta property="article:tag" content="keepalived"><meta property="article:tag" content="haproxy"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.voidking.com/dev-ansible-kubeadm/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>ansible+kubeadm部署K8S高可用集群 | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">一个计算机技术爱好者与学习者</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-ansible-kubeadm/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="一个计算机技术爱好者与学习者"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> ansible+kubeadm部署K8S高可用集群</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-09-30 15:00:00" itemprop="dateCreated datePublished" datetime="2022-09-30T15:00:00+00:00">2022-09-30</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-12-02 14:00:00" itemprop="dateModified" datetime="2022-12-02T14:00:00+00:00">2022-12-02</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/" itemprop="url" rel="index"><span itemprop="name">engineering</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/devops/" itemprop="url" rel="index"><span itemprop="name">devops</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/network/" itemprop="url" rel="index"><span itemprop="name">network</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/cloudnative/" itemprop="url" rel="index"><span itemprop="name">cloudnative</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="需求描述"><span class="post-title-index">1.</span><a href="#需求描述" class="headerlink" title="需求描述"></a> 需求描述</h1><p>当前有十台主机，主机IP为<code>192.168.56.101-110</code>，用户为<code>voidking</code>，具有sudo权限。<br>现在想要用这十台主机搭建一个K8S集群，版本1.22.15，其中3台作为master，7台作为worker。</p><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/high-availability/">利用 kubeadm 创建高可用集群</a></li><li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubeadm/blob/main/docs/ha-considerations.md#options-for-software-load-balancing">High Availability Considerations</a></li><li><a target="_blank" rel="noopener" href="https://www.kubernetes.org.cn/6964.html">k8s高可用部署：keepalived + haproxy</a></li><li><a target="_blank" rel="noopener" href="https://kubesphere.io/zh/docs/v3.3/installing-on-linux/high-availability-configurations/set-up-ha-cluster-using-keepalived-haproxy/">使用 Keepalived 和 HAproxy 创建高可用 Kubernetes 集群</a></li><li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1888164">利用 kubeadm 创建 kubernetes 的高可用集群</a></li></ul><h1 id="安装思路"><span class="post-title-index">2.</span><a href="#安装思路" class="headerlink" title="安装思路"></a> 安装思路</h1><p>最简单的方法，我们可以使用kubeadm逐个主机进行安装配置，参考<a href="https://www.voidking.com/dev-kubeadm-install-k8s-in-centos/">《kubeadm安装部署K8S集群——CentOS篇》</a>。</p><p>但是挨个安装效率太低了，所以我们希望能够批量安装，使用 ansible+kubeadm 。有一个<a target="_blank" rel="noopener" href="https://github.com/kairen/kubeadm-ansible">kubeadm-ansible</a>项目，可以使用ansible+kubeadm实现批量安装，但是已经废弃了（两年没有更新，issue也没人处理）。<br>因此，需要自行实现ansible+kubeadm的批量安装方式。</p><p>此外，因为要3台master配置高可用，所以还要安装keepalived+haproxy。</p><p>整体操作流程：</p><ul><li>管理节点安装配置ansible</li><li>所有节点安装docker</li><li>所有节点允许iptables检查桥接流量</li><li>所有节点安装kubeadm+kubelet+kubectl</li><li>master节点安装keepalived+haproxy</li><li>初始化master节点（创建集群）</li><li>worker节点加入到集群中</li><li>测试使用</li></ul><p>为方便描述，下文中使用主机IP的最后一段作为该主机的简称，例如：<code>192.168.56.101</code>简称为<code>101</code>。</p><span id="more"></span><h1 id="安装配置ansible"><span class="post-title-index">3.</span><a href="#安装配置ansible" class="headerlink" title="安装配置ansible"></a> 安装配置ansible</h1><p>参考<a href="https://www.voidking.com/dev-ansible-start/">《Ansible入门篇》</a>，选择一个节点作为管理节点（这里选择101节点），安装ansible，配置管理节点免密登录其他节点。</p><p>1、管理节点，工作目录为 <code>/home/voidking</code></p><p>2、<code>/home/voidking/hosts</code>文件内容为</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">192.168.56.101</span><br><span class="line">192.168.56.102</span><br><span class="line">192.168.56.103</span><br><span class="line">192.168.56.104</span><br><span class="line">192.168.56.105</span><br><span class="line">192.168.56.106</span><br><span class="line">192.168.56.107</span><br><span class="line">192.168.56.108</span><br><span class="line">192.168.56.109</span><br><span class="line">192.168.56.110</span><br><span class="line">[common:vars]</span><br><span class="line"></span><br><span class="line">[master]</span><br><span class="line">192.168.56.101</span><br><span class="line">192.168.56.102</span><br><span class="line">192.168.56.103</span><br><span class="line">[master:vars]</span><br><span class="line"></span><br><span class="line">[worker]</span><br><span class="line">192.168.56.104</span><br><span class="line">192.168.56.105</span><br><span class="line">192.168.56.106</span><br><span class="line">192.168.56.107</span><br><span class="line">192.168.56.108</span><br><span class="line">192.168.56.109</span><br><span class="line">192.168.56.110</span><br><span class="line">[worker:vars]</span><br></pre></td></tr></table></figure><p>3、权限测试<br>(1) 准备测试文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">touch</span> test.txt</span><br></pre></td></tr></table></figure><p>(2) 编写剧本 copy.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">common</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">voidking</span></span><br><span class="line">  <span class="attr">become_method:</span> <span class="string">sudo</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;cp test&quot;</span></span><br><span class="line">    <span class="attr">copy:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">/home/voidking/test.txt</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/tmp/</span></span><br></pre></td></tr></table></figure><p>(3) 使用sudo拷贝配置到客户机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i hosts copy.yaml</span><br></pre></td></tr></table></figure><p>如果能正常拷贝，说明sudo是允许执行<code>/bin/sh</code>命令的，没问题。</p><p>如果不能正常拷贝，提示：对不起，用户 voidking 无权以 root 的身份在 xxx 上执行 /bin/sh<br>说明sudo权限被限制了，不能sudo执行<code>/bin/sh</code>命令，那么只能换一种方式进行拷贝：添加客户机对管理机的免密访问，然后从客户机发起scp拷贝命令。</p><p>方法一：把管理机的<code>id_rsa</code>拷贝到所有客户机，这样其实所有机器都是管理机了，不够优雅<br>方法二：把所有客户机的<code>id_rsa.pub</code>添加到管理机的<code>authrized_keys</code>中，本文选择这种方法</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;ssh-keygen -t rsa -q -P &#x27;&#x27; -f ~/.ssh/id_rsa&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;cat ~/.ssh/id_rsa.pub&quot;</span> | grep -v <span class="string">&quot;SUCCESS&quot;</span> | <span class="built_in">tee</span> -a ~/.ssh/authorized_keys</span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;scp -o StrictHostKeyChecking=no voidking@192.168.56.101:~/test.txt /tmp/&quot;</span></span><br></pre></td></tr></table></figure><p>下文以sudo权限受限为前提进行部署，如果可以使用ansible copy的话会更加简单。</p><h1 id="安装docker"><span class="post-title-index">4.</span><a href="#安装docker" class="headerlink" title="安装docker"></a> 安装docker</h1><p>1、安装docker</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo yum install -y yum-utils&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo yum makecache fast&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo yum install docker-ce -y&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo systemctl start docker&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo systemctl enable docker&quot;</span></span><br></pre></td></tr></table></figure><p>2、安装docker-compose</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/v2.11.1/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o docker-compose</span><br><span class="line"><span class="built_in">chmod</span> a+x docker-compose</span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;scp -o StrictHostKeyChecking=no voidking@192.168.56.101:~/docker-compose ~/&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo cp ~/docker-compose /usr/local/bin/&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose&quot;</span></span><br></pre></td></tr></table></figure><h1 id="配置代理（可选）"><span class="post-title-index">5.</span><a href="#配置代理（可选）" class="headerlink" title="配置代理（可选）"></a> 配置代理（可选）</h1><p>参考文档<a href="https://www.voidking.com/dev-linux-network-proxy/">《Linux配置网络代理》</a></p><p>这里一定要注意：如果配置了网络代理，那么在执行<code>kubeadm init</code>的时候，环境变量中的网络代理会自动配置到组件中，引发一些奇奇怪怪的问题。</p><h2 id="配置上网代理"><span class="post-title-index">5.1.</span><a href="#配置上网代理" class="headerlink" title="配置上网代理"></a> 配置上网代理</h2><p>1、<code>.bashrc</code>中添加代理配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> http_proxy=http://192.168.56.1:7890</span><br><span class="line"><span class="built_in">export</span> https_proxy=http://192.168.56.1:7890</span><br><span class="line"><span class="built_in">export</span> no_proxy=127.0.0.1,localhost,192.168.56.0/24,10.96.0.0/12,10.244.0.0/16,172.31.0.0/16</span><br></pre></td></tr></table></figure><p>2、拷贝到所有节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;scp -o StrictHostKeyChecking=no voidking@192.168.56.101:~/.bashrc ~/.bashrc&quot;</span></span><br></pre></td></tr></table></figure><h2 id="配置docker代理"><span class="post-title-index">5.2.</span><a href="#配置docker代理" class="headerlink" title="配置docker代理"></a> 配置docker代理</h2><p>1、创建配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p ~/etc/systemd/system/docker.service.d</span><br><span class="line">vim ~/etc/systemd/system/docker.service.d/http-proxy.conf</span><br></pre></td></tr></table></figure><p>内容为：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">Environment=&quot;HTTP_PROXY=http://192.168.56.1:7890&quot;</span><br><span class="line">Environment=&quot;HTTPS_PROXY=http://192.168.56.1:7890&quot;</span><br><span class="line">Environment=&quot;NO_PROXY=127.0.0.1,localhost,192.168.56.0/24,10.96.0.0/12,10.244.0.0/16,172.31.0.0/16&quot;</span><br></pre></td></tr></table></figure><p>2、拷贝到所有节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;mkdir -p ~/etc/systemd/system/docker.service.d&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo mkdir -p /etc/systemd/system/docker.service.d&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;scp -o StrictHostKeyChecking=no voidking@192.168.56.101:~/etc/systemd/system/docker.service.d/http-proxy.conf ~/etc/systemd/system/docker.service.d/&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo cp ~/etc/systemd/system/docker.service.d/http-proxy.conf /etc/systemd/system/docker.service.d/http-proxy.conf&quot;</span></span><br></pre></td></tr></table></figure><p>3、重启docker</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo systemctl daemon-reload&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo systemctl restart docker&quot;</span></span><br><span class="line"><span class="built_in">sudo</span> docker info | grep Proxy</span><br></pre></td></tr></table></figure><h1 id="允许iptables检查桥接流量"><span class="post-title-index">6.</span><a href="#允许iptables检查桥接流量" class="headerlink" title="允许iptables检查桥接流量"></a> 允许iptables检查桥接流量</h1><p>1、 准备配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p etc/modules-load.d/</span><br><span class="line"><span class="built_in">mkdir</span> -p etc/sysctl.d/</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | tee etc/modules-load.d/k8s.conf</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | tee etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>2、 拷贝配置到所有节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;mkdir -p ~/etc/modules-load.d/&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;mkdir -p ~/etc/sysctl.d/&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;scp -o StrictHostKeyChecking=no voidking@192.168.56.101:~/etc/modules-load.d/k8s.conf ~/etc/modules-load.d/&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;scp -o StrictHostKeyChecking=no voidking@192.168.56.101:~/etc/sysctl.d/k8s.conf ~/etc/sysctl.d/&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo cp ~/etc/modules-load.d/k8s.conf /etc/modules-load.d/&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo cp ~/etc/sysctl.d/k8s.conf /etc/sysctl.d/&quot;</span></span><br></pre></td></tr></table></figure><h1 id="安装kubeadm-kubelet-kubectl"><span class="post-title-index">7.</span><a href="#安装kubeadm-kubelet-kubectl" class="headerlink" title="安装kubeadm+kubelet+kubectl"></a> 安装kubeadm+kubelet+kubectl</h1><h2 id="准备kubernetes-repo配置"><span class="post-title-index">7.1.</span><a href="#准备kubernetes-repo配置" class="headerlink" title="准备kubernetes.repo配置"></a> 准备kubernetes.repo配置</h2><p>1、当前目录下，创建kubernetes.repo文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p etc/yum.repos.d/</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | tee etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-$basearch</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">repo_gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">exclude=kubelet kubeadm kubectl</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>如果不能连通google，kubernetes.repo中的baseurl就替换成aliyun</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | tee etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>2、拷贝配置到所有节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;mkdir -p ~/etc/yum.repos.d/&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;scp -o StrictHostKeyChecking=no voidking@192.168.56.101:~/etc/yum.repos.d/kubernetes.repo ~/etc/yum.repos.d/&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo cp ~/etc/yum.repos.d/kubernetes.repo /etc/yum.repos.d/&quot;</span></span><br></pre></td></tr></table></figure><h2 id="SELinux设置为permissive模式"><span class="post-title-index">7.2.</span><a href="#SELinux设置为permissive模式" class="headerlink" title="SELinux设置为permissive模式"></a> SELinux设置为permissive模式</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo setenforce 0&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo sed -i &#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27; /etc/selinux/config&quot;</span></span><br></pre></td></tr></table></figure><h2 id="安装kubeadm-kubelet-kubectl-1"><span class="post-title-index">7.3.</span><a href="#安装kubeadm-kubelet-kubectl-1" class="headerlink" title="安装kubeadm+kubelet+kubectl"></a> 安装kubeadm+kubelet+kubectl</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo systemctl enable --now kubelet&quot;</span></span><br></pre></td></tr></table></figure><p>如果想要安装指定版本的k8s，比如1.22.15，那么需要安装指定版本的kubeadm、kubelet和kubectl。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo yum remove -y kubelet kubeadm kubectl&quot;</span></span><br><span class="line"><span class="built_in">sudo</span> yum list kubeadm kubelet kubectl --showduplicates</span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo yum install -y kubeadm-1.22.15-0 kubelet-1.22.15-0 kubectl-1.22.15-0 --disableexcludes=kubernetes&quot;</span></span><br></pre></td></tr></table></figure><h1 id="关闭swap"><span class="post-title-index">8.</span><a href="#关闭swap" class="headerlink" title="关闭swap"></a> 关闭swap</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo swapoff -a&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo sed -i &#x27;/ swap / s/^/#/&#x27; /etc/fstab&quot;</span></span><br></pre></td></tr></table></figure><h1 id="配置cgroup驱动"><span class="post-title-index">9.</span><a href="#配置cgroup驱动" class="headerlink" title="配置cgroup驱动"></a> 配置cgroup驱动</h1><p>1、创建docker配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p etc/docker/</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | tee etc/docker/daemon.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;exec-opts&quot;: [</span></span><br><span class="line"><span class="string">        &quot;native.cgroupdriver=systemd&quot;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>2、拷贝配置文件到所有节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;mkdir -p etc/docker/&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo mkdir -p /etc/docker/&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;scp -o StrictHostKeyChecking=no voidking@192.168.56.101:~/etc/docker/daemon.json ~/etc/docker/&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo cp -p ~/etc/docker/daemon.json /etc/docker&quot;</span></span><br></pre></td></tr></table></figure><p>3、重启docker</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo systemctl daemon-reload&quot;</span></span><br><span class="line">ansible all -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo systemctl restart docker&quot;</span></span><br></pre></td></tr></table></figure><h1 id="安装keepalived-haproxy"><span class="post-title-index">10.</span><a href="#安装keepalived-haproxy" class="headerlink" title="安装keepalived+haproxy"></a> 安装keepalived+haproxy</h1><p>keepalived负责高可用，haproxy负责负载均衡。详情参考<a href="https://www.voidking.com/dev-keepalived-lvs-nginx/">《基于 keeplived+lvs 实现nginx的高可用和负载均衡》</a></p><p>只使用keepalived行不行？行，当一个master节点坏掉，可以自动切换到另外一个好的master节点，实现高可用。但是，会有两个master节点一直处于闲置状态。<br>只使用haproxy行不行？行，让一个master节点作为入口，流量可以负载均衡到3个master。但是，当入口master节点坏掉，集群也就坏掉了，不能避免单点问题。<br>综上，我们需要让keepalived和haproxy配合，才能实现负载均衡+高可用。keepalived提供一个VIP，后端对应master三个节点，某个时间提供服务的只有一个节点，如果提供服务的节点坏掉了，那么会自动切换到另外的节点。流量打到提供服务的master节点上的haproxy服务，haproxy把流量分发到三个master节点上的apiserver。</p><p>另外，keepalived和haproxy不一定要部署到master节点，如果有单独的机器来部署也是完全可以的。</p><p>安装keepalived+haproxy</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo yum install keepalived haproxy psmisc -y&quot;</span></span><br></pre></td></tr></table></figure><h2 id="配置haproxy"><span class="post-title-index">10.1.</span><a href="#配置haproxy" class="headerlink" title="配置haproxy"></a> 配置haproxy</h2><p>三台master节点，配置haproxy，它们的配置都相同</p><p>1、创建haproxy.cfg文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p etc/haproxy/</span><br><span class="line">vim etc/haproxy/haproxy.cfg</span><br></pre></td></tr></table></figure><p>内容为：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    log /dev/log  local0 warning</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">   </span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">   </span><br><span class="line">defaults</span><br><span class="line">    log global</span><br><span class="line">    option  httplog</span><br><span class="line">    option  dontlognull</span><br><span class="line">    timeout connect 5000</span><br><span class="line">    timeout client 50000</span><br><span class="line">    timeout server 50000</span><br><span class="line">   </span><br><span class="line">frontend kube-apiserver</span><br><span class="line">    bind *:9443 # 监听9443端口</span><br><span class="line">    mode tcp</span><br><span class="line">    option tcplog</span><br><span class="line">    default_backend kube-apiserver</span><br><span class="line">   </span><br><span class="line">backend kube-apiserver</span><br><span class="line">    mode tcp</span><br><span class="line">    option tcplog</span><br><span class="line">    option tcp-check</span><br><span class="line">    balance roundrobin</span><br><span class="line">    default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100</span><br><span class="line">    server kube-apiserver-1 192.168.56.101:6443 check # Replace the IP address with your own.</span><br><span class="line">    server kube-apiserver-2 192.168.56.102:6443 check # Replace the IP address with your own.</span><br><span class="line">    server kube-apiserver-3 192.168.56.103:6443 check # Replace the IP address with your own.</span><br></pre></td></tr></table></figure><p>2、备份&amp;替换haproxy.cfg</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;mkdir -p etc/haproxy/&quot;</span></span><br><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;scp -o StrictHostKeyChecking=no voidking@192.168.56.101:~/etc/haproxy/haproxy.cfg ~/etc/haproxy/&quot;</span></span><br><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo mv /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak&quot;</span></span><br><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo cp etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg&quot;</span></span><br></pre></td></tr></table></figure><p>3、重启haproxy</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo systemctl restart haproxy&quot;</span></span><br><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo systemctl enable haproxy&quot;</span></span><br><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo systemctl status haproxy&quot;</span></span><br></pre></td></tr></table></figure><h2 id="找一个VIP"><span class="post-title-index">10.2.</span><a href="#找一个VIP" class="headerlink" title="找一个VIP"></a> 找一个VIP</h2><p>在配置keepalived之前，需要找一个没有被占用的IP作为VIP，给keepalived使用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmap -sP 192.168.56.0/24</span><br><span class="line"><span class="built_in">cat</span> /proc/net/arp | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | <span class="built_in">sort</span></span><br></pre></td></tr></table></figure><p>通过上面的命令可以筛选出没有被占用的IP，选择其中一个作为VIP，这里选择<code>192.169.56.200</code></p><h2 id="配置keepalived"><span class="post-title-index">10.3.</span><a href="#配置keepalived" class="headerlink" title="配置keepalived"></a> 配置keepalived</h2><p>三台master节点，都配置keepalived，它们的配置有所不同</p><p>1、创建keepalived.conf文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p etc/keepalived/</span><br><span class="line">vim etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure><p>101机器，keepalived.conf文件内容应该为：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">  notification_email &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  router_id LVS_DEVEL</span><br><span class="line">  vrrp_skip_check_adv_addr</span><br><span class="line">  vrrp_garp_interval 0</span><br><span class="line">  vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">  script &quot;killall -0 haproxy&quot;</span><br><span class="line">  interval 2</span><br><span class="line">  weight 2</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">vrrp_instance haproxy-vip &#123;</span><br><span class="line">  state BACKUP</span><br><span class="line">  priority 100</span><br><span class="line">  interface eth0                       # Network card</span><br><span class="line">  virtual_router_id 60</span><br><span class="line">  advert_int 1</span><br><span class="line">  authentication &#123;</span><br><span class="line">    auth_type PASS</span><br><span class="line">    auth_pass 1111</span><br><span class="line">  &#125;</span><br><span class="line">  unicast_src_ip 192.169.56.101     # The IP address of this machine</span><br><span class="line">  unicast_peer &#123;</span><br><span class="line">    192.169.56.102                         # The IP address of peer machines</span><br><span class="line">    192.169.56.103</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  virtual_ipaddress &#123;</span><br><span class="line">    192.169.56.200/24                  # The VIP address</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  track_script &#123;</span><br><span class="line">    chk_haproxy</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>考虑到通用性，需要创建一个通用的配置文件，keepalived.conf内容为：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">  notification_email &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  router_id LVS_DEVEL</span><br><span class="line">  vrrp_skip_check_adv_addr</span><br><span class="line">  vrrp_garp_interval 0</span><br><span class="line">  vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">  script &quot;killall -0 haproxy&quot;</span><br><span class="line">  interval 2</span><br><span class="line">  weight 2</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">vrrp_instance haproxy-vip &#123;</span><br><span class="line">  state BACKUP</span><br><span class="line">  priority 100</span><br><span class="line">  interface eth0                      # Network card</span><br><span class="line">  virtual_router_id 60</span><br><span class="line">  advert_int 1</span><br><span class="line">  authentication &#123;</span><br><span class="line">    auth_type PASS</span><br><span class="line">    auth_pass 1111</span><br><span class="line">  &#125;</span><br><span class="line">  unicast_src_ip &lt;unicast_src_ip&gt;     # The IP address of this machine</span><br><span class="line">  unicast_peer &#123;</span><br><span class="line">    192.169.56.101                    # The IP address of peer machines</span><br><span class="line">    192.169.56.102</span><br><span class="line">    192.169.56.103</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  virtual_ipaddress &#123;</span><br><span class="line">    192.169.56.200/24                 # The VIP address</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  track_script &#123;</span><br><span class="line">    chk_haproxy</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、创建替换配置的脚本keepalived.sh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim etc/keepalived/keepalived.sh</span><br></pre></td></tr></table></figure><p>keepalived.sh内容为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line">ip=$(ifconfig eth0 | awk <span class="string">&#x27;NR==2&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">sed -i <span class="string">&quot;s/  <span class="variable">$&#123;ip&#125;</span>/  #<span class="variable">$&#123;ip&#125;</span>/g&quot;</span> etc/keepalived/keepalived.conf</span><br><span class="line">sed -i <span class="string">&quot;s/&lt;unicast_src_ip&gt;/<span class="variable">$&#123;ip&#125;</span>/g&quot;</span> etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure><p>3、备份&amp;替换keepalived.conf</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;mkdir -p etc/keepalived/&quot;</span></span><br><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;scp -o StrictHostKeyChecking=no voidking@192.168.56.101:~/etc/keepalived/keepalived.conf ~/etc/keepalived/&quot;</span></span><br><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;scp -o StrictHostKeyChecking=no voidking@192.168.56.101:~/etc/keepalived/keepalived.sh ~/etc/keepalived/&quot;</span></span><br><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;bash etc/keepalived/keepalived.sh&quot;</span></span><br><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo mv /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak&quot;</span></span><br><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo cp etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf&quot;</span></span><br></pre></td></tr></table></figure><p>5、重启keepalived</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo systemctl restart keepalived&quot;</span></span><br><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo systemctl enable keepalived&quot;</span></span><br><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo systemctl status keepalived&quot;</span></span><br><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo ip a&quot;</span></span><br></pre></td></tr></table></figure><p>配置成功后，<code>ip a</code>查看节点IP时，会发现其中一个节点的eth0网卡有两个IP，其中eth0:0的IP是VIP <code>192.169.56.200</code></p><h1 id="k8s集群部署"><span class="post-title-index">11.</span><a href="#k8s集群部署" class="headerlink" title="k8s集群部署"></a> k8s集群部署</h1><h2 id="下载镜像文件"><span class="post-title-index">11.1.</span><a href="#下载镜像文件" class="headerlink" title="下载镜像文件"></a> 下载镜像文件</h2><p>1、导出kubeadm默认配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> kubeadm config <span class="built_in">print</span> init-defaults &gt; kubeadm.conf</span><br></pre></td></tr></table></figure><p>kubeadm.conf内容为：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">bootstrapTokens:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">system:bootstrappers:kubeadm:default-node-token</span></span><br><span class="line">  <span class="attr">token:</span> <span class="string">abcdef.0123456789abcdef</span></span><br><span class="line">  <span class="attr">ttl:</span> <span class="string">24h0m0s</span></span><br><span class="line">  <span class="attr">usages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">signing</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">authentication</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line">  <span class="attr">advertiseAddress:</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br><span class="line">  <span class="attr">bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="attr">criSocket:</span> <span class="string">/var/run/dockershim.sock</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node</span></span><br><span class="line">  <span class="attr">taints:</span> <span class="literal">null</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line">  <span class="attr">timeoutForControlPlane:</span> <span class="string">4m0s</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">controllerManager:</span> &#123;&#125;</span><br><span class="line"><span class="attr">dns:</span> &#123;&#125;</span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">dataDir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">k8s.gcr.io</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="number">1.22</span><span class="number">.0</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line"><span class="attr">scheduler:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>PS：导出所有默认配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config <span class="built_in">print</span> init-defaults --component-configs KubeletConfiguration &gt; kubeadm.conf</span><br></pre></td></tr></table></figure><p>2、编辑kubeadm.conf，imageRepository改为国内镜像源，kubernetesVersion改为期望的版本</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line">kubernetesVersion: 1.22.15</span><br></pre></td></tr></table></figure><p>3、下载镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> kubeadm config images pull --config kubeadm.conf</span><br></pre></td></tr></table></figure><p>4、打包镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> docker save $(<span class="built_in">sudo</span> docker images | grep -v REPOSITORY | awk <span class="string">&#x27;BEGIN&#123;OFS=&quot;:&quot;;ORS=&quot; &quot;&#125;&#123;print $1,$2&#125;&#x27;</span>) -o all.tar</span><br></pre></td></tr></table></figure><p>5、拷贝镜像到所有master节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> voidking:voidking all.tar</span><br><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;scp -o StrictHostKeyChecking=no voidking@192.168.56.101:~/all.tar ~/&quot;</span></span><br><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo docker load -i ~/all.tar&quot;</span></span><br></pre></td></tr></table></figure><h2 id="k8s集群配置"><span class="post-title-index">11.2.</span><a href="#k8s集群配置" class="headerlink" title="k8s集群配置"></a> k8s集群配置</h2><p>选择一个master节点（master-0），作为第一个控制平面节点。<br>编辑kubeadm.conf，指定k8s集群配置，详情参考<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/high-availability/">利用 kubeadm 创建高可用集群</a></p><h3 id="controlPlaneEndpoint"><span class="post-title-index">11.2.1.</span><a href="#controlPlaneEndpoint" class="headerlink" title="controlPlaneEndpoint"></a> controlPlaneEndpoint</h3><p>添加controlPlaneEndpoint相关配置，keepalived的VIP + haproxy的端口</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">controlPlaneEndpoint:</span> <span class="string">&quot;192.168.56.200:9443&quot;</span></span><br></pre></td></tr></table></figure><h3 id="localAPIEndpoint"><span class="post-title-index">11.2.2.</span><a href="#localAPIEndpoint" class="headerlink" title="localAPIEndpoint"></a> localAPIEndpoint</h3><p>apiserver地址改为master本机的IP和端口</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line">  <span class="attr">advertiseAddress:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.101</span></span><br><span class="line">  <span class="attr">bindPort:</span> <span class="number">6443</span></span><br></pre></td></tr></table></figure><h3 id="指定节点名称"><span class="post-title-index">11.2.3.</span><a href="#指定节点名称" class="headerlink" title="指定节点名称"></a> 指定节点名称</h3><p>修改 nodeRegistration.name ，把节点名称改为执行初始化的master主机的主机名</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="attr">criSocket:</span> <span class="string">/var/run/dockershim.sock</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">master-0</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">taints:</span> <span class="literal">null</span></span><br></pre></td></tr></table></figure><h3 id="配置pod和serviceip范围"><span class="post-title-index">11.2.4.</span><a href="#配置pod和serviceip范围" class="headerlink" title="配置pod和serviceip范围"></a> 配置pod和serviceip范围</h3><p><code>ip route</code>查看当前配置使用的ip范围，避开这些范围。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="number">172.31</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">  <span class="attr">podSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br></pre></td></tr></table></figure><p>关于pod ip范围和servcie ip范围的设置，可以参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/gui951753/article/details/79412524">子网划分详解与子网划分实例精析</a>和<a target="_blank" rel="noopener" href="https://blog.csdn.net/gui951753/article/details/79210535">详解网络分类ABC</a></p><h2 id="master-0节点初始化"><span class="post-title-index">11.3.</span><a href="#master-0节点初始化" class="headerlink" title="master-0节点初始化"></a> master-0节点初始化</h2><p>1、master-0节点执行初始化</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> kubeadm init --config ~/kubeadm.conf --upload-certs</span><br></pre></td></tr></table></figure><p>看到类似如下的结果：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">You can now join any number of the control-plane node running the following command on each as root:</span><br><span class="line"></span><br><span class="line">  kubeadm join 192.168.56.200:9443 --token abcdef.0123456789abcdef \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:xxxxx \</span><br><span class="line">    --control-plane --certificate-key xxxxx</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">  kubeadm join 192.168.56.200:9443 --token abcdef.0123456789abcdef \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:xxxxx</span><br></pre></td></tr></table></figure><p>2、配置kubeconfig</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure><p>3、查看集群状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line">kubectl get pods --all-namespaces</span><br></pre></td></tr></table></figure><h2 id="其他master节点加入集群"><span class="post-title-index">11.4.</span><a href="#其他master节点加入集群" class="headerlink" title="其他master节点加入集群"></a> 其他master节点加入集群</h2><p>1、修改hosts文件，注释掉master-0节点</p><p>2、其他master节点加入集群</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible master -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo kubeadm join 192.168.56.200:9443 --token abcdef.0123456789abcdef \</span></span><br><span class="line"><span class="string">    --discovery-token-ca-cert-hash sha256:xxxxx \</span></span><br><span class="line"><span class="string">    --control-plane --certificate-key xxxxx&quot;</span></span><br></pre></td></tr></table></figure><h2 id="worker节点加入集群"><span class="post-title-index">11.5.</span><a href="#worker节点加入集群" class="headerlink" title="worker节点加入集群"></a> worker节点加入集群</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible worker -i hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo kubeadm join 192.168.56.200:9443 --token abcdef.0123456789abcdef \</span></span><br><span class="line"><span class="string">    --discovery-token-ca-cert-hash sha256:xxxxx&quot;</span></span><br></pre></td></tr></table></figure><h2 id="安装CNI插件"><span class="post-title-index">11.6.</span><a href="#安装CNI插件" class="headerlink" title="安装CNI插件"></a> 安装CNI插件</h2><p>参考<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/cluster-administration/networking/#how-to-implement-the-kubernetes-networking-model">集群网络系统</a>选择一个cni插件，这里我们选择flannel。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><h2 id="查看集群状态"><span class="post-title-index">11.7.</span><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a> 查看集群状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line">kubectl get pods --all-namespaces</span><br></pre></td></tr></table></figure></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 好好学习的郝</li><li class="post-copyright-link"> <strong>原文链接：</strong> <a href="https://www.voidking.com/dev-ansible-kubeadm/" title="ansible+kubeadm部署K8S高可用集群">https://www.voidking.com/dev-ansible-kubeadm/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本文采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议，转载请注明出处！源站会即时更新知识点并修正错误，欢迎访问~</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/centos/" rel="tag"># centos</a> <a href="/tags/docker/" rel="tag"># docker</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag"># 网络</a> <a href="/tags/k8s/" rel="tag"># k8s</a> <a href="/tags/ansible/" rel="tag"># ansible</a> <a href="/tags/keepalived/" rel="tag"># keepalived</a> <a href="/tags/haproxy/" rel="tag"># haproxy</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-kubeadm-k8s-cert-expired/" rel="prev" title="好好学K8S：kubeadm安装的K8S集群证书过期问题"><i class="fa fa-chevron-left"></i> 好好学K8S：kubeadm安装的K8S集群证书过期问题</a></div><div class="post-nav-item"> <a href="/dev-kubeadm-proxy-problem/" rel="next" title="kubeadm意外配置代理引发的问题">kubeadm意外配置代理引发的问题<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="footer-ads" style="margin-top:10px"><ins class="adsbygoogle" style="display:block" data-ad-format="autorelaxed" data-ad-client="ca-pub-3284447971731414" data-ad-slot="9697986181"></ins><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3284447971731414" crossorigin="anonymous"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div class="comments" id="gitalk-container"></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9C%80%E6%B1%82%E6%8F%8F%E8%BF%B0"><span class="nav-text">1. 需求描述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%80%9D%E8%B7%AF"><span class="nav-text">2. 安装思路</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEansible"><span class="nav-text">3. 安装配置ansible</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85docker"><span class="nav-text">4. 安装docker</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%BB%A3%E7%90%86%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="nav-text">5. 配置代理（可选）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%8A%E7%BD%91%E4%BB%A3%E7%90%86"><span class="nav-text">5.1. 配置上网代理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEdocker%E4%BB%A3%E7%90%86"><span class="nav-text">5.2. 配置docker代理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%81%E8%AE%B8iptables%E6%A3%80%E6%9F%A5%E6%A1%A5%E6%8E%A5%E6%B5%81%E9%87%8F"><span class="nav-text">6. 允许iptables检查桥接流量</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85kubeadm-kubelet-kubectl"><span class="nav-text">7. 安装kubeadm+kubelet+kubectl</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87kubernetes-repo%E9%85%8D%E7%BD%AE"><span class="nav-text">7.1. 准备kubernetes.repo配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SELinux%E8%AE%BE%E7%BD%AE%E4%B8%BApermissive%E6%A8%A1%E5%BC%8F"><span class="nav-text">7.2. SELinux设置为permissive模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85kubeadm-kubelet-kubectl-1"><span class="nav-text">7.3. 安装kubeadm+kubelet+kubectl</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%B3%E9%97%ADswap"><span class="nav-text">8. 关闭swap</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEcgroup%E9%A9%B1%E5%8A%A8"><span class="nav-text">9. 配置cgroup驱动</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85keepalived-haproxy"><span class="nav-text">10. 安装keepalived+haproxy</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEhaproxy"><span class="nav-text">10.1. 配置haproxy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%BE%E4%B8%80%E4%B8%AAVIP"><span class="nav-text">10.2. 找一个VIP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEkeepalived"><span class="nav-text">10.3. 配置keepalived</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#k8s%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="nav-text">11. k8s集群部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6"><span class="nav-text">11.1. 下载镜像文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#k8s%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE"><span class="nav-text">11.2. k8s集群配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#controlPlaneEndpoint"><span class="nav-text">11.2.1. controlPlaneEndpoint</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#localAPIEndpoint"><span class="nav-text">11.2.2. localAPIEndpoint</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E8%8A%82%E7%82%B9%E5%90%8D%E7%A7%B0"><span class="nav-text">11.2.3. 指定节点名称</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEpod%E5%92%8Cserviceip%E8%8C%83%E5%9B%B4"><span class="nav-text">11.2.4. 配置pod和serviceip范围</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#master-0%E8%8A%82%E7%82%B9%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">11.3. master-0节点初始化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96master%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4"><span class="nav-text">11.4. 其他master节点加入集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#worker%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4"><span class="nav-text">11.5. worker节点加入集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85CNI%E6%8F%92%E4%BB%B6"><span class="nav-text">11.6. 安装CNI插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="nav-text">11.7. 查看集群状态</span></a></li></ol></li></ol></div></div><div class="sidecar-ads" style="margin-top:10px"><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">一个计算机技术爱好者与学习者</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">748</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">32</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">259</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/gitalk/1.7.2/gitalk.min.css"><script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/gitalk/1.7.2/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID: '5a238b8c32b1e4dd2156',
      clientSecret: 'bfb5d518626f6fdc7da0351d1e0cd37ab75c6361',
      repo: 'gitalk-comments',
      owner: 'voidking',
      admin: ['voidking'],
      id: '271d377efb87f4a0ad59c5391d552398',
      title: 'ansible+kubeadm部署K8S高可用集群',
      body: '欢迎留言，互相交流学习~',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script></body></html>