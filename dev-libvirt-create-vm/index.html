<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.1"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1,cdn:{enable:!0,url:"//cdn.jsdelivr.net/gh/voidking/voidking.github.io/search.xml"}},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="libvirt简介参考QEMU和QEMU-KVM的关系，可以了解到，KVM实现对CPU的底层虚拟化和内存的虚拟化，使Linux内核成为虚拟化层，需要x86架构的，支持虚拟化功能的硬件支持（比如Intel VT，AMD-V），是一种全虚拟化架构。QEMU是一套由Fabrice Bellard编写的模拟处理器的自由软件，它是一个完整的可以单独运行的软件，可以独立模拟出整台计算机，包括CPU，内存，IO"><meta property="og:type" content="article"><meta property="og:title" content="使用Libvirt创建虚拟机"><meta property="og:url" content="https://www.voidking.com/dev-libvirt-create-vm/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="libvirt简介参考QEMU和QEMU-KVM的关系，可以了解到，KVM实现对CPU的底层虚拟化和内存的虚拟化，使Linux内核成为虚拟化层，需要x86架构的，支持虚拟化功能的硬件支持（比如Intel VT，AMD-V），是一种全虚拟化架构。QEMU是一套由Fabrice Bellard编写的模拟处理器的自由软件，它是一个完整的可以单独运行的软件，可以独立模拟出整台计算机，包括CPU，内存，IO"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://cdn.voidking.com//imgs/libvirt-create-vm/boot.jpg?imageView2/0/w/700"><meta property="og:image" content="http://cdn.voidking.com//imgs/libvirt-create-vm/start.jpg?imageView2/0/w/600"><meta property="og:image" content="http://cdn.voidking.com//imgs/libvirt-create-vm/ip.jpg?imageView2/0/w/600"><meta property="og:image" content="http://cdn.voidking.com//imgs/libvirt-create-vm/ping.jpg?imageView2/0/w/600"><meta property="og:image" content="http://cdn.voidking.com//imgs/libvirt-create-vm/install.jpg?imageView2/0/w/700"><meta property="og:image" content="http://cdn.voidking.com//imgs/libvirt-create-vm/list.jpg?imageView2/0/w/600"><meta property="og:image" content="http://cdn.voidking.com//imgs/libvirt-create-vm/detail.jpg?imageView2/0/w/600"><meta property="og:image" content="http://cdn.voidking.com//imgs/libvirt-create-vm/arp.jpg?imageView2/0/w/600"><meta property="og:image" content="http://cdn.voidking.com//imgs/libvirt-create-vm/login.jpg?imageView2/0/w/600"><meta property="og:image" content="http://cdn.voidking.com//imgs/libvirt-create-vm/ping2.jpg?imageView2/0/w/600"><meta property="article:published_time" content="2018-12-21T03:30:00.000Z"><meta property="article:modified_time" content="2018-12-21T03:30:00.000Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="linux"><meta property="article:tag" content="ubuntu"><meta property="article:tag" content="libvirt"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://cdn.voidking.com//imgs/libvirt-create-vm/boot.jpg?imageView2/0/w/700"><link rel="canonical" href="https://www.voidking.com/dev-libvirt-create-vm/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>使用Libvirt创建虚拟机 | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">好好学习，天天向上！</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-libvirt-create-vm/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="学而不思则罔，思而不学则殆！"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> 使用Libvirt创建虚拟机</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-12-21 11:30:00" itemprop="dateCreated datePublished" datetime="2018-12-21T11:30:00+08:00">2018-12-21</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/" itemprop="url" rel="index"><span itemprop="name">专业</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/%E8%BF%90%E7%BB%B4/ubuntu/" itemprop="url" rel="index"><span itemprop="name">ubuntu</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="libvirt简介"><a href="#libvirt简介" class="headerlink" title="libvirt简介"></a>libvirt简介</h1><p>参考<a href="https://blog.csdn.net/shengxia1999/article/details/52244119" target="_blank" rel="noopener">QEMU和QEMU-KVM的关系</a>，可以了解到，KVM实现对CPU的底层虚拟化和内存的虚拟化，使Linux内核成为虚拟化层，需要x86架构的，支持虚拟化功能的硬件支持（比如Intel VT，AMD-V），是一种全虚拟化架构。QEMU是一套由Fabrice Bellard编写的模拟处理器的自由软件，它是一个完整的可以单独运行的软件，可以独立模拟出整台计算机，包括CPU，内存，IO设备，通过一个特殊的“重编译器”对特定的处理器的二进制代码进行翻译，从而具有了跨平台的通用性。</p><p>总的来说，QEMU是一个独立的虚拟化解决方案，并不依赖KVM（它本身自己可以做CPU和内存的模拟，只不过效率较低），而KVM是另一套虚拟化解决方案，对CPU进行虚拟效率较高（采用了硬件辅助虚拟化），但本身不提供其他设备的虚拟化，借用了QEMU的代码进行了定制，所以KVM方案一定要依赖QEMU。</p><p>Libvirt是用于管理虚拟化平台的开源的API，后台程序和管理工具。它可以用于管理KVM、Xen、VMware ESX，QEMU和其他虚拟化技术。</p><p>Libvirt主要由三个部分组成：API库，一个守护进程libvirtd和一个默认命令行管理工具 virsh。</p><p>更多内容参考<a href="https://blog.csdn.net/scucscheng/article/details/51803238" target="_blank" rel="noopener">libvirt 介绍</a>。</p><a id="more"></a><h1 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h1><p>不能直接在OpenStack环境中实验，因为这样会破坏OpenStack。而且，使用kolla安装的OpenStack，没有virsh命令，libvirt是运行在容器中的。</p><p>所以，我们搭建一个新的实验环境：两个节点分别为node0和node1，ubuntu16系统，IP分别为192.168.56.200和192.168.56.201。</p><h1 id="安装libvirt"><a href="#安装libvirt" class="headerlink" title="安装libvirt"></a>安装libvirt</h1><p>参考<a href="http://www.linuxdiyf.com/linux/31719.html" target="_blank" rel="noopener">Ubuntu16.04安装QEMU与libvirt</a>，安装QEMU和libvirt。</p><p>1、切换到root用户<br><code>sudo -i</code></p><p>2、查看主机是否支持硬件虚拟化<br><code>egrep -c &#39;(vmx|svm)&#39; /proc/cpuinfo</code><br>因为我们的实验本身是在虚拟机中进行的，所以输出0，表示不支持硬件虚拟化。</p><p>3、安装QEMU和libvirt<br><code>apt install -y qemu libvirt-bin bridge-utils virt-manager virt-viewer</code></p><p>如果是支持硬件虚拟化，那么执行安装：<br><code>apt install -y kvm qemu-kvm libvirt-bin bridge-utils virt-manager virt-viewer</code></p><p>bridge-utils是网桥管理工具。<a href="https://virt-manager.org/" target="_blank" rel="noopener">virt-manager</a>是一个通用的桌面管理工具。virt-viewer是一个用于显示虚拟机的图形控制台的最小工具。</p><p>4、检查安装</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">virsh <span class="comment">--version</span></span><br><span class="line">virt-manager <span class="comment">--version</span></span><br><span class="line">virt-viewer <span class="comment">--version</span></span><br></pre></td></tr></table></figure><p>5、查看网络</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ip</span> <span class="string">a</span></span><br><span class="line"><span class="attr">brctl</span> <span class="string">show</span></span><br><span class="line"><span class="attr">virsh</span> <span class="string">net-list</span></span><br></pre></td></tr></table></figure><p>安装完成以后，默认是启用了桥接网络virbr0，IP为192.168.122.1/24。如果没有启用，那么参考<a href="https://cloud.tencent.com/info/44873f0a21c091fe2dd89ef50efd3fc9.html" target="_blank" rel="noopener">ubuntu16.04环境安装KVM</a>进行启用。</p><p>6、安装vncserver<br><code>apt-get install vnc4server</code></p><h1 id="qemu创建虚拟机"><a href="#qemu创建虚拟机" class="headerlink" title="qemu创建虚拟机"></a>qemu创建虚拟机</h1><p>参考<a href="http://www.codeleading.com/article/704772348/" target="_blank" rel="noopener">嵌套虚拟化—VMware+QEMU/KVM</a>、<a href="https://my.oschina.net/lwaif/blog/1591709" target="_blank" rel="noopener">ubuntu下使用qemu安装虚拟机并配置桥接网络</a>和<a href="https://blog.csdn.net/RichardYSteven/article/details/54645328" target="_blank" rel="noopener">使用qemu安装虚拟机</a>，进行虚拟机的创建。</p><p>1、创建磁盘</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /<span class="keyword">opt</span>/qemu</span><br><span class="line"><span class="keyword">cd</span> /<span class="keyword">opt</span>/qemu</span><br><span class="line">qemu-img create -<span class="keyword">f</span> qcow2 cirros0.img <span class="number">5</span>g</span><br></pre></td></tr></table></figure><p>qcow2是qemu最常使用的格式，该格式下可以采用来写时复制技术来优化性能；cirros0.img是磁盘名称；5g是指磁盘文件大小。</p><p>2、下载cirros系统</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="regexp">//</span>download.cirros-cloud.net<span class="regexp">/0.4.0/</span>cirros-<span class="number">0.4</span>.<span class="number">0</span>-x86_64-disk.img</span><br></pre></td></tr></table></figure><p>3、安装cirros到磁盘</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 -hda cirros0.img -boot d -cdrom ./cirros<span class="number">-0.4</span><span class="number">.0</span>-x86_64-disk.img -m <span class="number">512</span> -vnc :<span class="number">1</span></span><br></pre></td></tr></table></figure><p>如果是支持硬件虚拟化，那么执行安装：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 -enable-kvm -hda cirros0.img -boot d -cdrom ./cirros<span class="number">-0.4</span><span class="number">.0</span>-x86_64-disk.img -m <span class="number">512</span> -vnc :<span class="number">1</span></span><br></pre></td></tr></table></figure><p><code>enable-kvm</code>使用KVM进行加速；<code>hda</code>指定要使用的虚拟磁盘；<code>boot d</code>指定启动位置，d表示从光盘启动；<code>cdrom</code>指定镜像文件；<code>m</code>指定虚拟机内存大小，默认单位是MB；<code>vnc:1</code>通过vnc创建虚拟桌面。</p><p>出现警告：warning: TCG doesn’t support requested feature: CPUID.01H:ECX.vmx [bit 5]<br>没啥影响，不去管它。但是另外一个问题来了？怎么进行交互安装？</p><p>4、本地打开<a href="https://www.realvnc.com/en/connect/download/viewer/" target="_blank" rel="noopener">vncviewer client</a>，输入ip:5901进行连接，即可看到安装过程。<br><img src="http://cdn.voidking.com//imgs/libvirt-create-vm/boot.jpg?imageView2/0/w/700" alt=""><br>卡在了安装界面：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Boot failed: could <span class="keyword">not</span> read the boot disk</span><br><span class="line"><span class="literal">No</span> more<span class="built_in"> network </span>devices</span><br><span class="line"><span class="literal">No</span> bootable device</span><br></pre></td></tr></table></figure><p>参考<a href="http://accelazh.github.io/virtualization/Play-With-Libvirt-KVM" target="_blank" rel="noopener">Play with Libvirt/KVM</a>发现，cirros-0.4.0-x86_64-disk.img本身就是一个磁盘，尴尬。。。</p><p>5、启动实例</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 -m <span class="number">512</span> -smp <span class="number">4</span> \</span><br><span class="line">-drive file=cirros<span class="number">-0.4</span><span class="number">.0</span>-x86_64-disk.img \</span><br><span class="line">-vnc :<span class="number">1</span></span><br></pre></td></tr></table></figure><p>本地打开<a href="https://www.realvnc.com/en/connect/download/viewer/" target="_blank" rel="noopener">vncviewer client</a>，输入ip:5901进行连接，即可看到启动过程。因为没有<code>enable-kvm</code>，所以启动很慢，请耐心等待。<br><img src="http://cdn.voidking.com//imgs/libvirt-create-vm/start.jpg?imageView2/0/w/600" alt=""></p><p>6、查看实例IP<br>登录cirros，然后查看IP、内存和硬盘</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ip</span> <span class="string">add</span></span><br><span class="line"><span class="attr">free</span> <span class="string">-m</span></span><br><span class="line"><span class="attr">df</span> <span class="string">-h</span></span><br></pre></td></tr></table></figure><p><img src="http://cdn.voidking.com//imgs/libvirt-create-vm/ip.jpg?imageView2/0/w/600" alt=""><br>IP默认为10.0.2.15；内存512M，是指定的；硬盘默认256M。</p><p>当ctrl+c结束<code>qemu-system-x86_64</code>命令后，实例就被关闭了。再次使用<code>qemu-system-x86_64</code>命令启动实例，登录实例后使用<code>history</code>命令，发现之前的命令记录都还在，说明两次使用的都是同一块磁盘，也就是cirros-0.4.0-x86_64-disk.img。</p><p>7、设置IP<br><code>sudo vi /etc/network/interfaces</code>，eth0的配置修改为：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">auto eth0</span><br><span class="line">iface eth0 inet static</span><br><span class="line">address 192.168.122.100</span><br><span class="line">netmask 255.255.255.0</span><br></pre></td></tr></table></figure><p>然后重启网卡，<code>sudo ifdown eth0</code>，<code>sudo ifup eth0</code>。但是，无法ping通192.168.122.1，说明实例的网卡并没有和virbr0进行连接。</p><h1 id="创建网络"><a href="#创建网络" class="headerlink" title="创建网络"></a>创建网络</h1><p>实例有了，但是还不能连接外部网络。参考<a href="https://blog.csdn.net/RichardYSteven/article/details/54807927" target="_blank" rel="noopener">访问qemu虚拟机的五种姿势</a>，创建网络，重新启动实例。</p><p>1、创建网桥</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brctl add virbr0</span><br><span class="line">ifconfig virbr0 <span class="number">192.168</span><span class="number">.122</span><span class="number">.1</span> net mask <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> up</span><br></pre></td></tr></table></figure><p>网桥已经存在，所以这一步不需要了。</p><p>2、创建tap接口，并添加到网桥</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apt</span> <span class="string">install uml-utilities</span></span><br><span class="line"><span class="attr">tunctl</span> <span class="string">-t tap0</span></span><br><span class="line"><span class="attr">ifconfig</span> <span class="string">tap0 0.0.0.0 up</span></span><br><span class="line"><span class="attr">brctl</span> <span class="string">addif virbr0 tap0</span></span><br></pre></td></tr></table></figure><p>3、让实例使用tap0作为网络设备启动</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 -m 512 -smp 4 \</span><br><span class="line">-drive <span class="attribute">file</span>=cirros-0.4.0-x86_64-disk.img \</span><br><span class="line">-netdev tap,<span class="attribute">id</span>=tapnet,ifname=tap0,script=no \</span><br><span class="line">-device rtl8139,<span class="attribute">netdev</span>=tapnet \</span><br><span class="line">-vnc :1</span><br></pre></td></tr></table></figure><p>4、测试网络<br>登录实例，<code>ping 192.168.122.1</code>，此时网络已经通了。<br><img src="http://cdn.voidking.com//imgs/libvirt-create-vm/ping.jpg?imageView2/0/w/600" alt=""></p><h1 id="libvirt创建虚拟机"><a href="#libvirt创建虚拟机" class="headerlink" title="libvirt创建虚拟机"></a>libvirt创建虚拟机</h1><p>以上创建虚拟机的过程，其实并没有用到libvirt。下面参考<a href="http://accelazh.github.io/virtualization/Play-With-Libvirt-KVM" target="_blank" rel="noopener">Play with Libvirt/KVM</a>，使用libvirt进行虚拟机的创建。</p><p>1、创建虚拟机</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virt-install <span class="attribute">--connect</span>=qemu:///system <span class="attribute">--name</span>=cirros <span class="attribute">--ram</span>=512 <span class="attribute">--vcpus</span>=1 --disk <span class="attribute">path</span>=cirros-0.4.0-x86_64-disk.img,format=qcow2 --import --network network:default --vnc</span><br></pre></td></tr></table></figure><p><img src="http://cdn.voidking.com//imgs/libvirt-create-vm/install.jpg?imageView2/0/w/700" alt=""></p><p>无法使用vncviwer进行连接，然后卡在上图的界面，最后ctrl+c强制结束。配置文件位于/etc/libvirt/qemu/cirros.xml，如果要编辑它，使用<code>virsh edit cirros</code>命令。</p><p>2、显示vnc port<br><code>virsh vncdisplay cirros</code></p><p>3、显示实例列表<br><code>virsh list</code><br><img src="http://cdn.voidking.com//imgs/libvirt-create-vm/list.jpg?imageView2/0/w/600" alt=""></p><p>4、查看实例详情<br><code>virsh dominfo cirros</code><br><img src="http://cdn.voidking.com//imgs/libvirt-create-vm/detail.jpg?imageView2/0/w/600" alt=""></p><p>问题来了，怎么访问这个实例呢？最简单的方法是使用<code>virsh console cirros</code>命令打开控制台，使用<code>ctrl+]</code>关闭控制台，另外就是通过ssh或者vnc。</p><p>5、查看实例网络<br>参考<a href="https://rwmj.wordpress.com/2010/10/26/tip-find-the-ip-address-of-a-virtual-machine/" target="_blank" rel="noopener">Find the IP address of a virtual machine</a>，使用<code>arp -an</code>命令查看实例IP。<br><img src="http://cdn.voidking.com//imgs/libvirt-create-vm/arp.jpg?imageView2/0/w/600" alt=""><br>然后，挨个ping一下192.168.122.0网段的IP，即可找到实例的IP，本次找到的IP为192.168.122.49。</p><p>6、访问实例<br><code>ssh cirros@192.168.122.49</code><br><img src="http://cdn.voidking.com//imgs/libvirt-create-vm/login.jpg?imageView2/0/w/600" alt=""><br>输入默认密码gocubsgo，即可登录实例。</p><p>7、测试网络<br><code>ping 8.8.8.8 -c3</code><br><img src="http://cdn.voidking.com//imgs/libvirt-create-vm/ping2.jpg?imageView2/0/w/600" alt=""><br>至此，大功告成，创建实例成功。</p><p>8、销毁实例（可选）</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">virsh destroy cirros</span><br><span class="line">rm /etc/libvirt/qemu/cirros.xml</span><br><span class="line">virsh</span><br><span class="line"><span class="comment"># undefine cirros</span></span><br><span class="line"><span class="comment"># quit</span></span><br></pre></td></tr></table></figure><h1 id="libvirt配置网络"><a href="#libvirt配置网络" class="headerlink" title="libvirt配置网络"></a>libvirt配置网络</h1><p>以上我们知道，可以使用<code>arp -an</code>命令查看实例IP，如果查看到的IP都不能访问呢？这时就需要我们来手动配置，参考<a href="https://blog.csdn.net/wesleyflagon/article/details/50781857" target="_blank" rel="noopener">给libvirt创建的虚拟机指定固定IP</a>。</p><p>1、查看libvirt网络<br><code>virsh net-list --all</code></p><p>2、查看实例的网络<br><code>virsh domiflist cirros</code><br>查看到mac地址为<code>52:54:00:7f:0e:77</code>。</p><p>3、修改libvirt网络配置<br><code>virsh net-edit default</code>，如下修改：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">network</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>cc522162-7487-41dc-82ee-63df0df4003e<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">forward</span> <span class="attr">mode</span>=<span class="string">'nat'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">name</span>=<span class="string">'virbr0'</span> <span class="attr">stp</span>=<span class="string">'on'</span> <span class="attr">delay</span>=<span class="string">'0'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">'52:54:00:d6:65:fb'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ip</span> <span class="attr">address</span>=<span class="string">'192.168.122.1'</span> <span class="attr">netmask</span>=<span class="string">'255.255.255.0'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dhcp</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">range</span> <span class="attr">start</span>=<span class="string">'192.168.122.2'</span> <span class="attr">end</span>=<span class="string">'192.168.122.254'</span>/&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--line 10, add--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">host</span> <span class="attr">mac</span>=<span class="string">'52:54:00:7f:0e:77'</span> <span class="attr">name</span>=<span class="string">'cirros'</span> <span class="attr">ip</span>=<span class="string">'192.168.122.100'</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dhcp</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ip</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">network</span>&gt;</span></span><br></pre></td></tr></table></figure><p>以上，给cirros实例配置了静态IP为192.168.122.100。</p><p>4、重启网络</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">virsh net-destroy default</span><br><span class="line">virsh net-start default</span><br><span class="line"><span class="comment">#virsh --connect qemu:///system net-destroy default</span></span><br><span class="line"><span class="comment">#virsh --connect qemu:///system net-start default</span></span><br></pre></td></tr></table></figure><p>5、重启实例</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">virsh</span> <span class="string">shutdown cirros</span></span><br><span class="line"><span class="attr">virsh</span> <span class="string">start cirros</span></span><br></pre></td></tr></table></figure><h1 id="libvirt配置VNC"><a href="#libvirt配置VNC" class="headerlink" title="libvirt配置VNC"></a>libvirt配置VNC</h1><p>某些情况下，无法通过IP访问实例，这时就需要配置vnc，参考<a href="http://blog.51cto.com/liqingbiao/1741103" target="_blank" rel="noopener">kvm虚拟机VNC的配置</a>。</p><p>1、配置vnc<br><code>virsh edit cirros</code>，找到</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;graphics <span class="attribute">type</span>=<span class="string">'vnc'</span> <span class="attribute">port</span>=<span class="string">'-1'</span> <span class="attribute">autoport</span>=<span class="string">'yes'</span>/&gt;</span><br></pre></td></tr></table></figure><p>修改为：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;graphics <span class="keyword">type</span>=<span class="string">'vnc'</span> port=<span class="string">'5901'</span> autoport=<span class="string">'no'</span> <span class="keyword">listen</span>=<span class="string">'0.0.0.0'</span>&gt;       </span><br><span class="line">  &lt;<span class="keyword">listen</span> <span class="keyword">type</span>=<span class="string">'address'</span> address=<span class="string">'0.0.0.0'</span>/&gt;        </span><br><span class="line">&lt;/graphics&gt;</span><br></pre></td></tr></table></figure><p>2、重启实例</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">virsh</span> <span class="string">shutdown cirros</span></span><br><span class="line"><span class="attr">virsh</span> <span class="string">start cirros</span></span><br></pre></td></tr></table></figure><p>3、vnc访问<br>本地打开<a href="https://www.realvnc.com/en/connect/download/viewer/" target="_blank" rel="noopener">vncviewer client</a>，输入ip:5901进行连接。登录实例后，也可以设置静态IP，这样就不用通过<code>virsh net-edit default</code>修改了。</p><h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>其实，虚拟机中安装的虚拟机，也可以支持KVM了，参考<a href="https://blog.csdn.net/u012124304/article/details/80955753" target="_blank" rel="noopener">KVM嵌套虚拟化 – 在虚拟机中创建虚拟机</a>和<a href="https://www.server-world.info/en/note?os=Ubuntu_16.04&p=kvm&f=8" target="_blank" rel="noopener">Nested KVM</a>，开启嵌套虚拟化即可。</p><p>1、查看宿主机是否开启嵌套虚拟化<br><code>cat /sys/module/kvm_intel/parameters/nested</code><br>N代表没有开启。</p><p>2、开启嵌套虚拟化<br><code>echo &#39;options kvm_intel nested=1&#39; &gt;&gt; /etc/modprobe.d/qemu-system-x86.conf</code><br>然后重启系统。</p><h1 id="书签"><a href="#书签" class="headerlink" title="书签"></a>书签</h1><p><a href="https://www.cnblogs.com/davidshen/p/8145965.html" target="_blank" rel="noopener">linux初学者-网络桥接篇</a></p><p><a href="https://wiki.qemu.org/Documentation/Networking" target="_blank" rel="noopener">Documentation/Networking</a></p></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 好好学习的郝</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.voidking.com/dev-libvirt-create-vm/" title="使用Libvirt创建虚拟机">https://www.voidking.com/dev-libvirt-create-vm/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！源站会及时更新知识点及修正错误，阅读体验也更好。欢迎分享，欢迎收藏~</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/linux/" rel="tag"># linux</a> <a href="/tags/ubuntu/" rel="tag"># ubuntu</a> <a href="/tags/libvirt/" rel="tag"># libvirt</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-vim-advance/" rel="prev" title="Vim进阶"><i class="fa fa-chevron-left"></i> Vim进阶</a></div><div class="post-nav-item"> <a href="/dev-libvirt-vm-network/" rel="next" title="Libvirt虚拟机网络配置">Libvirt虚拟机网络配置<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zODU3Mi8xNTEwMA=="></div></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#libvirt简介"><span class="nav-number">1.</span> <span class="nav-text">libvirt简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实验环境"><span class="nav-number">2.</span> <span class="nav-text">实验环境</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装libvirt"><span class="nav-number">3.</span> <span class="nav-text">安装libvirt</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#qemu创建虚拟机"><span class="nav-number">4.</span> <span class="nav-text">qemu创建虚拟机</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#创建网络"><span class="nav-number">5.</span> <span class="nav-text">创建网络</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#libvirt创建虚拟机"><span class="nav-number">6.</span> <span class="nav-text">libvirt创建虚拟机</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#libvirt配置网络"><span class="nav-number">7.</span> <span class="nav-text">libvirt配置网络</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#libvirt配置VNC"><span class="nav-number">8.</span> <span class="nav-text">libvirt配置VNC</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#后记"><span class="nav-number">9.</span> <span class="nav-text">后记</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#书签"><span class="nav-number">10.</span> <span class="nav-text">书签</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">学而不思则罔，思而不学则殆！</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">630</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">50</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">199</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://www.beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={iconStyle:"box",boxForm:"horizontal",position:"bottomCenter",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={iconStyle:"box",boxForm:"horizontal",position:"topRight",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-float",flOptions)</script><script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  // window.livereOptions = {
  //   refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  // };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script></body></html>