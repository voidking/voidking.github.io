<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.1"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1,cdn:{enable:!0,url:"//cdn.jsdelivr.net/gh/voidking/voidking.github.io/search.xml"}},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="前言《虚拟机在线迁移实验》一文中，模拟了CPU压力、内存压力、磁盘压力还有各种网络故障，得到了这些条件下虚拟机在线迁移的性能数据。《ApacheBenchmark和gnuplot》一文中，找到了测试Web应用性能的方法，学习了gnuplot的基本用法。 本文，就利用gnuplot给迁移过程中得到的性能数据进行绘图，绘图结果用于写论文。"><meta property="og:type" content="article"><meta property="og:title" content="虚拟机在线迁移实验结果绘图"><meta property="og:url" content="https://www.voidking.com/dev-vm-live-migration-gnuplot/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="前言《虚拟机在线迁移实验》一文中，模拟了CPU压力、内存压力、磁盘压力还有各种网络故障，得到了这些条件下虚拟机在线迁移的性能数据。《ApacheBenchmark和gnuplot》一文中，找到了测试Web应用性能的方法，学习了gnuplot的基本用法。 本文，就利用gnuplot给迁移过程中得到的性能数据进行绘图，绘图结果用于写论文。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://cdn.voidking.com/@/imgs/vm-live-migration-gnuplot/cpu.png?imageView2/0/w/600"><meta property="og:image" content="http://cdn.voidking.com/@/imgs/vm-live-migration-gnuplot/cpu1.png?imageView2/0/w/600"><meta property="og:image" content="http://cdn.voidking.com/@/imgs/vm-live-migration-gnuplot/cpu2.png?imageView2/0/w/600"><meta property="og:image" content="http://cdn.voidking.com/@/imgs/vm-live-migration-gnuplot/cpu3.png?imageView2/0/w/600"><meta property="article:published_time" content="2019-01-18T01:30:00.000Z"><meta property="article:modified_time" content="2019-01-18T01:30:00.000Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="linux"><meta property="article:tag" content="ubuntu"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://cdn.voidking.com/@/imgs/vm-live-migration-gnuplot/cpu.png?imageView2/0/w/600"><link rel="canonical" href="https://www.voidking.com/dev-vm-live-migration-gnuplot/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>虚拟机在线迁移实验结果绘图 | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">好好学习，天天向上！</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-vm-live-migration-gnuplot/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="学而不思则罔，思而不学则殆！"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> 虚拟机在线迁移实验结果绘图</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-01-18 09:30:00" itemprop="dateCreated datePublished" datetime="2019-01-18T09:30:00+08:00">2019-01-18</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/" itemprop="url" rel="index"><span itemprop="name">engineering</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/devops/" itemprop="url" rel="index"><span itemprop="name">devops</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><a href="https://www.voidking.com/dev-openstack-vm-live-migration-experiment/">《虚拟机在线迁移实验》</a>一文中，模拟了CPU压力、内存压力、磁盘压力还有各种网络故障，得到了这些条件下虚拟机在线迁移的性能数据。<br><a href="https://www.voidking.com/dev-ab-and-gnuplot/">《ApacheBenchmark和gnuplot》</a>一文中，找到了测试Web应用性能的方法，学习了gnuplot的基本用法。</p><p>本文，就利用gnuplot给迁移过程中得到的性能数据进行绘图，绘图结果用于写论文。</p><a id="more"></a><h1 id="数据处理"><a href="#数据处理" class="headerlink" title="数据处理"></a>数据处理</h1><p>gnuplot的数据是纯文本的，不带单位的，按列分布的。那么首先就要处理下数据，使之符合gnuplot的要求，以CPU数据为例，处理后的数据如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#CPU占用率  迁移时间    停机时间    迁出数据量   迁入数据量</span></span><br><span class="line"><span class="number">0</span><span class="string">%</span>  <span class="number">18</span>  <span class="number">6.28</span>    <span class="number">283</span> <span class="number">248</span></span><br><span class="line"><span class="number">10</span><span class="string">%</span> <span class="number">20</span>  <span class="number">6.53</span>    <span class="number">353</span> <span class="number">341</span></span><br><span class="line"><span class="number">20</span><span class="string">%</span> <span class="number">19</span>  <span class="number">4.52</span>    <span class="number">323</span> <span class="number">300</span></span><br><span class="line"><span class="number">30</span><span class="string">%</span> <span class="number">20</span>  <span class="number">4.58</span>    <span class="number">354</span> <span class="number">338</span></span><br><span class="line"><span class="number">40</span><span class="string">%</span> <span class="number">21</span>  <span class="number">4.62</span>    <span class="number">336</span> <span class="number">347</span></span><br><span class="line"><span class="number">50</span><span class="string">%</span> <span class="number">20</span>  <span class="number">5.41</span>    <span class="number">355</span> <span class="number">323</span></span><br><span class="line"><span class="number">60</span><span class="string">%</span> <span class="number">19</span>  <span class="number">4.54</span>    <span class="number">303</span> <span class="number">309</span></span><br><span class="line"><span class="number">70</span><span class="string">%</span> <span class="number">21</span>  <span class="number">5.24</span>    <span class="number">356</span> <span class="number">355</span></span><br><span class="line"><span class="number">80</span><span class="string">%</span> <span class="number">19</span>  <span class="number">4.41</span>    <span class="number">351</span> <span class="number">338</span></span><br><span class="line"><span class="number">90</span><span class="string">%</span> <span class="number">17</span>  <span class="number">7.31</span>    <span class="number">328</span> <span class="number">362</span></span><br><span class="line"><span class="number">99</span><span class="string">%</span> <span class="number">19</span>  <span class="number">5.77</span>    <span class="number">351</span> <span class="number">348</span></span><br></pre></td></tr></table></figure><h1 id="绘图"><a href="#绘图" class="headerlink" title="绘图"></a>绘图</h1><h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><p>绘图，最基本的，要知道绘图的目的，想要显示出哪些信息？然后考虑绘制什么图？柱状图还是折线图？x轴是什么？y轴是什么？要不要第二坐标轴？<br>另外，就要考虑在一张图里面放入哪些信息，不能太少，显得空旷；不能太多，显得杂乱。<br>对于迁移过程中的四个指标，我们来分析一下。对于迁移时间和停机时间，可以放到一张图（图1）里面，这里的迁移时间和停机时间都是秒级，所以可以使用同一个坐标轴。对于迁移数据量，也可以放进图1，建立第二坐标轴即可。而对于应用程序性能，这个就麻烦了，等会再讨论。</p><h2 id="CPU与迁移性能"><a href="#CPU与迁移性能" class="headerlink" title="CPU与迁移性能"></a>CPU与迁移性能</h2><p>1、按照以上设计，新建cpu.plt，内容如下：</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># graph title</span><br><span class="line"><span class="keyword">set</span> title <span class="comment">"CPU usage, downtime and migration time"</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">key below box 1</span></span><br><span class="line"></span><br><span class="line"># x-axis</span><br><span class="line"><span class="keyword">set</span> <span class="comment">xlabel</span> <span class="comment">"CPU usage"</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">format x</span> <span class="comment">"%g%%"</span></span><br><span class="line"></span><br><span class="line"># y-axis</span><br><span class="line"><span class="keyword">set</span> <span class="comment">ylabel</span> <span class="comment">"seconds"</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">yrange[0:25]</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">ytics 5 nomirror</span></span><br><span class="line"></span><br><span class="line"># y2-axis</span><br><span class="line"><span class="keyword">set</span> <span class="comment">y2label</span> <span class="comment">"MB"</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">y2range[0:500]</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">y2tics 100</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">grid</span></span><br><span class="line"></span><br><span class="line">plot <span class="comment">"cpu.dat"</span><span class="comment"> using 1:2 with linespoints title</span> <span class="comment">"migration time"</span><span class="comment">,\</span></span><br><span class="line">    <span class="string">"cpu.dat"</span> using <span class="comment">1:3 with linespoints title</span> <span class="comment">"downtime"</span><span class="comment">,\</span></span><br><span class="line">    <span class="string">"cpu.dat"</span> using <span class="comment">1:4 axis x1y2 with linespoints title</span> <span class="comment">"transfered data"</span></span><br><span class="line"></span><br><span class="line">#pause <span class="comment">5</span></span><br><span class="line">pause <span class="comment">mouse</span></span><br></pre></td></tr></table></figure><p>2、<code>gnuplot cpu.plt</code>，执行脚本绘制图片<br><img src="http://cdn.voidking.com/@/imgs/vm-live-migration-gnuplot/cpu.png?imageView2/0/w/600" alt=""><br>看上去，挺不错的。但是，实际上的downtime应该是毫秒级，不能和migration time共用y轴，否则看不出downtime的变化。所以，最好把迁移数据量拿出来单独绘图，downtime和migration time绘制在同一个图中，使用不同的坐标系。</p><p>3、新建cpu1.plt，绘制迁移时间和停机时间</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># graph title</span></span><br><span class="line"><span class="builtin-name">set</span> title <span class="string">"CPU usage, downtime and migration time"</span></span><br><span class="line"><span class="builtin-name">set</span> key below box 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># x-axis</span></span><br><span class="line"><span class="builtin-name">set</span> xlabel <span class="string">"CPU usage (%)"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># y-axis</span></span><br><span class="line"><span class="builtin-name">set</span> ylabel <span class="string">"Time (s)"</span></span><br><span class="line"><span class="builtin-name">set</span> yrange[0:25]</span><br><span class="line"><span class="builtin-name">set</span> ytics 5 nomirror</span><br><span class="line"></span><br><span class="line"><span class="comment"># y2-axis</span></span><br><span class="line"><span class="builtin-name">set</span> y2label <span class="string">"Time (ms)"</span></span><br><span class="line"><span class="builtin-name">set</span> y2range[0:10]</span><br><span class="line"><span class="builtin-name">set</span> y2tics 2</span><br><span class="line"><span class="builtin-name">set</span> grid</span><br><span class="line"></span><br><span class="line">plot <span class="string">"cpu.dat"</span> using 1:2 with linespoints title <span class="string">"migration time (s)"</span>,\</span><br><span class="line">    <span class="string">"cpu.dat"</span> using 1:3 axis x1y2 with linespoints title <span class="string">"downtime (ms)"</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">#pause 5</span></span><br><span class="line">pause mouse</span><br></pre></td></tr></table></figure><p><img src="http://cdn.voidking.com/@/imgs/vm-live-migration-gnuplot/cpu1.png?imageView2/0/w/600" alt=""></p><p>4、新建cpu2.plt，绘制迁移数据量</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># graph title</span><br><span class="line"><span class="keyword">set</span> title <span class="comment">"CPU usage and transfered data"</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">key below box 1</span></span><br><span class="line"></span><br><span class="line"># x-axis</span><br><span class="line"><span class="keyword">set</span> <span class="comment">xlabel</span> <span class="comment">"CPU usage (%)"</span></span><br><span class="line"></span><br><span class="line"># y-axis</span><br><span class="line"><span class="keyword">set</span> <span class="comment">ylabel</span> <span class="comment">"Transfered Data (MB)"</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">yrange[0:500]</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">ytics 50</span></span><br><span class="line"></span><br><span class="line">plot <span class="comment">"cpu.dat"</span><span class="comment"> using 1:4 with linespoints title</span> <span class="comment">"Source Machine"</span><span class="comment">,\</span></span><br><span class="line">    <span class="string">"cpu.dat"</span> using <span class="comment">1:5 with linespoints title</span> <span class="comment">"Target Machine"</span></span><br><span class="line"></span><br><span class="line">#pause <span class="comment">5</span></span><br><span class="line">pause <span class="comment">mouse</span></span><br></pre></td></tr></table></figure><p><img src="http://cdn.voidking.com/@/imgs/vm-live-migration-gnuplot/cpu2.png?imageView2/0/w/600" alt=""></p><h2 id="CPU与吞吐量"><a href="#CPU与吞吐量" class="headerlink" title="CPU与吞吐量"></a>CPU与吞吐量</h2><p>1、性能测试</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ab -g cpu0.dat -t <span class="number">120</span> -n <span class="number">10000000</span> http:<span class="comment">//10.0.2.154/</span></span><br><span class="line">ab -g cpu80.dat -t <span class="number">120</span> -n <span class="number">10000000</span> http:<span class="comment">//10.0.2.154/</span></span><br></pre></td></tr></table></figure><p>生成cpu0.dat和cpu80.dat两个文件。</p><p>2、处理ab数据，计算吞吐量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">for</span> var <span class="keyword">in</span> &#123;0,80&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    start_time=`awk <span class="string">'&#123;print $6&#125;'</span> cpu<span class="variable">$&#123;var&#125;</span>.dat | grep -v <span class="string">'wait'</span> | sort | uniq -c|head -1|awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">    awk <span class="string">'&#123;print $6&#125;'</span> cpu<span class="variable">$&#123;var&#125;</span>.dat | grep -v <span class="string">'wait'</span> | sort | uniq -c|awk -v t=<span class="variable">$&#123;start_time&#125;</span> <span class="string">'&#123;print $2-t,$1&#125;'</span> &gt; cpu<span class="variable">$&#123;var&#125;</span>-t.dat</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>生成cpu0-t.dat和cpu80-t.dat两个文件。</p><p>3、填充空缺数据为0</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> var <span class="keyword">in</span> &#123;0,80&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="attribute">array_str</span>=`cat cpu<span class="variable">$&#123;var&#125;</span>-t.dat | awk <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line">    <span class="attribute">array_str2</span>=`cat cpu<span class="variable">$&#123;var&#125;</span>-t.dat | awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">    <span class="attribute">IPS</span>=<span class="string">' '</span></span><br><span class="line">    array=(<span class="variable">$array_str</span>)</span><br><span class="line">    array2=(<span class="variable">$array_str2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="attribute">index</span>=0</span><br><span class="line">    <span class="attribute">count</span>=0</span><br><span class="line">    <span class="attribute">max</span>=121</span><br><span class="line">    echo <span class="string">"#cpu<span class="variable">$&#123;var&#125;</span>"</span> &gt; cpu<span class="variable">$&#123;var&#125;</span>-tf.dat</span><br><span class="line">    <span class="keyword">while</span> ( [ <span class="variable">$index</span> -lt <span class="variable">$max</span> ] &amp;&amp; [ <span class="variable">$count</span> -lt <span class="variable">$max</span> ] )</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> [[ <span class="variable">$&#123;array[index]&#125;</span> == <span class="variable">$count</span> ]]</span><br><span class="line">        then</span><br><span class="line">            echo <span class="string">"<span class="variable">$count</span> <span class="variable">$&#123;array2[index]&#125;</span>"</span> &gt;&gt; cpu<span class="variable">$&#123;var&#125;</span>-tf.dat</span><br><span class="line">            <span class="attribute">index</span>=`expr <span class="variable">$index</span> + 1`</span><br><span class="line">            <span class="attribute">count</span>=`expr <span class="variable">$count</span> + 1`</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            echo <span class="string">"<span class="variable">$count</span> 0"</span>  &gt;&gt; cpu<span class="variable">$&#123;var&#125;</span>-tf.dat</span><br><span class="line">            <span class="attribute">count</span>=`expr <span class="variable">$count</span> + 1`</span><br><span class="line">        fi</span><br><span class="line">    done</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>4、新建cpu3.plt，绘制吞吐量</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># output as png image</span><br><span class="line">#<span class="keyword">set</span> terminal <span class="comment">png  size 1000,560</span></span><br><span class="line">#<span class="keyword">set</span> <span class="comment">output</span> <span class="comment">"cpu3.png"</span></span><br><span class="line"># graph <span class="comment">title</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">title</span> <span class="comment">"CPU usage and throughput"</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">key below box 1</span></span><br><span class="line"></span><br><span class="line"># x-axis <span class="comment">label</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">xlabel</span> <span class="comment">"Time (s)"</span></span><br><span class="line"># y-axis <span class="comment">label</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">ylabel</span> <span class="comment">"Responses per second"</span></span><br><span class="line"></span><br><span class="line">plot <span class="comment">"cpu0_tf.dat"</span><span class="comment"> using 1:2 with linespoints title</span> <span class="comment">"CPU usage 0%"</span><span class="comment">,\</span></span><br><span class="line">    <span class="string">"cpu80_tf.dat"</span> using <span class="comment">1:2 with linespoints title</span> <span class="comment">"CPU usage 80%"</span></span><br><span class="line"></span><br><span class="line">pause <span class="comment">mouse</span></span><br></pre></td></tr></table></figure><p><img src="http://cdn.voidking.com/@/imgs/vm-live-migration-gnuplot/cpu3.png?imageView2/0/w/600" alt=""></p><h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>内存压力、磁盘压力、网络故障等条件下的实验结果绘图，和CPU压力类似，详情参考<a href="https://github.com/voidking/live-migration-plot" target="_blank" rel="noopener">live-migration-plot</a>。</p><p>对于吞吐量的绘图，还有很多需要完善。比如说取样，绘制所有CPU占用率下的吞吐量会太乱，取样少了又没有对比，所以2-4条是比较合适的。再比如说时间间隔问题，输入ab测试命令后，输入迁移命令，这中间存在时间间隔。而且通过观察吞吐量曲线，也无法看出从何时开始进行迁移，只能看出停机时间。</p></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 好好学习的郝</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.voidking.com/dev-vm-live-migration-gnuplot/" title="虚拟机在线迁移实验结果绘图">https://www.voidking.com/dev-vm-live-migration-gnuplot/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！源站会及时更新知识点及修正错误，阅读体验也更好。欢迎分享，欢迎收藏~</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/linux/" rel="tag"># linux</a> <a href="/tags/ubuntu/" rel="tag"># ubuntu</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-ab-and-gnuplot/" rel="prev" title="ApacheBenchmark和gnuplot"><i class="fa fa-chevron-left"></i> ApacheBenchmark和gnuplot</a></div><div class="post-nav-item"> <a href="/dev-openstack-vm-live-migration-experiment-v2-0/" rel="next" title="虚拟机在线迁移实验V2——上">虚拟机在线迁移实验V2——上<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zODU3Mi8xNTEwMA=="></div></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#数据处理"><span class="nav-number">2.</span> <span class="nav-text">数据处理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#绘图"><span class="nav-number">3.</span> <span class="nav-text">绘图</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#设计"><span class="nav-number">3.1.</span> <span class="nav-text">设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CPU与迁移性能"><span class="nav-number">3.2.</span> <span class="nav-text">CPU与迁移性能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CPU与吞吐量"><span class="nav-number">3.3.</span> <span class="nav-text">CPU与吞吐量</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#后记"><span class="nav-number">4.</span> <span class="nav-text">后记</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">学而不思则罔，思而不学则殆！</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">674</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">30</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">224</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={iconStyle:"box",boxForm:"horizontal",position:"bottomCenter",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={iconStyle:"box",boxForm:"horizontal",position:"topRight",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-float",flOptions)</script><script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  // window.livereOptions = {
  //   refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  // };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script></body></html>