<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1,cdn:{enable:!0,url:"//qiniu-cdn.voidking.com/doc/search.xml"}},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="问题简述怎样在K8S集群中发布一个新的项目？怎样判断一个项目是发布成功了还是失败了？怎样访问一个项目？怎样实现灰度发布？怎样实现发布过程中的并发度控制、暂停、继续、取消？怎样实现回滚？ 本文中，会努力寻求这些问题的答案。 参考文档：  Pod 的生命周期 管理资源 Service 10 Most Common Reasons Kubernetes Deployments Fail (Part 1)"><meta property="og:type" content="article"><meta property="og:title" content="好好学K8S：使用client-go在K8S集群发布项目"><meta property="og:url" content="https://www.voidking.com/dev-k8s-client-go-deploy/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="问题简述怎样在K8S集群中发布一个新的项目？怎样判断一个项目是发布成功了还是失败了？怎样访问一个项目？怎样实现灰度发布？怎样实现发布过程中的并发度控制、暂停、继续、取消？怎样实现回滚？ 本文中，会努力寻求这些问题的答案。 参考文档：  Pod 的生命周期 管理资源 Service 10 Most Common Reasons Kubernetes Deployments Fail (Part 1)"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://cdn.voidking.com/img/k8s-client-go-deploy/port.jpg?imageView2/0/w/600"><meta property="article:published_time" content="2019-09-23T20:00:00.000Z"><meta property="article:modified_time" content="2019-09-23T20:00:00.000Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="golang"><meta property="article:tag" content="docker"><meta property="article:tag" content="k8s"><meta property="article:tag" content="好好学K8S"><meta property="article:tag" content="client-go"><meta property="article:tag" content="kubectl"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://cdn.voidking.com/img/k8s-client-go-deploy/port.jpg?imageView2/0/w/600"><link rel="canonical" href="https://www.voidking.com/dev-k8s-client-go-deploy/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>好好学K8S：使用client-go在K8S集群发布项目 | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">一个计算机技术爱好者与学习者</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-k8s-client-go-deploy/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="一个计算机技术爱好者与学习者"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> 好好学K8S：使用client-go在K8S集群发布项目</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-09-23 20:00:00" itemprop="dateCreated datePublished" datetime="2019-09-23T20:00:00+00:00">2019-09-23</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/" itemprop="url" rel="index"><span itemprop="name">engineering</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/golang/" itemprop="url" rel="index"><span itemprop="name">golang</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/cloudnative/" itemprop="url" rel="index"><span itemprop="name">cloudnative</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="问题简述"><span class="post-title-index">1.</span><a href="#问题简述" class="headerlink" title="问题简述"></a> 问题简述</h1><p>怎样在K8S集群中发布一个新的项目？怎样判断一个项目是发布成功了还是失败了？怎样访问一个项目？怎样实现灰度发布？怎样实现发布过程中的并发度控制、暂停、继续、取消？怎样实现回滚？</p><p>本文中，会努力寻求这些问题的答案。</p><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/">Pod 的生命周期</a></li><li><a target="_blank" rel="noopener" href="https://k8smeetup.github.io/docs/concepts/cluster-administration/manage-deployment/">管理资源</a></li><li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/">Service</a></li><li><a target="_blank" rel="noopener" href="https://kukulinski.com/10-most-common-reasons-kubernetes-deployments-fail-part-1/">10 Most Common Reasons Kubernetes Deployments Fail (Part 1)</a></li><li><a target="_blank" rel="noopener" href="https://kukulinski.com/10-most-common-reasons-kubernetes-deployments-fail-part-2/">10 Most Common Reasons Kubernetes Deployments Fail (Part 2)</a></li></ul><span id="more"></span><h1 id="准备镜像"><span class="post-title-index">2.</span><a href="#准备镜像" class="headerlink" title="准备镜像"></a> 准备镜像</h1><p>首先准备两个镜像，分别是nginx:v1.0和nginx:v2.0。</p><p>1、启动并进入容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run --name nginx -d -p 80:80 voidking/nginx:latest</span><br><span class="line">docker <span class="built_in">exec</span> -it nginx /bin/bash</span><br></pre></td></tr></table></figure><p>有些小伙伴会有疑问，为什么不使用<code>docker run</code>启动并进入容器？<br><code>docker run -it voidking/nginx:latest /bin/bash</code></p><p>因为如果使用这种方式进入容器，修改内容后commit镜像，那么镜像无法正常启动。</p><p><code>docker ps -a --no-trunc</code><br>使用该命令可以看到，voidking/nginx:latest的默认启动命令为：<br><code>nginx -g &#39;daemon off;&#39;</code><br>而commit后的镜像，默认启动命令被修改为：<br><code>/bin/bash</code><br>看到这里就知道，因为自定义的启动命令覆盖掉了原有的启动命令，所以镜像无法正常启动。为什么会覆盖呢？因为CMD指令允许用户指定容器的默认的执行命令，此命令会在容器启动且docker run没有指定其他命令时运行。当docker run指定其他命令时，则会覆盖默认的执行命令。更多内容参考<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f0a0f6a43907">Dockerfile RUN，CMD，ENTRYPOINT命令区别</a>。</p><p>2、修改index.html</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/share/nginx/html</span><br><span class="line">sed <span class="string">&#x27;s/nginx!/nginx!v1.0/&#x27;</span> index.html</span><br><span class="line">sed -i <span class="string">&#x27;s/nginx!/nginx!v1.0/&#x27;</span> index.html</span><br><span class="line"><span class="built_in">cat</span> index.html</span><br></pre></td></tr></table></figure><p>3、commit/push镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker ps -l</span><br><span class="line">docker commit 6efcd878d0d1 voidking/nginx:v1.0</span><br><span class="line">docker login</span><br><span class="line">docker push voidking/nginx:v1.0</span><br></pre></td></tr></table></figure><h1 id="kubectl"><span class="post-title-index">3.</span><a href="#kubectl" class="headerlink" title="kubectl"></a> kubectl</h1><p>在使用go-client之前，我们先来学习一下使用kubectl怎样发布项目、获取状态、访问项目、更新项目。</p><h2 id="发布项目"><span class="post-title-index">3.1.</span><a href="#发布项目" class="headerlink" title="发布项目"></a> 发布项目</h2><p>以发布一个nginx项目为例。</p><p>1、准备deployment yaml文件nginx.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">voidking/nginx:v1.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure><p>2、发布项目</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nginx.yaml</span><br></pre></td></tr></table></figure><h2 id="获取状态"><span class="post-title-index">3.2.</span><a href="#获取状态" class="headerlink" title="获取状态"></a> 获取状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deployments nginx</span><br><span class="line">kubectl get deployments nginx -o json</span><br><span class="line">kubectl get pods -l app=nginx</span><br><span class="line">kubectl get pods -l app=nginx -o json</span><br><span class="line">kubectl describe deployments nginx</span><br><span class="line">kubectl describe pods -l app=nginx</span><br></pre></td></tr></table></figure><p>根据获取到的信息，判断发布成功还是失败。</p><h2 id="访问项目"><span class="post-title-index">3.3.</span><a href="#访问项目" class="headerlink" title="访问项目"></a> 访问项目</h2><p>1、准备service yaml文件nginx-svc.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="comment">#type: LoadBalancer</span></span><br></pre></td></tr></table></figure><p>2、查看服务IP和端口</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc nginx</span><br></pre></td></tr></table></figure><p><img src="http://cdn.voidking.com/img/k8s-client-go-deploy/port.jpg?imageView2/0/w/600"></p><p>3、访问项目</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minikube service nginx</span><br></pre></td></tr></table></figure><p>执行上面的命令后，会自动打开浏览器。<br>或者使用curl命令访问：<code>curl http://192.168.99.100:32329/</code></p><p>4、从容器内部访问项目（三种方式）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods</span><br><span class="line">kubectl <span class="built_in">exec</span> -it hello-node-6747d458b6-d757m /bin/bash</span><br><span class="line"><span class="comment"># wget -O- 10.97.151.28</span></span><br><span class="line">curl 10.97.151.28</span><br><span class="line">curl nginx.default</span><br><span class="line"><span class="built_in">env</span> | grep NGINX</span><br><span class="line">curl <span class="variable">$NGINX_SERVICE_HOST</span>:<span class="variable">$NGINX_SERVICE_PORT</span></span><br></pre></td></tr></table></figure><p>如果env命令没有显示出nginx service信息，那么可以重建pod：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod hello-node-6747d458b6-d757m -n default -o yaml | kubectl replace --force -f -</span><br></pre></td></tr></table></figure><p>PS：使用kubectl进入容器的方法</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods</span><br><span class="line">kubectl <span class="built_in">exec</span> -it pod-name /bin/bash</span><br><span class="line">kubectl <span class="built_in">exec</span> -it pod-name -c container-name /bin/bash</span><br></pre></td></tr></table></figure><h2 id="更新发布"><span class="post-title-index">3.4.</span><a href="#更新发布" class="headerlink" title="更新发布"></a> 更新发布</h2><p>1、修改nginx.yaml中的配置，升级镜像为voidking/nginx:2.0</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">voidking/nginx:v2.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure><p>2、更新发布</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nginx.yaml</span><br></pre></td></tr></table></figure><p>3、访问项目</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://192.168.99.100:32329/</span><br></pre></td></tr></table></figure><h1 id="client-go"><span class="post-title-index">4.</span><a href="#client-go" class="headerlink" title="client-go"></a> client-go</h1><p><a href="https://www.voidking.com/dev-k8s-client-go/">《使用client-go操作K8S》</a>一文中，配置好了<a target="_blank" rel="noopener" href="https://github.com/voidking/k8s-client-go">k8s-client-go</a>项目，可以使用这个项目对k8s集群进行一些基本操作。在此基础上，本节会实现一些更高阶的操作。</p><h2 id="判断发布状态"><span class="post-title-index">4.1.</span><a href="#判断发布状态" class="headerlink" title="判断发布状态"></a> 判断发布状态</h2><p>根据deployment和pod的状态，怎样判断一次发布成功还是失败？首先，要知道deployment和pod都有哪些状态。</p><p>1、通过kubectl命令获取发布数据</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deployments hello-node -o json</span><br><span class="line">kubectl get deployments nginx -o json</span><br><span class="line">kubectl get pods -l app=hello-node -o json</span><br><span class="line">kubectl get pods -l app=nginx -o json</span><br></pre></td></tr></table></figure><p>2、获取到的发布数据<br>发布成功的json数据：<a target="_blank" rel="noopener" href="https://github.com/voidking/k8s-client-go/blob/master/data/hello-node.json">hello-node.json</a><br>发布失败的json数据：<a target="_blank" rel="noopener" href="https://github.com/voidking/k8s-client-go/blob/master/data/nginx.json">nginx.json</a></p><p>3、具体可用状态有哪些</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># deployment部分</span><br><span class="line">deployment.generation</span><br><span class="line">deployment.spec.replicas</span><br><span class="line">deployment.status.observedGeneration</span><br><span class="line">deployment.status.replicas</span><br><span class="line">deployment.status.readyReplicas/unavailableReplicas</span><br><span class="line">deployment.status.updatedReplicas</span><br><span class="line">deployment.status.conditions[*].type&#123;Available,Progressing&#125; &amp;&amp; deployment.status.conditions[*].status&#123;True,False&#125;</span><br><span class="line"></span><br><span class="line"># pod部分</span><br><span class="line">pod.status.phase&#123;Pending,Running&#125;</span><br><span class="line">pod.status.conditions[*].type&#123;Initialized,Ready,ContainersReady,PodScheduled&#125; &amp;&amp; pod.status.conditions[*].status&#123;True,False&#125;</span><br><span class="line">pod.status.containerStatuses[*].state.&#123;waiting,running&#125;</span><br></pre></td></tr></table></figure><p>4、判断条件组合<br>参考<a target="_blank" rel="noopener" href="https://github.com/voidking/k8s-client-go/blob/master/common/deployment.go">k8s-client-go/common/deployment.go</a>文件的GetDeploymentStatus函数。</p><h2 id="灰度发布"><span class="post-title-index">4.2.</span><a href="#灰度发布" class="headerlink" title="灰度发布"></a> 灰度发布</h2><p>常见的发布方案包括蓝绿发布、滚动发布和灰度发布（金丝雀发布），更多内容参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/williamjie/p/9497390.html">微服务部署：蓝绿部署、滚动部署、灰度发布、金丝雀发布</a>。<br>参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/yejingtao703/article/details/100014437">Spinnaker第四节-对接k8s</a>、<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1480317">基于 Spinnaker 的 K8S 灰度发布</a>、<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/85948.html">灰度发布/蓝绿发布</a>，使用Ingress，可以很好地实现灰度发布。但是，在没有Ingress的情况下，该怎样实现灰度发布？</p><p>最简单的方案是发布一个新的deployment，把service的流量分流到新的deployment<br>，测试通过后删除老的deployment，流量就全部到了新的deployment。具体实现参考<a target="_blank" rel="noopener" href="https://github.com/voidking/k8s-client-go/blob/master/common/deploy.go">k8s-client-go/common/deploy.go</a>文件的GrayDeploy和UpdateDeploy函数。</p><p>但是，如果只允许维护一个deployment，该怎么处理？创建灰度的deployment，测试通过后删除灰度的deployment，然后正常更新原有的deployment。具体实现参考<a target="_blank" rel="noopener" href="https://github.com/voidking/k8s-client-go/blob/master/common/deploy.go">k8s-client-go/common/deploy.go</a>文件的GrayDeploy2和UpdateDeploy2函数。</p><h1 id="后记"><span class="post-title-index">5.</span><a href="#后记" class="headerlink" title="后记"></a> 后记</h1><p>并发度控制、暂停、继续、取消、回滚等等功能，未完待续。。。</p></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 好好学习的郝</li><li class="post-copyright-link"> <strong>原文链接：</strong> <a href="https://www.voidking.com/dev-k8s-client-go-deploy/" title="好好学K8S：使用client-go在K8S集群发布项目">https://www.voidking.com/dev-k8s-client-go-deploy/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本文采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议，转载请注明出处！源站会即时更新知识点并修正错误，欢迎访问~</li><li> <img width="200" height="200" src="/images/avatar.jpg"><p style="text-align:center;margin-bottom:0">微信公众号同步更新，欢迎关注~</p></li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/golang/" rel="tag"># golang</a> <a href="/tags/docker/" rel="tag"># docker</a> <a href="/tags/k8s/" rel="tag"># k8s</a> <a href="/tags/%E5%A5%BD%E5%A5%BD%E5%AD%A6K8S/" rel="tag"># 好好学K8S</a> <a href="/tags/client-go/" rel="tag"># client-go</a> <a href="/tags/kubectl/" rel="tag"># kubectl</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-golang-gpm/" rel="prev" title="好好学Golang：Golang包管理工具"><i class="fa fa-chevron-left"></i> 好好学Golang：Golang包管理工具</a></div><div class="post-nav-item"> <a href="/dev-hexo-theme-next/" rel="next" title="好好学Hexo：Hexo更换主题为Next">好好学Hexo：Hexo更换主题为Next<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="footer-ads" style="margin-top:10px"><ins class="adsbygoogle" style="display:block" data-ad-format="autorelaxed" data-ad-client="ca-pub-3284447971731414" data-ad-slot="9697986181"></ins><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3284447971731414" crossorigin="anonymous"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div class="comments" id="gitalk-container"></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E7%AE%80%E8%BF%B0"><span class="nav-text">1. 问题简述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E9%95%9C%E5%83%8F"><span class="nav-text">2. 准备镜像</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#kubectl"><span class="nav-text">3. kubectl</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E9%A1%B9%E7%9B%AE"><span class="nav-text">3.1. 发布项目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E7%8A%B6%E6%80%81"><span class="nav-text">3.2. 获取状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E9%A1%B9%E7%9B%AE"><span class="nav-text">3.3. 访问项目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E5%8F%91%E5%B8%83"><span class="nav-text">3.4. 更新发布</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#client-go"><span class="nav-text">4. client-go</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A4%E6%96%AD%E5%8F%91%E5%B8%83%E7%8A%B6%E6%80%81"><span class="nav-text">4.1. 判断发布状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83"><span class="nav-text">4.2. 灰度发布</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%90%8E%E8%AE%B0"><span class="nav-text">5. 后记</span></a></li></ol></div></div><div class="sidecar-ads" style="margin-top:10px"><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">一个计算机技术爱好者与学习者</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">748</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">32</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">259</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/gitalk/1.7.2/gitalk.min.css"><script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/gitalk/1.7.2/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID: '5a238b8c32b1e4dd2156',
      clientSecret: 'bfb5d518626f6fdc7da0351d1e0cd37ab75c6361',
      repo: 'gitalk-comments',
      owner: 'voidking',
      admin: ['voidking'],
      id: '9ef431c1131a6c532a257870d050e7a4',
      title: '好好学K8S：使用client-go在K8S集群发布项目',
      body: '欢迎留言，互相交流学习~',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script></body></html>