<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.1"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1,cdn:{enable:!0,url:"//cdn.jsdelivr.net/gh/voidking/voidking.github.io/search.xml"}},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="下载内核查看当前内核版本uname -a可以看到，当前内核版本为3.16.0。"><meta property="og:type" content="article"><meta property="og:title" content="Ubuntu Kylin编译内核和添加系统调用"><meta property="og:url" content="https://www.voidking.com/dev-ubuntu-kylin-compile-kernel-and-add-systemcall/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="下载内核查看当前内核版本uname -a可以看到，当前内核版本为3.16.0。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://cdn.voidking.com/imgs/linux/compile/kernalversion.jpg"><meta property="og:image" content="http://cdn.voidking.com/imgs/linux/compile/sys.jpg"><meta property="og:image" content="http://cdn.voidking.com/imgs/linux/compile/syscall_32.jpg"><meta property="og:image" content="http://cdn.voidking.com/imgs/linux/compile/syscalls.jpg"><meta property="og:image" content="http://cdn.voidking.com/imgs/linux/compile/makemenuconfig.jpg"><meta property="og:image" content="http://cdn.voidking.com/imgs/linux/compile/load.jpg"><meta property="og:image" content="http://cdn.voidking.com/imgs/linux/compile/save.jpg"><meta property="og:image" content="http://cdn.voidking.com/imgs/linux/compile/kernelcompile.jpg"><meta property="og:image" content="http://cdn.voidking.com/imgs/linux/compile/modulesinstallerror.jpg"><meta property="og:image" content="http://cdn.voidking.com/imgs/linux/compile/modulesbuildsuccess.jpg"><meta property="og:image" content="http://cdn.voidking.com/imgs/linux/compile/modulesinstallsuccess.jpg"><meta property="og:image" content="http://cdn.voidking.com/imgs/linux/compile/initrd-mylinux.img.jpg"><meta property="og:image" content="http://cdn.voidking.com/imgs/linux/compile/kernelinstallsuccess.jpg"><meta property="og:image" content="http://cdn.voidking.com/imgs/linux/compile/update-grub.jpg"><meta property="article:published_time" content="2015-06-29T03:01:47.000Z"><meta property="article:modified_time" content="2015-06-29T03:01:47.000Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="linux"><meta property="article:tag" content="ubuntu"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://cdn.voidking.com/imgs/linux/compile/kernalversion.jpg"><link rel="canonical" href="https://www.voidking.com/dev-ubuntu-kylin-compile-kernel-and-add-systemcall/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>Ubuntu Kylin编译内核和添加系统调用 | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">好好学习，天天向上！</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-ubuntu-kylin-compile-kernel-and-add-systemcall/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="学而不思则罔，思而不学则殆！"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> Ubuntu Kylin编译内核和添加系统调用</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2015-06-29 11:01:47" itemprop="dateCreated datePublished" datetime="2015-06-29T11:01:47+08:00">2015-06-29</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/" itemprop="url" rel="index"><span itemprop="name">engineering</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/devops/" itemprop="url" rel="index"><span itemprop="name">devops</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="下载内核"><a href="#下载内核" class="headerlink" title="下载内核"></a>下载内核</h1><h2 id="查看当前内核版本"><a href="#查看当前内核版本" class="headerlink" title="查看当前内核版本"></a>查看当前内核版本</h2><p><code>uname -a</code><br><img src="http://cdn.voidking.com/imgs/linux/compile/kernalversion.jpg" alt=""><br>可以看到，当前内核版本为3.16.0。</p><a id="more"></a><h2 id="获取当前版本内核源码"><a href="#获取当前版本内核源码" class="headerlink" title="获取当前版本内核源码"></a>获取当前版本内核源码</h2><p><code>sudo apt-get install linux-source</code><br>内核源码默认下载到/usr/src文件夹下，这里，我们就使用这套源码。</p><h2 id="官方下载地址"><a href="#官方下载地址" class="headerlink" title="官方下载地址"></a>官方下载地址</h2><p><a href="https://www.kernel.org/" target="_blank" rel="noopener">https://www.kernel.org/</a><br>这个网站，你可以找到最新的内核版本，如果要想要给内核升级，可以来这里下载。</p><h1 id="解压内核"><a href="#解压内核" class="headerlink" title="解压内核"></a>解压内核</h1><p><code>cd /usr/src/</code><br><code>tar -jvf linux-source-3.16.0.tar.bz2</code><br>解压失败：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar: You must specify one of the <span class="string">'-Acdtrux'</span>, <span class="string">'--delete'</span> or <span class="string">'--test-label'</span> <span class="keyword">options</span></span><br><span class="line"><span class="keyword">Try</span> <span class="string">'tar --help'</span> or <span class="string">'tar --usage'</span> <span class="keyword">for</span> more information.</span><br></pre></td></tr></table></figure><p>添加一个参数x：<br><code>tar -xjvf linux-source-3.16.0.tar.bz2</code><br>再次失败，各种Permission denied。</p><p><code>su</code><br><code>tar -xjvf linux-source-3.16.0.tar.bz2</code><br>虽然速度很慢（3分钟左右），但是好歹解压成功了。</p><h1 id="添加系统调用"><a href="#添加系统调用" class="headerlink" title="添加系统调用"></a>添加系统调用</h1><h2 id="修改sys-c"><a href="#修改sys-c" class="headerlink" title="修改sys.c"></a>修改sys.c</h2><p><code>cd linux-source-3.16.0/kernel/</code><br><code>gedit sys.c</code><br>添加如下代码：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *new systemcall added by voidking</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">asmlinkage <span class="keyword">int</span> <span class="title">sys_callvoidking</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	printk(<span class="string">"You are handsome,VoidKing!"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="http://cdn.voidking.com/imgs/linux/compile/sys.jpg" alt=""></p><h2 id="修改syscall-32-tbl"><a href="#修改syscall-32-tbl" class="headerlink" title="修改syscall_32.tbl"></a>修改syscall_32.tbl</h2><p><code>cd /usr/src/linux-source-3.16.0/arch/x86/syscalls</code><br><code>gedit syscall_32.tbl</code><br>在最后一行插入</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">355</span>	i386	callvoidking		sys_callvoidking</span><br></pre></td></tr></table></figure><p><img src="http://cdn.voidking.com/imgs/linux/compile/syscall_32.jpg" alt=""></p><h2 id="修改syscalls-h"><a href="#修改syscalls-h" class="headerlink" title="修改syscalls.h"></a>修改syscalls.h</h2><p><code>cd /usr/src/linux-source-3.16.0/include/linux/</code><br><code>gedit syscalls.h</code><br>在<code>#endif</code>前添加：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">asmlinkage <span class="keyword">int</span> <span class="title">sys_callvoidking</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure><p><img src="http://cdn.voidking.com/imgs/linux/compile/syscalls.jpg" alt=""></p><h1 id="编译准备"><a href="#编译准备" class="headerlink" title="编译准备"></a>编译准备</h1><h2 id="libncurses5-dev"><a href="#libncurses5-dev" class="headerlink" title="libncurses5-dev"></a>libncurses5-dev</h2><p>安装nucurses库，为了make menuconfig调用。<br><code>apt-get install libncurses5-dev</code></p><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>把原先系统的配置文件拷贝到当前源码目录。<br><code>cp /boot/config-\</code>uname -r` .config`</p><h2 id="加载配置文件"><a href="#加载配置文件" class="headerlink" title="加载配置文件"></a>加载配置文件</h2><p><code>make menuconfig</code>，打开编译配置界面，load，ok，save，exit。<br><img src="http://cdn.voidking.com/imgs/linux/compile/makemenuconfig.jpg" alt=""><br><img src="http://cdn.voidking.com/imgs/linux/compile/load.jpg" alt=""><br><img src="http://cdn.voidking.com/imgs/linux/compile/save.jpg" alt=""></p><h1 id="编译命令"><a href="#编译命令" class="headerlink" title="编译命令"></a>编译命令</h1><h2 id="编译内核"><a href="#编译内核" class="headerlink" title="编译内核"></a>编译内核</h2><p><code>make -j8</code>或者<code>make bzImage</code>，前者更快一点。<br><img src="http://cdn.voidking.com/imgs/linux/compile/kernelcompile.jpg" alt=""></p><p>有些同学要两个小时才能编译完成，郝同学使用VirtualBox，只用了20分钟，电脑配置之牛逼可见一斑！哇哈哈哈！</p><h2 id="编译模块"><a href="#编译模块" class="headerlink" title="编译模块"></a>编译模块</h2><p><code>make modules</code>，编译模块时，郝同学自己添加的系统调用出现了警告，不过不影响接下来的编译。<br>一个小时之后。。。噗！要吐血了，之前分给虚拟机8G存储空间，没想到编译过程中，空间不足了，没法继续编译。。。</p><h2 id="扩展Ubuntu空间"><a href="#扩展Ubuntu空间" class="headerlink" title="扩展Ubuntu空间"></a>扩展Ubuntu空间</h2><p>1、首先关闭虚拟机，在设置中给Ubuntu再添加一块虚拟硬盘。<br>2、打开虚拟机，<code>cd /dev</code><br>3、<code>fdisk sdb</code><br>4、命令p：查看当前新盘状态。<br>5、命令n：创建一个新的分区。<br>6、两个选项e（扩展分区）和p（主分区），选择p。<br>7、连续两次回车，使用默认的起始和结束sector。<br>8、创建了一个sdb1，大小为整块虚拟硬盘。<br>9、命令w：保存退出。<br>10、<code>mkfs -t ext4 sdb1</code>，格式化。<br>11、<code>cd /mnt</code>，<code>mkdir sdb1</code>，<code>mount /dev/sdb1 sdb1</code><br>12、<code>cd sdb1</code>，<code>cp -rv /usr/src/linux-source-3.16.0 .</code><br>13、<code>umount sdb1</code>，<code>mount /dev/sdb1 /usr/src</code></p><h2 id="重新编译模块"><a href="#重新编译模块" class="headerlink" title="重新编译模块"></a>重新编译模块</h2><p><code>cd /usr/src/linux-source-3.16.0</code>，<code>make modules</code><br>等。。。再等。。。继续等。。。四个小时之后，提示空间不足。。。我靠，你丫到底需要多大空间？8G的空间不够你编译程序用的！！！哭了。。。</p><h2 id="加速编译"><a href="#加速编译" class="headerlink" title="加速编译"></a>加速编译</h2><p>寻找加速编译内核的办法，发现，似乎<code>make -j8</code>等于<code>make bzImage</code>加<code>make modules</code>。<br>去掉编译模块这个步骤试试：<br><code>make mrproper</code>，<code>make clean</code>，<code>make -j8</code>，然后<code>make modules_install</code>。报错：</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  INSTALL arch/<span class="keyword">x</span><span class="number">86</span>/crypto/aes-<span class="keyword">x</span><span class="number">86</span>_<span class="number">64</span>.ko</span><br><span class="line">cp: cannot stat ‘arch/<span class="keyword">x</span><span class="number">86</span>/crypto/aes-<span class="keyword">x</span><span class="number">86</span>_<span class="number">64</span>.ko’: No such file <span class="keyword">or</span> directory</span><br><span class="line">Can't read <span class="keyword">private</span> key</span><br><span class="line">scripts/Makefile.modinst:<span class="number">30</span>: recipe for <span class="keyword">target</span> 'arch/<span class="keyword">x</span><span class="number">86</span>/crypto/aes-<span class="keyword">x</span><span class="number">86</span>_<span class="number">64</span>.ko' failed</span><br><span class="line">make[<span class="number">1</span>]: *** [arch/<span class="keyword">x</span><span class="number">86</span>/crypto/aes-<span class="keyword">x</span><span class="number">86</span>_<span class="number">64</span>.ko] Error <span class="number">2</span></span><br><span class="line">Makefile:<span class="number">1089</span>: recipe for <span class="keyword">target</span> '_modinst_' failed</span><br><span class="line">make: *** [_modinst_] Error <span class="number">2</span></span><br></pre></td></tr></table></figure><p><img src="http://cdn.voidking.com/imgs/linux/compile/modulesinstallerror.jpg" alt=""><br>猜测是配置文件.config文件有问题，换成/usr/src/linux-headers-3.16.0-23-generic目录下的.config文件。重新编译，安装，还是报同样错误。那就再加上编译模块这个步骤吧！</p><h2 id="第三次编译模块"><a href="#第三次编译模块" class="headerlink" title="第三次编译模块"></a>第三次编译模块</h2><p><code>make -j8 modules</code>，大概四个小时之后，终于编译完成。<br><img src="http://cdn.voidking.com/imgs/linux/compile/modulesbuildsuccess.jpg" alt=""><br>安装模块报错，和<code>make -j8</code>编译后直接安装模块报错相同。给跪了，能不能愉快地玩耍了！</p><h2 id="找到错误"><a href="#找到错误" class="headerlink" title="找到错误"></a>找到错误</h2><p>后来，仔细检查了前面的步骤。发现修改syscalls.h的时候，声明类型写错了，本该是int，却写成了long类型。修改成int，一路顺利。实践证明，<code>make -j8</code>等于<code>make bzImage</code>加<code>make modules</code>。</p><h2 id="安装模块"><a href="#安装模块" class="headerlink" title="安装模块"></a>安装模块</h2><p><code>make modules_install</code><br><img src="http://cdn.voidking.com/imgs/linux/compile/modulesinstallsuccess.jpg" alt=""></p><h2 id="建立映像文件"><a href="#建立映像文件" class="headerlink" title="建立映像文件"></a>建立映像文件</h2><p>建立要载入ramdisk的映像文件<br><code>mkinitramfs -o /boot/initrd-mylinux.img</code><br><code>cd /boot</code>，<code>ll</code><br><img src="http://cdn.voidking.com/imgs/linux/compile/initrd-mylinux.img.jpg" alt=""></p><h2 id="安装内核"><a href="#安装内核" class="headerlink" title="安装内核"></a>安装内核</h2><p><code>make install</code><br><img src="http://cdn.voidking.com/imgs/linux/compile/kernelinstallsuccess.jpg" alt=""></p><h1 id="更新grub引导"><a href="#更新grub引导" class="headerlink" title="更新grub引导"></a>更新grub引导</h1><p><code>update-grub</code><br><img src="http://cdn.voidking.com/imgs/linux/compile/update-grub.jpg" alt=""></p><h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><h2 id="选择新内核"><a href="#选择新内核" class="headerlink" title="选择新内核"></a>选择新内核</h2><p>开机时，选择新内核引导系统。</p><h2 id="voidking-c"><a href="#voidking-c" class="headerlink" title="voidking.c"></a>voidking.c</h2><p>新建文件voidking.c，内容如下：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> callvoidking 355</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	syscall(callvoidking);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="编译执行"><a href="#编译执行" class="headerlink" title="编译执行"></a>编译执行</h2><p><code>gcc -o voidking voidking.c</code><br><code>./voidking</code><br>最终什么都没有显示出来，不知道错在哪里。。。也许是sys.c中的函数没有写好，不重做了，整个流程耗时太久，领会精神就够了。</p><h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>为Linux添加新的系统调用，主要包括有4个步骤：编写系统调用服务例程；添加系统调用号；修改系统调用表；重新编译内核并测试新添加的系统调用。</p><p>虽然这次实验最终失败了，但是，我掌握了添加系统调用和编译内核的流程，培养了耐心以及分析解决问题的能力。也算是收获颇丰，吼吼！</p><h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p>Ubuntu 14.04 TLS 内核升级和添加系统调用<br><a href="http://yunpan.cn/cQtsTfkbeTPvG" target="_blank" rel="noopener">http://yunpan.cn/cQtsTfkbeTPvG</a> 访问密码 adce</p><hr><p>如何实现一个新的系统调用<br><a href="http://book.51cto.com/art/201007/213651.htm" target="_blank" rel="noopener">http://book.51cto.com/art/201007/213651.htm</a></p><hr><p>ubuntu下重新编译内核<br><a href="http://m.blog.csdn.net/blog/chen_jianjian/42168449" target="_blank" rel="noopener">http://m.blog.csdn.net/blog/chen_jianjian/42168449</a></p><hr><p>Ubuntu Linux内核编译步骤<br><a href="http://www.linuxidc.com/Linux/2012-03/57303.htm" target="_blank" rel="noopener">http://www.linuxidc.com/Linux/2012-03/57303.htm</a></p><hr><p>Add a system call to the linux kernel in Ubuntu<br><a href="http://www.franksthinktank.com/howto/addsyscall/" target="_blank" rel="noopener">http://www.franksthinktank.com/howto/addsyscall/</a></p><hr><p>Ubuntu添加系统调用<br><a href="http://gnodsy.blog.163.com/blog/static/17754713320112135352447/" target="_blank" rel="noopener">http://gnodsy.blog.163.com/blog/static/17754713320112135352447/</a></p><hr><p>Ubuntu内核的重新编译安装<br><a href="http://www.linuxidc.com/Linux/2009-12/23721.htm" target="_blank" rel="noopener">http://www.linuxidc.com/Linux/2009-12/23721.htm</a></p></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 好好学习的郝</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.voidking.com/dev-ubuntu-kylin-compile-kernel-and-add-systemcall/" title="Ubuntu Kylin编译内核和添加系统调用">https://www.voidking.com/dev-ubuntu-kylin-compile-kernel-and-add-systemcall/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！源站会及时更新知识点及修正错误，阅读体验也更好。欢迎分享，欢迎收藏~</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/linux/" rel="tag"># linux</a> <a href="/tags/ubuntu/" rel="tag"># ubuntu</a></div><div class="post-nav"><div class="post-nav-item"><a href="/essay-choice-kaoyan-or-work/" rel="prev" title="考研还是工作"><i class="fa fa-chevron-left"></i> 考研还是工作</a></div><div class="post-nav-item"> <a href="/dev-linux-review/" rel="next" title="Linux复习整理">Linux复习整理<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zODU3Mi8xNTEwMA=="></div></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#下载内核"><span class="nav-number">1.</span> <span class="nav-text">下载内核</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#查看当前内核版本"><span class="nav-number">1.1.</span> <span class="nav-text">查看当前内核版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#获取当前版本内核源码"><span class="nav-number">1.2.</span> <span class="nav-text">获取当前版本内核源码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#官方下载地址"><span class="nav-number">1.3.</span> <span class="nav-text">官方下载地址</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#解压内核"><span class="nav-number">2.</span> <span class="nav-text">解压内核</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#添加系统调用"><span class="nav-number">3.</span> <span class="nav-text">添加系统调用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#修改sys-c"><span class="nav-number">3.1.</span> <span class="nav-text">修改sys.c</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改syscall-32-tbl"><span class="nav-number">3.2.</span> <span class="nav-text">修改syscall_32.tbl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改syscalls-h"><span class="nav-number">3.3.</span> <span class="nav-text">修改syscalls.h</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#编译准备"><span class="nav-number">4.</span> <span class="nav-text">编译准备</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#libncurses5-dev"><span class="nav-number">4.1.</span> <span class="nav-text">libncurses5-dev</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置文件"><span class="nav-number">4.2.</span> <span class="nav-text">配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#加载配置文件"><span class="nav-number">4.3.</span> <span class="nav-text">加载配置文件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#编译命令"><span class="nav-number">5.</span> <span class="nav-text">编译命令</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#编译内核"><span class="nav-number">5.1.</span> <span class="nav-text">编译内核</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编译模块"><span class="nav-number">5.2.</span> <span class="nav-text">编译模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#扩展Ubuntu空间"><span class="nav-number">5.3.</span> <span class="nav-text">扩展Ubuntu空间</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#重新编译模块"><span class="nav-number">5.4.</span> <span class="nav-text">重新编译模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#加速编译"><span class="nav-number">5.5.</span> <span class="nav-text">加速编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第三次编译模块"><span class="nav-number">5.6.</span> <span class="nav-text">第三次编译模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#找到错误"><span class="nav-number">5.7.</span> <span class="nav-text">找到错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装模块"><span class="nav-number">5.8.</span> <span class="nav-text">安装模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#建立映像文件"><span class="nav-number">5.9.</span> <span class="nav-text">建立映像文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装内核"><span class="nav-number">5.10.</span> <span class="nav-text">安装内核</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#更新grub引导"><span class="nav-number">6.</span> <span class="nav-text">更新grub引导</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#测试"><span class="nav-number">7.</span> <span class="nav-text">测试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#选择新内核"><span class="nav-number">7.1.</span> <span class="nav-text">选择新内核</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#voidking-c"><span class="nav-number">7.2.</span> <span class="nav-text">voidking.c</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编译执行"><span class="nav-number">7.3.</span> <span class="nav-text">编译执行</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#小结"><span class="nav-number">8.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考文档"><span class="nav-number">9.</span> <span class="nav-text">参考文档</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">学而不思则罔，思而不学则殆！</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">656</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">30</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">205</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://www.beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={iconStyle:"box",boxForm:"horizontal",position:"bottomCenter",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={iconStyle:"box",boxForm:"horizontal",position:"topRight",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-float",flOptions)</script><script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  // window.livereOptions = {
  //   refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  // };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script></body></html>