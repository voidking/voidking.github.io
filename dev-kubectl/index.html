<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.1"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1,cdn:{enable:!0,url:"//cdn.jsdelivr.net/gh/voidking/voidking.github.io/search.xml"}},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="kubectl简介 Kubectl is a command line interface for running commands against Kubernetes clusters.   没错，kubectl是一个命令行工具，用来控制K8S集群。kubectl该怎么读？可以参考HowToPronounce-kubectl，郝同学喜欢读作kubecontrol。 kubectl命令格式为："><meta property="og:type" content="article"><meta property="og:title" content="kubectl常用命令"><meta property="og:url" content="https://www.voidking.com/dev-kubectl/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="kubectl简介 Kubectl is a command line interface for running commands against Kubernetes clusters.   没错，kubectl是一个命令行工具，用来控制K8S集群。kubectl该怎么读？可以参考HowToPronounce-kubectl，郝同学喜欢读作kubecontrol。 kubectl命令格式为："><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2019-09-15T12:00:00.000Z"><meta property="article:modified_time" content="2019-09-15T12:00:00.000Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="k8s"><meta property="article:tag" content="docker"><meta property="article:tag" content="kubectl"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.voidking.com/dev-kubectl/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>kubectl常用命令 | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">好好学习，天天向上！</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-kubectl/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="学而不思则罔，思而不学则殆！"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> kubectl常用命令</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-09-15 20:00:00" itemprop="dateCreated datePublished" datetime="2019-09-15T20:00:00+08:00">2019-09-15</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/" itemprop="url" rel="index"><span itemprop="name">专业</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/%E8%BF%90%E7%BB%B4/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="kubectl简介"><a href="#kubectl简介" class="headerlink" title="kubectl简介"></a>kubectl简介</h1><blockquote><p>Kubectl is a command line interface for running commands against Kubernetes clusters.</p></blockquote><p>没错，kubectl是一个命令行工具，用来控制K8S集群。kubectl该怎么读？可以参考<a href="http://www.howtopronounce.cc/kubectl" target="_blank" rel="noopener">HowToPronounce-kubectl</a>，郝同学喜欢读作kubecontrol。</p><p>kubectl命令格式为：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">kubectl</span> <span class="selector-attr">[command]</span> <span class="selector-attr">[TYPE]</span> <span class="selector-attr">[NAME]</span> <span class="selector-attr">[flags]</span></span><br></pre></td></tr></table></figure><p>更多内容，参考：</p><ul><li><a href="https://kubernetes.io/docs/reference/kubectl/overview/" target="_blank" rel="noopener">Overview of kubectl</a></li><li><a href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/" target="_blank" rel="noopener">kubectl Cheat Sheet</a></li><li><a href="https://kubectl.docs.kubernetes.io/" target="_blank" rel="noopener">The Kubectl Book</a></li><li><a href="http://docs.kubernetes.org.cn/683.html" target="_blank" rel="noopener">Kubernetes kubectl 命令表</a></li></ul><p><a href="https://www.voidking.com/dev-k8s-start/">《K8S入门篇》</a>一文中，已经学习了kubectl的安装方法，并且使用了一些简单命令。本文整理一下kubectl的常用命令，方便记忆和复习。</p><a id="more"></a><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="指定配置文件"><a href="#指定配置文件" class="headerlink" title="指定配置文件"></a>指定配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 指定默认配置文件</span></span><br><span class="line">export KUBECONFIG=~/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看kubectl配置</span></span><br><span class="line">kubectl config view</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定配置文件和context</span></span><br><span class="line">kubectl config --kubeconfig=/root/vk-kube-config use-context voidking@kubenertes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定单次运行配置文件</span></span><br><span class="line">kubectl get deployments --kubeconfig=/root/.kube/config</span><br><span class="line">kubectl get deployments --kubeconfig /root/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定默认namespace</span></span><br><span class="line">kubectl config set-context --current --namespace=voidking</span><br><span class="line">kubectl config set-context $(kubectl config current-context) --namespace=voidking</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 多个配置整合成一个配置</span></span><br><span class="line">KUBECONFIG=~/.kube/config:~/Downloads/new-config kubectl config view --merge --flatten &gt; ~/.kube/newconfig</span><br><span class="line">export KUBECONFIG=~/.kube/newconfig</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 同时使用多个配置</span></span><br><span class="line">export KUBECONFIG=~/.kube/config:~/Download/new-config</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看使用配置</span></span><br><span class="line">kubectl config get-contexts</span><br><span class="line">kubectl config use-context voidking@kubenertes</span><br></pre></td></tr></table></figure><h2 id="命令自动补全"><a href="#命令自动补全" class="headerlink" title="命令自动补全"></a>命令自动补全</h2><p>1、linux下配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y bash-completion</span><br><span class="line">source &lt;(kubectl completion bash)</span><br><span class="line">echo "source &lt;(kubectl completion bash)" &gt;&gt; ~/.bash_profile</span><br></pre></td></tr></table></figure><p>2、mac下配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brew install bash-completion</span><br><span class="line">source &lt;(kubectl completion zsh)</span><br><span class="line">echo "source &lt;(kubectl completion zsh)" &gt;&gt; ~/.bash_profile</span><br></pre></td></tr></table></figure><h2 id="使用别名缩写"><a href="#使用别名缩写" class="headerlink" title="使用别名缩写"></a>使用别名缩写</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> kubectl缩写为k</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">alias</span> k=kubectl</span></span><br><span class="line">alias k="/usr/local/bin/kubectl"</span><br><span class="line">complete -F __start_kubectl k</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可选<span class="built_in">alias</span></span></span><br><span class="line">alias kg="kubectl get"</span><br><span class="line">alisa kd="kubectl describe"</span><br></pre></td></tr></table></figure><p>建议把配置写入 .bash_profile ，登录后别名自动生效。</p><h2 id="查看集群信息"><a href="#查看集群信息" class="headerlink" title="查看集群信息"></a>查看集群信息</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看集群信息</span></span><br><span class="line">kubectl cluster-info</span><br><span class="line">kubectl cluster-info dump</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看集群状态</span></span><br><span class="line">kubectl get cs</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看node资源使用</span></span><br><span class="line">kubectl top node</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看集群事件</span></span><br><span class="line">kubectl get ev</span><br></pre></td></tr></table></figure><h1 id="查看帮助"><a href="#查看帮助" class="headerlink" title="查看帮助"></a>查看帮助</h1><h2 id="查看资源缩写"><a href="#查看资源缩写" class="headerlink" title="查看资源缩写"></a>查看资源缩写</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe</span><br><span class="line">kubectl api-resources</span><br></pre></td></tr></table></figure><p>建议记住常用资源的SHORTNAMES，可以提升输入效率。<br>此外，记住常用资源的APIGROUP，可以提高编写yaml文件时的效率。</p><h2 id="查看可用api版本"><a href="#查看可用api版本" class="headerlink" title="查看可用api版本"></a>查看可用api版本</h2><p><code>kubectl api-versions</code></p><h2 id="yaml帮助"><a href="#yaml帮助" class="headerlink" title="yaml帮助"></a>yaml帮助</h2><p>yaml文件分成四部分，apiVersion、kind、metadata和spec。<br>apiVersion和kind是关联的，参考<code>kubectl api-resources</code>。<br>metadata必填name、namespace、labels。<br>pod.spec主要填containers的name和image；deployment.spec主要填replicas、template和selector；service.spec主要填selector、ports和type。</p><p>编写yaml文件的过程中，如果忘记了某些结构和字段，可以使用kubectl explain命令来获取帮助。</p><p>1、查看资源包含哪些字段<br>以查看deployment的yaml包含哪些字段为例：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="keyword">explain</span> deployment</span><br><span class="line">kubectl <span class="keyword">explain</span> deployment <span class="comment">--api-version=apps/v1</span></span><br></pre></td></tr></table></figure><p>2、查看子字段<br>以查看节点亲和性字段为例：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">kubectl</span> <span class="selector-tag">explain</span> <span class="selector-tag">deployment</span><span class="selector-class">.spec</span><span class="selector-class">.template</span><span class="selector-class">.spec</span><span class="selector-class">.affinity</span></span><br><span class="line"><span class="selector-tag">kubectl</span> <span class="selector-tag">explain</span> <span class="selector-tag">deployment</span><span class="selector-class">.spec</span><span class="selector-class">.template</span><span class="selector-class">.spec</span><span class="selector-class">.affinity</span><span class="selector-class">.nodeAffinity</span></span><br><span class="line">...</span><br><span class="line"><span class="selector-tag">kubectl</span> <span class="selector-tag">explain</span> <span class="selector-tag">deployment</span><span class="selector-class">.spec</span><span class="selector-class">.template</span><span class="selector-class">.spec</span><span class="selector-class">.affinity</span><span class="selector-class">.nodeAffinity</span><span class="selector-class">.requiredDuringSchedulingIgnoredDuringExecution</span><span class="selector-class">.nodeSelectorTerms</span><span class="selector-class">.matchExpressions</span></span><br></pre></td></tr></table></figure><h1 id="资源相关"><a href="#资源相关" class="headerlink" title="资源相关"></a>资源相关</h1><h2 id="查看资源"><a href="#查看资源" class="headerlink" title="查看资源"></a>查看资源</h2><p>1、查看集群的所有资源</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all</span><br><span class="line">kubectl get all -o wide</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据label筛选所有资源</span></span><br><span class="line">kubectl get all -l 'env=dev'</span><br></pre></td></tr></table></figure><p>2、查看deployment</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看deployment</span></span><br><span class="line">kubectl get deploy</span><br><span class="line">kubectl get deploy -n voidking -o wide</span><br><span class="line">kubectl get deploy -l 'env=dev'</span><br><span class="line">kubectl get deploy --selector='env=dev'</span><br><span class="line">kubectl get deploy --all-namespaces</span><br><span class="line">kubectl get deploy --show-labels</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看deployment实时变化</span></span><br><span class="line">kubectl get deploy --watch</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看指定deployment</span></span><br><span class="line">kubectl get deploy/deployment-name</span><br><span class="line">kubectl get deploy deployment-name</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定namespace</span></span><br><span class="line">kubectl get deploy -n voidking</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据label选择deployment</span></span><br><span class="line">kubectl get deploy --selector="name=nginx,type=frontend"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看deployment详细信息</span></span><br><span class="line">kubectl describe deploy</span><br></pre></td></tr></table></figure><p>pod、service、node的查看方法和deployment相同。</p><h2 id="创建资源"><a href="#创建资源" class="headerlink" title="创建资源"></a>创建资源</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f deploy.yaml</span><br><span class="line">kubectl apply -f deploy.yaml</span><br></pre></td></tr></table></figure><h2 id="更新资源"><a href="#更新资源" class="headerlink" title="更新资源"></a>更新资源</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 编辑集群中的资源</span></span><br><span class="line">kubectl edit deployment deployment-name</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 比较manifest与集群中当前资源的不同</span></span><br><span class="line">kubectl diff -f deploy.yaml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 应用最新定义</span></span><br><span class="line">kubectl replace -f deploy.yaml</span><br><span class="line">kubectl apply -f deploy.yaml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加label</span></span><br><span class="line">kubectl label deployment deployment-name new-label=awesome</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加annotation</span></span><br><span class="line">kubectl annotate deployment deployment-name icon-url=http://goo.gl/XXBTWq </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 部分修改deployment</span></span><br><span class="line">kubectl patch deployment deployment-name --type json -p='[&#123;"op": "remove", "path": "/spec/template/spec/containers/0/livenessProbe"&#125;]'</span><br></pre></td></tr></table></figure><h2 id="删除资源"><a href="#删除资源" class="headerlink" title="删除资源"></a>删除资源</h2><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="keyword">delete</span> deployment deployment-<span class="type">name</span></span><br></pre></td></tr></table></figure><h2 id="扩缩容"><a href="#扩缩容" class="headerlink" title="扩缩容"></a>扩缩容</h2><p>方法一：通过扩缩容命令。</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">scale</span> --replicas=<span class="number">2</span> deployment deployment-<span class="keyword">name</span></span><br></pre></td></tr></table></figure><p>方法二：通过更新yaml文件。</p><h2 id="暴露服务"><a href="#暴露服务" class="headerlink" title="暴露服务"></a>暴露服务</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 为deployment创建clusterip，暴露clusterip的80端口</span></span><br><span class="line">kubectl expose deployment deployment-name --port=80 --name svc-name</span><br><span class="line"><span class="meta">#</span><span class="bash"> 为deployment创建clusterip，暴露clusterip的6789端口</span></span><br><span class="line">kubectl expose deployment deployment-name --target-port=80 --port=6789</span><br><span class="line">kubectl expose -f vk-deploy.yaml --target-port=80 --port=6789</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建nodeport，暴露clusterip的80端口，暴露node的随机端口</span></span><br><span class="line">kubectl expose deployment deployment-name --port=80 --type=NodePort --name svc-name</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建clusterip，暴露clusterip的80端口</span></span><br><span class="line">kubectl create service clusterip svc-name --tcp=80:80</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建nodeport，暴露clusterip的80端口，暴露node的30080端口</span></span><br><span class="line">kubectl create service nodeport svc-name --tcp=80:80 --node-port=30080</span><br></pre></td></tr></table></figure><h2 id="版本回退"><a href="#版本回退" class="headerlink" title="版本回退"></a>版本回退</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看发布历史</span></span><br><span class="line">kubectl rollout history deployment deployment-name</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看发布状态</span></span><br><span class="line">kubectl rollout status deployment deployment-name</span><br><span class="line"><span class="meta">#</span><span class="bash"> 回退到上一个版本</span></span><br><span class="line">kubectl rollout undo deployment deployment-name</span><br></pre></td></tr></table></figure><h2 id="cm和secret"><a href="#cm和secret" class="headerlink" title="cm和secret"></a>cm和secret</h2><p>1、创建configmap</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap special-config --from-literal=special.how=very --from-literal=special.type=charm</span><br><span class="line">kubectl create configmap game-config-3 --from-file=&lt;my-key-name&gt;=&lt;path-to-file&gt;</span><br></pre></td></tr></table></figure><p>2、创建secret</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在命令中指定key和value</span></span><br><span class="line">kubectl create secret generic db-user-pass --from-literal=username=voidking --from-literal=password='vkpassword'</span><br><span class="line">kubectl get secret db-user-pass -o yaml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在文件中指定value</span></span><br><span class="line">echo -n 'voidking' &gt; ./username.txt</span><br><span class="line">echo -n 'vkpassword' &gt; ./password.txt</span><br><span class="line">kubectl create secret generic db-user-pass --from-file=./username.txt --from-file=./password.txt</span><br><span class="line">kubectl create secret generic db-user-pass --from-file=username=./username.txt --from-file=password=./password.txt</span><br><span class="line">kubectl get secret db-user-pass -o yaml</span><br></pre></td></tr></table></figure><p>在yaml文件中看到的username和password，都是经过base64加密的字符串。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 加密</span></span><br><span class="line">echo -n 'voidking' | base64</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解密</span></span><br><span class="line">echo 'dm9pZGtpbmc=' | base64 --decode</span><br></pre></td></tr></table></figure><h2 id="创建多个资源"><a href="#创建多个资源" class="headerlink" title="创建多个资源"></a>创建多个资源</h2><p>如果要创建ns，然后在ns中创建configmap，最后创建deployment（依赖configmap），该怎么操作？<br>方法一：挨个apply</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">apply</span> -f ns.yaml</span><br><span class="line">kubectl <span class="built_in">apply</span> -f cm.yaml</span><br><span class="line">kubectl <span class="built_in">apply</span> -f deploy.yaml</span><br></pre></td></tr></table></figure><p>方法二：按顺序合并，然后apply</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cat</span> ns.yaml &lt;(<span class="keyword">echo</span> <span class="string">"---"</span>) <span class="keyword">cm</span>.yaml &lt;(<span class="keyword">echo</span> <span class="string">"---"</span>) deploy.yaml &gt; ns-<span class="keyword">cm</span>-deploy.yaml</span><br><span class="line">kubecl apply -<span class="keyword">f</span> ns-<span class="keyword">cm</span>-deploy.yaml</span><br></pre></td></tr></table></figure><p>方法三：多次apply</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">apply</span> -f .</span><br><span class="line">kubectl <span class="built_in">apply</span> -f .</span><br></pre></td></tr></table></figure><p>方法四：添加编号</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">mv</span> <span class="selector-tag">ns</span><span class="selector-class">.yaml</span> 00<span class="selector-tag">-ns</span><span class="selector-class">.yaml</span></span><br><span class="line"><span class="selector-tag">mv</span> <span class="selector-tag">cm</span><span class="selector-class">.yaml</span> 01<span class="selector-tag">-cm</span><span class="selector-class">.yaml</span></span><br><span class="line"><span class="selector-tag">mv</span> <span class="selector-tag">deploy</span><span class="selector-class">.yaml</span> 02<span class="selector-tag">-deploy</span><span class="selector-class">.yaml</span></span><br><span class="line"><span class="selector-tag">kubectl</span> <span class="selector-tag">apply</span> <span class="selector-tag">-f</span> .</span><br></pre></td></tr></table></figure><h2 id="资源拼接"><a href="#资源拼接" class="headerlink" title="资源拼接"></a>资源拼接</h2><p>参考 <a href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/kustomization/" target="_blank" rel="noopener">Kustomize</a>。</p><h1 id="yaml相关"><a href="#yaml相关" class="headerlink" title="yaml相关"></a>yaml相关</h1><h2 id="导出yaml或json文件"><a href="#导出yaml或json文件" class="headerlink" title="导出yaml或json文件"></a>导出yaml或json文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 导出deployment的yaml文件</span></span><br><span class="line">kubectl get deploy -o yaml &gt; deploy.yaml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 导出deployment的json文件</span></span><br><span class="line">kubectl get deploy -o json &gt; deploy.json</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 导出指定deployment的yaml文件</span></span><br><span class="line">kubectl get deploy/deployment-name -o yaml &gt; deploy-name.yaml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 导出指定deployment的json文件</span></span><br><span class="line">kubectl get deploy/deployment-name -o json &gt; deploy-name.json</span><br></pre></td></tr></table></figure><p>pod、service、node的yaml/json文件的导出方法和deployment相同。</p><h2 id="pod-yaml"><a href="#pod-yaml" class="headerlink" title="pod yaml"></a>pod yaml</h2><p>生成pod的yaml文件模板：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl run vkpod --image=nginx --restart=Never --dry-run=client -oyaml</span><br><span class="line">kubectl run vk-pod --image=nginx --generator=run-pod/v1 -l 'name=vk-pod,env=dev' --dry-run -o yaml</span><br><span class="line">kubectl run vk-pod --image=nginx --generator=run-pod/v1 --labels='name=vk-pod,env=dev' --dry-run -o yaml</span><br><span class="line">kubectl run vk-pod --image=busybox --generator=run-pod/v1 --dry-run -o yaml --command -- sleep 1000</span><br></pre></td></tr></table></figure><p>更多内容，参考<a href="http://docs.kubernetes.org.cn/468.html" target="_blank" rel="noopener">Kubernetes kubectl run 命令详解</a>和<a href="https://kubernetes.io/zh/docs/reference/kubectl/conventions/" target="_blank" rel="noopener">kubectl 的用法约定</a>。</p><h2 id="deployment-yaml"><a href="#deployment-yaml" class="headerlink" title="deployment yaml"></a>deployment yaml</h2><p>1、生成deployment的yaml文件模板（历史方法）：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="builtin-name">run</span> vk-deploy <span class="attribute">--image</span>=nginx --dry-<span class="builtin-name">run</span> -o yaml</span><br></pre></td></tr></table></figure><p>会出现提示：<br>kubectl run –generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run –generator=run-pod/v1 or kubectl create instead.<br>因为官方不推荐使用 run-pod/v1 以外的其他生成器，其他生成器不久后就会弃用。更多内容参考<a href="https://kubernetes.io/zh/docs/reference/kubectl/conventions/#kubectl-run" target="_blank" rel="noopener">kubectl run</a>。</p><p>2、从已有K8S集群中已有资源中导出yaml模板文件（历史方法）：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="builtin-name">get</span> deploy/deployment-name -o yaml --<span class="builtin-name">export</span> &gt; deploy-name.yaml</span><br></pre></td></tr></table></figure><p>也会出现提示：<br>Flag –export has been deprecated, This flag is deprecated and will be removed in future.<br>很尴尬，–export 也要弃用了，且用且珍惜吧。</p><p>3、生成deployment的yaml文件模板（推荐方法）：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment vk-deploy <span class="attribute">--image</span>=nginx --dry-<span class="builtin-name">run</span> -o yaml</span><br></pre></td></tr></table></figure><p>更多内容，参考<a href="http://docs.kubernetes.org.cn/535.html" target="_blank" rel="noopener">Kubernetes kubectl create deployment 命令详解</a>。</p><p>注意，我们并不需要在deployment中指定容器对外暴露的ports，因为该字段只是一个提示作用。</p><blockquote><p>List of ports to expose from the container. Exposing a port here gives the system additional information about the network connections a container uses, but is primarily informational. Not specifying a port here DOES NOT prevent that port from being exposed. Any port which is listening on the default “0.0.0.0” address inside a container will be accessible from the network. Cannot be updated.</p></blockquote><h2 id="service-yaml"><a href="#service-yaml" class="headerlink" title="service yaml"></a>service yaml</h2><p>生成service的yaml文件模板（推荐方法）：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create<span class="built_in"> service </span>clusterip vk-svc <span class="attribute">--tcp</span>=<span class="string">"5678:80"</span> --dry-<span class="builtin-name">run</span> -o yaml</span><br></pre></td></tr></table></figure><p>更多内容，参考<a href="http://docs.kubernetes.org.cn/564.html" target="_blank" rel="noopener">Kubernetes kubectl create service 命令详解</a>和<a href="https://kubernetes.io/docs/concepts/services-networking/service/" target="_blank" rel="noopener">Service</a>。</p><h2 id="yaml验证"><a href="#yaml验证" class="headerlink" title="yaml验证"></a>yaml验证</h2><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">create</span> <span class="comment">--validate -f deployment.yaml</span></span><br></pre></td></tr></table></figure><h1 id="node相关"><a href="#node相关" class="headerlink" title="node相关"></a>node相关</h1><h2 id="taint和tolerations"><a href="#taint和tolerations" class="headerlink" title="taint和tolerations"></a>taint和tolerations</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 添加taint</span></span><br><span class="line">kubectl taint nodes node1 key1=value1:NoSchedule</span><br><span class="line">kubectl taint nodes node1 key2=value2:PreferNoSchedule</span><br><span class="line">kubectl taint nodes node1 key3=value3:NoExecute</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除taint</span></span><br><span class="line">kubectl taint nodes node1 value1:NoSchedule-</span><br></pre></td></tr></table></figure><p>同时，要在pod yaml的spec下添加tolerations字段：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">tolerations</span>:</span><br><span class="line">  - <span class="attribute">key</span>: <span class="string">"key1"</span></span><br><span class="line">    <span class="attribute">operator</span>: <span class="string">"Equal"</span></span><br><span class="line">    <span class="attribute">value</span>: <span class="string">"value1"</span></span><br><span class="line">    <span class="attribute">effect</span>: <span class="string">"NoSchedule"</span></span><br><span class="line">  - <span class="attribute">key</span>: <span class="string">"key2"</span></span><br><span class="line">    <span class="attribute">operator</span>: <span class="string">"Exists"</span></span><br><span class="line">    <span class="attribute">effect</span>: <span class="string">"PreferNoSchedule"</span></span><br><span class="line">  - <span class="attribute">key</span>: <span class="string">"key3"</span></span><br><span class="line">    <span class="attribute">operator</span>: <span class="string">"Equal"</span></span><br><span class="line">    <span class="attribute">value</span>: <span class="string">"value3"</span></span><br><span class="line">    <span class="attribute">effect</span>: <span class="string">"NoExecute"</span></span><br></pre></td></tr></table></figure><h2 id="label和affinity"><a href="#label和affinity" class="headerlink" title="label和affinity"></a>label和affinity</h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加label</span></span><br><span class="line">kubectl <span class="keyword">label</span><span class="bash"> nodes node1 key1=value1,key2=value2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除label</span></span><br><span class="line">kubectl <span class="keyword">label</span><span class="bash"> nodes node1 key1-</span></span><br></pre></td></tr></table></figure><p>同时，要在pod yaml中添加tolerations字段：</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">nodeSelector:</span></span><br><span class="line"><span class="symbol">  disktype:</span> ssd</span><br></pre></td></tr></table></figure><p>或者，使用：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">key1</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">value1</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">valuex</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">key2</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">value2</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">valuey</span></span><br></pre></td></tr></table></figure><h2 id="node封锁"><a href="#node封锁" class="headerlink" title="node封锁"></a>node封锁</h2><p>如果node存在问题，或者node需要升级维护，这时需要对node进行封锁，并且驱除pod。</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 封锁node，不允许分配pod</span></span><br><span class="line"><span class="attr">kubectl</span> <span class="string">cordon nodename</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从指定node驱除pod</span></span><br><span class="line"><span class="attr">kubectl</span> <span class="string">drain nodename --ignore-daemonsets</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解除node的封锁，允许分配pod</span></span><br><span class="line"><span class="attr">kubectl</span> <span class="string">uncordon nodename</span></span><br></pre></td></tr></table></figure><h1 id="容器交互"><a href="#容器交互" class="headerlink" title="容器交互"></a>容器交互</h1><h2 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h2><p>1、登录容器</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -<span class="keyword">it</span> pod-<span class="built_in">name</span> /bin/bash</span><br><span class="line">kubectl exec -<span class="keyword">it</span> pod-<span class="built_in">name</span> -c container-<span class="built_in">name</span> /bin/bash</span><br><span class="line">kubectl exec -<span class="keyword">it</span> pod-<span class="built_in">name</span> -c container-<span class="built_in">name</span> sh</span><br></pre></td></tr></table></figure><p>2、直接执行命令</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec pod-<span class="built_in">name</span> env</span><br><span class="line">kubectl exec pod-<span class="built_in">name</span> <span class="comment">-- env</span></span><br><span class="line">kubectl exec pod-<span class="built_in">name</span> -<span class="keyword">it</span> <span class="comment">-- env</span></span><br><span class="line">kubectl exec -n default pod-<span class="built_in">name</span> -<span class="keyword">it</span> <span class="comment">-- env</span></span><br><span class="line"><span class="comment"># 命令带参数时必须加双横线</span></span><br><span class="line">kubectl exec pod-<span class="built_in">name</span> <span class="comment">-- sh -c 'echo $&#123;LANG&#125;'</span></span><br></pre></td></tr></table></figure><h2 id="拷贝文件"><a href="#拷贝文件" class="headerlink" title="拷贝文件"></a>拷贝文件</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拷贝pod内容到宿主机</span></span><br><span class="line"><span class="attribute">kubectl</span> cp podname-564949c96c-m986n:/path/filename .</span><br></pre></td></tr></table></figure><h1 id="故障排查"><a href="#故障排查" class="headerlink" title="故障排查"></a>故障排查</h1><p>故障排查的第一步是先给问题分下类。这个问题是什么？Pods，Replication Controller或者Service？<br>更多内容参考<a href="https://kubernetes.io/zh/docs/tasks/debug-application-cluster/debug-application/" target="_blank" rel="noopener">应用故障排查</a>。</p><h2 id="Pods排查"><a href="#Pods排查" class="headerlink" title="Pods排查"></a>Pods排查</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看pod详细信息</span></span><br><span class="line">kubectl describe pods $&#123;POD_NAME&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看容器日志</span></span><br><span class="line">kubectl logs $&#123;POD_NAME&#125; $&#123;CONTAINER_NAME&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看crashed容器日志</span></span><br><span class="line">kubectl logs --previous $&#123;POD_NAME&#125; $&#123;CONTAINER_NAME&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看运行的容器内部日志</span></span><br><span class="line">kubectl exec $&#123;POD_NAME&#125; -c $&#123;CONTAINER_NAME&#125; -- cat /var/log/cassandra/system.log</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看运行的容器内部日志（pod只有一个容器）</span></span><br><span class="line">kubectl exec $&#123;POD_NAME&#125; -- cat /var/log/cassandra/system.log</span><br></pre></td></tr></table></figure><h2 id="RC排查"><a href="#RC排查" class="headerlink" title="RC排查"></a>RC排查</h2><p>Replication Controllers排查</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 监控rc相关事件</span></span><br><span class="line"><span class="attribute">kubectl</span> describe rc <span class="variable">$&#123;CONTROLLER_NAME&#125;</span></span><br></pre></td></tr></table></figure><h2 id="Services排查"><a href="#Services排查" class="headerlink" title="Services排查"></a>Services排查</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看endpoints资源，service选择到了哪些pod和端口</span></span><br><span class="line">kubectl <span class="builtin-name">get</span> endpoints <span class="variable">$&#123;SERVICE_NAME&#125;</span></span><br></pre></td></tr></table></figure><h1 id="小技巧"><a href="#小技巧" class="headerlink" title="小技巧"></a>小技巧</h1><h2 id="service-cidr"><a href="#service-cidr" class="headerlink" title="service cidr"></a>service cidr</h2><p>怎样查看一个k8s集群的service ip范围？</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config view | grep Subnet</span><br><span class="line">kubectl get pods -n kube-system kube-apiserver-master -oyaml | grep service-cluster-ip-range</span><br></pre></td></tr></table></figure><h2 id="pod-cidr"><a href="#pod-cidr" class="headerlink" title="pod cidr"></a>pod cidr</h2><p>怎样查看一个k8s集群的pod ip范围？</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config view | grep Subnet</span><br><span class="line">kubectl cluster-info dump | grep -i cidr</span><br></pre></td></tr></table></figure><p>如果上面两个方法都找不到，那么还可以通过网络组件的日志来查看，以weave为例。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker ps | grep weave</span><br><span class="line">docker logs &lt;weave-container-id&gt; | grep ipalloc-range</span><br></pre></td></tr></table></figure><h1 id="k8s工具箱"><a href="#k8s工具箱" class="headerlink" title="k8s工具箱"></a>k8s工具箱</h1><p><a href="https://github.com/voidking/k8s-tool" target="_blank" rel="noopener">voidking/k8s-tool</a></p></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 好好学习的郝</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.voidking.com/dev-kubectl/" title="kubectl常用命令">https://www.voidking.com/dev-kubectl/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！源站会及时更新知识点及修正错误，阅读体验也更好。欢迎分享，欢迎收藏~</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/k8s/" rel="tag"># k8s</a> <a href="/tags/docker/" rel="tag"># docker</a> <a href="/tags/kubectl/" rel="tag"># kubectl</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-k8s-start/" rel="prev" title="K8S入门篇"><i class="fa fa-chevron-left"></i> K8S入门篇</a></div><div class="post-nav-item"> <a href="/dev-k8s-client-go/" rel="next" title="使用client-go操作K8S">使用client-go操作K8S<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zODU3Mi8xNTEwMA=="></div></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#kubectl简介"><span class="nav-number">1.</span> <span class="nav-text">kubectl简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#环境准备"><span class="nav-number">2.</span> <span class="nav-text">环境准备</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#指定配置文件"><span class="nav-number">2.1.</span> <span class="nav-text">指定配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#命令自动补全"><span class="nav-number">2.2.</span> <span class="nav-text">命令自动补全</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用别名缩写"><span class="nav-number">2.3.</span> <span class="nav-text">使用别名缩写</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查看集群信息"><span class="nav-number">2.4.</span> <span class="nav-text">查看集群信息</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#查看帮助"><span class="nav-number">3.</span> <span class="nav-text">查看帮助</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#查看资源缩写"><span class="nav-number">3.1.</span> <span class="nav-text">查看资源缩写</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查看可用api版本"><span class="nav-number">3.2.</span> <span class="nav-text">查看可用api版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#yaml帮助"><span class="nav-number">3.3.</span> <span class="nav-text">yaml帮助</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#资源相关"><span class="nav-number">4.</span> <span class="nav-text">资源相关</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#查看资源"><span class="nav-number">4.1.</span> <span class="nav-text">查看资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建资源"><span class="nav-number">4.2.</span> <span class="nav-text">创建资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新资源"><span class="nav-number">4.3.</span> <span class="nav-text">更新资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#删除资源"><span class="nav-number">4.4.</span> <span class="nav-text">删除资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#扩缩容"><span class="nav-number">4.5.</span> <span class="nav-text">扩缩容</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#暴露服务"><span class="nav-number">4.6.</span> <span class="nav-text">暴露服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#版本回退"><span class="nav-number">4.7.</span> <span class="nav-text">版本回退</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cm和secret"><span class="nav-number">4.8.</span> <span class="nav-text">cm和secret</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建多个资源"><span class="nav-number">4.9.</span> <span class="nav-text">创建多个资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#资源拼接"><span class="nav-number">4.10.</span> <span class="nav-text">资源拼接</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#yaml相关"><span class="nav-number">5.</span> <span class="nav-text">yaml相关</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#导出yaml或json文件"><span class="nav-number">5.1.</span> <span class="nav-text">导出yaml或json文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pod-yaml"><span class="nav-number">5.2.</span> <span class="nav-text">pod yaml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#deployment-yaml"><span class="nav-number">5.3.</span> <span class="nav-text">deployment yaml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#service-yaml"><span class="nav-number">5.4.</span> <span class="nav-text">service yaml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#yaml验证"><span class="nav-number">5.5.</span> <span class="nav-text">yaml验证</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#node相关"><span class="nav-number">6.</span> <span class="nav-text">node相关</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#taint和tolerations"><span class="nav-number">6.1.</span> <span class="nav-text">taint和tolerations</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#label和affinity"><span class="nav-number">6.2.</span> <span class="nav-text">label和affinity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#node封锁"><span class="nav-number">6.3.</span> <span class="nav-text">node封锁</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#容器交互"><span class="nav-number">7.</span> <span class="nav-text">容器交互</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#执行命令"><span class="nav-number">7.1.</span> <span class="nav-text">执行命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#拷贝文件"><span class="nav-number">7.2.</span> <span class="nav-text">拷贝文件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#故障排查"><span class="nav-number">8.</span> <span class="nav-text">故障排查</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Pods排查"><span class="nav-number">8.1.</span> <span class="nav-text">Pods排查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RC排查"><span class="nav-number">8.2.</span> <span class="nav-text">RC排查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Services排查"><span class="nav-number">8.3.</span> <span class="nav-text">Services排查</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#小技巧"><span class="nav-number">9.</span> <span class="nav-text">小技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#service-cidr"><span class="nav-number">9.1.</span> <span class="nav-text">service cidr</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pod-cidr"><span class="nav-number">9.2.</span> <span class="nav-text">pod cidr</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#k8s工具箱"><span class="nav-number">10.</span> <span class="nav-text">k8s工具箱</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">学而不思则罔，思而不学则殆！</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">632</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">50</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">199</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://www.beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={iconStyle:"box",boxForm:"horizontal",position:"bottomCenter",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={iconStyle:"box",boxForm:"horizontal",position:"topRight",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-float",flOptions)</script><script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  // window.livereOptions = {
  //   refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  // };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script></body></html>