<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1,cdn:{enable:!0,url:"//qiniu-cdn.voidking.com/doc/search.xml"}},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="kubeadm简介《使用kubeadm升级K8S集群》一文中，了解了k8s集群中常见组件，并且使用kubeadm对k8s集群进行了升级。本文中，会学习使用kubeadm安装部署k8s集群。  Kubeadm is a tool built to provide kubeadm init and kubeadm join as best-practice “fast paths” for creat"><meta property="og:type" content="article"><meta property="og:title" content="好好学K8S：使用kubeadm安装部署K8S集群——CentOS篇"><meta property="og:url" content="https://www.voidking.com/dev-kubeadm-install-k8s-in-centos/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="kubeadm简介《使用kubeadm升级K8S集群》一文中，了解了k8s集群中常见组件，并且使用kubeadm对k8s集群进行了升级。本文中，会学习使用kubeadm安装部署k8s集群。  Kubeadm is a tool built to provide kubeadm init and kubeadm join as best-practice “fast paths” for creat"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2020-03-16T21:00:00.000Z"><meta property="article:modified_time" content="2023-06-22T08:00:00.000Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="centos"><meta property="article:tag" content="docker"><meta property="article:tag" content="k8s"><meta property="article:tag" content="网络"><meta property="article:tag" content="好好学K8S"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.voidking.com/dev-kubeadm-install-k8s-in-centos/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>好好学K8S：使用kubeadm安装部署K8S集群——CentOS篇 | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">一个计算机技术爱好者与学习者</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-kubeadm-install-k8s-in-centos/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="一个计算机技术爱好者与学习者"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> 好好学K8S：使用kubeadm安装部署K8S集群——CentOS篇</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-03-16 21:00:00" itemprop="dateCreated datePublished" datetime="2020-03-16T21:00:00+00:00">2020-03-16</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-06-22 08:00:00" itemprop="dateModified" datetime="2023-06-22T08:00:00+00:00">2023-06-22</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/" itemprop="url" rel="index"><span itemprop="name">engineering</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/devops/" itemprop="url" rel="index"><span itemprop="name">devops</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/cloudnative/" itemprop="url" rel="index"><span itemprop="name">cloudnative</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/network/" itemprop="url" rel="index"><span itemprop="name">network</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="kubeadm简介"><span class="post-title-index">1.</span><a href="#kubeadm简介" class="headerlink" title="kubeadm简介"></a> kubeadm简介</h1><p><a href="https://www.voidking.com/dev-kubeadm-upgrade/">《使用kubeadm升级K8S集群》</a>一文中，了解了k8s集群中常见组件，并且使用kubeadm对k8s集群进行了升级。本文中，会学习使用kubeadm安装部署k8s集群。</p><blockquote><p>Kubeadm is a tool built to provide kubeadm init and kubeadm join as best-practice “fast paths” for creating Kubernetes clusters.</p></blockquote><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/">Overview of kubeadm</a></li><li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">Installing kubeadm</a></li></ul><span id="more"></span><h1 id="安装流程"><span class="post-title-index">2.</span><a href="#安装流程" class="headerlink" title="安装流程"></a> 安装流程</h1><p>目标：搭建一个k8s集群，包括master和node01两个节点，节点系统为centos7.6.1810。<br>master节点ip为192.168.56.200，node01节点ip为192.168.56.201。</p><p>1、环境准备。</p><p>2、在master节点和node01节点安装kubeadm。</p><p>3、初始化master节点，创建k8s集群（记得安装网络插件）。</p><p>4、node01节点加入到k8s集群。</p><p>5、验证安装。</p><h1 id="环境准备"><span class="post-title-index">3.</span><a href="#环境准备" class="headerlink" title="环境准备"></a> 环境准备</h1><p>1、配置主机名</p><p>2、配置IP地址</p><h1 id="安装docker"><span class="post-title-index">4.</span><a href="#安装docker" class="headerlink" title="安装docker"></a> 安装docker</h1><p>参考<a href="https://www.voidking.com/dev-docker-start/">Docker入门</a>，安装Docker</p><h1 id="允许iptables检查桥接流量"><span class="post-title-index">5.</span><a href="#允许iptables检查桥接流量" class="headerlink" title="允许iptables检查桥接流量"></a> 允许iptables检查桥接流量</h1><p>允许 iptables 检查桥接流量，允许流量转发</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/modules-load.d/k8s.conf</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">sudo</span> sysctl --system</span><br></pre></td></tr></table></figure><p>所有节点都要执行。</p><h1 id="安装kubeadm-kubelet-kubectl"><span class="post-title-index">6.</span><a href="#安装kubeadm-kubelet-kubectl" class="headerlink" title="安装kubeadm+kubelet+kubectl"></a> 安装kubeadm+kubelet+kubectl</h1><p>参考<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">安装kubeadm</a>。</p><h2 id="准备kubernetes-repo配置"><span class="post-title-index">6.1.</span><a href="#准备kubernetes-repo配置" class="headerlink" title="准备kubernetes.repo配置"></a> 准备kubernetes.repo配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-$basearch</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">repo_gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">exclude=kubelet kubeadm kubectl</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>如果不能连通google，kubernetes.repo中的baseurl就替换成aliyun</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>所有节点都要执行。</p><h2 id="SELinux设置为permissive模式"><span class="post-title-index">6.2.</span><a href="#SELinux设置为permissive模式" class="headerlink" title="SELinux设置为permissive模式"></a> SELinux设置为permissive模式</h2><p>将 SELinux 设置为 permissive 模式（相当于将其禁用）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> setenforce 0</span><br><span class="line"><span class="built_in">sudo</span> sed -i <span class="string">&#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27;</span> /etc/selinux/config</span><br></pre></td></tr></table></figure><h2 id="安装kubeadm-kubelet-kubectl-1"><span class="post-title-index">6.3.</span><a href="#安装kubeadm-kubelet-kubectl-1" class="headerlink" title="安装kubeadm+kubelet+kubectl"></a> 安装kubeadm+kubelet+kubectl</h2><p>1、安装默认版本的kubeadm+kubelet+kubectl</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes</span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> --now kubelet</span><br></pre></td></tr></table></figure><p>centos安装这些组件时如果报错：[Errno -1] repomd.xml signature could not be verified for kubernetes<br>不考虑安全性的话，最简单的解决办法是修改 /etc/yum.repos.d/kubernetes.repo 文件，设置 <code>repo_gpgcheck=0</code></p><p>2、查看kubelet版本<br><code>kubelet --version</code></p><p>如果想要安装指定版本的k8s，比如1.22.15，那么需要安装指定版本的kubeadm、kubelet和kubectl。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum remove -y kubelet kubeadm kubectl</span><br><span class="line"><span class="built_in">sudo</span> yum list kubeadm kubelet kubectl --showduplicates</span><br><span class="line"><span class="built_in">sudo</span> yum install -y kubeadm-1.22.15-0 kubelet-1.22.15-0 kubectl-1.22.15-0 --disableexcludes=kubernetes</span><br></pre></td></tr></table></figure><p>下文中kubeadm.conf中的版本也需要同步修改<br><code>kubernetesVersion: 1.22.15</code></p><h1 id="关闭swap"><span class="post-title-index">7.</span><a href="#关闭swap" class="headerlink" title="关闭swap"></a> 关闭swap</h1><blockquote><p>Swap disabled. You MUST disable swap in order for the kubelet to work properly.</p></blockquote><p>如官方文档所说，kubelet正常工作的前提是关闭swap，否则kubeadm执行初始化时会报错：<br>“–cgroups-per-qos enabled, but –cgroup-root was not specified. defaulting to /“<br>“Failed to run kubelet” err=”failed to run Kubelet: running with swap on is not supported, please disable swap!<br>报错查看方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl status kubelet</span><br><span class="line">journalctl -xeu kubelet</span><br></pre></td></tr></table></figure><p>1、临时关闭swap<br><code>swapoff -a</code></p><p>2、永久关闭swap<br><code>sed -i &#39;/ swap / s/^/#/&#39; /etc/fstab</code><br>或者编辑 /etc/fstab，手动注释掉swap配置。</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#/dev/mapper/centos-<span class="built_in">swap</span> <span class="built_in">swap</span> <span class="built_in">swap</span> defaults <span class="number">0</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p>无论是master节点，还是worker节点，记得都要关闭swap。</p><h1 id="配置cgroup驱动"><span class="post-title-index">8.</span><a href="#配置cgroup驱动" class="headerlink" title="配置cgroup驱动"></a> 配置cgroup驱动</h1><blockquote><p>Both the container runtime and the kubelet have a property called “cgroup driver”, which is important for the management of cgroups on Linux machines.</p></blockquote><p>如官方文档所说，cgroup驱动对于在linux中管理cgroups中非常重要。<br>因此需要正确配置 kubelet 的 cgroup 驱动以匹配 kubeadm 集群中的容器运行时的 cgroup 驱动，详情参考 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/configure-cgroup-driver/">配置 cgroup 驱动</a></p><p>否则kubeadm执行初始化时会报错：<br>[kubelet-check] It seems like the kubelet isn’t running or healthy.<br>The kubelet is not running<br>The kubelet is unhealthy due to a misconfiguration of the node in some way (required cgroups disabled)<br>这是因为， docker 和 kubelet 服务中的cgroup不一致，docker默认使用cgroupfs，kubelet默认使用systemd<br>cgroup驱动查看方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker system info | grep -i driver</span><br><span class="line"><span class="built_in">cat</span> /var/lib/kubelet/config.yaml | grep cgroup</span><br></pre></td></tr></table></figure><p>方法一：kubelet匹配docker<br>编辑kubeadm.conf，添加kubelet的cgroup配置，指定驱动为cgroupfs</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeletConfiguration</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="comment">#cgroupDriver: systemd</span></span><br><span class="line"><span class="attr">cgroupDriver:</span> <span class="string">cgroupfs</span></span><br></pre></td></tr></table></figure><p>方法二：docker匹配kubelet<br>编辑 /etc/docker/daemon.json ，添加：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;exec-opts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;native.cgroupdriver=systemd&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>重启docker</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><p>这里选择方法二，因为官方更加推荐，可以避免后续kubeadm升级可能引发的cgroup驱动问题。</p><h1 id="初始化master节点"><span class="post-title-index">9.</span><a href="#初始化master节点" class="headerlink" title="初始化master节点"></a> 初始化master节点</h1><p>参考<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#installing-kubeadm-on-your-hosts">Installing kubeadm on your hosts</a>。</p><h2 id="下载镜像文件"><span class="post-title-index">9.1.</span><a href="#下载镜像文件" class="headerlink" title="下载镜像文件"></a> 下载镜像文件</h2><p>kubeadm默认从gcr.io下载k8s组件镜像，国内需要科学上网，或者更改为国内源。本文选择更改为国内源。</p><p>1、导出一份默认配置文件<br><code>kubeadm config print init-defaults &gt; kubeadm.conf</code></p><p>默认配置内容为：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">bootstrapTokens:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">system:bootstrappers:kubeadm:default-node-token</span></span><br><span class="line">  <span class="attr">token:</span> <span class="string">abcdef.0123456789abcdef</span></span><br><span class="line">  <span class="attr">ttl:</span> <span class="string">24h0m0s</span></span><br><span class="line">  <span class="attr">usages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">signing</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">authentication</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line">  <span class="attr">advertiseAddress:</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br><span class="line">  <span class="attr">bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="attr">criSocket:</span> <span class="string">/var/run/dockershim.sock</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node</span></span><br><span class="line">  <span class="attr">taints:</span> <span class="literal">null</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line">  <span class="attr">timeoutForControlPlane:</span> <span class="string">4m0s</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">controllerManager:</span> &#123;&#125;</span><br><span class="line"><span class="attr">dns:</span> &#123;&#125;</span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">dataDir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">k8s.gcr.io</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="number">1.23</span><span class="number">.0</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line"><span class="attr">scheduler:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>2、下载地址改为国内镜像源<br>编辑kubeadm.conf，imageRepository改为国内源</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">imageRepository:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/google_containers</span></span><br></pre></td></tr></table></figure><p>3、指定配置文件，执行下载<br><code>kubeadm config images pull --config kubeadm.conf</code></p><p>[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.23.0<br>[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.23.0<br>[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.23.0<br>[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.23.0<br>[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6<br>[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.1-0<br>[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.6</p><h2 id="k8s集群配置"><span class="post-title-index">9.2.</span><a href="#k8s集群配置" class="headerlink" title="k8s集群配置"></a> k8s集群配置</h2><p>编辑kubeadm.conf，指定k8s集群配置，详情参考<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/reference/config-api/kubeadm-config.v1beta2/">kubeadm 配置 (v1beta2)</a></p><h3 id="advertiseAddress"><span class="post-title-index">9.2.1.</span><a href="#advertiseAddress" class="headerlink" title="advertiseAddress"></a> advertiseAddress</h3><p>修改 localAPIEndpoint.advertiseAddress 字段，也就是apiserver对外开放的地址，这里改为master节点地址（因为没有配置高可用）</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line">  <span class="attr">advertiseAddress:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.200</span></span><br><span class="line">  <span class="attr">bindPort:</span> <span class="number">6443</span></span><br></pre></td></tr></table></figure><p>如果在执行初始前不指定可用的advertiseAddress，那么<code>kubeadm init</code>初始化时会报错：<br>Error getting node” err=”node “node” not found</p><h3 id="指定节点名称"><span class="post-title-index">9.2.2.</span><a href="#指定节点名称" class="headerlink" title="指定节点名称"></a> 指定节点名称</h3><p>修改 nodeRegistration.name 字段，这个字段会作为执行初始化的这个master节点的名称。建议改为master节点的主机名，否则默认就会叫node。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="attr">criSocket:</span> <span class="string">/var/run/dockershim.sock</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">taints:</span> <span class="literal">null</span></span><br></pre></td></tr></table></figure><p>如果在执行初始化前没有指定节点名字，想要修改的话，需要修改kubeadm.conf后重新部署k8s集群。</p><p>不重新部署k8s集群，是否可以直接编辑修改节点的名称？<br><code>kubectl edit nodes/node</code>，修改如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">kubernetes.io/hostname:</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure><p>很遗憾，不可以，会报错：<br>error: At least one of apiVersion, kind and name was changed</p><h3 id="指定pod-ip范围"><span class="post-title-index">9.2.3.</span><a href="#指定pod-ip范围" class="headerlink" title="指定pod ip范围"></a> 指定pod ip范围</h3><p>添加 networking.podSubnet 字段，指定pod ip范围（pod-network-cidr）</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line">  <span class="attr">podSubnet:</span> <span class="string">&quot;10.244.0.0/16&quot;</span></span><br></pre></td></tr></table></figure><p>关于pod ip范围和servcie ip范围的设置，可以参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/gui951753/article/details/79412524">子网划分详解与子网划分实例精析</a>和<a target="_blank" rel="noopener" href="https://blog.csdn.net/gui951753/article/details/79210535">详解网络分类ABC</a></p><p>如果在执行初始化前没有指定pod ip范围，也是可以正常初始化的，但是后面会导致CNI插件无法正常启动。比如kube-flannel会报错：<br>Error registering network: failed to acquire lease: node “node” pod cidr not assigned<br>后期想要修改的话，需要修改kubeadm.conf后重新部署k8s集群。</p><p>不重新部署k8s集群，能否补救？这个是可以的<br>编辑 /etc/kubernetes/manifests/kube-controller-manager.yaml ，添加参数：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--allocate-node-cidrs=true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--cluster-cidr=10.244.0.0/16</span></span><br></pre></td></tr></table></figure><p>然后重启kubelet：<br><code>systemctl restart kubelet</code></p><h2 id="执行初始化"><span class="post-title-index">9.3.</span><a href="#执行初始化" class="headerlink" title="执行初始化"></a> 执行初始化</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#rm -rf /etc/kubernetes/manifests/ </span></span><br><span class="line"><span class="comment">#kubeadm reset</span></span><br><span class="line">kubeadm init --config kubeadm.conf</span><br></pre></td></tr></table></figure><p>完成后，屏幕输出会提示创建配置文件，以及添加worker node的join命令，记录下来。<br>例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm <span class="built_in">join</span> 192.168.56.200:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:6743eaae41ba8fd99e495e3df94ff9a996878e7c9cf8ac590a3c52b97ea8012e</span><br></pre></td></tr></table></figure><p>PS：如果忘记了添加worker node的join命令，可以重新生成。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --<span class="built_in">help</span></span><br><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure><p>生成新的join命令后，之前的join命令同样可以使用。</p><h2 id="创建配置文件"><span class="post-title-index">9.4.</span><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a> 创建配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure><h2 id="验证安装"><span class="post-title-index">9.5.</span><a href="#验证安装" class="headerlink" title="验证安装"></a> 验证安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a</span><br><span class="line">kubectl get nodes</span><br><span class="line">kubectl get pods --namespace kube-system</span><br></pre></td></tr></table></figure><h2 id="验证发现问题"><span class="post-title-index">9.6.</span><a href="#验证发现问题" class="headerlink" title="验证发现问题"></a> 验证发现问题</h2><p>问题一：coredns处于pending状态<br>查看coredns报错信息：</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">get</span> deployment/coredns -n kube-<span class="built_in">system</span> -o yaml</span><br><span class="line">kubectl <span class="built_in">get</span> pods -n kube-<span class="built_in">system</span></span><br><span class="line">kubectl <span class="built_in">describe</span> pods coredns-65c54cc984-srzl4 -n kube-<span class="built_in">system</span></span><br><span class="line">kubectl logs pods coredns-65c54cc984-srzl4 -n kube-<span class="built_in">system</span></span><br></pre></td></tr></table></figure><p>Warning FailedScheduling 2m57s (x36 over 38m) default-scheduler 0/1 nodes are available: 1 node(s) had taint {node.kubernetes.io/not-ready: }, that the pod didn’t tolerate.<br>原来是coredns默认无法部署在master节点，因为没有配置容忍。参考<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/scheduling-eviction/taint-and-toleration/">污点和容忍度</a>进行配置即可。<br><code>kubectl edit deployment/coredns -n kube-system -o yaml</code><br>tolerations部分添加：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">node.kubernetes.io/not-ready</span></span><br></pre></td></tr></table></figure><p>问题二：coredns无法启动<br>问题一解决后，coredns可以调度了，但是无法启动。<br><code>kubectl describe pods/coredns-55b7b56cf8-jv2dc -n kube-system</code><br>network is not ready: container runtime network not ready: NetworkReady=false reason:NetworkPluginNotReady message:docker: network plugin is not ready: cni config uninitialized</p><p>仔细研读<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/">使用 kubeadm 创建集群</a>，原来问题一是符合预期的，master节点还没有ready，因为缺少cni插件。</p><h2 id="安装CNI插件"><span class="post-title-index">9.7.</span><a href="#安装CNI插件" class="headerlink" title="安装CNI插件"></a> 安装CNI插件</h2><p>参考<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/cluster-administration/networking/#how-to-implement-the-kubernetes-networking-model">集群网络系统</a>选择一个cni插件，这里我们选择flannel。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><h1 id="node01加入k8s集群"><span class="post-title-index">10.</span><a href="#node01加入k8s集群" class="headerlink" title="node01加入k8s集群"></a> node01加入k8s集群</h1><p>1、使用join命令，添加node01节点到集群</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">kubeadm</span> join <span class="number">192.168.56.200:6443</span> --token abcdef.<span class="number">0123456789</span>abcdef <span class="punctuation">\</span></span><br><span class="line"><span class="punctuation"></span>    --discovery-token-ca-cert-hash sha256:<span class="number">6743</span>eaae41ba8fd99e495e3df94ff9a996878e7c9cf8ac590a3c52b97ea8012e</span><br></pre></td></tr></table></figure><p>2、验证结果<br>在master节点执行：<br><code>kubectl get nodes</code><br>看到master节点和node01节点都是Ready的状态，说明安装成功。</p><h1 id="开发模式"><span class="post-title-index">11.</span><a href="#开发模式" class="headerlink" title="开发模式"></a> 开发模式</h1><p>出于安全原因，k8s集群默认不会在控制节点(master节点)上调度Pod。如果我们希望可以在master节点上调度Pod，比如在开发测试时，可以去掉master节点的污点。<br><code>kubectl taint nodes --all node-role.kubernetes.io/master-</code></p><h1 id="验证安装-1"><span class="post-title-index">12.</span><a href="#验证安装-1" class="headerlink" title="验证安装"></a> 验证安装</h1><h2 id="手动验证"><span class="post-title-index">12.1.</span><a href="#手动验证" class="headerlink" title="手动验证"></a> 手动验证</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line">kubectl get pods --all-namespaces</span><br><span class="line">service kube-apiserver status</span><br><span class="line">service kube-controller-manager status</span><br><span class="line">service kube-scheduler status</span><br><span class="line">service kubelet status</span><br><span class="line">service kube-proxy status</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl run nginx</span><br><span class="line">kubectl get pods</span><br><span class="line">kubectl scale --replicas=3 deploy/nginx</span><br><span class="line">kubectl get pods</span><br><span class="line">kubectl expose deployment nginx --port=80 --<span class="built_in">type</span>=NodePort</span><br><span class="line">kubectl get service</span><br><span class="line">curl http://node01:31850</span><br></pre></td></tr></table></figure><h2 id="test-infra"><span class="post-title-index">12.2.</span><a href="#test-infra" class="headerlink" title="test-infra"></a> test-infra</h2><p>源码地址：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/test-infra">kubernetes/test-infra</a></p><p>1、拉取源码<br><code>go get -u k8s.io/test-infra/kubetest</code></p><p>2、执行kubetest</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubetest <span class="attribute">--extract</span>=v1.11.3</span><br><span class="line">cd kubernetes</span><br><span class="line"><span class="built_in">export</span> <span class="attribute">KUBE_MASTER_IP</span>=<span class="string">&quot;192.168.56.200:6443&quot;</span></span><br><span class="line"><span class="built_in">export</span> <span class="attribute">KUBE_MASTER</span>=kube-master</span><br><span class="line">kubetest --test <span class="attribute">--provider</span>=skeleton &gt; testout.txt</span><br><span class="line">kubetest --test <span class="attribute">--provider</span>=skeleton <span class="attribute">--test_args</span>=<span class="string">&quot;ginkgo.focus=Secrets&quot;</span> &gt; testout.txt</span><br><span class="line">cat testout.txt</span><br></pre></td></tr></table></figure><h2 id="Smoke-Test"><span class="post-title-index">12.3.</span><a href="#Smoke-Test" class="headerlink" title="Smoke Test"></a> Smoke Test</h2><p>按照<a target="_blank" rel="noopener" href="https://github.com/mmumshad/kubernetes-the-hard-way/blob/master/docs/15-smoke-test.md">Smoke Test</a>文档操作一遍。</p><h2 id="sonobuoy"><span class="post-title-index">12.4.</span><a href="#sonobuoy" class="headerlink" title="sonobuoy"></a> sonobuoy</h2><p>官网地址：<a target="_blank" rel="noopener" href="https://sonobuoy.io/">sonobuoy</a><br>源码地址：<a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/sonobuoy">vmware-tanzu/sonobuoy</a></p><h1 id="节点重启后coredns启动问题"><span class="post-title-index">13.</span><a href="#节点重启后coredns启动问题" class="headerlink" title="节点重启后coredns启动问题"></a> 节点重启后coredns启动问题</h1><p>master节点重启后，发现coredns无法正常启动。<br>Warning Unhealthy 2m1s (x22 over 5m) kubelet Readiness probe failed: HTTP probe failed with statuscode: 503<br>[ERROR] plugin/errors: HINFO: read udp 10.244.0.7:48010-&gt;202.106.195.68:53: i/o timeout<br>[INFO] plugin/ready: Still waiting on: “kubernetes”</p><p>参考<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/63132164/how-to-solve-coredns-always-stuck-at-waiting-for-kubernetes">How to solve CoreDNS always stuck at “waiting for kubernetes”?</a>，发现需要关闭防火墙，低级错误！</p><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">system</span>ctl status firewalld</span><br><span class="line"><span class="params">system</span>ctl stop firewalld</span><br><span class="line"><span class="params">system</span>ctl disable firewalld</span><br></pre></td></tr></table></figure><h1 id="集群配置更改"><span class="post-title-index">14.</span><a href="#集群配置更改" class="headerlink" title="集群配置更改"></a> 集群配置更改</h1><p>执行<code>kubeadm init</code>初始化后，kubeadm.conf中的内容就写入到了k8s集群了configmap，可以通过kubectl命令查看。<br><code>kubectl get cm kubeadm-config -n kube-system -oyaml</code></p><p>如果想要修改配置，可以直接修改kubeadm-config这个configmap，详情参考<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-reconfigure/">重新配置 kubeadm 集群</a>。</p></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 好好学习的郝</li><li class="post-copyright-link"> <strong>原文链接：</strong> <a href="https://www.voidking.com/dev-kubeadm-install-k8s-in-centos/" title="好好学K8S：使用kubeadm安装部署K8S集群——CentOS篇">https://www.voidking.com/dev-kubeadm-install-k8s-in-centos/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本文采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议，转载请注明出处！源站会即时更新知识点并修正错误，欢迎访问~</li><li> <img width="200" height="200" src="/images/avatar.jpg"><p style="text-align:center;margin-bottom:0">微信公众号同步更新，欢迎关注~</p></li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/centos/" rel="tag"># centos</a> <a href="/tags/docker/" rel="tag"># docker</a> <a href="/tags/k8s/" rel="tag"># k8s</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag"># 网络</a> <a href="/tags/%E5%A5%BD%E5%A5%BD%E5%AD%A6K8S/" rel="tag"># 好好学K8S</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-kubeadm-install-k8s-in-ubuntu/" rel="prev" title="好好学K8S：使用kubeadm安装部署K8S集群——Ubuntu篇"><i class="fa fa-chevron-left"></i> 好好学K8S：使用kubeadm安装部署K8S集群——Ubuntu篇</a></div><div class="post-nav-item"> <a href="/dev-kubeadm-install-k8s-in-multi-cloud/" rel="next" title="好好学K8S：使用kubeadm跨云搭建K8S集群">好好学K8S：使用kubeadm跨云搭建K8S集群<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="footer-ads" style="margin-top:10px"><ins class="adsbygoogle" style="display:block" data-ad-format="autorelaxed" data-ad-client="ca-pub-3284447971731414" data-ad-slot="9697986181"></ins><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3284447971731414" crossorigin="anonymous"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div class="comments" id="gitalk-container"></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#kubeadm%E7%AE%80%E4%BB%8B"><span class="nav-text">1. kubeadm简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B"><span class="nav-text">2. 安装流程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-text">3. 环境准备</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85docker"><span class="nav-text">4. 安装docker</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%81%E8%AE%B8iptables%E6%A3%80%E6%9F%A5%E6%A1%A5%E6%8E%A5%E6%B5%81%E9%87%8F"><span class="nav-text">5. 允许iptables检查桥接流量</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85kubeadm-kubelet-kubectl"><span class="nav-text">6. 安装kubeadm+kubelet+kubectl</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87kubernetes-repo%E9%85%8D%E7%BD%AE"><span class="nav-text">6.1. 准备kubernetes.repo配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SELinux%E8%AE%BE%E7%BD%AE%E4%B8%BApermissive%E6%A8%A1%E5%BC%8F"><span class="nav-text">6.2. SELinux设置为permissive模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85kubeadm-kubelet-kubectl-1"><span class="nav-text">6.3. 安装kubeadm+kubelet+kubectl</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%B3%E9%97%ADswap"><span class="nav-text">7. 关闭swap</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEcgroup%E9%A9%B1%E5%8A%A8"><span class="nav-text">8. 配置cgroup驱动</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96master%E8%8A%82%E7%82%B9"><span class="nav-text">9. 初始化master节点</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6"><span class="nav-text">9.1. 下载镜像文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#k8s%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE"><span class="nav-text">9.2. k8s集群配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#advertiseAddress"><span class="nav-text">9.2.1. advertiseAddress</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E8%8A%82%E7%82%B9%E5%90%8D%E7%A7%B0"><span class="nav-text">9.2.2. 指定节点名称</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E5%AE%9Apod-ip%E8%8C%83%E5%9B%B4"><span class="nav-text">9.2.3. 指定pod ip范围</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">9.3. 执行初始化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">9.4. 创建配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E5%AE%89%E8%A3%85"><span class="nav-text">9.5. 验证安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E5%8F%91%E7%8E%B0%E9%97%AE%E9%A2%98"><span class="nav-text">9.6. 验证发现问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85CNI%E6%8F%92%E4%BB%B6"><span class="nav-text">9.7. 安装CNI插件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#node01%E5%8A%A0%E5%85%A5k8s%E9%9B%86%E7%BE%A4"><span class="nav-text">10. node01加入k8s集群</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F"><span class="nav-text">11. 开发模式</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E5%AE%89%E8%A3%85-1"><span class="nav-text">12. 验证安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%8B%E5%8A%A8%E9%AA%8C%E8%AF%81"><span class="nav-text">12.1. 手动验证</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#test-infra"><span class="nav-text">12.2. test-infra</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Smoke-Test"><span class="nav-text">12.3. Smoke Test</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sonobuoy"><span class="nav-text">12.4. sonobuoy</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E9%87%8D%E5%90%AF%E5%90%8Ecoredns%E5%90%AF%E5%8A%A8%E9%97%AE%E9%A2%98"><span class="nav-text">13. 节点重启后coredns启动问题</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE%E6%9B%B4%E6%94%B9"><span class="nav-text">14. 集群配置更改</span></a></li></ol></div></div><div class="sidecar-ads" style="margin-top:10px"><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">一个计算机技术爱好者与学习者</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">744</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">32</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">258</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/gitalk/1.7.2/gitalk.min.css"><script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/gitalk/1.7.2/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID: '5a238b8c32b1e4dd2156',
      clientSecret: 'bfb5d518626f6fdc7da0351d1e0cd37ab75c6361',
      repo: 'gitalk-comments',
      owner: 'voidking',
      admin: ['voidking'],
      id: 'a54010682ea1d7cca0d3b765e7af0c5c',
      title: '好好学K8S：使用kubeadm安装部署K8S集群——CentOS篇',
      body: '欢迎留言，互相交流学习~',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script></body></html>