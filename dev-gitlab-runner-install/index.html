<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1,cdn:{enable:!0,url:"//cdn.jsdelivr.net/gh/voidking/voidking.github.io/search.xml"}},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="GitLab Runner版本说明出于兼容性原因，GitLab Runner major.minor 版本应与 GitLab major.minor 版本保持同步。较旧的runner可能仍然可以使用较新的 GitLab 版本，反之亦然。但是，如果存在版本差异，功能可能无法使用或无法正常工作。minor版本更新时，会保障向后兼容性。但是，有时 GitLab 的minor版本更新会引入新功能，这些新功"><meta property="og:type" content="article"><meta property="og:title" content="GitLab Runner安装实践"><meta property="og:url" content="https://www.voidking.com/dev-gitlab-runner-install/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="GitLab Runner版本说明出于兼容性原因，GitLab Runner major.minor 版本应与 GitLab major.minor 版本保持同步。较旧的runner可能仍然可以使用较新的 GitLab 版本，反之亦然。但是，如果存在版本差异，功能可能无法使用或无法正常工作。minor版本更新时，会保障向后兼容性。但是，有时 GitLab 的minor版本更新会引入新功能，这些新功"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2022-11-11T14:00:00.000Z"><meta property="article:modified_time" content="2023-06-17T08:00:00.000Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="k8s"><meta property="article:tag" content="git"><meta property="article:tag" content="cicd"><meta property="article:tag" content="gitlab"><meta property="article:tag" content="helm"><meta property="article:tag" content="virtualbox"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.voidking.com/dev-gitlab-runner-install/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>GitLab Runner安装实践 | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">好好学习，天天向上！</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-gitlab-runner-install/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="学而不思则罔，思而不学则殆！"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> GitLab Runner安装实践</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-11-11 14:00:00" itemprop="dateCreated datePublished" datetime="2022-11-11T14:00:00+00:00">2022-11-11</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-06-17 08:00:00" itemprop="dateModified" datetime="2023-06-17T08:00:00+00:00">2023-06-17</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/" itemprop="url" rel="index"><span itemprop="name">engineering</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/devops/" itemprop="url" rel="index"><span itemprop="name">devops</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/cloudnative/" itemprop="url" rel="index"><span itemprop="name">cloudnative</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/git/" itemprop="url" rel="index"><span itemprop="name">git</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="GitLab-Runner版本说明"><a href="#GitLab-Runner版本说明" class="headerlink" title="GitLab Runner版本说明"></a>GitLab Runner版本说明</h1><p>出于兼容性原因，GitLab Runner major.minor 版本应与 GitLab major.minor 版本保持同步。<br>较旧的runner可能仍然可以使用较新的 GitLab 版本，反之亦然。但是，如果存在版本差异，功能可能无法使用或无法正常工作。<br>minor版本更新时，会保障向后兼容性。但是，有时 GitLab 的minor版本更新会引入新功能，这些新功能需要 GitLab Runner 在同一minor版本上。</p><p>需要特别注意的是：GitLab Runner 15.0 对注册 API 请求格式进行了更改。它阻止 GitLab Runner 与低于 14.8 的 GitLab 版本通信。我们必须使用适合 GitLab 版本的 Runner 版本，或升级 GitLab 应用程序。</p><p>更多内容参考文档<a target="_blank" rel="noopener" href="https://docs.gitlab.com/runner/">GitLab Runner</a></p><span id="more"></span><h1 id="查看安装教程"><a href="#查看安装教程" class="headerlink" title="查看安装教程"></a>查看安装教程</h1><h2 id="指定项目的Runner"><a href="#指定项目的Runner" class="headerlink" title="指定项目的Runner"></a>指定项目的Runner</h2><p>打开gitlab项目 -&gt; Settings -&gt; CI/CD -&gt; Runners -&gt; Expand -&gt; Show Runner installation instructions</p><p>页面的 registration token，用于注册指定项目（当前项目）的runner。</p><h2 id="共享的Runner"><a href="#共享的Runner" class="headerlink" title="共享的Runner"></a>共享的Runner</h2><p>查看Runner：<a target="_blank" rel="noopener" href="https://gitlab.voidking.com/admin/runners">https://gitlab.voidking.com/admin/runners</a></p><p>打开gitlab runner管理页面 -&gt; Show Runner installation instructions</p><p>页面的 registration token，用于注册共享runner。</p><h1 id="TOML语法"><a href="#TOML语法" class="headerlink" title="TOML语法"></a>TOML语法</h1><p>gitlab-runner配置文件为config.toml，使用TOML语法。<br>TOML的目标是成为一种易于阅读的最小配置文件格式。<br>TOML被设计为明确地映射到哈希表。<br>TOML应该很容易解析成各种语言的数据结构。</p><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/runner/configuration/">Configuring GitLab Runner</a></li><li><a target="_blank" rel="noopener" href="https://github.com/toml-lang/toml">TOML</a></li><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xingxia/p/toml.html">TOML 1.0格式语法</a></li><li><a target="_blank" rel="noopener" href="https://www.convertjson.com/toml-to-json.htm">Convert TOML To JSON</a></li></ul><h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><p><code>#</code>，井号后面表示注释</p><h2 id="键值对"><a href="#键值对" class="headerlink" title="键值对"></a>键值对</h2><p>键名为字符串，值可以为字符串、整数、浮点数、布尔值、日期、时刻、数组、行内表等。<br>键名在等号的左边，值在等号的右边。</p><p>例如：</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name</span> = <span class="string">&quot;voidking&quot;</span></span><br></pre></td></tr></table></figure><h2 id="表"><a href="#表" class="headerlink" title="表"></a>表</h2><p>表的表示方法：方括号+表名，例如<code>[table]</code>。<br>表是键值对的集合，类似于json中的对象（花括号中内容）。在它下方，直至下一个表头或文件结束，都是这个表的键值对。<br>顶层表，又被称为根表，于文档开始处开始并在第一个表头（或文件结束处）前结束。</p><p>表名的规则和键名的规则相同。</p><p>表的层级结构以点<code>.</code>分隔，分隔的每个部分都是一个表名。<br>定义一个多层级表时，如果最后一个表名前的表没有被创建，那么会被自动创建。</p><p>例如：</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[table]</span></span><br><span class="line"><span class="comment"># 定义一个名为 table 的表</span></span><br><span class="line"><span class="attr">key1</span> = <span class="string">&quot;some string&quot;</span></span><br><span class="line"><span class="attr">key2</span> = <span class="number">123</span></span><br><span class="line"></span><br><span class="line"><span class="attr">fruit.apple.color</span> = <span class="string">&quot;红色&quot;</span></span><br><span class="line"><span class="comment"># 定义一个名为 fruit 的表</span></span><br><span class="line"><span class="comment"># 定义一个名为 fruit.apple 的表</span></span><br><span class="line"></span><br><span class="line"><span class="attr">fruit.apple.taste.sweet</span> = <span class="literal">true</span></span><br><span class="line"><span class="comment"># 定义一个名为 fruit.apple.taste 的表</span></span><br><span class="line"><span class="comment"># fruit 和 fruit.apple 已经创建过了</span></span><br></pre></td></tr></table></figure><h2 id="表数组"><a href="#表数组" class="headerlink" title="表数组"></a>表数组</h2><p>表数组表示方法：双层方括号+表名，例如<code>[[fruits]]</code>。<br>表数组是表的数组，类似于json中的对象数组。</p><p>表数组的第一例定义了这个数组及其首个表元素，而后续的每个表数组在该数组中创建并定义一个新的表元素。</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[[fruits]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;苹果&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[fruits.physical]</span>  <span class="comment"># 子表</span></span><br><span class="line"><span class="attr">color</span> = <span class="string">&quot;红色&quot;</span></span><br><span class="line"><span class="attr">shape</span> = <span class="string">&quot;圆形&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[fruits.varieties]]</span>  <span class="comment"># 嵌套表数组</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;蛇果&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[fruits.varieties]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;澳洲青苹&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[fruits]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;香蕉&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[fruits.varieties]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;车前草&quot;</span></span><br></pre></td></tr></table></figure><p>对应的json格式为：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;fruits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;苹果&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;physical&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;红色&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;shape&quot;</span><span class="punctuation">:</span> <span class="string">&quot;圆形&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;varieties&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;蛇果&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;澳洲青苹&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;香蕉&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;varieties&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;车前草&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="缩进"><a href="#缩进" class="headerlink" title="缩进"></a>缩进</h2><p>TOML中的缩进没有意义，只是为了方便读者理解层级结构。</p><h1 id="Linux环境安装Runner"><a href="#Linux环境安装Runner" class="headerlink" title="Linux环境安装Runner"></a>Linux环境安装Runner</h1><p>参考文档：<a target="_blank" rel="noopener" href="https://docs.gitlab.com/runner/install/index.html">Install GitLab Runner</a></p><p>1、安装runner</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Download the binary for your system</span></span><br><span class="line">sudo curl -L --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64</span><br><span class="line"></span><br><span class="line"><span class="comment"># Give it permissions to execute</span></span><br><span class="line">sudo <span class="built_in">chmod</span> +x /usr/local/bin/gitlab-runner</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a GitLab CI user</span></span><br><span class="line">sudo useradd --comment <span class="string">&#x27;GitLab Runner&#x27;</span> --create-home gitlab-runner --shell /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install and run as service</span></span><br><span class="line">sudo gitlab-runner install --user=gitlab-runner --working-directory=/home/gitlab-runner</span><br><span class="line">sudo gitlab-runner start</span><br><span class="line">sudo gitlab-runner -v</span><br></pre></td></tr></table></figure><p>PS：其他版本的runner源码和二进制文件，可以在<a target="_blank" rel="noopener" href="https://gitlab.com/gitlab-org/gitlab-runner/-/releases">gitlab-runner Releases</a>页面找到。</p><p>对于centos系统，可以直接使用rpm包安装。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y https://gitlab-runner.downloads.s3.amazonaws.com/latest/rpm/gitlab-runner_amd64.rpm </span><br></pre></td></tr></table></figure><p>2、添加到gitlab-runner到docker用户组（可选）<br>如果gitlab-runner执行的ci脚本需要运行docker，那么需要将gitlab-runner到docker用户组</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -a -G docker gitlab-runner</span><br><span class="line"><span class="comment"># if no docker group</span></span><br><span class="line">sudo usermod -a -G root gitlab-runner</span><br><span class="line"></span><br><span class="line">sudo -u gitlab-runner -H docker info</span><br></pre></td></tr></table></figure><p>3、gitlab-runner添加sudo权限（可选）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sudoers</span><br></pre></td></tr></table></figure><p>添加配置：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-runner ALL=(ALL) NOPASSWD: ALL</span><br></pre></td></tr></table></figure><h1 id="注册Shell类型Runner"><a href="#注册Shell类型Runner" class="headerlink" title="注册Shell类型Runner"></a>注册Shell类型Runner</h1><p>Shell类型的Executor，在Runner程序所在主机上运行CI任务。</p><p>前置条件：安装好了Runner。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-runner register -h</span><br><span class="line">sudo gitlab-runner register --url https://gitlab.voidking.com/ --registration-token <span class="variable">$REGISTRATION_TOKEN</span></span><br></pre></td></tr></table></figure><p>REGISTRATION_TOKEN可以在gitlab页面获取到，详情参考上文【查看安装教程】一节。<br>根据提示，填写url、token、description、tags（多个tag以英文逗号分隔）、executor类型等信息，这里executor类型填写<code>shell</code>。</p><h1 id="注册Docker类型Runner"><a href="#注册Docker类型Runner" class="headerlink" title="注册Docker类型Runner"></a>注册Docker类型Runner</h1><p>Docker类型的Executor，在Runner程序所在主机上的Docker容器中运行CI任务。</p><p>前置条件：安装好了Runner，而且Runner所在主机已经安装配置好了Docker。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-runner register --url https://gitlab.voidking.com/ --registration-token <span class="variable">$REGISTRATION_TOKEN</span></span><br></pre></td></tr></table></figure><p>根据提示，填写url、token、description、tags、executor类型等信息，这里executor类型填写<code>docker</code>，最后填写一个默认的镜像。</p><h1 id="注册Docker-Machine类型Runner"><a href="#注册Docker-Machine类型Runner" class="headerlink" title="注册Docker Machine类型Runner"></a>注册Docker Machine类型Runner</h1><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/runner/executors/docker_machine.html">Install and register GitLab Runner for autoscaling with Docker Machine</a></li><li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/runner/configuration/autoscale.html">Docker Machine Executor autoscale configuration</a></li><li><a target="_blank" rel="noopener" href="https://www.runoob.com/docker/docker-machine.html">Docker Machine</a></li><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/RenshenLi/article/details/121585307">docker-machine的安装与使用</a></li></ul><h2 id="安装虚拟机驱动"><a href="#安装虚拟机驱动" class="headerlink" title="安装虚拟机驱动"></a>安装虚拟机驱动</h2><p>可选驱动：</p><ul><li>virtualbox（推荐），参考文档<a href="https://www.voidking.com/dev-linux-virtualbox/">Linux下使用VirtualBox</a></li><li>qemu，参考文档<a target="_blank" rel="noopener" href="https://github.com/machine-drivers/docker-machine-driver-qemu">machine-drivers/docker-machine-driver-qemu</a></li><li>kvm，参考文档<a target="_blank" rel="noopener" href="https://github.com/dhiltgen/docker-machine-kvm">dhiltgen/docker-machine-kvm</a></li></ul><p>1、安装virtualbox驱动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install https://download.virtualbox.org/virtualbox/6.1.26/VirtualBox-6.1-6.1.26_145957_el7-1.x86_64.rpm</span><br></pre></td></tr></table></figure><p>2、安装编译环境</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kernel-devel kernel-devel install gcc make perl kernel-headers</span><br></pre></td></tr></table></figure><p>3、激活virtualbox内核支持</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/vboxconfig</span><br></pre></td></tr></table></figure><h2 id="安装Docker-Machine"><a href="#安装Docker-Machine" class="headerlink" title="安装Docker Machine"></a>安装Docker Machine</h2><p>1、下载docker-machine二进制文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://gitlab.com/gitlab-org/ci-cd/docker-machine/-/releases/v0.16.2-gitlab.15/downloads/docker-machine-Linux-x86_64</span><br><span class="line"><span class="built_in">mv</span> docker-machine-Linux-x86_64 /usr/sbin/docker-machine</span><br><span class="line"><span class="built_in">chmod</span> +x /usr/sbin/docker-machine</span><br></pre></td></tr></table></figure><p>更多版本可以访问<a target="_blank" rel="noopener" href="https://gitlab.com/gitlab-org/ci-cd/docker-machine/-/releases">docker-machine/releases</a>页面查找。</p><p>2、测试启动虚拟机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-machine create -d virtualbox <span class="built_in">test</span></span><br></pre></td></tr></table></figure><h2 id="注册Runner"><a href="#注册Runner" class="headerlink" title="注册Runner"></a>注册Runner</h2><p>前置条件：安装好了Runner。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-runner register --url https://gitlab.voidking.com/ --registration-token <span class="variable">$REGISTRATION_TOKEN</span></span><br></pre></td></tr></table></figure><p>根据提示，填写url、token、description、tags、executor类型等信息，这里executor类型填写<code>docker+machine</code>，最后填写一个默认的镜像。</p><h2 id="配置镜像加速（可选）"><a href="#配置镜像加速（可选）" class="headerlink" title="配置镜像加速（可选）"></a>配置镜像加速（可选）</h2><p>参考文档<a href="https://www.voidking.com/dev-docker-registry-mirror/">《Docker镜像站的配置和使用》</a>，搭建本地镜像站。</p><h2 id="配置缓存"><a href="#配置缓存" class="headerlink" title="配置缓存"></a>配置缓存</h2><p>1、启动minio容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name minio \</span><br><span class="line">--restart always \</span><br><span class="line">-p 9000:9000 \</span><br><span class="line">-p 9001:9001  \</span><br><span class="line">-v /data/minio/.minio:/data/.minio \</span><br><span class="line">-v /data/minio/export:/export \</span><br><span class="line">-e <span class="string">&quot;MINIO_ROOT_USER=root&quot;</span> \</span><br><span class="line">-e <span class="string">&quot;MINIO_ROOT_PASSWORD=xxxxxx&quot;</span> \</span><br><span class="line">minio/minio:latest server /export --console-address <span class="string">&quot;:9001&quot;</span></span><br></pre></td></tr></table></figure><p>2、页面访问<br><a target="_blank" rel="noopener" href="http://192.168.56.101:9001/">http://192.168.56.101:9001/</a></p><h2 id="配置Runner"><a href="#配置Runner" class="headerlink" title="配置Runner"></a>配置Runner</h2><p>1、修改 /etc/gitlab-runner/config.toml</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">concurrent = 3</span><br><span class="line">check_interval = 0</span><br><span class="line"></span><br><span class="line">[session_server]</span><br><span class="line">  session_timeout = 1800</span><br><span class="line"></span><br><span class="line">[[runners]]</span><br><span class="line">  limit = 3</span><br><span class="line">  name = &quot;dockermachine&quot;</span><br><span class="line">  url = &quot;https://gitlab.voidking.com&quot;</span><br><span class="line">  token = &quot;xxx&quot;</span><br><span class="line">  executor = &quot;docker+machine&quot;</span><br><span class="line">  [runners.custom_build_dir]</span><br><span class="line">    enabled = true</span><br><span class="line">  [runners.cache]</span><br><span class="line">    Type = &quot;s3&quot;</span><br><span class="line">    Path = &quot;runner&quot;</span><br><span class="line">    Shared = true</span><br><span class="line">    [runners.cache.s3]</span><br><span class="line">      ServerAddress = &quot;192.168.56.101:9000&quot;</span><br><span class="line">      AccessKey = &quot;root&quot;</span><br><span class="line">      SecretKey = &quot;xxx&quot;</span><br><span class="line">      BucketName = &quot;runner&quot;</span><br><span class="line">      Insecure = true</span><br><span class="line">    [runners.cache.gcs]</span><br><span class="line">    [runners.cache.azure]</span><br><span class="line">  [runners.docker]</span><br><span class="line">    tls_verify = false</span><br><span class="line">    image = &quot;docker:19.03&quot;</span><br><span class="line">    privileged = true</span><br><span class="line">    disable_entrypoint_overwrite = false</span><br><span class="line">    oom_kill_disable = false</span><br><span class="line">    disable_cache = false</span><br><span class="line">    volumes = [&quot;/certs/client&quot;,&quot;/cache&quot;, &quot;/var/run/docker.sock:/var/run/docker.sock&quot;]</span><br><span class="line">    pull_policy = [&quot;if-not-present&quot;]</span><br><span class="line">    shm_size = 0</span><br><span class="line">  [runners.machine]</span><br><span class="line">    IdleCount = 5</span><br><span class="line">    MaxGrowthRate = 1</span><br><span class="line">    IdleTime = 1800</span><br><span class="line">    MachineDriver = &quot;virtualbox&quot;</span><br><span class="line">    MachineName = &quot;auto-scale-%s&quot;</span><br><span class="line">    MachineOptions = [</span><br><span class="line">      &quot;engine-registry-mirror=http://192.168.56.101:5000&quot;,</span><br><span class="line">      &quot;engine-registry-mirror=http://192.168.56.101:5001&quot;,</span><br><span class="line">      &quot;virtualbox-memory=4048&quot;,</span><br><span class="line">      &quot;virtualbox-disk-size=204800&quot;,</span><br><span class="line">      &quot;virtualbox-cpu-count=2&quot;</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure><p>注意：runners.docker.image要指定版本，否则每次构建都会拉取最新版的docker，而最新版本的docker不支持http请求镜像仓库。<br>更多docker版本可以访问<a target="_blank" rel="noopener" href="https://hub.docker.com/_/docker/tags?page=1">dockerhub - docker</a>获取。</p><p>其中MachineOptions中给定的参数，是<code>docker-machine create</code>命令接收的参数。</p><p>2、重新启动runner</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-runner restart</span><br></pre></td></tr></table></figure><h2 id="管理Docker-Machine"><a href="#管理Docker-Machine" class="headerlink" title="管理Docker Machine"></a>管理Docker Machine</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-machine <span class="built_in">ls</span></span><br><span class="line">docker-machine ssh xxx</span><br></pre></td></tr></table></figure><h1 id="K8S环境安装Runner"><a href="#K8S环境安装Runner" class="headerlink" title="K8S环境安装Runner"></a>K8S环境安装Runner</h1><p>本节中，我们在K8S中通过helm安装Runner。</p><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/runner/install/kubernetes.html">GitLab Runner Helm Chart</a></li><li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/runner/install/kubernetes.html#running-docker-in-docker-containers-with-gitlab-runner">GitLab Runner Helm Chart - Running Docker-in-Docker containers with GitLab Runner</a></li><li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=0Fes86qtBSc">GitLab CI CD | Install and Configure GitLab Runner on Kubernetes with Helm</a></li><li><a target="_blank" rel="noopener" href="http://docs.idevops.site/gitlabci/chapter05/01/01-runner%E6%9E%84%E5%BB%BA%E7%8E%AF%E5%A2%83%E4%BC%98%E5%8C%96%E9%85%8D%E7%BD%AE/">Runner构建优化</a></li><li><a target="_blank" rel="noopener" href="https://www.qikqiak.com/post/gitlab-runner-install-on-k8s/">在 Kubernetes 上安装 Gitlab CI Runner</a></li></ul><h2 id="准备存储"><a href="#准备存储" class="headerlink" title="准备存储"></a>准备存储</h2><p>通过helm安装runner，values当前还不支持配置storageclass。因此，需要先自行准备好runner的存储。主要参考文档<a href="https://www.voidking.com/dev-k8s-storageclass/">《K8S中安装配置StorageClass》</a></p><p>准备pvc定义 runner-pvc.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab-runner-cache</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs-storage</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">50Gi</span></span><br></pre></td></tr></table></figure><h2 id="准备Runner配置"><a href="#准备Runner配置" class="headerlink" title="准备Runner配置"></a>准备Runner配置</h2><p>1、添加gitlab repo</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add gitlab https://charts.gitlab.io</span><br><span class="line">helm repo update</span><br></pre></td></tr></table></figure><p>2、查看可用的runner版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm search repo -l gitlab/gitlab-runner</span><br></pre></td></tr></table></figure><p>CHART VERSION有对应的APP VERSION版本，选择需要的APP VERSION版本。<br>这里选择14.0.0版本，对应CHART VERSION为0.30.0</p><p>3、下载chart</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm fetch gitlab/gitlab-runner --version 0.30.0</span><br><span class="line">tar -xzvf gitlab-runner-0.30.0.tgz</span><br></pre></td></tr></table></figure><p>4、values.yaml修改配置</p><ul><li>image：指定版本gitlab/gitlab-runner:alpine-v14.0.1，更多镜像版本可以访问<a target="_blank" rel="noopener" href="https://hub.docker.com/r/gitlab/gitlab-runner/tags">docker hub</a>查找</li><li>gitlabUrl：改成我们自己的的gitlab地址</li><li>runnerRegistrationToken：参考【查看安装教程】一节获取</li><li>resources：修改申请和限制的资源</li><li>rbac.create：改成true，创建sa用于创建runner</li><li>name：改成runner想要在gitlab中显示的名称</li><li>tags：改成runner想要注册的tags，多个tag以英文逗号分隔</li><li>replicas：改成runner期望的副本数，这些runner副本使用同一个name。</li><li>privileged：改成true，启用docker in docker</li><li>runners.config：支持自定义构建目录，支持docker in docker</li></ul><p>runners.config内容：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[runners.custom_build_dir]</span><br><span class="line">  enabled = true</span><br><span class="line"></span><br><span class="line">[[runners.kubernetes.volumes.host_path]]</span><br><span class="line">  name = &quot;docker&quot;</span><br><span class="line">  mount_path = &quot;/var/run/docker.sock&quot;</span><br><span class="line">  read_only = true</span><br><span class="line">  host_path = &quot;/var/run/docker.sock&quot;</span><br></pre></td></tr></table></figure><p>我们想要对构建缓存使用持久化存储，因此需要添加</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## configure build cache</span></span><br><span class="line"><span class="attr">cibuild:</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">pvcName:</span> <span class="string">gitlab-runner-cache</span></span><br><span class="line">    <span class="attr">mountPath:</span> <span class="string">/home/gitlab-runner/ci-build-cache</span></span><br></pre></td></tr></table></figure><p>同时，需要修改gitlab-runner/templates/configmap.yaml<br>data.entrypoint部分添加runner配置，自动挂载存储</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># add build cache and </span></span><br><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">&gt;&gt;/home/gitlab-runner/.gitlab-runner/config.toml</span></span><br><span class="line">  [[<span class="string">runners.kubernetes.volumes.pvc</span>]]</span><br><span class="line">    <span class="string">name</span> <span class="string">=</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;.Values.cibuild.cache.pvcName&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="string">mount_path</span> <span class="string">=</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;.Values.cibuild.cache.mountPath&#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Start the runner</span></span><br><span class="line"><span class="string">exec</span> <span class="string">/entrypoint</span> <span class="string">run</span> <span class="string">--user=gitlab-runner</span> <span class="string">\</span></span><br><span class="line">  <span class="string">--working-directory=/home/gitlab-runner</span></span><br></pre></td></tr></table></figure><h2 id="安装Runner"><a href="#安装Runner" class="headerlink" title="安装Runner"></a>安装Runner</h2><p>1、安装runner</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns gitlab-14-0</span><br><span class="line">kubectl apply -f runner-pvc.yaml -n gitlab-14-0</span><br><span class="line">helm install --namespace gitlab-14-0 gitlab-runner ./gitlab-runner</span><br></pre></td></tr></table></figure><p>2、查看安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all -n gitlab-14-0</span><br><span class="line">kubectl get pvc -n gitlab-14-0</span><br><span class="line">kubectl logs pod/gitlab-runner-gitlab-runner-849988b584-kllqv -n gitlab-14-0</span><br></pre></td></tr></table></figure><p>3、查看runner注册结果<br><a target="_blank" rel="noopener" href="https://gitlab.voidking.com/admin/runners">https://gitlab.voidking.com/admin/runners</a></p><p>找到新的runner，点击右侧的Edit按钮，可以做进一步的配置。</p><h1 id="自定义builds路径"><a href="#自定义builds路径" class="headerlink" title="自定义builds路径"></a>自定义builds路径</h1><p>参考文档<a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/ci/large_repositories/">Optimize GitLab for large repositories</a></p><p>1、准备builds目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /builds</span><br><span class="line"><span class="built_in">mkdir</span> /cache</span><br><span class="line"><span class="built_in">chown</span> gitlab-runner:gitlab-runner -R /builds</span><br><span class="line"><span class="built_in">chown</span> gitlab-runner:gitlab-runner -R /cache</span><br></pre></td></tr></table></figure><p>2、修改runner配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/gitlab-runner/config.toml</span><br></pre></td></tr></table></figure><p>添加配置</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[[runners]]</span><br><span class="line">  builds_dir = &quot;/builds&quot;</span><br><span class="line">  cache_dir = &quot;/cache&quot;</span><br><span class="line">  [runners.custom_build_dir]</span><br><span class="line">    enabled = true</span><br></pre></td></tr></table></figure><p>3、重启runner</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-runner restart</span><br></pre></td></tr></table></figure><h1 id="取消注册Runner"><a href="#取消注册Runner" class="headerlink" title="取消注册Runner"></a>取消注册Runner</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看token</span></span><br><span class="line">gitlab-runner list</span><br><span class="line"><span class="comment"># token还可以在/etc/gitlab-runner/config.toml中查看</span></span><br><span class="line"><span class="comment"># 取消注册runner</span></span><br><span class="line">gitlab-runner unregister -t <span class="variable">$token</span> -u https://gitlab.voidking.com/</span><br></pre></td></tr></table></figure></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 好好学习的郝</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.voidking.com/dev-gitlab-runner-install/" title="GitLab Runner安装实践">https://www.voidking.com/dev-gitlab-runner-install/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！源站会及时更新知识点及修正错误，阅读体验也更好。欢迎分享，欢迎收藏~</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/k8s/" rel="tag"># k8s</a> <a href="/tags/git/" rel="tag"># git</a> <a href="/tags/cicd/" rel="tag"># cicd</a> <a href="/tags/gitlab/" rel="tag"># gitlab</a> <a href="/tags/helm/" rel="tag"># helm</a> <a href="/tags/virtualbox/" rel="tag"># virtualbox</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-gitlab-runner-start/" rel="prev" title="GitLab Runner入门篇"><i class="fa fa-chevron-left"></i> GitLab Runner入门篇</a></div><div class="post-nav-item"> <a href="/dev-gitlab-ci-problems/" rel="next" title="GitLab CI问题记录">GitLab CI问题记录<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="footer-ads" style="margin-top:10px"><div class="_xduxciwe4ao"></div><script type="text/javascript" src="//cpro.baidustatic.com/cpro/ui/cm.js" async="async" defer="defer"></script><script type="text/javascript">(window.slotbydup=window.slotbydup||[]).push({id:"u6920911",container:"_xduxciwe4ao",async:!0}),(window.slotbydup=window.slotbydup||[]).push({id:"u6920919",container:"_053ydasmd31h",async:!0}),(window.slotbydup=window.slotbydup||[]).push({id:"u6921432",container:"_ft8kcphe7kl",async:!0})</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3284447971731414" crossorigin="anonymous"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div class="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zODU3Mi8xNTEwMA=="></div></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#GitLab-Runner%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-number">1.</span> <span class="nav-text">GitLab Runner版本说明</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B"><span class="nav-number">2.</span> <span class="nav-text">查看安装教程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E9%A1%B9%E7%9B%AE%E7%9A%84Runner"><span class="nav-number">2.1.</span> <span class="nav-text">指定项目的Runner</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B1%E4%BA%AB%E7%9A%84Runner"><span class="nav-number">2.2.</span> <span class="nav-text">共享的Runner</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TOML%E8%AF%AD%E6%B3%95"><span class="nav-number">3.</span> <span class="nav-text">TOML语法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E9%87%8A"><span class="nav-number">3.1.</span> <span class="nav-text">注释</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%AE%E5%80%BC%E5%AF%B9"><span class="nav-number">3.2.</span> <span class="nav-text">键值对</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A1%A8"><span class="nav-number">3.3.</span> <span class="nav-text">表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A1%A8%E6%95%B0%E7%BB%84"><span class="nav-number">3.4.</span> <span class="nav-text">表数组</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%A9%E8%BF%9B"><span class="nav-number">3.5.</span> <span class="nav-text">缩进</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Linux%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Runner"><span class="nav-number">4.</span> <span class="nav-text">Linux环境安装Runner</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B3%A8%E5%86%8CShell%E7%B1%BB%E5%9E%8BRunner"><span class="nav-number">5.</span> <span class="nav-text">注册Shell类型Runner</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B3%A8%E5%86%8CDocker%E7%B1%BB%E5%9E%8BRunner"><span class="nav-number">6.</span> <span class="nav-text">注册Docker类型Runner</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B3%A8%E5%86%8CDocker-Machine%E7%B1%BB%E5%9E%8BRunner"><span class="nav-number">7.</span> <span class="nav-text">注册Docker Machine类型Runner</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%A9%B1%E5%8A%A8"><span class="nav-number">7.1.</span> <span class="nav-text">安装虚拟机驱动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Docker-Machine"><span class="nav-number">7.2.</span> <span class="nav-text">安装Docker Machine</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8CRunner"><span class="nav-number">7.3.</span> <span class="nav-text">注册Runner</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="nav-number">7.4.</span> <span class="nav-text">配置镜像加速（可选）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E7%BC%93%E5%AD%98"><span class="nav-number">7.5.</span> <span class="nav-text">配置缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AERunner"><span class="nav-number">7.6.</span> <span class="nav-text">配置Runner</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%A1%E7%90%86Docker-Machine"><span class="nav-number">7.7.</span> <span class="nav-text">管理Docker Machine</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#K8S%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Runner"><span class="nav-number">8.</span> <span class="nav-text">K8S环境安装Runner</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%AD%98%E5%82%A8"><span class="nav-number">8.1.</span> <span class="nav-text">准备存储</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87Runner%E9%85%8D%E7%BD%AE"><span class="nav-number">8.2.</span> <span class="nav-text">准备Runner配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Runner"><span class="nav-number">8.3.</span> <span class="nav-text">安装Runner</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89builds%E8%B7%AF%E5%BE%84"><span class="nav-number">9.</span> <span class="nav-text">自定义builds路径</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%96%E6%B6%88%E6%B3%A8%E5%86%8CRunner"><span class="nav-number">10.</span> <span class="nav-text">取消注册Runner</span></a></li></ol></div></div><div class="sidecar-ads" style="margin-top:10px"><ins class="adsbygoogle" style="display:block" data-ad-format="autorelaxed" data-ad-client="ca-pub-3284447971731414" data-ad-slot="2661998066"></ins></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">学而不思则罔，思而不学则殆！</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">645</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">30</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">242</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={iconStyle:"box",boxForm:"horizontal",position:"bottomCenter",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={iconStyle:"box",boxForm:"horizontal",position:"topRight",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-float",flOptions)</script><script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  // window.livereOptions = {
  //   refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  // };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script></body></html>