<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1,cdn:{enable:!0,url:"//cdn.jsdelivr.net/gh/voidking/voidking.github.io/search.xml"}},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="前言《在CentOS7上配置PHP运行环境》一文中学习了安装配置LNMP环境，《CentOS安装Apache和PHP环境》一文中学习了安装配置Apache和PHP环境。 本文学习使用Docker安装配置Apache和PHP，与Mysql结合，搭建一个容器化的LAMP环境，部署微擎服务。 前置条件是安装配置好了docker环境，安装方法参考《Docker入门》。已知docker宿主机IP为192.1"><meta property="og:type" content="article"><meta property="og:title" content="使用Docker安装配置Apache和PHP环境（微擎环境）"><meta property="og:url" content="https://www.voidking.com/dev-docker-apache-php/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="前言《在CentOS7上配置PHP运行环境》一文中学习了安装配置LNMP环境，《CentOS安装Apache和PHP环境》一文中学习了安装配置Apache和PHP环境。 本文学习使用Docker安装配置Apache和PHP，与Mysql结合，搭建一个容器化的LAMP环境，部署微擎服务。 前置条件是安装配置好了docker环境，安装方法参考《Docker入门》。已知docker宿主机IP为192.1"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://cdn.voidking.com/@/imgs/docker-apache-php/install.jpg?imageView2/0/w/600"><meta property="og:image" content="http://cdn.voidking.com/@/imgs/docker-apache-php/check.jpg?imageView2/0/w/800"><meta property="og:image" content="http://cdn.voidking.com/@/imgs/docker-apache-php/success.jpg?imageView2/0/w/600"><meta property="og:image" content="http://cdn.voidking.com/@/imgs/docker-apache-php/check2.jpg?imageView2/0/w/800"><meta property="og:image" content="http://cdn.voidking.com/@/imgs/docker-apache-php/check2.jpg?imageView2/0/w/800"><meta property="og:image" content="http://cdn.voidking.com/@/imgs/docker-apache-php/data.jpg?imageView2/0/w/700"><meta property="og:image" content="http://cdn.voidking.com/@/imgs/docker-apache-php/mysql.jpg?imageView2/0/w/800"><meta property="og:image" content="http://cdn.voidking.com/@/imgs/docker-apache-php/finish.jpg?imageView2/0/w/800"><meta property="og:image" content="http://cdn.voidking.com/@/imgs/docker-apache-php/login.jpg?imageView2/0/w/700"><meta property="og:image" content="http://cdn.voidking.com/@/imgs/docker-apache-php/newinstall.jpg?imageView2/0/w/700"><meta property="og:image" content="http://cdn.voidking.com/@/imgs/docker-apache-php/setting.jpg?imageView2/0/w/700"><meta property="article:published_time" content="2019-12-30T20:00:00.000Z"><meta property="article:modified_time" content="2019-12-30T20:00:00.000Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="docker"><meta property="article:tag" content="apache"><meta property="article:tag" content="php"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://cdn.voidking.com/@/imgs/docker-apache-php/install.jpg?imageView2/0/w/600"><link rel="canonical" href="https://www.voidking.com/dev-docker-apache-php/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>使用Docker安装配置Apache和PHP环境（微擎环境） | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">好好学习，天天向上！</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-docker-apache-php/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="学而不思则罔，思而不学则殆！"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> 使用Docker安装配置Apache和PHP环境（微擎环境）</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-12-30 20:00:00" itemprop="dateCreated datePublished" datetime="2019-12-30T20:00:00+00:00">2019-12-30</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/" itemprop="url" rel="index"><span itemprop="name">engineering</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/php/" itemprop="url" rel="index"><span itemprop="name">php</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><a href="https://www.voidking.com/dev-centos-php-envirenment/">《在CentOS7上配置PHP运行环境》</a>一文中学习了安装配置LNMP环境，<a href="https://www.voidking.com/dev-centos-apache-php/">《CentOS安装Apache和PHP环境》</a>一文中学习了安装配置Apache和PHP环境。</p><p>本文学习使用Docker安装配置Apache和PHP，与Mysql结合，搭建一个容器化的LAMP环境，部署微擎服务。</p><p>前置条件是安装配置好了docker环境，安装方法参考<a href="https://www.voidking.com/dev-docker-start/">《Docker入门》</a>。已知docker宿主机IP为192.168.56.130。</p><span id="more"></span><h1 id="安装Mysql"><a href="#安装Mysql" class="headerlink" title="安装Mysql"></a>安装Mysql</h1><p>参考<a href="https://www.voidking.com/dev-docker-mysql/">《使用Docker安装配置Mysql》</a>，安装好mysql server和mysql client。</p><p>1、登录mysql server<br><code>mysql -h 127.0.0.1 -u root -p</code></p><p>2、创建数据库</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> `w7` <span class="keyword">default</span> <span class="type">character</span> <span class="keyword">set</span> utf8 <span class="keyword">collate</span> utf8_general_ci; </span><br></pre></td></tr></table></figure><h1 id="安装PHP"><a href="#安装PHP" class="headerlink" title="安装PHP"></a>安装PHP</h1><p>1、登录dockerhub查看需要的<a target="_blank" rel="noopener" href="https://hub.docker.com/_/php">PHP - Docker Official Images</a>。</p><p>2、下载php镜像（以7.2-apache为例）<br><code>docker pull php:7.2-apache</code></p><p>选择带有apache的版本，省去了安装apache的步骤。</p><p>3、启动php和apache服务</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run --name vk-php -d \</span><br><span class="line">-p <span class="number">8080</span>:<span class="number">80</span> \</span><br><span class="line">-v <span class="regexp">/opt/</span>php<span class="regexp">/w7:/</span>var<span class="regexp">/www/</span>html \</span><br><span class="line">php:<span class="number">7.2</span>-apache</span><br></pre></td></tr></table></figure><p>以上命令：</p><ul><li>命名容器为vk-php，后台运行</li><li>映射宿主机8080端口到容器的80端口</li><li>挂载宿主机目录/opt/php/w7到容器目录/var/www/html</li></ul><p>更多启动命令参数可以参考<a target="_blank" rel="noopener" href="https://hub.docker.com/_/php?tab=description">How to use this image</a>。</p><p>4、创建测试文件<br><code>vim /opt/php/w7/index.php</code>，内容为：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;hello php7.2&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>5、验证安装<br><code>curl localhost:8080</code>，可以看到hello php7.2。<br>浏览器访问 <a target="_blank" rel="noopener" href="http://192.168.56.130:8080/">http://192.168.56.130:8080</a> ，可以看到hello php7.2。</p><p>以上，apache和php环境安装配置完成。</p><h1 id="安装微擎"><a href="#安装微擎" class="headerlink" title="安装微擎"></a>安装微擎</h1><h2 id="初始尝试"><a href="#初始尝试" class="headerlink" title="初始尝试"></a>初始尝试</h2><p>主要参考<a href="voidking.com/dev-we7-start/">《微擎系统搭建》</a>和<a target="_blank" rel="noopener" href="https://www.kancloud.cn/we7pengpeng/weengine/1369873">微擎linux服务器安装</a>。<br>1、下载微擎安装引导文件</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="regexp">/opt/</span>php/w7</span><br><span class="line">wget https:<span class="regexp">//</span>cdn.w7.cc<span class="regexp">/download/</span>WeEngine-Laster-Online.zip</span><br><span class="line">unzip WeEngine-Laster-Online.zip</span><br></pre></td></tr></table></figure><p>2、浏览器访问安装页面<br><a target="_blank" rel="noopener" href="http://192.168.56.130:8080/install.php">http://192.168.56.130:8080/install.php</a><br><img src="http://cdn.voidking.com/@/imgs/docker-apache-php/install.jpg?imageView2/0/w/600"><br>填入用户名密码后，点击验证后安装微擎。没有通过验证，如下图：<br><img src="http://cdn.voidking.com/@/imgs/docker-apache-php/check.jpg?imageView2/0/w/800"><br>由报错看，主要是目录权限问题和缺少扩展问题。</p><h2 id="重做镜像"><a href="#重做镜像" class="headerlink" title="重做镜像"></a>重做镜像</h2><p>1、修改sources.list<br>在容器中查看/etc/apt/sources.list，发现镜像版本是debian buster，因此新建一个sources.list为：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">deb http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/debian/</span> buster main non-free contrib</span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/debian/</span> buster main non-free contrib</span><br><span class="line">deb http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/debian-security buster/u</span>pdates main</span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/debian-security buster/u</span>pdates main</span><br><span class="line">deb http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/debian/</span> buster-updates main non-free contrib</span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/debian/</span> buster-updates main non-free contrib</span><br><span class="line">deb http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/debian/</span> buster-backports main non-free contrib</span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/debian/</span> buster-backports main non-free contrib</span><br></pre></td></tr></table></figure><p>2、编写Dockerfile</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> php:7.2-apache</span><br><span class="line"></span><br><span class="line">COPY sources.list /etc/apt/sources.list</span><br><span class="line"><span class="built_in">RUN</span> apt-<span class="built_in">get</span> update &amp;&amp; apt-<span class="built_in">get</span> install -y libpng-dev libzip-dev \</span><br><span class="line">    &amp;&amp; docker-php-ext-install zip gd pdo pdo_mysql</span><br><span class="line"><span class="built_in">RUN</span> chmod 777 /var/www/html</span><br></pre></td></tr></table></figure><p>3、生成新镜像<br><code>docker build -t voidking/w7:v1.0 .</code><br><img src="http://cdn.voidking.com/@/imgs/docker-apache-php/success.jpg?imageView2/0/w/600"></p><h2 id="再次尝试"><a href="#再次尝试" class="headerlink" title="再次尝试"></a>再次尝试</h2><p>1、删除原有容器</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker stop vk-php</span><br><span class="line">docker rm vk-php</span><br></pre></td></tr></table></figure><p>2、启动新的容器</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run --name vk-php -d \</span><br><span class="line">-p <span class="number">8080</span>:<span class="number">80</span> \</span><br><span class="line">-v <span class="regexp">/opt/</span>php<span class="regexp">/w7:/</span>var<span class="regexp">/www/</span>html \</span><br><span class="line">voidking/w7:v1.<span class="number">0</span></span><br></pre></td></tr></table></figure><p>3、再次安装，再次验证<br><img src="http://cdn.voidking.com/@/imgs/docker-apache-php/check2.jpg?imageView2/0/w/800"><br>可以看到，这次还剩一个问题：外网不可访问。这就奇怪了，在容器内明明是可以正常访问外网的，为啥报这个错？既然没错，那就忽略它好了。但是这个错存在，就无法进行下一步，因此这里我们换一种安装方式：源码安装。</p><h2 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h2><p>1、下载源码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/php/w7</span><br><span class="line"><span class="built_in">rm</span> -rf ./*</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">git <span class="built_in">clone</span> https://gitee.com/we7coreteam/pros.git w7</span><br></pre></td></tr></table></figure><p>2、再次安装，再次验证<br><img src="http://cdn.voidking.com/@/imgs/docker-apache-php/check2.jpg?imageView2/0/w/800"><br>nice，完美跳过了外网不可访问这个坑。然后，data目录权限报错。<br><img src="http://cdn.voidking.com/@/imgs/docker-apache-php/data.jpg?imageView2/0/w/700"><br>修改data目录权限，<code>chmod 777 /opt/php/w7/data/</code>，问题解决。</p><p>3、填入数据库连接信息，以及管理员用户名密码<br><img src="http://cdn.voidking.com/@/imgs/docker-apache-php/mysql.jpg?imageView2/0/w/800"></p><p>4、然后，安装完成。<br><img src="http://cdn.voidking.com/@/imgs/docker-apache-php/finish.jpg?imageView2/0/w/800"></p><p>5、测试访问<br>浏览器访问首页 <a target="_blank" rel="noopener" href="http://192.168.56.130:8080/index.php">http://192.168.56.130:8080/index.php</a> ，即会跳转到微擎登录页。<br><img src="http://cdn.voidking.com/@/imgs/docker-apache-php/login.jpg?imageView2/0/w/700"></p><p>以上，微擎系统安装配置完成，可以愉快地使用了。</p><h1 id="百度云解析"><a href="#百度云解析" class="headerlink" title="百度云解析"></a>百度云解析</h1><h2 id="备案失败"><a href="#备案失败" class="headerlink" title="备案失败"></a>备案失败</h2><p>百度智能云年终盛典，全场云服务器一折起，于是151块钱入手了一台1C2G2M的百度云BCC主机。但是，没有想到的是，网站需要新增接入备案，否则无法使用域名！！！这个不怪百度，如果使用百度云备案成功，以后想要接入阿里云或者腾讯云，也需要新增接入备案。</p><p>不过百度云比较坑的有两点：第一点是备案期间域名不能解析，而阿里云备案期间可以正常解析。第二点是无法通过百度云的备案审核，提交备案后百度云给出了六条不符合审核条件的理由，而同样的审核材料，一个月前在阿里云通过了备案审核。</p><p>真的是没有对比就没有伤害，第一个念头是退货，然而退货失败。不能退货，那该怎样使用这台服务器呢？那该怎样在这台服务器上部署服务，然后通过域名访问呢？</p><p>在github找到了一些项目，<a target="_blank" rel="noopener" href="https://github.com/awesome-selfhosted/awesome-selfhosted">awesome-selfhosted</a>，想要部署一些不需要域名的服务，好歹给利用起来了。但是，依然不甘心，想要给这些服务加上域名！然后，真的找到了办法！前提是你还有一台可以进行域名接入的主机，无论是备案过的阿里云主机，还是不需要备案的海外主机，都可以。</p><h2 id="解析方案"><a href="#解析方案" class="headerlink" title="解析方案"></a>解析方案</h2><p>已知两台主机：可以域名接入的主机（主机A），百度云主机（主机B）。<br>我们在主机B上部署好了微擎服务，想要给这个服务添加一个域名：w7.voidking.com</p><p>1、安装frp<br>参考<a href="https://www.voidking.com/dev-frp/">《使用frp进行内网穿透》</a>，在主机A上安装配置好frp server，在主机B上安装配置好frp client。主机B上的8080端口，映射为主机A上的3480端口。</p><p>2、nginx配置<br>在主机A上，添加nginx解析 w7.voidking.com.conf ，内容为：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">server_name</span> w7.voidking.com;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://127.0.0.1:3480/;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意，不用多加其他参数，不然会出现502等错误。</p><p>3、域名解析<br>在dnspod上添加A记录解析到主机A。</p><p>以上，可以通过域名访问百度云上的微擎服务了。</p><h1 id="微擎后续问题"><a href="#微擎后续问题" class="headerlink" title="微擎后续问题"></a>微擎后续问题</h1><h2 id="站点URL问题"><a href="#站点URL问题" class="headerlink" title="站点URL问题"></a>站点URL问题</h2><p>确实可以通过域名访问微擎服务了，但是站点的很多请求地址为 127.0.0.1:3480 ，因为微擎服务使用proxy_pass里的URL作为了站点URL。我们想让微擎服务把域名作为站点URL，解决办法很简单，添加：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_set_header</span> Host <span class="variable">$http_host</span>;</span><br></pre></td></tr></table></figure><p>但是，添加完这个参数，就会出现502错误，尴尬了吧。。。<br>nginx层没法进行修复，看来这个问题只能通过修改微擎源码来修复了。<br>编辑/opt/php/w7/framework/bootstrap.inc.php，如下修改：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># line 90, change</span></span><br><span class="line"><span class="regexp">//</span> <span class="variable">$_W</span>[<span class="string">&#x27;siteroot&#x27;</span>] = htmlspecialchars(<span class="variable">$_W</span>[<span class="string">&#x27;sitescheme&#x27;</span>] . (isset(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>]) ? <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>] : <span class="string">&#x27;&#x27;</span>) . <span class="variable">$sitepath</span>);</span><br><span class="line"><span class="variable">$_W</span>[<span class="string">&#x27;siteroot&#x27;</span>] = <span class="string">&#x27;w7.voidking.com&#x27;</span>;</span><br></pre></td></tr></table></figure><p>然后，请求地址就全部变成 w7.voidking.com ，nice。</p><h2 id="跨域问题"><a href="#跨域问题" class="headerlink" title="跨域问题"></a>跨域问题</h2><p>但是，一些请求报错：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Access</span> <span class="keyword">to</span> XMLHttpRequest at <span class="string">&#x27;javascript:;&#x27;</span> <span class="keyword">from</span> origin <span class="string">&#x27;http://w7.voidking.com&#x27;</span> has been blocked <span class="keyword">by</span> CORS <span class="keyword">policy</span>: <span class="keyword">Cross</span> origin requests are <span class="keyword">only</span> supported <span class="keyword">for</span> protocol schemes: http, data, chrome, chrome-<span class="keyword">extension</span>, https.</span><br></pre></td></tr></table></figure><p>明明都是同一个url，居然还是跨域错误，没有找到解决办法。</p><h2 id="重装微擎"><a href="#重装微擎" class="headerlink" title="重装微擎"></a>重装微擎</h2><p>既然自己安装微擎问题这么多，那就使用官网给的docker镜像好了，参考<a target="_blank" rel="noopener" href="https://www.kancloud.cn/we7pengpeng/weengine/1369875">docker安装微擎</a>。</p><p>1、删除原有环境</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker stop vk-php</span><br><span class="line">docker rm vk-php</span><br></pre></td></tr></table></figure><p>2、启动新的容器</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name vk-php -d \</span><br><span class="line">-p <span class="number">8080</span>:<span class="number">80</span> \</span><br><span class="line">-v <span class="regexp">/opt/</span>w7<span class="regexp">/mysql:/</span>var<span class="regexp">/lib/my</span>sql \</span><br><span class="line">-v <span class="regexp">/opt/</span>w7<span class="regexp">/html:/</span>var<span class="regexp">/www/</span>html \</span><br><span class="line">-e MYSQL\_ROOT\_PASSWORD=<span class="number">123456</span> -d \</span><br><span class="line">--restart=always \</span><br><span class="line">ccr.ccs.tencentyun.com<span class="regexp">/weiqing/</span>nginxphpmysql:<span class="number">1.0</span></span><br></pre></td></tr></table></figure><p>3、重新安装微擎<br><a target="_blank" rel="noopener" href="http://ip:8080/install.php">http://ip:8080/install.php</a><br><img src="http://cdn.voidking.com/@/imgs/docker-apache-php/newinstall.jpg?imageView2/0/w/700"></p><p>4、设置用户名密码<br><img src="http://cdn.voidking.com/@/imgs/docker-apache-php/setting.jpg?imageView2/0/w/700"></p><p>5、同样修改微擎源码，修改站点URL。</p><p>然后，同样有跨域问题，但是站点已经可以正常使用了，就先这么滴吧。</p></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 好好学习的郝</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.voidking.com/dev-docker-apache-php/" title="使用Docker安装配置Apache和PHP环境（微擎环境）">https://www.voidking.com/dev-docker-apache-php/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！源站会及时更新知识点及修正错误，阅读体验也更好。欢迎分享，欢迎收藏~</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/docker/" rel="tag"># docker</a> <a href="/tags/apache/" rel="tag"># apache</a> <a href="/tags/php/" rel="tag"># php</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-docker-nginx/" rel="prev" title="使用Docker安装配置Nginx"><i class="fa fa-chevron-left"></i> 使用Docker安装配置Nginx</a></div><div class="post-nav-item"> <a href="/dev-jvm-params/" rel="next" title="JVM参数设置规范描述">JVM参数设置规范描述<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="footer-ads" style="margin-top:10px"><div class="_xduxciwe4ao"></div><script type="text/javascript">(window.slotbydup=window.slotbydup||[]).push({id:"u6920911",container:"_xduxciwe4ao",async:!0}),(window.slotbydup=window.slotbydup||[]).push({id:"u6920919",container:"_053ydasmd31h",async:!0})</script><script type="text/javascript" src="//cpro.baidustatic.com/cpro/ui/cm.js" async="async" defer="defer"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3284447971731414" crossorigin="anonymous"></script></div><div class="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zODU3Mi8xNTEwMA=="></div></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Mysql"><span class="nav-number">2.</span> <span class="nav-text">安装Mysql</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85PHP"><span class="nav-number">3.</span> <span class="nav-text">安装PHP</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E5%BE%AE%E6%93%8E"><span class="nav-number">4.</span> <span class="nav-text">安装微擎</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%B0%9D%E8%AF%95"><span class="nav-number">4.1.</span> <span class="nav-text">初始尝试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8D%E5%81%9A%E9%95%9C%E5%83%8F"><span class="nav-number">4.2.</span> <span class="nav-text">重做镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%8D%E6%AC%A1%E5%B0%9D%E8%AF%95"><span class="nav-number">4.3.</span> <span class="nav-text">再次尝试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85"><span class="nav-number">4.4.</span> <span class="nav-text">源码安装</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%99%BE%E5%BA%A6%E4%BA%91%E8%A7%A3%E6%9E%90"><span class="nav-number">5.</span> <span class="nav-text">百度云解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%87%E6%A1%88%E5%A4%B1%E8%B4%A5"><span class="nav-number">5.1.</span> <span class="nav-text">备案失败</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90%E6%96%B9%E6%A1%88"><span class="nav-number">5.2.</span> <span class="nav-text">解析方案</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BE%AE%E6%93%8E%E5%90%8E%E7%BB%AD%E9%97%AE%E9%A2%98"><span class="nav-number">6.</span> <span class="nav-text">微擎后续问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%99%E7%82%B9URL%E9%97%AE%E9%A2%98"><span class="nav-number">6.1.</span> <span class="nav-text">站点URL问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98"><span class="nav-number">6.2.</span> <span class="nav-text">跨域问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8D%E8%A3%85%E5%BE%AE%E6%93%8E"><span class="nav-number">6.3.</span> <span class="nav-text">重装微擎</span></a></li></ol></li></ol></div></div><div class="sidecar-ads" style="margin-top:10px"><div class="_053ydasmd31h"></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">学而不思则罔，思而不学则殆！</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">645</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">30</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">242</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={iconStyle:"box",boxForm:"horizontal",position:"bottomCenter",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={iconStyle:"box",boxForm:"horizontal",position:"topRight",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-float",flOptions)</script><script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  // window.livereOptions = {
  //   refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  // };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script></body></html>