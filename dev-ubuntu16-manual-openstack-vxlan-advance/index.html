<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="目标《Ubuntu16手动安装OpenStack——openvswitch》一文中，配置好了openvswitch作为虚拟交换机。 《Ubuntu16手动安装OpenStack——vxlan网络》一文中，使用linuxbridge虚拟交换机配置过vxlan网络模式。 因为linuxbridge换成了openvswitch，所以，本文就再来研究一下vxlan网络模式的配置。主要参考OpenStack"><meta property="og:type" content="article"><meta property="og:title" content="Ubuntu16手动安装OpenStack——vxlan网络进阶"><meta property="og:url" content="https://www.voidking.com/dev-ubuntu16-manual-openstack-vxlan-advance/index.html"><meta property="og:site_name" content="VoidKing"><meta property="og:description" content="目标《Ubuntu16手动安装OpenStack——openvswitch》一文中，配置好了openvswitch作为虚拟交换机。 《Ubuntu16手动安装OpenStack——vxlan网络》一文中，使用linuxbridge虚拟交换机配置过vxlan网络模式。 因为linuxbridge换成了openvswitch，所以，本文就再来研究一下vxlan网络模式的配置。主要参考OpenStack"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/router01.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/int_net.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/subnet1.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/ext_net.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/subnet2.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/network.jpg"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/rbac.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/rbacdetail.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/networklist.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/projectlist.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/siat.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/cirros1.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/serverlist.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/floatingip.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/206.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/serverlist1.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/ping.jpg?imageView2/0/w/550"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/ping2.jpg?imageView2/0/w/550"><meta property="article:published_time" content="2018-07-18T17:00:00.000Z"><meta property="article:modified_time" content="2020-02-10T11:59:26.338Z"><meta property="article:author" content="VoidKing"><meta property="article:tag" content="linux"><meta property="article:tag" content="网络"><meta property="article:tag" content="ubuntu"><meta property="article:tag" content="openstack"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/router01.jpg?imageView2/0/w/750"><link rel="canonical" href="https://www.voidking.com/dev-ubuntu16-manual-openstack-vxlan-advance/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>Ubuntu16手动安装OpenStack——vxlan网络进阶 | VoidKing</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="VoidKing" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">VoidKing</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">好好学习，天天向上！</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-ubuntu16-manual-openstack-vxlan-advance/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="VoidKing"><meta itemprop="description" content="学而不思则罔，思而不学则殆！"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="VoidKing"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> Ubuntu16手动安装OpenStack——vxlan网络进阶</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-07-18 17:00:00" itemprop="dateCreated datePublished" datetime="2018-07-18T17:00:00+00:00">2018-07-18</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/" itemprop="url" rel="index"><span itemprop="name">专业</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%93%E4%B8%9A/%E8%BF%90%E7%BB%B4/ubuntu/" itemprop="url" rel="index"><span itemprop="name">ubuntu</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p><a href="https://www.voidking.com/dev-ubuntu16-manual-openstack-openvswitch/">《Ubuntu16手动安装OpenStack——openvswitch》</a>一文中，配置好了openvswitch作为虚拟交换机。</p><p><a href="https://www.voidking.com/dev-ubuntu16-manual-openstack-vxlan/">《Ubuntu16手动安装OpenStack——vxlan网络》</a>一文中，使用linuxbridge虚拟交换机配置过vxlan网络模式。</p><p>因为linuxbridge换成了openvswitch，所以，本文就再来研究一下vxlan网络模式的配置。主要参考<a href="https://www.server-world.info/en/note?os=CentOS_7&p=openstack_pike&f=20" target="_blank" rel="noopener">OpenStack Pike : Neutron Network (VXLAN)</a>和<a href="https://www.jb51.net/article/136960.htm" target="_blank" rel="noopener">openstack使用openvswitch实现vxlan的方法</a>。如果要配置flat网络模式，参考<a href="https://www.server-world.info/en/note?os=CentOS_7&p=openstack_pike&f=19" target="_blank" rel="noopener">OpenStack Pike : Neutron Network (FLAT)</a>。</p><a id="more"></a><h1 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h1><h2 id="root用户"><a href="#root用户" class="headerlink" title="root用户"></a>root用户</h2><p>为了避免权限问题，建议切换到root用户进行操作（否则要加很多sudo）。<br><code>sudo -i</code></p><h2 id="控制节点"><a href="#控制节点" class="headerlink" title="控制节点"></a>控制节点</h2><p>0、备份配置（可选操作）：<code>cp /etc/neutron/plugins/ml2/ml2_conf.ini{,.bak}</code></p><p>1、<code>vi /etc/neutron/plugins/ml2/ml2_conf.ini</code>，如下修改：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># line 130: add a value to tenant_network_types</span></span><br><span class="line"><span class="attr">tenant_network_types</span> = vxlan</span><br><span class="line"><span class="comment"># line 181: add</span></span><br><span class="line"><span class="section">[ml2_type_flat]</span></span><br><span class="line"><span class="attr">flat_networks</span> = physnet1</span><br><span class="line"><span class="comment"># line 235: add</span></span><br><span class="line"><span class="section">[ml2_type_vxlan]</span></span><br><span class="line"><span class="attr">vni_ranges</span> = <span class="number">1</span>:<span class="number">1000</span></span><br></pre></td></tr></table></figure><p>2、重启neutron-server<br><code>systemctl restart neutron-server</code></p><h2 id="网络节点"><a href="#网络节点" class="headerlink" title="网络节点"></a>网络节点</h2><p>这里我们的网络节点和控制节点是同一个节点。</p><p>1、创建网桥br-eth2<br><code>ovs-vsctl add-br br-eth2</code></p><p>2、把br-eth2连接到eth2<br><code>ovs-vsctl add-port br-eth2 eth2</code></p><p>3、<code>vi /etc/neutron/plugins/ml2/ml2_conf.ini</code>，如下修改：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># line 130: add a value to tenant_network_types</span></span><br><span class="line"><span class="attr">tenant_network_types</span> = vxlan</span><br><span class="line"><span class="comment"># line 181: add</span></span><br><span class="line"><span class="section">[ml2_type_flat]</span></span><br><span class="line"><span class="attr">flat_networks</span> = physnet1</span><br><span class="line"><span class="comment"># line 235: add</span></span><br><span class="line"><span class="section">[ml2_type_vxlan]</span></span><br><span class="line"><span class="attr">vni_ranges</span> = <span class="number">1</span>:<span class="number">1000</span></span><br></pre></td></tr></table></figure><p>4、<code>vi /etc/neutron/plugins/ml2/openvswitch_agent.ini</code>，如下修改：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># line 117: add</span></span><br><span class="line"><span class="section">[agent]</span></span><br><span class="line"><span class="attr">tunnel_types</span> = vxlan</span><br><span class="line"><span class="attr">l2_population</span> = <span class="literal">True</span></span><br><span class="line"><span class="attr">prevent_arp_spoofing</span> = <span class="literal">True</span></span><br><span class="line"><span class="comment"># line 195: add (specify IP address of this host for local_ip)</span></span><br><span class="line"><span class="section">[ovs]</span></span><br><span class="line"><span class="attr">local_ip</span> = <span class="number">172.16</span>.<span class="number">0.105</span></span><br><span class="line"><span class="attr">bridge_mappings</span> = physnet1:br-eth2</span><br></pre></td></tr></table></figure><p>5、重启相关服务</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span><span class="built_in"> service </span><span class="keyword">in</span> dhcp-agent l3-agent metadata-agent openvswitch-agent; <span class="keyword">do</span></span><br><span class="line">systemctl restart neutron-<span class="variable">$service</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="计算节点"><a href="#计算节点" class="headerlink" title="计算节点"></a>计算节点</h2><p>1、<code>vi /etc/neutron/plugins/ml2/ml2_conf.ini</code>，如下修改：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># line 130: add a value to tenant_network_types</span></span><br><span class="line"><span class="attr">tenant_network_types</span> = vxlan</span><br><span class="line"><span class="comment"># line 181: add</span></span><br><span class="line"><span class="section">[ml2_type_flat]</span></span><br><span class="line"><span class="attr">flat_networks</span> = physnet1</span><br><span class="line"><span class="comment"># line 235: add</span></span><br><span class="line"><span class="section">[ml2_type_vxlan]</span></span><br><span class="line"><span class="attr">vni_ranges</span> = <span class="number">1</span>:<span class="number">1000</span></span><br></pre></td></tr></table></figure><p>2、<code>vi /etc/neutron/plugins/ml2/openvswitch_agent.ini</code>，如下修改：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># line 117: add</span></span><br><span class="line"><span class="section">[agent]</span></span><br><span class="line"><span class="attr">tunnel_types</span> = vxlan</span><br><span class="line"><span class="attr">l2_population</span> = <span class="literal">True</span></span><br><span class="line"><span class="attr">prevent_arp_spoofing</span> = <span class="literal">True</span></span><br><span class="line"><span class="comment"># line 195: add (specify IP address of this host for local_ip)</span></span><br><span class="line"><span class="section">[ovs]</span></span><br><span class="line"><span class="attr">local_ip</span> = <span class="number">172.16</span>.<span class="number">0.106</span></span><br></pre></td></tr></table></figure><p>3、重启openvswitch-agent<br><code>systemctl restart neutron-openvswitch-agent</code></p><h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>在控制节点测试使用vxlan，实际上可以在任意节点使用。</p><h2 id="内核配置"><a href="#内核配置" class="headerlink" title="内核配置"></a>内核配置</h2><p>1、<code>vim /etc/sysctl.conf</code>，如下修改：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># line 19, uncomment and change</span></span><br><span class="line"><span class="attr">net.ipv4.conf.default.rp_filter</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">net.ipv4.conf.all.rp_filter</span>=<span class="number">0</span></span><br><span class="line"><span class="comment"># line 28, uncomment</span></span><br><span class="line"><span class="attr">net.ipv4.ip_forward</span>=<span class="number">1</span></span><br><span class="line"><span class="comment"># end line, add</span></span><br><span class="line"><span class="attr">net.bridge.bridge-nf-call-iptables</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">net.bridge.bridge-nf-call-ip6tables</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><p>2、使内核配置生效<br><code>sysctl -p</code></p><h2 id="创建vxlan网络"><a href="#创建vxlan网络" class="headerlink" title="创建vxlan网络"></a>创建vxlan网络</h2><p>1、使admin环境生效<br><code>. admin-openrc</code></p><p>2、创建路由router01<br><code>openstack router create router01</code><br><img src="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/router01.jpg?imageView2/0/w/750" alt=""></p><p>3、创建内部网络int_net<br><code>openstack network create int_net --provider-network-type vxlan</code><br><img src="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/int_net.jpg?imageView2/0/w/750" alt=""></p><p>4、在内部网络中创建子网</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack subnet create subnet1 --network <span class="built_in">int</span>_net \</span><br><span class="line">--subnet-range <span class="number">192.168</span><span class="number">.100</span><span class="number">.0</span>/<span class="number">24</span> --gateway <span class="number">192.168</span><span class="number">.100</span><span class="number">.1</span> \</span><br><span class="line">--dns-nameserver <span class="number">10.0</span><span class="number">.0</span><span class="number">.10</span></span><br></pre></td></tr></table></figure><p><img src="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/subnet1.jpg?imageView2/0/w/750" alt=""></p><p>5、把内部网络int_net连接到路由router01上<br><code>openstack router add subnet router01 subnet1</code></p><p>6、创建外部网络ext_net</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack<span class="built_in"> network </span>create \</span><br><span class="line">--provider-physical-network physnet1 \</span><br><span class="line">--provider-network-type flat --external ext_net</span><br></pre></td></tr></table></figure><p><img src="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/ext_net.jpg?imageView2/0/w/750" alt=""></p><p>7、在外部网络中创建子网subnet2</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openstack subnet create subnet2 \</span><br><span class="line">--network ext_net --subnet-range <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span> \</span><br><span class="line">--allocation-pool start=<span class="number">10.0</span><span class="number">.0</span><span class="number">.200</span>,end=<span class="number">10.0</span><span class="number">.0</span><span class="number">.254</span> \</span><br><span class="line">--gateway <span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span> --dns-nameserver <span class="number">10.0</span><span class="number">.0</span><span class="number">.10</span> --no-dhcp</span><br></pre></td></tr></table></figure><p><img src="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/subnet2.jpg?imageView2/0/w/750" alt=""></p><p>8、把ext_net的网关设置为router01<br><code>openstack router set router01 --external-gateway ext_net</code></p><p>此时，在horizon控制台看到的网络拓扑如下：<br><img src="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/network.jpg" alt=""></p><h2 id="授权网络"><a href="#授权网络" class="headerlink" title="授权网络"></a>授权网络</h2><p>默认情况下，所有项目都可以访问到外部网络，但对于内部网络，只有管理项目可以访问它。因此需要对其他项目进行授权，使项目中的用户可以使用内部网络。</p><p>1、查看rbac网络<br><code>openstack network rbac list</code><br><img src="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/rbac.jpg?imageView2/0/w/750" alt=""></p><p>2、查看rbac网络细节<br><code>openstack network rbac show [rbac-id]</code><br><img src="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/rbacdetail.jpg?imageView2/0/w/750" alt=""></p><p>3、查看网络<br><code>openstack network list</code><br><img src="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/networklist.jpg?imageView2/0/w/750" alt=""></p><p>4、查看项目<br><code>openstack project list</code><br><img src="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/projectlist.jpg?imageView2/0/w/750" alt=""></p><p>5、授权int_net给siat项目，权限为access_as_shared</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">netID</span>=$(openstack<span class="built_in"> network </span>list | grep int_net | awk <span class="string">'&#123; print $2 &#125;'</span>) </span><br><span class="line"><span class="attribute">prjID</span>=$(openstack project list | grep siat | awk <span class="string">'&#123; print $2 &#125;'</span>) </span><br><span class="line">openstack<span class="built_in"> network </span>rbac create --target-project <span class="variable">$prjID</span> --type<span class="built_in"> network </span>--action access_as_shared <span class="variable">$netID</span></span><br></pre></td></tr></table></figure><h2 id="使用vxlan网络"><a href="#使用vxlan网络" class="headerlink" title="使用vxlan网络"></a>使用vxlan网络</h2><p>1、切换到siat项目的voidking用户环境<br><code>. voidkingrc</code></p><p>2、查看实例模板、镜像、网络</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack flavor list</span><br><span class="line">openstack image list </span><br><span class="line">openstack<span class="built_in"> network </span>list</span><br></pre></td></tr></table></figure><p><img src="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/siat.jpg?imageView2/0/w/750" alt=""></p><p>3、安全组和密钥使用<a href="https://www.voidking.com/dev-ubuntu16-manual-openstack-instance/">《Ubuntu16手动安装OpenStack——创建实例》</a>一文中创建的secgroup01和vkkey。</p><p>4、创建实例</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">netID</span>=$(openstack<span class="built_in"> network </span>list | grep int_net | awk <span class="string">'&#123; print $2 &#125;'</span>) </span><br><span class="line">openstack<span class="built_in"> server </span>create --flavor m1.tiny --image cirros --security-group secgroup01 --nic <span class="attribute">net-id</span>=<span class="variable">$netID</span> --key-name vkkey cirros1</span><br></pre></td></tr></table></figure><p><img src="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/cirros1.jpg?imageView2/0/w/750" alt=""></p><p>5、查看实例<br><code>openstack server list</code><br><img src="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/serverlist.jpg?imageView2/0/w/750" alt=""></p><p>6、给实例添加浮动IP</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openstack floating<span class="built_in"> ip </span>create ext_net</span><br><span class="line">openstack<span class="built_in"> server </span><span class="builtin-name">add</span> floating<span class="built_in"> ip </span>cirros1 10.0.0.206</span><br></pre></td></tr></table></figure><p><img src="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/floatingip.jpg?imageView2/0/w/750" alt=""></p><p>7、查看浮动IP<br><code>openstack floating ip show 10.0.0.206</code><br><img src="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/206.jpg?imageView2/0/w/750" alt=""></p><p>8、再次查看实例<br><code>openstack server list</code><br><img src="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/serverlist1.jpg?imageView2/0/w/750" alt=""><br>可以发现，cirros1已经有了两个IP地址。</p><p>9、测试连通<br><code>ping 10.0.0.206</code>，不通。</p><h1 id="网络调试"><a href="#网络调试" class="headerlink" title="网络调试"></a>网络调试</h1><h2 id="连接实例"><a href="#连接实例" class="headerlink" title="连接实例"></a>连接实例</h2><p>1、测试网关<br><code>ping 10.0.0.1</code>，不通。</p><p>2、将br-eth2的ip设置为10.0.0.1</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth2 <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> </span><br><span class="line">ifconfig br-eth2 <span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure><p>3、测试连通<br><code>ping 10.0.0.206</code>，已经连通，nice。</p><p>4、ssh登录实例<br><code>ssh cirros@10.0.0.206</code>，默认密码为gocubsgo。</p><p>或者vnc登录实例<br><code>openstack console url show cirros1</code><br>查看到url后，在浏览器登录cirros1。</p><h2 id="连接外网"><a href="#连接外网" class="headerlink" title="连接外网"></a>连接外网</h2><p>参考<a href="https://www.voidking.com/dev-ubuntu16-manual-openstack-internet/">Ubuntu16手动安装OpenStack——实例访问外网</a>，配置实例连接外网。</p><p>1、在控制节点执行</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -i br-eth2 -j ACCEPT</span><br><span class="line">iptables -I INPUT -i eth2 -j ACCEPT</span><br><span class="line">iptables -t<span class="built_in"> nat </span>-A POSTROUTING -s 10.0.0.0/24 -o eth1 -j SNAT --to 172.16.0.105</span><br></pre></td></tr></table></figure><p>2、登录cirros1<br><code>ssh cirros@10.0.0.206</code></p><p>2、测试访问<br><code>ping 8.8.8.8 -c3</code><br><img src="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/ping.jpg?imageView2/0/w/550" alt=""></p><p>3、修改resolv.conf<br><code>sudo vi /etc/resolv.conf</code><br>添加：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nameserver <span class="number">180.76</span><span class="number">.76</span><span class="number">.76</span></span><br></pre></td></tr></table></figure><p>4、测试访问<br><code>ping www.baidu.com -c3</code><br><img src="http://cdn.voidking.com//imgs/ubuntu16-manual-openstack-vxlan-advance/ping2.jpg?imageView2/0/w/550" alt=""></p></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/linux/" rel="tag"># linux</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag"># 网络</a> <a href="/tags/ubuntu/" rel="tag"># ubuntu</a> <a href="/tags/openstack/" rel="tag"># openstack</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-ubuntu16-manual-openstack-openvswitch/" rel="prev" title="Ubuntu16手动安装OpenStack——openvswitch"><i class="fa fa-chevron-left"></i> Ubuntu16手动安装OpenStack——openvswitch</a></div><div class="post-nav-item"> <a href="/dev-openvswitch-vxlan/" rel="next" title="使用Open vSwitch进行VxLAN隧道实验">使用Open vSwitch进行VxLAN隧道实验<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zODU3Mi8xNTEwMA=="></div></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#目标"><span class="nav-number">1.</span> <span class="nav-text">目标</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装配置"><span class="nav-number">2.</span> <span class="nav-text">安装配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#root用户"><span class="nav-number">2.1.</span> <span class="nav-text">root用户</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#控制节点"><span class="nav-number">2.2.</span> <span class="nav-text">控制节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#网络节点"><span class="nav-number">2.3.</span> <span class="nav-text">网络节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#计算节点"><span class="nav-number">2.4.</span> <span class="nav-text">计算节点</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#使用"><span class="nav-number">3.</span> <span class="nav-text">使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#内核配置"><span class="nav-number">3.1.</span> <span class="nav-text">内核配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建vxlan网络"><span class="nav-number">3.2.</span> <span class="nav-text">创建vxlan网络</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#授权网络"><span class="nav-number">3.3.</span> <span class="nav-text">授权网络</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用vxlan网络"><span class="nav-number">3.4.</span> <span class="nav-text">使用vxlan网络</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#网络调试"><span class="nav-number">4.</span> <span class="nav-text">网络调试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#连接实例"><span class="nav-number">4.1.</span> <span class="nav-text">连接实例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#连接外网"><span class="nav-number">4.2.</span> <span class="nav-text">连接外网</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="VoidKing" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">VoidKing</p><div class="site-description" itemprop="description">学而不思则罔，思而不学则殆！</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">583</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">40</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">189</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://twitter.com/voidking_com" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;voidking_com" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i> Twitter</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2020</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">VoidKing</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://www.beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={iconStyle:"box",boxForm:"horizontal",position:"bottomCenter",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={iconStyle:"box",boxForm:"horizontal",position:"topRight",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-float",flOptions)</script><script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  // window.livereOptions = {
  //   refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  // };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script></body></html>