<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1,cdn:{enable:!0,url:"//qiniu-cdn.voidking.com/doc/search.xml"}},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="PromQL简介 Prometheus提供了一种称为PromQL（Prometheus查询语言）的功能查询语言，使用户可以实时选择和汇总时间序列数据。表达式的结果既可以显示为图形，也可以在Prometheus的表达式浏览器中显示为表格数据，也可以由外部系统通过HTTP API使用。  参考文档：  QUERYING PROMETHEUS  QUERYING FUNCTIONS 表达式语言运算符 Q"><meta property="og:type" content="article"><meta property="og:title" content="Prometheus查询语言：PromQL"><meta property="og:url" content="https://www.voidking.com/dev-prometheus-query-language-promql/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="PromQL简介 Prometheus提供了一种称为PromQL（Prometheus查询语言）的功能查询语言，使用户可以实时选择和汇总时间序列数据。表达式的结果既可以显示为图形，也可以在Prometheus的表达式浏览器中显示为表格数据，也可以由外部系统通过HTTP API使用。  参考文档：  QUERYING PROMETHEUS  QUERYING FUNCTIONS 表达式语言运算符 Q"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2020-06-21T20:00:00.000Z"><meta property="article:modified_time" content="2023-08-26T08:00:00.000Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="prometheus"><meta property="article:tag" content="promql"><meta property="article:tag" content="监控"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.voidking.com/dev-prometheus-query-language-promql/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>Prometheus查询语言：PromQL | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">一个计算机技术爱好者与学习者</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-prometheus-query-language-promql/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="一个计算机技术爱好者与学习者"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> Prometheus查询语言：PromQL</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-06-21 20:00:00" itemprop="dateCreated datePublished" datetime="2020-06-21T20:00:00+00:00">2020-06-21</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-08-26 08:00:00" itemprop="dateModified" datetime="2023-08-26T08:00:00+00:00">2023-08-26</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/" itemprop="url" rel="index"><span itemprop="name">engineering</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/monitoring/" itemprop="url" rel="index"><span itemprop="name">monitoring</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="PromQL简介"><span class="post-title-index">1.</span><a href="#PromQL简介" class="headerlink" title="PromQL简介"></a> PromQL简介</h1><blockquote><p>Prometheus提供了一种称为PromQL（Prometheus查询语言）的功能查询语言，使用户可以实时选择和汇总时间序列数据。表达式的结果既可以显示为图形，也可以在Prometheus的表达式浏览器中显示为表格数据，也可以由外部系统通过HTTP API使用。</p></blockquote><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/querying/basics/">QUERYING PROMETHEUS</a></li><li><a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/querying/functions/">QUERYING FUNCTIONS</a></li><li><a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/querying/operators/">表达式语言运算符</a></li><li><a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/querying/examples/">QUERY EXAMPLE</a></li><li><a target="_blank" rel="noopener" href="https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/promql">探索PromQL</a></li><li><a target="_blank" rel="noopener" href="https://www.kawabangga.com/posts/4408">PromQL 简明教程</a></li></ul><span id="more"></span><h1 id="基本概念"><span class="post-title-index">2.</span><a href="#基本概念" class="headerlink" title="基本概念"></a> 基本概念</h1><h2 id="指标（Metric）"><span class="post-title-index">2.1.</span><a href="#指标（Metric）" class="headerlink" title="指标（Metric）"></a> 指标（Metric）</h2><p>指标是一种测量数据，通常由名称和一组标签组成。</p><p>指标（样本）格式：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">metric_name [ &#123;label_name=&quot;label_value&quot;&#125; ] value [ timestamp ]</span><br></pre></td></tr></table></figure><p>指标说明：</p><ul><li>metric_name：指标名称（本质是<code>__name__</code>的标签值），只能使用字母、数字、下划线和冒号，区分大小写，不能以下划线和数字开头</li><li>value：指标值，是一个float格式的数据</li><li>label_name：标签名称，只能使用字母、数字和下划线，区分大小写，不能以下划线和数字开头</li><li>label_value：标签值，字符串</li><li>timestamp：时间戳，类型为int64（从1970-01-01 00:00:00以来的毫秒数），timestamp可选，默认为当前时间</li><li>注释：<code>#</code>号开头表示注释</li><li>指标组：具有相同 metric_name 的样本必须按照一个组的形式排列，并且每一行必须是唯一的指标名称和标签键值对组合</li><li>两种指标类型：Gauge是当前状态的数值，Counter是一个永远递增的数值。</li></ul><p>指标示例：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;host=&quot;www.voidking.com&quot;, method=&quot;GET&quot;, status=&quot;200&quot;&#125; 34</span><br><span class="line">http_requests_total&#123;host=&quot;blog.voidking.com&quot;, method=&quot;GET&quot;, status=&quot;200&quot;&#125; 21</span><br></pre></td></tr></table></figure><p>该指标组表示 HTTP GET 请求中状态码为 200 的计数，host 、method 和 status 是标签。</p><h2 id="时间序列（Time-Series）"><span class="post-title-index">2.2.</span><a href="#时间序列（Time-Series）" class="headerlink" title="时间序列（Time Series）"></a> 时间序列（Time Series）</h2><p>时间序列是一系列具有相同指标和标签组合的数据点，按时间排序。</p><p>Prometheus会将所有采集到的指标数据以时间序列（time-series）的方式保存在内存数据库中，并且定时保存到硬盘上。</p><p>时间序列示例：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http_request_total&#123;host=&quot;www.voidking.com&quot;, method=&quot;GET&quot;, status=&quot;200&quot;&#125;@1434417560000 =&gt; 30</span><br><span class="line">http_request_total&#123;host=&quot;www.voidking.com&quot;, method=&quot;GET&quot;, status=&quot;200&quot;&#125;@1434417561000 =&gt; 34</span><br><span class="line">http_request_total&#123;host=&quot;www.voidking.com&quot;, method=&quot;GET&quot;, status=&quot;200&quot;&#125;@1434417562000 =&gt; 45</span><br></pre></td></tr></table></figure><p>我们可以将time-series理解为一个数字矩阵，X轴是时间戳，Y轴是指标。</p><h1 id="PromQL表达式"><span class="post-title-index">3.</span><a href="#PromQL表达式" class="headerlink" title="PromQL表达式"></a> PromQL表达式</h1><h2 id="基本选择器"><span class="post-title-index">3.1.</span><a href="#基本选择器" class="headerlink" title="基本选择器"></a> 基本选择器</h2><p>基本选择器用于从 Prometheus 中选择特定的时间序列数据。它通过指标名称和标签条件来过滤数据。<br>例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;method=&quot;GET&quot;, status=&quot;200&quot;&#125;</span><br></pre></td></tr></table></figure><p>这个表达式选择了当前时刻所有 HTTP GET 请求中状态码为 200 的时间序列，是瞬时数据（瞬时向量）。</p><p>Prometheus绘图时，只接受瞬时向量。</p><h2 id="操作符"><span class="post-title-index">3.2.</span><a href="#操作符" class="headerlink" title="操作符"></a> 操作符</h2><p>PromQL 支持多种操作符，用于在表达式中进行逻辑运算、比较和匹配。常见操作符有：</p><ul><li><code>==</code>：等于</li><li><code>!=</code>：不等于</li><li><code>=~</code>：正则表达式匹配</li><li><code>!~</code>：不匹配正则表达式</li><li><code>and</code>、<code>or</code>：逻辑与、逻辑或</li></ul><p>PromQL 中的所有正则表达式都使用<a target="_blank" rel="noopener" href="https://github.com/google/re2/wiki/Syntax">RE2语法</a>。</p><p>例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;method=~&quot;POST|PUT&quot;&#125; and status=&quot;500&quot;</span><br></pre></td></tr></table></figure><p>这个表达式选择了所有方法为 POST 或 PUT 且状态码为 500 的时间序列。</p><h2 id="时间范围选择"><span class="post-title-index">3.3.</span><a href="#时间范围选择" class="headerlink" title="时间范围选择"></a> 时间范围选择</h2><p>PromQL 允许我们选择特定时间范围内的数据，用于计算速率、增量等。例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total[5m]</span><br></pre></td></tr></table></figure><p>这个表达式选择了过去 5 分钟内的 HTTP 请求计数，是范围数据（范围向量）。</p><p>持续时间以数字指定，后面跟着单位。<br>单位标识：s - seconds，m - minutes，h - hours，d - days，w - weeks，y - years</p><h2 id="偏移量"><span class="post-title-index">3.4.</span><a href="#偏移量" class="headerlink" title="偏移量"></a> 偏移量</h2><p>偏移量允许更改查询中各个瞬时向量和范围向量的时间偏移。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total offset 5m</span><br><span class="line">sum(http_requests_total&#123;method=&quot;GET&quot;&#125; offset 5m) // GOOD.</span><br><span class="line">sum(http_requests_total&#123;method=&quot;GET&quot;&#125;) offset 5m // INVALID.</span><br><span class="line">rate(http_requests_total[5m] offset 1w)</span><br></pre></td></tr></table></figure><h2 id="聚合函数"><span class="post-title-index">3.5.</span><a href="#聚合函数" class="headerlink" title="聚合函数"></a> 聚合函数</h2><p>聚合函数用于对时间序列数据进行聚合计算，从而获得更高级别的洞察力。常见的聚合函数有：</p><ul><li><code>sum</code>：求和，所有指标名相同的指标求和</li><li><code>avg</code>：平均值，所有指标名相同的指标求平均值</li><li><code>min</code>：最小值，所有指标名相同的指标求最小值</li><li><code>max</code>：最大值，所有指标名相同的指标求最大指</li><li><code>count</code>：计数，计算指标名相同的指标的数量</li></ul><p>例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(http_requests_total) by (method)</span><br></pre></td></tr></table></figure><p>这个表达式按照 HTTP 请求方法对请求计数进行了求和。</p><p>使用 <code>by</code> 关键字，我们可以按照指定的标签对时间序列数据进行分组，从而进行聚合操作。</p><h2 id="向量操作和标量操作"><span class="post-title-index">3.6.</span><a href="#向量操作和标量操作" class="headerlink" title="向量操作和标量操作"></a> 向量操作和标量操作</h2><p>PromQL 支持对向量（time series vectors）和标量（scalar）之间进行操作。例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total + 100</span><br></pre></td></tr></table></figure><p>这个表达式将每个时间序列的值都增加了 100。</p><h2 id="函数调用"><span class="post-title-index">3.7.</span><a href="#函数调用" class="headerlink" title="函数调用"></a> 函数调用</h2><p>PromQL 提供了多种内置函数，用于执行各种操作，如计算速率、计算增量、应用分位数等。常见函数有：</p><ul><li><code>rate</code>：计算速率，根据指定的时间范围内的第一个数据点和最后一个数据点的值，计算它们之间的增加量，并将结果转化为每秒的速率，结果单位是数据单位 per second</li><li><code>increase</code>：计算增量，根据指定的时间范围内的第一个数据点和最后一个数据点的值，计算它们之间的增加量</li><li><code>histogram_quantile</code>：计算分位数，计算数据在不同区间的频率</li><li><code>irate</code>：计算速率，根据最后两个点的差值来计算增加量，并将结果转化为每秒的速率，结果单位是数据单位 per second。此时的数据范围不是用来计算的，而是用来限制向前找点的时间范围的，时间范围内没有点，这个点的计算就放弃了。</li></ul><p>例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rate(http_requests_total[1h])</span><br></pre></td></tr></table></figure><p>这个表达式计算了过去 1 小时内 HTTP 请求计数的速率。<br>函数通常需要接受一个或多个参数，参数可以是指标、标量、向量等。上例中的<code>http_requests_total[1h]</code>就是参数。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">increase(http_requests_total[5m])</span><br></pre></td></tr></table></figure><p>这个表达式计算了过去 5 分钟内 HTTP 请求的增量。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">histogram_quantile(0.95, http_request_duration_seconds_bucket)</span><br></pre></td></tr></table></figure><p>这个表达式计算了 HTTP 请求持续时间的分布中的 95 分位数值，即在所有持续时间中，95% 的请求的持续时间小于等于这个值。</p><h2 id="注释"><span class="post-title-index">3.8.</span><a href="#注释" class="headerlink" title="注释"></a> 注释</h2><p>在 PromQL 中，我们可以使用 <code>#</code> 来添加注释，以提高查询的可读性。例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Calculate the error rate of HTTP requests</span><br><span class="line">rate(http_requests_total&#123;status=~&quot;5..&quot;&#125;[1h])</span><br></pre></td></tr></table></figure><p>这个表达式计算了过去 1 小时内 HTTP 请求状态码以 “5” 开头（表示服务器错误）的时间序列的速率。</p><h2 id="子查询"><span class="post-title-index">3.9.</span><a href="#子查询" class="headerlink" title="子查询"></a> 子查询</h2><p>子查询对给定的范围进行即时查询。子查询的结果是范围向量。<br>语法：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;instant_query&gt; &#x27;[&#x27; &lt;range&gt; &#x27;:&#x27; [&lt;resolution&gt;] &#x27;]&#x27; [ offset &lt;duration&gt; ]</span><br></pre></td></tr></table></figure><p>resolution是可选的。默认值为全局评估间隔。</p><h1 id="例子"><span class="post-title-index">4.</span><a href="#例子" class="headerlink" title="例子"></a> 例子</h1><h2 id="简单时间序列查询"><span class="post-title-index">4.1.</span><a href="#简单时间序列查询" class="headerlink" title="简单时间序列查询"></a> 简单时间序列查询</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total</span><br><span class="line">&#123;__name__=&quot;http_requests_total&quot;&#125;</span><br><span class="line">http_requests_total&#123;job=&quot;apiserver&quot;, handler=&quot;/api/comments&quot;&#125;</span><br><span class="line">http_requests_total&#123;job=&quot;apiserver&quot;, handler=&quot;/api/comments&quot;&#125;[5m]</span><br><span class="line">http_requests_total&#123;job=~&quot;.*server&quot;&#125;</span><br><span class="line">http_requests_total&#123;status!~&quot;4..&quot;&#125;</span><br></pre></td></tr></table></figure><h2 id="子查询-1"><span class="post-title-index">4.2.</span><a href="#子查询-1" class="headerlink" title="子查询"></a> 子查询</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rate(http_requests_total[5m])[30m:1m]</span><br><span class="line">max_over_time(deriv(rate(distance_covered_total[5s])[30s:5s])[10m:])</span><br></pre></td></tr></table></figure><h2 id="函数运算等"><span class="post-title-index">4.3.</span><a href="#函数运算等" class="headerlink" title="函数运算等"></a> 函数运算等</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">rate(http_requests_total[5m])</span><br><span class="line"></span><br><span class="line">sum by (job) (</span><br><span class="line">  rate(http_requests_total[5m])</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">(instance_memory_limit_bytes - instance_memory_usage_bytes) / 1024 / 1024</span><br><span class="line"></span><br><span class="line">sum by (app, proc) (</span><br><span class="line">  instance_memory_limit_bytes - instance_memory_usage_bytes</span><br><span class="line">) / 1024 / 1024</span><br><span class="line"></span><br><span class="line">topk(3, sum by (app, proc) (rate(instance_cpu_time_ns[5m])))</span><br><span class="line"></span><br><span class="line">count by (app) (instance_cpu_time_ns)</span><br></pre></td></tr></table></figure></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 好好学习的郝</li><li class="post-copyright-link"> <strong>原文链接：</strong> <a href="https://www.voidking.com/dev-prometheus-query-language-promql/" title="Prometheus查询语言：PromQL">https://www.voidking.com/dev-prometheus-query-language-promql/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本文采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议，转载请注明出处！源站会即时更新知识点并修正错误，欢迎访问~</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/prometheus/" rel="tag"># prometheus</a> <a href="/tags/promql/" rel="tag"># promql</a> <a href="/tags/%E7%9B%91%E6%8E%A7/" rel="tag"># 监控</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-httpload/" rel="prev" title="httpload使用说明"><i class="fa fa-chevron-left"></i> httpload使用说明</a></div><div class="post-nav-item"> <a href="/dev-kube-controller-manager-metrics/" rel="next" title="kube-controller-manager指标收集">kube-controller-manager指标收集<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="footer-ads" style="margin-top:10px"><ins class="adsbygoogle" style="display:block" data-ad-format="autorelaxed" data-ad-client="ca-pub-3284447971731414" data-ad-slot="9697986181"></ins><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3284447971731414" crossorigin="anonymous"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div class="comments" id="gitalk-container"></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#PromQL%E7%AE%80%E4%BB%8B"><span class="nav-text">1. PromQL简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-text">2. 基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%87%E6%A0%87%EF%BC%88Metric%EF%BC%89"><span class="nav-text">2.1. 指标（Metric）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%EF%BC%88Time-Series%EF%BC%89"><span class="nav-text">2.2. 时间序列（Time Series）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PromQL%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">3. PromQL表达式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E9%80%89%E6%8B%A9%E5%99%A8"><span class="nav-text">3.1. 基本选择器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="nav-text">3.2. 操作符</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E8%8C%83%E5%9B%B4%E9%80%89%E6%8B%A9"><span class="nav-text">3.3. 时间范围选择</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%81%8F%E7%A7%BB%E9%87%8F"><span class="nav-text">3.4. 偏移量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0"><span class="nav-text">3.5. 聚合函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%91%E9%87%8F%E6%93%8D%E4%BD%9C%E5%92%8C%E6%A0%87%E9%87%8F%E6%93%8D%E4%BD%9C"><span class="nav-text">3.6. 向量操作和标量操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8"><span class="nav-text">3.7. 函数调用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E9%87%8A"><span class="nav-text">3.8. 注释</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="nav-text">3.9. 子查询</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BE%8B%E5%AD%90"><span class="nav-text">4. 例子</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E6%9F%A5%E8%AF%A2"><span class="nav-text">4.1. 简单时间序列查询</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%90%E6%9F%A5%E8%AF%A2-1"><span class="nav-text">4.2. 子查询</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E8%BF%90%E7%AE%97%E7%AD%89"><span class="nav-text">4.3. 函数运算等</span></a></li></ol></li></ol></div></div><div class="sidecar-ads" style="margin-top:10px"><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">一个计算机技术爱好者与学习者</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">776</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">33</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">269</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2026</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="https://cdn.staticfile.net/gitalk/1.7.2/gitalk.min.css"><script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('https://cdn.staticfile.net/gitalk/1.7.2/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID: '5a238b8c32b1e4dd2156',
      clientSecret: 'bfb5d518626f6fdc7da0351d1e0cd37ab75c6361',
      repo: 'gitalk-comments',
      owner: 'voidking',
      admin: ['voidking'],
      id: 'c258d57917be78a000e92e55350ae682',
      title: 'Prometheus查询语言：PromQL',
      body: '欢迎留言，互相交流学习~',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script></body></html>