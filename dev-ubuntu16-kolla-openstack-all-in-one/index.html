<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1,cdn:{enable:!0,url:"//cdn.jsdelivr.net/gh/voidking/voidking.github.io/search.xml"}},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="前言完成了《Ubuntu16手动安装OpenStack——XXX》系列，看上去，我们已经总结出了一套不错的文档。遵照文档，理论上就能成功安装更多的机器。但是，设想是美好的，而在实际安装过程中，又出现很多莫名其妙的报错。有些错误可以解决，很好；有些错误解决不了，那么整个环境就废了，需要重装系统。而且，整个安装流程非常复杂，难以保证每一步都不出错。 于是，郝同学决定寻找更加通用、更加方便的方法。树添同"><meta property="og:type" content="article"><meta property="og:title" content="Ubuntu16使用Kolla安装OpenStack"><meta property="og:url" content="https://www.voidking.com/dev-ubuntu16-kolla-openstack-all-in-one/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="前言完成了《Ubuntu16手动安装OpenStack——XXX》系列，看上去，我们已经总结出了一套不错的文档。遵照文档，理论上就能成功安装更多的机器。但是，设想是美好的，而在实际安装过程中，又出现很多莫名其妙的报错。有些错误可以解决，很好；有些错误解决不了，那么整个环境就废了，需要重装系统。而且，整个安装流程非常复杂，难以保证每一步都不出错。 于是，郝同学决定寻找更加通用、更加方便的方法。树添同"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-kolla-openstack-all-in-one/dockerinfo.jpg?imageView2/0/w/650"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-kolla-openstack-all-in-one/globals.jpg?imageView2/0/w/650"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-kolla-openstack-all-in-one/error.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-kolla-openstack-all-in-one/images.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-kolla-openstack-all-in-one/compute.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-kolla-openstack-all-in-one/init.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-kolla-openstack-all-in-one/curl.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/ubuntu16-kolla-openstack-all-in-one/dashboard.jpg?imageView2/0/w/750"><meta property="article:published_time" content="2018-08-02T09:00:00.000Z"><meta property="article:modified_time" content="2018-08-02T09:00:00.000Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="docker"><meta property="article:tag" content="linux"><meta property="article:tag" content="ubuntu"><meta property="article:tag" content="openstack"><meta property="article:tag" content="ansible"><meta property="article:tag" content="kolla"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://cdn.voidking.com//imgs/ubuntu16-kolla-openstack-all-in-one/dockerinfo.jpg?imageView2/0/w/650"><link rel="canonical" href="https://www.voidking.com/dev-ubuntu16-kolla-openstack-all-in-one/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>Ubuntu16使用Kolla安装OpenStack | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">好好学习，天天向上！</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-ubuntu16-kolla-openstack-all-in-one/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="学而不思则罔，思而不学则殆！"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> Ubuntu16使用Kolla安装OpenStack</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-08-02 09:00:00" itemprop="dateCreated datePublished" datetime="2018-08-02T09:00:00+00:00">2018-08-02</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/" itemprop="url" rel="index"><span itemprop="name">engineering</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/devops/" itemprop="url" rel="index"><span itemprop="name">devops</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/openstack/" itemprop="url" rel="index"><span itemprop="name">openstack</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>完成了《Ubuntu16手动安装OpenStack——XXX》系列，看上去，我们已经总结出了一套不错的文档。遵照文档，理论上就能成功安装更多的机器。但是，设想是美好的，而在实际安装过程中，又出现很多莫名其妙的报错。有些错误可以解决，很好；有些错误解决不了，那么整个环境就废了，需要重装系统。而且，整个安装流程非常复杂，难以保证每一步都不出错。</p><p>于是，郝同学决定寻找更加通用、更加方便的方法。树添同学给出建议：能不能使用docker来进行部署？经过讨论和搜索资料，发现这条道路确实可行，而且有OpenStack官方文档。</p><p>本文，就来研究一下使用Kolla安装OpenStack Queens版本的方法，架构采用最简单的all-in-one。</p><span id="more"></span><h1 id="Kolla简介"><a href="#Kolla简介" class="headerlink" title="Kolla简介"></a>Kolla简介</h1><p>Kolla是OpenStack社区“Big Tent”开发模式下的项目，该项目由思科于2014年9月提出。Kolla的优势和使用场景体现在如下几个方面：</p><ul><li>原子性升级或者回退OpenStack部署。</li><li>基于组件升级OpenStack。</li><li>基于组件回退OpenStack。</li></ul><p>Kolla为OpenStack的部署提供了有效、快捷、方便、易于维护、方便版本更新与回退的方案。</p><p>具体而言，Kolla的最终目标是为OpenStack的每一个服务都创建一个对应的Docker镜像，通过Docker镜像将升级的粒度减小到服务级别，从而在升级时对OpenStack的影响降到最小，并且一旦升级失败，也很容易回滚。升级只需要三步：拉取新版本的容器镜像，停止老版本的容器服务，启动新版本的容器。回滚也不需要重新安装包，直接启动老版本的容器服务就行，非常方便。</p><p>Kolla可以使用Ansible、Kubernetes或者Mesos来部署OpenStack环境，Kolla负责容器化OpenStack各个服务；后者则负责部署这些容器，搭建出一个可用的OpenStack环境。来实现基于Docker容器的OpenStack服务全生命周期管理，如安装、升级、回滚、迁移等。在部署Docker容器时，默认的网络配置都是Host模式。因为Kolla的Docker镜像粒度很小，它针对每个OpenStack服务都有特定的镜像，所以我们也可以通过Docker命令来操作某个具体的OpenStack服务。</p><p>Kolla项目及其相关的其他项目如下：</p><ul><li>Kolla项目，负责docker build OpenStack每个服务，如nova-compute容器等；</li><li>Kolla-Ansible项目，使用Ansible部署这些容器，搭建OpenStack环境；</li><li>Kolla-Kubernetes项目，使用Kubernetes部署这些容器，搭建OpenStack环境；</li><li>Kolla-Mesos项目，使用Mesos部署这些容器，搭建OpenStack环境。</li></ul><p>上述Kolla简介摘自<a target="_blank" rel="noopener" href="http://dockone.io/article/2476">微信分享DockOne微信分享（一二八）：容器化部署OpenStack的正确姿势</a>。</p><h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>VirtualBox虚拟机一台，系统为ubuntu-16.04.4-server-amd64，4核8G内存40G存储，主机名为controller，eth0的IP为192.168.56.110，eth1为nat上网网卡，eth2为neutron服务提供网络。</p><h1 id="网络设置"><a href="#网络设置" class="headerlink" title="网络设置"></a>网络设置</h1><p>1、切换到root用户<br><code>sudo -i</code></p><p>2、<code>vim /etc/network/interfaces</code>，设置网卡为：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This file describes the network interfaces available on your system</span></span><br><span class="line"><span class="comment"># and how to activate them. For more information, see interfaces(5).</span></span><br><span class="line"></span><br><span class="line">source <span class="regexp">/etc/</span>network<span class="regexp">/interfaces.d/</span>*</span><br><span class="line"></span><br><span class="line"><span class="comment"># The loopback network interface</span></span><br><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line"></span><br><span class="line"><span class="comment"># The primary network interface</span></span><br><span class="line">auto eth0</span><br><span class="line">iface eth0 inet static</span><br><span class="line">address <span class="number">192.168</span>.<span class="number">56.110</span></span><br><span class="line">netmask <span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line"></span><br><span class="line">auto eth1</span><br><span class="line">iface eth1 inet dhcp</span><br><span class="line"></span><br><span class="line">auto eth2</span><br><span class="line">iface eth2 inet manual</span><br><span class="line">up ifconfig <span class="variable">$IFACE</span> <span class="number">0.0</span>.<span class="number">0.0</span> up</span><br><span class="line">up ifconfig <span class="variable">$IFACE</span> promisc</span><br></pre></td></tr></table></figure><p>3、启用网卡<br><code>ifup eth2</code></p><h1 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h1><p>主要参考<a target="_blank" rel="noopener" href="https://elatov.github.io/2018/01/openstack-ansible-and-kolla-on-ubuntu-1604/">OpenStack, Ansible, and Kolla on Ubuntu 16.04</a>、<a target="_blank" rel="noopener" href="https://www.lijiawang.org/posts/kolla%20queens%20on%20centos7.41.html">kolla queens on centos7.4</a>和<a target="_blank" rel="noopener" href="https://docs.openstack.org/kolla-ansible/latest/">Kolla-Ansible’s documentation!</a>。</p><h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><p>1、安装并升级pip</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-<span class="keyword">get</span> <span class="keyword">update</span></span><br><span class="line">apt-<span class="keyword">get</span> install python-pip</span><br><span class="line">pip install <span class="comment">--upgrade pip</span></span><br></pre></td></tr></table></figure><p>2、安装依赖<br><code>apt-get -y install python-dev libffi-dev gcc libssl-dev python-selinux</code></p><p>3、安装ansible<br><code>apt-get -y install ansible</code></p><p>4、<code>vim /etc/ansible/ansible.cfg</code>，添加如下：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">line 10, <span class="built_in">add</span></span><br><span class="line">[defaults]</span><br><span class="line"><span class="attribute">host_key_checking</span>=<span class="literal">False</span></span><br><span class="line"><span class="attribute">pipelining</span>=<span class="literal">True</span></span><br><span class="line"><span class="attribute">forks</span>=100</span><br></pre></td></tr></table></figure><h2 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h2><p>1、安装docker<br><code>curl -SSL https://get.docker.io | bash</code></p><p>2、为docker和kolla创建配置文件</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span>docker.service.d</span><br><span class="line">vim <span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span>docker.service.d/kolla.conf</span><br></pre></td></tr></table></figure><p>修改为：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">MountFlags</span>=shared</span><br></pre></td></tr></table></figure><p>3、重启docker</p><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">system</span>ctl daemon-reload</span><br><span class="line"><span class="params">system</span>ctl restart docker</span><br></pre></td></tr></table></figure><p>4、查看docker信息<br><code>docker info</code><br>报错：</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker: Cannot connect <span class="built_in">to</span> <span class="keyword">the</span> Docker daemon. Is <span class="keyword">the</span> docker daemon running <span class="keyword">on</span> <span class="title">this</span> <span class="title">host</span>?.</span><br></pre></td></tr></table></figure><p>5、重启docker<br><code>systemctl restart docker</code><br>报错：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Failed <span class="keyword">to</span> <span class="keyword">restart</span> docker.service: Unit docker.service <span class="keyword">is</span> <span class="keyword">not</span> loaded properly: Invalid argument.</span><br><span class="line">See <span class="keyword">system</span> logs <span class="keyword">and</span> <span class="string">&#x27;systemctl status docker.service&#x27;</span> <span class="keyword">for</span> details.</span><br></pre></td></tr></table></figure><p>6、手动启动docker<br><code>/usr/bin/dockerd</code><br>报错：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">INFO</span>[0000] libcontainerd: new containerd process, pid: 7629 </span><br><span class="line">WARN[0000] containerd: low RLIMIT_NOFILE changing <span class="keyword">to</span> max  <span class="attribute">current</span>=1024 <span class="attribute">max</span>=1048576</span><br><span class="line">FATA[0001] <span class="built_in">Error</span> starting daemon: <span class="built_in">error</span> initializing graphdriver: <span class="string">&quot;/var/lib/docker&quot;</span> contains several valid graphdrivers: aufs, overlay2; Please cleanup <span class="keyword">or</span> explicitly choose storage driver (-s &lt;DRIVER&gt;)</span><br></pre></td></tr></table></figure><p>7、查看docker的aufs挂载情况并取消挂载</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="regexp">/proc/m</span>ounts | <span class="keyword">grep</span> <span class="string">&quot;docker&quot;</span></span><br><span class="line">umount <span class="regexp">/var/</span>lib<span class="regexp">/docker/</span>aufs</span><br></pre></td></tr></table></figure><p>8、删除/var/lib/docker/目录下的文件并重启docker</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -rf <span class="regexp">/var/</span>lib<span class="regexp">/docker/</span>*</span><br><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure><p>9、再次查看docker信息<br><code>docker info</code><br><img src="http://cdn.voidking.com//imgs/ubuntu16-kolla-openstack-all-in-one/dockerinfo.jpg?imageView2/0/w/650"></p><h2 id="加速镜像拉取"><a href="#加速镜像拉取" class="headerlink" title="加速镜像拉取"></a>加速镜像拉取</h2><p>参考<a href="https://www.voidking.com/dev-docker-start/">Docker入门</a>中的镜像加速器一节。</p><h2 id="安装Kolla-ansible"><a href="#安装Kolla-ansible" class="headerlink" title="安装Kolla-ansible"></a>安装Kolla-ansible</h2><p>1、安装kolla-ansible<br><code>pip install kolla-ansible</code></p><p>报错：ImportError: cannot import name main，参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/accumulate_zhang/article/details/80269313">升级pip后出现ImportError: cannot import name main</a>，编辑/usr/bin/pip文件，如下修改：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># line 9, change</span></span><br><span class="line">from pip import __main__</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    sys.<span class="keyword">exit</span>(__main__._main())</span><br></pre></td></tr></table></figure><p>报红：oslo-config 6.4.0 has requirement PyYAML&gt;=3.12, but you’ll have pyyaml 3.11 which is incompatible.忽略。</p><p>2、拷贝globals.yml和passwords.yml到/etc/kolla目录<br><code>cp -r /usr/local/share/kolla-ansible/etc_examples/kolla /etc/</code></p><p>3、拷贝all-in-one和multinode清单文件到当前目录<br><code>cp /usr/local/share/kolla-ansible/ansible/inventory/* .</code></p><p>4、生成kolla密码<br><code>kolla-genpwd</code><br>我们部署中使用的密码存储在/etc/kolla/passwords.yml文件中。此文件中的所有密码都是空白的，必须手动填写或运行随机密码生成器。</p><h2 id="配置globals-yml"><a href="#配置globals-yml" class="headerlink" title="配置globals.yml"></a>配置globals.yml</h2><p>1、查看globals.yml配置<br><code>grep -vE &#39;^$|^#&#39; /etc/kolla/globals.yml</code><br><img src="http://cdn.voidking.com//imgs/ubuntu16-kolla-openstack-all-in-one/globals.jpg?imageView2/0/w/650"></p><p>2、<code>vim /etc/kolla/globals.yml</code>，如下修改：</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># line 15,uncomment</span></span><br><span class="line"><span class="symbol">kolla_base_distro:</span> <span class="string">&quot;centos&quot;</span></span><br><span class="line"><span class="meta"># line 18,uncomment</span></span><br><span class="line"><span class="symbol">kolla_install_type:</span> <span class="string">&quot;binary&quot;</span></span><br><span class="line"><span class="meta"># line 21,uncomment and change</span></span><br><span class="line"><span class="symbol">openstack_release:</span> <span class="string">&quot;queens&quot;</span></span><br><span class="line"><span class="meta"># line 31,change</span></span><br><span class="line"><span class="symbol">kolla_internal_vip_address:</span> <span class="string">&quot;192.168.56.120&quot;</span></span><br><span class="line"><span class="meta"># line 85,uncomment and change</span></span><br><span class="line"><span class="symbol">network_interface:</span> <span class="string">&quot;eth0&quot;</span></span><br><span class="line"><span class="meta"># line 100,uncomment and change</span></span><br><span class="line"><span class="symbol">neutron_external_interface:</span> <span class="string">&quot;eth2&quot;</span></span><br><span class="line"><span class="meta"># line 331,uncomment</span></span><br><span class="line"><span class="symbol">designate_backend:</span> <span class="string">&quot;bind9&quot;</span></span><br><span class="line"><span class="symbol">designate_ns_record:</span> <span class="string">&quot;sample.openstack.org&quot;</span></span><br><span class="line"><span class="meta"># line 340,uncomment and change</span></span><br><span class="line"><span class="symbol">nova_compute_virt_type:</span> <span class="string">&quot;qemu&quot;</span></span><br><span class="line"><span class="meta"># other</span></span><br><span class="line"><span class="symbol">tempest_image_id:</span></span><br><span class="line"><span class="symbol">tempest_flavor_ref_id:</span></span><br><span class="line"><span class="symbol">tempest_public_network_id:</span></span><br><span class="line"><span class="symbol">tempest_floating_network_name:</span></span><br></pre></td></tr></table></figure><p>kolla_internal_vip_address为192.168.56.120，它是一个和OpenStack宿主机内网连接网络（eth0 192.168.56.110）同一个网段的未使用IP。network_interface为eth0，意思是openstack内部网络使用eth0网卡。neutron_external_interface为eth2，意思是openstack的虚拟机外部网络使用eth2网卡。因为是在虚拟机中安装openstack，所以nova_compute_virt_type设置为qemu。</p><h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><p>1、初始化<br><code>kolla-ansible -i ./all-in-one bootstrap-servers</code><br>报错：<br><img src="http://cdn.voidking.com//imgs/ubuntu16-kolla-openstack-all-in-one/error.jpg?imageView2/0/w/750"><br>查找资料，猜测是ansible版本问题。<br>（1）<code>ansible --version</code>，查看ansible版本为2.0.0.2，确实非常低。<br>（2）<code>apt install ansible</code>，提示已经是最新版本。<br>（3）更新apt库，然后重装ansible</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt-<span class="built_in">get</span> install software-properties-common</span><br><span class="line">apt-<span class="built_in">add</span>-repository <span class="keyword">pp</span><span class="variable">a:ansible</span>/ansible</span><br><span class="line">apt-<span class="built_in">get</span> <span class="keyword">update</span></span><br><span class="line">apt-<span class="built_in">get</span> install ansible</span><br></pre></td></tr></table></figure><p>然后，重新编辑/etc/ansible/ansible.cfg，再次执行初始化命令，问题解决。时间比较久，请耐心等待。</p><p>2、预检查<br><code>kolla-ansible -i ./all-in-one prechecks</code></p><p>3、拉取镜像<br><code>kolla-ansible -i ./all-in-one pull</code><br>这一步的时间特别久，挺耐心等待。如果拉取失败，就多尝试几次。</p><p>4、查看镜像<br><code>docker images</code><br><img src="http://cdn.voidking.com//imgs/ubuntu16-kolla-openstack-all-in-one/images.jpg?imageView2/0/w/750"></p><p>5、部署<br><code>kolla-ansible -i ./all-in-one deploy</code></p><h1 id="测试使用openstack"><a href="#测试使用openstack" class="headerlink" title="测试使用openstack"></a>测试使用openstack</h1><p>1、安装openstack客户端<br><code>pip install python-openstackclient python-glanceclient python-neutronclient --ignore-installed</code></p><p>2、生成admin-openrc.sh等<br><code>kolla-ansible post-deploy</code></p><p>3、使admin环境生效<br><code>source /etc/kolla/admin-openrc.sh</code></p><p>4、查看计算服务<br><code>openstack compute service list</code><br><img src="http://cdn.voidking.com//imgs/ubuntu16-kolla-openstack-all-in-one/compute.jpg?imageView2/0/w/750"></p><h1 id="初始化配置"><a href="#初始化配置" class="headerlink" title="初始化配置"></a>初始化配置</h1><p>1、执行init-runonce脚本<br><code>. /usr/local/share/kolla-ansible/init-runonce</code><br><img src="http://cdn.voidking.com//imgs/ubuntu16-kolla-openstack-all-in-one/init.jpg?imageView2/0/w/750"><br>执行初始化之前，可以参考<a target="_blank" rel="noopener" href="http://blog.51cto.com/yuweibing/1981189?cid=702783">openstack 之 Kolla部署指南</a>，设置一下外部网络。这样，就可以从路由器给虚拟机分配IP，安装完虚拟机就可以宿主机互相ping通。比如：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">EXT_NET_CIDR</span>=<span class="string">&#x27;192.168.56.0/24&#x27;</span></span><br><span class="line"><span class="attr">EXT_NET_RANGE</span>=<span class="string">&#x27;start=192.168.56.200,end=192.168.56.240&#x27;</span></span><br><span class="line"><span class="attr">EXT_NET_GATEWAY</span>=<span class="string">&#x27;192.168.56.1&#x27;</span></span><br></pre></td></tr></table></figure><p>这里配置的网络范围，对应globals.yml中配置的neutron_external_interface，也就是eth2网卡。</p><p>2、根据提示，创建实例</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">openstack <span class="keyword">server</span> <span class="keyword">create</span> \</span><br><span class="line"><span class="comment">--image cirros \</span></span><br><span class="line"><span class="comment">--flavor m1.tiny \</span></span><br><span class="line"><span class="comment">--key-name mykey \</span></span><br><span class="line"><span class="comment">--nic net-id=e52fe099-c798-4ffd-8c3c-06de424a9de7 \</span></span><br><span class="line">demo1</span><br></pre></td></tr></table></figure><p>3、访问horizon服务<br><code>curl 192.168.56.120 -L</code><br><img src="http://cdn.voidking.com//imgs/ubuntu16-kolla-openstack-all-in-one/curl.jpg?imageView2/0/w/750"></p><p>在浏览器访问 <a target="_blank" rel="noopener" href="http://192.168.56.120/">http://192.168.56.120</a> ，使用admin账号登录，密码在passwords.yml文件中查看。<br><code>less /etc/kolla/passwords.yml | grep keystone_admin_password</code><br><img src="http://cdn.voidking.com//imgs/ubuntu16-kolla-openstack-all-in-one/dashboard.jpg?imageView2/0/w/750"></p><h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>至此，使用kolla安装openstack成功。但是，我们还不知道实例能否正常使用。关于实例的访问和网络配置，放在下一篇文章中研究。</p><h1 id="书签"><a href="#书签" class="headerlink" title="书签"></a>书签</h1><p><a target="_blank" rel="noopener" href="https://docs.openstack.org/kolla/latest/">Kolla’s documentation!</a></p><p><a target="_blank" rel="noopener" href="https://www.imooc.com/article/31896">Kolla让OpenStack部署更贴心</a></p><p><a target="_blank" rel="noopener" href="http://www.chenshake.com/kolla-installation/">Kolla安装Ocata单节点</a></p><p><a target="_blank" rel="noopener" href="https://wenku.baidu.com/view/94fe6479ef06eff9aef8941ea76e58fafab045d7.html">kolla部署openstack ocata版</a></p><p><a target="_blank" rel="noopener" href="https://blog.inkubate.io/install-and-configure-openstack-ocata-with-kolla-as-a-standalone/">Install and configure OpenStack Ocata with Kolla as a standalone</a></p><p><a target="_blank" rel="noopener" href="http://edu.51cto.com/course/13250.html">Kolla OpenStack系统视频课程</a></p></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 好好学习的郝</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.voidking.com/dev-ubuntu16-kolla-openstack-all-in-one/" title="Ubuntu16使用Kolla安装OpenStack">https://www.voidking.com/dev-ubuntu16-kolla-openstack-all-in-one/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！源站会及时更新知识点及修正错误，阅读体验也更好。欢迎分享，欢迎收藏~</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/docker/" rel="tag"># docker</a> <a href="/tags/linux/" rel="tag"># linux</a> <a href="/tags/ubuntu/" rel="tag"># ubuntu</a> <a href="/tags/openstack/" rel="tag"># openstack</a> <a href="/tags/ansible/" rel="tag"># ansible</a> <a href="/tags/kolla/" rel="tag"># kolla</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-hexo-livere-comment-plugin/" rel="prev" title="Hexo使用livere作为评论插件"><i class="fa fa-chevron-left"></i> Hexo使用livere作为评论插件</a></div><div class="post-nav-item"> <a href="/dev-kolla-instance-network/" rel="next" title="Kolla配置实例网络">Kolla配置实例网络<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="footer-ads" style="margin-top:10px"><div class="_xduxciwe4ao"></div><script type="text/javascript">(window.slotbydup=window.slotbydup||[]).push({id:"u6920911",container:"_xduxciwe4ao",async:!0}),(window.slotbydup=window.slotbydup||[]).push({id:"u6920919",container:"_053ydasmd31h",async:!0})</script><script type="text/javascript" src="//cpro.baidustatic.com/cpro/ui/cm.js" async="async" defer="defer"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3284447971731414" crossorigin="anonymous"></script></div><div class="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zODU3Mi8xNTEwMA=="></div></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kolla%E7%AE%80%E4%BB%8B"><span class="nav-number">2.</span> <span class="nav-text">Kolla简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83"><span class="nav-number">3.</span> <span class="nav-text">环境</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E8%AE%BE%E7%BD%AE"><span class="nav-number">4.</span> <span class="nav-text">网络设置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="nav-number">5.</span> <span class="nav-text">安装配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="nav-number">5.1.</span> <span class="nav-text">安装依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85docker"><span class="nav-number">5.2.</span> <span class="nav-text">安装docker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E9%80%9F%E9%95%9C%E5%83%8F%E6%8B%89%E5%8F%96"><span class="nav-number">5.3.</span> <span class="nav-text">加速镜像拉取</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Kolla-ansible"><span class="nav-number">5.4.</span> <span class="nav-text">安装Kolla-ansible</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEglobals-yml"><span class="nav-number">5.5.</span> <span class="nav-text">配置globals.yml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2"><span class="nav-number">5.6.</span> <span class="nav-text">部署</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E4%BD%BF%E7%94%A8openstack"><span class="nav-number">6.</span> <span class="nav-text">测试使用openstack</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="nav-number">7.</span> <span class="nav-text">初始化配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%90%8E%E8%AE%B0"><span class="nav-number">8.</span> <span class="nav-text">后记</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B9%A6%E7%AD%BE"><span class="nav-number">9.</span> <span class="nav-text">书签</span></a></li></ol></div></div><div class="sidecar-ads" style="margin-top:10px"><div class="_053ydasmd31h"></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">学而不思则罔，思而不学则殆！</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">645</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">30</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">242</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={iconStyle:"box",boxForm:"horizontal",position:"bottomCenter",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={iconStyle:"box",boxForm:"horizontal",position:"topRight",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-float",flOptions)</script><script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  // window.livereOptions = {
  //   refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  // };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script></body></html>