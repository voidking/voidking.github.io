<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1,cdn:{enable:!0,url:"//qiniu-cdn.voidking.com/doc/search.xml"}},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="前言本文中，我们学习在CentOS7中安装配置DNS服务。DNS服务选择使用BIND，BIND（Berkeley Internet Name Domain）是一种开源的DNS服务器软件，可以安装在CentOS 7上。 参考文档：BIND官网"><meta property="og:type" content="article"><meta property="og:title" content="好好学Linux：CentOS7安装配置DNS服务"><meta property="og:url" content="https://www.voidking.com/dev-centos-dns-server/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="前言本文中，我们学习在CentOS7中安装配置DNS服务。DNS服务选择使用BIND，BIND（Berkeley Internet Name Domain）是一种开源的DNS服务器软件，可以安装在CentOS 7上。 参考文档：BIND官网"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2018-05-15T16:30:00.000Z"><meta property="article:modified_time" content="2024-10-26T08:00:00.000Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="linux"><meta property="article:tag" content="centos"><meta property="article:tag" content="好好学Linux"><meta property="article:tag" content="网络"><meta property="article:tag" content="问题排查"><meta property="article:tag" content="dns"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.voidking.com/dev-centos-dns-server/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>好好学Linux：CentOS7安装配置DNS服务 | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">一个计算机技术爱好者与学习者</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-centos-dns-server/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="一个计算机技术爱好者与学习者"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> 好好学Linux：CentOS7安装配置DNS服务</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-05-15 16:30:00" itemprop="dateCreated datePublished" datetime="2018-05-15T16:30:00+00:00">2018-05-15</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-10-26 08:00:00" itemprop="dateModified" datetime="2024-10-26T08:00:00+00:00">2024-10-26</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/" itemprop="url" rel="index"><span itemprop="name">engineering</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/devops/" itemprop="url" rel="index"><span itemprop="name">devops</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/network/" itemprop="url" rel="index"><span itemprop="name">network</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/troubleshooting/" itemprop="url" rel="index"><span itemprop="name">troubleshooting</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="前言"><span class="post-title-index">1.</span><a href="#前言" class="headerlink" title="前言"></a> 前言</h1><p>本文中，我们学习在CentOS7中安装配置DNS服务。<br>DNS服务选择使用BIND，BIND（Berkeley Internet Name Domain）是一种开源的DNS服务器软件，可以安装在CentOS 7上。</p><p>参考文档：<a target="_blank" rel="noopener" href="https://www.isc.org/bind/">BIND官网</a></p><span id="more"></span><h1 id="安装BIND"><span class="post-title-index">2.</span><a href="#安装BIND" class="headerlink" title="安装BIND"></a> 安装BIND</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y <span class="built_in">bind</span> bind-utils</span><br></pre></td></tr></table></figure><h1 id="配置BIND"><span class="post-title-index">3.</span><a href="#配置BIND" class="headerlink" title="配置BIND"></a> 配置BIND</h1><p>1、编辑bind配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/named.conf</span><br></pre></td></tr></table></figure><p>默认配置内容为：<a target="_blank" rel="noopener" href="https://github.com/voidking/hexo-storage/blob/main/centos7-dns-server/named.conf">named.conf</a></p><p>引用zone配置文件和反向数据文件：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">zone &quot;example.com&quot; &#123;</span><br><span class="line">    type master;</span><br><span class="line">    file &quot;/var/named/example.com.zone&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone &quot;1.168.192.in-addr.arpa&quot; &#123;</span><br><span class="line">    type master;</span><br><span class="line">    file &quot;/var/named/1.168.192.in-addr.arpa.zone&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>2、创建zone配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /var/named/example.com.zone</span><br></pre></td></tr></table></figure><p>内容为：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$TTL 86400</span><br><span class="line">@   IN  SOA     ns1.example.com. admin.example.com. (</span><br><span class="line">            2023101601 ; Serial</span><br><span class="line">            3600       ; Refresh</span><br><span class="line">            1800       ; Retry</span><br><span class="line">            604800     ; Expire</span><br><span class="line">            86400 )    ; Minimum TTL</span><br><span class="line"></span><br><span class="line">@   IN  NS  ns1.example.com.</span><br><span class="line">@   IN  NS  ns2.example.com.</span><br><span class="line"></span><br><span class="line">ns1 IN  A   192.168.1.10</span><br><span class="line">ns2 IN  A   192.168.1.11</span><br><span class="line">www IN  A   192.168.1.100</span><br></pre></td></tr></table></figure><p>其中 <code>@ IN SOA ns1.example.com. admin.example.com.</code> 是DNS区域文件（zone file）中的一行，它定义了域的”Start of Authority”（SOA）记录。</p><ul><li>@: 在这种上下文中，@ 代表当前域的根（例如，如果您定义的是example.com，那么@ 表示 example.com）。这是一种特殊的缩写，表示当前域。</li><li>IN: 表示资源记录的类别（Class），通常为“IN”（Internet）。</li><li>SOA: 这是资源记录类型，表示”Start of Authority”，它包含有关域的基本信息。</li><li><code>ns1.example.com.</code>: 这是主要名称服务器（Primary Name Server）的域名。它指定了此域的主要权威DNS服务器的域名。</li><li><code>admin.example.com.</code>: 这是负责管理此域的负责人的电子邮件地址。通常，电子邮件地址以<code>.</code>替换<code>@</code>。</li></ul><p>此行的示例告诉DNS服务器，在当前域（例如，example.com）中，主要的权威DNS服务器是 ns1.example.com ，同时负责人的电子邮件地址是<code>admin@example.com</code>。</p><p>SOA记录还包括其他信息，如序列号、刷新时间、重试时间、过期时间等，这些信息对于域名的管理和更新非常重要。</p><p>这是DNS区域文件的一部分，用于配置DNS服务器以提供有关域名的信息，以便其他计算机能够解析域名并找到与之相关的IP地址。</p><p>其中 <code>@ IN NS ns1.example.com.</code> 用于指定当前域的NS服务器的域名。</p><p>其中 <code>www IN A 192.168.1.100</code> 是一条解析，<a target="_blank" rel="noopener" href="http://www.example.com/">www.example.com</a> 域名解析到 <code>192.168.1.100</code>。</p><p>3、创建反向数据文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /var/named/1.168.192.in-addr.arpa.zone</span><br></pre></td></tr></table></figure><p>内容为：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$TTL 86400</span><br><span class="line">@   IN  SOA     ns1.example.com. admin.example.com. (</span><br><span class="line">            2023101601 ; Serial</span><br><span class="line">            3600       ; Refresh</span><br><span class="line">            1800       ; Retry</span><br><span class="line">            604800     ; Expire</span><br><span class="line">            86400 )    ; Minimum TTL</span><br><span class="line"></span><br><span class="line">@   IN  NS  ns1.example.com.</span><br><span class="line">@   IN  NS  ns2.example.com.</span><br><span class="line"></span><br><span class="line">10  IN  PTR ns1.example.com.</span><br><span class="line">11  IN  PTR ns2.example.com.</span><br><span class="line">100 IN  PTR www.example.com.</span><br></pre></td></tr></table></figure><p>其中 <code>100 IN PTR www.example.com.</code> 是一条反向解析，<code>192.168.1.100</code> 反向解析到 <a target="_blank" rel="noopener" href="http://www.example.com/">www.example.com</a> 。</p><h1 id="启动BIND"><span class="post-title-index">4.</span><a href="#启动BIND" class="headerlink" title="启动BIND"></a> 启动BIND</h1><p>1、启动BIND</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start named</span><br><span class="line">systemctl <span class="built_in">enable</span> named</span><br></pre></td></tr></table></figure><p>2、查看服务状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl status named</span><br><span class="line">netstat -nlp | grep 53</span><br></pre></td></tr></table></figure><p>3、配置防火墙（可选）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-service=dns --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure><h1 id="测试DNS服务器"><span class="post-title-index">5.</span><a href="#测试DNS服务器" class="headerlink" title="测试DNS服务器"></a> 测试DNS服务器</h1><p>1、正向解析测试</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nslookup www.example.com 127.0.0.1</span><br><span class="line">dig @127.0.0.1 -p 53 www.example.com </span><br></pre></td></tr></table></figure><p>正常的话，会看到解析结果为 192.168.1.100</p><p>2、反向解析测试</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nslookup 192.168.1.100 127.0.0.1</span><br><span class="line">dig @127.0.0.1 -p 53 -x 192.168.1.100</span><br></pre></td></tr></table></figure><p>正常的话，会看到反向解析结果为 <a target="_blank" rel="noopener" href="http://www.example.com/">www.example.com</a></p><h1 id="配置上游DNS服务器"><span class="post-title-index">6.</span><a href="#配置上游DNS服务器" class="headerlink" title="配置上游DNS服务器"></a> 配置上游DNS服务器</h1><p>自建的DNS服务器无法解析的查询请求，会进行递归查询。DNS具体解析流程，可以参考<a href="https://www.voidking.com/dev-dns-start/">《DNS入门篇<br>》</a>。<br>此时，我们可以配置指定的上游DNS服务器，从而减少自建DNS服务器的递归查询数量，提高性能。</p><p>具体配置方法为：</p><p>1、编辑named.conf</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/named.conf</span><br></pre></td></tr></table></figure><p>添加 forwarders 配置：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">    forwarders &#123; 180.76.76.76; 114.114.114.114; &#125;;</span><br><span class="line">    forward first;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>这里的 forwarders 指定了需要前向查询的DNS服务器，多个服务器之间用分号间隔。<br>forward first 的意思是首先尝试将请求转发给forwarders中的服务器，如果失败，那么才会尝试使用传统的DNS递归查询来解析。</p><p>2、重启named</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart named</span><br></pre></td></tr></table></figure><p>3、测试访问</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nslookup www.baidu.com 127.0.0.1</span><br><span class="line">nslookup www.google.com 127.0.0.1</span><br></pre></td></tr></table></figure><h1 id="配置使用DNS服务器"><span class="post-title-index">7.</span><a href="#配置使用DNS服务器" class="headerlink" title="配置使用DNS服务器"></a> 配置使用DNS服务器</h1><p>1、配置允许其他主机使用DNS服务器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/named.conf</span><br></pre></td></tr></table></figure><p>修改options部分的参数：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">    listen-on port 53 &#123; any; &#125;;</span><br><span class="line">    listen-on-v6 port 53 &#123; any; &#125;;</span><br><span class="line">    allow-query &#123; any; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>2、重启named</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart named</span><br></pre></td></tr></table></figure><p>3、其他主机配置使用DNS服务器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/resolv.conf</span><br></pre></td></tr></table></figure><p>假设DNS服务器的IP地址为 192.168.56.101 ，那么配置为：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nameserver 192.168.56.101</span><br></pre></td></tr></table></figure><h1 id="no-valid-DS-resolving-问题"><span class="post-title-index">8.</span><a href="#no-valid-DS-resolving-问题" class="headerlink" title="no valid DS resolving 问题"></a> no valid DS resolving 问题</h1><h2 id="问题描述"><span class="post-title-index">8.1.</span><a href="#问题描述" class="headerlink" title="问题描述"></a> 问题描述</h2><p>查看bind服务的日志：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/named/data</span><br><span class="line">grep <span class="string">&quot;xxx.oss-cn-hangzhou.aliyuncs.com&quot;</span> named.run</span><br></pre></td></tr></table></figure><p>发现很多错误的解析：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">no valid DS resolving &#x27;xxx.oss-cn-hangzhou.aliyuncs.com/A/IN&#x27;: 114.114.114.114#53</span><br><span class="line">no valid DS resolving &#x27;xxx.oss-cn-hangzhou.aliyuncs.com/A/IN&#x27;: 180.76.76.76#53</span><br><span class="line">network unreachable resolving &#x27;xxx.oss-cn-hangzhou.aliyuncs.com/A/IN&#x27;: 2001:503:d414::30#53</span><br><span class="line">network unreachable resolving &#x27;xxx.oss-cn-hangzhou.aliyuncs.com/A/IN&#x27;: 2001:502:8cc::30#53</span><br><span class="line">network unreachable resolving &#x27;xxx.oss-cn-hangzhou.aliyuncs.com/A/IN&#x27;: 2001:502:1ca1::30#53</span><br><span class="line">network unreachable resolving &#x27;xxx.oss-cn-hangzhou.aliyuncs.com/A/IN&#x27;: 2001:503:eea3::30#53</span><br><span class="line">network unreachable resolving &#x27;xxx.oss-cn-hangzhou.aliyuncs.com/A/IN&#x27;: 2001:501:b1f9::30#53</span><br><span class="line">network unreachable resolving &#x27;xxx.oss-cn-hangzhou.aliyuncs.com/A/IN&#x27;: 2001:503:83eb::30#53</span><br><span class="line">network unreachable resolving &#x27;xxx.oss-cn-hangzhou.aliyuncs.com/A/IN&#x27;: 2001:502:7094::30#53</span><br><span class="line">network unreachable resolving &#x27;xxx.oss-cn-hangzhou.aliyuncs.com/A/IN&#x27;: 2001:503:a83e::2:30#53</span><br><span class="line">network unreachable resolving &#x27;xxx.oss-cn-hangzhou.aliyuncs.com/A/IN&#x27;: 2001:500:d937::30#53</span><br><span class="line">network unreachable resolving &#x27;xxx.oss-cn-hangzhou.aliyuncs.com/A/IN&#x27;: 2001:503:d2d::30#53</span><br><span class="line">network unreachable resolving &#x27;xxx.oss-cn-hangzhou.aliyuncs.com/A/IN&#x27;: 2001:500:856e::30#53</span><br><span class="line">network unreachable resolving &#x27;xxx.oss-cn-hangzhou.aliyuncs.com/A/IN&#x27;: 2001:503:39c1::30#53</span><br><span class="line">network unreachable resolving &#x27;xxx.oss-cn-hangzhou.aliyuncs.com/A/IN&#x27;: 2001:503:231d::2:30#53</span><br><span class="line">network unreachable resolving &#x27;xxx.oss-cn-hangzhou.aliyuncs.com/A/IN&#x27;: 2401:b180:4100::12#53</span><br><span class="line">network unreachable resolving &#x27;xxx.oss-cn-hangzhou.aliyuncs.com/A/IN&#x27;: 2401:b180:4100::13#53</span><br><span class="line">network unreachable resolving &#x27;xxx.oss-cn-hangzhou.aliyuncs.com/A/IN&#x27;: 2401:b180:4100::11#53</span><br></pre></td></tr></table></figure><h2 id="解决办法"><span class="post-title-index">8.2.</span><a href="#解决办法" class="headerlink" title="解决办法"></a> 解决办法</h2><p>1、对于 no valid DS resolving ，需要关闭dnssec。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/named.conf</span><br></pre></td></tr></table></figure><p>修改：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">    dnssec-enable no;</span><br><span class="line">    dnssec-validation no;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、对于 network unreachable resolving ，需要关闭IPv6解析。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysconfig/named</span><br></pre></td></tr></table></figure><p>添加：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS=&quot;-4&quot;</span><br></pre></td></tr></table></figure><p>3、重启named</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart named</span><br></pre></td></tr></table></figure><h1 id="TCP-client-quota-reached-问题"><span class="post-title-index">9.</span><a href="#TCP-client-quota-reached-问题" class="headerlink" title="TCP client quota reached 问题"></a> TCP client quota reached 问题</h1><h2 id="问题描述-1"><span class="post-title-index">9.1.</span><a href="#问题描述-1" class="headerlink" title="问题描述"></a> 问题描述</h2><p>CoreDNS上游DNS配置了 named ，使用一段时候，发现大量报错：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] plugin/errors: 2 kong-db. SRV: read udp 100.119.197.225:38457-&gt;192.168.56.101:53: i/o timeout</span><br><span class="line">[ERROR] plugin/errors: 2 test.example.com. A: read udp 100.119.197.225:35334-&gt;192.168.56.101:53: i/o timeout</span><br></pre></td></tr></table></figure><p>查看 named 状态，发现正常运行，但是出现飘红日志：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Oct 26 14:29:49 named-host named[5564]: socket: file descriptor exceeds limit (21000/21000)</span><br><span class="line">Oct 26 14:29:57 named-host named[5564]: FORMERR resolving &#x27;smlopenapi.esign.cn/AAAA/IN&#x27;: 114.114.114.114#53</span><br></pre></td></tr></table></figure><h2 id="问题排查解决"><span class="post-title-index">9.2.</span><a href="#问题排查解决" class="headerlink" title="问题排查解决"></a> 问题排查解决</h2><p>1、测试解析</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup www.voidking.com 192.168.56.101</span><br></pre></td></tr></table></figure><p>发现可以正常解析，说明问题是偶发的。</p><p>2、重启named</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart named</span><br><span class="line">systemctl status named</span><br></pre></td></tr></table></figure><p>重启named，查看named状态，发现出现了明显的提示：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Oct 26 15:03:55 named-host named[5564]: client @0x7f2f7bb4b050 (no-peer): TCP client quota reached: quota reached</span><br><span class="line">Oct 26 15:03:55 named-host named[5564]: client @0x7f2f7bbcac90 (no-peer): TCP client quota reached: quota reached</span><br><span class="line">Oct 26 15:03:55 named-host named[5564]: client @0x7f2f7bc3eed0 (no-peer): TCP client quota reached: quota reached</span><br></pre></td></tr></table></figure><p>从日志可以看出，TCP client quota达到了阈值。</p><p>解决办法：调整 TCP client quota为一个更大值。参考文档<a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/264683">no more TCP clients: quota reached</a></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">  tcp-clients &lt;NUMBER_OF_MAX_CLIENT&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>更好的解决办法：使用adguardhome替换bind9。</p><h1 id="后记"><span class="post-title-index">10.</span><a href="#后记" class="headerlink" title="后记"></a> 后记</h1><p>如果想要配置多个顶级域名，那么在 named.conf 中添加多个 zone 即可。</p></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 好好学习的郝</li><li class="post-copyright-link"> <strong>原文链接：</strong> <a href="https://www.voidking.com/dev-centos-dns-server/" title="好好学Linux：CentOS7安装配置DNS服务">https://www.voidking.com/dev-centos-dns-server/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本文采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议，转载请注明出处！源站会即时更新知识点并修正错误，欢迎访问~</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/linux/" rel="tag"># linux</a> <a href="/tags/centos/" rel="tag"># centos</a> <a href="/tags/%E5%A5%BD%E5%A5%BD%E5%AD%A6Linux/" rel="tag"># 好好学Linux</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag"># 网络</a> <a href="/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/" rel="tag"># 问题排查</a> <a href="/tags/dns/" rel="tag"># dns</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-ubuntu-dns-server/" rel="prev" title="Ubuntu14.04安装配置DNS服务"><i class="fa fa-chevron-left"></i> Ubuntu14.04安装配置DNS服务</a></div><div class="post-nav-item"> <a href="/dev-pssh-manage-linux/" rel="next" title="使用PSSH批量管理Linux">使用PSSH批量管理Linux<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="footer-ads" style="margin-top:10px"></div><div class="comments" id="gitalk-container"></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">1. 前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85BIND"><span class="nav-text">2. 安装BIND</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEBIND"><span class="nav-text">3. 配置BIND</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8BIND"><span class="nav-text">4. 启动BIND</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95DNS%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-text">5. 测试DNS服务器</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%8A%E6%B8%B8DNS%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-text">6. 配置上游DNS服务器</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%BD%BF%E7%94%A8DNS%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-text">7. 配置使用DNS服务器</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#no-valid-DS-resolving-%E9%97%AE%E9%A2%98"><span class="nav-text">8. no valid DS resolving 问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><span class="nav-text">8.1. 问题描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95"><span class="nav-text">8.2. 解决办法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TCP-client-quota-reached-%E9%97%AE%E9%A2%98"><span class="nav-text">9. TCP client quota reached 问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0-1"><span class="nav-text">9.1. 问题描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E8%A7%A3%E5%86%B3"><span class="nav-text">9.2. 问题排查解决</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%90%8E%E8%AE%B0"><span class="nav-text">10. 后记</span></a></li></ol></div></div><div class="sidecar-ads" style="margin-top:10px"><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">一个计算机技术爱好者与学习者</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">779</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">34</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">271</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2026</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="https://cdn.staticfile.net/gitalk/1.7.2/gitalk.min.css"><script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('https://cdn.staticfile.net/gitalk/1.7.2/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID: '5a238b8c32b1e4dd2156',
      clientSecret: 'bfb5d518626f6fdc7da0351d1e0cd37ab75c6361',
      repo: 'gitalk-comments',
      owner: 'voidking',
      admin: ['voidking'],
      id: 'e824fa996d34d8f8cec35d9cab7ee65a',
      title: '好好学Linux：CentOS7安装配置DNS服务',
      body: '欢迎留言，互相交流学习~',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script></body></html>