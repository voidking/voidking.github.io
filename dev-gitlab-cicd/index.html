<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1,cdn:{enable:!0,url:"//qiniu-cdn.voidking.com/doc/search.xml"}},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="GitLab CI&#x2F;CD是啥？CI，CONTINUOUS INTEGRATION，持续集成。简单来说就是自动化构建和测试。一个应用程序的代码存储在Git仓库中。开发人员推送的每个更改，甚至是开发分支，都可以通过一组脚本来自动地构建和测试。这些测试可确保更改通过您为应用程序建立的所有测试、指南和代码合规性标准。 CD，CONTINUOUS DELIVERY，持续交付。简单来说就是自动化构建和测试+支"><meta property="og:type" content="article"><meta property="og:title" content="好好学GitLab：GitLab CI&#x2F;CD入门篇"><meta property="og:url" content="https://www.voidking.com/dev-gitlab-cicd/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="GitLab CI&#x2F;CD是啥？CI，CONTINUOUS INTEGRATION，持续集成。简单来说就是自动化构建和测试。一个应用程序的代码存储在Git仓库中。开发人员推送的每个更改，甚至是开发分支，都可以通过一组脚本来自动地构建和测试。这些测试可确保更改通过您为应用程序建立的所有测试、指南和代码合规性标准。 CD，CONTINUOUS DELIVERY，持续交付。简单来说就是自动化构建和测试+支"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2022-09-08T20:00:00.000Z"><meta property="article:modified_time" content="2024-05-04T08:00:00.000Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="git"><meta property="article:tag" content="cicd"><meta property="article:tag" content="gitlab"><meta property="article:tag" content="好好学GitLab"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.voidking.com/dev-gitlab-cicd/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>好好学GitLab：GitLab CI/CD入门篇 | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">一个计算机技术爱好者与学习者</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-gitlab-cicd/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="一个计算机技术爱好者与学习者"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> 好好学GitLab：GitLab CI/CD入门篇</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-09-08 20:00:00" itemprop="dateCreated datePublished" datetime="2022-09-08T20:00:00+00:00">2022-09-08</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-05-04 08:00:00" itemprop="dateModified" datetime="2024-05-04T08:00:00+00:00">2024-05-04</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/" itemprop="url" rel="index"><span itemprop="name">engineering</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/devops/" itemprop="url" rel="index"><span itemprop="name">devops</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/git/" itemprop="url" rel="index"><span itemprop="name">git</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="GitLab-CI-CD是啥？"><span class="post-title-index">1.</span><a href="#GitLab-CI-CD是啥？" class="headerlink" title="GitLab CI/CD是啥？"></a> GitLab CI/CD是啥？</h1><p>CI，CONTINUOUS INTEGRATION，持续集成。简单来说就是自动化构建和测试。<br>一个应用程序的代码存储在Git仓库中。开发人员推送的每个更改，甚至是开发分支，都可以通过一组脚本来自动地构建和测试。这些测试可确保更改通过您为应用程序建立的所有测试、指南和代码合规性标准。</p><p>CD，CONTINUOUS DELIVERY，持续交付。简单来说就是自动化构建和测试+支持手动触发部署。<br>每次将代码更改推送到代码库时，不仅会自动构建和测试应用程序，还支持一键部署应用程序，这里的部署需要手动触发。</p><p>CD，CONTINUOUS DEPLOYMENT，持续部署。简单来说就是自动化构建和测试+自动部署。<br>持续部署类似于持续交付，不同之处在于，不是手动触发部署应用程序，而是将其设置为自动部署。</p><p>而GitLab CI/CD，就是一种支持在GitLab中配置使用持续集成、持续交付和持续部署的工具。GitLab CI/CD通过使用YAML文件定义作业流程和流水线（pipelines），可实现复杂的应用程序的自动化构建和部署。</p><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/ci/">GitLab CI/CD Document</a></li><li><a target="_blank" rel="noopener" href="https://docs.gitlab.cn/jh/ci/">GitLab CI/CD 中文文档</a></li><li><a target="_blank" rel="noopener" href="https://docs.gitlab.cn/jh/ci/introduction/index.html">CI/CD 概念</a></li><li><a target="_blank" rel="noopener" href="http://www.ttlsa.com/news/ci-cd-cd/">详解CI、CD &amp; CD</a></li><li><a target="_blank" rel="noopener" href="https://linux.cn/article-9926-1.html">什么是 CI/CD？</a></li><li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Deployment_environment">Deployment environment</a></li></ul><span id="more"></span><h1 id="GitLab-CI-CD基本概念"><span class="post-title-index">2.</span><a href="#GitLab-CI-CD基本概念" class="headerlink" title="GitLab CI/CD基本概念"></a> GitLab CI/CD基本概念</h1><ul><li>pipeline：在每个仓库中，使用名为<code>.gitlab-ci.yml</code>的yaml文件配置gitlab ci/cd流水线（pipeline）</li><li>stage：一条流水线可以包含多个阶段（stage），一个阶段可以包含多个作业</li><li>job：作业（job）是具体要执行的任务，是命令脚本语句的集合</li><li>runner：runner是每个作业的执行节点；每个作业可以根据标签选择不同的执行节点</li></ul><h1 id="Gitlab-CI-CD工作机制"><span class="post-title-index">3.</span><a href="#Gitlab-CI-CD工作机制" class="headerlink" title="Gitlab CI/CD工作机制"></a> Gitlab CI/CD工作机制</h1><p>1、在gitlab仓库中的根目录下添加<code>.gitlab-ci.yml</code>文件，定义流水线</p><p>2、当仓库中发生commit、push、merge等事件时，根据<code>.gitlab-ci.yml</code>的定义触发流水线</p><p>3、流水线会调用gitlab runner，在gitlab runner中按照<code>.gitlab-ci.yml</code>的定义跑作业</p><h1 id="配置第一个流水线"><span class="post-title-index">4.</span><a href="#配置第一个流水线" class="headerlink" title="配置第一个流水线"></a> 配置第一个流水线</h1><h2 id="配置-gitlab-ci-yml"><span class="post-title-index">4.1.</span><a href="#配置-gitlab-ci-yml" class="headerlink" title="配置.gitlab-ci.yml"></a> 配置.gitlab-ci.yml</h2><p>为了配置GitLab CI/CD流水线，首先需要在项目根目录创建一个<code>.gitlab-ci.yml</code>文件，并定义需要执行的作业和阶段。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build_job:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Building the project...&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./build-script.sh</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test_job:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Running tests...&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./run-tests.sh</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy_job:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Deploying application...&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./deploy-script.sh</span></span><br></pre></td></tr></table></figure><p>这个简单的例子定义了三个作业，每个作业分别执行构建、测试和部署脚本。</p><h2 id="注册Runner"><span class="post-title-index">4.2.</span><a href="#注册Runner" class="headerlink" title="注册Runner"></a> 注册Runner</h2><p>为了让流水线工作，我们需要至少一个注册的Runner。可以使用GitLab提供的共享Runner，或者自己安装和注册一个专用的Runner。</p><p>注册Runner步骤如下：</p><p>1、在GitLab页面上，进入我们的项目设置。<br>2、寻找CI/CD设置，找到Runners部分。<br>3、我们会看到用于注册Runner的URL和Token。<br>4、在具有网络访问权限的机器上安装Runner并运行注册命令，使用提供的URL和Token。</p><p>更多Runner相关内容，参考文档<a href="https://www.voidking.com/dev-gitlab-runner-start/">《好好学GitLab：GitLab Runner入门篇》</a></p><h1 id="流水线典型示例"><span class="post-title-index">5.</span><a href="#流水线典型示例" class="headerlink" title="流水线典型示例"></a> 流水线典型示例</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stages:</span> <span class="comment">#对stages的编排</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">DEPLOY_ENV:</span> <span class="string">&quot;dev&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ciinit:</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">.pre</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Pipeline init first job&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ciend:</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">.post</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Pipeline end job&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">before_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Before script section&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;For example you might run an update here or install a build dependency&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Or perhaps you might print out some debugging details&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">after_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;After script section&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;For example you might do some cleanup here&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">k8s</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Do your build here&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test1:</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">k8s</span>  </span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Do a test here&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;For example run a test suite&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test2:</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">k8s</span>  </span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Do a test here&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;For example run a test suite&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">k8s</span>  </span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">DEPLOY_ENV:</span> <span class="string">&quot;test&quot;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;$&#123;DEPLOY_ENV&#125;&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Do your deploy here&quot;</span></span><br></pre></td></tr></table></figure><h1 id="流水线语法"><span class="post-title-index">6.</span><a href="#流水线语法" class="headerlink" title="流水线语法"></a> 流水线语法</h1><h2 id="流水线语法概述"><span class="post-title-index">6.1.</span><a href="#流水线语法概述" class="headerlink" title="流水线语法概述"></a> 流水线语法概述</h2><p>GitLab CI/CD流水线是由 .gitlab-ci.yml 文件中定义的一系列规则和指令组成。这个文件使用YAML语法来描述CI/CD的过程。</p><p>GitLab CI/CD 流水线配置包括：</p><ul><li>配置流水线行为的全局关键字</li><li>配置作业行为作业关键字</li></ul><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://docs.gitlab.cn/jh/ci/yaml/">.gitlab-ci.yml 关键字参考</a></li><li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/ci/yaml/gitlab_ci_yaml.html">The .gitlab-ci.yml file</a></li><li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/ci/yaml/">.gitlab-ci.yml keyword reference</a></li><li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/510820543">GitLabCI-CD流水线语法</a></li></ul><h2 id="全局关键字"><span class="post-title-index">6.2.</span><a href="#全局关键字" class="headerlink" title="全局关键字"></a> 全局关键字</h2><ul><li>default 作业关键字的自定义默认值。</li><li>stages 流水线阶段的名称和顺序。</li><li>workflow 控制运行的流水线类型。</li><li>include 从其他 YAML 文件导入配置。</li></ul><h2 id="作业关键字"><span class="post-title-index">6.3.</span><a href="#作业关键字" class="headerlink" title="作业关键字"></a> 作业关键字</h2><h3 id="执行命令"><span class="post-title-index">6.3.1.</span><a href="#执行命令" class="headerlink" title="执行命令"></a> 执行命令</h3><ul><li>before_script：作业在运行前执行的Shell命令行</li><li>script：作业在运行中执行的Shell命令行，每个作业至少要包含一个script</li><li>after_script：作业在运行后执行的Shell命令行</li></ul><p>有了before_script、script、和after_script，可以方便我们把通用的脚本抽象出来。</p><ul><li>before_script：有命令执行结果非0，job判定失败，不再执行before_script的后续命令，跳过script，继续执行after_script</li><li>script：有命令执行结果为0，job判定失败，不再执行script的后续命令，继续执行after_script</li><li>after_script：有命令执行结果非0，job判定不受影响，不再执行after_script后续命令</li></ul><h3 id="环境变量"><span class="post-title-index">6.3.2.</span><a href="#环境变量" class="headerlink" title="环境变量"></a> 环境变量</h3><ul><li>variables：在作业级别定义作业变量。</li><li>environment：作业部署到的环境的名称。</li><li>secrets：作业所需的 CI/CD secret 信息。secret属于enviroment。</li></ul><h3 id="作业条件"><span class="post-title-index">6.3.3.</span><a href="#作业条件" class="headerlink" title="作业条件"></a> 作业条件</h3><ul><li>stage：定义作业阶段，指定当前作业所属的阶段名称，从而确定作业顺序</li><li>only：满足条件时执行作业</li><li>except：满足条件时不执行作业</li><li>rules：12.3之后引入的特性，不能与only/except混用，具体用法参考【jobs:rules作业控制】一节</li><li>when：何时运行作业。</li><li>needs：在 stage 顺序之前执行的作业。</li><li>tags：根据标签选择运行作业的Runner节点，如果有多个标签，则匹配具有所有标签的Runner节点</li><li>image：指定执行作业的脚本时应该启动哪个 Docker 镜像作为执行环境，成为主容器。这个 Docker 镜像应包含所有必要的依赖和工具，以便能够运行定义在 script 部分的命令。需要Runner支持Docker。</li><li>services：指定与主容器相连的额外容器服务。这些服务可以是数据库、缓存等。</li><li>allow_failure：允许作业失败。失败的作业不会导致流水线失败。</li><li>parallel：应该并行运行多少个作业实例。</li><li>resource_group：限制作业并发。</li><li>trigger：定义下游流水线触发器。</li></ul><h3 id="超时与重试"><span class="post-title-index">6.3.4.</span><a href="#超时与重试" class="headerlink" title="超时与重试"></a> 超时与重试</h3><ul><li>retry：在失败的情况下可以自动重试作业的时间和次数。</li><li>timeout：定义优先于项目范围设置的自定义作业级别超时。</li></ul><h3 id="继承"><span class="post-title-index">6.3.5.</span><a href="#继承" class="headerlink" title="继承"></a> 继承</h3><ul><li>extends：此作业继承自的配置条目。</li><li>inherit：选择所有作业继承的全局默认值。</li></ul><h3 id="其他"><span class="post-title-index">6.3.6.</span><a href="#其他" class="headerlink" title="其他"></a> 其他</h3><ul><li>artifacts：成功时附加到作业的文件和目录列表。</li><li>cache：应在后续运行之间缓存的文件列表。</li><li>coverage：给定作业的代码覆盖率设置。</li><li>dast_configuration：在作业级别使用来自 DAST 配置文件的配置。</li><li>dependencies：通过提供要从中获取产物的作业列表，来限制将哪些产物传递给特定作业。</li><li>interruptible：定义当新运行使作业变得多余时，是否可以取消作业。</li><li>pages：上传作业的结果，与 GitLab Pages 一起使用。</li><li>release：指示运行器生成 release 对象。</li></ul><h1 id="流水线部分关键字详解"><span class="post-title-index">7.</span><a href="#流水线部分关键字详解" class="headerlink" title="流水线部分关键字详解"></a> 流水线部分关键字详解</h1><h2 id="variables环境变量"><span class="post-title-index">7.1.</span><a href="#variables环境变量" class="headerlink" title="variables环境变量"></a> variables环境变量</h2><p>环境变量可以分为两类：全局变量和局部变量，局部变量优先级高于全局变量</p><ul><li>全局变量是整个流水线生效的，局部变量是仅在作业中生效的</li><li>全局变量可以使用CI自带的预定义变量，也可以自定义变量</li><li>全局变量定义在全局 variables 中，也可以定义在 workflow:rules:variables 中</li><li>局部变量定义在 job:variables 中，也可以定义在 job:rules:variables 中</li></ul><p>.gitlab-ci.yml解析顺序为：全局变量 -&gt; workflow规则 -&gt; job规则<br>因此优先级顺序为：job中变量优先级 &gt; workflow中变量优先级 &gt; 全局变量优先级</p><p>常用全局预定义变量：</p><table><thead><tr><th align="left">变量名称</th><th align="center">GitLab</th><th align="center">GitLab Runner</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">CI</td><td align="center">all</td><td align="center">0.4</td><td align="left">对CI/CD中的所有作业可见，值为true</td></tr><tr><td align="left">CI_BUILDS_DIR</td><td align="center">all</td><td align="center">11.10</td><td align="left">构建时的最顶层目录</td></tr><tr><td align="left">CI_COMMIT_AUTHOR</td><td align="center">13.11</td><td align="center">all</td><td align="left">提交的作者，格式为：名称&lt;邮箱&gt;</td></tr><tr><td align="left">CI_COMMIT_BEFORE_SHA</td><td align="center">11.2</td><td align="center">all</td><td align="left">当前分支的上一个提交哈希值</td></tr><tr><td align="left">CI_COMMIT_BRANCH</td><td align="center">12.6</td><td align="center">0.5</td><td align="left">提交的分支名，在合并流水线和tag流水线时不可见</td></tr><tr><td align="left">CI_COMMIT_DESCRIPTION</td><td align="center">10.8</td><td align="center">all</td><td align="left">提交的描述</td></tr><tr><td align="left">CI_COMMIT_MESSAGE</td><td align="center">10.8</td><td align="center">all</td><td align="left">完整的提交信息</td></tr><tr><td align="left">CI_COMMIT_REF_NAME</td><td align="center">9.0</td><td align="center">all</td><td align="left">项目的分支名或tag名</td></tr><tr><td align="left">CI_COMMIT_REF_PROTECTED</td><td align="center">11.11</td><td align="center">all</td><td align="left">如果作业正在构建的是被保护的分支或tag，值为true</td></tr><tr><td align="left">CI_COMMIT_REF_SLUG</td><td align="center">9.0</td><td align="center">all</td><td align="left">CI_COMMIT_REF_NAME的小写形式。</td></tr><tr><td align="left">CI_COMMIT_SHA</td><td align="center">9.0</td><td align="center">all</td><td align="left">提交的完整哈希值</td></tr><tr><td align="left">CI_COMMIT_SHORT_SHA</td><td align="center">11.7</td><td align="center">all</td><td align="left">8个字符的提交哈希值</td></tr><tr><td align="left">CI_COMMIT_TAG</td><td align="center">9.0</td><td align="center">0.5</td><td align="left">提交的tag，仅在tag流水线可见</td></tr><tr><td align="left">CI_COMMIT_TIMESTAMP</td><td align="center">13.4</td><td align="center">all</td><td align="left">提交时的时间戳</td></tr><tr><td align="left">CI_COMMIT_TITLE</td><td align="center">10.8</td><td align="center">all</td><td align="left">提交的标题</td></tr><tr><td align="left">CI_DEFAULT_BRANCH</td><td align="center">12.4</td><td align="center">all</td><td align="left">项目的默认分支</td></tr><tr><td align="left">CI_DEPLOY_FREEZE</td><td align="center">13.2</td><td align="center">all</td><td align="left">当流水运行是处于部署冻结阶段时可见，值为true。</td></tr><tr><td align="left">CI_ENVIRONMENT_NAME</td><td align="center">8.15</td><td align="center">all</td><td align="left">当前作业的部署环境名，当设置了environment:name 时可见</td></tr><tr><td align="left">CI_ENVIRONMENT_URL</td><td align="center">9.3</td><td align="center">all</td><td align="left">当前作业的部署环境地址，只有设置了environment:url可见</td></tr><tr><td align="left">CI_JOB_ID</td><td align="center">9.0</td><td align="center">all</td><td align="left">当前作业的ID，系统内唯一</td></tr><tr><td align="left">CI_JOB_IMAGE</td><td align="center">12.9</td><td align="center">12.9</td><td align="left">当前作业使用的Docker镜像名</td></tr><tr><td align="left">CI_JOB_NAME</td><td align="center">9.0</td><td align="center">0.5</td><td align="left">当前作业名称</td></tr><tr><td align="left">CI_JOB_STAGE</td><td align="center">9.0</td><td align="center">0.5</td><td align="left">当前作业所属的阶段名</td></tr><tr><td align="left">CI_PIPELINE_ID</td><td align="center">8.10</td><td align="center">all</td><td align="left">当前流水线ID（实例级），系统内唯一</td></tr><tr><td align="left">CI_PIPELINE_SOURCE</td><td align="center">10.0</td><td align="center">all</td><td align="left">流水线触发方式，枚举值为push,web, schedule, api, external, chat, webide,merge_request_event, external_pull_request_event, parent_pipeline, trigger, 或者 pipeline</td></tr><tr><td align="left">CI_PIPELINE_TRIGGERED</td><td align="center">all</td><td align="center">all</td><td align="left">当作业是使用trigger触发的时为true</td></tr><tr><td align="left">CI_PIPELINE_URL</td><td align="center">11.1</td><td align="center">0.5</td><td align="left">流水线详情的地址</td></tr><tr><td align="left">CI_PIPELINE_CREATED_AT</td><td align="center">13.10</td><td align="center">all</td><td align="left">流水线创建时间</td></tr><tr><td align="left">CI_PROJECT_DIR</td><td align="center">all</td><td align="center">all</td><td align="left">存放克隆项目的完整路径，作业运行的目录。</td></tr><tr><td align="left">CI_PROJECT_NAME</td><td align="center">8.10</td><td align="center">0.5</td><td align="left">当前项目名称，不包含组名</td></tr><tr><td align="left">CI_PROJECT_NAMESPACE</td><td align="center">8.10</td><td align="center">0.5</td><td align="left">项目的命名空间（组名或用户名）</td></tr><tr><td align="left">CI_PROJECT_PATH</td><td align="center">8.10</td><td align="center">0.5</td><td align="left">包含项目名称的命名空间</td></tr><tr><td align="left">CI_PROJECT_TITLE</td><td align="center">12.4</td><td align="center">all</td><td align="left">项目名称（网页上显示的）</td></tr><tr><td align="left">CI_PROJECT_URL</td><td align="center">8.10</td><td align="center">0.5</td><td align="left">项目HTTP(S)地址</td></tr><tr><td align="left">CI_RUNNER_TAGS</td><td align="center">8.10</td><td align="center">0.5</td><td align="left">逗号分割的runner标签列表</td></tr><tr><td align="left">GITLAB_USER_EMAIL</td><td align="center">8.12</td><td align="center">all</td><td align="left">开始当前作业的用户邮箱</td></tr><tr><td align="left">GITLAB_USER_LOGIN</td><td align="center">10.0</td><td align="center">all</td><td align="left">开始当前作业的登录用户名</td></tr><tr><td align="left">GITLAB_USER_NAME</td><td align="center">10.0</td><td align="center">all</td><td align="left">开始当前作业的用户名</td></tr><tr><td align="left">CI_MERGE_REQUEST_APPROVED （仅合并流水线）</td><td align="center">14.1</td><td align="center">all</td><td align="left">当合并流水线的MR被通过时值为true</td></tr><tr><td align="left">CI_MERGE_REQUEST_ASSIGNEES （仅合并流水线）</td><td align="center">11.9</td><td align="center">all</td><td align="left">逗号分割的合并请求指派人列表</td></tr><tr><td align="left">CI_MERGE_REQUEST_SOURCE_BRANCH_NAME（仅合并流水线）</td><td align="center">11.6</td><td align="center">all</td><td align="left">合并请求中的源分支名称</td></tr><tr><td align="left">CI_MERGE_REQUEST_TARGET_BRANCH_NAME（仅合并流水线）</td><td align="center">11.6</td><td align="center">all</td><td align="left">合并请求中的目标分支名称</td></tr><tr><td align="left">CI_MERGE_REQUEST_TITLE（仅合并流水线）</td><td align="center">11.9</td><td align="center">all</td><td align="left">合并请求的标题</td></tr></tbody></table><p>预定义变量详情参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/ci/variables/predefined_variables.html">Predefined variables reference</a></li><li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1976361">GitLab CI/CD中的常用预设变量</a></li></ul><h2 id="全局关键字-1"><span class="post-title-index">7.2.</span><a href="#全局关键字-1" class="headerlink" title="全局关键字"></a> 全局关键字</h2><h3 id="workflow-rules流水线控制"><span class="post-title-index">7.2.1.</span><a href="#workflow-rules流水线控制" class="headerlink" title="workflow:rules流水线控制"></a> workflow:rules流水线控制</h3><p>使用 workflow:rules 关键字来控制何时创建流水线。<br>workflow:rules 关键字在作业之前进行评估。例如，将作业配置为针对标签运行，但工作流阻止标签流水线，则该作业永远不会运行。</p><p>rules包含以下关键字：</p><ul><li>if：条件判断，为true时再看对应的when规则。</li><li>when：取值<code>never</code>表示流水线不运行，取值<code>always</code>或者缺省表示流水线运行。<ul><li>最后一个规则的if缺省，<code>when: always</code>表示其他所有流水线类型都运行。</li><li>最后一个规则不是<code>when: always</code>，表示其他所有流水线类型都不运行。</li></ul></li><li>variables：定义特定流水线条件的变量（引入于13.11版本）。例如不同分支，同一个变量可以定义不同的值。</li></ul><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://docs.gitlab.cn/jh/ci/yaml/workflow.html">GitLab CI/CD workflow 关键字</a></li><li><a target="_blank" rel="noopener" href="https://docs.gitlab.cn/jh/ci/yaml/index.html#workflowrulesvariables">.gitlab-ci.yml 关键字参考 - workflow</a></li><li><a target="_blank" rel="noopener" href="https://forum.gitlab.com/t/interaction-between-workflow-rules-and-rules/49704">Interaction between workflow:rules and rules</a></li></ul><h3 id="stages阶段控制"><span class="post-title-index">7.2.2.</span><a href="#stages阶段控制" class="headerlink" title="stages阶段控制"></a> stages阶段控制</h3><ul><li>stages里可以定义各个stage执行的前后顺序，但是<code>.pre</code>和<code>.post</code>阶段不受其控制</li><li><code>.pre</code>阶段的作业总是在流水线开始时执行</li><li><code>.post</code>阶段的作业总是在流水线结束时执行</li><li>如果两个或者多个作业，指向同一个阶段名称，则该阶段下的所有作业都并行运行；如果不能并行运行，需要检查runner的配置文件中的<code>concurrent</code></li></ul><h3 id="include"><span class="post-title-index">7.2.3.</span><a href="#include" class="headerlink" title="include"></a> include</h3><p>使用 include 在 CI/CD 配置中包含外部 YAML 文件。 您可以将一个长的 .gitlab-ci.yml 文件拆分为多个文件以提高可读性，或减少同一配置在多个位置的重复。</p><p>您还可以将模板文件存储在中央仓库中并将它们包含在项目中。</p><p>include 文件说明：</p><ul><li>与 .gitlab-ci.yml 文件中的那些合并。</li><li>无论 include 关键字的位置如何，始终先求值，然后与 .gitlab-ci.yml 文件的内容合并。</li></ul><p>include 子键：</p><ul><li>include:local</li><li>include:project，include:file，include:ref</li><li>include:remote</li><li>include:template</li></ul><p>注意：如果include了多个文件中都包含stages，那么最后一个文件中的stages会生效。</p><p>参考文档：<a target="_blank" rel="noopener" href="https://docs.gitlab.cn/jh/ci/yaml/#include">gitlab-ci - include</a></p><h2 id="作业关键字-1"><span class="post-title-index">7.3.</span><a href="#作业关键字-1" class="headerlink" title="作业关键字"></a> 作业关键字</h2><h3 id="job-rules作业控制"><span class="post-title-index">7.3.1.</span><a href="#job-rules作业控制" class="headerlink" title="job:rules作业控制"></a> job:rules作业控制</h3><p>使用 job:rules 关键字来控制何时创建作业。</p><p>rules包含以下子关键字：</p><ul><li>if：条件判断，为true时再看对应的其他规则。<ul><li>if的语法和bash中的if语法很像</li><li>不同1：模式匹配时添加了两个斜杠</li><li>不同2：变量不能加花括号（版本14.0.5）</li></ul></li><li>when：前面的作业成功或者失败时运行。on_success（默认值）前面作业成功时执行；on_failure 前面作业失败时执行；always 总是执行；manual 手动执行；delayed&amp;start_in 延迟执行；never 永不执行。</li><li>allow_failure：是否允许作业失败，默认值为false。启用后，作业失败不会阻塞接下来的任务。</li><li>retry：作业遇到错误重新运行的次数。</li><li>timeout：作业运行超时时间。</li><li>needs：作业依赖控制。当前作业可能只依赖前一个stage的其中一个作业，就不用等前一个stage的作业全部完成。</li><li>parallel：生成多个作业，并行运行。值在<code>2-50</code>之间。</li><li>variables：定义特定作业条件下的变量。</li></ul><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://my.oschina.net/zeyangli/blog/4346888">GitLabCI系列之流水线语法第三部分</a></li><li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/ci/jobs/job_control.html">Choose when to run jobs</a></li><li><a target="_blank" rel="noopener" href="https://docs.gitlab.cn/jh/ci/jobs/job_control.html">选择何时运行作业</a></li><li><a target="_blank" rel="noopener" href="https://docs.gitlab.cn/jh/ci/yaml/index.html#rules">.gitlab-ci.yml 关键字参考 - rules</a></li></ul><h3 id="extends"><span class="post-title-index">7.3.2.</span><a href="#extends" class="headerlink" title="extends"></a> extends</h3><p>使用 extends 来重用配置 section。它是 YAML 锚点 的替代方案，并且更加灵活和可读。</p><p>关键字类型：作业关键字。您只能将其用作作业的一部分。</p><p>可能的输入：</p><ul><li>流水线中另一个作业的名称。</li><li>流水线中其他作业的名称列表（数组）。</li></ul><p>注意：extends父作业时，如果不想执行父作业，那么父作业的名称应该以点<code>.</code>开头。</p><p>参考文档：<a target="_blank" rel="noopener" href="https://docs.gitlab.cn/jh/ci/yaml/#extends">gitlab-ci - extends</a></p><h3 id="job-services"><span class="post-title-index">7.3.3.</span><a href="#job-services" class="headerlink" title="job:services"></a> job:services</h3><p>使用services可以指定job运行所依赖的服务镜像。<br>GitLab CI/CD会为每个任务创建一个Docker网络，并且把任务容器（主容器）和服务容器都连接到这个网络上。<br>服务容器的别名就是它在这个网络上的主机名，所以任务容器可以通过别名来访问服务容器提供的端口。</p><p>使用Docker执行器的话，任务和服务都跑在容器中。<br>使用Shell执行器的话，任务跑在执行器所在的机器上，服务跑在容器中。同时，执行器所在机器需要安装Docker。</p><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/ci/yaml/#services">gitlab-ci - services</a></li><li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/ci/services/index.html#available-settings-for-services">Available settings for services</a></li><li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/ci/services/index.html#define-services-in-the-gitlab-ciyml-file">Define services in the .gitlab-ci.yml file</a></li></ul><h3 id="job-artifacts"><span class="post-title-index">7.3.4.</span><a href="#job-artifacts" class="headerlink" title="job:artifacts"></a> job:artifacts</h3><p>job:artifacts的作用是将Job执行后生成的文件或目录存储在GitLab服务器上，供后续的Job或用户下载和使用。我们可以通过UI或API来下载Job artifacts。需要注意的是，Job artifacts的大小不能超过配置的最大值。</p><p>artifacts常用关键字：</p><ul><li>paths：所有指定的路径中的文件，都会被放入artifacts目录。用于指定任意类型的Job artifact，例如编译后的二进制文件、日志文件、图片文件等，这些类型的Job artifact可以被后续的Job或用户下载和使用。只有在Job执行成功时才会上传，除非指定了when:always参数。</li><li>name：指定制品名称，默认制品名称是<code>artifacts</code>，下载时对应<code>artifacts.zip</code>。</li><li>exclude：排除不要放入artifacts目录的文件。</li><li>expire_in：制品的过期时间，默认30天。每小时会自动删除一次过期制品。</li><li>expose_as：要在制品下载链接的UI中显示的名称。</li><li>public：制品是否可以公开下载。</li><li>reports：用于指定一些特定类型的Job artifact，例如JUnit测试报告、代码覆盖率报告、性能测试报告等，这些报告是可以在GitLab的流水线视图、性能仪表盘和安全仪表盘中查看的。总是上传制品，无论Job执行成功还是失败。</li><li>untracked：是否把<code>.gitignore</code>中忽略的文件也作为制品，默认false，不包含被忽略的文件。</li><li>when：什么时候上传制品。取值on_success、on_failure和always，只对paths生效，reports一定会上传。</li></ul><p>下载制品的方法：进入CI/CD Pipelines页面，找到Job对应的Pipeline，最右边三个点，点击下载artifacts。</p><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/ci/yaml/#artifacts">gitlab-ci - artifacts</a></li></ul><h3 id="job-coverage"><span class="post-title-index">7.3.5.</span><a href="#job-coverage" class="headerlink" title="job:coverage"></a> job:coverage</h3><p>将覆盖率与自定义正则表达式一起使用，可以配置如何从作业输出中提取代码覆盖率。如果作业输出中至少有一行与正则表达式匹配，则覆盖率将显示在UI中。</p><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/ci/yaml/#coverage">gitlab-ci - coverage</a></li><li><a target="_blank" rel="noopener" href="https://docs.gitlab.cn/14.0/ee/user/project/merge_requests/test_coverage_visualization.html">Test coverage visualization</a></li></ul><h1 id="常用配置"><span class="post-title-index">8.</span><a href="#常用配置" class="headerlink" title="常用配置"></a> 常用配置</h1><h2 id="当流水线成功时合并分支"><span class="post-title-index">8.1.</span><a href="#当流水线成功时合并分支" class="headerlink" title="当流水线成功时合并分支"></a> 当流水线成功时合并分支</h2><p>1、项目配置<br>Project -&gt; Settings -&gt; General -&gt; Merge requests -&gt; Expand -&gt; Merge checks -&gt; 勾选 Pipelines must succeed</p><p>2、gitlab-ci配置<br>gitlab-ci配置时，要保证workflow和job中都允许merge requests触发pipeline。</p><p>3、触发合并请求<br>gitlab页面上发起一次合并请求，或者使用glab发起合并请求</p><p>4、流水线成功时自动合并<br>打开合并代码的页面，当pipeline运行时，点击 Merge when pipeline succeeds</p><p>参考文档：</p><ul><li><a target="_blank" rel="noopener" href="https://docs.gitlab.cn/jh/user/project/merge_requests/merge_when_pipeline_succeeds.html">当流水线成功时合并</a></li><li><a target="_blank" rel="noopener" href="https://gitlab.voidking.com/help/ci/merge_request_pipelines/index.md#configuring-pipelines-for-merge-requests">Configuring pipelines for merge requests</a></li><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/wzj_110/article/details/104515993">配置Gitlab合并流水线</a></li><li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/54d57ed593e9">Gitlab 发起合并请求，一行命令就搞定！</a></li></ul></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 好好学习的郝</li><li class="post-copyright-link"> <strong>原文链接：</strong> <a href="https://www.voidking.com/dev-gitlab-cicd/" title="好好学GitLab：GitLab CI&#x2F;CD入门篇">https://www.voidking.com/dev-gitlab-cicd/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本文采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议，转载请注明出处！源站会即时更新知识点并修正错误，欢迎访问~</li><li> <img width="200" height="200" src="/images/avatar.jpg"><p style="text-align:center;margin-bottom:0">微信公众号同步更新，欢迎关注~</p></li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/git/" rel="tag"># git</a> <a href="/tags/cicd/" rel="tag"># cicd</a> <a href="/tags/gitlab/" rel="tag"># gitlab</a> <a href="/tags/%E5%A5%BD%E5%A5%BD%E5%AD%A6GitLab/" rel="tag"># 好好学GitLab</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-clickhouse-start/" rel="prev" title="ClickHouse入门篇"><i class="fa fa-chevron-left"></i> ClickHouse入门篇</a></div><div class="post-nav-item"> <a href="/dev-gitlab-ci-no-space-left-on-device/" rel="next" title="好好学GitLab：GitLab CI报错no space left on device">好好学GitLab：GitLab CI报错no space left on device<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="footer-ads" style="margin-top:10px"><ins class="adsbygoogle" style="display:block" data-ad-format="autorelaxed" data-ad-client="ca-pub-3284447971731414" data-ad-slot="9697986181"></ins><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3284447971731414" crossorigin="anonymous"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div class="comments" id="gitalk-container"></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#GitLab-CI-CD%E6%98%AF%E5%95%A5%EF%BC%9F"><span class="nav-text">1. GitLab CI&#x2F;CD是啥？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#GitLab-CI-CD%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-text">2. GitLab CI&#x2F;CD基本概念</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Gitlab-CI-CD%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6"><span class="nav-text">3. Gitlab CI&#x2F;CD工作机制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E7%AC%AC%E4%B8%80%E4%B8%AA%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="nav-text">4. 配置第一个流水线</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-gitlab-ci-yml"><span class="nav-text">4.1. 配置.gitlab-ci.yml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8CRunner"><span class="nav-text">4.2. 注册Runner</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%85%B8%E5%9E%8B%E7%A4%BA%E4%BE%8B"><span class="nav-text">5. 流水线典型示例</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B5%81%E6%B0%B4%E7%BA%BF%E8%AF%AD%E6%B3%95"><span class="nav-text">6. 流水线语法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E6%B0%B4%E7%BA%BF%E8%AF%AD%E6%B3%95%E6%A6%82%E8%BF%B0"><span class="nav-text">6.1. 流水线语法概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-text">6.2. 全局关键字</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%9C%E4%B8%9A%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-text">6.3. 作业关键字</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="nav-text">6.3.1. 执行命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-text">6.3.2. 环境变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%9C%E4%B8%9A%E6%9D%A1%E4%BB%B6"><span class="nav-text">6.3.3. 作业条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B6%85%E6%97%B6%E4%B8%8E%E9%87%8D%E8%AF%95"><span class="nav-text">6.3.4. 超时与重试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%A7%E6%89%BF"><span class="nav-text">6.3.5. 继承</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-text">6.3.6. 其他</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B5%81%E6%B0%B4%E7%BA%BF%E9%83%A8%E5%88%86%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3"><span class="nav-text">7. 流水线部分关键字详解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#variables%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-text">7.1. variables环境变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E5%85%B3%E9%94%AE%E5%AD%97-1"><span class="nav-text">7.2. 全局关键字</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#workflow-rules%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%8E%A7%E5%88%B6"><span class="nav-text">7.2.1. workflow:rules流水线控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#stages%E9%98%B6%E6%AE%B5%E6%8E%A7%E5%88%B6"><span class="nav-text">7.2.2. stages阶段控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#include"><span class="nav-text">7.2.3. include</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%9C%E4%B8%9A%E5%85%B3%E9%94%AE%E5%AD%97-1"><span class="nav-text">7.3. 作业关键字</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#job-rules%E4%BD%9C%E4%B8%9A%E6%8E%A7%E5%88%B6"><span class="nav-text">7.3.1. job:rules作业控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#extends"><span class="nav-text">7.3.2. extends</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#job-services"><span class="nav-text">7.3.3. job:services</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#job-artifacts"><span class="nav-text">7.3.4. job:artifacts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#job-coverage"><span class="nav-text">7.3.5. job:coverage</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="nav-text">8. 常用配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BD%93%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%88%90%E5%8A%9F%E6%97%B6%E5%90%88%E5%B9%B6%E5%88%86%E6%94%AF"><span class="nav-text">8.1. 当流水线成功时合并分支</span></a></li></ol></li></ol></div></div><div class="sidecar-ads" style="margin-top:10px"><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">一个计算机技术爱好者与学习者</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">725</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">32</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">255</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/gitalk/1.7.2/gitalk.min.css"><script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/gitalk/1.7.2/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID: '5a238b8c32b1e4dd2156',
      clientSecret: 'bfb5d518626f6fdc7da0351d1e0cd37ab75c6361',
      repo: 'gitalk-comments',
      owner: 'voidking',
      admin: ['voidking'],
      id: '8a234586754edcc97bda652f5f827cce',
      title: '好好学GitLab：GitLab CI/CD入门篇',
      body: '欢迎留言，互相交流学习~',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script></body></html>