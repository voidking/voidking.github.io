<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1,cdn:{enable:!0,url:"//cdn.jsdelivr.net/gh/voidking/voidking.github.io/search.xml"}},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="前言为了加深对VxLAN网络模式的理解，郝同学打算使用Open vSwitch进行VxLAN隧道实验。主要参考搭建基于Open vSwitch的VxLAN隧道实验和基于Open vSwitch的VxLAN隧道实验网络。"><meta property="og:type" content="article"><meta property="og:title" content="使用Open vSwitch进行VxLAN隧道实验"><meta property="og:url" content="https://www.voidking.com/dev-openvswitch-vxlan/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="前言为了加深对VxLAN网络模式的理解，郝同学打算使用Open vSwitch进行VxLAN隧道实验。主要参考搭建基于Open vSwitch的VxLAN隧道实验和基于Open vSwitch的VxLAN隧道实验网络。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://cdn.voidking.com//imgs/openvswitch-vxlan/nettopology1.png?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/openvswitch-vxlan/ovsctlshow.jpg?imageView2/0/w/650"><meta property="og:image" content="http://cdn.voidking.com//imgs/openvswitch-vxlan/ifconfig.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/openvswitch-vxlan/ping1.jpg?imageView2/0/w/650"><meta property="og:image" content="http://cdn.voidking.com//imgs/openvswitch-vxlan/ping3.jpg?imageView2/0/w/650"><meta property="og:image" content="http://cdn.voidking.com//imgs/openvswitch-vxlan/nettopology2.png?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/openvswitch-vxlan/ping4.jpg?imageView2/0/w/650"><meta property="og:image" content="http://cdn.voidking.com//imgs/openvswitch-vxlan/ping5.jpg?imageView2/0/w/650"><meta property="og:image" content="http://cdn.voidking.com//imgs/openvswitch-vxlan/nettopology3.jpg?imageView2/0/w/750"><meta property="og:image" content="http://cdn.voidking.com//imgs/openvswitch-vxlan/ping6.jpg?imageView2/0/w/650"><meta property="og:image" content="http://cdn.voidking.com//imgs/openvswitch-vxlan/ping7.jpg?imageView2/0/w/650"><meta property="og:image" content="http://cdn.voidking.com//imgs/openvswitch-vxlan/ping8.jpg?imageView2/0/w/650"><meta property="og:image" content="http://cdn.voidking.com//imgs/openvswitch-vxlan/ping9.jpg?imageView2/0/w/650"><meta property="og:image" content="http://cdn.voidking.com//imgs/openvswitch-vxlan/traceroute.jpg?imageView2/0/w/650"><meta property="article:published_time" content="2018-07-21T09:00:00.000Z"><meta property="article:modified_time" content="2018-07-21T09:00:00.000Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="linux"><meta property="article:tag" content="ubuntu"><meta property="article:tag" content="openstack"><meta property="article:tag" content="网络"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://cdn.voidking.com//imgs/openvswitch-vxlan/nettopology1.png?imageView2/0/w/750"><link rel="canonical" href="https://www.voidking.com/dev-openvswitch-vxlan/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>使用Open vSwitch进行VxLAN隧道实验 | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">好好学习，天天向上！</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-openvswitch-vxlan/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="学而不思则罔，思而不学则殆！"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> 使用Open vSwitch进行VxLAN隧道实验</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-07-21 09:00:00" itemprop="dateCreated datePublished" datetime="2018-07-21T09:00:00+00:00">2018-07-21</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/" itemprop="url" rel="index"><span itemprop="name">engineering</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/devops/" itemprop="url" rel="index"><span itemprop="name">devops</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>为了加深对VxLAN网络模式的理解，郝同学打算使用Open vSwitch进行VxLAN隧道实验。主要参考<a target="_blank" rel="noopener" href="https://www.sdnlab.com/5365.html">搭建基于Open vSwitch的VxLAN隧道实验</a>和<a target="_blank" rel="noopener" href="https://www.sdnlab.com/openvswitch-vxlan/">基于Open vSwitch的VxLAN隧道实验网络</a>。</p><span id="more"></span><h1 id="虚拟机准备"><a href="#虚拟机准备" class="headerlink" title="虚拟机准备"></a>虚拟机准备</h1><p>使用VirtualBox创建两个虚拟机，主机名分别为controller和compute，系统均为ubuntu-16.04.4-server-amd64。</p><p>这两台虚拟机，都有两块网卡。eth0负责主机间相互通信，eth1负责上网。controller的eth0的IP为192.168.56.110，compute的eth0的IP为192.168.56.111。controller和compute可以互相ping通。</p><h1 id="安装openvswitch"><a href="#安装openvswitch" class="headerlink" title="安装openvswitch"></a>安装openvswitch</h1><p>通过源码安装参考<a target="_blank" rel="noopener" href="http://docs.openvswitch.org/en/latest/intro/install/general/">Open vSwitch on Linux, FreeBSD and NetBSD</a>，这里我们不使用源码安装，而是使用apt包管理工具直接安装，参考<a target="_blank" rel="noopener" href="http://docs.openvswitch.org/en/latest/intro/install/distributions/#debian">Debian安装openvswitch</a>。</p><p>一条命令搞定：</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt -y install  openvswitch-<span class="keyword">switch</span> openvswitch-<span class="keyword">common</span> openvswitch-<span class="keyword">switch</span>-dpdk</span><br></pre></td></tr></table></figure><h1 id="实验一"><a href="#实验一" class="headerlink" title="实验一"></a>实验一</h1><h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p><img src="http://cdn.voidking.com//imgs/openvswitch-vxlan/nettopology1.png?imageView2/0/w/750"><br>如上图，分别给两台虚拟机的br1指定两个 <strong>相同网段</strong> 的ip，然后通过搭建VXLAN隧道让这两个不同机器的网桥能够实现通信。</p><h2 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h2><p>1、在controller上添加br0和br1两个网桥</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl<span class="built_in"> add-br </span>br0</span><br><span class="line">ovs-vsctl<span class="built_in"> add-br </span>br1</span><br></pre></td></tr></table></figure><p>2、查看网桥<br><code>ovs-vsctl show</code><br><img src="http://cdn.voidking.com//imgs/openvswitch-vxlan/ovsctlshow.jpg?imageView2/0/w/650"></p><p>3、在br0上添加一个端口，将eth0挂载到br0上。这样做的目的是方便我们在虚拟网桥上添加多个端口供我们使用，这样不必受限于eth0的有限端口。<br><code>ovs-vsctl add-port br0 eth0</code></p><p>4、此时我们将原先eth0分配的ip清除并指定给br0，让虚拟机网络能通过br0继续工作。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ifconfig</span> eth0 <span class="number">0</span> up</span><br><span class="line"><span class="attribute">ifconfig</span> br0 <span class="number">192.168.56.110</span>/<span class="number">24</span> up</span><br></pre></td></tr></table></figure><p>5、根据实际情况配置一下br0的网关（可选）。<br><code>route add default gw 192.168.56.1 br0</code></p><p>6、给网桥br1分配一个ip。<br><code>ifconfig br1 172.16.0.1/24 up</code></p><p>7、查看ip<br><code>ifconfig</code><br><img src="http://cdn.voidking.com//imgs/openvswitch-vxlan/ifconfig.jpg?imageView2/0/w/750"></p><h2 id="ip永久生效"><a href="#ip永久生效" class="headerlink" title="ip永久生效"></a>ip永久生效</h2><p>以上ip配置，在重启后会失效，要想永久有效，需要修改interfaces配置。<br><code>vim /etc/network/interfaces</code>，如下修改：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">auto</span> eth0</span><br><span class="line">iface eth0 inet manual</span><br><span class="line">up ifconfig <span class="variable">$IFACE</span> <span class="number">0.0.0.0</span> up</span><br><span class="line">up ifconfig <span class="variable">$IFACE</span> promisc</span><br><span class="line"></span><br><span class="line">auto eth1</span><br><span class="line">iface eth1 inet dhcp</span><br><span class="line"></span><br><span class="line">auto br0</span><br><span class="line">iface br0 inet static</span><br><span class="line">address <span class="number">192.168.56.110</span></span><br><span class="line">netmask <span class="number">255.255.255.0</span></span><br><span class="line"></span><br><span class="line">auto br1</span><br><span class="line">iface br1 inet static</span><br><span class="line">address <span class="number">172.16.0.1</span></span><br><span class="line">netmask <span class="number">255.255.255.0</span></span><br></pre></td></tr></table></figure><h2 id="compute"><a href="#compute" class="headerlink" title="compute"></a>compute</h2><p>1、在compute上添加br0和br1两个网桥</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl<span class="built_in"> add-br </span>br0</span><br><span class="line">ovs-vsctl<span class="built_in"> add-br </span>br1</span><br></pre></td></tr></table></figure><p>2、在br0上添加一个端口，将eth0挂载到br0上。这样做的目的是方便我们在虚拟网桥上添加多个端口供我们使用，这样不必受限于eth0的有限端口。<br><code>ovs-vsctl add-port br0 eth0</code></p><p>3、此时我们将原先eth0分配的ip清除并指定给br0，让虚拟机网络能通过br0继续工作。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ifconfig</span> eth0 <span class="number">0</span> up</span><br><span class="line"><span class="attribute">ifconfig</span> br0 <span class="number">192.168.56.111</span>/<span class="number">24</span> up</span><br></pre></td></tr></table></figure><p>4、根据实际情况配置一下br0的网关（可选）。<br><code>route add default gw 192.168.56.1 br0</code></p><p>5、给网桥br1分配一个ip。<br><code>ifconfig br1 172.16.0.2/24 up</code></p><h2 id="搭建VxLAN隧道"><a href="#搭建VxLAN隧道" class="headerlink" title="搭建VxLAN隧道"></a>搭建VxLAN隧道</h2><p>1、在controller查看连通性</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ping</span> <span class="number">192.168.56.111</span> -c3</span><br><span class="line">ping <span class="number">172.16.0.2</span> -c3</span><br></pre></td></tr></table></figure><p><img src="http://cdn.voidking.com//imgs/openvswitch-vxlan/ping1.jpg?imageView2/0/w/650"><br>上图可以看到，controller可以ping通过192.168.56.111，却ping不通172.16.0.2。</p><p>2、在controller上设置VxLAN，远端ip设置为compute能对外通信的br0的ip。</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl<span class="built_in"> add-port </span>br1 vx1 -- set interface vx1 type=vxlan options:remote_ip=192.168.56.111</span><br></pre></td></tr></table></figure><p>此时，依然ping不通172.16.0.2。</p><p>3、在compute上设置VxLAN，远端ip设置为controller能对外通信的br0的ip。</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl<span class="built_in"> add-port </span>br1 vx1 -- set interface vx1 type=vxlan options:remote_ip=192.168.56.110</span><br></pre></td></tr></table></figure><p>4、在controller上验证VxLAN隧道<br><code>ping 172.16.0.2 -c3</code><br><img src="http://cdn.voidking.com//imgs/openvswitch-vxlan/ping3.jpg?imageView2/0/w/650"><br>如上图，controller的br1和compute的br1已经连通，实验成功。</p><h1 id="实验二"><a href="#实验二" class="headerlink" title="实验二"></a>实验二</h1><h2 id="目标-1"><a href="#目标-1" class="headerlink" title="目标"></a>目标</h2><p><img src="http://cdn.voidking.com//imgs/openvswitch-vxlan/nettopology2.png?imageView2/0/w/750"><br>如上图，分别给两台虚拟机的br1指定两个 <strong>不同网段</strong> 的ip，然后通过搭建VXLAN隧道让这两个不同网段的网桥能够实现通信。</p><h2 id="搭建VxLAN隧道-1"><a href="#搭建VxLAN隧道-1" class="headerlink" title="搭建VxLAN隧道"></a>搭建VxLAN隧道</h2><p>紧接着实验一，我们已经创建了VxLAN隧道，controller和compute在172.16.0.0/24网段可以相互ping通。</p><p>1、在compute上修改ip为其他网段<br><code>ifconfig br1 172.16.1.1/24 up</code></p><p>2、在controller上验证VxLAN隧道<br><code>ping 172.16.1.1 -c3</code><br><img src="http://cdn.voidking.com//imgs/openvswitch-vxlan/ping4.jpg?imageView2/0/w/650"><br>如上图，controller无法连通compute，这是因为，不通网段间的通信需要路由。</p><p>3、在controller上设置路由<br><code>route add -net 172.16.1.0/24 gw 172.16.0.1 dev br1</code></p><p>4、在compute上设置路由<br><code>route add -net 172.16.0.0/24 gw 172.16.1.1 dev br1</code></p><p>5、再次在controller上验证VxLAN隧道<br><code>ping 172.16.1.1 -c3</code><br><img src="http://cdn.voidking.com//imgs/openvswitch-vxlan/ping5.jpg?imageView2/0/w/650"><br>如上图，controller的br1和compute的br1已经连通，实验成功。</p><h2 id="路由永久生效"><a href="#路由永久生效" class="headerlink" title="路由永久生效"></a>路由永久生效</h2><p>以上路由配置，在重启后会失效，要想永久有效，需要修改interfaces配置。<br>controller上，<code>vim /etc/network/interfaces</code>，添加：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">up</span> route add -net <span class="number">172.16.1.0</span>/<span class="number">24</span> gw <span class="number">172.16.0.1</span> dev br1</span><br></pre></td></tr></table></figure><p>compute上，<code>vim /etc/network/interfaces</code>，添加：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">up</span> route add -net <span class="number">172.16.0.0</span>/<span class="number">24</span> gw <span class="number">172.16.1.1</span> dev br1</span><br></pre></td></tr></table></figure><h1 id="实验三"><a href="#实验三" class="headerlink" title="实验三"></a>实验三</h1><h2 id="目标-2"><a href="#目标-2" class="headerlink" title="目标"></a>目标</h2><p><img src="http://cdn.voidking.com//imgs/openvswitch-vxlan/nettopology3.jpg?imageView2/0/w/750"><br>紧接着实验二，问题来了，两个虚拟机之间可以创建VxLAN隧道，那么三个虚拟机之间该怎么处理？本实验，就要在三个虚拟机之间建立XxLAN隧道，实现通信。</p><h2 id="ip配置"><a href="#ip配置" class="headerlink" title="ip配置"></a>ip配置</h2><p>参照实验一：<br>controller的br0配置ip为192.168.56.110/24，br1配置ip为172.16.0.1/24。<br>compute1的br0配置ip为192.168.56.111/24，br1配置ip为172.16.1.1/24。<br>compute2的br0配置ip为192.168.56.112/24，br1配置ip为172.16.2.1/24。</p><h2 id="搭建VxLAN隧道-2"><a href="#搭建VxLAN隧道-2" class="headerlink" title="搭建VxLAN隧道"></a>搭建VxLAN隧道</h2><p>1、在controller上设置VxLAN，远端ip设置为compute1和compute2能对外通信的br0的ip。</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl<span class="built_in"> add-port </span>br1 vx1 -- set interface vx1 type=vxlan options:remote_ip=192.168.56.111</span><br><span class="line">ovs-vsctl<span class="built_in"> add-port </span>br1 vx2 -- set interface vx2 type=vxlan options:remote_ip=192.168.56.112</span><br></pre></td></tr></table></figure><p>2、在compute1上设置VxLAN，远端ip设置为controller能对外通信的br0的ip。</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl<span class="built_in"> add-port </span>br1 vx1 -- set interface vx1 type=vxlan options:remote_ip=192.168.56.110</span><br></pre></td></tr></table></figure><p>3、在compute2上设置VxLAN，远端ip设置为controller能对外通信的br0的ip。</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl<span class="built_in"> add-port </span>br1 vx1 -- set interface vx1 type=vxlan options:remote_ip=192.168.56.110</span><br></pre></td></tr></table></figure><p>5、在controller上添加路由</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">route</span> add -net <span class="number">172.16.0.0</span>/<span class="number">16</span> gw <span class="number">172.16.0.1</span> dev br1</span><br></pre></td></tr></table></figure><p>6、在compute1上添加路由<br><code>route add -net 172.16.0.0/16 gw 172.16.1.1 dev br1</code></p><p>7、在compute2上添加路由<br><code>route add -net 172.16.0.0/16 gw 172.16.2.1 dev br1</code></p><p>8、在controller测试连通compute1和compute2</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ping</span> <span class="number">172.16.1.1</span> -c3</span><br><span class="line">ping <span class="number">172.16.2.1</span> -c3</span><br></pre></td></tr></table></figure><p><img src="http://cdn.voidking.com//imgs/openvswitch-vxlan/ping6.jpg?imageView2/0/w/650"><br><img src="http://cdn.voidking.com//imgs/openvswitch-vxlan/ping7.jpg?imageView2/0/w/650"><br>神奇的事情发生了，可以ping通172.16.1.1的时候，172.16.2.1不通；可以ping通172.16.2.1的时候，172.16.1.1不通。这是因为，在完成实验二后，郝同学直接复制了compute虚拟机作为compute2，结果导致两台虚拟机的br1的mac地址相同。compute2删除br1重建，问题解决。<br><img src="http://cdn.voidking.com//imgs/openvswitch-vxlan/ping8.jpg?imageView2/0/w/650"></p><p>9、在compute1测试连通compute2<br><code>ping 172.16.2.1 -c3</code><br><img src="http://cdn.voidking.com//imgs/openvswitch-vxlan/ping9.jpg?imageView2/0/w/650"><br>此时，compute1和compute2的br1已经连通。由上面的配置我们知道，它们之间并没有建立直接隧道，而是通过controller进行转发。</p><p>有意思的是，使用traceroute查看路由，发现它们连接时并没有经过网关（compute1的172.16.1.1和controller的172.16.0.1），而是直连。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">traceroute</span> <span class="number">172.16.2.1</span></span><br><span class="line">traceroute <span class="number">172.16.2.1</span> -I</span><br></pre></td></tr></table></figure><p><img src="http://cdn.voidking.com//imgs/openvswitch-vxlan/traceroute.jpg?imageView2/0/w/650"></p><h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>至此，使用Open vSwitch进行VxLAN隧道实验完成。三个实验都比较基础，至于更高级的实验，以后再研究，比如在br1网桥上连接cirros虚拟机、添加tun/tap设备、添加veth设备等。</p><h1 id="书签"><a href="#书签" class="headerlink" title="书签"></a>书签</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hbgzy/p/5279269.html">Vxlan学习笔记——原理</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/power886/article/details/72633906">最详细的Vlan原理介绍</a></p><p><a target="_blank" rel="noopener" href="https://www.sdnlab.com/sdn-guide/14716.html">SDN与OpenFlow技术简介</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zztflyer/article/details/51823068">OpenStack网络实战系列一：通过Openvswitch实践了解交换机的基本概念和操作</a></p><p><a target="_blank" rel="noopener" href="https://www.sdnlab.com/15083.html">Open vSwitch使用案例扩展实验</a></p><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yml435/p/5917628.html">TAP 设备与 VETH 设备</a></p><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000009249039">Linux虚拟网络设备之tun/tap</a></p><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000009251098">Linux虚拟网络设备之veth</a></p></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 好好学习的郝</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.voidking.com/dev-openvswitch-vxlan/" title="使用Open vSwitch进行VxLAN隧道实验">https://www.voidking.com/dev-openvswitch-vxlan/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！源站会及时更新知识点及修正错误，阅读体验也更好。欢迎分享，欢迎收藏~</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/linux/" rel="tag"># linux</a> <a href="/tags/ubuntu/" rel="tag"># ubuntu</a> <a href="/tags/openstack/" rel="tag"># openstack</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag"># 网络</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-ubuntu16-manual-openstack-vxlan-advance/" rel="prev" title="Ubuntu16手动安装OpenStack——vxlan网络进阶"><i class="fa fa-chevron-left"></i> Ubuntu16手动安装OpenStack——vxlan网络进阶</a></div><div class="post-nav-item"> <a href="/dev-hexo-gitalk-comment-plugin/" rel="next" title="Hexo使用gitalk作为评论插件">Hexo使用gitalk作为评论插件<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zODU3Mi8xNTEwMA=="></div></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%87%86%E5%A4%87"><span class="nav-number">2.</span> <span class="nav-text">虚拟机准备</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85openvswitch"><span class="nav-number">3.</span> <span class="nav-text">安装openvswitch</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C%E4%B8%80"><span class="nav-number">4.</span> <span class="nav-text">实验一</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87"><span class="nav-number">4.1.</span> <span class="nav-text">目标</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#controller"><span class="nav-number">4.2.</span> <span class="nav-text">controller</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ip%E6%B0%B8%E4%B9%85%E7%94%9F%E6%95%88"><span class="nav-number">4.3.</span> <span class="nav-text">ip永久生效</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#compute"><span class="nav-number">4.4.</span> <span class="nav-text">compute</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%AD%E5%BB%BAVxLAN%E9%9A%A7%E9%81%93"><span class="nav-number">4.5.</span> <span class="nav-text">搭建VxLAN隧道</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C%E4%BA%8C"><span class="nav-number">5.</span> <span class="nav-text">实验二</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87-1"><span class="nav-number">5.1.</span> <span class="nav-text">目标</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%AD%E5%BB%BAVxLAN%E9%9A%A7%E9%81%93-1"><span class="nav-number">5.2.</span> <span class="nav-text">搭建VxLAN隧道</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E6%B0%B8%E4%B9%85%E7%94%9F%E6%95%88"><span class="nav-number">5.3.</span> <span class="nav-text">路由永久生效</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C%E4%B8%89"><span class="nav-number">6.</span> <span class="nav-text">实验三</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87-2"><span class="nav-number">6.1.</span> <span class="nav-text">目标</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ip%E9%85%8D%E7%BD%AE"><span class="nav-number">6.2.</span> <span class="nav-text">ip配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%AD%E5%BB%BAVxLAN%E9%9A%A7%E9%81%93-2"><span class="nav-number">6.3.</span> <span class="nav-text">搭建VxLAN隧道</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%90%8E%E8%AE%B0"><span class="nav-number">7.</span> <span class="nav-text">后记</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B9%A6%E7%AD%BE"><span class="nav-number">8.</span> <span class="nav-text">书签</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">学而不思则罔，思而不学则殆！</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">645</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">30</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">242</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={iconStyle:"box",boxForm:"horizontal",position:"bottomCenter",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={iconStyle:"box",boxForm:"horizontal",position:"topRight",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-float",flOptions)</script><script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  // window.livereOptions = {
  //   refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  // };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script></body></html>