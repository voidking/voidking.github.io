<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.voidking.com").hostname,root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1,cdn:{enable:!0,url:"//qiniu.cdn.voidking.com/doc/search.xml"}},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="K8S中的账户简介k8s中的账户分为useraccount和serviceaccount，主要差异有四点：  useraccount是给人使用的，serviceaccount是给pod中进程调用APIServer使用的 useraccount是跨namespace的，serviceaccount是局限在它所在的namespace的 useraccount不能通过k8s api添加，但是能够通过证书"><meta property="og:type" content="article"><meta property="og:title" content="好好学K8S：K8S中创建用户账户和服务账户"><meta property="og:url" content="https://www.voidking.com/dev-k8s-useraccount-serviceaccount/index.html"><meta property="og:site_name" content="好好学习的郝"><meta property="og:description" content="K8S中的账户简介k8s中的账户分为useraccount和serviceaccount，主要差异有四点：  useraccount是给人使用的，serviceaccount是给pod中进程调用APIServer使用的 useraccount是跨namespace的，serviceaccount是局限在它所在的namespace的 useraccount不能通过k8s api添加，但是能够通过证书"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2020-03-09T20:00:00.000Z"><meta property="article:modified_time" content="2024-06-01T08:00:00.000Z"><meta property="article:author" content="好好学习的郝"><meta property="article:tag" content="k8s"><meta property="article:tag" content="好好学K8S"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.voidking.com/dev-k8s-useraccount-serviceaccount/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>好好学K8S：K8S中创建用户账户和服务账户 | 好好学习的郝</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b759ac2a7fa45129e3ef060bf68259f0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="好好学习的郝" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">好好学习的郝</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">一个计算机技术爱好者与学习者</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/voidking" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.voidking.com/dev-k8s-useraccount-serviceaccount/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="好好学习的郝"><meta itemprop="description" content="一个计算机技术爱好者与学习者"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="好好学习的郝"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> 好好学K8S：K8S中创建用户账户和服务账户</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-03-09 20:00:00" itemprop="dateCreated datePublished" datetime="2020-03-09T20:00:00+00:00">2020-03-09</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-06-01 08:00:00" itemprop="dateModified" datetime="2024-06-01T08:00:00+00:00">2024-06-01</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/" itemprop="url" rel="index"><span itemprop="name">engineering</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/engineering/cloudnative/" itemprop="url" rel="index"><span itemprop="name">cloudnative</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="K8S中的账户简介"><span class="post-title-index">1.</span><a href="#K8S中的账户简介" class="headerlink" title="K8S中的账户简介"></a> K8S中的账户简介</h1><p>k8s中的账户分为useraccount和serviceaccount，主要差异有四点：</p><ul><li>useraccount是给人使用的，serviceaccount是给pod中进程调用APIServer使用的</li><li>useraccount是跨namespace的，serviceaccount是局限在它所在的namespace的</li><li>useraccount不能通过k8s api添加，但是能够通过证书签名方式进行认证；serviceaccount可以通过k8s api添加</li><li>每个namespace都有一个默认的serviceaccount，叫做default</li></ul><p>本文中，我们主要研究怎样为K8S创建用户账户和怎样创建服务账户。</p><p>参考文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/authentication/">用户认证</a></p><span id="more"></span><h1 id="创建用户账户"><span class="post-title-index">2.</span><a href="#创建用户账户" class="headerlink" title="创建用户账户"></a> 创建用户账户</h1><p>需求：创建一个名为jane的用户账户。</p><h2 id="创建用户密钥对"><span class="post-title-index">2.1.</span><a href="#创建用户密钥对" class="headerlink" title="创建用户密钥对"></a> 创建用户密钥对</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out jane.key 2048</span><br><span class="line">openssl req -new -key jane.key -subj  <span class="string">&quot;/CN=jane&quot;</span> -out jane.csr</span><br></pre></td></tr></table></figure><p>其中，key文件是私钥；csr文件是证书签名申请（Certificate Signing Request），里面包含证书的公钥和其他信息。</p><h2 id="使用CA签名"><span class="post-title-index">2.2.</span><a href="#使用CA签名" class="headerlink" title="使用CA签名"></a> 使用CA签名</h2><p>假设可以登录运行kube-controller-manager的master节点，那么可以直接在该节点进行CA签名。</p><p>1、查看签名用的CA路径</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/kubernetes/manifests/kube-controller-manager.yaml | grep ca.crt</span><br><span class="line"><span class="built_in">cat</span> /etc/kubernetes/manifests/kube-controller-manager.yaml | grep ca.key</span><br></pre></td></tr></table></figure><p>查到的路径为<code>/etc/kubernetes/pki/ca.crt</code> 和 <code>/etc/kubernetes/pki/ca.key</code></p><p>2、使用CA签名</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -<span class="keyword">in</span> /root/jane.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out /root/jane.crt</span><br></pre></td></tr></table></figure><p>其中，crt文件是签名后的证书。</p><p>以上，有了crt和key，这俩加起来就是jane用户账户。一般的用户账户是用户名和密码，K8S的用户账户就是签名证书和私钥。</p><h2 id="使用API签名"><span class="post-title-index">2.3.</span><a href="#使用API签名" class="headerlink" title="使用API签名"></a> 使用API签名</h2><p>如果无法直接使用CA证书进行签名，那么可以通过APIServer的方式进行签名。</p><p>1、查看证书签名申请，base64加密</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> jane.csr | <span class="built_in">base64</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span></span><br></pre></td></tr></table></figure><p>2、创建jane-csr.yaml文件，把证书签名申请的内容粘贴到spec.request部分</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">certificates.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CertificateSigningRequest</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jane</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">system:authenticated</span></span><br><span class="line">  <span class="attr">usages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">digital</span> <span class="string">signature</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">key</span> <span class="string">encipherment</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">server</span> <span class="string">auth</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">client</span> <span class="string">auth</span></span><br><span class="line">  <span class="attr">request:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ1ZEQ0NBVHdDQVFBd0R6RU5NQXNHQTFVRUF3d0VhbUZ1WlRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRApnZ0VQQURDQ0FRb0NnZ0VCQUtxbWFIa3BJeE94dDN2UmxJT1FnSUFxSUFsekhQcTRRVTBDTDVhS04xbmY4NXRzCi9LU3o0eml1a1hEQ1NOSVNIT1pWbTY5NzVJa3RXcGFySmhaTXptc1B2eUFSeXFWbWY2L1h0bmwyeE0xblhaUzAKZGc0b0E1dXFuR0w2dHpaQzF3VFY4RVFIZnRlcWYzbUpTN2JtdlppaXFlak12a2UzVkk5RTNFK0xsUUttNnVXRwprS2RDZ2ZHNUszRGJFczR1VzR6M0lMdTdEa1BlamJodWFtYzlxYVZNRVpLSGZ0bnlBYlFITkZVLzhvWVYvR1VzCnRFVWZMRXBBTmlqUFc5U0pPWHJtNUg1NXhOdExXVHMwenU3YlRSZWE0ZjFVaDFCbkZuUkhWYUJqNysydHpITTgKaklJS01KakdWOS9rUVltRmo3UTJZUW1wYzdXWGpPZEFWcHBSc1kwQ0F3RUFBYUFBTUEwR0NTcUdTSWIzRFFFQgpDd1VBQTRJQkFRQUZ2ZUxrUmYxd0xDQmN6cWdMVkJIUGZBa0MzeU1CTDA3VXl0QUlCcVhkR3h1QWtyL3NQT1dkClNxTkhIRkNzQVNmU0lNVC96djBrQS9yN3Fnd25BMCtZREZJSjNzUlBKZkJmNm1Ic3FrbjlPd1htR1E3d0orNFQKWXVCc1lJSllnNWtzVWJoQVhiQkVZekk2OUY0Uk52U0d0K1ZLOHBBdUQzcXRvejJsd3liV0cvaUo4V3FESTZNegpuMURBeDBkRDZmRWhIKy9DTWdSREY5OExCL1ZqMWZOUUlqZ2k3Rmc1aTByU1NtZUdUMllOblJldERZYWN4aWlzCjNFN1B4STdYWDd2QjRjY3pITlUrTG92N3JnSkVXM3lRMXZRTXRCNTZlbWJaNGVnL01XZEhkeWliVXo2aDQ1ZW8KUGN5b3QxaW1wdFRyK3kwSkt0SmJ1YllQOGd2RG5FeFYKLS0tLS1FTkQgQ0VSVElGSUNBVEUgUkVRVUVTVC0tLS0tCg==</span></span><br></pre></td></tr></table></figure><p>3、签名请求并通过</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f jane-csr.yaml</span><br><span class="line">kubectl get csr </span><br><span class="line">kubectl certificate approve jane</span><br></pre></td></tr></table></figure><p>4、导出签名证书</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get csr jane -o yaml</span><br><span class="line">kubectl get csr jane -o jsonpath=<span class="string">&#x27;&#123;.status.certificate&#125;&#x27;</span> | <span class="built_in">base64</span> --decode &gt; jane.crt</span><br></pre></td></tr></table></figure><p>以上，有了crt和key，这俩加起来就是jane用户账户。</p><p>更多内容参考<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster/">Manage TLS Certificates in a Cluster</a>。</p><h1 id="证书格式转换"><span class="post-title-index">3.</span><a href="#证书格式转换" class="headerlink" title="证书格式转换"></a> 证书格式转换</h1><p>X.509是一种证书标准，定义了证书中应该包含哪些内容，详情参考RFC5280，SSL使用的就是这种证书标准。<br>同样的X.509证书，可能有不同的编码格式，目前有以下两种编码格式。<br>PEM：Privacy Enhanced Mail，BASE64编码，以”—–BEGIN—–”开头，”—–END—–”结尾。<br>查看PEM格式证书的信息：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -<span class="keyword">in</span> cert.pem -text -noout</span><br></pre></td></tr></table></figure><p>DER：Distinguished Encoding Rules，二进制格式，不可读。<br>查看DER格式证书的信息：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -<span class="keyword">in</span> cert.der -inform der -text -noout</span><br></pre></td></tr></table></figure><p>问题来了，k8s中的证书，除了使用pem格式，还有就是crt格式，并没有der格式啊？这是因为，crt只是一个文件后缀，编码格式可能是pem也可能是der。</p><p>那么，pem和der怎样互相转换呢？</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pem to der</span></span><br><span class="line">openssl x509 -<span class="keyword">in</span> cert.crt -outform der -out cert.der</span><br><span class="line"><span class="comment"># der to pem</span></span><br><span class="line">openssl x509 -<span class="keyword">in</span> cert.crt -inform der -outform pem -out cert.pem</span><br></pre></td></tr></table></figure><h1 id="K8S中的数字证书"><span class="post-title-index">4.</span><a href="#K8S中的数字证书" class="headerlink" title="K8S中的数字证书"></a> K8S中的数字证书</h1><p>我们自己创建的用户账户拥有自己的数字证书，除此之外，K8S的各个组件也拥有自己的数字证书，用于组件之间的安全访问。</p><p>HTTPS(SSL/TLS)加密原理，参考文档<a href="https://www.voidking.com/dev-encryption-algorithm/">《浅谈数据加密》</a>。</p><h2 id="查看证书"><span class="post-title-index">4.1.</span><a href="#查看证书" class="headerlink" title="查看证书"></a> 查看证书</h2><p>1、查看证书位置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep kubelet</span><br><span class="line"><span class="comment"># find config file</span></span><br><span class="line"><span class="built_in">cat</span> /var/lib/kubelet/config.yaml | grep staticPodPath</span><br><span class="line"><span class="built_in">cd</span> /etc/kubernetes/manifests</span><br><span class="line"><span class="built_in">cat</span> kube-apiserver.yaml</span><br></pre></td></tr></table></figure><p>2、查看证书详情</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -<span class="keyword">in</span> /etc/kubernetes/pki/apiserver.crt -text</span><br></pre></td></tr></table></figure><h2 id="签名"><span class="post-title-index">4.2.</span><a href="#签名" class="headerlink" title="签名"></a> 签名</h2><p>签名，或者签名过期后重新签名</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -<span class="keyword">in</span> /etc/kubernetes/pki/apiserver-etcd-client.csr -CA /etc/kubernetes/pki/etcd/ca.crt -CAkey /etc/kubernetes/pki/etcd/ca.key -CAcreateserial -out /etc/kubernetes/pki/apiserver-etcd-client.crt</span><br></pre></td></tr></table></figure><h1 id="创建服务账户"><span class="post-title-index">5.</span><a href="#创建服务账户" class="headerlink" title="创建服务账户"></a> 创建服务账户</h1><h2 id="v1-22之前的版本"><span class="post-title-index">5.1.</span><a href="#v1-22之前的版本" class="headerlink" title="v1.22之前的版本"></a> v1.22之前的版本</h2><p>1、创建ServiceAccount和Secret</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create serviceaccount harkin</span><br></pre></td></tr></table></figure><p>v1.22 之前的 Kubernetes 版本，当创建ServiceAccount时，会自动创建Secret，Secret中包含Token和CA，用于访问 Kubernetes API。<br>当Pod中指定使用这个ServiceAccount时，TOKEN和CA会挂载到Pod中，以便程序使用。</p><ul><li>Token的路径: <code>/var/run/secrets/kubernetes.io/serviceaccount/token</code></li><li>CA证书的路径: <code>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</code></li></ul><p>2、查看ServiceAccount和Secret</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get sa</span><br><span class="line">kubectl get secret</span><br><span class="line">kubectl get secret harkin-token-xxx -oyaml <span class="comment"># 获取token部分和ca.crt部分</span></span><br></pre></td></tr></table></figure><h2 id="v1-22之后的版本"><span class="post-title-index">5.2.</span><a href="#v1-22之后的版本" class="headerlink" title="v1.22之后的版本"></a> v1.22之后的版本</h2><p>在包括 Kubernetes v1.27 在内最近的几个版本中，使用 TokenRequest API 直接获得 API 凭据，并使用投射卷挂载到 Pod 中。<br>使用这种方法获得的令牌具有绑定的生命周期，当挂载的 Pod 被删除时这些令牌将自动失效。</p><p>简单来说，新版本的K8S创建sa时，已经不会自动生成<code>admin-user-token-xxx</code>这种secret，也就无法从这种secret中获取token。</p><p>详情参考文档<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/service-accounts-admin/#manual-secret-management-for-serviceaccounts">手动管理 ServiceAccount 的 Secret</a></p><p>1、创建ServiceAccount</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create serviceaccount harkin</span><br></pre></td></tr></table></figure><p>2、创建ServiceAccount的Secret<br>（1）创建有期限Token（令牌）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create token harkin --duration=8760h</span><br></pre></td></tr></table></figure><p>该令牌只会显示一次，请保存好它。至于ca.crt，从<code>/etc/kubernetes/pki/ca.crt</code>获取即可。</p><p>（2）创建长期有效Token（令牌）<br>我们仍然可以手动创建 Secret 来保存服务账号令牌，例如在我们需要一个永不过期的令牌的时候。<br>一旦我们手动创建一个 Secret 并将其关联到 ServiceAccount， Kubernetes 控制平面就会自动将令牌填充到该 Secret 中。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Secret</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: harkin-secret</span></span><br><span class="line"><span class="string">  annotations:</span></span><br><span class="line"><span class="string">    kubernetes.io/service-account.name: harkin</span></span><br><span class="line"><span class="string">type: kubernetes.io/service-account-token</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>3、查看ServiceAccount和Secret</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get sa</span><br><span class="line">kubectl get secret</span><br><span class="line">kubectl get secrets/harkin-secret -oyaml <span class="comment"># 获取token部分和ca.crt部分</span></span><br></pre></td></tr></table></figure><h1 id="授权"><span class="post-title-index">6.</span><a href="#授权" class="headerlink" title="授权"></a> 授权</h1><p>创建完用户账户和服务账户，只是有了账户，并没有K8S集群的权限。<br>账户授权方法参考文档<a href="https://www.voidking.com/dev-k8s-rbac-auth/">《好好学K8S：K8S中用户账户的RBAC鉴权》</a>和<a href="https://www.voidking.com/dev-k8s-sa-rbac-auth/">《好好学K8S：K8S中服务账户的RBAC鉴权》</a>。</p></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 好好学习的郝</li><li class="post-copyright-link"> <strong>原文链接：</strong> <a href="https://www.voidking.com/dev-k8s-useraccount-serviceaccount/" title="好好学K8S：K8S中创建用户账户和服务账户">https://www.voidking.com/dev-k8s-useraccount-serviceaccount/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本文采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议，转载请注明出处！源站会即时更新知识点并修正错误，欢迎访问~</li><li> <img width="200" height="200" src="/images/avatar.jpg"><p style="text-align:center;margin-bottom:0">微信公众号同步更新，欢迎关注~</p></li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/k8s/" rel="tag"># k8s</a> <a href="/tags/%E5%A5%BD%E5%A5%BD%E5%AD%A6K8S/" rel="tag"># 好好学K8S</a></div><div class="post-nav"><div class="post-nav-item"><a href="/dev-k8s-etcd-backup-restore/" rel="prev" title="好好学K8S：K8S集群中etcd备份和恢复"><i class="fa fa-chevron-left"></i> 好好学K8S：K8S集群中etcd备份和恢复</a></div><div class="post-nav-item"> <a href="/dev-k8s-sa-rbac-auth/" rel="next" title="好好学K8S：K8S中服务账户的RBAC鉴权">好好学K8S：K8S中服务账户的RBAC鉴权<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="footer-ads" style="margin-top:10px"><ins class="adsbygoogle" style="display:block" data-ad-format="autorelaxed" data-ad-client="ca-pub-3284447971731414" data-ad-slot="9697986181"></ins><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3284447971731414" crossorigin="anonymous"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div class="comments" id="gitalk-container"></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#K8S%E4%B8%AD%E7%9A%84%E8%B4%A6%E6%88%B7%E7%AE%80%E4%BB%8B"><span class="nav-text">1. K8S中的账户简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E8%B4%A6%E6%88%B7"><span class="nav-text">2. 创建用户账户</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E5%AF%86%E9%92%A5%E5%AF%B9"><span class="nav-text">2.1. 创建用户密钥对</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8CA%E7%AD%BE%E5%90%8D"><span class="nav-text">2.2. 使用CA签名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8API%E7%AD%BE%E5%90%8D"><span class="nav-text">2.3. 使用API签名</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AF%81%E4%B9%A6%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2"><span class="nav-text">3. 证书格式转换</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#K8S%E4%B8%AD%E7%9A%84%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6"><span class="nav-text">4. K8S中的数字证书</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E8%AF%81%E4%B9%A6"><span class="nav-text">4.1. 查看证书</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AD%BE%E5%90%8D"><span class="nav-text">4.2. 签名</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1%E8%B4%A6%E6%88%B7"><span class="nav-text">5. 创建服务账户</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#v1-22%E4%B9%8B%E5%89%8D%E7%9A%84%E7%89%88%E6%9C%AC"><span class="nav-text">5.1. v1.22之前的版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#v1-22%E4%B9%8B%E5%90%8E%E7%9A%84%E7%89%88%E6%9C%AC"><span class="nav-text">5.2. v1.22之后的版本</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8E%88%E6%9D%83"><span class="nav-text">6. 授权</span></a></li></ol></div></div><div class="sidecar-ads" style="margin-top:10px"><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="好好学习的郝" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">好好学习的郝</p><div class="site-description" itemprop="description">一个计算机技术爱好者与学习者</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">723</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">31</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">254</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:voidking@qq.com" title="E-Mail → mailto:voidking@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://github.com/voidking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/voidking" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/voidking" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;voidking" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i> Zhihu</a></span></div></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 – <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">好好学习的郝</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-beian"> <a href="http://beian.miit.gov.cn/" target="_blank">苏ICP备14021030号</a>&nbsp;|&nbsp; <img src="/images/beian.png" alt=""> <a target="_blank" href="http://www.beian.gov.cn/">苏公网安备 32032202000223号</a></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/gitalk/1.7.2/gitalk.min.css"><script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/gitalk/1.7.2/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID: '5a238b8c32b1e4dd2156',
      clientSecret: 'bfb5d518626f6fdc7da0351d1e0cd37ab75c6361',
      repo: 'gitalk-comments',
      owner: 'voidking',
      admin: ['voidking'],
      id: 'e1c05f70e5990e1dbebcd474eb83c52f',
      title: '好好学K8S：K8S中创建用户账户和服务账户',
      body: '欢迎留言，互相交流学习~',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script></body></html>